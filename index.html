<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Freel">
  <meta name="description" content="Gestion freelance intelligente - Suivi CA, charges, trésorerie">
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZyZWVsIC0gR2VzdGlvbiBGcmVlbGFuY2UiLAogICJzaG9ydF9uYW1lIjogIkZyZWVsIiwKICAiZGVzY3JpcHRpb24iOiAiR2VzdGlvbiBmcmVlbGFuY2UgaW50ZWxsaWdlbnRlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwYTBhMGIiLAogICJ0aGVtZV9jb2xvciI6ICIjMGEwYTBiIiwKICAiaWNvbnMiOiBbXQp9">
  <title>Freel</title>
  <script>/* jsPDF 4.0 embedded */
/** @license
 *
 * jsPDF - PDF Document creation from JavaScript
 * Version 4.0.0 Built on 2025-12-18T10:27:09.424Z
 *                      CommitID 00000000
 *
 * Copyright (c) 2010-2025 James Hall <james@parall.ax>, https://github.com/MrRio/jsPDF
 *               2015-2025 yWorks GmbH, http://www.yworks.com
 *               2015-2025 Lukas Holländer <lukas.hollaender@yworks.com>, https://github.com/HackbrettXXX
 *               2016-2018 Aras Abbasi <aras.abbasi@gmail.com>
 *               2010 Aaron Spike, https://github.com/acspike
 *               2012 Willow Systems Corporation, https://github.com/willowsystems
 *               2012 Pablo Hess, https://github.com/pablohess
 *               2012 Florian Jenett, https://github.com/fjenett
 *               2013 Warren Weckesser, https://github.com/warrenweckesser
 *               2013 Youssef Beddad, https://github.com/lifof
 *               2013 Lee Driscoll, https://github.com/lsdriscoll
 *               2013 Stefan Slonevskiy, https://github.com/stefslon
 *               2013 Jeremy Morel, https://github.com/jmorel
 *               2013 Christoph Hartmann, https://github.com/chris-rock
 *               2014 Juan Pablo Gaviria, https://github.com/juanpgaviria
 *               2014 James Makes, https://github.com/dollaruw
 *               2014 Diego Casorran, https://github.com/diegocr
 *               2014 Steven Spungin, https://github.com/Flamenco
 *               2014 Kenneth Glassey, https://github.com/Gavvers
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * Contributor(s):
 *    siefkenj, ahwolf, rickygu, Midnith, saintclair, eaparango,
 *    kim3er, mfo, alnorth, Flamenco
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).jspdf={})}(this,function(t){function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function n(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,a,s,o=[],h=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;h=!1}else for(;!(h=(r=a.call(n)).done)&&(o.push(r.value),o.length!==e);h=!0);}catch(t){l=!0,i=t}finally{try{if(!h&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw i}}return o}}(t,n)||function(t,n){if(t){if("string"==typeof t)return e(t,n);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,n):void 0}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}var i=function(){return"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this}();function a(){i.console&&"function"==typeof i.console.log&&i.console.log.apply(i.console,arguments)}var s={log:a,warn:function(t){i.console&&("function"==typeof i.console.warn?i.console.warn.apply(i.console,arguments):a.call(null,arguments))},error:function(t){i.console&&("function"==typeof i.console.error?i.console.error.apply(i.console,arguments):a(t))}};function o(t,e,n){var r=new XMLHttpRequest;r.open("GET",t),r.responseType="blob",r.onload=function(){c(r.response,e,n)},r.onerror=function(){s.error("could not download file")},r.send()}function h(t){var e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send()}catch(n){}return e.status>=200&&e.status<=299}function l(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(n){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var c=i.saveAs||("object"!==("undefined"==typeof window?"undefined":r(window))||window!==i?function(){}:"undefined"!=typeof HTMLAnchorElement&&"download"in HTMLAnchorElement.prototype?function(t,e,n){var r=i.URL||i.webkitURL,a=document.createElement("a");e=e||t.name||"download",a.download=e,a.rel="noopener","string"==typeof t?(a.href=t,a.origin!==location.origin?h(a.href)?o(t,e,n):l(a,a.target="_blank"):l(a)):(a.href=r.createObjectURL(t),setTimeout(function(){r.revokeObjectURL(a.href)},4e4),setTimeout(function(){l(a)},0))}:"msSaveOrOpenBlob"in navigator?function(t,e,n){if(e=e||t.name||"download","string"==typeof t)if(h(t))o(t,e,n);else{var i=document.createElement("a");i.href=t,i.target="_blank",setTimeout(function(){l(i)})}else navigator.msSaveOrOpenBlob(function(t,e){return void 0===e?e={autoBom:!1}:"object"!==r(e)&&(s.warn("Deprecated: Expected third argument to be a object"),e={autoBom:!e}),e.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob([String.fromCharCode(65279),t],{type:t.type}):t}(t,n),e)}:function(t,e,n,a){if((a=a||open("","_blank"))&&(a.document.title=a.document.body.innerText="downloading..."),"string"==typeof t)return o(t,e,n);var s="application/octet-stream"===t.type,h=/constructor/i.test(i.HTMLElement)||i.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||s&&h)&&"object"===("undefined"==typeof FileReader?"undefined":r(FileReader))){var c=new FileReader;c.onloadend=function(){var t=c.result;t=l?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),a?a.location.href=t:location=t,a=null},c.readAsDataURL(t)}else{var u=i.URL||i.webkitURL,f=u.createObjectURL(t);a?a.location=f:location.href=f,a=null,setTimeout(function(){u.revokeObjectURL(f)},4e4)}});
/**
   * A class to parse color values
   * @author Stoyan Stefanov <sstoo@gmail.com>
   * {@link   http://www.phpied.com/rgb-color-parser-in-javascript/}
   * @license Use it if you like it
   */function u(t){var e;t=t||"",this.ok=!1,"#"==t.charAt(0)&&(t=t.substr(1,6)),t={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"}[t=(t=t.replace(/ /g,"")).toLowerCase()]||t;for(var n=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(t){return[parseInt(t[1]),parseInt(t[2]),parseInt(t[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(t){return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(t){return[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16)]}}],r=0;r<n.length;r++){var i=n[r].re,a=n[r].process,s=i.exec(t);s&&(e=a(s),this.r=e[0],this.g=e[1],this.b=e[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var t=this.r.toString(16),e=this.g.toString(16),n=this.b.toString(16);return 1==t.length&&(t="0"+t),1==e.length&&(e="0"+e),1==n.length&&(n="0"+n),"#"+t+e+n}}var f=i.atob.bind(i),d=i.btoa.bind(i);
/**
   * @license
   * Joseph Myers does not specify a particular license for his work.
   *
   * Author: Joseph Myers
   * Accessed from: http://www.myersdaily.org/joseph/javascript/md5.js
   *
   * Modified by: Owen Leong
   */
function p(t,e){var n=t[0],r=t[1],i=t[2],a=t[3];n=m(n,r,i,a,e[0],7,-680876936),a=m(a,n,r,i,e[1],12,-389564586),i=m(i,a,n,r,e[2],17,606105819),r=m(r,i,a,n,e[3],22,-1044525330),n=m(n,r,i,a,e[4],7,-176418897),a=m(a,n,r,i,e[5],12,1200080426),i=m(i,a,n,r,e[6],17,-1473231341),r=m(r,i,a,n,e[7],22,-45705983),n=m(n,r,i,a,e[8],7,1770035416),a=m(a,n,r,i,e[9],12,-1958414417),i=m(i,a,n,r,e[10],17,-42063),r=m(r,i,a,n,e[11],22,-1990404162),n=m(n,r,i,a,e[12],7,1804603682),a=m(a,n,r,i,e[13],12,-40341101),i=m(i,a,n,r,e[14],17,-1502002290),n=b(n,r=m(r,i,a,n,e[15],22,1236535329),i,a,e[1],5,-165796510),a=b(a,n,r,i,e[6],9,-1069501632),i=b(i,a,n,r,e[11],14,643717713),r=b(r,i,a,n,e[0],20,-373897302),n=b(n,r,i,a,e[5],5,-701558691),a=b(a,n,r,i,e[10],9,38016083),i=b(i,a,n,r,e[15],14,-660478335),r=b(r,i,a,n,e[4],20,-405537848),n=b(n,r,i,a,e[9],5,568446438),a=b(a,n,r,i,e[14],9,-1019803690),i=b(i,a,n,r,e[3],14,-187363961),r=b(r,i,a,n,e[8],20,1163531501),n=b(n,r,i,a,e[13],5,-1444681467),a=b(a,n,r,i,e[2],9,-51403784),i=b(i,a,n,r,e[7],14,1735328473),n=v(n,r=b(r,i,a,n,e[12],20,-1926607734),i,a,e[5],4,-378558),a=v(a,n,r,i,e[8],11,-2022574463),i=v(i,a,n,r,e[11],16,1839030562),r=v(r,i,a,n,e[14],23,-35309556),n=v(n,r,i,a,e[1],4,-1530992060),a=v(a,n,r,i,e[4],11,1272893353),i=v(i,a,n,r,e[7],16,-155497632),r=v(r,i,a,n,e[10],23,-1094730640),n=v(n,r,i,a,e[13],4,681279174),a=v(a,n,r,i,e[0],11,-358537222),i=v(i,a,n,r,e[3],16,-722521979),r=v(r,i,a,n,e[6],23,76029189),n=v(n,r,i,a,e[9],4,-640364487),a=v(a,n,r,i,e[12],11,-421815835),i=v(i,a,n,r,e[15],16,530742520),n=w(n,r=v(r,i,a,n,e[2],23,-995338651),i,a,e[0],6,-198630844),a=w(a,n,r,i,e[7],10,1126891415),i=w(i,a,n,r,e[14],15,-1416354905),r=w(r,i,a,n,e[5],21,-57434055),n=w(n,r,i,a,e[12],6,1700485571),a=w(a,n,r,i,e[3],10,-1894986606),i=w(i,a,n,r,e[10],15,-1051523),r=w(r,i,a,n,e[1],21,-2054922799),n=w(n,r,i,a,e[8],6,1873313359),a=w(a,n,r,i,e[15],10,-30611744),i=w(i,a,n,r,e[6],15,-1560198380),r=w(r,i,a,n,e[13],21,1309151649),n=w(n,r,i,a,e[4],6,-145523070),a=w(a,n,r,i,e[11],10,-1120210379),i=w(i,a,n,r,e[2],15,718787259),r=w(r,i,a,n,e[9],21,-343485551),t[0]=k(n,t[0]),t[1]=k(r,t[1]),t[2]=k(i,t[2]),t[3]=k(a,t[3])}function g(t,e,n,r,i,a){return e=k(k(e,t),k(r,a)),k(e<<i|e>>>32-i,n)}function m(t,e,n,r,i,a,s){return g(e&n|~e&r,t,e,i,a,s)}function b(t,e,n,r,i,a,s){return g(e&r|n&~r,t,e,i,a,s)}function v(t,e,n,r,i,a,s){return g(e^n^r,t,e,i,a,s)}function w(t,e,n,r,i,a,s){return g(n^(e|~r),t,e,i,a,s)}function y(t){var e,n=t.length,r=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)p(r,_(t.substring(e-64,e)));t=t.substring(e-64);var i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)i[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(i[e>>2]|=128<<(e%4<<3),e>55)for(p(r,i),e=0;e<16;e++)i[e]=0;return i[14]=8*n,p(r,i),r}function _(t){var e,n=[];for(e=0;e<64;e+=4)n[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return n}var x="0123456789abcdef".split("");function A(t){for(var e="",n=0;n<4;n++)e+=x[t>>8*n+4&15]+x[t>>8*n&15];return e}function L(t){return String.fromCharCode(255&t,(65280&t)>>8,(16711680&t)>>16,(4278190080&t)>>24)}function N(t){return function(t){return t.map(L).join("")}(y(t))}var S="5d41402abc4b2a76b9719d911017c592"!=function(t){for(var e=0;e<t.length;e++)t[e]=A(t[e]);return t.join("")}(y("hello"));function k(t,e){if(S){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}return t+e&4294967295}
/**
   * @license
   * FPDF is released under a permissive license: there is no usage restriction.
   * You may embed it freely in your application (commercial or not), with or
   * without modifications.
   *
   * Reference: http://www.fpdf.org/en/script/script37.php
   */function P(t,e){var n,r,i,a;if(t!==n){for(var s=(i=t,a=1+(256/t.length|0),new Array(a+1).join(i)),o=[],h=0;h<256;h++)o[h]=h;var l=0;for(h=0;h<256;h++){var c=o[h];l=(l+c+s.charCodeAt(h))%256,o[h]=o[l],o[l]=c}n=t,r=o}else o=r;var u=e.length,f=0,d=0,p="";for(h=0;h<u;h++)d=(d+(c=o[f=(f+1)%256]))%256,o[f]=o[d],o[d]=c,s=o[(o[f]+o[d])%256],p+=String.fromCharCode(e.charCodeAt(h)^s);return p}
/**
   * @license
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   * Author: Owen Leong (@owenl131)
   * Date: 15 Oct 2020
   * References:
   * https://www.cs.cmu.edu/~dst/Adobe/Gallery/anon21jul01-pdf-encryption.txt
   * https://github.com/foliojs/pdfkit/blob/master/lib/security.js
   * http://www.fpdf.org/en/script/script37.php
   */var F={print:4,modify:8,copy:16,"annot-forms":32};function I(t,e,n,r){this.v=1,this.r=2;var i=192;t.forEach(function(t){if(void 0!==F.perm)throw new Error("Invalid permission: "+t);i+=F[t]}),this.padding="(¿N^NuAd\0NVÿú\b..\0¶Ðh>/\f©þdSiz";var a=(e+this.padding).substr(0,32),s=(n+this.padding).substr(0,32);this.O=this.processOwnerPassword(a,s),this.P=-(1+(255^i)),this.encryptionKey=N(a+this.O+this.lsbFirstWord(this.P)+this.hexToBytes(r)).substr(0,5),this.U=P(this.encryptionKey,this.padding)}function C(t){if(/[^\u0000-\u00ff]/.test(t))throw new Error("Invalid PDF Name Object: "+t+", Only accept ASCII characters.");for(var e="",n=t.length,r=0;r<n;r++){var i=t.charCodeAt(r);e+=i<33||35===i||37===i||40===i||41===i||47===i||60===i||62===i||91===i||93===i||123===i||125===i||i>126?"#"+("0"+i.toString(16)).slice(-2):t[r]}return e}function j(t){if("object"!==r(t))throw new Error("Invalid Context passed to initialize PubSub (jsPDF-module)");var e={};this.subscribe=function(t,n,r){if(r=r||!1,"string"!=typeof t||"function"!=typeof n||"boolean"!=typeof r)throw new Error("Invalid arguments passed to PubSub.subscribe (jsPDF-module)");e.hasOwnProperty(t)||(e[t]={});var i=Math.random().toString(35);return e[t][i]=[n,!!r],i},this.unsubscribe=function(t){for(var n in e)if(e[n][t])return delete e[n][t],0===Object.keys(e[n]).length&&delete e[n],!0;return!1},this.publish=function(n){if(e.hasOwnProperty(n)){var r=Array.prototype.slice.call(arguments,1),a=[];for(var o in e[n]){var h=e[n][o];try{h[0].apply(t,r)}catch(l){i.console&&s.error("jsPDF PubSub Error",l.message,l)}h[1]&&a.push(o)}a.length&&a.forEach(this.unsubscribe)}},this.getTopics=function(){return e}}function E(t){if(!(this instanceof E))return new E(t);var e="opacity,stroke-opacity".split(",");for(var n in t)t.hasOwnProperty(n)&&e.indexOf(n)>=0&&(this[n]=t[n]);this.id="",this.objectNumber=-1}function O(t,e){this.gState=t,this.matrix=e,this.id="",this.objectNumber=-1}function B(t,e,n,r,i){if(!(this instanceof B))return new B(t,e,n,r,i);this.type="axial"===t?2:3,this.coords=e,this.colors=n,O.call(this,r,i)}function M(t,e,n,r,i){if(!(this instanceof M))return new M(t,e,n,r,i);this.boundingBox=t,this.xStep=e,this.yStep=n,this.stream="",this.cloneIndex=0,O.call(this,r,i)}function R(t){var e,n="string"==typeof arguments[0]?arguments[0]:"p",a=arguments[1],o=arguments[2],h=arguments[3],l=[],f=1,p=16,g="S",m=null;"object"===r(t=t||{})&&(n=t.orientation,a=t.unit||a,o=t.format||o,h=t.compress||t.compressPdf||h,null!==(m=t.encryption||null)&&(m.userPassword=m.userPassword||"",m.ownerPassword=m.ownerPassword||"",m.userPermissions=m.userPermissions||[]),f="number"==typeof t.userUnit?Math.abs(t.userUnit):1,void 0!==t.precision&&(e=t.precision),void 0!==t.floatPrecision&&(p=t.floatPrecision),g=t.defaultPathOperation||"S"),l=t.filters||(!0===h?["FlateEncode"]:l),a=a||"mm",n=(""+(n||"P")).toLowerCase();var b=t.putOnlyUsedFonts||!1,v={},w={internal:{},__private__:{}};w.__private__.PubSub=j;var y="1.3",_=w.__private__.getPdfVersion=function(){return y};w.__private__.setPdfVersion=function(t){y=t};var x={a0:[2383.94,3370.39],a1:[1683.78,2383.94],a2:[1190.55,1683.78],a3:[841.89,1190.55],a4:[595.28,841.89],a5:[419.53,595.28],a6:[297.64,419.53],a7:[209.76,297.64],a8:[147.4,209.76],a9:[104.88,147.4],a10:[73.7,104.88],b0:[2834.65,4008.19],b1:[2004.09,2834.65],b2:[1417.32,2004.09],b3:[1000.63,1417.32],b4:[708.66,1000.63],b5:[498.9,708.66],b6:[354.33,498.9],b7:[249.45,354.33],b8:[175.75,249.45],b9:[124.72,175.75],b10:[87.87,124.72],c0:[2599.37,3676.54],c1:[1836.85,2599.37],c2:[1298.27,1836.85],c3:[918.43,1298.27],c4:[649.13,918.43],c5:[459.21,649.13],c6:[323.15,459.21],c7:[229.61,323.15],c8:[161.57,229.61],c9:[113.39,161.57],c10:[79.37,113.39],dl:[311.81,623.62],letter:[612,792],"government-letter":[576,756],legal:[612,1008],"junior-legal":[576,360],ledger:[1224,792],tabloid:[792,1224],"credit-card":[153,243]};w.__private__.getPageFormats=function(){return x};var A=w.__private__.getPageFormat=function(t){return x[t]};o=o||"a4";var L="compat",N="advanced",S=L;function k(){this.saveGraphicsState(),ct(new Wt(Nt,0,0,-Nt,0,Sn()*Nt).toString()+" cm"),this.setFontSize(this.getFontSize()/Nt),g="n",S=N}function P(){this.restoreGraphicsState(),g="S",S=L}var F=w.__private__.combineFontStyleAndFontWeight=function(t,e){if("bold"==t&&"normal"==e||"bold"==t&&400==e||"normal"==t&&"italic"==e||"bold"==t&&"italic"==e)throw new Error("Invalid Combination of fontweight and fontstyle");return e&&(t=400==e||"normal"===e?"italic"===t?"italic":"normal":700!=e&&"bold"!==e||"normal"!==t?(700==e?"bold":e)+""+t:"bold"),t};w.advancedAPI=function(t){var e=S===L;return e&&k.call(this),"function"!=typeof t||(t(this),e&&P.call(this)),this},w.compatAPI=function(t){var e=S===N;return e&&P.call(this),"function"!=typeof t||(t(this),e&&k.call(this)),this},w.isAdvancedAPI=function(){return S===N};var O,T=function(t){if(S!==N)throw new Error(t+" is only available in 'advanced' API mode. You need to call advancedAPI() first.")},q=w.roundToPrecision=w.__private__.roundToPrecision=function(t,n){var r=e||n;if(isNaN(t)||isNaN(r))throw new Error("Invalid argument passed to jsPDF.roundToPrecision");return t.toFixed(r).replace(/0+$/,"")};O=w.hpf=w.__private__.hpf="number"==typeof p?function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.hpf");return q(t,p)}:"smart"===p?function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.hpf");return q(t,t>-1&&t<1?16:5)}:function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.hpf");return q(t,16)};var D=w.f2=w.__private__.f2=function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.f2");return q(t,2)},z=w.__private__.f3=function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.f3");return q(t,3)},U=w.scale=w.__private__.scale=function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.scale");return S===L?t*Nt:S===N?t:void 0},H=function(t){return U(function(t){return S===L?Sn()-t:S===N?t:void 0}(t))};w.__private__.setPrecision=w.setPrecision=function(t){"number"==typeof parseInt(t,10)&&(e=parseInt(t,10))};var W,V="00000000000000000000000000000000",G=w.__private__.getFileId=function(){return V},Y=w.__private__.setFileId=function(t){return V=void 0!==t&&/^[a-fA-F0-9]{32}$/.test(t)?t.toUpperCase():V.split("").map(function(){return"ABCDEF0123456789".charAt(Math.floor(16*Math.random()))}).join(""),null!==m&&(Ce=new I(m.userPermissions,m.userPassword,m.ownerPassword,V)),V};w.setFileId=function(t){return Y(t),this},w.getFileId=function(){return G()};var Z=w.__private__.convertDateToPDFDate=function(t){var e=t.getTimezoneOffset(),n=e<0?"+":"-",r=Math.floor(Math.abs(e/60)),i=Math.abs(e%60),a=[n,Q(r),"'",Q(i),"'"].join("");return["D:",t.getFullYear(),Q(t.getMonth()+1),Q(t.getDate()),Q(t.getHours()),Q(t.getMinutes()),Q(t.getSeconds()),a].join("")},J=w.__private__.convertPDFDateToDate=function(t){var e=parseInt(t.substr(2,4),10),n=parseInt(t.substr(6,2),10)-1,r=parseInt(t.substr(8,2),10),i=parseInt(t.substr(10,2),10),a=parseInt(t.substr(12,2),10),s=parseInt(t.substr(14,2),10);return new Date(e,n,r,i,a,s,0)},X=w.__private__.setCreationDate=function(t){var e;if(void 0===t&&(t=new Date),t instanceof Date)e=Z(t);else{if(!/^D:(20[0-2][0-9]|203[0-7]|19[7-9][0-9])(0[0-9]|1[0-2])([0-2][0-9]|3[0-1])(0[0-9]|1[0-9]|2[0-3])(0[0-9]|[1-5][0-9])(0[0-9]|[1-5][0-9])(\+0[0-9]|\+1[0-4]|-0[0-9]|-1[0-1])'(0[0-9]|[1-5][0-9])'?$/.test(t))throw new Error("Invalid argument passed to jsPDF.setCreationDate");e=t}return W=e},K=w.__private__.getCreationDate=function(t){var e=W;return"jsDate"===t&&(e=J(W)),e};w.setCreationDate=function(t){return X(t),this},w.getCreationDate=function(t){return K(t)};var $,Q=w.__private__.padd2=function(t){return("0"+parseInt(t)).slice(-2)},tt=w.__private__.padd2Hex=function(t){return("00"+(t=t.toString())).substr(t.length)},et=0,nt=[],rt=[],it=0,at=[],st=[],ot=!1,ht=rt;w.__private__.setCustomOutputDestination=function(t){ot=!0,ht=t};var lt=function(t){ot||(ht=t)};w.__private__.resetCustomOutputDestination=function(){ot=!1,ht=rt};var ct=w.__private__.out=function(t){return t=t.toString(),it+=t.length+1,ht.push(t),ht},ut=w.__private__.write=function(t){return ct(1===arguments.length?t.toString():Array.prototype.join.call(arguments," "))},ft=w.__private__.getArrayBuffer=function(t){for(var e=t.length,n=new ArrayBuffer(e),r=new Uint8Array(n);e--;)r[e]=t.charCodeAt(e);return n},dt=[["Helvetica","helvetica","normal","WinAnsiEncoding"],["Helvetica-Bold","helvetica","bold","WinAnsiEncoding"],["Helvetica-Oblique","helvetica","italic","WinAnsiEncoding"],["Helvetica-BoldOblique","helvetica","bolditalic","WinAnsiEncoding"],["Courier","courier","normal","WinAnsiEncoding"],["Courier-Bold","courier","bold","WinAnsiEncoding"],["Courier-Oblique","courier","italic","WinAnsiEncoding"],["Courier-BoldOblique","courier","bolditalic","WinAnsiEncoding"],["Times-Roman","times","normal","WinAnsiEncoding"],["Times-Bold","times","bold","WinAnsiEncoding"],["Times-Italic","times","italic","WinAnsiEncoding"],["Times-BoldItalic","times","bolditalic","WinAnsiEncoding"],["ZapfDingbats","zapfdingbats","normal",null],["Symbol","symbol","normal",null]];w.__private__.getStandardFonts=function(){return dt};var pt=t.fontSize||16;w.__private__.setFontSize=w.setFontSize=function(t){return pt=S===N?t/Nt:t,this};var gt,mt=w.__private__.getFontSize=w.getFontSize=function(){return S===L?pt:pt*Nt},bt=t.R2L||!1;w.__private__.setR2L=w.setR2L=function(t){return bt=t,this},w.__private__.getR2L=w.getR2L=function(){return bt};var vt,wt=w.__private__.setZoomMode=function(t){if(/^(?:\d+\.\d*|\d*\.\d+|\d+)%$/.test(t))gt=t;else if(isNaN(t)){if(-1===[void 0,null,"fullwidth","fullheight","fullpage","original"].indexOf(t))throw new Error('zoom must be Integer (e.g. 2), a percentage Value (e.g. 300%) or fullwidth, fullheight, fullpage, original. "'+t+'" is not recognized.');gt=t}else gt=parseInt(t,10)};w.__private__.getZoomMode=function(){return gt};var yt,_t=w.__private__.setPageMode=function(t){if(-1==[void 0,null,"UseNone","UseOutlines","UseThumbs","FullScreen"].indexOf(t))throw new Error('Page mode must be one of UseNone, UseOutlines, UseThumbs, or FullScreen. "'+t+'" is not recognized.');vt=t};w.__private__.getPageMode=function(){return vt};var xt=w.__private__.setLayoutMode=function(t){if(-1==[void 0,null,"continuous","single","twoleft","tworight","two"].indexOf(t))throw new Error('Layout mode must be one of continuous, single, twoleft, tworight. "'+t+'" is not recognized.');yt=t};w.__private__.getLayoutMode=function(){return yt},w.__private__.setDisplayMode=w.setDisplayMode=function(t,e,n){return wt(t),xt(e),_t(n),this};var At={title:"",subject:"",author:"",keywords:"",creator:""};w.__private__.getDocumentProperty=function(t){if(-1===Object.keys(At).indexOf(t))throw new Error("Invalid argument passed to jsPDF.getDocumentProperty");return At[t]},w.__private__.getDocumentProperties=function(){return At},w.__private__.setDocumentProperties=w.setProperties=w.setDocumentProperties=function(t){for(var e in At)At.hasOwnProperty(e)&&t[e]&&(At[e]=t[e]);return this},w.__private__.setDocumentProperty=function(t,e){if(-1===Object.keys(At).indexOf(t))throw new Error("Invalid arguments passed to jsPDF.setDocumentProperty");return At[t]=e};var Lt,Nt,St,kt,Pt,Ft={},It={},Ct=[],jt={},Et={},Ot={},Bt={},Mt=null,Rt=0,Tt=[],qt=new j(w),Dt=t.hotfixes||[],zt={},Ut={},Ht=[],Wt=function t(e,n,r,i,a,s){if(!(this instanceof t))return new t(e,n,r,i,a,s);isNaN(e)&&(e=1),isNaN(n)&&(n=0),isNaN(r)&&(r=0),isNaN(i)&&(i=1),isNaN(a)&&(a=0),isNaN(s)&&(s=0),this._matrix=[e,n,r,i,a,s]};Object.defineProperty(Wt.prototype,"sx",{get:function(){return this._matrix[0]},set:function(t){this._matrix[0]=t}}),Object.defineProperty(Wt.prototype,"shy",{get:function(){return this._matrix[1]},set:function(t){this._matrix[1]=t}}),Object.defineProperty(Wt.prototype,"shx",{get:function(){return this._matrix[2]},set:function(t){this._matrix[2]=t}}),Object.defineProperty(Wt.prototype,"sy",{get:function(){return this._matrix[3]},set:function(t){this._matrix[3]=t}}),Object.defineProperty(Wt.prototype,"tx",{get:function(){return this._matrix[4]},set:function(t){this._matrix[4]=t}}),Object.defineProperty(Wt.prototype,"ty",{get:function(){return this._matrix[5]},set:function(t){this._matrix[5]=t}}),Object.defineProperty(Wt.prototype,"a",{get:function(){return this._matrix[0]},set:function(t){this._matrix[0]=t}}),Object.defineProperty(Wt.prototype,"b",{get:function(){return this._matrix[1]},set:function(t){this._matrix[1]=t}}),Object.defineProperty(Wt.prototype,"c",{get:function(){return this._matrix[2]},set:function(t){this._matrix[2]=t}}),Object.defineProperty(Wt.prototype,"d",{get:function(){return this._matrix[3]},set:function(t){this._matrix[3]=t}}),Object.defineProperty(Wt.prototype,"e",{get:function(){return this._matrix[4]},set:function(t){this._matrix[4]=t}}),Object.defineProperty(Wt.prototype,"f",{get:function(){return this._matrix[5]},set:function(t){this._matrix[5]=t}}),Object.defineProperty(Wt.prototype,"rotation",{get:function(){return Math.atan2(this.shx,this.sx)}}),Object.defineProperty(Wt.prototype,"scaleX",{get:function(){return this.decompose().scale.sx}}),Object.defineProperty(Wt.prototype,"scaleY",{get:function(){return this.decompose().scale.sy}}),Object.defineProperty(Wt.prototype,"isIdentity",{get:function(){return 1===this.sx&&0===this.shy&&0===this.shx&&1===this.sy&&0===this.tx&&0===this.ty}}),Wt.prototype.join=function(t){return[this.sx,this.shy,this.shx,this.sy,this.tx,this.ty].map(O).join(t)},Wt.prototype.multiply=function(t){var e=t.sx*this.sx+t.shy*this.shx,n=t.sx*this.shy+t.shy*this.sy,r=t.shx*this.sx+t.sy*this.shx,i=t.shx*this.shy+t.sy*this.sy,a=t.tx*this.sx+t.ty*this.shx+this.tx,s=t.tx*this.shy+t.ty*this.sy+this.ty;return new Wt(e,n,r,i,a,s)},Wt.prototype.decompose=function(){var t=this.sx,e=this.shy,n=this.shx,r=this.sy,i=this.tx,a=this.ty,s=Math.sqrt(t*t+e*e),o=(t/=s)*n+(e/=s)*r;n-=t*o,r-=e*o;var h=Math.sqrt(n*n+r*r);return o/=h,t*(r/=h)<e*(n/=h)&&(t=-t,e=-e,o=-o,s=-s),{scale:new Wt(s,0,0,h,0,0),translate:new Wt(1,0,0,1,i,a),rotate:new Wt(t,e,-e,t,0,0),skew:new Wt(1,0,o,1,0,0)}},Wt.prototype.toString=function(t){return this.join(" ")},Wt.prototype.inversed=function(){var t=this.sx,e=this.shy,n=this.shx,r=this.sy,i=this.tx,a=this.ty,s=1/(t*r-e*n),o=r*s,h=-e*s,l=-n*s,c=t*s;return new Wt(o,h,l,c,-o*i-l*a,-h*i-c*a)},Wt.prototype.applyToPoint=function(t){var e=t.x*this.sx+t.y*this.shx+this.tx,n=t.x*this.shy+t.y*this.sy+this.ty;return new gn(e,n)},Wt.prototype.applyToRectangle=function(t){var e=this.applyToPoint(t),n=this.applyToPoint(new gn(t.x+t.w,t.y+t.h));return new mn(e.x,e.y,n.x-e.x,n.y-e.y)},Wt.prototype.clone=function(){var t=this.sx,e=this.shy,n=this.shx,r=this.sy,i=this.tx,a=this.ty;return new Wt(t,e,n,r,i,a)},w.Matrix=Wt;var Vt=w.matrixMult=function(t,e){return e.multiply(t)},Gt=new Wt(1,0,0,1,0,0);w.unitMatrix=w.identityMatrix=Gt;var Yt=function(t,e){if(!Et[t]){var n=(e instanceof B?"Sh":"P")+(Object.keys(jt).length+1).toString(10);e.id=n,Et[t]=n,jt[n]=e,qt.publish("addPattern",e)}};w.ShadingPattern=B,w.TilingPattern=M,w.addShadingPattern=function(t,e){return T("addShadingPattern()"),Yt(t,e),this},w.beginTilingPattern=function(t){T("beginTilingPattern()"),vn(t.boundingBox[0],t.boundingBox[1],t.boundingBox[2]-t.boundingBox[0],t.boundingBox[3]-t.boundingBox[1],t.matrix)},w.endTilingPattern=function(t,e){T("endTilingPattern()"),e.stream=st[$].join("\n"),Yt(t,e),qt.publish("endTilingPattern",e),Ht.pop().restore()};var Zt,Jt=w.__private__.newObject=function(){var t=Xt();return Kt(t,!0),t},Xt=w.__private__.newObjectDeferred=function(){return et++,nt[et]=function(){return it},et},Kt=function(t,e){return e="boolean"==typeof e&&e,nt[t]=it,e&&ct(t+" 0 obj"),t},$t=w.__private__.newAdditionalObject=function(){var t={objId:Xt(),content:""};return at.push(t),t},Qt=Xt(),te=Xt(),ee=w.__private__.decodeColorString=function(t){var e=t.split(" ");if(2!==e.length||"g"!==e[1]&&"G"!==e[1])5!==e.length||"k"!==e[4]&&"K"!==e[4]||(e=[(1-e[0])*(1-e[3]),(1-e[1])*(1-e[3]),(1-e[2])*(1-e[3]),"r"]);else{var n=parseFloat(e[0]);e=[n,n,n,"r"]}for(var r="#",i=0;i<3;i++)r+=("0"+Math.floor(255*parseFloat(e[i])).toString(16)).slice(-2);return r},ne=w.__private__.encodeColorString=function(t){var e;"string"==typeof t&&(t={ch1:t});var n=t.ch1,i=t.ch2,a=t.ch3,s=t.ch4,o="draw"===t.pdfColorType?["G","RG","K"]:["g","rg","k"];if("string"==typeof n&&"#"!==n.charAt(0)){var h=new u(n);if(h.ok)n=h.toHex();else if(!/^\d*\.?\d*$/.test(n))throw new Error('Invalid color "'+n+'" passed to jsPDF.encodeColorString.')}if("string"==typeof n&&/^#[0-9A-Fa-f]{3}$/.test(n)&&(n="#"+n[1]+n[1]+n[2]+n[2]+n[3]+n[3]),"string"==typeof n&&/^#[0-9A-Fa-f]{6}$/.test(n)){var l=parseInt(n.substr(1),16);n=l>>16&255,i=l>>8&255,a=255&l}if(void 0===i||void 0===s&&n===i&&i===a)e="string"==typeof n?n+" "+o[0]:2===t.precision?D(n/255)+" "+o[0]:z(n/255)+" "+o[0];else if(void 0===s||"object"===r(s)){if(s&&!isNaN(s.a)&&0===s.a)return["1.","1.","1.",o[1]].join(" ");e="string"==typeof n?[n,i,a,o[1]].join(" "):2===t.precision?[D(n/255),D(i/255),D(a/255),o[1]].join(" "):[z(n/255),z(i/255),z(a/255),o[1]].join(" ")}else e="string"==typeof n?[n,i,a,s,o[2]].join(" "):2===t.precision?[D(n),D(i),D(a),D(s),o[2]].join(" "):[z(n),z(i),z(a),z(s),o[2]].join(" ");return e},re=w.__private__.getFilters=function(){return l},ie=w.__private__.putStream=function(t){var e=(t=t||{}).data||"",n=t.filters||re(),r=t.alreadyAppliedFilters||[],i=t.addLength1||!1,a=e.length,s=t.objectId,o=function(t){return t};if(null!==m&&void 0===s)throw new Error("ObjectId must be passed to putStream for file encryption");null!==m&&(o=Ce.encryptor(s,0));var h={};!0===n&&(n=["FlateEncode"]);var l=t.additionalKeyValues||[],c=(h=void 0!==R.API.processDataByFilters?R.API.processDataByFilters(e,n):{data:e,reverseChain:[]}).reverseChain+(Array.isArray(r)?r.join(" "):r.toString());if(0!==h.data.length&&(l.push({key:"Length",value:h.data.length}),!0===i&&l.push({key:"Length1",value:a})),0!=c.length)if(c.split("/").length-1==1)l.push({key:"Filter",value:c});else{l.push({key:"Filter",value:"["+c+"]"});for(var u=0;u<l.length;u+=1)if("DecodeParms"===l[u].key){for(var f=[],d=0;d<h.reverseChain.split("/").length-1;d+=1)f.push("null");f.push(l[u].value),l[u].value="["+f.join(" ")+"]"}}ct("<<");for(var p=0;p<l.length;p++)ct("/"+l[p].key+" "+l[p].value);ct(">>"),0!==h.data.length&&(ct("stream"),ct(o(h.data)),ct("endstream"))},ae=w.__private__.putPage=function(t){var e=t.number,n=t.data,r=t.objId,i=t.contentsObjId;Kt(r,!0),ct("<</Type /Page"),ct("/Parent "+t.rootDictionaryObjId+" 0 R"),ct("/Resources "+t.resourceDictionaryObjId+" 0 R"),ct("/MediaBox ["+parseFloat(O(t.mediaBox.bottomLeftX))+" "+parseFloat(O(t.mediaBox.bottomLeftY))+" "+O(t.mediaBox.topRightX)+" "+O(t.mediaBox.topRightY)+"]"),null!==t.cropBox&&ct("/CropBox ["+O(t.cropBox.bottomLeftX)+" "+O(t.cropBox.bottomLeftY)+" "+O(t.cropBox.topRightX)+" "+O(t.cropBox.topRightY)+"]"),null!==t.bleedBox&&ct("/BleedBox ["+O(t.bleedBox.bottomLeftX)+" "+O(t.bleedBox.bottomLeftY)+" "+O(t.bleedBox.topRightX)+" "+O(t.bleedBox.topRightY)+"]"),null!==t.trimBox&&ct("/TrimBox ["+O(t.trimBox.bottomLeftX)+" "+O(t.trimBox.bottomLeftY)+" "+O(t.trimBox.topRightX)+" "+O(t.trimBox.topRightY)+"]"),null!==t.artBox&&ct("/ArtBox ["+O(t.artBox.bottomLeftX)+" "+O(t.artBox.bottomLeftY)+" "+O(t.artBox.topRightX)+" "+O(t.artBox.topRightY)+"]"),"number"==typeof t.userUnit&&1!==t.userUnit&&ct("/UserUnit "+t.userUnit),qt.publish("putPage",{objId:r,pageContext:Tt[e],pageNumber:e,page:n}),ct("/Contents "+i+" 0 R"),ct(">>"),ct("endobj");var a=n.join("\n");return S===N&&(a+="\nQ"),Kt(i,!0),ie({data:a,filters:re(),objectId:i}),ct("endobj"),r},se=w.__private__.putPages=function(){var t,e,n=[];for(t=1;t<=Rt;t++)Tt[t].objId=Xt(),Tt[t].contentsObjId=Xt();for(t=1;t<=Rt;t++)n.push(ae({number:t,data:st[t],objId:Tt[t].objId,contentsObjId:Tt[t].contentsObjId,mediaBox:Tt[t].mediaBox,cropBox:Tt[t].cropBox,bleedBox:Tt[t].bleedBox,trimBox:Tt[t].trimBox,artBox:Tt[t].artBox,userUnit:Tt[t].userUnit,rootDictionaryObjId:Qt,resourceDictionaryObjId:te}));Kt(Qt,!0),ct("<</Type /Pages");var r="/Kids [";for(e=0;e<Rt;e++)r+=n[e]+" 0 R ";ct(r+"]"),ct("/Count "+Rt),ct(">>"),ct("endobj"),qt.publish("postPutPages")},oe=function(t){qt.publish("putFont",{font:t,out:ct,newObject:Jt,putStream:ie}),!0!==t.isAlreadyPutted&&(t.objectNumber=Jt(),ct("<<"),ct("/Type /Font"),ct("/BaseFont /"+C(t.postScriptName)),ct("/Subtype /Type1"),"string"==typeof t.encoding&&ct("/Encoding /"+t.encoding),ct("/FirstChar 32"),ct("/LastChar 255"),ct(">>"),ct("endobj"))},he=function(t){t.objectNumber=Jt();var e=[];e.push({key:"Type",value:"/XObject"}),e.push({key:"Subtype",value:"/Form"}),e.push({key:"BBox",value:"["+[O(t.x),O(t.y),O(t.x+t.width),O(t.y+t.height)].join(" ")+"]"}),e.push({key:"Matrix",value:"["+t.matrix.toString()+"]"});var n=t.pages[1].join("\n");ie({data:n,additionalKeyValues:e,objectId:t.objectNumber}),ct("endobj")},le=function(t,e){e||(e=21);var n=Jt(),r=function(t,e){var n,r=[],i=1/(e-1);for(n=0;n<1;n+=i)r.push(n);if(r.push(1),0!=t[0].offset){var a={offset:0,color:t[0].color};t.unshift(a)}if(1!=t[t.length-1].offset){var s={offset:1,color:t[t.length-1].color};t.push(s)}for(var o="",h=0,l=0;l<r.length;l++){for(n=r[l];n>t[h+1].offset;)h++;var c=t[h].offset,u=(n-c)/(t[h+1].offset-c),f=t[h].color,d=t[h+1].color;o+=tt(Math.round((1-u)*f[0]+u*d[0]).toString(16))+tt(Math.round((1-u)*f[1]+u*d[1]).toString(16))+tt(Math.round((1-u)*f[2]+u*d[2]).toString(16))}return o.trim()}(t.colors,e),i=[];i.push({key:"FunctionType",value:"0"}),i.push({key:"Domain",value:"[0.0 1.0]"}),i.push({key:"Size",value:"["+e+"]"}),i.push({key:"BitsPerSample",value:"8"}),i.push({key:"Range",value:"[0.0 1.0 0.0 1.0 0.0 1.0]"}),i.push({key:"Decode",value:"[0.0 1.0 0.0 1.0 0.0 1.0]"}),ie({data:r,additionalKeyValues:i,alreadyAppliedFilters:["/ASCIIHexDecode"],objectId:n}),ct("endobj"),t.objectNumber=Jt(),ct("<< /ShadingType "+t.type),ct("/ColorSpace /DeviceRGB");var a="/Coords ["+O(parseFloat(t.coords[0]))+" "+O(parseFloat(t.coords[1]))+" ";2===t.type?a+=O(parseFloat(t.coords[2]))+" "+O(parseFloat(t.coords[3])):a+=O(parseFloat(t.coords[2]))+" "+O(parseFloat(t.coords[3]))+" "+O(parseFloat(t.coords[4]))+" "+O(parseFloat(t.coords[5])),ct(a+="]"),t.matrix&&ct("/Matrix ["+t.matrix.toString()+"]"),ct("/Function "+n+" 0 R"),ct("/Extend [true true]"),ct(">>"),ct("endobj")},ce=function(t,e){var n=Xt(),r=Jt();e.push({resourcesOid:n,objectOid:r}),t.objectNumber=r;var i=[];i.push({key:"Type",value:"/Pattern"}),i.push({key:"PatternType",value:"1"}),i.push({key:"PaintType",value:"1"}),i.push({key:"TilingType",value:"1"}),i.push({key:"BBox",value:"["+t.boundingBox.map(O).join(" ")+"]"}),i.push({key:"XStep",value:O(t.xStep)}),i.push({key:"YStep",value:O(t.yStep)}),i.push({key:"Resources",value:n+" 0 R"}),t.matrix&&i.push({key:"Matrix",value:"["+t.matrix.toString()+"]"}),ie({data:t.stream,additionalKeyValues:i,objectId:t.objectNumber}),ct("endobj")},ue=function(t){for(var e in t.objectNumber=Jt(),ct("<<"),t)switch(e){case"opacity":ct("/ca "+D(t[e]));break;case"stroke-opacity":ct("/CA "+D(t[e]))}ct(">>"),ct("endobj")},fe=function(t){Kt(t.resourcesOid,!0),ct("<<"),ct("/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]"),function(){for(var t in ct("/Font <<"),Ft)Ft.hasOwnProperty(t)&&(!1===b||!0===b&&v.hasOwnProperty(t))&&ct("/"+t+" "+Ft[t].objectNumber+" 0 R");ct(">>")}(),function(){if(Object.keys(jt).length>0){for(var t in ct("/Shading <<"),jt)jt.hasOwnProperty(t)&&jt[t]instanceof B&&jt[t].objectNumber>=0&&ct("/"+t+" "+jt[t].objectNumber+" 0 R");qt.publish("putShadingPatternDict"),ct(">>")}}(),function(t){if(Object.keys(jt).length>0){for(var e in ct("/Pattern <<"),jt)jt.hasOwnProperty(e)&&jt[e]instanceof w.TilingPattern&&jt[e].objectNumber>=0&&jt[e].objectNumber<t&&ct("/"+e+" "+jt[e].objectNumber+" 0 R");qt.publish("putTilingPatternDict"),ct(">>")}}(t.objectOid),function(){if(Object.keys(Ot).length>0){var t;for(t in ct("/ExtGState <<"),Ot)Ot.hasOwnProperty(t)&&Ot[t].objectNumber>=0&&ct("/"+t+" "+Ot[t].objectNumber+" 0 R");qt.publish("putGStateDict"),ct(">>")}}(),function(){for(var t in ct("/XObject <<"),zt)zt.hasOwnProperty(t)&&zt[t].objectNumber>=0&&ct("/"+t+" "+zt[t].objectNumber+" 0 R");qt.publish("putXobjectDict"),ct(">>")}(),ct(">>"),ct("endobj")},de=function(t){It[t.fontName]=It[t.fontName]||{},It[t.fontName][t.fontStyle]=t.id},pe=function(t,e,n,r,i){var a={id:"F"+(Object.keys(Ft).length+1).toString(10),postScriptName:t,fontName:e,fontStyle:n,encoding:r,isStandardFont:i||!1,metadata:{}};return qt.publish("addFont",{font:a,instance:this}),Ft[a.id]=a,de(a),a.id},ge=w.__private__.pdfEscape=w.pdfEscape=function(t,e){return function(t,e){var n,r,i,a,s,o,h,l,c;if(i=(e=e||{}).sourceEncoding||"Unicode",s=e.outputEncoding,(e.autoencode||s)&&Ft[Lt].metadata&&Ft[Lt].metadata[i]&&Ft[Lt].metadata[i].encoding&&(a=Ft[Lt].metadata[i].encoding,!s&&Ft[Lt].encoding&&(s=Ft[Lt].encoding),!s&&a.codePages&&(s=a.codePages[0]),"string"==typeof s&&(s=a[s]),s)){for(h=!1,o=[],n=0,r=t.length;n<r;n++)(l=s[t.charCodeAt(n)])?o.push(String.fromCharCode(l)):o.push(t[n]),o[n].charCodeAt(0)>>8&&(h=!0);t=o.join("")}for(n=t.length;void 0===h&&0!==n;)t.charCodeAt(n-1)>>8&&(h=!0),n--;if(!h)return t;for(o=e.noBOM?[]:[254,255],n=0,r=t.length;n<r;n++){if((c=(l=t.charCodeAt(n))>>8)>>8)throw new Error("Character at position "+n+" of string '"+t+"' exceeds 16bits. Cannot be encoded into UCS-2 BE");o.push(c),o.push(l-(c<<8))}return String.fromCharCode.apply(void 0,o)}(t,e).replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")},me=w.__private__.beginPage=function(t){st[++Rt]=[],Tt[Rt]={objId:0,contentsObjId:0,userUnit:Number(f),artBox:null,bleedBox:null,cropBox:null,trimBox:null,mediaBox:{bottomLeftX:0,bottomLeftY:0,topRightX:Number(t[0]),topRightY:Number(t[1])}},we(Rt),lt(st[$])},be=function(t,e){var r,i,a;switch(n=e||n,"string"==typeof t&&(r=A(t.toLowerCase()),Array.isArray(r)&&(i=r[0],a=r[1])),Array.isArray(t)&&(i=t[0]*Nt,a=t[1]*Nt),isNaN(i)&&(i=o[0],a=o[1]),(i>14400||a>14400)&&(s.warn("A page in a PDF can not be wider or taller than 14400 userUnit. jsPDF limits the width/height to 14400"),i=Math.min(14400,i),a=Math.min(14400,a)),o=[i,a],n.substr(0,1)){case"l":a>i&&(o=[a,i]);break;case"p":i>a&&(o=[a,i])}me(o),Ke(Je),ct(sn),0!==fn&&ct(fn+" J"),0!==dn&&ct(dn+" j"),qt.publish("addPage",{pageNumber:Rt})},ve=function(t){t>0&&t<=Rt&&(st.splice(t,1),Tt.splice(t,1),Rt--,$>Rt&&($=Rt),this.setPage($))},we=function(t){t>0&&t<=Rt&&($=t)},ye=w.__private__.getNumberOfPages=w.getNumberOfPages=function(){return st.length-1},_e=function(t,e,n){var r,i=void 0;return n=n||{},t=void 0!==t?t:Ft[Lt].fontName,e=void 0!==e?e:Ft[Lt].fontStyle,r=t.toLowerCase(),void 0!==It[r]&&void 0!==It[r][e]?i=It[r][e]:void 0!==It[t]&&void 0!==It[t][e]?i=It[t][e]:!1===n.disableWarning&&s.warn("Unable to look up font label for font '"+t+"', '"+e+"'. Refer to getFontList() for available fonts."),i||n.noFallback||null==(i=It.times[e])&&(i=It.times.normal),i},xe=w.__private__.putInfo=function(){var t=Jt(),e=function(t){return t};for(var n in null!==m&&(e=Ce.encryptor(t,0)),ct("<<"),ct("/Producer ("+ge(e("jsPDF "+R.version))+")"),At)At.hasOwnProperty(n)&&At[n]&&ct("/"+n.substr(0,1).toUpperCase()+n.substr(1)+" ("+ge(e(At[n]))+")");ct("/CreationDate ("+ge(e(W))+")"),ct(">>"),ct("endobj")},Ae=w.__private__.putCatalog=function(t){var e=(t=t||{}).rootDictionaryObjId||Qt;switch(Jt(),ct("<<"),ct("/Type /Catalog"),ct("/Pages "+e+" 0 R"),gt||(gt="fullwidth"),gt){case"fullwidth":ct("/OpenAction [3 0 R /FitH null]");break;case"fullheight":ct("/OpenAction [3 0 R /FitV null]");break;case"fullpage":ct("/OpenAction [3 0 R /Fit]");break;case"original":ct("/OpenAction [3 0 R /XYZ null null 1]");break;default:var n=""+gt;"%"===n.substr(n.length-1)&&(gt=parseInt(gt)/100),"number"==typeof gt&&ct("/OpenAction [3 0 R /XYZ null null "+D(gt)+"]")}switch(yt||(yt="continuous"),yt){case"continuous":ct("/PageLayout /OneColumn");break;case"single":ct("/PageLayout /SinglePage");break;case"two":case"twoleft":ct("/PageLayout /TwoColumnLeft");break;case"tworight":ct("/PageLayout /TwoColumnRight")}vt&&ct("/PageMode /"+vt),qt.publish("putCatalog"),ct(">>"),ct("endobj")},Le=w.__private__.putTrailer=function(){ct("trailer"),ct("<<"),ct("/Size "+(et+1)),ct("/Root "+et+" 0 R"),ct("/Info "+(et-1)+" 0 R"),null!==m&&ct("/Encrypt "+Ce.oid+" 0 R"),ct("/ID [ <"+V+"> <"+V+"> ]"),ct(">>")},Ne=w.__private__.putHeader=function(){ct("%PDF-"+y),ct("%ºß¬à")},Se=w.__private__.putXRef=function(){var t="0000000000";ct("xref"),ct("0 "+(et+1)),ct("0000000000 65535 f ");for(var e=1;e<=et;e++)"function"==typeof nt[e]?ct((t+nt[e]()).slice(-10)+" 00000 n "):void 0!==nt[e]?ct((t+nt[e]).slice(-10)+" 00000 n "):ct("0000000000 00000 n ")},ke=w.__private__.buildDocument=function(){var t;et=0,it=0,rt=[],nt=[],at=[],Qt=Xt(),te=Xt(),lt(rt),qt.publish("buildDocument"),Ne(),se(),function(){qt.publish("putAdditionalObjects");for(var t=0;t<at.length;t++){var e=at[t];Kt(e.objId,!0),ct(e.content),ct("endobj")}qt.publish("postPutAdditionalObjects")}(),t=[],function(){for(var t in Ft)Ft.hasOwnProperty(t)&&(!1===b||!0===b&&v.hasOwnProperty(t))&&oe(Ft[t])}(),function(){var t;for(t in Ot)Ot.hasOwnProperty(t)&&ue(Ot[t])}(),function(){for(var t in zt)zt.hasOwnProperty(t)&&he(zt[t])}(),function(t){var e;for(e in jt)jt.hasOwnProperty(e)&&(jt[e]instanceof B?le(jt[e]):jt[e]instanceof M&&ce(jt[e],t))}(t),qt.publish("putResources"),t.forEach(fe),fe({resourcesOid:te,objectOid:Number.MAX_SAFE_INTEGER}),qt.publish("postPutResources"),null!==m&&(Ce.oid=Jt(),ct("<<"),ct("/Filter /Standard"),ct("/V "+Ce.v),ct("/R "+Ce.r),ct("/U <"+Ce.toHexString(Ce.U)+">"),ct("/O <"+Ce.toHexString(Ce.O)+">"),ct("/P "+Ce.P),ct(">>"),ct("endobj")),xe(),Ae();var e=it;return Se(),Le(),ct("startxref"),ct(""+e),ct("%%EOF"),lt(st[$]),rt.join("\n")},Pe=w.__private__.getBlob=function(t){return new Blob([ft(t)],{type:"application/pdf"})},Fe=w.output=w.__private__.output=(Zt=function(t,e){switch("string"==typeof(e=e||{})?e={filename:e}:e.filename=e.filename||"generated.pdf",t){case void 0:return ke();case"save":w.save(e.filename);break;case"arraybuffer":return ft(ke());case"blob":return Pe(ke());case"bloburi":case"bloburl":if(void 0!==i.URL&&"function"==typeof i.URL.createObjectURL)return i.URL&&i.URL.createObjectURL(Pe(ke()))||void 0;s.warn("bloburl is not supported by your system, because URL.createObjectURL is not supported by your browser.");break;case"datauristring":case"dataurlstring":var n="",r=ke();try{n=d(r)}catch(m){n=d(unescape(encodeURIComponent(r)))}return"data:application/pdf;filename="+e.filename+";base64,"+n;case"pdfobjectnewwindow":if("[object Window]"===Object.prototype.toString.call(i)){var a="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js",o=' integrity="sha512-4ze/a9/4jqu+tX9dfOqJYSvyYd5M6qum/3HpCLr+/Jqf0whc37VUbkpNGHR7/8pSnCFw47T1fmIpwBV7UySh3g==" crossorigin="anonymous"';e.pdfObjectUrl&&(a=e.pdfObjectUrl,o="");var h='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><script src="'+a+'"'+o+'><\/script><script >PDFObject.embed("'+this.output("dataurlstring")+'", '+JSON.stringify(e)+");<\/script></body></html>",l=i.open();return null!==l&&l.document.write(h),l}throw new Error("The option pdfobjectnewwindow just works in a browser-environment.");case"pdfjsnewwindow":if("[object Window]"===Object.prototype.toString.call(i)){var c='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><iframe id="pdfViewer" src="'+(e.pdfJsUrl||"examples/PDF.js/web/viewer.html")+"?file=&downloadName="+e.filename+'" width="500px" height="400px" /></body></html>',u=i.open();if(null!==u){u.document.write(c);var f=this;u.document.documentElement.querySelector("#pdfViewer").onload=function(){u.document.title=e.filename,u.document.documentElement.querySelector("#pdfViewer").contentWindow.PDFViewerApplication.open(f.output("bloburl"))}}return u}throw new Error("The option pdfjsnewwindow just works in a browser-environment.");case"dataurlnewwindow":if("[object Window]"!==Object.prototype.toString.call(i))throw new Error("The option dataurlnewwindow just works in a browser-environment.");var p='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><iframe src="'+this.output("datauristring",e)+'"></iframe></body></html>',g=i.open();if(null!==g&&(g.document.write(p),g.document.title=e.filename),g||"undefined"==typeof safari)return g;break;case"datauri":case"dataurl":return i.document.location.href=this.output("datauristring",e);default:return null}},Zt.foo=function(){try{return Zt.apply(this,arguments)}catch(n){var t=n.stack||"";~t.indexOf(" at ")&&(t=t.split(" at ")[1]);var e="Error in function "+t.split("\n")[0].split("<")[0]+": "+n.message;if(!i.console)throw new Error(e);i.console.error(e,n),i.alert&&alert(e)}},Zt.foo.bar=Zt,Zt.foo),Ie=function(t){return!0===Array.isArray(Dt)&&Dt.indexOf(t)>-1};switch(a){case"pt":Nt=1;break;case"mm":Nt=72/25.4;break;case"cm":Nt=72/2.54;break;case"in":Nt=72;break;case"px":Nt=1==Ie("px_scaling")?.75:96/72;break;case"pc":case"em":Nt=12;break;case"ex":Nt=6;break;default:if("number"!=typeof a)throw new Error("Invalid unit: "+a);Nt=a}var Ce=null;X(),Y();var je=w.__private__.getPageInfo=w.getPageInfo=function(t){if(isNaN(t)||t%1!=0)throw new Error("Invalid argument passed to jsPDF.getPageInfo");return{objId:Tt[t].objId,pageNumber:t,pageContext:Tt[t]}},Ee=w.__private__.getPageInfoByObjId=function(t){if(isNaN(t)||t%1!=0)throw new Error("Invalid argument passed to jsPDF.getPageInfoByObjId");for(var e in Tt)if(Tt[e].objId===t)break;return je(e)},Oe=w.__private__.getCurrentPageInfo=w.getCurrentPageInfo=function(){return{objId:Tt[$].objId,pageNumber:$,pageContext:Tt[$]}};w.addPage=function(){return be.apply(this,arguments),this},w.setPage=function(){return we.apply(this,arguments),lt.call(this,st[$]),this},w.insertPage=function(t){return this.addPage(),this.movePage($,t),this},w.movePage=function(t,e){var n,r;if(t>e){n=st[t],r=Tt[t];for(var i=t;i>e;i--)st[i]=st[i-1],Tt[i]=Tt[i-1];st[e]=n,Tt[e]=r,this.setPage(e)}else if(t<e){n=st[t],r=Tt[t];for(var a=t;a<e;a++)st[a]=st[a+1],Tt[a]=Tt[a+1];st[e]=n,Tt[e]=r,this.setPage(e)}return this},w.deletePage=function(){return ve.apply(this,arguments),this},w.__private__.text=w.text=function(t,e,n,i,a){var s,o,h,l,c,u,f,d,p,g=(i=i||{}).scope||this;if("number"==typeof t&&"number"==typeof e&&("string"==typeof n||Array.isArray(n))){var m=n;n=e,e=t,t=m}if(arguments[3]instanceof Wt==0?(h=arguments[4],l=arguments[5],"object"===r(f=arguments[3])&&null!==f||("string"==typeof h&&(l=h,h=null),"string"==typeof f&&(l=f,f=null),"number"==typeof f&&(h=f,f=null),i={flags:f,angle:h,align:l})):(T("The transform parameter of text() with a Matrix value"),p=a),isNaN(e)||isNaN(n)||null==t)throw new Error("Invalid arguments passed to jsPDF.text");if(0===t.length)return g;var b,w="",y="number"==typeof i.lineHeightFactor?i.lineHeightFactor:Ze,_=g.internal.scaleFactor;function x(t){return t=t.split("\t").join(Array(i.TabLen||9).join(" ")),ge(t,f)}function A(t){for(var e,n=t.concat(),r=[],i=n.length;i--;)"string"==typeof(e=n.shift())?r.push(e):Array.isArray(t)&&(1===e.length||void 0===e[1]&&void 0===e[2])?r.push(e[0]):r.push([e[0],e[1],e[2]]);return r}function L(t,e){var n;if("string"==typeof t)n=e(t)[0];else if(Array.isArray(t)){for(var r,i,a=t.concat(),s=[],o=a.length;o--;)"string"==typeof(r=a.shift())?s.push(e(r)[0]):Array.isArray(r)&&"string"==typeof r[0]&&(i=e(r[0],r[1],r[2]),s.push([i[0],i[1],i[2]]));n=s}return n}var k=!1,P=!0;if("string"==typeof t)k=!0;else if(Array.isArray(t)){var F=t.concat();o=[];for(var I,C=F.length;C--;)("string"!=typeof(I=F.shift())||Array.isArray(I)&&"string"!=typeof I[0])&&(P=!1);k=P}if(!1===k)throw new Error('Type of text must be string or Array. "'+t+'" is not recognized.');"string"==typeof t&&(t=t.match(/[\r?\n]/)?t.split(/\r\n|\r|\n/g):[t]);var j=pt/g.internal.scaleFactor,E=j*(y-1);switch(i.baseline){case"bottom":n-=E;break;case"top":n+=j-E;break;case"hanging":n+=j-2*E;break;case"middle":n+=j/2-E}if((u=i.maxWidth||0)>0&&("string"==typeof t?t=g.splitTextToSize(t,u):"[object Array]"===Object.prototype.toString.call(t)&&(t=t.reduce(function(t,e){return t.concat(g.splitTextToSize(e,u))},[]))),s={text:t,x:e,y:n,options:i,mutex:{pdfEscape:ge,activeFontKey:Lt,fonts:Ft,activeFontSize:pt}},qt.publish("preProcessText",s),t=s.text,h=(i=s.options).angle,p instanceof Wt==0&&h&&"number"==typeof h){h*=Math.PI/180,0===i.rotationDirection&&(h=-h),S===N&&(h=-h);var B=Math.cos(h),M=Math.sin(h);p=new Wt(B,M,-M,B,0,0)}else h&&h instanceof Wt&&(p=h);S!==N||p||(p=Gt),void 0!==(c=i.charSpace||cn)&&(w+=O(U(c))+" Tc\n",this.setCharSpace(this.getCharSpace()||0)),void 0!==(d=i.horizontalScale)&&(w+=O(100*d)+" Tz\n"),i.lang;var R=-1,q=void 0!==i.renderingMode?i.renderingMode:i.stroke,D=g.internal.getCurrentPageInfo().pageContext;switch(q){case 0:case!1:case"fill":R=0;break;case 1:case!0:case"stroke":R=1;break;case 2:case"fillThenStroke":R=2;break;case 3:case"invisible":R=3;break;case 4:case"fillAndAddForClipping":R=4;break;case 5:case"strokeAndAddPathForClipping":R=5;break;case 6:case"fillThenStrokeAndAddToPathForClipping":R=6;break;case 7:case"addToPathForClipping":R=7}var z=void 0!==D.usedRenderingMode?D.usedRenderingMode:-1;-1!==R?w+=R+" Tr\n":-1!==z&&(w+="0 Tr\n"),-1!==R&&(D.usedRenderingMode=R),l=i.align||"left";var H,W=pt*y,V=g.internal.pageSize.getWidth(),G=Ft[Lt];c=i.charSpace||cn,u=i.maxWidth||0,f=Object.assign({autoencode:!0,noBOM:!0},i.flags);var Y=[],Z=function(t){return g.getStringUnitWidth(t,{font:G,charSpace:c,fontSize:pt,doKerning:!1})*pt/_};if("[object Array]"===Object.prototype.toString.call(t)){var J;o=A(t),"left"!==l&&(H=o.map(Z));var X,K=0;if("right"===l){e-=H[0],t=[],C=o.length;for(var $=0;$<C;$++)0===$?(X=en(e),J=nn(n)):(X=U(K-H[$]),J=-W),t.push([o[$],X,J]),K=H[$]}else if("center"===l){e-=H[0]/2,t=[],C=o.length;for(var Q=0;Q<C;Q++)0===Q?(X=en(e),J=nn(n)):(X=U((K-H[Q])/2),J=-W),t.push([o[Q],X,J]),K=H[Q]}else if("left"===l){t=[],C=o.length;for(var tt=0;tt<C;tt++)t.push(o[tt])}else if("justify"===l&&"Identity-H"===G.encoding){t=[],C=o.length,u=0!==u?u:V;for(var et=0,nt=0;nt<C;nt++)if(J=0===nt?nn(n):-W,X=0===nt?en(e):et,nt<C-1){var rt=U((u-H[nt])/(o[nt].split(" ").length-1)),it=o[nt].split(" ");t.push([it[0]+" ",X,J]),et=0;for(var at=1;at<it.length;at++){var st=(Z(it[at-1]+" "+it[at])-Z(it[at]))*_+rt;at==it.length-1?t.push([it[at],st,0]):t.push([it[at]+" ",st,0]),et-=st}}else t.push([o[nt],X,J]);t.push(["",et,0])}else{if("justify"!==l)throw new Error('Unrecognized alignment option, use "left", "center", "right" or "justify".');for(t=[],C=o.length,u=0!==u?u:V,nt=0;nt<C;nt++){J=0===nt?nn(n):-W,X=0===nt?en(e):0;var ot=o[nt].split(" ").length-1,ht=ot>0?(u-H[nt])/ot:0;nt<C-1?Y.push(O(U(ht))):Y.push(0),t.push([o[nt],X,J])}}}!0===("boolean"==typeof i.R2L?i.R2L:bt)&&(t=L(t,function(t,e,n){return[t.split("").reverse().join(""),e,n]})),s={text:t,x:e,y:n,options:i,mutex:{pdfEscape:ge,activeFontKey:Lt,fonts:Ft,activeFontSize:pt}},qt.publish("postProcessText",s),t=s.text,b=s.mutex.isHex||!1;var lt=Ft[Lt].encoding;"WinAnsiEncoding"!==lt&&"StandardEncoding"!==lt||(t=L(t,function(t,e,n){return[x(t),e,n]})),o=A(t),t=[];for(var ut,ft,dt,gt=Array.isArray(o[0])?1:0,mt="",vt=function(t,e,n){var r="";return n instanceof Wt?(n="number"==typeof i.angle?Vt(n,new Wt(1,0,0,1,t,e)):Vt(new Wt(1,0,0,1,t,e),n),S===N&&(n=Vt(new Wt(1,0,0,-1,0,0),n)),r=n.join(" ")+" Tm\n"):r=O(t)+" "+O(e)+" Td\n",r},wt=0;wt<o.length;wt++){switch(mt="",gt){case 1:dt=(b?"<":"(")+o[wt][0]+(b?">":")"),ut=parseFloat(o[wt][1]),ft=parseFloat(o[wt][2]);break;case 0:dt=(b?"<":"(")+o[wt]+(b?">":")"),ut=en(e),ft=nn(n)}void 0!==Y&&void 0!==Y[wt]&&(mt=Y[wt]+" Tw\n"),0===wt?t.push(mt+vt(ut,ft,p)+dt):0===gt?t.push(mt+dt):1===gt&&t.push(mt+vt(ut,ft,p)+dt)}t=0===gt?t.join(" Tj\nT* "):t.join(" Tj\n"),t+=" Tj\n";var yt="BT\n/";return yt+=Lt+" "+pt+" Tf\n",yt+=O(pt*y)+" TL\n",yt+=hn+"\n",yt+=w,yt+=t,ct(yt+="ET"),v[Lt]=!0,g};var Be=w.__private__.clip=w.clip=function(t){return ct("evenodd"===t?"W*":"W"),this};w.clipEvenOdd=function(){return Be("evenodd")},w.__private__.discardPath=w.discardPath=function(){return ct("n"),this};var Me=w.__private__.isValidStyle=function(t){var e=!1;return-1!==[void 0,null,"S","D","F","DF","FD","f","f*","B","B*","n"].indexOf(t)&&(e=!0),e};w.__private__.setDefaultPathOperation=w.setDefaultPathOperation=function(t){return Me(t)&&(g=t),this};var Re=w.__private__.getStyle=w.getStyle=function(t){var e=g;switch(t){case"D":case"S":e="S";break;case"F":e="f";break;case"FD":case"DF":e="B";break;case"f":case"f*":case"B":case"B*":e=t}return e},Te=w.close=function(){return ct("h"),this};w.stroke=function(){return ct("S"),this},w.fill=function(t){return qe("f",t),this},w.fillEvenOdd=function(t){return qe("f*",t),this},w.fillStroke=function(t){return qe("B",t),this},w.fillStrokeEvenOdd=function(t){return qe("B*",t),this};var qe=function(t,e){"object"===r(e)?Ue(e,t):ct(t)},De=function(t){null===t||S===N&&void 0===t||(t=Re(t),ct(t))};function ze(t,e,n,r,i){var a=new M(e||this.boundingBox,n||this.xStep,r||this.yStep,this.gState,i||this.matrix);a.stream=this.stream;var s=t+"$$"+this.cloneIndex+++"$$";return Yt(s,a),a}var Ue=function(t,e){var n=Et[t.key],r=jt[n];if(r instanceof B)ct("q"),ct(He(e)),r.gState&&w.setGState(r.gState),ct(t.matrix.toString()+" cm"),ct("/"+n+" sh"),ct("Q");else if(r instanceof M){var i=new Wt(1,0,0,-1,0,Sn());t.matrix&&(i=i.multiply(t.matrix||Gt),n=ze.call(r,t.key,t.boundingBox,t.xStep,t.yStep,i).id),ct("q"),ct("/Pattern cs"),ct("/"+n+" scn"),r.gState&&w.setGState(r.gState),ct(e),ct("Q")}},He=function(t){switch(t){case"f":case"F":case"n":return"W n";case"f*":return"W* n";case"B":case"S":return"W S";case"B*":return"W* S"}},We=w.moveTo=function(t,e){return ct(O(U(t))+" "+O(H(e))+" m"),this},Ve=w.lineTo=function(t,e){return ct(O(U(t))+" "+O(H(e))+" l"),this},Ge=w.curveTo=function(t,e,n,r,i,a){return ct([O(U(t)),O(H(e)),O(U(n)),O(H(r)),O(U(i)),O(H(a)),"c"].join(" ")),this};w.__private__.line=w.line=function(t,e,n,r,i){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||!Me(i))throw new Error("Invalid arguments passed to jsPDF.line");return S===L?this.lines([[n-t,r-e]],t,e,[1,1],i||"S"):this.lines([[n-t,r-e]],t,e,[1,1]).stroke()},w.__private__.lines=w.lines=function(t,e,n,r,i,a){var s,o,h,l,c,u,f,d,p,g,m,b;if("number"==typeof t&&(b=n,n=e,e=t,t=b),r=r||[1,1],a=a||!1,isNaN(e)||isNaN(n)||!Array.isArray(t)||!Array.isArray(r)||!Me(i)||"boolean"!=typeof a)throw new Error("Invalid arguments passed to jsPDF.lines");for(We(e,n),s=r[0],o=r[1],l=t.length,g=e,m=n,h=0;h<l;h++)2===(c=t[h]).length?(g=c[0]*s+g,m=c[1]*o+m,Ve(g,m)):(u=c[0]*s+g,f=c[1]*o+m,d=c[2]*s+g,p=c[3]*o+m,g=c[4]*s+g,m=c[5]*o+m,Ge(u,f,d,p,g,m));return a&&Te(),De(i),this},w.path=function(t){for(var e=0;e<t.length;e++){var n=t[e],r=n.c;switch(n.op){case"m":We(r[0],r[1]);break;case"l":Ve(r[0],r[1]);break;case"c":Ge.apply(this,r);break;case"h":Te()}}return this},w.__private__.rect=w.rect=function(t,e,n,r,i){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||!Me(i))throw new Error("Invalid arguments passed to jsPDF.rect");return S===L&&(r=-r),ct([O(U(t)),O(H(e)),O(U(n)),O(U(r)),"re"].join(" ")),De(i),this},w.__private__.triangle=w.triangle=function(t,e,n,r,i,a,s){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||isNaN(i)||isNaN(a)||!Me(s))throw new Error("Invalid arguments passed to jsPDF.triangle");return this.lines([[n-t,r-e],[i-n,a-r],[t-i,e-a]],t,e,[1,1],s,!0),this},w.__private__.roundedRect=w.roundedRect=function(t,e,n,r,i,a,s){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||isNaN(i)||isNaN(a)||!Me(s))throw new Error("Invalid arguments passed to jsPDF.roundedRect");var o=4/3*(Math.SQRT2-1);return i=Math.min(i,.5*n),a=Math.min(a,.5*r),this.lines([[n-2*i,0],[i*o,0,i,a-a*o,i,a],[0,r-2*a],[0,a*o,-i*o,a,-i,a],[2*i-n,0],[-i*o,0,-i,-a*o,-i,-a],[0,2*a-r],[0,-a*o,i*o,-a,i,-a]],t+i,e,[1,1],s,!0),this},w.__private__.ellipse=w.ellipse=function(t,e,n,r,i){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||!Me(i))throw new Error("Invalid arguments passed to jsPDF.ellipse");var a=4/3*(Math.SQRT2-1)*n,s=4/3*(Math.SQRT2-1)*r;return We(t+n,e),Ge(t+n,e-s,t+a,e-r,t,e-r),Ge(t-a,e-r,t-n,e-s,t-n,e),Ge(t-n,e+s,t-a,e+r,t,e+r),Ge(t+a,e+r,t+n,e+s,t+n,e),De(i),this},w.__private__.circle=w.circle=function(t,e,n,r){if(isNaN(t)||isNaN(e)||isNaN(n)||!Me(r))throw new Error("Invalid arguments passed to jsPDF.circle");return this.ellipse(t,e,n,n,r)},w.setFont=function(t,e,n){return n&&(e=F(e,n)),Lt=_e(t,e,{disableWarning:!1}),this};var Ye=w.__private__.getFont=w.getFont=function(){return Ft[_e.apply(w,arguments)]};w.__private__.getFontList=w.getFontList=function(){var t,e,n={};for(t in It)if(It.hasOwnProperty(t))for(e in n[t]=[],It[t])It[t].hasOwnProperty(e)&&n[t].push(e);return n},w.addFont=function(t,e,n,r,i){var a=["StandardEncoding","MacRomanEncoding","Identity-H","WinAnsiEncoding"];return arguments[3]&&-1!==a.indexOf(arguments[3])?i=arguments[3]:arguments[3]&&-1==a.indexOf(arguments[3])&&(n=F(n,r)),pe.call(this,t,e,n,i=i||"Identity-H")};var Ze,Je=t.lineWidth||.200025,Xe=w.__private__.getLineWidth=w.getLineWidth=function(){return Je},Ke=w.__private__.setLineWidth=w.setLineWidth=function(t){return Je=t,ct(O(U(t))+" w"),this};w.__private__.setLineDash=R.API.setLineDash=R.API.setLineDashPattern=function(t,e){if(t=t||[],e=e||0,isNaN(e)||!Array.isArray(t))throw new Error("Invalid arguments passed to jsPDF.setLineDash");return t=t.map(function(t){return O(U(t))}).join(" "),e=O(U(e)),ct("["+t+"] "+e+" d"),this};var $e=w.__private__.getLineHeight=w.getLineHeight=function(){return pt*Ze};w.__private__.getLineHeight=w.getLineHeight=function(){return pt*Ze};var Qe=w.__private__.setLineHeightFactor=w.setLineHeightFactor=function(t){return"number"==typeof(t=t||1.15)&&(Ze=t),this},tn=w.__private__.getLineHeightFactor=w.getLineHeightFactor=function(){return Ze};Qe(t.lineHeight);var en=w.__private__.getHorizontalCoordinate=function(t){return U(t)},nn=w.__private__.getVerticalCoordinate=function(t){return S===N?t:Tt[$].mediaBox.topRightY-Tt[$].mediaBox.bottomLeftY-U(t)},rn=w.__private__.getHorizontalCoordinateString=w.getHorizontalCoordinateString=function(t){return O(en(t))},an=w.__private__.getVerticalCoordinateString=w.getVerticalCoordinateString=function(t){return O(nn(t))},sn=t.strokeColor||"0 G";w.__private__.getStrokeColor=w.getDrawColor=function(){return ee(sn)},w.__private__.setStrokeColor=w.setDrawColor=function(t,e,n,r){return sn=ne({ch1:t,ch2:e,ch3:n,ch4:r,pdfColorType:"draw",precision:2}),ct(sn),this};var on=t.fillColor||"0 g";w.__private__.getFillColor=w.getFillColor=function(){return ee(on)},w.__private__.setFillColor=w.setFillColor=function(t,e,n,r){return on=ne({ch1:t,ch2:e,ch3:n,ch4:r,pdfColorType:"fill",precision:2}),ct(on),this};var hn=t.textColor||"0 g",ln=w.__private__.getTextColor=w.getTextColor=function(){return ee(hn)};w.__private__.setTextColor=w.setTextColor=function(t,e,n,r){return hn=ne({ch1:t,ch2:e,ch3:n,ch4:r,pdfColorType:"text",precision:3}),this};var cn=t.charSpace,un=w.__private__.getCharSpace=w.getCharSpace=function(){return parseFloat(cn||0)};w.__private__.setCharSpace=w.setCharSpace=function(t){if(isNaN(t))throw new Error("Invalid argument passed to jsPDF.setCharSpace");return cn=t,this};var fn=0;w.CapJoinStyles={0:0,butt:0,but:0,miter:0,1:1,round:1,rounded:1,circle:1,2:2,projecting:2,project:2,square:2,bevel:2},w.__private__.setLineCap=w.setLineCap=function(t){var e=w.CapJoinStyles[t];if(void 0===e)throw new Error("Line cap style of '"+t+"' is not recognized. See or extend .CapJoinStyles property for valid styles");return fn=e,ct(e+" J"),this};var dn=0;w.__private__.setLineJoin=w.setLineJoin=function(t){var e=w.CapJoinStyles[t];if(void 0===e)throw new Error("Line join style of '"+t+"' is not recognized. See or extend .CapJoinStyles property for valid styles");return dn=e,ct(e+" j"),this},w.__private__.setLineMiterLimit=w.__private__.setMiterLimit=w.setLineMiterLimit=w.setMiterLimit=function(t){if(t=t||0,isNaN(t))throw new Error("Invalid argument passed to jsPDF.setLineMiterLimit");return ct(O(U(t))+" M"),this},w.GState=E,w.setGState=function(t){(t="string"==typeof t?Ot[Bt[t]]:pn(null,t)).equals(Mt)||(ct("/"+t.id+" gs"),Mt=t)};var pn=function(t,e){if(!t||!Bt[t]){var n=!1;for(var r in Ot)if(Ot.hasOwnProperty(r)&&Ot[r].equals(e)){n=!0;break}if(n)e=Ot[r];else{var i="GS"+(Object.keys(Ot).length+1).toString(10);Ot[i]=e,e.id=i}return t&&(Bt[t]=e.id),qt.publish("addGState",e),e}};w.addGState=function(t,e){return pn(t,e),this},w.saveGraphicsState=function(){return ct("q"),Ct.push({key:Lt,size:pt,color:hn}),this},w.restoreGraphicsState=function(){ct("Q");var t=Ct.pop();return Lt=t.key,pt=t.size,hn=t.color,Mt=null,this},w.setCurrentTransformationMatrix=function(t){return ct(t.toString()+" cm"),this},w.comment=function(t){return ct("#"+t),this};var gn=function(t,e){var n=t||0;Object.defineProperty(this,"x",{enumerable:!0,get:function(){return n},set:function(t){isNaN(t)||(n=parseFloat(t))}});var r=e||0;Object.defineProperty(this,"y",{enumerable:!0,get:function(){return r},set:function(t){isNaN(t)||(r=parseFloat(t))}});var i="pt";return Object.defineProperty(this,"type",{enumerable:!0,get:function(){return i},set:function(t){i=t.toString()}}),this},mn=function(t,e,n,r){gn.call(this,t,e),this.type="rect";var i=n||0;Object.defineProperty(this,"w",{enumerable:!0,get:function(){return i},set:function(t){isNaN(t)||(i=parseFloat(t))}});var a=r||0;return Object.defineProperty(this,"h",{enumerable:!0,get:function(){return a},set:function(t){isNaN(t)||(a=parseFloat(t))}}),this},bn=function(){this.page=Rt,this.currentPage=$,this.pages=st.slice(0),this.pagesContext=Tt.slice(0),this.x=St,this.y=kt,this.matrix=Pt,this.width=yn($),this.height=xn($),this.outputDestination=ht,this.id="",this.objectNumber=-1};bn.prototype.restore=function(){Rt=this.page,$=this.currentPage,Tt=this.pagesContext,st=this.pages,St=this.x,kt=this.y,Pt=this.matrix,_n($,this.width),An($,this.height),ht=this.outputDestination};var vn=function(t,e,n,r,i){Ht.push(new bn),Rt=$=0,st=[],St=t,kt=e,Pt=i,me([n,r])};for(var wn in w.beginFormObject=function(t,e,n,r,i){return vn(t,e,n,r,i),this},w.endFormObject=function(t){return function(t){if(Ut[t])Ht.pop().restore();else{var e=new bn,n="Xo"+(Object.keys(zt).length+1).toString(10);e.id=n,Ut[t]=n,zt[n]=e,qt.publish("addFormObject",e),Ht.pop().restore()}}(t),this},w.doFormObject=function(t,e){var n=zt[Ut[t]];return ct("q"),ct(e.toString()+" cm"),ct("/"+n.id+" Do"),ct("Q"),this},w.getFormObject=function(t){var e=zt[Ut[t]];return{x:e.x,y:e.y,width:e.width,height:e.height,matrix:e.matrix}},w.save=function(t,e){return t=t||"generated.pdf",(e=e||{}).returnPromise=e.returnPromise||!1,!1===e.returnPromise?(c(Pe(ke()),t),"function"==typeof c.unload&&i.setTimeout&&setTimeout(c.unload,911),this):new Promise(function(e,n){try{var r=c(Pe(ke()),t);"function"==typeof c.unload&&i.setTimeout&&setTimeout(c.unload,911),e(r)}catch(a){n(a.message)}})},R.API)R.API.hasOwnProperty(wn)&&("events"===wn&&R.API.events.length?function(t,e){var n,r,i;for(i=e.length-1;-1!==i;i--)n=e[i][0],r=e[i][1],t.subscribe.apply(t,[n].concat("function"==typeof r?[r]:r))}(qt,R.API.events):w[wn]=R.API[wn]);function yn(t){return Tt[t].mediaBox.topRightX-Tt[t].mediaBox.bottomLeftX}function _n(t,e){Tt[t].mediaBox.topRightX=e+Tt[t].mediaBox.bottomLeftX}function xn(t){return Tt[t].mediaBox.topRightY-Tt[t].mediaBox.bottomLeftY}function An(t,e){Tt[t].mediaBox.topRightY=e+Tt[t].mediaBox.bottomLeftY}var Ln=w.getPageWidth=function(t){return yn(t=t||$)/Nt},Nn=w.setPageWidth=function(t,e){_n(t,e*Nt)},Sn=w.getPageHeight=function(t){return xn(t=t||$)/Nt},kn=w.setPageHeight=function(t,e){An(t,e*Nt)};return w.internal={pdfEscape:ge,getStyle:Re,getFont:Ye,getFontSize:mt,getCharSpace:un,getTextColor:ln,getLineHeight:$e,getLineHeightFactor:tn,getLineWidth:Xe,write:ut,getHorizontalCoordinate:en,getVerticalCoordinate:nn,getCoordinateString:rn,getVerticalCoordinateString:an,collections:{},newObject:Jt,newAdditionalObject:$t,newObjectDeferred:Xt,newObjectDeferredBegin:Kt,getFilters:re,putStream:ie,events:qt,scaleFactor:Nt,pageSize:{getWidth:function(){return Ln($)},setWidth:function(t){Nn($,t)},getHeight:function(){return Sn($)},setHeight:function(t){kn($,t)}},encryptionOptions:m,encryption:Ce,getEncryptor:function(t){return null!==m?Ce.encryptor(t,0):function(t){return t}},output:Fe,getNumberOfPages:ye,get pages(){return st},out:ct,f2:D,f3:z,getPageInfo:je,getPageInfoByObjId:Ee,getCurrentPageInfo:Oe,getPDFVersion:_,Point:gn,Rectangle:mn,Matrix:Wt,hasHotfix:Ie},Object.defineProperty(w.internal.pageSize,"width",{get:function(){return Ln($)},set:function(t){Nn($,t)},enumerable:!0,configurable:!0}),Object.defineProperty(w.internal.pageSize,"height",{get:function(){return Sn($)},set:function(t){kn($,t)},enumerable:!0,configurable:!0}),function(t){for(var e=0,n=dt.length;e<n;e++){var r=pe.call(this,t[e][0],t[e][1],t[e][2],dt[e][3],!0);!1===b&&(v[r]=!0);var i=t[e][0].split("-");de({id:r,fontName:i[0],fontStyle:i[1]||""})}qt.publish("addFonts",{fonts:Ft,dictionary:It})}.call(w,dt),Lt="F1",be(o,n),qt.publish("initialized"),w}I.prototype.lsbFirstWord=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)},I.prototype.toHexString=function(t){return t.split("").map(function(t){return("0"+(255&t.charCodeAt(0)).toString(16)).slice(-2)}).join("")},I.prototype.hexToBytes=function(t){for(var e=[],n=0;n<t.length;n+=2)e.push(String.fromCharCode(parseInt(t.substr(n,2),16)));return e.join("")},I.prototype.processOwnerPassword=function(t,e){return P(N(e).substr(0,5),t)},I.prototype.encryptor=function(t,e){var n=N(this.encryptionKey+String.fromCharCode(255&t,t>>8&255,t>>16&255,255&e,e>>8&255)).substr(0,10);return function(t){return P(n,t)}},E.prototype.equals=function(t){var e,n="id,objectNumber,equals";if(!t||r(t)!==r(this))return!1;var i=0;for(e in this)if(!(n.indexOf(e)>=0)){if(this.hasOwnProperty(e)&&!t.hasOwnProperty(e))return!1;if(this[e]!==t[e])return!1;i++}for(e in t)t.hasOwnProperty(e)&&n.indexOf(e)<0&&i--;return 0===i},R.API={events:[]},R.version="4.0.0";var T=R.API,q=1,D=function(t){return t.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")},z=function(t){return t.replace(/\\\\/g,"\\").replace(/\\\(/g,"(").replace(/\\\)/g,")")},U=function(t){return t.toFixed(2)},H=function(t){return t.toFixed(5)};T.__acroform__={};var W=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t},V=function(t){return t*q},G=function(t){var e=new lt,n=At.internal.getHeight(t)||0,r=At.internal.getWidth(t)||0;return e.BBox=[0,0,Number(U(r)),Number(U(n))],e},Y=T.__acroform__.setBit=function(t,e){if(t=t||0,e=e||0,isNaN(t)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.setBit");return t|1<<e},Z=T.__acroform__.clearBit=function(t,e){if(t=t||0,e=e||0,isNaN(t)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.clearBit");return t&~(1<<e)},J=T.__acroform__.getBit=function(t,e){if(isNaN(t)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.getBit");return t&1<<e?1:0},X=T.__acroform__.getBitForPdf=function(t,e){if(isNaN(t)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.getBitForPdf");return J(t,e-1)},K=T.__acroform__.setBitForPdf=function(t,e){if(isNaN(t)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.setBitForPdf");return Y(t,e-1)},$=T.__acroform__.clearBitForPdf=function(t,e){if(isNaN(t)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.clearBitForPdf");return Z(t,e-1)},Q=T.__acroform__.calculateCoordinates=function(t,e){var n=e.internal.getHorizontalCoordinate,r=e.internal.getVerticalCoordinate,i=t[0],a=t[1],s=t[2],o=t[3],h={};return h.lowerLeft_X=n(i)||0,h.lowerLeft_Y=r(a+o)||0,h.upperRight_X=n(i+s)||0,h.upperRight_Y=r(a)||0,[Number(U(h.lowerLeft_X)),Number(U(h.lowerLeft_Y)),Number(U(h.upperRight_X)),Number(U(h.upperRight_Y))]},tt=function(t){if(t.appearanceStreamContent)return t.appearanceStreamContent;if(t.V||t.DV){var e=[],n=t._V||t.DV,r=et(t,n),i=t.scope.internal.getFont(t.fontName,t.fontStyle).id;e.push("/Tx BMC"),e.push("q"),e.push("BT"),e.push(t.scope.__private__.encodeColorString(t.color)),e.push("/"+i+" "+U(r.fontSize)+" Tf"),e.push("1 0 0 1 0 0 Tm"),e.push(r.text),e.push("ET"),e.push("Q"),e.push("EMC");var a=G(t);return a.scope=t.scope,a.stream=e.join("\n"),a}},et=function(t,e){var n=0===t.fontSize?t.maxFontSize:t.fontSize,r={text:"",fontSize:""},i=(e=")"==(e="("==e.substr(0,1)?e.substr(1):e).substr(e.length-1)?e.substr(0,e.length-1):e).split(" ");i=t.multiline?i.map(function(t){return t.split("\n")}):i.map(function(t){return[t]});var a=n,s=At.internal.getHeight(t)||0;s=s<0?-s:s;var o=At.internal.getWidth(t)||0;o=o<0?-o:o;var h=function(e,n,r){if(e+1<i.length){var a=n+" "+i[e+1][0];return nt(a,t,r).width<=o-4}return!1};a++;t:for(;a>0;){e="",a--;var l,c,u=nt("3",t,a).height,f=t.multiline?s-a:(s-u)/2,d=f+=2,p=0,g=0,m=0;if(a<=0){e="(...) Tj\n",e+="% Width of Text: "+nt(e,t,a=12).width+", FieldWidth:"+o+"\n";break}for(var b="",v=0,w=0;w<i.length;w++)if(i.hasOwnProperty(w)){var y=!1;if(1!==i[w].length&&m!==i[w].length-1){if((u+2)*(v+2)+2>s)continue t;b+=i[w][m],y=!0,g=w,w--}else{b=" "==(b+=i[w][m]+" ").substr(b.length-1)?b.substr(0,b.length-1):b;var _=parseInt(w),x=h(_,b,a),A=w>=i.length-1;if(x&&!A){b+=" ",m=0;continue}if(x||A){if(A)g=_;else if(t.multiline&&(u+2)*(v+2)+2>s)continue t}else{if(!t.multiline)continue t;if((u+2)*(v+2)+2>s)continue t;g=_}}for(var L="",N=p;N<=g;N++){var S=i[N];if(t.multiline){if(N===g){L+=S[m]+" ",m=(m+1)%S.length;continue}if(N===p){L+=S[S.length-1]+" ";continue}}L+=S[0]+" "}switch(L=" "==L.substr(L.length-1)?L.substr(0,L.length-1):L,c=nt(L,t,a).width,t.textAlign){case"right":l=o-c-2;break;case"center":l=(o-c)/2;break;default:l=2}e+=U(l)+" "+U(d)+" Td\n",e+="("+D(L)+") Tj\n",e+=-U(l)+" 0 Td\n",d=-(a+2),c=0,p=y?g:g+1,v++,b=""}break}return r.text=e,r.fontSize=a,r},nt=function(t,e,n){var r=e.scope.internal.getFont(e.fontName,e.fontStyle),i=e.scope.getStringUnitWidth(t,{font:r,fontSize:parseFloat(n),charSpace:0})*parseFloat(n);return{height:e.scope.getStringUnitWidth("3",{font:r,fontSize:parseFloat(n),charSpace:0})*parseFloat(n)*1.5,width:i}},rt={fields:[],xForms:[],acroFormDictionaryRoot:null,printedOut:!1,internal:null,isInitialized:!1},it=function(t,e){var n={type:"reference",object:t};void 0===e.internal.getPageInfo(t.page).pageContext.annotations.find(function(t){return t.type===n.type&&t.object===n.object})&&e.internal.getPageInfo(t.page).pageContext.annotations.push(n)},at=function(t,e){if(e.scope=t,void 0!==t.internal&&(void 0===t.internal.acroformPlugin||!1===t.internal.acroformPlugin.isInitialized)){if(ut.FieldNum=0,t.internal.acroformPlugin=JSON.parse(JSON.stringify(rt)),t.internal.acroformPlugin.acroFormDictionaryRoot)throw new Error("Exception while creating AcroformDictionary");q=t.internal.scaleFactor,t.internal.acroformPlugin.acroFormDictionaryRoot=new ct,t.internal.acroformPlugin.acroFormDictionaryRoot.scope=t,t.internal.acroformPlugin.acroFormDictionaryRoot._eventID=t.internal.events.subscribe("postPutResources",function(){!function(t){t.internal.events.unsubscribe(t.internal.acroformPlugin.acroFormDictionaryRoot._eventID),delete t.internal.acroformPlugin.acroFormDictionaryRoot._eventID,t.internal.acroformPlugin.printedOut=!0}(t)}),t.internal.events.subscribe("buildDocument",function(){!function(t){t.internal.acroformPlugin.acroFormDictionaryRoot.objId=void 0;var e=t.internal.acroformPlugin.acroFormDictionaryRoot.Fields;for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];r.objId=void 0,r.hasAnnotation&&it(r,t)}}(t)}),t.internal.events.subscribe("putCatalog",function(){!function(t){if(void 0===t.internal.acroformPlugin.acroFormDictionaryRoot)throw new Error("putCatalogCallback: Root missing.");t.internal.write("/AcroForm "+t.internal.acroformPlugin.acroFormDictionaryRoot.objId+" 0 R")}(t)}),t.internal.events.subscribe("postPutPages",function(e){!function(t,e){var n=!t;for(var i in t||(e.internal.newObjectDeferredBegin(e.internal.acroformPlugin.acroFormDictionaryRoot.objId,!0),e.internal.acroformPlugin.acroFormDictionaryRoot.putStream()),t=t||e.internal.acroformPlugin.acroFormDictionaryRoot.Kids)if(t.hasOwnProperty(i)){var a=t[i],s=[],o=a.Rect;if(a.Rect&&(a.Rect=Q(a.Rect,e)),e.internal.newObjectDeferredBegin(a.objId,!0),a.DA=At.createDefaultAppearanceStream(a),"object"===r(a)&&"function"==typeof a.getKeyValueListForStream&&(s=a.getKeyValueListForStream()),a.Rect=o,a.hasAppearanceStream&&!a.appearanceStreamContent){var h=tt(a);s.push({key:"AP",value:"<</N "+h+">>"}),e.internal.acroformPlugin.xForms.push(h)}if(a.appearanceStreamContent){var l="";for(var c in a.appearanceStreamContent)if(a.appearanceStreamContent.hasOwnProperty(c)){var u=a.appearanceStreamContent[c];if(l+="/"+c+" ",l+="<<",Object.keys(u).length>=1||Array.isArray(u)){for(var i in u)if(u.hasOwnProperty(i)){var f=u[i];"function"==typeof f&&(f=f.call(e,a)),l+="/"+i+" "+f+" ",e.internal.acroformPlugin.xForms.indexOf(f)>=0||e.internal.acroformPlugin.xForms.push(f)}}else"function"==typeof(f=u)&&(f=f.call(e,a)),l+="/"+i+" "+f,e.internal.acroformPlugin.xForms.indexOf(f)>=0||e.internal.acroformPlugin.xForms.push(f);l+=">>"}s.push({key:"AP",value:"<<\n"+l+">>"})}e.internal.putStream({additionalKeyValues:s,objectId:a.objId}),e.internal.out("endobj")}n&&function(t,e){for(var n in t)if(t.hasOwnProperty(n)){var i=n,a=t[n];e.internal.newObjectDeferredBegin(a.objId,!0),"object"===r(a)&&"function"==typeof a.putStream&&a.putStream(),delete t[i]}}(e.internal.acroformPlugin.xForms,e)}(e,t)}),t.internal.acroformPlugin.isInitialized=!0}},st=T.__acroform__.arrayToPdfArray=function(t,e,n){var i=function(t){return t};if(Array.isArray(t)){for(var a="[",s=0;s<t.length;s++)switch(0!==s&&(a+=" "),r(t[s])){case"boolean":case"number":case"object":a+=t[s].toString();break;case"string":"/"!==t[s].substr(0,1)?(void 0!==e&&n&&(i=n.internal.getEncryptor(e)),a+="("+D(i(t[s].toString()))+")"):a+=t[s].toString()}return a+"]"}throw new Error("Invalid argument passed to jsPDF.__acroform__.arrayToPdfArray")},ot=function(t,e,n){var r=function(t){return t};return void 0!==e&&n&&(r=n.internal.getEncryptor(e)),(t=t||"").toString(),"("+D(r(t))+")"},ht=function(){this._objId=void 0,this._scope=void 0,Object.defineProperty(this,"objId",{get:function(){if(void 0===this._objId){if(void 0===this.scope)return;this._objId=this.scope.internal.newObjectDeferred()}return this._objId},set:function(t){this._objId=t}}),Object.defineProperty(this,"scope",{value:this._scope,writable:!0})};ht.prototype.toString=function(){return this.objId+" 0 R"},ht.prototype.putStream=function(){var t=this.getKeyValueListForStream();this.scope.internal.putStream({data:this.stream,additionalKeyValues:t,objectId:this.objId}),this.scope.internal.out("endobj")},ht.prototype.getKeyValueListForStream=function(){var t=[],e=Object.getOwnPropertyNames(this).filter(function(t){return"content"!=t&&"appearanceStreamContent"!=t&&"scope"!=t&&"objId"!=t&&"_"!=t.substring(0,1)});for(var n in e)if(!1===Object.getOwnPropertyDescriptor(this,e[n]).configurable){var r=e[n],i=this[r];i&&(Array.isArray(i)?t.push({key:r,value:st(i,this.objId,this.scope)}):i instanceof ht?(i.scope=this.scope,t.push({key:r,value:i.objId+" 0 R"})):"function"!=typeof i&&t.push({key:r,value:i}))}return t};var lt=function(){ht.call(this),Object.defineProperty(this,"Type",{value:"/XObject",configurable:!1,writable:!0}),Object.defineProperty(this,"Subtype",{value:"/Form",configurable:!1,writable:!0}),Object.defineProperty(this,"FormType",{value:1,configurable:!1,writable:!0});var t,e=[];Object.defineProperty(this,"BBox",{configurable:!1,get:function(){return e},set:function(t){e=t}}),Object.defineProperty(this,"Resources",{value:"2 0 R",configurable:!1,writable:!0}),Object.defineProperty(this,"stream",{enumerable:!1,configurable:!0,set:function(e){t=e.trim()},get:function(){return t||null}})};W(lt,ht);var ct=function(){ht.call(this);var t,e=[];Object.defineProperty(this,"Kids",{enumerable:!1,configurable:!0,get:function(){return e.length>0?e:void 0}}),Object.defineProperty(this,"Fields",{enumerable:!1,configurable:!1,get:function(){return e}}),Object.defineProperty(this,"DA",{enumerable:!1,configurable:!1,get:function(){if(t){var e=function(t){return t};return this.scope&&(e=this.scope.internal.getEncryptor(this.objId)),"("+D(e(t))+")"}},set:function(e){t=e}})};W(ct,ht);var ut=function t(){ht.call(this);var e=4;Object.defineProperty(this,"F",{enumerable:!1,configurable:!1,get:function(){return e},set:function(t){if(isNaN(t))throw new Error('Invalid value "'+t+'" for attribute F supplied.');e=t}}),Object.defineProperty(this,"showWhenPrinted",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(e,3))},set:function(t){!0===Boolean(t)?this.F=K(e,3):this.F=$(e,3)}});var n=0;Object.defineProperty(this,"Ff",{enumerable:!1,configurable:!1,get:function(){return n},set:function(t){if(isNaN(t))throw new Error('Invalid value "'+t+'" for attribute Ff supplied.');n=t}});var r=[];Object.defineProperty(this,"Rect",{enumerable:!1,configurable:!1,get:function(){if(0!==r.length)return r},set:function(t){r=void 0!==t?t:[]}}),Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,get:function(){return!r||isNaN(r[0])?0:r[0]},set:function(t){r[0]=t}}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,get:function(){return!r||isNaN(r[1])?0:r[1]},set:function(t){r[1]=t}}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,get:function(){return!r||isNaN(r[2])?0:r[2]},set:function(t){r[2]=t}}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,get:function(){return!r||isNaN(r[3])?0:r[3]},set:function(t){r[3]=t}});var i="";Object.defineProperty(this,"FT",{enumerable:!0,configurable:!1,get:function(){return i},set:function(t){switch(t){case"/Btn":case"/Tx":case"/Ch":case"/Sig":i=t;break;default:throw new Error('Invalid value "'+t+'" for attribute FT supplied.')}}});var a=null;Object.defineProperty(this,"T",{enumerable:!0,configurable:!1,get:function(){if(!a||a.length<1){if(this instanceof wt)return;a="FieldObject"+t.FieldNum++}var e=function(t){return t};return this.scope&&(e=this.scope.internal.getEncryptor(this.objId)),"("+D(e(a))+")"},set:function(t){a=t.toString()}}),Object.defineProperty(this,"fieldName",{configurable:!0,enumerable:!0,get:function(){return a},set:function(t){a=t}});var s="helvetica";Object.defineProperty(this,"fontName",{enumerable:!0,configurable:!0,get:function(){return s},set:function(t){s=t}});var o="normal";Object.defineProperty(this,"fontStyle",{enumerable:!0,configurable:!0,get:function(){return o},set:function(t){o=t}});var h=0;Object.defineProperty(this,"fontSize",{enumerable:!0,configurable:!0,get:function(){return h},set:function(t){h=t}});var l=void 0;Object.defineProperty(this,"maxFontSize",{enumerable:!0,configurable:!0,get:function(){return void 0===l?50/q:l},set:function(t){l=t}});var c="black";Object.defineProperty(this,"color",{enumerable:!0,configurable:!0,get:function(){return c},set:function(t){c=t}});var u="/F1 0 Tf 0 g";Object.defineProperty(this,"DA",{enumerable:!0,configurable:!1,get:function(){if(!(!u||this instanceof wt||this instanceof _t))return ot(u,this.objId,this.scope)},set:function(t){t=t.toString(),u=t}});var f=null;Object.defineProperty(this,"DV",{enumerable:!1,configurable:!1,get:function(){if(f)return this instanceof mt==0?ot(f,this.objId,this.scope):f},set:function(t){t=t.toString(),f=this instanceof mt==0?"("===t.substr(0,1)?z(t.substr(1,t.length-2)):z(t):t}}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,get:function(){return this instanceof mt==1?z(f.substr(1,f.length-1)):f},set:function(t){t=t.toString(),f=this instanceof mt==1?"/"+t:t}});var d=null;Object.defineProperty(this,"_V",{enumerable:!1,configurable:!1,get:function(){if(d)return d},set:function(t){this.V=t}}),Object.defineProperty(this,"V",{enumerable:!1,configurable:!1,get:function(){if(d)return this instanceof mt==0?ot(d,this.objId,this.scope):d},set:function(t){t=t.toString(),d=this instanceof mt==0?"("===t.substr(0,1)?z(t.substr(1,t.length-2)):z(t):t}}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,get:function(){return this instanceof mt==1?z(d.substr(1,d.length-1)):d},set:function(t){t=t.toString(),d=this instanceof mt==1?"/"+t:t}}),Object.defineProperty(this,"hasAnnotation",{enumerable:!0,configurable:!0,get:function(){return this.Rect}}),Object.defineProperty(this,"Type",{enumerable:!0,configurable:!1,get:function(){return this.hasAnnotation?"/Annot":null}}),Object.defineProperty(this,"Subtype",{enumerable:!0,configurable:!1,get:function(){return this.hasAnnotation?"/Widget":null}});var p,g=!1;Object.defineProperty(this,"hasAppearanceStream",{enumerable:!0,configurable:!0,get:function(){return g},set:function(t){t=Boolean(t),g=t}}),Object.defineProperty(this,"page",{enumerable:!0,configurable:!0,get:function(){if(p)return p},set:function(t){p=t}}),Object.defineProperty(this,"readOnly",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,1))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,1):this.Ff=$(this.Ff,1)}}),Object.defineProperty(this,"required",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,2))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,2):this.Ff=$(this.Ff,2)}}),Object.defineProperty(this,"noExport",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,3))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,3):this.Ff=$(this.Ff,3)}});var m=null;Object.defineProperty(this,"Q",{enumerable:!0,configurable:!1,get:function(){if(null!==m)return m},set:function(t){if(-1===[0,1,2].indexOf(t))throw new Error('Invalid value "'+t+'" for attribute Q supplied.');m=t}}),Object.defineProperty(this,"textAlign",{get:function(){var t;switch(m){case 0:default:t="left";break;case 1:t="center";break;case 2:t="right"}return t},configurable:!0,enumerable:!0,set:function(t){switch(t){case"right":case 2:m=2;break;case"center":case 1:m=1;break;default:m=0}}})};W(ut,ht);var ft=function(){ut.call(this),this.FT="/Ch",this.V="()",this.fontName="zapfdingbats";var t=0;Object.defineProperty(this,"TI",{enumerable:!0,configurable:!1,get:function(){return t},set:function(e){t=e}}),Object.defineProperty(this,"topIndex",{enumerable:!0,configurable:!0,get:function(){return t},set:function(e){t=e}});var e=[];Object.defineProperty(this,"Opt",{enumerable:!0,configurable:!1,get:function(){return st(e,this.objId,this.scope)},set:function(t){var n,r;r=[],"string"==typeof(n=t)&&(r=function(t,e,n){n||(n=1);for(var r,i=[];r=e.exec(t);)i.push(r[n]);return i}(n,/\((.*?)\)/g)),e=r}}),this.getOptions=function(){return e},this.setOptions=function(t){e=t,this.sort&&e.sort()},this.addOption=function(t){t=(t=t||"").toString(),e.push(t),this.sort&&e.sort()},this.removeOption=function(t,n){for(n=n||!1,t=(t=t||"").toString();-1!==e.indexOf(t)&&(e.splice(e.indexOf(t),1),!1!==n););},Object.defineProperty(this,"combo",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,18))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,18):this.Ff=$(this.Ff,18)}}),Object.defineProperty(this,"edit",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,19))},set:function(t){!0===this.combo&&(!0===Boolean(t)?this.Ff=K(this.Ff,19):this.Ff=$(this.Ff,19))}}),Object.defineProperty(this,"sort",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,20))},set:function(t){!0===Boolean(t)?(this.Ff=K(this.Ff,20),e.sort()):this.Ff=$(this.Ff,20)}}),Object.defineProperty(this,"multiSelect",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,22))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,22):this.Ff=$(this.Ff,22)}}),Object.defineProperty(this,"doNotSpellCheck",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,23))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,23):this.Ff=$(this.Ff,23)}}),Object.defineProperty(this,"commitOnSelChange",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,27))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,27):this.Ff=$(this.Ff,27)}}),this.hasAppearanceStream=!1};W(ft,ut);var dt=function(){ft.call(this),this.fontName="helvetica",this.combo=!1};W(dt,ft);var pt=function(){dt.call(this),this.combo=!0};W(pt,dt);var gt=function(){pt.call(this),this.edit=!0};W(gt,pt);var mt=function(){ut.call(this),this.FT="/Btn",Object.defineProperty(this,"noToggleToOff",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,15))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,15):this.Ff=$(this.Ff,15)}}),Object.defineProperty(this,"radio",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,16))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,16):this.Ff=$(this.Ff,16)}}),Object.defineProperty(this,"pushButton",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,17))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,17):this.Ff=$(this.Ff,17)}}),Object.defineProperty(this,"radioIsUnison",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,26))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,26):this.Ff=$(this.Ff,26)}});var t,e={};Object.defineProperty(this,"MK",{enumerable:!1,configurable:!1,get:function(){var t=function(t){return t};if(this.scope&&(t=this.scope.internal.getEncryptor(this.objId)),0!==Object.keys(e).length){var n,r=[];for(n in r.push("<<"),e)r.push("/"+n+" ("+D(t(e[n]))+")");return r.push(">>"),r.join("\n")}},set:function(t){"object"===r(t)&&(e=t)}}),Object.defineProperty(this,"caption",{enumerable:!0,configurable:!0,get:function(){return e.CA||""},set:function(t){"string"==typeof t&&(e.CA=t)}}),Object.defineProperty(this,"AS",{enumerable:!1,configurable:!1,get:function(){return t},set:function(e){t=e}}),Object.defineProperty(this,"appearanceState",{enumerable:!0,configurable:!0,get:function(){return t.substr(1,t.length-1)},set:function(e){t="/"+e}})};W(mt,ut);var bt=function(){mt.call(this),this.pushButton=!0};W(bt,mt);var vt=function(){mt.call(this),this.radio=!0,this.pushButton=!1;var t=[];Object.defineProperty(this,"Kids",{enumerable:!0,configurable:!1,get:function(){return t},set:function(e){t=void 0!==e?e:[]}})};W(vt,mt);var wt=function(){var t,e;ut.call(this),Object.defineProperty(this,"Parent",{enumerable:!1,configurable:!1,get:function(){return t},set:function(e){t=e}}),Object.defineProperty(this,"optionName",{enumerable:!1,configurable:!0,get:function(){return e},set:function(t){e=t}});var n,i={};Object.defineProperty(this,"MK",{enumerable:!1,configurable:!1,get:function(){var t=function(t){return t};this.scope&&(t=this.scope.internal.getEncryptor(this.objId));var e,n=[];for(e in n.push("<<"),i)n.push("/"+e+" ("+D(t(i[e]))+")");return n.push(">>"),n.join("\n")},set:function(t){"object"===r(t)&&(i=t)}}),Object.defineProperty(this,"caption",{enumerable:!0,configurable:!0,get:function(){return i.CA||""},set:function(t){"string"==typeof t&&(i.CA=t)}}),Object.defineProperty(this,"AS",{enumerable:!1,configurable:!1,get:function(){return n},set:function(t){n=t}}),Object.defineProperty(this,"appearanceState",{enumerable:!0,configurable:!0,get:function(){return n.substr(1,n.length-1)},set:function(t){n="/"+t}}),this.caption="l",this.appearanceState="Off",this._AppearanceType=At.RadioButton.Circle,this.appearanceStreamContent=this._AppearanceType.createAppearanceStream(this.optionName)};W(wt,ut),vt.prototype.setAppearance=function(t){if(!("createAppearanceStream"in t)||!("getCA"in t))throw new Error("Couldn't assign Appearance to RadioButton. Appearance was Invalid!");for(var e in this.Kids)if(this.Kids.hasOwnProperty(e)){var n=this.Kids[e];n.appearanceStreamContent=t.createAppearanceStream(n.optionName),n.caption=t.getCA()}},vt.prototype.createOption=function(t){var e=new wt;return e.Parent=this,e.optionName=t,this.Kids.push(e),Lt.call(this.scope,e),e};var yt=function(){mt.call(this),this.fontName="zapfdingbats",this.caption="3",this.appearanceState="On",this.value="On",this.textAlign="center",this.appearanceStreamContent=At.CheckBox.createAppearanceStream()};W(yt,mt);var _t=function(){ut.call(this),this.FT="/Tx",Object.defineProperty(this,"multiline",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,13))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,13):this.Ff=$(this.Ff,13)}}),Object.defineProperty(this,"fileSelect",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,21))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,21):this.Ff=$(this.Ff,21)}}),Object.defineProperty(this,"doNotSpellCheck",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,23))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,23):this.Ff=$(this.Ff,23)}}),Object.defineProperty(this,"doNotScroll",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,24))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,24):this.Ff=$(this.Ff,24)}}),Object.defineProperty(this,"comb",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,25))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,25):this.Ff=$(this.Ff,25)}}),Object.defineProperty(this,"richText",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,26))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,26):this.Ff=$(this.Ff,26)}});var t=null;Object.defineProperty(this,"MaxLen",{enumerable:!0,configurable:!1,get:function(){return t},set:function(e){t=e}}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,get:function(){return t},set:function(e){Number.isInteger(e)&&(t=e)}}),Object.defineProperty(this,"hasAppearanceStream",{enumerable:!0,configurable:!0,get:function(){return this.V||this.DV}})};W(_t,ut);var xt=function(){_t.call(this),Object.defineProperty(this,"password",{enumerable:!0,configurable:!0,get:function(){return Boolean(X(this.Ff,14))},set:function(t){!0===Boolean(t)?this.Ff=K(this.Ff,14):this.Ff=$(this.Ff,14)}}),this.password=!0};W(xt,_t);var At={CheckBox:{createAppearanceStream:function(){return{N:{On:At.CheckBox.YesNormal},D:{On:At.CheckBox.YesPushDown,Off:At.CheckBox.OffPushDown}}},YesPushDown:function(t){var e=G(t);e.scope=t.scope;var n=[],r=t.scope.internal.getFont(t.fontName,t.fontStyle).id,i=t.scope.__private__.encodeColorString(t.color),a=et(t,t.caption);return n.push("0.749023 g"),n.push("0 0 "+U(At.internal.getWidth(t))+" "+U(At.internal.getHeight(t))+" re"),n.push("f"),n.push("BMC"),n.push("q"),n.push("0 0 1 rg"),n.push("/"+r+" "+U(a.fontSize)+" Tf "+i),n.push("BT"),n.push(a.text),n.push("ET"),n.push("Q"),n.push("EMC"),e.stream=n.join("\n"),e},YesNormal:function(t){var e=G(t);e.scope=t.scope;var n=t.scope.internal.getFont(t.fontName,t.fontStyle).id,r=t.scope.__private__.encodeColorString(t.color),i=[],a=At.internal.getHeight(t),s=At.internal.getWidth(t),o=et(t,t.caption);return i.push("1 g"),i.push("0 0 "+U(s)+" "+U(a)+" re"),i.push("f"),i.push("q"),i.push("0 0 1 rg"),i.push("0 0 "+U(s-1)+" "+U(a-1)+" re"),i.push("W"),i.push("n"),i.push("0 g"),i.push("BT"),i.push("/"+n+" "+U(o.fontSize)+" Tf "+r),i.push(o.text),i.push("ET"),i.push("Q"),e.stream=i.join("\n"),e},OffPushDown:function(t){var e=G(t);e.scope=t.scope;var n=[];return n.push("0.749023 g"),n.push("0 0 "+U(At.internal.getWidth(t))+" "+U(At.internal.getHeight(t))+" re"),n.push("f"),e.stream=n.join("\n"),e}},RadioButton:{Circle:{createAppearanceStream:function(t){var e={D:{Off:At.RadioButton.Circle.OffPushDown},N:{}};return e.N[t]=At.RadioButton.Circle.YesNormal,e.D[t]=At.RadioButton.Circle.YesPushDown,e},getCA:function(){return"l"},YesNormal:function(t){var e=G(t);e.scope=t.scope;var n=[],r=At.internal.getWidth(t)<=At.internal.getHeight(t)?At.internal.getWidth(t)/4:At.internal.getHeight(t)/4;r=Number((.9*r).toFixed(5));var i=At.internal.Bezier_C,a=Number((r*i).toFixed(5));return n.push("q"),n.push("1 0 0 1 "+H(At.internal.getWidth(t)/2)+" "+H(At.internal.getHeight(t)/2)+" cm"),n.push(r+" 0 m"),n.push(r+" "+a+" "+a+" "+r+" 0 "+r+" c"),n.push("-"+a+" "+r+" -"+r+" "+a+" -"+r+" 0 c"),n.push("-"+r+" -"+a+" -"+a+" -"+r+" 0 -"+r+" c"),n.push(a+" -"+r+" "+r+" -"+a+" "+r+" 0 c"),n.push("f"),n.push("Q"),e.stream=n.join("\n"),e},YesPushDown:function(t){var e=G(t);e.scope=t.scope;var n=[],r=At.internal.getWidth(t)<=At.internal.getHeight(t)?At.internal.getWidth(t)/4:At.internal.getHeight(t)/4;r=Number((.9*r).toFixed(5));var i=Number((2*r).toFixed(5)),a=Number((i*At.internal.Bezier_C).toFixed(5)),s=Number((r*At.internal.Bezier_C).toFixed(5));return n.push("0.749023 g"),n.push("q"),n.push("1 0 0 1 "+H(At.internal.getWidth(t)/2)+" "+H(At.internal.getHeight(t)/2)+" cm"),n.push(i+" 0 m"),n.push(i+" "+a+" "+a+" "+i+" 0 "+i+" c"),n.push("-"+a+" "+i+" -"+i+" "+a+" -"+i+" 0 c"),n.push("-"+i+" -"+a+" -"+a+" -"+i+" 0 -"+i+" c"),n.push(a+" -"+i+" "+i+" -"+a+" "+i+" 0 c"),n.push("f"),n.push("Q"),n.push("0 g"),n.push("q"),n.push("1 0 0 1 "+H(At.internal.getWidth(t)/2)+" "+H(At.internal.getHeight(t)/2)+" cm"),n.push(r+" 0 m"),n.push(r+" "+s+" "+s+" "+r+" 0 "+r+" c"),n.push("-"+s+" "+r+" -"+r+" "+s+" -"+r+" 0 c"),n.push("-"+r+" -"+s+" -"+s+" -"+r+" 0 -"+r+" c"),n.push(s+" -"+r+" "+r+" -"+s+" "+r+" 0 c"),n.push("f"),n.push("Q"),e.stream=n.join("\n"),e},OffPushDown:function(t){var e=G(t);e.scope=t.scope;var n=[],r=At.internal.getWidth(t)<=At.internal.getHeight(t)?At.internal.getWidth(t)/4:At.internal.getHeight(t)/4;r=Number((.9*r).toFixed(5));var i=Number((2*r).toFixed(5)),a=Number((i*At.internal.Bezier_C).toFixed(5));return n.push("0.749023 g"),n.push("q"),n.push("1 0 0 1 "+H(At.internal.getWidth(t)/2)+" "+H(At.internal.getHeight(t)/2)+" cm"),n.push(i+" 0 m"),n.push(i+" "+a+" "+a+" "+i+" 0 "+i+" c"),n.push("-"+a+" "+i+" -"+i+" "+a+" -"+i+" 0 c"),n.push("-"+i+" -"+a+" -"+a+" -"+i+" 0 -"+i+" c"),n.push(a+" -"+i+" "+i+" -"+a+" "+i+" 0 c"),n.push("f"),n.push("Q"),e.stream=n.join("\n"),e}},Cross:{createAppearanceStream:function(t){var e={D:{Off:At.RadioButton.Cross.OffPushDown},N:{}};return e.N[t]=At.RadioButton.Cross.YesNormal,e.D[t]=At.RadioButton.Cross.YesPushDown,e},getCA:function(){return"8"},YesNormal:function(t){var e=G(t);e.scope=t.scope;var n=[],r=At.internal.calculateCross(t);return n.push("q"),n.push("1 1 "+U(At.internal.getWidth(t)-2)+" "+U(At.internal.getHeight(t)-2)+" re"),n.push("W"),n.push("n"),n.push(U(r.x1.x)+" "+U(r.x1.y)+" m"),n.push(U(r.x2.x)+" "+U(r.x2.y)+" l"),n.push(U(r.x4.x)+" "+U(r.x4.y)+" m"),n.push(U(r.x3.x)+" "+U(r.x3.y)+" l"),n.push("s"),n.push("Q"),e.stream=n.join("\n"),e},YesPushDown:function(t){var e=G(t);e.scope=t.scope;var n=At.internal.calculateCross(t),r=[];return r.push("0.749023 g"),r.push("0 0 "+U(At.internal.getWidth(t))+" "+U(At.internal.getHeight(t))+" re"),r.push("f"),r.push("q"),r.push("1 1 "+U(At.internal.getWidth(t)-2)+" "+U(At.internal.getHeight(t)-2)+" re"),r.push("W"),r.push("n"),r.push(U(n.x1.x)+" "+U(n.x1.y)+" m"),r.push(U(n.x2.x)+" "+U(n.x2.y)+" l"),r.push(U(n.x4.x)+" "+U(n.x4.y)+" m"),r.push(U(n.x3.x)+" "+U(n.x3.y)+" l"),r.push("s"),r.push("Q"),e.stream=r.join("\n"),e},OffPushDown:function(t){var e=G(t);e.scope=t.scope;var n=[];return n.push("0.749023 g"),n.push("0 0 "+U(At.internal.getWidth(t))+" "+U(At.internal.getHeight(t))+" re"),n.push("f"),e.stream=n.join("\n"),e}}},createDefaultAppearanceStream:function(t){var e=t.scope.internal.getFont(t.fontName,t.fontStyle).id,n=t.scope.__private__.encodeColorString(t.color);return"/"+e+" "+t.fontSize+" Tf "+n}};At.internal={Bezier_C:.551915024494,calculateCross:function(t){var e=At.internal.getWidth(t),n=At.internal.getHeight(t),r=Math.min(e,n);return{x1:{x:(e-r)/2,y:(n-r)/2+r},x2:{x:(e-r)/2+r,y:(n-r)/2},x3:{x:(e-r)/2,y:(n-r)/2},x4:{x:(e-r)/2+r,y:(n-r)/2+r}}}},At.internal.getWidth=function(t){var e=0;return"object"===r(t)&&(e=V(t.Rect[2])),e},At.internal.getHeight=function(t){var e=0;return"object"===r(t)&&(e=V(t.Rect[3])),e};var Lt=T.addField=function(t){if(at(this,t),!(t instanceof ut))throw new Error("Invalid argument passed to jsPDF.addField.");var e;return(e=t).scope.internal.acroformPlugin.printedOut&&(e.scope.internal.acroformPlugin.printedOut=!1,e.scope.internal.acroformPlugin.acroFormDictionaryRoot=null),e.scope.internal.acroformPlugin.acroFormDictionaryRoot.Fields.push(e),t.page=t.scope.internal.getCurrentPageInfo().pageNumber,this};T.AcroFormChoiceField=ft,T.AcroFormListBox=dt,T.AcroFormComboBox=pt,T.AcroFormEditBox=gt,T.AcroFormButton=mt,T.AcroFormPushButton=bt,T.AcroFormRadioButton=vt,T.AcroFormCheckBox=yt,T.AcroFormTextField=_t,T.AcroFormPasswordField=xt,T.AcroFormAppearance=At,T.AcroForm={ChoiceField:ft,ListBox:dt,ComboBox:pt,EditBox:gt,Button:mt,PushButton:bt,RadioButton:vt,CheckBox:yt,TextField:_t,PasswordField:xt,Appearance:At},R.AcroForm={ChoiceField:ft,ListBox:dt,ComboBox:pt,EditBox:gt,Button:mt,PushButton:bt,RadioButton:vt,CheckBox:yt,TextField:_t,PasswordField:xt,Appearance:At};var Nt=R.AcroForm;function St(t){return t.reduce(function(t,e,n){return t[e]=n,t},{})}!function(t){var e="addImage_";t.__addimage__={};var n="UNKNOWN",i={PNG:[[137,80,78,71]],TIFF:[[77,77,0,42],[73,73,42,0]],JPEG:[[255,216,255,224,void 0,void 0,74,70,73,70,0],[255,216,255,225,void 0,void 0,69,120,105,102,0,0],[255,216,255,219],[255,216,255,238]],JPEG2000:[[0,0,0,12,106,80,32,32]],GIF87a:[[71,73,70,56,55,97]],GIF89a:[[71,73,70,56,57,97]],WEBP:[[82,73,70,70,void 0,void 0,void 0,void 0,87,69,66,80]],BMP:[[66,77],[66,65],[67,73],[67,80],[73,67],[80,84]]},a=t.__addimage__.getImageFileTypeByImageData=function(t,e){var r,a,s,o,h,l=n;if("RGBA"===(e=e||n)||void 0!==t.data&&t.data instanceof Uint8ClampedArray&&"height"in t&&"width"in t)return"RGBA";if(L(t))for(h in i)for(s=i[h],r=0;r<s.length;r+=1){for(o=!0,a=0;a<s[r].length;a+=1)if(void 0!==s[r][a]&&s[r][a]!==t[a]){o=!1;break}if(!0===o){l=h;break}}else for(h in i)for(s=i[h],r=0;r<s.length;r+=1){for(o=!0,a=0;a<s[r].length;a+=1)if(void 0!==s[r][a]&&s[r][a]!==t.charCodeAt(a)){o=!1;break}if(!0===o){l=h;break}}return l===n&&e!==n&&(l=e),l},s=function t(e){for(var n=this.internal.write,r=this.internal.putStream,i=(0,this.internal.getFilters)();-1!==i.indexOf("FlateEncode");)i.splice(i.indexOf("FlateEncode"),1);e.objectId=this.internal.newObject();var a=[];if(a.push({key:"Type",value:"/XObject"}),a.push({key:"Subtype",value:"/Image"}),a.push({key:"Width",value:e.width}),a.push({key:"Height",value:e.height}),e.colorSpace===w.INDEXED?a.push({key:"ColorSpace",value:"[/Indexed /DeviceRGB "+(e.palette.length/3-1)+" "+("sMask"in e&&void 0!==e.sMask?e.objectId+2:e.objectId+1)+" 0 R]"}):(a.push({key:"ColorSpace",value:"/"+e.colorSpace}),e.colorSpace===w.DEVICE_CMYK&&a.push({key:"Decode",value:"[1 0 1 0 1 0 1 0]"})),a.push({key:"BitsPerComponent",value:e.bitsPerComponent}),"decodeParameters"in e&&void 0!==e.decodeParameters&&a.push({key:"DecodeParms",value:"<<"+e.decodeParameters+">>"}),"transparency"in e&&Array.isArray(e.transparency)&&e.transparency.length>0){for(var s="",o=0,h=e.transparency.length;o<h;o++)s+=e.transparency[o]+" "+e.transparency[o]+" ";a.push({key:"Mask",value:"["+s+"]"})}void 0!==e.sMask&&a.push({key:"SMask",value:e.objectId+1+" 0 R"});var l=void 0!==e.filter?["/"+e.filter]:void 0;if(r({data:e.data,additionalKeyValues:a,alreadyAppliedFilters:l,objectId:e.objectId}),n("endobj"),"sMask"in e&&void 0!==e.sMask){var c,u=null!==(c=e.sMaskBitsPerComponent)&&void 0!==c?c:e.bitsPerComponent,f={width:e.width,height:e.height,colorSpace:"DeviceGray",bitsPerComponent:u,data:e.sMask};"filter"in e&&(f.decodeParameters="/Predictor ".concat(e.predictor," /Colors 1 /BitsPerComponent ").concat(u," /Columns ").concat(e.width),f.filter=e.filter),t.call(this,f)}if(e.colorSpace===w.INDEXED){var d=this.internal.newObject();r({data:S(new Uint8Array(e.palette)),objectId:d}),n("endobj")}},o=function(){var t=this.internal.collections[e+"images"];for(var n in t)s.call(this,t[n])},h=function(){var t,n=this.internal.collections[e+"images"],r=this.internal.write;for(var i in n)r("/I"+(t=n[i]).index,t.objectId,"0","R")},l=function(){this.internal.collections[e+"images"]||(this.internal.collections[e+"images"]={},this.internal.events.subscribe("putResources",o),this.internal.events.subscribe("putXobjectDict",h))},c=function(){var t=this.internal.collections[e+"images"];return l.call(this),t},u=function(){return Object.keys(this.internal.collections[e+"images"]).length},d=function(e){return"function"==typeof t["process"+e.toUpperCase()]},p=function(t){return"object"===r(t)&&1===t.nodeType},g=function(e,n){if("IMG"===e.nodeName&&e.hasAttribute("src")){var r=""+e.getAttribute("src");if(0===r.indexOf("data:image/"))return f(unescape(r).split("base64,").pop());var i=t.loadFile(r,!0);if(void 0!==i)return i}if("CANVAS"===e.nodeName){if(0===e.width||0===e.height)throw new Error("Given canvas must have data. Canvas width: "+e.width+", height: "+e.height);var a;switch(n){case"PNG":a="image/png";break;case"WEBP":a="image/webp";break;default:a="image/jpeg"}return f(e.toDataURL(a,1).split("base64,").pop())}},m=function(t){var n=this.internal.collections[e+"images"];if(n)for(var r in n)if(t===n[r].alias)return n[r]},b=function(t,e,n){return t||e||(t=-96,e=-96),t<0&&(t=-1*n.width*72/t/this.internal.scaleFactor),e<0&&(e=-1*n.height*72/e/this.internal.scaleFactor),0===t&&(t=e*n.width/n.height),0===e&&(e=t*n.height/n.width),[t,e]},v=function(t,e,n,r,i,a){var s=b.call(this,n,r,i),o=this.internal.getCoordinateString,h=this.internal.getVerticalCoordinateString,l=c.call(this);if(n=s[0],r=s[1],l[i.index]=i,a){a*=Math.PI/180;var u=Math.cos(a),f=Math.sin(a),d=function(t){return t.toFixed(4)},p=[d(u),d(f),d(-1*f),d(u),0,0,"cm"]}this.internal.write("q"),a?(this.internal.write([1,"0","0",1,o(t),h(e+r),"cm"].join(" ")),this.internal.write(p.join(" ")),this.internal.write([o(n),"0","0",o(r),"0","0","cm"].join(" "))):this.internal.write([o(n),"0","0",o(r),o(t),h(e+r),"cm"].join(" ")),this.isAdvancedAPI()&&this.internal.write([1,0,0,-1,0,0,"cm"].join(" ")),this.internal.write("/I"+i.index+" Do"),this.internal.write("Q")},w=t.color_spaces={DEVICE_RGB:"DeviceRGB",DEVICE_GRAY:"DeviceGray",DEVICE_CMYK:"DeviceCMYK",CAL_GREY:"CalGray",CAL_RGB:"CalRGB",LAB:"Lab",ICC_BASED:"ICCBased",INDEXED:"Indexed",PATTERN:"Pattern",SEPARATION:"Separation",DEVICE_N:"DeviceN"};t.decode={DCT_DECODE:"DCTDecode",FLATE_DECODE:"FlateDecode",LZW_DECODE:"LZWDecode",JPX_DECODE:"JPXDecode",JBIG2_DECODE:"JBIG2Decode",ASCII85_DECODE:"ASCII85Decode",ASCII_HEX_DECODE:"ASCIIHexDecode",RUN_LENGTH_DECODE:"RunLengthDecode",CCITT_FAX_DECODE:"CCITTFaxDecode"};var y=t.image_compression={NONE:"NONE",FAST:"FAST",MEDIUM:"MEDIUM",SLOW:"SLOW"},_=t.__addimage__.sHashCode=function(t){var e,n,r=0;if("string"==typeof t)for(n=t.length,e=0;e<n;e++)r=(r<<5)-r+t.charCodeAt(e),r|=0;else if(L(t))for(n=t.byteLength/2,e=0;e<n;e++)r=(r<<5)-r+t[e],r|=0;return r},x=t.__addimage__.validateStringAsBase64=function(t){(t=t||"").toString().trim();var e=!0;return 0===t.length&&(e=!1),t.length%4!=0&&(e=!1),!1===/^[A-Za-z0-9+/]+$/.test(t.substr(0,t.length-2))&&(e=!1),!1===/^[A-Za-z0-9/][A-Za-z0-9+/]|[A-Za-z0-9+/]=|==$/.test(t.substr(-2))&&(e=!1),e},A=t.__addimage__.extractImageFromDataUrl=function(t){if(null==t)return null;if(!(t=t.trim()).startsWith("data:"))return null;var e=t.indexOf(",");return e<0?null:t.substring(0,e).trim().endsWith("base64")?t.substring(e+1):null};t.__addimage__.isArrayBuffer=function(t){return t instanceof ArrayBuffer};var L=t.__addimage__.isArrayBufferView=function(t){return t instanceof Int8Array||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array},N=t.__addimage__.binaryStringToUint8Array=function(t){for(var e=t.length,n=new Uint8Array(e),r=0;r<e;r++)n[r]=t.charCodeAt(r);return n},S=t.__addimage__.arrayBufferToBinaryString=function(t){for(var e="",n=L(t)?t:new Uint8Array(t),r=0;r<n.length;r+=8192)e+=String.fromCharCode.apply(null,n.subarray(r,r+8192));return e};t.addImage=function(){var t,e,i,a,s,o,h,c,u;if("number"==typeof arguments[1]?(e=n,i=arguments[1],a=arguments[2],s=arguments[3],o=arguments[4],h=arguments[5],c=arguments[6],u=arguments[7]):(e=arguments[1],i=arguments[2],a=arguments[3],s=arguments[4],o=arguments[5],h=arguments[6],c=arguments[7],u=arguments[8]),"object"===r(t=arguments[0])&&!p(t)&&"imageData"in t){var f=t;t=f.imageData,e=f.format||e||n,i=f.x||i||0,a=f.y||a||0,s=f.w||f.width||s,o=f.h||f.height||o,h=f.alias||h,c=f.compression||c,u=f.rotation||f.angle||u}var d=this.internal.getFilters();if(void 0===c&&-1!==d.indexOf("FlateEncode")&&(c="SLOW"),isNaN(i)||isNaN(a))throw new Error("Invalid coordinates passed to jsPDF.addImage");l.call(this);var g=k.call(this,t,e,h,c);return v.call(this,i,a,s,o,g,u),this};var k=function(e,r,i,s){var o,h,l;if("string"==typeof e&&a(e)===n){e=unescape(e);var c=P(e,!1);(""!==c||void 0!==(c=t.loadFile(e,!0)))&&(e=c)}if(p(e)&&(e=g(e,r)),r=a(e,r),!d(r))throw new Error("addImage does not support files of type '"+r+"', please ensure that a plugin for '"+r+"' support is added.");if((null==(l=i)||0===l.length)&&(i=function(t){return"string"==typeof t||L(t)?_(t):L(t.data)?_(t.data):null}(e)),(o=m.call(this,i))||(e instanceof Uint8Array||"RGBA"===r||(h=e,e=N(e)),o=this["process"+r.toUpperCase()](e,u.call(this),i,function(e){return e&&"string"==typeof e&&(e=e.toUpperCase()),e in t.image_compression?e:y.NONE}(s),h)),!o)throw new Error("An unknown error occurred whilst processing the image.");return o},P=t.__addimage__.convertBase64ToBinaryString=function(t,e){e="boolean"!=typeof e||e;var n,r="";if("string"==typeof t){var i;n=null!==(i=A(t))&&void 0!==i?i:t;try{r=f(n)}catch(a){if(e)throw x(n)?new Error("atob-Error in jsPDF.convertBase64ToBinaryString "+a.message):new Error("Supplied Data is not a valid base64-String jsPDF.convertBase64ToBinaryString ")}}return r};t.getImageProperties=function(e){var r,i,s="";if(p(e)&&(e=g(e)),"string"==typeof e&&a(e)===n&&(""===(s=P(e,!1))&&(s=t.loadFile(e)||""),e=s),i=a(e),!d(i))throw new Error("addImage does not support files of type '"+i+"', please ensure that a plugin for '"+i+"' support is added.");if(e instanceof Uint8Array||(e=N(e)),!(r=this["process"+i.toUpperCase()](e)))throw new Error("An unknown error occurred whilst processing the image");return r.fileType=i,r}}(R.API),
/**
   * @license
   * Copyright (c) 2014 Steven Spungin (TwelveTone LLC)  steven@twelvetone.tv
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e=function(t){if(void 0!==t&&""!=t)return!0};R.API.events.push(["addPage",function(t){this.internal.getPageInfo(t.pageNumber).pageContext.annotations=[]}]),t.events.push(["putPage",function(t){for(var n,r,i,a=this.internal.getCoordinateString,s=this.internal.getVerticalCoordinateString,o=this.internal.getPageInfoByObjId(t.objId),h=t.pageContext.annotations,l=!1,c=0;c<h.length&&!l;c++)switch((n=h[c]).type){case"link":(e(n.options.url)||e(n.options.pageNumber))&&(l=!0);break;case"reference":case"text":case"freetext":l=!0}if(0!=l){this.internal.write("/Annots [");for(var u=0;u<h.length;u++){n=h[u];var f=this.internal.pdfEscape,d=this.internal.getEncryptor(t.objId);switch(n.type){case"reference":this.internal.write(" "+n.object.objId+" 0 R ");break;case"text":var p=this.internal.newAdditionalObject(),g=this.internal.newAdditionalObject(),m=this.internal.getEncryptor(p.objId),b=n.title||"Note";i="<</Type /Annot /Subtype /Text "+(r="/Rect ["+a(n.bounds.x)+" "+s(n.bounds.y+n.bounds.h)+" "+a(n.bounds.x+n.bounds.w)+" "+s(n.bounds.y)+"] ")+"/Contents ("+f(m(n.contents))+")",i+=" /Popup "+g.objId+" 0 R",i+=" /P "+o.objId+" 0 R",i+=" /T ("+f(m(b))+") >>",p.content=i;var v=p.objId+" 0 R";i="<</Type /Annot /Subtype /Popup "+(r="/Rect ["+a(n.bounds.x+30)+" "+s(n.bounds.y+n.bounds.h)+" "+a(n.bounds.x+n.bounds.w+30)+" "+s(n.bounds.y)+"] ")+" /Parent "+v,n.open&&(i+=" /Open true"),i+=" >>",g.content=i,this.internal.write(p.objId,"0 R",g.objId,"0 R");break;case"freetext":r="/Rect ["+a(n.bounds.x)+" "+s(n.bounds.y)+" "+a(n.bounds.x+n.bounds.w)+" "+s(n.bounds.y+n.bounds.h)+"] ";var w=n.color||"#000000";i="<</Type /Annot /Subtype /FreeText "+r+"/Contents ("+f(d(n.contents))+")",i+=" /DS(font: Helvetica,sans-serif 12.0pt; text-align:left; color:#"+w+")",i+=" /Border [0 0 0]",i+=" >>",this.internal.write(i);break;case"link":if(n.options.name){var y=this.annotations._nameMap[n.options.name];n.options.pageNumber=y.page,n.options.top=y.y}else n.options.top||(n.options.top=0);if(r="/Rect ["+n.finalBounds.x+" "+n.finalBounds.y+" "+n.finalBounds.w+" "+n.finalBounds.h+"] ",i="",n.options.url)i="<</Type /Annot /Subtype /Link "+r+"/Border [0 0 0] /A <</S /URI /URI ("+f(d(n.options.url))+") >>";else if(n.options.pageNumber)switch(i="<</Type /Annot /Subtype /Link "+r+"/Border [0 0 0] /Dest ["+this.internal.getPageInfo(n.options.pageNumber).objId+" 0 R",n.options.magFactor=n.options.magFactor||"XYZ",n.options.magFactor){case"Fit":i+=" /Fit]";break;case"FitH":i+=" /FitH "+n.options.top+"]";break;case"FitV":n.options.left=n.options.left||0,i+=" /FitV "+n.options.left+"]";break;default:var _=s(n.options.top);n.options.left=n.options.left||0,void 0===n.options.zoom&&(n.options.zoom=0),i+=" /XYZ "+n.options.left+" "+_+" "+n.options.zoom+"]"}""!=i&&(i+=" >>",this.internal.write(i))}}this.internal.write("]")}}]),t.createAnnotation=function(t){var e=this.internal.getCurrentPageInfo();switch(t.type){case"link":this.link(t.bounds.x,t.bounds.y,t.bounds.w,t.bounds.h,t);break;case"text":case"freetext":e.pageContext.annotations.push(t)}},t.link=function(t,e,n,r,i){var a=this.internal.getCurrentPageInfo(),s=this.internal.getCoordinateString,o=this.internal.getVerticalCoordinateString;a.pageContext.annotations.push({finalBounds:{x:s(t),y:o(e),w:s(t+n),h:o(e+r)},options:i,type:"link"})},t.textWithLink=function(t,e,n,r){var i,a,s=this.getTextWidth(t),o=this.internal.getLineHeight()/this.internal.scaleFactor;if(void 0!==r.maxWidth){a=r.maxWidth;var h=this.splitTextToSize(t,a).length;i=Math.ceil(o*h)}else a=s,i=o;return this.text(t,e,n,r),n+=.2*o,"center"===r.align&&(e-=s/2),"right"===r.align&&(e-=s),this.link(e,n-o,a,i,r),s},t.getTextWidth=function(t){var e=this.internal.getFontSize();return this.getStringUnitWidth(t)*e/this.internal.scaleFactor}}(R.API),
/**
   * @license
   * Copyright (c) 2017 Aras Abbasi
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e={1569:[65152],1570:[65153,65154],1571:[65155,65156],1572:[65157,65158],1573:[65159,65160],1574:[65161,65162,65163,65164],1575:[65165,65166],1576:[65167,65168,65169,65170],1577:[65171,65172],1578:[65173,65174,65175,65176],1579:[65177,65178,65179,65180],1580:[65181,65182,65183,65184],1581:[65185,65186,65187,65188],1582:[65189,65190,65191,65192],1583:[65193,65194],1584:[65195,65196],1585:[65197,65198],1586:[65199,65200],1587:[65201,65202,65203,65204],1588:[65205,65206,65207,65208],1589:[65209,65210,65211,65212],1590:[65213,65214,65215,65216],1591:[65217,65218,65219,65220],1592:[65221,65222,65223,65224],1593:[65225,65226,65227,65228],1594:[65229,65230,65231,65232],1601:[65233,65234,65235,65236],1602:[65237,65238,65239,65240],1603:[65241,65242,65243,65244],1604:[65245,65246,65247,65248],1605:[65249,65250,65251,65252],1606:[65253,65254,65255,65256],1607:[65257,65258,65259,65260],1608:[65261,65262],1609:[65263,65264,64488,64489],1610:[65265,65266,65267,65268],1649:[64336,64337],1655:[64477],1657:[64358,64359,64360,64361],1658:[64350,64351,64352,64353],1659:[64338,64339,64340,64341],1662:[64342,64343,64344,64345],1663:[64354,64355,64356,64357],1664:[64346,64347,64348,64349],1667:[64374,64375,64376,64377],1668:[64370,64371,64372,64373],1670:[64378,64379,64380,64381],1671:[64382,64383,64384,64385],1672:[64392,64393],1676:[64388,64389],1677:[64386,64387],1678:[64390,64391],1681:[64396,64397],1688:[64394,64395],1700:[64362,64363,64364,64365],1702:[64366,64367,64368,64369],1705:[64398,64399,64400,64401],1709:[64467,64468,64469,64470],1711:[64402,64403,64404,64405],1713:[64410,64411,64412,64413],1715:[64406,64407,64408,64409],1722:[64414,64415],1723:[64416,64417,64418,64419],1726:[64426,64427,64428,64429],1728:[64420,64421],1729:[64422,64423,64424,64425],1733:[64480,64481],1734:[64473,64474],1735:[64471,64472],1736:[64475,64476],1737:[64482,64483],1739:[64478,64479],1740:[64508,64509,64510,64511],1744:[64484,64485,64486,64487],1746:[64430,64431],1747:[64432,64433]},n={65247:{65154:65269,65156:65271,65160:65273,65166:65275},65248:{65154:65270,65156:65272,65160:65274,65166:65276},65165:{65247:{65248:{65258:65010}}},1617:{1612:64606,1613:64607,1614:64608,1615:64609,1616:64610}},r={1612:64606,1613:64607,1614:64608,1615:64609,1616:64610},i=[1570,1571,1573,1575];t.__arabicParser__={};var a=t.__arabicParser__.isInArabicSubstitutionA=function(t){return void 0!==e[t.charCodeAt(0)]},s=t.__arabicParser__.isArabicLetter=function(t){return"string"==typeof t&&/^[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+$/.test(t)},o=t.__arabicParser__.isArabicEndLetter=function(t){return s(t)&&a(t)&&e[t.charCodeAt(0)].length<=2},h=t.__arabicParser__.isArabicAlfLetter=function(t){return s(t)&&i.indexOf(t.charCodeAt(0))>=0};t.__arabicParser__.arabicLetterHasIsolatedForm=function(t){return s(t)&&a(t)&&e[t.charCodeAt(0)].length>=1};var l=t.__arabicParser__.arabicLetterHasFinalForm=function(t){return s(t)&&a(t)&&e[t.charCodeAt(0)].length>=2};t.__arabicParser__.arabicLetterHasInitialForm=function(t){return s(t)&&a(t)&&e[t.charCodeAt(0)].length>=3};var c=t.__arabicParser__.arabicLetterHasMedialForm=function(t){return s(t)&&a(t)&&4==e[t.charCodeAt(0)].length},u=t.__arabicParser__.resolveLigatures=function(t){var e=0,r=n,i="",a=0;for(e=0;e<t.length;e+=1)void 0!==r[t.charCodeAt(e)]?(a++,"number"==typeof(r=r[t.charCodeAt(e)])&&(i+=String.fromCharCode(r),r=n,a=0),e===t.length-1&&(r=n,i+=t.charAt(e-(a-1)),e-=a-1,a=0)):(r=n,i+=t.charAt(e-a),e-=a,a=0);return i};t.__arabicParser__.isArabicDiacritic=function(t){return void 0!==t&&void 0!==r[t.charCodeAt(0)]};var f=t.__arabicParser__.getCorrectForm=function(t,e,n){return s(t)?!1===a(t)?-1:!l(t)||!s(e)&&!s(n)||!s(n)&&o(e)||o(t)&&!s(e)||o(t)&&h(e)||o(t)&&o(e)?0:c(t)&&s(e)&&!o(e)&&s(n)&&l(n)?3:o(t)||!s(n)?1:2:-1},d=function(t){var n=0,r=0,i=0,a="",o="",h="",l=(t=t||"").split("\\s+"),c=[];for(n=0;n<l.length;n+=1){for(c.push(""),r=0;r<l[n].length;r+=1)a=l[n][r],o=l[n][r-1],h=l[n][r+1],s(a)?(i=f(a,o,h),c[n]+=-1!==i?String.fromCharCode(e[a.charCodeAt(0)][i]):a):c[n]+=a;c[n]=u(c[n])}return c.join(" ")},p=t.__arabicParser__.processArabic=t.processArabic=function(){var t,e="string"==typeof arguments[0]?arguments[0]:arguments[0].text,n=[];if(Array.isArray(e)){var r=0;for(n=[],r=0;r<e.length;r+=1)Array.isArray(e[r])?n.push([d(e[r][0]),e[r][1],e[r][2]]):n.push([d(e[r])]);t=n}else t=d(e);return"string"==typeof arguments[0]?t:(arguments[0].text=t,arguments[0])};t.events.push(["preProcessText",p])}(R.API),
/** @license
   * jsPDF Autoprint Plugin
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){t.autoPrint=function(t){var e;return(t=t||{}).variant=t.variant||"non-conform","javascript"===t.variant?this.addJS("print({});"):(this.internal.events.subscribe("postPutResources",function(){e=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/S /Named"),this.internal.out("/Type /Action"),this.internal.out("/N /Print"),this.internal.out(">>"),this.internal.out("endobj")}),this.internal.events.subscribe("putCatalog",function(){this.internal.out("/OpenAction "+e+" 0 R")})),this}}(R.API),
/**
   * @license
   * Copyright (c) 2014 Steven Spungin (TwelveTone LLC)  steven@twelvetone.tv
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e=function(){var t=void 0;Object.defineProperty(this,"pdf",{get:function(){return t},set:function(e){t=e}});var e=150;Object.defineProperty(this,"width",{get:function(){return e},set:function(t){e=isNaN(t)||!1===Number.isInteger(t)||t<0?150:t,this.getContext("2d").pageWrapXEnabled&&(this.getContext("2d").pageWrapX=e+1)}});var n=300;Object.defineProperty(this,"height",{get:function(){return n},set:function(t){n=isNaN(t)||!1===Number.isInteger(t)||t<0?300:t,this.getContext("2d").pageWrapYEnabled&&(this.getContext("2d").pageWrapY=n+1)}});var r=[];Object.defineProperty(this,"childNodes",{get:function(){return r},set:function(t){r=t}});var i={};Object.defineProperty(this,"style",{get:function(){return i},set:function(t){i=t}}),Object.defineProperty(this,"parentNode",{})};e.prototype.getContext=function(t,e){var n;if("2d"!==(t=t||"2d"))return null;for(n in e)this.pdf.context2d.hasOwnProperty(n)&&(this.pdf.context2d[n]=e[n]);return this.pdf.context2d._canvas=this,this.pdf.context2d},e.prototype.toDataURL=function(){throw new Error("toDataURL is not implemented.")},t.events.push(["initialized",function(){this.canvas=new e,this.canvas.pdf=this}])}(R.API),function(t){var e={left:0,top:0,bottom:0,right:0},n=!1,i=function(){void 0===this.internal.__cell__&&(this.internal.__cell__={},this.internal.__cell__.padding=3,this.internal.__cell__.headerFunction=void 0,this.internal.__cell__.margins=Object.assign({},e),this.internal.__cell__.margins.width=this.getPageWidth(),a.call(this))},a=function(){this.internal.__cell__.lastCell=new s,this.internal.__cell__.pages=1},s=function(){var t=arguments[0];Object.defineProperty(this,"x",{enumerable:!0,get:function(){return t},set:function(e){t=e}});var e=arguments[1];Object.defineProperty(this,"y",{enumerable:!0,get:function(){return e},set:function(t){e=t}});var n=arguments[2];Object.defineProperty(this,"width",{enumerable:!0,get:function(){return n},set:function(t){n=t}});var r=arguments[3];Object.defineProperty(this,"height",{enumerable:!0,get:function(){return r},set:function(t){r=t}});var i=arguments[4];Object.defineProperty(this,"text",{enumerable:!0,get:function(){return i},set:function(t){i=t}});var a=arguments[5];Object.defineProperty(this,"lineNumber",{enumerable:!0,get:function(){return a},set:function(t){a=t}});var s=arguments[6];return Object.defineProperty(this,"align",{enumerable:!0,get:function(){return s},set:function(t){s=t}}),this};s.prototype.clone=function(){return new s(this.x,this.y,this.width,this.height,this.text,this.lineNumber,this.align)},s.prototype.toArray=function(){return[this.x,this.y,this.width,this.height,this.text,this.lineNumber,this.align]},t.setHeaderFunction=function(t){return i.call(this),this.internal.__cell__.headerFunction="function"==typeof t?t:void 0,this},t.getTextDimensions=function(t,e){i.call(this);var n=(e=e||{}).fontSize||this.getFontSize(),r=e.font||this.getFont(),a=e.scaleFactor||this.internal.scaleFactor,s=0,o=0,h=0,l=this;if(!Array.isArray(t)&&"string"!=typeof t){if("number"!=typeof t)throw new Error("getTextDimensions expects text-parameter to be of type String or type Number or an Array of Strings.");t=String(t)}var c=e.maxWidth;c>0?"string"==typeof t?t=this.splitTextToSize(t,c):"[object Array]"===Object.prototype.toString.call(t)&&(t=t.reduce(function(t,e){return t.concat(l.splitTextToSize(e,c))},[])):t=Array.isArray(t)?t:[t];for(var u=0;u<t.length;u++)s<(h=this.getStringUnitWidth(t[u],{font:r})*n)&&(s=h);return 0!==s&&(o=t.length),{w:s/=a,h:Math.max((o*n*this.getLineHeightFactor()-n*(this.getLineHeightFactor()-1))/a,0)}},t.cellAddPage=function(){i.call(this),this.addPage();var t=this.internal.__cell__.margins||e;return this.internal.__cell__.lastCell=new s(t.left,t.top,void 0,void 0),this.internal.__cell__.pages+=1,this};var o=t.cell=function(){var t;t=arguments[0]instanceof s?arguments[0]:new s(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]),i.call(this);var r=this.internal.__cell__.lastCell,a=this.internal.__cell__.padding,o=this.internal.__cell__.margins||e,h=this.internal.__cell__.tableHeaderRow,l=this.internal.__cell__.printHeaders;return void 0!==r.lineNumber&&(r.lineNumber===t.lineNumber?(t.x=(r.x||0)+(r.width||0),t.y=r.y||0):r.y+r.height+t.height+o.bottom>this.getPageHeight()?(this.cellAddPage(),t.y=o.top,l&&h&&(this.printHeaderRow(t.lineNumber,!0),t.y+=h[0].height)):t.y=r.y+r.height||t.y),void 0!==t.text[0]&&(this.rect(t.x,t.y,t.width,t.height,!0===n?"FD":void 0),"right"===t.align?this.text(t.text,t.x+t.width-a,t.y+a,{align:"right",baseline:"top"}):"center"===t.align?this.text(t.text,t.x+t.width/2,t.y+a,{align:"center",baseline:"top",maxWidth:t.width-a-a}):this.text(t.text,t.x+a,t.y+a,{align:"left",baseline:"top",maxWidth:t.width-a-a})),this.internal.__cell__.lastCell=t,this};t.table=function(t,n,l,c,u){if(i.call(this),!l)throw new Error("No data for PDF table.");var f,d,p,g,m=[],b=[],v=[],w={},y={},_=[],x=[],A=(u=u||{}).autoSize||!1,L=!1!==u.printHeaders,N=u.css&&void 0!==u.css["font-size"]?16*u.css["font-size"]:u.fontSize||12,S=u.margins||Object.assign({width:this.getPageWidth()},e),k="number"==typeof u.padding?u.padding:3,P=u.headerBackgroundColor||"#c8c8c8",F=u.headerTextColor||"#000";if(a.call(this),this.internal.__cell__.printHeaders=L,this.internal.__cell__.margins=S,this.internal.__cell__.table_font_size=N,this.internal.__cell__.padding=k,this.internal.__cell__.headerBackgroundColor=P,this.internal.__cell__.headerTextColor=F,this.setFontSize(N),null==c)b=m=Object.keys(l[0]),v=m.map(function(){return"left"});else if(Array.isArray(c)&&"object"===r(c[0]))for(m=c.map(function(t){return t.name}),b=c.map(function(t){return t.prompt||t.name||""}),v=c.map(function(t){return t.align||"left"}),f=0;f<c.length;f+=1)y[c[f].name]=.7499990551181103*c[f].width;else Array.isArray(c)&&"string"==typeof c[0]&&(b=m=c,v=m.map(function(){return"left"}));if(A||Array.isArray(c)&&"string"==typeof c[0])for(f=0;f<m.length;f+=1){for(w[g=m[f]]=l.map(function(t){return t[g]}),this.setFont(void 0,"bold"),_.push(this.getTextDimensions(b[f],{fontSize:this.internal.__cell__.table_font_size,scaleFactor:this.internal.scaleFactor}).w),d=w[g],this.setFont(void 0,"normal"),p=0;p<d.length;p+=1)_.push(this.getTextDimensions(d[p],{fontSize:this.internal.__cell__.table_font_size,scaleFactor:this.internal.scaleFactor}).w);y[g]=Math.max.apply(null,_)+k+k,_=[]}if(L){var I={};for(f=0;f<m.length;f+=1)I[m[f]]={},I[m[f]].text=b[f],I[m[f]].align=v[f];var C=h.call(this,I,y);x=m.map(function(e){return new s(t,n,y[e],C,I[e].text,void 0,I[e].align)}),this.setTableHeaderRow(x),this.printHeaderRow(1,!1)}var j=c.reduce(function(t,e){return t[e.name]=e.align,t},{});for(f=0;f<l.length;f+=1){"rowStart"in u&&u.rowStart instanceof Function&&u.rowStart({row:f,data:l[f]},this);var E=h.call(this,l[f],y);for(p=0;p<m.length;p+=1){var O=l[f][m[p]];"cellStart"in u&&u.cellStart instanceof Function&&u.cellStart({row:f,col:p,data:O},this),o.call(this,new s(t,n,y[m[p]],E,O,f+2,j[m[p]]))}}return this.internal.__cell__.table_x=t,this.internal.__cell__.table_y=n,this};var h=function(t,e){var n=this.internal.__cell__.padding,r=this.internal.__cell__.table_font_size,i=this.internal.scaleFactor;return Object.keys(t).map(function(r){var i=t[r];return this.splitTextToSize(i.hasOwnProperty("text")?i.text:i,e[r]-n-n)},this).map(function(t){return this.getLineHeightFactor()*t.length*r/i+n+n},this).reduce(function(t,e){return Math.max(t,e)},0)};t.setTableHeaderRow=function(t){i.call(this),this.internal.__cell__.tableHeaderRow=t},t.printHeaderRow=function(t,e){if(i.call(this),!this.internal.__cell__.tableHeaderRow)throw new Error("Property tableHeaderRow does not exist.");var r;if(n=!0,"function"==typeof this.internal.__cell__.headerFunction){var a=this.internal.__cell__.headerFunction(this,this.internal.__cell__.pages);this.internal.__cell__.lastCell=new s(a[0],a[1],a[2],a[3],void 0,-1)}this.setFont(void 0,"bold");for(var h=[],l=0;l<this.internal.__cell__.tableHeaderRow.length;l+=1){r=this.internal.__cell__.tableHeaderRow[l].clone(),e&&(r.y=this.internal.__cell__.margins.top||0,h.push(r)),r.lineNumber=t;var c=this.getTextColor();this.setTextColor(this.internal.__cell__.headerTextColor),this.setFillColor(this.internal.__cell__.headerBackgroundColor),o.call(this,r),this.setTextColor(c)}h.length>0&&this.setTableHeaderRow(h),this.setFont(void 0,"normal"),n=!1}}(R.API);var kt={italic:["italic","oblique","normal"],oblique:["oblique","italic","normal"],normal:["normal","oblique","italic"]},Pt=["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded"],Ft=St(Pt),It=[100,200,300,400,500,600,700,800,900],Ct=St(It);function jt(t){var e=t.family.replace(/"|'/g,"").toLowerCase(),n=function(t){return kt[t=t||"normal"]?t:"normal"}(t.style),r=function(t){return t?"number"==typeof t?t>=100&&t<=900&&t%100==0?t:400:/^\d00$/.test(t)?parseInt(t):"bold"===t?700:400:400}(t.weight),i=function(t){return"number"==typeof Ft[t=t||"normal"]?t:"normal"}(t.stretch);return{family:e,style:n,weight:r,stretch:i,src:t.src||[],ref:t.ref||{name:e,style:[i,n,r].join(" ")}}}function Et(t,e,n,r){var i;for(i=n;i>=0&&i<e.length;i+=r)if(t[e[i]])return t[e[i]];for(i=n;i>=0&&i<e.length;i-=r)if(t[e[i]])return t[e[i]]}var Ot={"sans-serif":"helvetica",fixed:"courier",monospace:"courier",terminal:"courier",cursive:"times",fantasy:"times",serif:"times"},Bt={caption:"times",icon:"times",menu:"times","message-box":"times","small-caption":"times","status-bar":"times"};function Mt(t){return[t.stretch,t.style,t.weight,t.family].join(" ")}function Rt(t){return t.trimLeft()}function Tt(t,e){for(var n=0;n<t.length;){if(t.charAt(n)===e)return[t.substring(0,n),t.substring(n+1)];n+=1}return null}function qt(t){var e=t.match(/^(-[a-z_]|[a-z_])[a-z0-9_-]*/i);return null===e?null:[e[0],t.substring(e[0].length)]}var Dt=["times"];!function(t){var e,n,i,a,o,h,l,c,f,d=function(t){return t=t||{},this.isStrokeTransparent=t.isStrokeTransparent||!1,this.strokeOpacity=t.strokeOpacity||1,this.strokeStyle=t.strokeStyle||"#000000",this.fillStyle=t.fillStyle||"#000000",this.isFillTransparent=t.isFillTransparent||!1,this.fillOpacity=t.fillOpacity||1,this.font=t.font||"10px sans-serif",this.textBaseline=t.textBaseline||"alphabetic",this.textAlign=t.textAlign||"left",this.lineWidth=t.lineWidth||1,this.lineJoin=t.lineJoin||"miter",this.lineCap=t.lineCap||"butt",this.path=t.path||[],this.transform=void 0!==t.transform?t.transform.clone():new c,this.globalCompositeOperation=t.globalCompositeOperation||"normal",this.globalAlpha=t.globalAlpha||1,this.clip_path=t.clip_path||[],this.currentPoint=t.currentPoint||new h,this.miterLimit=t.miterLimit||10,this.lastPoint=t.lastPoint||new h,this.lineDashOffset=t.lineDashOffset||0,this.lineDash=t.lineDash||[],this.margin=t.margin||[0,0,0,0],this.prevPageLastElemOffset=t.prevPageLastElemOffset||0,this.ignoreClearRect="boolean"!=typeof t.ignoreClearRect||t.ignoreClearRect,this};t.events.push(["initialized",function(){this.context2d=new p(this),e=this.internal.f2,n=this.internal.getCoordinateString,i=this.internal.getVerticalCoordinateString,a=this.internal.getHorizontalCoordinate,o=this.internal.getVerticalCoordinate,h=this.internal.Point,l=this.internal.Rectangle,c=this.internal.Matrix,f=new d}]);var p=function(t){Object.defineProperty(this,"canvas",{get:function(){return{parentNode:!1,style:!1}}});var e=t;Object.defineProperty(this,"pdf",{get:function(){return e}});var n=!1;Object.defineProperty(this,"pageWrapXEnabled",{get:function(){return n},set:function(t){n=Boolean(t)}});var r=!1;Object.defineProperty(this,"pageWrapYEnabled",{get:function(){return r},set:function(t){r=Boolean(t)}});var i=0;Object.defineProperty(this,"posX",{get:function(){return i},set:function(t){isNaN(t)||(i=t)}});var a=0;Object.defineProperty(this,"posY",{get:function(){return a},set:function(t){isNaN(t)||(a=t)}}),Object.defineProperty(this,"margin",{get:function(){return f.margin},set:function(t){var e;"number"==typeof t?e=[t,t,t,t]:((e=new Array(4))[0]=t[0],e[1]=t.length>=2?t[1]:e[0],e[2]=t.length>=3?t[2]:e[0],e[3]=t.length>=4?t[3]:e[1]),f.margin=e}});var s=!1;Object.defineProperty(this,"autoPaging",{get:function(){return s},set:function(t){s=t}});var o=0;Object.defineProperty(this,"lastBreak",{get:function(){return o},set:function(t){o=t}});var h=[];Object.defineProperty(this,"pageBreaks",{get:function(){return h},set:function(t){h=t}}),Object.defineProperty(this,"ctx",{get:function(){return f},set:function(t){t instanceof d&&(f=t)}}),Object.defineProperty(this,"path",{get:function(){return f.path},set:function(t){f.path=t}});var l=[];Object.defineProperty(this,"ctxStack",{get:function(){return l},set:function(t){l=t}}),Object.defineProperty(this,"fillStyle",{get:function(){return this.ctx.fillStyle},set:function(t){var e;e=g(t),this.ctx.fillStyle=e.style,this.ctx.isFillTransparent=0===e.a,this.ctx.fillOpacity=e.a,this.pdf.setFillColor(e.r,e.g,e.b,{a:e.a}),this.pdf.setTextColor(e.r,e.g,e.b,{a:e.a})}}),Object.defineProperty(this,"strokeStyle",{get:function(){return this.ctx.strokeStyle},set:function(t){var e=g(t);this.ctx.strokeStyle=e.style,this.ctx.isStrokeTransparent=0===e.a,this.ctx.strokeOpacity=e.a,0===e.a?this.pdf.setDrawColor(255,255,255):(e.a,this.pdf.setDrawColor(e.r,e.g,e.b))}}),Object.defineProperty(this,"lineCap",{get:function(){return this.ctx.lineCap},set:function(t){-1!==["butt","round","square"].indexOf(t)&&(this.ctx.lineCap=t,this.pdf.setLineCap(t))}}),Object.defineProperty(this,"lineWidth",{get:function(){return this.ctx.lineWidth},set:function(t){isNaN(t)||(this.ctx.lineWidth=t,this.pdf.setLineWidth(t))}}),Object.defineProperty(this,"lineJoin",{get:function(){return this.ctx.lineJoin},set:function(t){-1!==["bevel","round","miter"].indexOf(t)&&(this.ctx.lineJoin=t,this.pdf.setLineJoin(t))}}),Object.defineProperty(this,"miterLimit",{get:function(){return this.ctx.miterLimit},set:function(t){isNaN(t)||(this.ctx.miterLimit=t,this.pdf.setMiterLimit(t))}}),Object.defineProperty(this,"textBaseline",{get:function(){return this.ctx.textBaseline},set:function(t){this.ctx.textBaseline=t}}),Object.defineProperty(this,"textAlign",{get:function(){return this.ctx.textAlign},set:function(t){-1!==["right","end","center","left","start"].indexOf(t)&&(this.ctx.textAlign=t)}});var c=null,u=null;var p=null;Object.defineProperty(this,"fontFaces",{get:function(){return p},set:function(t){c=null,u=null,p=t}}),Object.defineProperty(this,"font",{get:function(){return this.ctx.font},set:function(t){var e;if(this.ctx.font=t,null!==(e=/^\s*(?=(?:(?:[-a-z]+\s*){0,2}(italic|oblique))?)(?=(?:(?:[-a-z]+\s*){0,2}(small-caps))?)(?=(?:(?:[-a-z]+\s*){0,2}(bold(?:er)?|lighter|[1-9]00))?)(?:(?:normal|\1|\2|\3)\s*){0,3}((?:xx?-)?(?:small|large)|medium|smaller|larger|[.\d]+(?:\%|in|[cem]m|ex|p[ctx]))(?:\s*\/\s*(normal|[.\d]+(?:\%|in|[cem]m|ex|p[ctx])))?\s*([-_,\"\'\sa-z0-9]+?)\s*$/i.exec(t))){var n=e[1];e[2];var r=e[3],i=e[4];e[5];var a=e[6],s=/^([.\d]+)((?:%|in|[cem]m|ex|p[ctx]))$/i.exec(i)[2];i="px"===s?Math.floor(parseFloat(i)*this.pdf.internal.scaleFactor):"em"===s?Math.floor(parseFloat(i)*this.pdf.getFontSize()):Math.floor(parseFloat(i)*this.pdf.internal.scaleFactor),this.pdf.setFontSize(i);var o=function(t){var e,n,r=[],i=t.trim();if(""===i)return Dt;if(i in Bt)return[Bt[i]];for(;""!==i;){switch(n=null,e=(i=Rt(i)).charAt(0)){case'"':case"'":n=Tt(i.substring(1),e);break;default:n=qt(i)}if(null===n)return Dt;if(r.push(n[0]),""!==(i=Rt(n[1]))&&","!==i.charAt(0))return Dt;i=i.replace(/^,/,"")}return r}(a);if(this.fontFaces){var h=function(t,e){var n=t.getFontList(),r=JSON.stringify(n);if(null===c||u!==r){var i=function(t){var e=[];return Object.keys(t).forEach(function(n){t[n].forEach(function(t){var r=null;switch(t){case"bold":r={family:n,weight:"bold"};break;case"italic":r={family:n,style:"italic"};break;case"bolditalic":r={family:n,weight:"bold",style:"italic"};break;case"":case"normal":r={family:n}}null!==r&&(r.ref={name:n,style:t},e.push(r))})}),e}(n);c=function(t){for(var e={},n=0;n<t.length;++n){var r=jt(t[n]),i=r.family,a=r.stretch,s=r.style,o=r.weight;e[i]=e[i]||{},e[i][a]=e[i][a]||{},e[i][a][s]=e[i][a][s]||{},e[i][a][s][o]=r}return e}(i.concat(e)),u=r}return c}(this.pdf,this.fontFaces),l=o.map(function(t){return{family:t,stretch:"normal",weight:r,style:n}}),f=function(t,e,n){for(var r=(n=n||{}).defaultFontFamily||"times",i=Object.assign({},Ot,n.genericFontFamilies||{}),a=null,s=null,o=0;o<e.length;++o)if(i[(a=jt(e[o])).family]&&(a.family=i[a.family]),t.hasOwnProperty(a.family)){s=t[a.family];break}if(!(s=s||t[r]))throw new Error("Could not find a font-family for the rule '"+Mt(a)+"' and default family '"+r+"'.");if(s=function(t,e){if(e[t])return e[t];var n=Ft[t],r=n<=Ft.normal?-1:1,i=Et(e,Pt,n,r);if(!i)throw new Error("Could not find a matching font-stretch value for "+t);return i}(a.stretch,s),s=function(t,e){if(e[t])return e[t];for(var n=kt[t],r=0;r<n.length;++r)if(e[n[r]])return e[n[r]];throw new Error("Could not find a matching font-style for "+t)}(a.style,s),!(s=function(t,e){if(e[t])return e[t];if(400===t&&e[500])return e[500];if(500===t&&e[400])return e[400];var n=Ct[t],r=Et(e,It,n,t<400?-1:1);if(!r)throw new Error("Could not find a matching font-weight for value "+t);return r}(a.weight,s)))throw new Error("Failed to resolve a font for the rule '"+Mt(a)+"'.");return s}(h,l);this.pdf.setFont(f.ref.name,f.ref.style)}else{var d="";("bold"===r||parseInt(r,10)>=700||"bold"===n)&&(d="bold"),"italic"===n&&(d+="italic"),0===d.length&&(d="normal");for(var p="",g={arial:"Helvetica",Arial:"Helvetica",verdana:"Helvetica",Verdana:"Helvetica",helvetica:"Helvetica",Helvetica:"Helvetica","sans-serif":"Helvetica",fixed:"Courier",monospace:"Courier",terminal:"Courier",cursive:"Times",fantasy:"Times",serif:"Times"},m=0;m<o.length;m++){if(void 0!==this.pdf.internal.getFont(o[m],d,{noFallback:!0,disableWarning:!0})){p=o[m];break}if("bolditalic"===d&&void 0!==this.pdf.internal.getFont(o[m],"bold",{noFallback:!0,disableWarning:!0}))p=o[m],d="bold";else if(void 0!==this.pdf.internal.getFont(o[m],"normal",{noFallback:!0,disableWarning:!0})){p=o[m],d="normal";break}}if(""===p)for(var b=0;b<o.length;b++)if(g[o[b]]){p=g[o[b]];break}p=""===p?"Times":p,this.pdf.setFont(p,d)}}}}),Object.defineProperty(this,"globalCompositeOperation",{get:function(){return this.ctx.globalCompositeOperation},set:function(t){this.ctx.globalCompositeOperation=t}}),Object.defineProperty(this,"globalAlpha",{get:function(){return this.ctx.globalAlpha},set:function(t){this.ctx.globalAlpha=t}}),Object.defineProperty(this,"lineDashOffset",{get:function(){return this.ctx.lineDashOffset},set:function(t){this.ctx.lineDashOffset=t,D.call(this)}}),Object.defineProperty(this,"lineDash",{get:function(){return this.ctx.lineDash},set:function(t){this.ctx.lineDash=t,D.call(this)}}),Object.defineProperty(this,"ignoreClearRect",{get:function(){return this.ctx.ignoreClearRect},set:function(t){this.ctx.ignoreClearRect=Boolean(t)}})};p.prototype.setLineDash=function(t){this.lineDash=t},p.prototype.getLineDash=function(){return this.lineDash.length%2?this.lineDash.concat(this.lineDash):this.lineDash.slice()},p.prototype.fill=function(){A.call(this,"fill",!1)},p.prototype.stroke=function(){A.call(this,"stroke",!1)},p.prototype.beginPath=function(){this.path=[{type:"begin"}]},p.prototype.moveTo=function(t,e){if(isNaN(t)||isNaN(e))throw s.error("jsPDF.context2d.moveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.moveTo");var n=this.ctx.transform.applyToPoint(new h(t,e));this.path.push({type:"mt",x:n.x,y:n.y}),this.ctx.lastPoint=new h(t,e)},p.prototype.closePath=function(){var t=new h(0,0),e=0;for(e=this.path.length-1;-1!==e;e--)if("begin"===this.path[e].type&&"object"===r(this.path[e+1])&&"number"==typeof this.path[e+1].x){t=new h(this.path[e+1].x,this.path[e+1].y);break}this.path.push({type:"close"}),this.ctx.lastPoint=new h(t.x,t.y)},p.prototype.lineTo=function(t,e){if(isNaN(t)||isNaN(e))throw s.error("jsPDF.context2d.lineTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.lineTo");var n=this.ctx.transform.applyToPoint(new h(t,e));this.path.push({type:"lt",x:n.x,y:n.y}),this.ctx.lastPoint=new h(n.x,n.y)},p.prototype.clip=function(){this.ctx.clip_path=JSON.parse(JSON.stringify(this.path)),A.call(this,null,!0)},p.prototype.quadraticCurveTo=function(t,e,n,r){if(isNaN(n)||isNaN(r)||isNaN(t)||isNaN(e))throw s.error("jsPDF.context2d.quadraticCurveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.quadraticCurveTo");var i=this.ctx.transform.applyToPoint(new h(n,r)),a=this.ctx.transform.applyToPoint(new h(t,e));this.path.push({type:"qct",x1:a.x,y1:a.y,x:i.x,y:i.y}),this.ctx.lastPoint=new h(i.x,i.y)},p.prototype.bezierCurveTo=function(t,e,n,r,i,a){if(isNaN(i)||isNaN(a)||isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r))throw s.error("jsPDF.context2d.bezierCurveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.bezierCurveTo");var o=this.ctx.transform.applyToPoint(new h(i,a)),l=this.ctx.transform.applyToPoint(new h(t,e)),c=this.ctx.transform.applyToPoint(new h(n,r));this.path.push({type:"bct",x1:l.x,y1:l.y,x2:c.x,y2:c.y,x:o.x,y:o.y}),this.ctx.lastPoint=new h(o.x,o.y)},p.prototype.arc=function(t,e,n,r,i,a){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||isNaN(i))throw s.error("jsPDF.context2d.arc: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.arc");if(a=Boolean(a),!this.ctx.transform.isIdentity){var o=this.ctx.transform.applyToPoint(new h(t,e));t=o.x,e=o.y;var l=this.ctx.transform.applyToPoint(new h(0,n)),c=this.ctx.transform.applyToPoint(new h(0,0));n=Math.sqrt(Math.pow(l.x-c.x,2)+Math.pow(l.y-c.y,2))}Math.abs(i-r)>=2*Math.PI&&(r=0,i=2*Math.PI),this.path.push({type:"arc",x:t,y:e,radius:n,startAngle:r,endAngle:i,counterclockwise:a})},p.prototype.arcTo=function(t,e,n,r,i){throw new Error("arcTo not implemented.")},p.prototype.rect=function(t,e,n,r){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r))throw s.error("jsPDF.context2d.rect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.rect");this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+r),this.lineTo(t,e+r),this.lineTo(t,e),this.lineTo(t+n,e),this.lineTo(t,e)},p.prototype.fillRect=function(t,e,n,r){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r))throw s.error("jsPDF.context2d.fillRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.fillRect");if(!m.call(this)){var i={};"butt"!==this.lineCap&&(i.lineCap=this.lineCap,this.lineCap="butt"),"miter"!==this.lineJoin&&(i.lineJoin=this.lineJoin,this.lineJoin="miter"),this.beginPath(),this.rect(t,e,n,r),this.fill(),i.hasOwnProperty("lineCap")&&(this.lineCap=i.lineCap),i.hasOwnProperty("lineJoin")&&(this.lineJoin=i.lineJoin)}},p.prototype.strokeRect=function(t,e,n,r){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r))throw s.error("jsPDF.context2d.strokeRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.strokeRect");b.call(this)||(this.beginPath(),this.rect(t,e,n,r),this.stroke())},p.prototype.clearRect=function(t,e,n,r){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r))throw s.error("jsPDF.context2d.clearRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.clearRect");this.ignoreClearRect||(this.fillStyle="#ffffff",this.fillRect(t,e,n,r))},p.prototype.save=function(t){t="boolean"!=typeof t||t;for(var e=this.pdf.internal.getCurrentPageInfo().pageNumber,n=0;n<this.pdf.internal.getNumberOfPages();n++)this.pdf.setPage(n+1),this.pdf.internal.out("q");if(this.pdf.setPage(e),t){this.ctx.fontSize=this.pdf.internal.getFontSize();var r=new d(this.ctx);this.ctxStack.push(this.ctx),this.ctx=r}},p.prototype.restore=function(t){t="boolean"!=typeof t||t;for(var e=this.pdf.internal.getCurrentPageInfo().pageNumber,n=0;n<this.pdf.internal.getNumberOfPages();n++)this.pdf.setPage(n+1),this.pdf.internal.out("Q");this.pdf.setPage(e),t&&0!==this.ctxStack.length&&(this.ctx=this.ctxStack.pop(),this.fillStyle=this.ctx.fillStyle,this.strokeStyle=this.ctx.strokeStyle,this.font=this.ctx.font,this.lineCap=this.ctx.lineCap,this.lineWidth=this.ctx.lineWidth,this.lineJoin=this.ctx.lineJoin,this.lineDash=this.ctx.lineDash,this.lineDashOffset=this.ctx.lineDashOffset)},p.prototype.toDataURL=function(){throw new Error("toDataUrl not implemented.")};var g=function(t){var e,n,r,i;if(!0===t.isCanvasGradient&&(t=t.getColor()),!t)return{r:0,g:0,b:0,a:0,style:t};if(/transparent|rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*0+\s*\)/.test(t))e=0,n=0,r=0,i=0;else{var a=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(t);if(null!==a)e=parseInt(a[1]),n=parseInt(a[2]),r=parseInt(a[3]),i=1;else if(null!==(a=/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/.exec(t)))e=parseInt(a[1]),n=parseInt(a[2]),r=parseInt(a[3]),i=parseFloat(a[4]);else{if(i=1,"string"==typeof t&&"#"!==t.charAt(0)){var s=new u(t);t=s.ok?s.toHex():"#000000"}4===t.length?(e=t.substring(1,2),e+=e,n=t.substring(2,3),n+=n,r=t.substring(3,4),r+=r):(e=t.substring(1,3),n=t.substring(3,5),r=t.substring(5,7)),e=parseInt(e,16),n=parseInt(n,16),r=parseInt(r,16)}}return{r:e,g:n,b:r,a:i,style:t}},m=function(){return this.ctx.isFillTransparent||0==this.globalAlpha},b=function(){return Boolean(this.ctx.isStrokeTransparent||0==this.globalAlpha)};p.prototype.fillText=function(t,e,n,r){if(isNaN(e)||isNaN(n)||"string"!=typeof t)throw s.error("jsPDF.context2d.fillText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.fillText");if(r=isNaN(r)?void 0:r,!m.call(this)){var i=R(this.ctx.transform.rotation),a=this.ctx.transform.scaleX;C.call(this,{text:t,x:e,y:n,scale:a,angle:i,align:this.textAlign,maxWidth:r})}},p.prototype.strokeText=function(t,e,n,r){if(isNaN(e)||isNaN(n)||"string"!=typeof t)throw s.error("jsPDF.context2d.strokeText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.strokeText");if(!b.call(this)){r=isNaN(r)?void 0:r;var i=R(this.ctx.transform.rotation),a=this.ctx.transform.scaleX;C.call(this,{text:t,x:e,y:n,scale:a,renderingMode:"stroke",angle:i,align:this.textAlign,maxWidth:r})}},p.prototype.measureText=function(t){if("string"!=typeof t)throw s.error("jsPDF.context2d.measureText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.measureText");var e=this.pdf,n=this.pdf.internal.scaleFactor,r=e.internal.getFontSize(),i=e.getStringUnitWidth(t)*r/e.internal.scaleFactor;return new function(t){var e=(t=t||{}).width||0;return Object.defineProperty(this,"width",{get:function(){return e}}),this}({width:i*=Math.round(96*n/72*1e4)/1e4})},p.prototype.scale=function(t,e){if(isNaN(t)||isNaN(e))throw s.error("jsPDF.context2d.scale: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.scale");var n=new c(t,0,0,e,0,0);this.ctx.transform=this.ctx.transform.multiply(n)},p.prototype.rotate=function(t){if(isNaN(t))throw s.error("jsPDF.context2d.rotate: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.rotate");var e=new c(Math.cos(t),Math.sin(t),-Math.sin(t),Math.cos(t),0,0);this.ctx.transform=this.ctx.transform.multiply(e)},p.prototype.translate=function(t,e){if(isNaN(t)||isNaN(e))throw s.error("jsPDF.context2d.translate: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.translate");var n=new c(1,0,0,1,t,e);this.ctx.transform=this.ctx.transform.multiply(n)},p.prototype.transform=function(t,e,n,r,i,a){if(isNaN(t)||isNaN(e)||isNaN(n)||isNaN(r)||isNaN(i)||isNaN(a))throw s.error("jsPDF.context2d.transform: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.transform");var o=new c(t,e,n,r,i,a);this.ctx.transform=this.ctx.transform.multiply(o)},p.prototype.setTransform=function(t,e,n,r,i,a){t=isNaN(t)?1:t,e=isNaN(e)?0:e,n=isNaN(n)?0:n,r=isNaN(r)?1:r,i=isNaN(i)?0:i,a=isNaN(a)?0:a,this.ctx.transform=new c(t,e,n,r,i,a)};var v=function(){return this.margin[0]>0||this.margin[1]>0||this.margin[2]>0||this.margin[3]>0};p.prototype.drawImage=function(t,e,n,r,i,a,s,o,h){var u=this.pdf.getImageProperties(t),f=1,d=1,p=1,g=1;void 0!==r&&void 0!==o&&(p=o/r,g=h/i,f=u.width/r*o/r,d=u.height/i*h/i),void 0===a&&(a=e,s=n,e=0,n=0),void 0!==r&&void 0===o&&(o=r,h=i),void 0===r&&void 0===o&&(o=u.width,h=u.height);var m=this.ctx.transform.decompose(),b=R(m.rotate.shx),y=new c,A=(y=(y=(y=y.multiply(m.translate)).multiply(m.skew)).multiply(m.scale)).applyToRectangle(new l(a-e*p,s-n*g,r*f,i*d));if(this.autoPaging){for(var N,S=w.call(this,A),k=[],P=0;P<S.length;P+=1)-1===k.indexOf(S[P])&&k.push(S[P]);x(k);for(var F=k[0],I=k[k.length-1],C=F;C<I+1;C++){this.pdf.setPage(C);var j=this.pdf.internal.pageSize.width-this.margin[3]-this.margin[1],E=1===C?this.posY+this.margin[0]:this.margin[0],O=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],B=this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2],M=1===C?0:O+(C-2)*B;if(0!==this.ctx.clip_path.length){var T=this.path;N=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=_(N,this.posX+this.margin[3],-M+E+this.ctx.prevPageLastElemOffset),L.call(this,"fill",!0),this.path=T}var q=JSON.parse(JSON.stringify(A));q=_([q],this.posX+this.margin[3],-M+E+this.ctx.prevPageLastElemOffset)[0];var D=(C>F||C<I)&&v.call(this);D&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],j,B,null).clip().discardPath()),this.pdf.addImage(t,"JPEG",q.x,q.y,q.w,q.h,null,null,b),D&&this.pdf.restoreGraphicsState()}}else this.pdf.addImage(t,"JPEG",A.x,A.y,A.w,A.h,null,null,b)};var w=function(t,e,n){var r=[];e=e||this.pdf.internal.pageSize.width,n=n||this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2];var i=this.posY+this.ctx.prevPageLastElemOffset;switch(t.type){default:case"mt":case"lt":r.push(Math.floor((t.y+i)/n)+1);break;case"arc":r.push(Math.floor((t.y+i-t.radius)/n)+1),r.push(Math.floor((t.y+i+t.radius)/n)+1);break;case"qct":var a=T(this.ctx.lastPoint.x,this.ctx.lastPoint.y,t.x1,t.y1,t.x,t.y);r.push(Math.floor((a.y+i)/n)+1),r.push(Math.floor((a.y+a.h+i)/n)+1);break;case"bct":var s=q(this.ctx.lastPoint.x,this.ctx.lastPoint.y,t.x1,t.y1,t.x2,t.y2,t.x,t.y);r.push(Math.floor((s.y+i)/n)+1),r.push(Math.floor((s.y+s.h+i)/n)+1);break;case"rect":r.push(Math.floor((t.y+i)/n)+1),r.push(Math.floor((t.y+t.h+i)/n)+1)}for(var o=0;o<r.length;o+=1)for(;this.pdf.internal.getNumberOfPages()<r[o];)y.call(this);return r},y=function(){var t=this.fillStyle,e=this.strokeStyle,n=this.font,r=this.lineCap,i=this.lineWidth,a=this.lineJoin;this.pdf.addPage(),this.fillStyle=t,this.strokeStyle=e,this.font=n,this.lineCap=r,this.lineWidth=i,this.lineJoin=a},_=function(t,e,n){for(var r=0;r<t.length;r++)switch(t[r].type){case"bct":t[r].x2+=e,t[r].y2+=n;case"qct":t[r].x1+=e,t[r].y1+=n;default:t[r].x+=e,t[r].y+=n}return t},x=function(t){return t.sort(function(t,e){return t-e})},A=function(t,e){var n=this.fillStyle,r=this.strokeStyle,i=this.lineCap,a=this.lineWidth,s=Math.abs(a*this.ctx.transform.scaleX),o=this.lineJoin;if(this.autoPaging){for(var h,l,c=JSON.parse(JSON.stringify(this.path)),u=JSON.parse(JSON.stringify(this.path)),f=[],d=0;d<u.length;d++)if(void 0!==u[d].x)for(var p=w.call(this,u[d]),g=0;g<p.length;g+=1)-1===f.indexOf(p[g])&&f.push(p[g]);for(var m=0;m<f.length;m++)for(;this.pdf.internal.getNumberOfPages()<f[m];)y.call(this);x(f);for(var b=f[0],A=f[f.length-1],N=b;N<A+1;N++){this.pdf.setPage(N),this.fillStyle=n,this.strokeStyle=r,this.lineCap=i,this.lineWidth=s,this.lineJoin=o;var S=this.pdf.internal.pageSize.width-this.margin[3]-this.margin[1],k=1===N?this.posY+this.margin[0]:this.margin[0],P=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],F=this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2],I=1===N?0:P+(N-2)*F;if(0!==this.ctx.clip_path.length){var C=this.path;h=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=_(h,this.posX+this.margin[3],-I+k+this.ctx.prevPageLastElemOffset),L.call(this,t,!0),this.path=C}if(l=JSON.parse(JSON.stringify(c)),this.path=_(l,this.posX+this.margin[3],-I+k+this.ctx.prevPageLastElemOffset),!1===e||0===N){var j=(N>b||N<A)&&v.call(this);j&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],S,F,null).clip().discardPath()),L.call(this,t,e),j&&this.pdf.restoreGraphicsState()}this.lineWidth=a}this.path=c}else this.lineWidth=s,L.call(this,t,e),this.lineWidth=a},L=function(t,e){if(("stroke"!==t||e||!b.call(this))&&("stroke"===t||e||!m.call(this))){for(var n,r,i=[],a=this.path,s=0;s<a.length;s++){var o=a[s];switch(o.type){case"begin":i.push({begin:!0});break;case"close":i.push({close:!0});break;case"mt":i.push({start:o,deltas:[],abs:[]});break;case"lt":var h=i.length;if(a[s-1]&&!isNaN(a[s-1].x)&&(n=[o.x-a[s-1].x,o.y-a[s-1].y],h>0))for(;h>=0;h--)if(!0!==i[h-1].close&&!0!==i[h-1].begin){i[h-1].deltas.push(n),i[h-1].abs.push(o);break}break;case"bct":n=[o.x1-a[s-1].x,o.y1-a[s-1].y,o.x2-a[s-1].x,o.y2-a[s-1].y,o.x-a[s-1].x,o.y-a[s-1].y],i[i.length-1].deltas.push(n);break;case"qct":var l=a[s-1].x+2/3*(o.x1-a[s-1].x),c=a[s-1].y+2/3*(o.y1-a[s-1].y),u=o.x+2/3*(o.x1-o.x),f=o.y+2/3*(o.y1-o.y),d=o.x,p=o.y;n=[l-a[s-1].x,c-a[s-1].y,u-a[s-1].x,f-a[s-1].y,d-a[s-1].x,p-a[s-1].y],i[i.length-1].deltas.push(n);break;case"arc":i.push({deltas:[],abs:[],arc:!0}),Array.isArray(i[i.length-1].abs)&&i[i.length-1].abs.push(o)}}r=e?null:"stroke"===t?"stroke":"fill";for(var g=!1,v=0;v<i.length;v++)if(i[v].arc)for(var w=i[v].abs,y=0;y<w.length;y++){var _=w[y];"arc"===_.type?k.call(this,_.x,_.y,_.radius,_.startAngle,_.endAngle,_.counterclockwise,void 0,e,!g):j.call(this,_.x,_.y),g=!0}else if(!0===i[v].close)this.pdf.internal.out("h"),g=!1;else if(!0!==i[v].begin){var x=i[v].start.x,A=i[v].start.y;E.call(this,i[v].deltas,x,A),g=!0}r&&P.call(this,r),e&&F.call(this)}},N=function(t){var e=this.pdf.internal.getFontSize()/this.pdf.internal.scaleFactor,n=e*(this.pdf.internal.getLineHeightFactor()-1);switch(this.ctx.textBaseline){case"bottom":return t-n;case"top":return t+e-n;case"hanging":return t+e-2*n;case"middle":return t+e/2-n;default:return t}},S=function(t){return t+this.pdf.internal.getFontSize()/this.pdf.internal.scaleFactor*(this.pdf.internal.getLineHeightFactor()-1)};p.prototype.createLinearGradient=function(){var t=function(){};return t.colorStops=[],t.addColorStop=function(t,e){this.colorStops.push([t,e])},t.getColor=function(){return 0===this.colorStops.length?"#000000":this.colorStops[0][1]},t.isCanvasGradient=!0,t},p.prototype.createPattern=function(){return this.createLinearGradient()},p.prototype.createRadialGradient=function(){return this.createLinearGradient()};var k=function(t,e,n,r,i,a,s,o,h){for(var l=B.call(this,n,r,i,a),c=0;c<l.length;c++){var u=l[c];0===c&&(h?I.call(this,u.x1+t,u.y1+e):j.call(this,u.x1+t,u.y1+e)),O.call(this,t,e,u.x2,u.y2,u.x3,u.y3,u.x4,u.y4)}o?F.call(this):P.call(this,s)},P=function(t){switch(t){case"stroke":this.pdf.internal.out("S");break;case"fill":this.pdf.internal.out("f")}},F=function(){this.pdf.clip(),this.pdf.discardPath()},I=function(t,e){this.pdf.internal.out(n(t)+" "+i(e)+" m")},C=function(t){var e;switch(t.align){case"right":case"end":e="right";break;case"center":e="center";break;default:e="left"}var n,r,i,a=this.pdf.getTextDimensions(t.text),s=N.call(this,t.y),o=S.call(this,s)-a.h,u=this.ctx.transform.applyToPoint(new h(t.x,s));if(this.autoPaging){var f=this.ctx.transform.decompose(),d=new c;d=(d=(d=d.multiply(f.translate)).multiply(f.skew)).multiply(f.scale);for(var p=this.ctx.transform.applyToRectangle(new l(t.x,s,a.w,a.h)),g=d.applyToRectangle(new l(t.x,o,a.w,a.h)),m=w.call(this,g),b=[],y=0;y<m.length;y+=1)-1===b.indexOf(m[y])&&b.push(m[y]);x(b);for(var A=b[0],k=b[b.length-1],P=A;P<k+1;P++){this.pdf.setPage(P);var F=1===P?this.posY+this.margin[0]:this.margin[0],I=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],C=this.pdf.internal.pageSize.height-this.margin[2],j=C-this.margin[0],E=this.pdf.internal.pageSize.width-this.margin[1],O=E-this.margin[3],B=1===P?0:I+(P-2)*j;if(0!==this.ctx.clip_path.length){var M=this.path;n=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=_(n,this.posX+this.margin[3],-1*B+F),L.call(this,"fill",!0),this.path=M}var R=_([JSON.parse(JSON.stringify(g))],this.posX+this.margin[3],-B+F+this.ctx.prevPageLastElemOffset)[0];t.scale>=.01&&(r=this.pdf.internal.getFontSize(),this.pdf.setFontSize(r*t.scale),i=this.lineWidth,this.lineWidth=i*t.scale);var T="text"!==this.autoPaging;if(T||R.y+R.h<=C){if(T||R.y>=F&&R.x<=E){var q=T?t.text:this.pdf.splitTextToSize(t.text,t.maxWidth||E-R.x)[0],D=_([JSON.parse(JSON.stringify(p))],this.posX+this.margin[3],-B+F+this.ctx.prevPageLastElemOffset)[0],z=T&&(P>A||P<k)&&v.call(this);z&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],O,j,null).clip().discardPath()),this.pdf.text(q,D.x,D.y,{angle:t.angle,align:e,renderingMode:t.renderingMode}),z&&this.pdf.restoreGraphicsState()}}else R.y<C&&(this.ctx.prevPageLastElemOffset+=C-R.y);t.scale>=.01&&(this.pdf.setFontSize(r),this.lineWidth=i)}}else t.scale>=.01&&(r=this.pdf.internal.getFontSize(),this.pdf.setFontSize(r*t.scale),i=this.lineWidth,this.lineWidth=i*t.scale),this.pdf.text(t.text,u.x+this.posX,u.y+this.posY,{angle:t.angle,align:e,renderingMode:t.renderingMode,maxWidth:t.maxWidth}),t.scale>=.01&&(this.pdf.setFontSize(r),this.lineWidth=i)},j=function(t,e,r,a){r=r||0,a=a||0,this.pdf.internal.out(n(t+r)+" "+i(e+a)+" l")},E=function(t,e,n){return this.pdf.lines(t,e,n,null,null)},O=function(t,n,r,i,s,h,l,c){this.pdf.internal.out([e(a(r+t)),e(o(i+n)),e(a(s+t)),e(o(h+n)),e(a(l+t)),e(o(c+n)),"c"].join(" "))},B=function(t,e,n,r){for(var i=2*Math.PI,a=Math.PI/2;e>n;)e-=i;var s=Math.abs(n-e);s<i&&r&&(s=i-s);for(var o=[],h=r?-1:1,l=e;s>1e-5;){var c=l+h*Math.min(s,a);o.push(M.call(this,t,l,c)),s-=Math.abs(c-l),l=c}return o},M=function(t,e,n){var r=(n-e)/2,i=t*Math.cos(r),a=t*Math.sin(r),s=i,o=-a,h=s*s+o*o,l=h+s*i+o*a,c=4/3*(Math.sqrt(2*h*l)-l)/(s*a-o*i),u=s-c*o,f=o+c*s,d=u,p=-f,g=r+e,m=Math.cos(g),b=Math.sin(g);return{x1:t*Math.cos(e),y1:t*Math.sin(e),x2:u*m-f*b,y2:u*b+f*m,x3:d*m-p*b,y3:d*b+p*m,x4:t*Math.cos(n),y4:t*Math.sin(n)}},R=function(t){return 180*t/Math.PI},T=function(t,e,n,r,i,a){var s=t+.5*(n-t),o=e+.5*(r-e),h=i+.5*(n-i),c=a+.5*(r-a),u=Math.min(t,i,s,h),f=Math.max(t,i,s,h),d=Math.min(e,a,o,c),p=Math.max(e,a,o,c);return new l(u,d,f-u,p-d)},q=function(t,e,n,r,i,a,s,o){var h,c,u,f,d,p,g,m,b,v,w,y,_,x,A=n-t,L=r-e,N=i-n,S=a-r,k=s-i,P=o-a;for(c=0;c<41;c++)b=(g=(u=t+(h=c/40)*A)+h*((d=n+h*N)-u))+h*(d+h*(i+h*k-d)-g),v=(m=(f=e+h*L)+h*((p=r+h*S)-f))+h*(p+h*(a+h*P-p)-m),0==c?(w=b,y=v,_=b,x=v):(w=Math.min(w,b),y=Math.min(y,v),_=Math.max(_,b),x=Math.max(x,v));return new l(Math.round(w),Math.round(y),Math.round(_-w),Math.round(x-y))},D=function(){if(this.prevLineDash||this.ctx.lineDash.length||this.ctx.lineDashOffset){var t,e,n=(t=this.ctx.lineDash,e=this.ctx.lineDashOffset,JSON.stringify({lineDash:t,lineDashOffset:e}));this.prevLineDash!==n&&(this.pdf.setLineDash(this.ctx.lineDash,this.ctx.lineDashOffset),this.prevLineDash=n)}}}(R.API);var zt=Uint8Array,Ut=Uint16Array,Ht=Int32Array,Wt=new zt([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Vt=new zt([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Gt=new zt([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Yt=function(t,e){for(var n=new Ut(31),r=0;r<31;++r)n[r]=e+=1<<t[r-1];var i=new Ht(n[30]);for(r=1;r<30;++r)for(var a=n[r];a<n[r+1];++a)i[a]=a-n[r]<<5|r;return{b:n,r:i}},Zt=Yt(Wt,2),Jt=Zt.b,Xt=Zt.r;Jt[28]=258,Xt[258]=28;for(var Kt=Yt(Vt,0).r,$t=new Ut(32768),Qt=0;Qt<32768;++Qt){var te=(43690&Qt)>>1|(21845&Qt)<<1;te=(61680&(te=(52428&te)>>2|(13107&te)<<2))>>4|(3855&te)<<4,$t[Qt]=((65280&te)>>8|(255&te)<<8)>>1}var ee=function(t,e,n){for(var r=t.length,i=0,a=new Ut(e);i<r;++i)t[i]&&++a[t[i]-1];var s,o=new Ut(e);for(i=1;i<e;++i)o[i]=o[i-1]+a[i-1]<<1;if(n){s=new Ut(1<<e);var h=15-e;for(i=0;i<r;++i)if(t[i])for(var l=i<<4|t[i],c=e-t[i],u=o[t[i]-1]++<<c,f=u|(1<<c)-1;u<=f;++u)s[$t[u]>>h]=l}else for(s=new Ut(r),i=0;i<r;++i)t[i]&&(s[i]=$t[o[t[i]-1]++]>>15-t[i]);return s},ne=new zt(288);for(Qt=0;Qt<144;++Qt)ne[Qt]=8;for(Qt=144;Qt<256;++Qt)ne[Qt]=9;for(Qt=256;Qt<280;++Qt)ne[Qt]=7;for(Qt=280;Qt<288;++Qt)ne[Qt]=8;var re=new zt(32);for(Qt=0;Qt<32;++Qt)re[Qt]=5;var ie=ee(ne,9,0),ae=ee(re,5,0),se=function(t){return(t+7)/8|0},oe=function(t,e,n){n<<=7&e;var r=e/8|0;t[r]|=n,t[r+1]|=n>>8},he=function(t,e,n){n<<=7&e;var r=e/8|0;t[r]|=n,t[r+1]|=n>>8,t[r+2]|=n>>16},le=function(t,e){for(var n=[],r=0;r<t.length;++r)t[r]&&n.push({s:r,f:t[r]});var i=n.length,a=n.slice();if(!i)return{t:me,l:0};if(1==i){var s=new zt(n[0].s+1);return s[n[0].s]=1,{t:s,l:1}}n.sort(function(t,e){return t.f-e.f}),n.push({s:-1,f:25001});var o=n[0],h=n[1],l=0,c=1,u=2;for(n[0]={s:-1,f:o.f+h.f,l:o,r:h};c!=i-1;)o=n[n[l].f<n[u].f?l++:u++],h=n[l!=c&&n[l].f<n[u].f?l++:u++],n[c++]={s:-1,f:o.f+h.f,l:o,r:h};var f=a[0].s;for(r=1;r<i;++r)a[r].s>f&&(f=a[r].s);var d=new Ut(f+1),p=ce(n[c-1],d,0);if(p>e){r=0;var g=0,m=p-e,b=1<<m;for(a.sort(function(t,e){return d[e.s]-d[t.s]||t.f-e.f});r<i;++r){var v=a[r].s;if(!(d[v]>e))break;g+=b-(1<<p-d[v]),d[v]=e}for(g>>=m;g>0;){var w=a[r].s;d[w]<e?g-=1<<e-d[w]++-1:++r}for(;r>=0&&g;--r){var y=a[r].s;d[y]==e&&(--d[y],++g)}p=e}return{t:new zt(d),l:p}},ce=function(t,e,n){return-1==t.s?Math.max(ce(t.l,e,n+1),ce(t.r,e,n+1)):e[t.s]=n},ue=function(t){for(var e=t.length;e&&!t[--e];);for(var n=new Ut(++e),r=0,i=t[0],a=1,s=function(t){n[r++]=t},o=1;o<=e;++o)if(t[o]==i&&o!=e)++a;else{if(!i&&a>2){for(;a>138;a-=138)s(32754);a>2&&(s(a>10?a-11<<5|28690:a-3<<5|12305),a=0)}else if(a>3){for(s(i),--a;a>6;a-=6)s(8304);a>2&&(s(a-3<<5|8208),a=0)}for(;a--;)s(i);a=1,i=t[o]}return{c:n.subarray(0,r),n:e}},fe=function(t,e){for(var n=0,r=0;r<e.length;++r)n+=t[r]*e[r];return n},de=function(t,e,n){var r=n.length,i=se(e+2);t[i]=255&r,t[i+1]=r>>8,t[i+2]=255^t[i],t[i+3]=255^t[i+1];for(var a=0;a<r;++a)t[i+a+4]=n[a];return 8*(i+4+r)},pe=function(t,e,n,r,i,a,s,o,h,l,c){oe(e,c++,n),++i[256];for(var u=le(i,15),f=u.t,d=u.l,p=le(a,15),g=p.t,m=p.l,b=ue(f),v=b.c,w=b.n,y=ue(g),_=y.c,x=y.n,A=new Ut(19),L=0;L<v.length;++L)++A[31&v[L]];for(L=0;L<_.length;++L)++A[31&_[L]];for(var N=le(A,7),S=N.t,k=N.l,P=19;P>4&&!S[Gt[P-1]];--P);var F,I,C,j,E=l+5<<3,O=fe(i,ne)+fe(a,re)+s,B=fe(i,f)+fe(a,g)+s+14+3*P+fe(A,S)+2*A[16]+3*A[17]+7*A[18];if(h>=0&&E<=O&&E<=B)return de(e,c,t.subarray(h,h+l));if(oe(e,c,1+(B<O)),c+=2,B<O){F=ee(f,d,0),I=f,C=ee(g,m,0),j=g;var M=ee(S,k,0);for(oe(e,c,w-257),oe(e,c+5,x-1),oe(e,c+10,P-4),c+=14,L=0;L<P;++L)oe(e,c+3*L,S[Gt[L]]);c+=3*P;for(var R=[v,_],T=0;T<2;++T){var q=R[T];for(L=0;L<q.length;++L){var D=31&q[L];oe(e,c,M[D]),c+=S[D],D>15&&(oe(e,c,q[L]>>5&127),c+=q[L]>>12)}}}else F=ie,I=ne,C=ae,j=re;for(L=0;L<o;++L){var z=r[L];if(z>255){he(e,c,F[257+(D=z>>18&31)]),c+=I[D+257],D>7&&(oe(e,c,z>>23&31),c+=Wt[D]);var U=31&z;he(e,c,C[U]),c+=j[U],U>3&&(he(e,c,z>>5&8191),c+=Vt[U])}else he(e,c,F[z]),c+=I[z]}return he(e,c,F[256]),c+I[256]},ge=new Ht([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),me=new zt(0),be=function(){var t=1,e=0;return{p:function(n){for(var r=t,i=e,a=0|n.length,s=0;s!=a;){for(var o=Math.min(s+2655,a);s<o;++s)i+=r+=n[s];r=(65535&r)+15*(r>>16),i=(65535&i)+15*(i>>16)}t=r,e=i},d:function(){return(255&(t%=65521))<<24|(65280&t)<<8|(255&(e%=65521))<<8|e>>8}}},ve=function(t,e,n){for(;n;++e)t[e]=n,n>>>=8};function we(t,e){e||(e={});var n=be();n.p(t);var r=function(t,e,n,r,i){if(!i&&(i={l:1},e.dictionary)){var a=e.dictionary.subarray(-32768),s=new zt(a.length+t.length);s.set(a),s.set(t,a.length),t=s,i.w=a.length}return function(t,e,n,r,i,a){var s=a.z||t.length,o=new zt(r+s+5*(1+Math.ceil(s/7e3))+i),h=o.subarray(r,o.length-i),l=a.l,c=7&(a.r||0);if(e){c&&(h[0]=a.r>>3);for(var u=ge[e-1],f=u>>13,d=8191&u,p=(1<<n)-1,g=a.p||new Ut(32768),m=a.h||new Ut(p+1),b=Math.ceil(n/3),v=2*b,w=function(e){return(t[e]^t[e+1]<<b^t[e+2]<<v)&p},y=new Ht(25e3),_=new Ut(288),x=new Ut(32),A=0,L=0,N=a.i||0,S=0,k=a.w||0,P=0;N+2<s;++N){var F=w(N),I=32767&N,C=m[F];if(g[I]=C,m[F]=I,k<=N){var j=s-N;if((A>7e3||S>24576)&&(j>423||!l)){c=pe(t,h,0,y,_,x,L,S,P,N-P,c),S=A=L=0,P=N;for(var E=0;E<286;++E)_[E]=0;for(E=0;E<30;++E)x[E]=0}var O=2,B=0,M=d,R=I-C&32767;if(j>2&&F==w(N-R))for(var T=Math.min(f,j)-1,q=Math.min(32767,N),D=Math.min(258,j);R<=q&&--M&&I!=C;){if(t[N+O]==t[N+O-R]){for(var z=0;z<D&&t[N+z]==t[N+z-R];++z);if(z>O){if(O=z,B=R,z>T)break;var U=Math.min(R,z-2),H=0;for(E=0;E<U;++E){var W=N-R+E&32767,V=W-g[W]&32767;V>H&&(H=V,C=W)}}}R+=(I=C)-(C=g[I])&32767}if(B){y[S++]=268435456|Xt[O]<<18|Kt[B];var G=31&Xt[O],Y=31&Kt[B];L+=Wt[G]+Vt[Y],++_[257+G],++x[Y],k=N+O,++A}else y[S++]=t[N],++_[t[N]]}}for(N=Math.max(N,k);N<s;++N)y[S++]=t[N],++_[t[N]];c=pe(t,h,l,y,_,x,L,S,P,N-P,c),l||(a.r=7&c|h[c/8|0]<<3,c-=7,a.h=m,a.p=g,a.i=N,a.w=k)}else{for(N=a.w||0;N<s+l;N+=65535){var Z=N+65535;Z>=s&&(h[c/8|0]=l,Z=s),c=de(h,c+1,t.subarray(N,Z))}a.i=s}return function(t,e,n){return(null==e||e<0)&&(e=0),(null==n||n>t.length)&&(n=t.length),new zt(t.subarray(e,n))}(o,0,r+se(c)+i)}(t,null==e.level?6:e.level,null==e.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(t.length)))):12+e.mem,n,4,i)}(t,e,e.dictionary?6:2);return function(t,e){var n=e.level,r=0==n?0:n<6?1:9==n?3:2;if(t[0]=120,t[1]=r<<6|(e.dictionary&&32),t[1]|=31-(t[0]<<8|t[1])%31,e.dictionary){var i=be();i.p(e.dictionary),ve(t,2,i.d())}}(r,e),ve(r,r.length-4,n.d()),r}var ye="undefined"!=typeof TextDecoder&&new TextDecoder;try{ye.decode(me,{stream:!0})}catch(es){}
/**
   * @license
   * jsPDF filters PlugIn
   * Copyright (c) 2014 Aras Abbasi
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */function _e(t,e="utf8"){return new TextDecoder(e).decode(t)}!function(t){var e=function(t){var e,n,r,i,a,s,o,h,l,c;for(/[^\x00-\xFF]/.test(t),n=[],r=0,i=(t+=e="\0\0\0\0".slice(t.length%4||4)).length;i>r;r+=4)0!==(a=(t.charCodeAt(r)<<24)+(t.charCodeAt(r+1)<<16)+(t.charCodeAt(r+2)<<8)+t.charCodeAt(r+3))?(s=(a=((a=((a=((a=(a-(c=a%85))/85)-(l=a%85))/85)-(h=a%85))/85)-(o=a%85))/85)%85,n.push(s+33,o+33,h+33,l+33,c+33)):n.push(122);return function(t,e){for(var n=e;n>0;n--)t.pop()}(n,e.length),String.fromCharCode.apply(String,n)+"~>"},n=function(t){var e,n,r,i,a,s=String,o="length",h=255,l="charCodeAt",c="slice",u="replace";for(t[c](-2),t=t[c](0,-2)[u](/\s/g,"")[u]("z","!!!!!"),r=[],i=0,a=(t+=e="uuuuu"[c](t[o]%5||5))[o];a>i;i+=5)n=52200625*(t[l](i)-33)+614125*(t[l](i+1)-33)+7225*(t[l](i+2)-33)+85*(t[l](i+3)-33)+(t[l](i+4)-33),r.push(h&n>>24,h&n>>16,h&n>>8,h&n);return function(t,e){for(var n=e;n>0;n--)t.pop()}(r,e[o]),s.fromCharCode.apply(s,r)},r=function(t){return t.split("").map(function(t){return("0"+t.charCodeAt().toString(16)).slice(-2)}).join("")+">"},i=function(t){var e=new RegExp(/^([0-9A-Fa-f]{2})+$/);if(-1!==(t=t.replace(/\s/g,"")).indexOf(">")&&(t=t.substr(0,t.indexOf(">"))),t.length%2&&(t+="0"),!1===e.test(t))return"";for(var n="",r=0;r<t.length;r+=2)n+=String.fromCharCode("0x"+(t[r]+t[r+1]));return n},a=function(t){for(var e=new Uint8Array(t.length),n=t.length;n--;)e[n]=t.charCodeAt(n);return(e=we(e)).reduce(function(t,e){return t+String.fromCharCode(e)},"")};t.processDataByFilters=function(t,s){var o=0,h=t||"",l=[];for("string"==typeof(s=s||[])&&(s=[s]),o=0;o<s.length;o+=1)switch(s[o]){case"ASCII85Decode":case"/ASCII85Decode":h=n(h),l.push("/ASCII85Encode");break;case"ASCII85Encode":case"/ASCII85Encode":h=e(h),l.push("/ASCII85Decode");break;case"ASCIIHexDecode":case"/ASCIIHexDecode":h=i(h),l.push("/ASCIIHexEncode");break;case"ASCIIHexEncode":case"/ASCIIHexEncode":h=r(h),l.push("/ASCIIHexDecode");break;case"FlateEncode":case"/FlateEncode":h=a(h),l.push("/FlateDecode");break;default:throw new Error('The filter: "'+s[o]+'" is not implemented')}return{data:h,reverseChain:l.reverse().join(" ")}}}(R.API),
/**
   * @license
   * jsPDF fileloading PlugIn
   * Copyright (c) 2018 Aras Abbasi (aras.abbasi@gmail.com)
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){t.loadFile=function(t,e,n){return function(t,e,n){e=!1!==e,n="function"==typeof n?n:function(){};var r=void 0;try{r=function(t,e,n){var r=new XMLHttpRequest,i=0,a=function(t){var e=t.length,n=[],r=String.fromCharCode;for(i=0;i<e;i+=1)n.push(r(255&t.charCodeAt(i)));return n.join("")};if(r.open("GET",t,!e),r.overrideMimeType("text/plain; charset=x-user-defined"),!1===e&&(r.onload=function(){200===r.status?n(a(this.responseText)):n(void 0)}),r.send(null),e&&200===r.status)return a(r.responseText)}(t,e,n)}catch(es){}return r}(t,e,n)},t.allowFsRead=void 0,t.loadImageFile=t.loadFile}(R.API),function(e){function n(){return(i.html2canvas?Promise.resolve(i.html2canvas):"object"===(void 0===t?"undefined":r(t))&&"undefined"!=typeof module?new Promise(function(t,e){try{t(require("html2canvas"))}catch(es){e(es)}}):"function"==typeof define&&define.amd?new Promise(function(t,e){try{require(["html2canvas"],t)}catch(es){e(es)}}):Promise.reject(new Error("Could not load html2canvas"))).catch(function(t){return Promise.reject(new Error("Could not load html2canvas: "+t))}).then(function(t){return t.default?t.default:t})}function a(){return(i.DOMPurify?Promise.resolve(i.DOMPurify):"object"===(void 0===t?"undefined":r(t))&&"undefined"!=typeof module?new Promise(function(t,e){try{t(require("dompurify"))}catch(es){e(es)}}):"function"==typeof define&&define.amd?new Promise(function(t,e){try{require(["dompurify"],t)}catch(es){e(es)}}):Promise.reject(new Error("Could not load dompurify"))).catch(function(t){return Promise.reject(new Error("Could not load dompurify: "+t))}).then(function(t){return t.default?t.default:t})}var s=function(t){var e=r(t);return"undefined"===e?"undefined":"string"===e||t instanceof String?"string":"number"===e||t instanceof Number?"number":"function"===e||t instanceof Function?"function":t&&t.constructor===Array?"array":t&&1===t.nodeType?"element":"object"===e?"object":"unknown"},o=function(t,e){var n=document.createElement(t);for(var r in e.className&&(n.className=e.className),e.innerHTML&&e.dompurify&&(n.innerHTML=e.dompurify.sanitize(e.innerHTML)),e.style)n.style[r]=e.style[r];return n},h=function t(e,n){for(var r=3===e.nodeType?document.createTextNode(e.nodeValue):e.cloneNode(!1),i=e.firstChild;i;i=i.nextSibling)!0!==n&&1===i.nodeType&&"SCRIPT"===i.nodeName||r.appendChild(t(i,n));return 1===e.nodeType&&("CANVAS"===e.nodeName?(r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0)):"TEXTAREA"!==e.nodeName&&"SELECT"!==e.nodeName||(r.value=e.value),r.addEventListener("load",function(){r.scrollTop=e.scrollTop,r.scrollLeft=e.scrollLeft},!0)),r},l=function t(e){var n=Object.assign(t.convert(Promise.resolve()),JSON.parse(JSON.stringify(t.template))),r=t.convert(Promise.resolve(),n);return(r=r.setProgress(1,t,1,[t])).set(e)};(l.prototype=Object.create(Promise.prototype)).constructor=l,l.convert=function(t,e){return t.__proto__=e||l.prototype,t},l.template={prop:{src:null,container:null,overlay:null,canvas:null,img:null,pdf:null,pageSize:null,callback:function(){}},progress:{val:0,state:null,n:0,stack:[]},opt:{filename:"file.pdf",margin:[0,0,0,0],enableLinks:!0,x:0,y:0,html2canvas:{},jsPDF:{},backgroundColor:"transparent"}},l.prototype.from=function(t,e){return this.then(function(){switch(e=e||function(t){switch(s(t)){case"string":return"string";case"element":return"canvas"===t.nodeName.toLowerCase()?"canvas":"element";default:return"unknown"}}(t),e){case"string":return this.then(a).then(function(e){return this.set({src:o("div",{innerHTML:t,dompurify:e})})});case"element":return this.set({src:t});case"canvas":return this.set({canvas:t});case"img":return this.set({img:t});default:return this.error("Unknown source type.")}})},l.prototype.to=function(t){switch(t){case"container":return this.toContainer();case"canvas":return this.toCanvas();case"img":return this.toImg();case"pdf":return this.toPdf();default:return this.error("Invalid target.")}},l.prototype.toContainer=function(){return this.thenList([function(){return this.prop.src||this.error("Cannot duplicate - no source HTML.")},function(){return this.prop.pageSize||this.setPageSize()}]).then(function(){var t={position:"relative",display:"inline-block",width:("number"!=typeof this.opt.width||isNaN(this.opt.width)||"number"!=typeof this.opt.windowWidth||isNaN(this.opt.windowWidth)?Math.max(this.prop.src.clientWidth,this.prop.src.scrollWidth,this.prop.src.offsetWidth):this.opt.windowWidth)+"px",left:0,right:0,top:0,margin:"auto",backgroundColor:this.opt.backgroundColor},e=h(this.prop.src,this.opt.html2canvas.javascriptEnabled);"BODY"===e.tagName&&(t.height=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight)+"px"),this.prop.overlay=o("div",{className:"html2pdf__overlay",style:{position:"fixed",overflow:"hidden",zIndex:1e3,left:"-100000px",right:0,bottom:0,top:0}}),this.prop.container=o("div",{className:"html2pdf__container",style:t}),this.prop.container.appendChild(e),this.prop.container.firstChild.appendChild(o("div",{style:{clear:"both",border:"0 none transparent",margin:0,padding:0,height:0}})),this.prop.container.style.float="none",this.prop.overlay.appendChild(this.prop.container),document.body.appendChild(this.prop.overlay),this.prop.container.firstChild.style.position="relative",this.prop.container.height=Math.max(this.prop.container.firstChild.clientHeight,this.prop.container.firstChild.scrollHeight,this.prop.container.firstChild.offsetHeight)+"px"})},l.prototype.toCanvas=function(){var t=[function(){return document.body.contains(this.prop.container)||this.toContainer()}];return this.thenList(t).then(n).then(function(t){var e=Object.assign({},this.opt.html2canvas);return delete e.onrendered,t(this.prop.container,e)}).then(function(t){(this.opt.html2canvas.onrendered||function(){})(t),this.prop.canvas=t,document.body.removeChild(this.prop.overlay)})},l.prototype.toContext2d=function(){var t=[function(){return document.body.contains(this.prop.container)||this.toContainer()}];return this.thenList(t).then(n).then(function(t){var e=this.opt.jsPDF,n=this.opt.fontFaces,r="number"!=typeof this.opt.width||isNaN(this.opt.width)||"number"!=typeof this.opt.windowWidth||isNaN(this.opt.windowWidth)?1:this.opt.width/this.opt.windowWidth,i=Object.assign({async:!0,allowTaint:!0,scale:r,scrollX:this.opt.scrollX||0,scrollY:this.opt.scrollY||0,backgroundColor:"#ffffff",imageTimeout:15e3,logging:!0,proxy:null,removeContainer:!0,foreignObjectRendering:!1,useCORS:!1},this.opt.html2canvas);if(delete i.onrendered,e.context2d.autoPaging=void 0===this.opt.autoPaging||this.opt.autoPaging,e.context2d.posX=this.opt.x,e.context2d.posY=this.opt.y,e.context2d.margin=this.opt.margin,e.context2d.fontFaces=n,n)for(var a=0;a<n.length;++a){var s=n[a],o=s.src.find(function(t){return"truetype"===t.format});o&&e.addFont(o.url,s.ref.name,s.ref.style)}return i.windowHeight=i.windowHeight||0,i.windowHeight=0==i.windowHeight?Math.max(this.prop.container.clientHeight,this.prop.container.scrollHeight,this.prop.container.offsetHeight):i.windowHeight,e.context2d.save(!0),t(this.prop.container,i)}).then(function(t){this.opt.jsPDF.context2d.restore(!0),(this.opt.html2canvas.onrendered||function(){})(t),this.prop.canvas=t,document.body.removeChild(this.prop.overlay)})},l.prototype.toImg=function(){return this.thenList([function(){return this.prop.canvas||this.toCanvas()}]).then(function(){var t=this.prop.canvas.toDataURL("image/"+this.opt.image.type,this.opt.image.quality);this.prop.img=document.createElement("img"),this.prop.img.src=t})},l.prototype.toPdf=function(){return this.thenList([function(){return this.toContext2d()}]).then(function(){this.prop.pdf=this.prop.pdf||this.opt.jsPDF})},l.prototype.output=function(t,e,n){return"img"===(n=n||"pdf").toLowerCase()||"image"===n.toLowerCase()?this.outputImg(t,e):this.outputPdf(t,e)},l.prototype.outputPdf=function(t,e){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).then(function(){return this.prop.pdf.output(t,e)})},l.prototype.outputImg=function(t){return this.thenList([function(){return this.prop.img||this.toImg()}]).then(function(){switch(t){case void 0:case"img":return this.prop.img;case"datauristring":case"dataurlstring":return this.prop.img.src;case"datauri":case"dataurl":return document.location.href=this.prop.img.src;default:throw'Image output type "'+t+'" is not supported.'}})},l.prototype.save=function(t){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).set(t?{filename:t}:null).then(function(){this.prop.pdf.save(this.opt.filename)})},l.prototype.doCallback=function(){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).then(function(){this.prop.callback(this.prop.pdf)})},l.prototype.set=function(t){if("object"!==s(t))return this;var e=Object.keys(t||{}).map(function(e){if(e in l.template.prop)return function(){this.prop[e]=t[e]};switch(e){case"margin":return this.setMargin.bind(this,t.margin);case"jsPDF":return function(){return this.opt.jsPDF=t.jsPDF,this.setPageSize()};case"pageSize":return this.setPageSize.bind(this,t.pageSize);default:return function(){this.opt[e]=t[e]}}},this);return this.then(function(){return this.thenList(e)})},l.prototype.get=function(t,e){return this.then(function(){var n=t in l.template.prop?this.prop[t]:this.opt[t];return e?e(n):n})},l.prototype.setMargin=function(t){return this.then(function(){switch(s(t)){case"number":t=[t,t,t,t];case"array":if(2===t.length&&(t=[t[0],t[1],t[0],t[1]]),4===t.length)break;default:return this.error("Invalid margin array.")}this.opt.margin=t}).then(this.setPageSize)},l.prototype.setPageSize=function(t){function e(t,e){return Math.floor(t*e/72*96)}return this.then(function(){(t=t||R.getPageSize(this.opt.jsPDF)).hasOwnProperty("inner")||(t.inner={width:t.width-this.opt.margin[1]-this.opt.margin[3],height:t.height-this.opt.margin[0]-this.opt.margin[2]},t.inner.px={width:e(t.inner.width,t.k),height:e(t.inner.height,t.k)},t.inner.ratio=t.inner.height/t.inner.width),this.prop.pageSize=t})},l.prototype.setProgress=function(t,e,n,r){return null!=t&&(this.progress.val=t),null!=e&&(this.progress.state=e),null!=n&&(this.progress.n=n),null!=r&&(this.progress.stack=r),this.progress.ratio=this.progress.val/this.progress.state,this},l.prototype.updateProgress=function(t,e,n,r){return this.setProgress(t?this.progress.val+t:null,e||null,n?this.progress.n+n:null,r?this.progress.stack.concat(r):null)},l.prototype.then=function(t,e){var n=this;return this.thenCore(t,e,function(t,e){return n.updateProgress(null,null,1,[t]),Promise.prototype.then.call(this,function(e){return n.updateProgress(null,t),e}).then(t,e).then(function(t){return n.updateProgress(1),t})})},l.prototype.thenCore=function(t,e,n){n=n||Promise.prototype.then;var r=this;t&&(t=t.bind(r)),e&&(e=e.bind(r));var i=-1!==Promise.toString().indexOf("[native code]")&&"Promise"===Promise.name?r:l.convert(Object.assign({},r),Promise.prototype),a=n.call(i,t,e);return l.convert(a,r.__proto__)},l.prototype.thenExternal=function(t,e){return Promise.prototype.then.call(this,t,e)},l.prototype.thenList=function(t){var e=this;return t.forEach(function(t){e=e.thenCore(t)}),e},l.prototype.catch=function(t){t&&(t=t.bind(this));var e=Promise.prototype.catch.call(this,t);return l.convert(e,this)},l.prototype.catchExternal=function(t){return Promise.prototype.catch.call(this,t)},l.prototype.error=function(t){return this.then(function(){throw new Error(t)})},l.prototype.using=l.prototype.set,l.prototype.saveAs=l.prototype.save,l.prototype.export=l.prototype.output,l.prototype.run=l.prototype.then,R.getPageSize=function(t,e,n){if("object"===r(t)){var i=t;t=i.orientation,e=i.unit||e,n=i.format||n}e=e||"mm",n=n||"a4",t=(""+(t||"P")).toLowerCase();var a,s=(""+n).toLowerCase(),o={a0:[2383.94,3370.39],a1:[1683.78,2383.94],a2:[1190.55,1683.78],a3:[841.89,1190.55],a4:[595.28,841.89],a5:[419.53,595.28],a6:[297.64,419.53],a7:[209.76,297.64],a8:[147.4,209.76],a9:[104.88,147.4],a10:[73.7,104.88],b0:[2834.65,4008.19],b1:[2004.09,2834.65],b2:[1417.32,2004.09],b3:[1000.63,1417.32],b4:[708.66,1000.63],b5:[498.9,708.66],b6:[354.33,498.9],b7:[249.45,354.33],b8:[175.75,249.45],b9:[124.72,175.75],b10:[87.87,124.72],c0:[2599.37,3676.54],c1:[1836.85,2599.37],c2:[1298.27,1836.85],c3:[918.43,1298.27],c4:[649.13,918.43],c5:[459.21,649.13],c6:[323.15,459.21],c7:[229.61,323.15],c8:[161.57,229.61],c9:[113.39,161.57],c10:[79.37,113.39],dl:[311.81,623.62],letter:[612,792],"government-letter":[576,756],legal:[612,1008],"junior-legal":[576,360],ledger:[1224,792],tabloid:[792,1224],"credit-card":[153,243]};switch(e){case"pt":a=1;break;case"mm":a=72/25.4;break;case"cm":a=72/2.54;break;case"in":a=72;break;case"px":a=.75;break;case"pc":case"em":a=12;break;case"ex":a=6;break;default:throw"Invalid unit: "+e}var h,l=0,c=0;if(o.hasOwnProperty(s))l=o[s][1]/a,c=o[s][0]/a;else try{l=n[1],c=n[0]}catch(qn){throw new Error("Invalid format: "+n)}if("p"===t||"portrait"===t)t="p",c>l&&(h=c,c=l,l=h);else{if("l"!==t&&"landscape"!==t)throw"Invalid orientation: "+t;t="l",l>c&&(h=c,c=l,l=h)}return{width:c,height:l,unit:e,k:a,orientation:t}},e.html=function(t,e){(e=e||{}).callback=e.callback||function(){},e.html2canvas=e.html2canvas||{},e.html2canvas.canvas=e.html2canvas.canvas||this.canvas,e.jsPDF=e.jsPDF||this,e.fontFaces=e.fontFaces?e.fontFaces.map(jt):null;var n=new l(e);return e.worker?n:n.from(t).doCallback()}}(R.API),
/**
   * @license
   * ====================================================================
   * Copyright (c) 2013 Youssef Beddad, youssef.beddad@gmail.com
   *
   * Permission is hereby granted, free of charge, to any person obtaining
   * a copy of this software and associated documentation files (the
   * "Software"), to deal in the Software without restriction, including
   * without limitation the rights to use, copy, modify, merge, publish,
   * distribute, sublicense, and/or sell copies of the Software, and to
   * permit persons to whom the Software is furnished to do so, subject to
   * the following conditions:
   *
   * The above copyright notice and this permission notice shall be
   * included in all copies or substantial portions of the Software.
   *
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
   * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
   * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
   * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
   * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
   * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
   * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
   * ====================================================================
   */
function(t){var e,n,r;t.addJS=function(t){return r=t,this.internal.events.subscribe("postPutResources",function(){e=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/Names [(EmbeddedJS) "+(e+1)+" 0 R]"),this.internal.out(">>"),this.internal.out("endobj"),n=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/S /JavaScript"),this.internal.out("/JS ("+r+")"),this.internal.out(">>"),this.internal.out("endobj")}),this.internal.events.subscribe("putCatalog",function(){void 0!==e&&void 0!==n&&this.internal.out("/Names <</JavaScript "+e+" 0 R>>")}),this}}(R.API),
/**
   * @license
   * Copyright (c) 2014 Steven Spungin (TwelveTone LLC)  steven@twelvetone.tv
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e;t.events.push(["postPutResources",function(){var t=this,n=/^(\d+) 0 obj$/;if(this.outline.root.children.length>0)for(var r=t.outline.render().split(/\r\n/),i=0;i<r.length;i++){var a=r[i],s=n.exec(a);if(null!=s){var o=s[1];t.internal.newObjectDeferredBegin(o,!1)}t.internal.write(a)}if(this.outline.createNamedDestinations){var h=this.internal.pages.length,l=[];for(i=0;i<h;i++){var c=t.internal.newObject();l.push(c);var u=t.internal.getPageInfo(i+1);t.internal.write("<< /D["+u.objId+" 0 R /XYZ null null null]>> endobj")}var f=t.internal.newObject();for(t.internal.write("<< /Names [ "),i=0;i<l.length;i++)t.internal.write("(page_"+(i+1)+")"+l[i]+" 0 R");t.internal.write(" ] >>","endobj"),e=t.internal.newObject(),t.internal.write("<< /Dests "+f+" 0 R"),t.internal.write(">>","endobj")}}]),t.events.push(["putCatalog",function(){var t=this;t.outline.root.children.length>0&&(t.internal.write("/Outlines",this.outline.makeRef(this.outline.root)),this.outline.createNamedDestinations&&t.internal.write("/Names "+e+" 0 R"))}]),t.events.push(["initialized",function(){var t=this;t.outline={createNamedDestinations:!1,root:{children:[]}},t.outline.add=function(t,e,n){var r={title:e,options:n,children:[]};return null==t&&(t=this.root),t.children.push(r),r},t.outline.render=function(){return this.ctx={},this.ctx.val="",this.ctx.pdf=t,this.genIds_r(this.root),this.renderRoot(this.root),this.renderItems(this.root),this.ctx.val},t.outline.genIds_r=function(e){e.id=t.internal.newObjectDeferred();for(var n=0;n<e.children.length;n++)this.genIds_r(e.children[n])},t.outline.renderRoot=function(t){this.objStart(t),this.line("/Type /Outlines"),t.children.length>0&&(this.line("/First "+this.makeRef(t.children[0])),this.line("/Last "+this.makeRef(t.children[t.children.length-1]))),this.line("/Count "+this.count_r({count:0},t)),this.objEnd()},t.outline.renderItems=function(e){for(var n=this.ctx.pdf.internal.getVerticalCoordinateString,r=0;r<e.children.length;r++){var i=e.children[r];this.objStart(i),this.line("/Title "+this.makeString(i.title)),this.line("/Parent "+this.makeRef(e)),r>0&&this.line("/Prev "+this.makeRef(e.children[r-1])),r<e.children.length-1&&this.line("/Next "+this.makeRef(e.children[r+1])),i.children.length>0&&(this.line("/First "+this.makeRef(i.children[0])),this.line("/Last "+this.makeRef(i.children[i.children.length-1])));var a=this.count=this.count_r({count:0},i);if(a>0&&this.line("/Count "+a),i.options&&i.options.pageNumber){var s=t.internal.getPageInfo(i.options.pageNumber);this.line("/Dest ["+s.objId+" 0 R /XYZ 0 "+n(0)+" 0]")}this.objEnd()}for(var o=0;o<e.children.length;o++)this.renderItems(e.children[o])},t.outline.line=function(t){this.ctx.val+=t+"\r\n"},t.outline.makeRef=function(t){return t.id+" 0 R"},t.outline.makeString=function(e){return"("+t.internal.pdfEscape(e)+")"},t.outline.objStart=function(t){this.ctx.val+="\r\n"+t.id+" 0 obj\r\n<<\r\n"},t.outline.objEnd=function(){this.ctx.val+=">> \r\nendobj\r\n"},t.outline.count_r=function(t,e){for(var n=0;n<e.children.length;n++)t.count++,this.count_r(t,e.children[n]);return t.count}}])}(R.API),
/**
   * @license
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e=[192,193,194,195,196,197,198,199];t.processJPEG=function(t,n,r,i,a,s){var o,h=this.decode.DCT_DECODE,l=null;if("string"==typeof t||this.__addimage__.isArrayBuffer(t)||this.__addimage__.isArrayBufferView(t)){switch(t=a||t,t=this.__addimage__.isArrayBuffer(t)?new Uint8Array(t):t,o=function(t){for(var n,r=256*t.charCodeAt(4)+t.charCodeAt(5),i=t.length,a={width:0,height:0,numcomponents:1},s=4;s<i;s+=2){if(s+=r,-1!==e.indexOf(t.charCodeAt(s+1))){n=256*t.charCodeAt(s+5)+t.charCodeAt(s+6),a={width:256*t.charCodeAt(s+7)+t.charCodeAt(s+8),height:n,numcomponents:t.charCodeAt(s+9)};break}r=256*t.charCodeAt(s+2)+t.charCodeAt(s+3)}return a}(t=this.__addimage__.isArrayBufferView(t)?this.__addimage__.arrayBufferToBinaryString(t):t),o.numcomponents){case 1:s=this.color_spaces.DEVICE_GRAY;break;case 4:s=this.color_spaces.DEVICE_CMYK;break;case 3:s=this.color_spaces.DEVICE_RGB}l={data:t,width:o.width,height:o.height,colorSpace:s,bitsPerComponent:8,filter:h,index:n,alias:r}}return l}}(R.API);const xe=new TextEncoder,Ae=(()=>{const t=new Uint8Array(4);return!((new Uint32Array(t.buffer)[0]=1)&t[0])})(),Le={int8:globalThis.Int8Array,uint8:globalThis.Uint8Array,int16:globalThis.Int16Array,uint16:globalThis.Uint16Array,int32:globalThis.Int32Array,uint32:globalThis.Uint32Array,uint64:globalThis.BigUint64Array,int64:globalThis.BigInt64Array,float32:globalThis.Float32Array,float64:globalThis.Float64Array};class Ne{buffer;byteLength;byteOffset;length;offset;lastWrittenByte;littleEndian;_data;_mark;_marks;constructor(t=8192,e={}){let n=!1;"number"==typeof t?t=new ArrayBuffer(t):(n=!0,this.lastWrittenByte=t.byteLength);const r=e.offset?e.offset>>>0:0,i=t.byteLength-r;let a=r;(ArrayBuffer.isView(t)||t instanceof Ne)&&(t.byteLength!==t.buffer.byteLength&&(a=t.byteOffset+r),t=t.buffer),this.lastWrittenByte=n?i:0,this.buffer=t,this.length=i,this.byteLength=i,this.byteOffset=a,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,a,i),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}back(t=1){return this.offset-=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(void 0===t)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const e=2*(this.offset+t),n=new Uint8Array(e);n.set(new Uint8Array(this.buffer)),this.buffer=n.buffer,this.length=e,this.byteLength=e,this._data=new DataView(this.buffer)}return this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){return this.readArray(t,"uint8")}readArray(t,e){const n=Le[e].BYTES_PER_ELEMENT*t,r=this.byteOffset+this.offset,i=this.buffer.slice(r,r+n);if(this.littleEndian===Ae&&"uint8"!==e&&"int8"!==e){const t=new Uint8Array(this.buffer.slice(r,r+n));t.reverse();const i=new Le[e](t.buffer);return this.offset+=n,i.reverse(),i}const a=new Le[e](i);return this.offset+=n,a}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readBigInt64(){const t=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,t}readBigUint64(){const t=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let e="";for(let n=0;n<t;n++)e+=this.readChar();return e}readUtf8(t=1){return _e(this.readBytes(t))}decodeText(t=1,e="utf8"){return _e(this.readBytes(t),e)}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let e=0;e<t.length;e++)this._data.setUint8(this.offset++,t[e]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(t){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(t){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let e=0;e<t.length;e++)this.writeUint8(t.charCodeAt(e));return this}writeUtf8(t){return this.writeBytes(function(t){return xe.encode(t)}(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}getWrittenByteLength(){return this.lastWrittenByte-this.byteOffset}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}
/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */function Se(t){let e=t.length;for(;--e>=0;)t[e]=0}const ke=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Pe=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Fe=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Ie=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ce=new Array(576);Se(Ce);const je=new Array(60);Se(je);const Ee=new Array(512);Se(Ee);const Oe=new Array(256);Se(Oe);const Be=new Array(29);Se(Be);const Me=new Array(30);function Re(t,e,n,r,i){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=r,this.max_length=i,this.has_stree=t&&t.length}let Te,qe,De;function ze(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Se(Me);const Ue=t=>t<256?Ee[t]:Ee[256+(t>>>7)],He=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},We=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,He(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},Ve=(t,e,n)=>{We(t,n[2*e],n[2*e+1])},Ge=(t,e)=>{let n=0;do{n|=1&t,t>>>=1,n<<=1}while(--e>0);return n>>>1},Ye=(t,e,n)=>{const r=new Array(16);let i,a,s=0;for(i=1;i<=15;i++)s=s+n[i-1]<<1,r[i]=s;for(a=0;a<=e;a++){let e=t[2*a+1];0!==e&&(t[2*a]=Ge(r[e]++,e))}},Ze=t=>{let e;for(e=0;e<286;e++)t.dyn_ltree[2*e]=0;for(e=0;e<30;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},Je=t=>{t.bi_valid>8?He(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},Xe=(t,e,n,r)=>{const i=2*e,a=2*n;return t[i]<t[a]||t[i]===t[a]&&r[e]<=r[n]},Ke=(t,e,n)=>{const r=t.heap[n];let i=n<<1;for(;i<=t.heap_len&&(i<t.heap_len&&Xe(e,t.heap[i+1],t.heap[i],t.depth)&&i++,!Xe(e,r,t.heap[i],t.depth));)t.heap[n]=t.heap[i],n=i,i<<=1;t.heap[n]=r},$e=(t,e,n)=>{let r,i,a,s,o=0;if(0!==t.sym_next)do{r=255&t.pending_buf[t.sym_buf+o++],r+=(255&t.pending_buf[t.sym_buf+o++])<<8,i=t.pending_buf[t.sym_buf+o++],0===r?Ve(t,i,e):(a=Oe[i],Ve(t,a+256+1,e),s=ke[a],0!==s&&(i-=Be[a],We(t,i,s)),r--,a=Ue(r),Ve(t,a,n),s=Pe[a],0!==s&&(r-=Me[a],We(t,r,s)))}while(o<t.sym_next);Ve(t,256,e)},Qe=(t,e)=>{const n=e.dyn_tree,r=e.stat_desc.static_tree,i=e.stat_desc.has_stree,a=e.stat_desc.elems;let s,o,h,l=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<a;s++)0!==n[2*s]?(t.heap[++t.heap_len]=l=s,t.depth[s]=0):n[2*s+1]=0;for(;t.heap_len<2;)h=t.heap[++t.heap_len]=l<2?++l:0,n[2*h]=1,t.depth[h]=0,t.opt_len--,i&&(t.static_len-=r[2*h+1]);for(e.max_code=l,s=t.heap_len>>1;s>=1;s--)Ke(t,n,s);h=a;do{s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Ke(t,n,1),o=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=o,n[2*h]=n[2*s]+n[2*o],t.depth[h]=(t.depth[s]>=t.depth[o]?t.depth[s]:t.depth[o])+1,n[2*s+1]=n[2*o+1]=h,t.heap[1]=h++,Ke(t,n,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((t,e)=>{const n=e.dyn_tree,r=e.max_code,i=e.stat_desc.static_tree,a=e.stat_desc.has_stree,s=e.stat_desc.extra_bits,o=e.stat_desc.extra_base,h=e.stat_desc.max_length;let l,c,u,f,d,p,g=0;for(f=0;f<=15;f++)t.bl_count[f]=0;for(n[2*t.heap[t.heap_max]+1]=0,l=t.heap_max+1;l<573;l++)c=t.heap[l],f=n[2*n[2*c+1]+1]+1,f>h&&(f=h,g++),n[2*c+1]=f,c>r||(t.bl_count[f]++,d=0,c>=o&&(d=s[c-o]),p=n[2*c],t.opt_len+=p*(f+d),a&&(t.static_len+=p*(i[2*c+1]+d)));if(0!==g){do{for(f=h-1;0===t.bl_count[f];)f--;t.bl_count[f]--,t.bl_count[f+1]+=2,t.bl_count[h]--,g-=2}while(g>0);for(f=h;0!==f;f--)for(c=t.bl_count[f];0!==c;)u=t.heap[--l],u>r||(n[2*u+1]!==f&&(t.opt_len+=(f-n[2*u+1])*n[2*u],n[2*u+1]=f),c--)}})(t,e),Ye(n,l,t.bl_count)},tn=(t,e,n)=>{let r,i,a=-1,s=e[1],o=0,h=7,l=4;for(0===s&&(h=138,l=3),e[2*(n+1)+1]=65535,r=0;r<=n;r++)i=s,s=e[2*(r+1)+1],++o<h&&i===s||(o<l?t.bl_tree[2*i]+=o:0!==i?(i!==a&&t.bl_tree[2*i]++,t.bl_tree[32]++):o<=10?t.bl_tree[34]++:t.bl_tree[36]++,o=0,a=i,0===s?(h=138,l=3):i===s?(h=6,l=3):(h=7,l=4))},en=(t,e,n)=>{let r,i,a=-1,s=e[1],o=0,h=7,l=4;for(0===s&&(h=138,l=3),r=0;r<=n;r++)if(i=s,s=e[2*(r+1)+1],!(++o<h&&i===s)){if(o<l)do{Ve(t,i,t.bl_tree)}while(0!==--o);else 0!==i?(i!==a&&(Ve(t,i,t.bl_tree),o--),Ve(t,16,t.bl_tree),We(t,o-3,2)):o<=10?(Ve(t,17,t.bl_tree),We(t,o-3,3)):(Ve(t,18,t.bl_tree),We(t,o-11,7));o=0,a=i,0===s?(h=138,l=3):i===s?(h=6,l=3):(h=7,l=4)}};let nn=!1;const rn=(t,e,n,r)=>{We(t,0+(r?1:0),3),Je(t),He(t,n),He(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var an={_tr_init:t=>{nn||((()=>{let t,e,n,r,i;const a=new Array(16);for(n=0,r=0;r<28;r++)for(Be[r]=n,t=0;t<1<<ke[r];t++)Oe[n++]=r;for(Oe[n-1]=r,i=0,r=0;r<16;r++)for(Me[r]=i,t=0;t<1<<Pe[r];t++)Ee[i++]=r;for(i>>=7;r<30;r++)for(Me[r]=i<<7,t=0;t<1<<Pe[r]-7;t++)Ee[256+i++]=r;for(e=0;e<=15;e++)a[e]=0;for(t=0;t<=143;)Ce[2*t+1]=8,t++,a[8]++;for(;t<=255;)Ce[2*t+1]=9,t++,a[9]++;for(;t<=279;)Ce[2*t+1]=7,t++,a[7]++;for(;t<=287;)Ce[2*t+1]=8,t++,a[8]++;for(Ye(Ce,287,a),t=0;t<30;t++)je[2*t+1]=5,je[2*t]=Ge(t,5);Te=new Re(Ce,ke,257,286,15),qe=new Re(je,Pe,0,30,15),De=new Re(new Array(0),Fe,0,19,7)})(),nn=!0),t.l_desc=new ze(t.dyn_ltree,Te),t.d_desc=new ze(t.dyn_dtree,qe),t.bl_desc=new ze(t.bl_tree,De),t.bi_buf=0,t.bi_valid=0,Ze(t)},_tr_stored_block:rn,_tr_flush_block:(t,e,n,r)=>{let i,a,s=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(t=>{let e,n=4093624447;for(e=0;e<=31;e++,n>>>=1)if(1&n&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<256;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0})(t)),Qe(t,t.l_desc),Qe(t,t.d_desc),s=(t=>{let e;for(tn(t,t.dyn_ltree,t.l_desc.max_code),tn(t,t.dyn_dtree,t.d_desc.max_code),Qe(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*Ie[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e})(t),i=t.opt_len+3+7>>>3,a=t.static_len+3+7>>>3,a<=i&&(i=a)):i=a=n+5,n+4<=i&&-1!==e?rn(t,e,n,r):4===t.strategy||a===i?(We(t,2+(r?1:0),3),$e(t,Ce,je)):(We(t,4+(r?1:0),3),((t,e,n,r)=>{let i;for(We(t,e-257,5),We(t,n-1,5),We(t,r-4,4),i=0;i<r;i++)We(t,t.bl_tree[2*Ie[i]+1],3);en(t,t.dyn_ltree,e-1),en(t,t.dyn_dtree,n-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,s+1),$e(t,t.dyn_ltree,t.dyn_dtree)),Ze(t),r&&Je(t)},_tr_tally:(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,0===e?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(Oe[n]+256+1)]++,t.dyn_dtree[2*Ue(e)]++),t.sym_next===t.sym_end),_tr_align:t=>{We(t,2,3),Ve(t,256,Ce),(t=>{16===t.bi_valid?(He(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(t)}},sn=(t,e,n,r)=>{let i=65535&t,a=t>>>16&65535,s=0;for(;0!==n;){s=n>2e3?2e3:n,n-=s;do{i=i+e[r++]|0,a=a+i|0}while(--s);i%=65521,a%=65521}return i|a<<16};const on=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var hn=(t,e,n,r)=>{const i=on,a=r+n;t^=-1;for(let s=r;s<a;s++)t=t>>>8^i[255&(t^e[s])];return-1^t},ln={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},cn={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:un,_tr_stored_block:fn,_tr_flush_block:dn,_tr_tally:pn,_tr_align:gn}=an,{Z_NO_FLUSH:mn,Z_PARTIAL_FLUSH:bn,Z_FULL_FLUSH:vn,Z_FINISH:wn,Z_BLOCK:yn,Z_OK:_n,Z_STREAM_END:xn,Z_STREAM_ERROR:An,Z_DATA_ERROR:Ln,Z_BUF_ERROR:Nn,Z_DEFAULT_COMPRESSION:Sn,Z_FILTERED:kn,Z_HUFFMAN_ONLY:Pn,Z_RLE:Fn,Z_FIXED:In,Z_DEFAULT_STRATEGY:Cn,Z_UNKNOWN:jn,Z_DEFLATED:En}=cn,On=258,Bn=262,Mn=42,Rn=113,Tn=666,qn=(t,e)=>(t.msg=ln[e],e),Dn=t=>2*t-(t>4?9:0),zn=t=>{let e=t.length;for(;--e>=0;)t[e]=0},Un=t=>{let e,n,r,i=t.w_size;e=t.hash_size,r=e;do{n=t.head[--r],t.head[r]=n>=i?n-i:0}while(--e);e=i,r=e;do{n=t.prev[--r],t.prev[r]=n>=i?n-i:0}while(--e)};let Hn=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const Wn=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),0!==n&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,0===e.pending&&(e.pending_out=0))},Vn=(t,e)=>{dn(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Wn(t.strm)},Gn=(t,e)=>{t.pending_buf[t.pending++]=e},Yn=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},Zn=(t,e,n,r)=>{let i=t.avail_in;return i>r&&(i=r),0===i?0:(t.avail_in-=i,e.set(t.input.subarray(t.next_in,t.next_in+i),n),1===t.state.wrap?t.adler=sn(t.adler,e,i,n):2===t.state.wrap&&(t.adler=hn(t.adler,e,i,n)),t.next_in+=i,t.total_in+=i,i)},Jn=(t,e)=>{let n,r,i=t.max_chain_length,a=t.strstart,s=t.prev_length,o=t.nice_match;const h=t.strstart>t.w_size-Bn?t.strstart-(t.w_size-Bn):0,l=t.window,c=t.w_mask,u=t.prev,f=t.strstart+On;let d=l[a+s-1],p=l[a+s];t.prev_length>=t.good_match&&(i>>=2),o>t.lookahead&&(o=t.lookahead);do{if(n=e,l[n+s]===p&&l[n+s-1]===d&&l[n]===l[a]&&l[++n]===l[a+1]){a+=2,n++;do{}while(l[++a]===l[++n]&&l[++a]===l[++n]&&l[++a]===l[++n]&&l[++a]===l[++n]&&l[++a]===l[++n]&&l[++a]===l[++n]&&l[++a]===l[++n]&&l[++a]===l[++n]&&a<f);if(r=On-(f-a),a=f-On,r>s){if(t.match_start=e,s=r,r>=o)break;d=l[a+s-1],p=l[a+s]}}}while((e=u[e&c])>h&&0!==--i);return s<=t.lookahead?s:t.lookahead},Xn=t=>{const e=t.w_size;let n,r,i;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-Bn)&&(t.window.set(t.window.subarray(e,e+e-r),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),Un(t),r+=e),0===t.strm.avail_in)break;if(n=Zn(t.strm,t.window,t.strstart+t.lookahead,r),t.lookahead+=n,t.lookahead+t.insert>=3)for(i=t.strstart-t.insert,t.ins_h=t.window[i],t.ins_h=Hn(t,t.ins_h,t.window[i+1]);t.insert&&(t.ins_h=Hn(t,t.ins_h,t.window[i+3-1]),t.prev[i&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=i,i++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<Bn&&0!==t.strm.avail_in)},Kn=(t,e)=>{let n,r,i,a=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,s=0,o=t.strm.avail_in;do{if(n=65535,i=t.bi_valid+42>>3,t.strm.avail_out<i)break;if(i=t.strm.avail_out-i,r=t.strstart-t.block_start,n>r+t.strm.avail_in&&(n=r+t.strm.avail_in),n>i&&(n=i),n<a&&(0===n&&e!==wn||e===mn||n!==r+t.strm.avail_in))break;s=e===wn&&n===r+t.strm.avail_in?1:0,fn(t,0,0,s),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,Wn(t.strm),r&&(r>n&&(r=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+r),t.strm.next_out),t.strm.next_out+=r,t.strm.avail_out-=r,t.strm.total_out+=r,t.block_start+=r,n-=r),n&&(Zn(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(0===s);return o-=t.strm.avail_in,o&&(o>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=o&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-o,t.strm.next_in),t.strstart),t.strstart+=o,t.insert+=o>t.w_size-t.insert?t.w_size-t.insert:o),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),s?4:e!==mn&&e!==wn&&0===t.strm.avail_in&&t.strstart===t.block_start?2:(i=t.window_size-t.strstart,t.strm.avail_in>i&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,i+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),i>t.strm.avail_in&&(i=t.strm.avail_in),i&&(Zn(t.strm,t.window,t.strstart,i),t.strstart+=i,t.insert+=i>t.w_size-t.insert?t.w_size-t.insert:i),t.high_water<t.strstart&&(t.high_water=t.strstart),i=t.bi_valid+42>>3,i=t.pending_buf_size-i>65535?65535:t.pending_buf_size-i,a=i>t.w_size?t.w_size:i,r=t.strstart-t.block_start,(r>=a||(r||e===wn)&&e!==mn&&0===t.strm.avail_in&&r<=i)&&(n=r>i?i:r,s=e===wn&&0===t.strm.avail_in&&n===r?1:0,fn(t,t.block_start,n,s),t.block_start+=n,Wn(t.strm)),s?3:1)},$n=(t,e)=>{let n,r;for(;;){if(t.lookahead<Bn){if(Xn(t),t.lookahead<Bn&&e===mn)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=Hn(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==n&&t.strstart-n<=t.w_size-Bn&&(t.match_length=Jn(t,n)),t.match_length>=3)if(r=pn(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=Hn(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!==--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=Hn(t,t.ins_h,t.window[t.strstart+1]);else r=pn(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(r&&(Vn(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===wn?(Vn(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Vn(t,!1),0===t.strm.avail_out)?1:2},Qn=(t,e)=>{let n,r,i;for(;;){if(t.lookahead<Bn){if(Xn(t),t.lookahead<Bn&&e===mn)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=Hn(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==n&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-Bn&&(t.match_length=Jn(t,n),t.match_length<=5&&(t.strategy===kn||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){i=t.strstart+t.lookahead-3,r=pn(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=i&&(t.ins_h=Hn(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!==--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,r&&(Vn(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(r=pn(t,0,t.window[t.strstart-1]),r&&Vn(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(r=pn(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===wn?(Vn(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Vn(t,!1),0===t.strm.avail_out)?1:2};function tr(t,e,n,r,i){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=r,this.func=i}const er=[new tr(0,0,0,0,Kn),new tr(4,4,8,4,$n),new tr(4,5,16,8,$n),new tr(4,6,32,32,$n),new tr(4,4,16,16,Qn),new tr(8,16,32,32,Qn),new tr(8,16,128,128,Qn),new tr(8,32,128,256,Qn),new tr(32,128,258,1024,Qn),new tr(32,258,258,4096,Qn)];function nr(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=En,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),zn(this.dyn_ltree),zn(this.dyn_dtree),zn(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),zn(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),zn(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const rr=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==Mn&&57!==e.status&&69!==e.status&&73!==e.status&&91!==e.status&&103!==e.status&&e.status!==Rn&&e.status!==Tn?1:0},ir=t=>{if(rr(t))return qn(t,An);t.total_in=t.total_out=0,t.data_type=jn;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=2===e.wrap?57:e.wrap?Mn:Rn,t.adler=2===e.wrap?0:1,e.last_flush=-2,un(e),_n},ar=t=>{const e=ir(t);return e===_n&&((n=t.state).window_size=2*n.w_size,zn(n.head),n.max_lazy_match=er[n.level].max_lazy,n.good_match=er[n.level].good_length,n.nice_match=er[n.level].nice_length,n.max_chain_length=er[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0),e;var n},sr=(t,e,n,r,i,a)=>{if(!t)return An;let s=1;if(e===Sn&&(e=6),r<0?(s=0,r=-r):r>15&&(s=2,r-=16),i<1||i>9||n!==En||r<8||r>15||e<0||e>9||a<0||a>In||8===r&&1!==s)return qn(t,An);8===r&&(r=9);const o=new nr;return t.state=o,o.strm=t,o.status=Mn,o.wrap=s,o.gzhead=null,o.w_bits=r,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=i+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+3-1)/3),o.window=new Uint8Array(2*o.w_size),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<i+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new Uint8Array(o.pending_buf_size),o.sym_buf=o.lit_bufsize,o.sym_end=3*(o.lit_bufsize-1),o.level=e,o.strategy=a,o.method=n,ar(t)};var or=sr,hr=(t,e)=>rr(t)||2!==t.state.wrap?An:(t.state.gzhead=e,_n),lr=(t,e)=>{if(rr(t)||e>yn||e<0)return t?qn(t,An):An;const n=t.state;if(!t.output||0!==t.avail_in&&!t.input||n.status===Tn&&e!==wn)return qn(t,0===t.avail_out?Nn:An);const r=n.last_flush;if(n.last_flush=e,0!==n.pending){if(Wn(t),0===t.avail_out)return n.last_flush=-1,_n}else if(0===t.avail_in&&Dn(e)<=Dn(r)&&e!==wn)return qn(t,Nn);if(n.status===Tn&&0!==t.avail_in)return qn(t,Nn);if(n.status===Mn&&0===n.wrap&&(n.status=Rn),n.status===Mn){let e=En+(n.w_bits-8<<4)<<8,r=-1;if(r=n.strategy>=Pn||n.level<2?0:n.level<6?1:6===n.level?2:3,e|=r<<6,0!==n.strstart&&(e|=32),e+=31-e%31,Yn(n,e),0!==n.strstart&&(Yn(n,t.adler>>>16),Yn(n,65535&t.adler)),t.adler=1,n.status=Rn,Wn(t),0!==n.pending)return n.last_flush=-1,_n}if(57===n.status)if(t.adler=0,Gn(n,31),Gn(n,139),Gn(n,8),n.gzhead)Gn(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Gn(n,255&n.gzhead.time),Gn(n,n.gzhead.time>>8&255),Gn(n,n.gzhead.time>>16&255),Gn(n,n.gzhead.time>>24&255),Gn(n,9===n.level?2:n.strategy>=Pn||n.level<2?4:0),Gn(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Gn(n,255&n.gzhead.extra.length),Gn(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=hn(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Gn(n,0),Gn(n,0),Gn(n,0),Gn(n,0),Gn(n,0),Gn(n,9===n.level?2:n.strategy>=Pn||n.level<2?4:0),Gn(n,3),n.status=Rn,Wn(t),0!==n.pending)return n.last_flush=-1,_n;if(69===n.status){if(n.gzhead.extra){let e=n.pending,r=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+r>n.pending_buf_size;){let i=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+i),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>e&&(t.adler=hn(t.adler,n.pending_buf,n.pending-e,e)),n.gzindex+=i,Wn(t),0!==n.pending)return n.last_flush=-1,_n;e=0,r-=i}let i=new Uint8Array(n.gzhead.extra);n.pending_buf.set(i.subarray(n.gzindex,n.gzindex+r),n.pending),n.pending+=r,n.gzhead.hcrc&&n.pending>e&&(t.adler=hn(t.adler,n.pending_buf,n.pending-e,e)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let e,r=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>r&&(t.adler=hn(t.adler,n.pending_buf,n.pending-r,r)),Wn(t),0!==n.pending)return n.last_flush=-1,_n;r=0}e=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Gn(n,e)}while(0!==e);n.gzhead.hcrc&&n.pending>r&&(t.adler=hn(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let e,r=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>r&&(t.adler=hn(t.adler,n.pending_buf,n.pending-r,r)),Wn(t),0!==n.pending)return n.last_flush=-1,_n;r=0}e=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Gn(n,e)}while(0!==e);n.gzhead.hcrc&&n.pending>r&&(t.adler=hn(t.adler,n.pending_buf,n.pending-r,r))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Wn(t),0!==n.pending))return n.last_flush=-1,_n;Gn(n,255&t.adler),Gn(n,t.adler>>8&255),t.adler=0}if(n.status=Rn,Wn(t),0!==n.pending)return n.last_flush=-1,_n}if(0!==t.avail_in||0!==n.lookahead||e!==mn&&n.status!==Tn){let r=0===n.level?Kn(n,e):n.strategy===Pn?((t,e)=>{let n;for(;;){if(0===t.lookahead&&(Xn(t),0===t.lookahead)){if(e===mn)return 1;break}if(t.match_length=0,n=pn(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,n&&(Vn(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===wn?(Vn(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Vn(t,!1),0===t.strm.avail_out)?1:2})(n,e):n.strategy===Fn?((t,e)=>{let n,r,i,a;const s=t.window;for(;;){if(t.lookahead<=On){if(Xn(t),t.lookahead<=On&&e===mn)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(i=t.strstart-1,r=s[i],r===s[++i]&&r===s[++i]&&r===s[++i])){a=t.strstart+On;do{}while(r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&r===s[++i]&&i<a);t.match_length=On-(a-i),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(n=pn(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(n=pn(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),n&&(Vn(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===wn?(Vn(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(Vn(t,!1),0===t.strm.avail_out)?1:2})(n,e):er[n.level].func(n,e);if(3!==r&&4!==r||(n.status=Tn),1===r||3===r)return 0===t.avail_out&&(n.last_flush=-1),_n;if(2===r&&(e===bn?gn(n):e!==yn&&(fn(n,0,0,!1),e===vn&&(zn(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),Wn(t),0===t.avail_out))return n.last_flush=-1,_n}return e!==wn?_n:n.wrap<=0?xn:(2===n.wrap?(Gn(n,255&t.adler),Gn(n,t.adler>>8&255),Gn(n,t.adler>>16&255),Gn(n,t.adler>>24&255),Gn(n,255&t.total_in),Gn(n,t.total_in>>8&255),Gn(n,t.total_in>>16&255),Gn(n,t.total_in>>24&255)):(Yn(n,t.adler>>>16),Yn(n,65535&t.adler)),Wn(t),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?_n:xn)},cr=t=>{if(rr(t))return An;const e=t.state.status;return t.state=null,e===Rn?qn(t,Ln):_n},ur=(t,e)=>{let n=e.length;if(rr(t))return An;const r=t.state,i=r.wrap;if(2===i||1===i&&r.status!==Mn||r.lookahead)return An;if(1===i&&(t.adler=sn(t.adler,e,n,0)),r.wrap=0,n>=r.w_size){0===i&&(zn(r.head),r.strstart=0,r.block_start=0,r.insert=0);let t=new Uint8Array(r.w_size);t.set(e.subarray(n-r.w_size,n),0),e=t,n=r.w_size}const a=t.avail_in,s=t.next_in,o=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Xn(r);r.lookahead>=3;){let t=r.strstart,e=r.lookahead-2;do{r.ins_h=Hn(r,r.ins_h,r.window[t+3-1]),r.prev[t&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=t,t++}while(--e);r.strstart=t,r.lookahead=2,Xn(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,t.next_in=s,t.input=o,t.avail_in=a,r.wrap=i,_n};const fr=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var dr=function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const e in n)fr(n,e)&&(t[e]=n[e])}}return t},pr=t=>{let e=0;for(let r=0,i=t.length;r<i;r++)e+=t[r].length;const n=new Uint8Array(e);for(let r=0,i=0,a=t.length;r<a;r++){let e=t[r];n.set(e,i),i+=e.length}return n};let gr=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(ns){gr=!1}const mr=new Uint8Array(256);for(let rs=0;rs<256;rs++)mr[rs]=rs>=252?6:rs>=248?5:rs>=240?4:rs>=224?3:rs>=192?2:1;mr[254]=mr[254]=1;var br=t=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(t);let e,n,r,i,a,s=t.length,o=0;for(i=0;i<s;i++)n=t.charCodeAt(i),55296==(64512&n)&&i+1<s&&(r=t.charCodeAt(i+1),56320==(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),o+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(o),a=0,i=0;a<o;i++)n=t.charCodeAt(i),55296==(64512&n)&&i+1<s&&(r=t.charCodeAt(i+1),56320==(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),n<128?e[a++]=n:n<2048?(e[a++]=192|n>>>6,e[a++]=128|63&n):n<65536?(e[a++]=224|n>>>12,e[a++]=128|n>>>6&63,e[a++]=128|63&n):(e[a++]=240|n>>>18,e[a++]=128|n>>>12&63,e[a++]=128|n>>>6&63,e[a++]=128|63&n);return e},vr=(t,e)=>{const n=e||t.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(t.subarray(0,e));let r,i;const a=new Array(2*n);for(i=0,r=0;r<n;){let e=t[r++];if(e<128){a[i++]=e;continue}let s=mr[e];if(s>4)a[i++]=65533,r+=s-1;else{for(e&=2===s?31:3===s?15:7;s>1&&r<n;)e=e<<6|63&t[r++],s--;s>1?a[i++]=65533:e<65536?a[i++]=e:(e-=65536,a[i++]=55296|e>>10&1023,a[i++]=56320|1023&e)}}return((t,e)=>{if(e<65534&&t.subarray&&gr)return String.fromCharCode.apply(null,t.length===e?t:t.subarray(0,e));let n="";for(let r=0;r<e;r++)n+=String.fromCharCode(t[r]);return n})(a,i)},wr=(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&128==(192&t[n]);)n--;return n<0||0===n?e:n+mr[t[n]]>e?n:e},yr=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const _r=Object.prototype.toString,{Z_NO_FLUSH:xr,Z_SYNC_FLUSH:Ar,Z_FULL_FLUSH:Lr,Z_FINISH:Nr,Z_OK:Sr,Z_STREAM_END:kr,Z_DEFAULT_COMPRESSION:Pr,Z_DEFAULT_STRATEGY:Fr,Z_DEFLATED:Ir}=cn;function Cr(t){this.options=dr({level:Pr,method:Ir,chunkSize:16384,windowBits:15,memLevel:8,strategy:Fr},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new yr,this.strm.avail_out=0;let n=or(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==Sr)throw new Error(ln[n]);if(e.header&&hr(this.strm,e.header),e.dictionary){let t;if(t="string"==typeof e.dictionary?br(e.dictionary):"[object ArrayBuffer]"===_r.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,n=ur(this.strm,t),n!==Sr)throw new Error(ln[n]);this._dict_set=!0}}Cr.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize;let i,a;if(this.ended)return!1;for(a=e===~~e?e:!0===e?Nr:xr,"string"==typeof t?n.input=br(t):"[object ArrayBuffer]"===_r.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),(a===Ar||a===Lr)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(i=lr(n,a),i===kr)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=cr(this.strm),this.onEnd(i),this.ended=!0,i===Sr;if(0!==n.avail_out){if(a>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},Cr.prototype.onData=function(t){this.chunks.push(t)},Cr.prototype.onEnd=function(t){t===Sr&&(this.result=pr(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};const jr=16209;var Er=function(t,e){let n,r,i,a,s,o,h,l,c,u,f,d,p,g,m,b,v,w,y,_,x,A,L,N;const S=t.state;n=t.next_in,L=t.input,r=n+(t.avail_in-5),i=t.next_out,N=t.output,a=i-(e-t.avail_out),s=i+(t.avail_out-257),o=S.dmax,h=S.wsize,l=S.whave,c=S.wnext,u=S.window,f=S.hold,d=S.bits,p=S.lencode,g=S.distcode,m=(1<<S.lenbits)-1,b=(1<<S.distbits)-1;t:do{d<15&&(f+=L[n++]<<d,d+=8,f+=L[n++]<<d,d+=8),v=p[f&m];e:for(;;){if(w=v>>>24,f>>>=w,d-=w,w=v>>>16&255,0===w)N[i++]=65535&v;else{if(!(16&w)){if(64&w){if(32&w){S.mode=16191;break t}t.msg="invalid literal/length code",S.mode=jr;break t}v=p[(65535&v)+(f&(1<<w)-1)];continue e}for(y=65535&v,w&=15,w&&(d<w&&(f+=L[n++]<<d,d+=8),y+=f&(1<<w)-1,f>>>=w,d-=w),d<15&&(f+=L[n++]<<d,d+=8,f+=L[n++]<<d,d+=8),v=g[f&b];;){if(w=v>>>24,f>>>=w,d-=w,w=v>>>16&255,16&w){if(_=65535&v,w&=15,d<w&&(f+=L[n++]<<d,d+=8,d<w&&(f+=L[n++]<<d,d+=8)),_+=f&(1<<w)-1,_>o){t.msg="invalid distance too far back",S.mode=jr;break t}if(f>>>=w,d-=w,w=i-a,_>w){if(w=_-w,w>l&&S.sane){t.msg="invalid distance too far back",S.mode=jr;break t}if(x=0,A=u,0===c){if(x+=h-w,w<y){y-=w;do{N[i++]=u[x++]}while(--w);x=i-_,A=N}}else if(c<w){if(x+=h+c-w,w-=c,w<y){y-=w;do{N[i++]=u[x++]}while(--w);if(x=0,c<y){w=c,y-=w;do{N[i++]=u[x++]}while(--w);x=i-_,A=N}}}else if(x+=c-w,w<y){y-=w;do{N[i++]=u[x++]}while(--w);x=i-_,A=N}for(;y>2;)N[i++]=A[x++],N[i++]=A[x++],N[i++]=A[x++],y-=3;y&&(N[i++]=A[x++],y>1&&(N[i++]=A[x++]))}else{x=i-_;do{N[i++]=N[x++],N[i++]=N[x++],N[i++]=N[x++],y-=3}while(y>2);y&&(N[i++]=N[x++],y>1&&(N[i++]=N[x++]))}break}if(64&w){t.msg="invalid distance code",S.mode=jr;break t}v=g[(65535&v)+(f&(1<<w)-1)]}}break}}while(n<r&&i<s);y=d>>3,n-=y,d-=y<<3,f&=(1<<d)-1,t.next_in=n,t.next_out=i,t.avail_in=n<r?r-n+5:5-(n-r),t.avail_out=i<s?s-i+257:257-(i-s),S.hold=f,S.bits=d};const Or=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Br=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Mr=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Rr=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Tr=(t,e,n,r,i,a,s,o)=>{const h=o.bits;let l,c,u,f,d,p,g=0,m=0,b=0,v=0,w=0,y=0,_=0,x=0,A=0,L=0,N=null;const S=new Uint16Array(16),k=new Uint16Array(16);let P,F,I,C=null;for(g=0;g<=15;g++)S[g]=0;for(m=0;m<r;m++)S[e[n+m]]++;for(w=h,v=15;v>=1&&0===S[v];v--);if(w>v&&(w=v),0===v)return i[a++]=20971520,i[a++]=20971520,o.bits=1,0;for(b=1;b<v&&0===S[b];b++);for(w<b&&(w=b),x=1,g=1;g<=15;g++)if(x<<=1,x-=S[g],x<0)return-1;if(x>0&&(0===t||1!==v))return-1;for(k[1]=0,g=1;g<15;g++)k[g+1]=k[g]+S[g];for(m=0;m<r;m++)0!==e[n+m]&&(s[k[e[n+m]]++]=m);if(0===t?(N=C=s,p=20):1===t?(N=Or,C=Br,p=257):(N=Mr,C=Rr,p=0),L=0,m=0,g=b,d=a,y=w,_=0,u=-1,A=1<<w,f=A-1,1===t&&A>852||2===t&&A>592)return 1;for(;;){P=g-_,s[m]+1<p?(F=0,I=s[m]):s[m]>=p?(F=C[s[m]-p],I=N[s[m]-p]):(F=96,I=0),l=1<<g-_,c=1<<y,b=c;do{c-=l,i[d+(L>>_)+c]=P<<24|F<<16|I}while(0!==c);for(l=1<<g-1;L&l;)l>>=1;if(0!==l?(L&=l-1,L+=l):L=0,m++,0===--S[g]){if(g===v)break;g=e[n+s[m]]}if(g>w&&(L&f)!==u){for(0===_&&(_=w),d+=b,y=g-_,x=1<<y;y+_<v&&(x-=S[y+_],!(x<=0));)y++,x<<=1;if(A+=1<<y,1===t&&A>852||2===t&&A>592)return 1;u=L&f,i[u]=w<<24|y<<16|d-a}}return 0!==L&&(i[d+L]=g-_<<24|64<<16),o.bits=w,0};const{Z_FINISH:qr,Z_BLOCK:Dr,Z_TREES:zr,Z_OK:Ur,Z_STREAM_END:Hr,Z_NEED_DICT:Wr,Z_STREAM_ERROR:Vr,Z_DATA_ERROR:Gr,Z_MEM_ERROR:Yr,Z_BUF_ERROR:Zr,Z_DEFLATED:Jr}=cn,Xr=16180,Kr=16190,$r=16191,Qr=16192,ti=16194,ei=16199,ni=16200,ri=16206,ii=16209,ai=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function si(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const oi=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<Xr||e.mode>16211?1:0},hi=t=>{if(oi(t))return Vr;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=Xr,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Ur},li=t=>{if(oi(t))return Vr;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,hi(t)},ci=(t,e)=>{let n;if(oi(t))return Vr;const r=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Vr:(null!==r.window&&r.wbits!==e&&(r.window=null),r.wrap=n,r.wbits=e,li(t))},ui=(t,e)=>{if(!t)return Vr;const n=new si;t.state=n,n.strm=t,n.window=null,n.mode=Xr;const r=ci(t,e);return r!==Ur&&(t.state=null),r};let fi,di,pi=!0;const gi=t=>{if(pi){fi=new Int32Array(512),di=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(Tr(1,t.lens,0,288,fi,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;Tr(2,t.lens,0,32,di,0,t.work,{bits:5}),pi=!1}t.lencode=fi,t.lenbits=9,t.distcode=di,t.distbits=5},mi=(t,e,n,r)=>{let i;const a=t.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new Uint8Array(a.wsize)),r>=a.wsize?(a.window.set(e.subarray(n-a.wsize,n),0),a.wnext=0,a.whave=a.wsize):(i=a.wsize-a.wnext,i>r&&(i=r),a.window.set(e.subarray(n-r,n-r+i),a.wnext),(r-=i)?(a.window.set(e.subarray(n-r,n),0),a.wnext=r,a.whave=a.wsize):(a.wnext+=i,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=i))),0};var bi=li,vi=ui,wi=(t,e)=>{let n,r,i,a,s,o,h,l,c,u,f,d,p,g,m,b,v,w,y,_,x,A,L=0;const N=new Uint8Array(4);let S,k;const P=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(oi(t)||!t.output||!t.input&&0!==t.avail_in)return Vr;n=t.state,n.mode===$r&&(n.mode=Qr),s=t.next_out,i=t.output,h=t.avail_out,a=t.next_in,r=t.input,o=t.avail_in,l=n.hold,c=n.bits,u=o,f=h,A=Ur;t:for(;;)switch(n.mode){case Xr:if(0===n.wrap){n.mode=Qr;break}for(;c<16;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(2&n.wrap&&35615===l){0===n.wbits&&(n.wbits=15),n.check=0,N[0]=255&l,N[1]=l>>>8&255,n.check=hn(n.check,N,2,0),l=0,c=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&l)<<8)+(l>>8))%31){t.msg="incorrect header check",n.mode=ii;break}if((15&l)!==Jr){t.msg="unknown compression method",n.mode=ii;break}if(l>>>=4,c-=4,x=8+(15&l),0===n.wbits&&(n.wbits=x),x>15||x>n.wbits){t.msg="invalid window size",n.mode=ii;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&l?16189:$r,l=0,c=0;break;case 16181:for(;c<16;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(n.flags=l,(255&n.flags)!==Jr){t.msg="unknown compression method",n.mode=ii;break}if(57344&n.flags){t.msg="unknown header flags set",n.mode=ii;break}n.head&&(n.head.text=l>>8&1),512&n.flags&&4&n.wrap&&(N[0]=255&l,N[1]=l>>>8&255,n.check=hn(n.check,N,2,0)),l=0,c=0,n.mode=16182;case 16182:for(;c<32;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}n.head&&(n.head.time=l),512&n.flags&&4&n.wrap&&(N[0]=255&l,N[1]=l>>>8&255,N[2]=l>>>16&255,N[3]=l>>>24&255,n.check=hn(n.check,N,4,0)),l=0,c=0,n.mode=16183;case 16183:for(;c<16;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}n.head&&(n.head.xflags=255&l,n.head.os=l>>8),512&n.flags&&4&n.wrap&&(N[0]=255&l,N[1]=l>>>8&255,n.check=hn(n.check,N,2,0)),l=0,c=0,n.mode=16184;case 16184:if(1024&n.flags){for(;c<16;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}n.length=l,n.head&&(n.head.extra_len=l),512&n.flags&&4&n.wrap&&(N[0]=255&l,N[1]=l>>>8&255,n.check=hn(n.check,N,2,0)),l=0,c=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&n.flags&&(d=n.length,d>o&&(d=o),d&&(n.head&&(x=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(r.subarray(a,a+d),x)),512&n.flags&&4&n.wrap&&(n.check=hn(n.check,r,d,a)),o-=d,a+=d,n.length-=d),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&n.flags){if(0===o)break t;d=0;do{x=r[a+d++],n.head&&x&&n.length<65536&&(n.head.name+=String.fromCharCode(x))}while(x&&d<o);if(512&n.flags&&4&n.wrap&&(n.check=hn(n.check,r,d,a)),o-=d,a+=d,x)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&n.flags){if(0===o)break t;d=0;do{x=r[a+d++],n.head&&x&&n.length<65536&&(n.head.comment+=String.fromCharCode(x))}while(x&&d<o);if(512&n.flags&&4&n.wrap&&(n.check=hn(n.check,r,d,a)),o-=d,a+=d,x)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&n.flags){for(;c<16;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(4&n.wrap&&l!==(65535&n.check)){t.msg="header crc mismatch",n.mode=ii;break}l=0,c=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=$r;break;case 16189:for(;c<32;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}t.adler=n.check=ai(l),l=0,c=0,n.mode=Kr;case Kr:if(0===n.havedict)return t.next_out=s,t.avail_out=h,t.next_in=a,t.avail_in=o,n.hold=l,n.bits=c,Wr;t.adler=n.check=1,n.mode=$r;case $r:if(e===Dr||e===zr)break t;case Qr:if(n.last){l>>>=7&c,c-=7&c,n.mode=ri;break}for(;c<3;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}switch(n.last=1&l,l>>>=1,c-=1,3&l){case 0:n.mode=16193;break;case 1:if(gi(n),n.mode=ei,e===zr){l>>>=2,c-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=ii}l>>>=2,c-=2;break;case 16193:for(l>>>=7&c,c-=7&c;c<32;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if((65535&l)!=(l>>>16^65535)){t.msg="invalid stored block lengths",n.mode=ii;break}if(n.length=65535&l,l=0,c=0,n.mode=ti,e===zr)break t;case ti:n.mode=16195;case 16195:if(d=n.length,d){if(d>o&&(d=o),d>h&&(d=h),0===d)break t;i.set(r.subarray(a,a+d),s),o-=d,a+=d,h-=d,s+=d,n.length-=d;break}n.mode=$r;break;case 16196:for(;c<14;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(n.nlen=257+(31&l),l>>>=5,c-=5,n.ndist=1+(31&l),l>>>=5,c-=5,n.ncode=4+(15&l),l>>>=4,c-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=ii;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;c<3;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}n.lens[P[n.have++]]=7&l,l>>>=3,c-=3}for(;n.have<19;)n.lens[P[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,S={bits:n.lenbits},A=Tr(0,n.lens,0,19,n.lencode,0,n.work,S),n.lenbits=S.bits,A){t.msg="invalid code lengths set",n.mode=ii;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;L=n.lencode[l&(1<<n.lenbits)-1],m=L>>>24,b=L>>>16&255,v=65535&L,!(m<=c);){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(v<16)l>>>=m,c-=m,n.lens[n.have++]=v;else{if(16===v){for(k=m+2;c<k;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(l>>>=m,c-=m,0===n.have){t.msg="invalid bit length repeat",n.mode=ii;break}x=n.lens[n.have-1],d=3+(3&l),l>>>=2,c-=2}else if(17===v){for(k=m+3;c<k;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}l>>>=m,c-=m,x=0,d=3+(7&l),l>>>=3,c-=3}else{for(k=m+7;c<k;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}l>>>=m,c-=m,x=0,d=11+(127&l),l>>>=7,c-=7}if(n.have+d>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=ii;break}for(;d--;)n.lens[n.have++]=x}}if(n.mode===ii)break;if(0===n.lens[256]){t.msg="invalid code -- missing end-of-block",n.mode=ii;break}if(n.lenbits=9,S={bits:n.lenbits},A=Tr(1,n.lens,0,n.nlen,n.lencode,0,n.work,S),n.lenbits=S.bits,A){t.msg="invalid literal/lengths set",n.mode=ii;break}if(n.distbits=6,n.distcode=n.distdyn,S={bits:n.distbits},A=Tr(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,S),n.distbits=S.bits,A){t.msg="invalid distances set",n.mode=ii;break}if(n.mode=ei,e===zr)break t;case ei:n.mode=ni;case ni:if(o>=6&&h>=258){t.next_out=s,t.avail_out=h,t.next_in=a,t.avail_in=o,n.hold=l,n.bits=c,Er(t,f),s=t.next_out,i=t.output,h=t.avail_out,a=t.next_in,r=t.input,o=t.avail_in,l=n.hold,c=n.bits,n.mode===$r&&(n.back=-1);break}for(n.back=0;L=n.lencode[l&(1<<n.lenbits)-1],m=L>>>24,b=L>>>16&255,v=65535&L,!(m<=c);){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(b&&!(240&b)){for(w=m,y=b,_=v;L=n.lencode[_+((l&(1<<w+y)-1)>>w)],m=L>>>24,b=L>>>16&255,v=65535&L,!(w+m<=c);){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}l>>>=w,c-=w,n.back+=w}if(l>>>=m,c-=m,n.back+=m,n.length=v,0===b){n.mode=16205;break}if(32&b){n.back=-1,n.mode=$r;break}if(64&b){t.msg="invalid literal/length code",n.mode=ii;break}n.extra=15&b,n.mode=16201;case 16201:if(n.extra){for(k=n.extra;c<k;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}n.length+=l&(1<<n.extra)-1,l>>>=n.extra,c-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;L=n.distcode[l&(1<<n.distbits)-1],m=L>>>24,b=L>>>16&255,v=65535&L,!(m<=c);){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(!(240&b)){for(w=m,y=b,_=v;L=n.distcode[_+((l&(1<<w+y)-1)>>w)],m=L>>>24,b=L>>>16&255,v=65535&L,!(w+m<=c);){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}l>>>=w,c-=w,n.back+=w}if(l>>>=m,c-=m,n.back+=m,64&b){t.msg="invalid distance code",n.mode=ii;break}n.offset=v,n.extra=15&b,n.mode=16203;case 16203:if(n.extra){for(k=n.extra;c<k;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}n.offset+=l&(1<<n.extra)-1,l>>>=n.extra,c-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=ii;break}n.mode=16204;case 16204:if(0===h)break t;if(d=f-h,n.offset>d){if(d=n.offset-d,d>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=ii;break}d>n.wnext?(d-=n.wnext,p=n.wsize-d):p=n.wnext-d,d>n.length&&(d=n.length),g=n.window}else g=i,p=s-n.offset,d=n.length;d>h&&(d=h),h-=d,n.length-=d;do{i[s++]=g[p++]}while(--d);0===n.length&&(n.mode=ni);break;case 16205:if(0===h)break t;i[s++]=n.length,h--,n.mode=ni;break;case ri:if(n.wrap){for(;c<32;){if(0===o)break t;o--,l|=r[a++]<<c,c+=8}if(f-=h,t.total_out+=f,n.total+=f,4&n.wrap&&f&&(t.adler=n.check=n.flags?hn(n.check,i,f,s-f):sn(n.check,i,f,s-f)),f=h,4&n.wrap&&(n.flags?l:ai(l))!==n.check){t.msg="incorrect data check",n.mode=ii;break}l=0,c=0}n.mode=16207;case 16207:if(n.wrap&&n.flags){for(;c<32;){if(0===o)break t;o--,l+=r[a++]<<c,c+=8}if(4&n.wrap&&l!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=ii;break}l=0,c=0}n.mode=16208;case 16208:A=Hr;break t;case ii:A=Gr;break t;case 16210:return Yr;default:return Vr}return t.next_out=s,t.avail_out=h,t.next_in=a,t.avail_in=o,n.hold=l,n.bits=c,(n.wsize||f!==t.avail_out&&n.mode<ii&&(n.mode<ri||e!==qr))&&mi(t,t.output,t.next_out,f-t.avail_out),u-=t.avail_in,f-=t.avail_out,t.total_in+=u,t.total_out+=f,n.total+=f,4&n.wrap&&f&&(t.adler=n.check=n.flags?hn(n.check,i,f,t.next_out-f):sn(n.check,i,f,t.next_out-f)),t.data_type=n.bits+(n.last?64:0)+(n.mode===$r?128:0)+(n.mode===ei||n.mode===ti?256:0),(0===u&&0===f||e===qr)&&A===Ur&&(A=Zr),A},yi=t=>{if(oi(t))return Vr;let e=t.state;return e.window&&(e.window=null),t.state=null,Ur},_i=(t,e)=>{if(oi(t))return Vr;const n=t.state;return 2&n.wrap?(n.head=e,e.done=!1,Ur):Vr},xi=(t,e)=>{const n=e.length;let r,i,a;return oi(t)?Vr:(r=t.state,0!==r.wrap&&r.mode!==Kr?Vr:r.mode===Kr&&(i=1,i=sn(i,e,n,0),i!==r.check)?Gr:(a=mi(t,e,n,n),a?(r.mode=16210,Yr):(r.havedict=1,Ur)))},Ai=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Li=Object.prototype.toString,{Z_NO_FLUSH:Ni,Z_FINISH:Si,Z_OK:ki,Z_STREAM_END:Pi,Z_NEED_DICT:Fi,Z_STREAM_ERROR:Ii,Z_DATA_ERROR:Ci,Z_MEM_ERROR:ji}=cn;function Ei(t){this.options=dr({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new yr,this.strm.avail_out=0;let n=vi(this.strm,e.windowBits);if(n!==ki)throw new Error(ln[n]);if(this.header=new Ai,_i(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=br(e.dictionary):"[object ArrayBuffer]"===Li.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=xi(this.strm,e.dictionary),n!==ki)))throw new Error(ln[n])}function Oi(t,e){const n=new Ei(e);if(n.push(t),n.err)throw n.msg||ln[n.err];return n.result}Ei.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize,i=this.options.dictionary;let a,s,o;if(this.ended)return!1;for(s=e===~~e?e:!0===e?Si:Ni,"[object ArrayBuffer]"===Li.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),a=wi(n,s),a===Fi&&i&&(a=xi(n,i),a===ki?a=wi(n,s):a===Ci&&(a=Fi));n.avail_in>0&&a===Pi&&n.state.wrap>0&&0!==t[n.next_in];)bi(n),a=wi(n,s);switch(a){case Ii:case Ci:case Fi:case ji:return this.onEnd(a),this.ended=!0,!1}if(o=n.avail_out,n.next_out&&(0===n.avail_out||a===Pi))if("string"===this.options.to){let t=wr(n.output,n.next_out),e=n.next_out-t,i=vr(n.output,t);n.next_out=e,n.avail_out=r-e,e&&n.output.set(n.output.subarray(t,t+e),0),this.onData(i)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(a!==ki||0!==o){if(a===Pi)return a=yi(this.strm),this.onEnd(a),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},Ei.prototype.onData=function(t){this.chunks.push(t)},Ei.prototype.onEnd=function(t){t===ki&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=pr(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var Bi={Inflate:Ei,inflate:Oi,inflateRaw:function(t,e){return(e=e||{}).raw=!0,Oi(t,e)},ungzip:Oi,constants:cn};const{Inflate:Mi,inflate:Ri,inflateRaw:Ti,ungzip:qi}=Bi;var Di=Mi,zi=Ri;const Ui=[];for(let rs=0;rs<256;rs++){let t=rs;for(let e=0;e<8;e++)1&t?t=3988292384^t>>>1:t>>>=1;Ui[rs]=t}const Hi=4294967295;function Wi(t,e,n){const r=t.readUint32(),i=(a=new Uint8Array(t.buffer,t.byteOffset+t.offset-e-4,e),(function(t,e,n){let r=t;for(let i=0;i<n;i++)r=Ui[255&(r^e[i])]^r>>>8;return r}(Hi,a,e)^Hi)>>>0);var a;if(i!==r)throw new Error(`CRC mismatch for chunk ${n}. Expected ${r}, found ${i}`)}function Vi(t,e,n){for(let r=0;r<n;r++)e[r]=t[r]}function Gi(t,e,n,r){let i=0;for(;i<r;i++)e[i]=t[i];for(;i<n;i++)e[i]=t[i]+e[i-r]&255}function Yi(t,e,n,r){let i=0;if(0===n.length)for(;i<r;i++)e[i]=t[i];else for(;i<r;i++)e[i]=t[i]+n[i]&255}function Zi(t,e,n,r,i){let a=0;if(0===n.length){for(;a<i;a++)e[a]=t[a];for(;a<r;a++)e[a]=t[a]+(e[a-i]>>1)&255}else{for(;a<i;a++)e[a]=t[a]+(n[a]>>1)&255;for(;a<r;a++)e[a]=t[a]+(e[a-i]+n[a]>>1)&255}}function Ji(t,e,n,r,i){let a=0;if(0===n.length){for(;a<i;a++)e[a]=t[a];for(;a<r;a++)e[a]=t[a]+e[a-i]&255}else{for(;a<i;a++)e[a]=t[a]+n[a]&255;for(;a<r;a++)e[a]=t[a]+Xi(e[a-i],n[a],n[a-i])&255}}function Xi(t,e,n){const r=t+e-n,i=Math.abs(r-t),a=Math.abs(r-e),s=Math.abs(r-n);return i<=a&&i<=s?t:a<=s?e:n}function Ki(t,e,n,r,i,a){switch(t){case 0:Vi(e,n,i);break;case 1:Gi(e,n,i,a);break;case 2:Yi(e,n,r,i);break;case 3:Zi(e,n,r,i,a);break;case 4:Ji(e,n,r,i,a);break;default:throw new Error(`Unsupported filter: ${t}`)}}const $i=new Uint16Array([255]),Qi=255===new Uint8Array($i.buffer)[0];function ta(t){return(255&t)<<8|t>>8&255}const ea=new Uint16Array([255]),na=255===new Uint8Array(ea.buffer)[0],ra=new Uint8Array(0);function ia(t){const{data:e,width:n,height:r,channels:i,depth:a}=t,s=Math.ceil(a/8)*i,o=Math.ceil(a/8*i*n),h=new Uint8Array(r*o);let l,c,u=ra,f=0;for(let d=0;d<r;d++){switch(l=e.subarray(f+1,f+1+o),c=h.subarray(d*o,(d+1)*o),e[f]){case 0:Vi(l,c,o);break;case 1:Gi(l,c,o,s);break;case 2:Yi(l,c,u,o);break;case 3:Zi(l,c,u,o,s);break;case 4:Ji(l,c,u,o,s);break;default:throw new Error(`Unsupported filter: ${e[f]}`)}u=c,f+=o+1}if(16===a){const t=new Uint16Array(h.buffer);if(na)for(let e=0;e<t.length;e++)t[e]=aa(t[e]);return t}return h}function aa(t){return(255&t)<<8|t>>8&255}const sa=Uint8Array.of(137,80,78,71,13,10,26,10);function oa(t){if(!function(t){if(t.length<sa.length)return!1;for(let e=0;e<sa.length;e++)if(t[e]!==sa[e])return!1;return!0}(t.readBytes(sa.length)))throw new Error("wrong PNG signature")}const ha=new TextDecoder("latin1");const la=/^[\u0000-\u00FF]*$/;function ca(t){for(t.mark();0!==t.readByte(););const e=t.offset;t.reset();const n=ha.decode(t.readBytes(e-t.offset-1));return t.skip(1),function(t){if(function(t){if(!la.test(t))throw new Error("invalid latin1 text")}(t),0===t.length||t.length>79)throw new Error("keyword length must be between 1 and 79")}(n),n}class ua extends Ne{_checkCrc;_inflator;_png;_apng;_end;_hasPalette;_palette;_hasTransparency;_transparency;_compressionMethod;_filterMethod;_interlaceMethod;_colorType;_isAnimated;_numberOfFrames;_numberOfPlays;_frames;_writingDataChunks;constructor(t,e={}){super(t);const{checkCrc:n=!1}=e;this._checkCrc=n,this._inflator=new Di,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._apng={width:-1,height:-1,channels:-1,depth:1,numberOfFrames:1,numberOfPlays:0,text:{},frames:[]},this._end=!1,this._hasPalette=!1,this._palette=[],this._hasTransparency=!1,this._transparency=new Uint16Array(0),this._compressionMethod=-1,this._filterMethod=-1,this._interlaceMethod=-1,this._colorType=-1,this._isAnimated=!1,this._numberOfFrames=1,this._numberOfPlays=0,this._frames=[],this._writingDataChunks=!1,this.setBigEndian()}decode(){for(oa(this);!this._end;){const t=this.readUint32(),e=this.readChars(4);this.decodeChunk(t,e)}return this.decodeImage(),this._png}decodeApng(){for(oa(this);!this._end;){const t=this.readUint32(),e=this.readChars(4);this.decodeApngChunk(t,e)}return this.decodeApngImage(),this._apng}decodeChunk(t,e){const n=this.offset;switch(e){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(t);break;case"IDAT":this.decodeIDAT(t);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(t);break;case"iCCP":this.decodeiCCP(t);break;case"tEXt":!function(t,e,n){const r=ca(e);t[r]=function(t,e){return ha.decode(t.readBytes(e))}(e,n-r.length-1)}(this._png.text,this,t);break;case"pHYs":this.decodepHYs();break;default:this.skip(t)}if(this.offset-n!==t)throw new Error(`Length mismatch while decoding chunk ${e}`);this._checkCrc?Wi(this,t+4,e):this.skip(4)}decodeApngChunk(t,e){const n=this.offset;switch("fdAT"!==e&&"IDAT"!==e&&this._writingDataChunks&&this.pushDataToFrame(),e){case"acTL":this.decodeACTL();break;case"fcTL":this.decodeFCTL();break;case"fdAT":this.decodeFDAT(t);break;default:this.decodeChunk(t,e),this.offset=n+t}if(this.offset-n!==t)throw new Error(`Length mismatch while decoding chunk ${e}`);this._checkCrc?Wi(this,t+4,e):this.skip(4)}decodeIHDR(){const t=this._png;t.width=this.readUint32(),t.height=this.readUint32(),t.depth=function(t){if(1!==t&&2!==t&&4!==t&&8!==t&&16!==t)throw new Error(`invalid bit depth: ${t}`);return t}(this.readUint8());const e=this.readUint8();let n;switch(this._colorType=e,e){case 0:case 3:n=1;break;case 2:n=3;break;case 4:n=2;break;case 6:n=4;break;default:throw new Error(`Unknown color type: ${e}`)}if(this._png.channels=n,this._compressionMethod=this.readUint8(),0!==this._compressionMethod)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodeACTL(){this._numberOfFrames=this.readUint32(),this._numberOfPlays=this.readUint32(),this._isAnimated=!0}decodeFCTL(){const t={sequenceNumber:this.readUint32(),width:this.readUint32(),height:this.readUint32(),xOffset:this.readUint32(),yOffset:this.readUint32(),delayNumber:this.readUint16(),delayDenominator:this.readUint16(),disposeOp:this.readUint8(),blendOp:this.readUint8(),data:new Uint8Array(0)};this._frames.push(t)}decodePLTE(t){if(t%3!=0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${t}`);const e=t/3;this._hasPalette=!0;const n=[];this._palette=n;for(let r=0;r<e;r++)n.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(t){this._writingDataChunks=!0;const e=t,n=this.offset+this.byteOffset;if(this._inflator.push(new Uint8Array(this.buffer,n,e)),this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);this.skip(t)}decodeFDAT(t){this._writingDataChunks=!0;let e=t,n=this.offset+this.byteOffset;if(n+=4,e-=4,this._inflator.push(new Uint8Array(this.buffer,n,e)),this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);this.skip(t)}decodetRNS(t){switch(this._colorType){case 0:case 2:if(t%2!=0)throw new RangeError(`tRNS chunk length must be a multiple of 2. Got ${t}`);if(t/2>this._png.width*this._png.height)throw new Error(`tRNS chunk contains more alpha values than there are pixels (${t/2} vs ${this._png.width*this._png.height})`);this._hasTransparency=!0,this._transparency=new Uint16Array(t/2);for(let e=0;e<t/2;e++)this._transparency[e]=this.readUint16();break;case 3:{if(t>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${t} vs ${this._palette.length})`);let e=0;for(;e<t;e++){const t=this.readByte();this._palette[e].push(t)}for(;e<this._palette.length;e++)this._palette[e].push(255);break}default:throw new Error(`tRNS chunk is not supported for color type ${this._colorType}`)}}decodeiCCP(t){const e=ca(this),n=this.readUint8();if(0!==n)throw new Error(`Unsupported iCCP compression method: ${n}`);const r=this.readBytes(t-e.length-2);this._png.iccEmbeddedProfile={name:e,profile:zi(r)}}decodepHYs(){const t=this.readUint32(),e=this.readUint32(),n=this.readByte();this._png.resolution={x:t,y:e,unit:n}}decodeApngImage(){this._apng.width=this._png.width,this._apng.height=this._png.height,this._apng.channels=this._png.channels,this._apng.depth=this._png.depth,this._apng.numberOfFrames=this._numberOfFrames,this._apng.numberOfPlays=this._numberOfPlays,this._apng.text=this._png.text,this._apng.resolution=this._png.resolution;for(let t=0;t<this._numberOfFrames;t++){const e={sequenceNumber:this._frames[t].sequenceNumber,delayNumber:this._frames[t].delayNumber,delayDenominator:this._frames[t].delayDenominator,data:8===this._apng.depth?new Uint8Array(this._apng.width*this._apng.height*this._apng.channels):new Uint16Array(this._apng.width*this._apng.height*this._apng.channels)},n=this._frames.at(t);if(n){if(n.data=ia({data:n.data,width:n.width,height:n.height,channels:this._apng.channels,depth:this._apng.depth}),this._hasPalette&&(this._apng.palette=this._palette),this._hasTransparency&&(this._apng.transparency=this._transparency),0===t||0===n.xOffset&&0===n.yOffset&&n.width===this._png.width&&n.height===this._png.height)e.data=n.data;else{const r=this._apng.frames.at(t-1);this.disposeFrame(n,r,e),this.addFrameDataToCanvas(e,n)}this._apng.frames.push(e)}}return this._apng}disposeFrame(t,e,n){switch(t.disposeOp){case 0:break;case 1:for(let e=0;e<this._png.height;e++)for(let r=0;r<this._png.width;r++){const i=(e*t.width+r)*this._png.channels;for(let t=0;t<this._png.channels;t++)n.data[i+t]=0}break;case 2:n.data.set(e.data);break;default:throw new Error("Unknown disposeOp")}}addFrameDataToCanvas(t,e){const n=1<<this._png.depth,r=(t,n)=>({index:((t+e.yOffset)*this._png.width+e.xOffset+n)*this._png.channels,frameIndex:(t*e.width+n)*this._png.channels});switch(e.blendOp){case 0:for(let n=0;n<e.height;n++)for(let i=0;i<e.width;i++){const{index:a,frameIndex:s}=r(n,i);for(let n=0;n<this._png.channels;n++)t.data[a+n]=e.data[s+n]}break;case 1:for(let i=0;i<e.height;i++)for(let a=0;a<e.width;a++){const{index:s,frameIndex:o}=r(i,a);for(let r=0;r<this._png.channels;r++){const i=e.data[o+this._png.channels-1]/n,a=r%(this._png.channels-1)==0?1:e.data[o+r],h=Math.floor(i*a+(1-i)*t.data[s+r]);t.data[s+r]+=h}}break;default:throw new Error("Unknown blendOp")}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const t=this._isAnimated?(this._frames?.at(0)).data:this._inflator.result;if(0!==this._filterMethod)throw new Error(`Filter method ${this._filterMethod} not supported`);if(0===this._interlaceMethod)this._png.data=ia({data:t,width:this._png.width,height:this._png.height,channels:this._png.channels,depth:this._png.depth});else{if(1!==this._interlaceMethod)throw new Error(`Interlace method ${this._interlaceMethod} not supported`);this._png.data=function(t){const{data:e,width:n,height:r,channels:i,depth:a}=t,s=[{x:0,y:0,xStep:8,yStep:8},{x:4,y:0,xStep:8,yStep:8},{x:0,y:4,xStep:4,yStep:8},{x:2,y:0,xStep:4,yStep:4},{x:0,y:2,xStep:2,yStep:4},{x:1,y:0,xStep:2,yStep:2},{x:0,y:1,xStep:1,yStep:2}],o=Math.ceil(a/8)*i,h=new Uint8Array(r*n*o);let l=0;for(let c=0;c<7;c++){const t=s[c],i=Math.ceil((n-t.x)/t.xStep),a=Math.ceil((r-t.y)/t.yStep);if(i<=0||a<=0)continue;const u=i*o,f=new Uint8Array(u);for(let s=0;s<a;s++){const a=e[l++],c=e.subarray(l,l+u);l+=u;const d=new Uint8Array(u);Ki(a,c,d,f,u,o),f.set(d);for(let e=0;e<i;e++){const i=t.x+e*t.xStep,a=t.y+s*t.yStep;if(!(i>=n||a>=r))for(let t=0;t<o;t++)h[(a*n+i)*o+t]=d[e*o+t]}}}if(16===a){const t=new Uint16Array(h.buffer);if(Qi)for(let e=0;e<t.length;e++)t[e]=ta(t[e]);return t}return h}({data:t,width:this._png.width,height:this._png.height,channels:this._png.channels,depth:this._png.depth})}this._hasPalette&&(this._png.palette=this._palette),this._hasTransparency&&(this._png.transparency=this._transparency)}pushDataToFrame(){const t=this._inflator.result,e=this._frames.at(-1);e?e.data=t:this._frames.push({sequenceNumber:0,width:this._png.width,height:this._png.height,xOffset:0,yOffset:0,delayNumber:0,delayDenominator:0,disposeOp:0,blendOp:0,data:t}),this._inflator=new Di,this._writingDataChunks=!1}}var fa,da,pa,ga,ma,ba;function va(t,e,n,r,i){var a=4,s=_a;switch(i){case R.API.image_compression.FAST:a=1,s=ya;break;case R.API.image_compression.MEDIUM:a=6,s=xa;break;case R.API.image_compression.SLOW:a=9,s=Aa}t=function(t,e,n,r){for(var i,a=t.length/e,s=new Uint8Array(t.length+a),o=[wa,ya,_a,xa,Aa],h=0;h<a;h+=1){var l=h*e,c=t.subarray(l,l+e);if(r)s.set(r(c,n,i),l+h);else{for(var u=o.length,f=[],d=0;d<u;d+=1)f[d]=o[d](c,n,i);var p=Na(f.concat());s.set(f[p],l+h)}i=c}return s}(t,e,Math.ceil(n*r/8),s);var o=we(t,{level:a});return R.API.__addimage__.arrayBufferToBinaryString(o)}function wa(t){var e=Array.apply([],t);return e.unshift(0),e}function ya(t,e){var n=t.length,r=[];r[0]=1;for(var i=0;i<n;i+=1){var a=t[i-e]||0;r[i+1]=t[i]-a+256&255}return r}function _a(t,e,n){var r=t.length,i=[];i[0]=2;for(var a=0;a<r;a+=1){var s=n&&n[a]||0;i[a+1]=t[a]-s+256&255}return i}function xa(t,e,n){var r=t.length,i=[];i[0]=3;for(var a=0;a<r;a+=1){var s=t[a-e]||0,o=n&&n[a]||0;i[a+1]=t[a]+256-(s+o>>>1)&255}return i}function Aa(t,e,n){var r=t.length,i=[];i[0]=4;for(var a=0;a<r;a+=1){var s=La(t[a-e]||0,n&&n[a]||0,n&&n[a-e]||0);i[a+1]=t[a]-s+256&255}return i}function La(t,e,n){if(t===e&&e===n)return t;var r=Math.abs(e-n),i=Math.abs(t-n),a=Math.abs(t+e-n-n);return r<=i&&r<=a?t:i<=a?e:n}function Na(t){var e=t.map(function(t){return t.reduce(function(t,e){return t+Math.abs(e)},0)});return e.indexOf(Math.min.apply(null,e))}function Sa(t,e,n){var r=e*n,i=Math.floor(r/8),a=16-(r-8*i+n),s=(1<<n)-1;return Pa(t,i)>>a&s}function ka(t,e,n,r){var i=n*r,a=Math.floor(i/8),s=16-(i-8*a+r),o=(1<<r)-1,h=(e&o)<<s;!function(t,e,n){if(e+1<t.byteLength)t.setUint16(e,n,!1);else{var r=n>>8&255;t.setUint8(e,r)}}
/**
   * @license
   * (c) Dean McNamee <dean@gmail.com>, 2013.
   *
   * https://github.com/deanm/omggif
   *
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to
   * deal in the Software without restriction, including without limitation the
   * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
   * sell copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   *
   * The above copyright notice and this permission notice shall be included in
   * all copies or substantial portions of the Software.
   *
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
   * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
   * IN THE SOFTWARE.
   *
   * omggif is a JavaScript implementation of a GIF 89a encoder and decoder,
   * including animation and compression.  It does not rely on any specific
   * underlying system, so should run in the browser, Node, or Plask.
   */(t,a,Pa(t,a)&~(o<<s)&65535|h)}function Pa(t,e){return e+1<t.byteLength?t.getUint16(e,!1):t.getUint8(e)<<8}function Fa(t){var e=0;if(71!==t[e++]||73!==t[e++]||70!==t[e++]||56!==t[e++]||56!=(t[e++]+1&253)||97!==t[e++])throw new Error("Invalid GIF 87a/89a header.");var n=t[e++]|t[e++]<<8,r=t[e++]|t[e++]<<8,i=t[e++],a=i>>7,s=1<<1+(7&i);t[e++],t[e++];var o=null,h=null;a&&(o=e,h=s,e+=3*s);var l=!0,c=[],u=0,f=null,d=0,p=null;for(this.width=n,this.height=r;l&&e<t.length;)switch(t[e++]){case 33:switch(t[e++]){case 255:if(11!==t[e]||78==t[e+1]&&69==t[e+2]&&84==t[e+3]&&83==t[e+4]&&67==t[e+5]&&65==t[e+6]&&80==t[e+7]&&69==t[e+8]&&50==t[e+9]&&46==t[e+10]&&48==t[e+11]&&3==t[e+12]&&1==t[e+13]&&0==t[e+16])e+=14,p=t[e++]|t[e++]<<8,e++;else for(e+=12;;){if(!((k=t[e++])>=0))throw Error("Invalid block size");if(0===k)break;e+=k}break;case 249:if(4!==t[e++]||0!==t[e+4])throw new Error("Invalid graphics extension block.");var g=t[e++];u=t[e++]|t[e++]<<8,f=t[e++],1&g||(f=null),d=g>>2&7,e++;break;case 254:for(;;){if(!((k=t[e++])>=0))throw Error("Invalid block size");if(0===k)break;e+=k}break;default:throw new Error("Unknown graphic control label: 0x"+t[e-1].toString(16))}break;case 44:var m=t[e++]|t[e++]<<8,b=t[e++]|t[e++]<<8,v=t[e++]|t[e++]<<8,w=t[e++]|t[e++]<<8,y=t[e++],_=y>>6&1,x=1<<1+(7&y),A=o,L=h,N=!1;y>>7&&(N=!0,A=e,L=x,e+=3*x);var S=e;for(e++;;){var k;if(!((k=t[e++])>=0))throw Error("Invalid block size");if(0===k)break;e+=k}c.push({x:m,y:b,width:v,height:w,has_local_palette:N,palette_offset:A,palette_size:L,data_offset:S,data_length:e-S,transparent_index:f,interlaced:!!_,delay:u,disposal:d});break;case 59:l=!1;break;default:throw new Error("Unknown gif block: 0x"+t[e-1].toString(16))}this.numFrames=function(){return c.length},this.loopCount=function(){return p},this.frameInfo=function(t){if(t<0||t>=c.length)throw new Error("Frame index out of range.");return c[t]},this.decodeAndBlitFrameBGRA=function(e,r){var i=this.frameInfo(e),a=i.width*i.height,s=new Uint8Array(a);Ia(t,i.data_offset,s,a);var o=i.palette_offset,h=i.transparent_index;null===h&&(h=256);var l=i.width,c=n-l,u=l,f=4*(i.y*n+i.x),d=4*((i.y+i.height)*n+i.x),p=f,g=4*c;!0===i.interlaced&&(g+=4*n*7);for(var m=8,b=0,v=s.length;b<v;++b){var w=s[b];if(0===u&&(u=l,(p+=g)>=d&&(g=4*c+4*n*(m-1),p=f+(l+c)*(m<<1),m>>=1)),w===h)p+=4;else{var y=t[o+3*w],_=t[o+3*w+1],x=t[o+3*w+2];r[p++]=x,r[p++]=_,r[p++]=y,r[p++]=255}--u}},this.decodeAndBlitFrameRGBA=function(e,r){var i=this.frameInfo(e),a=i.width*i.height,s=new Uint8Array(a);Ia(t,i.data_offset,s,a);var o=i.palette_offset,h=i.transparent_index;null===h&&(h=256);var l=i.width,c=n-l,u=l,f=4*(i.y*n+i.x),d=4*((i.y+i.height)*n+i.x),p=f,g=4*c;!0===i.interlaced&&(g+=4*n*7);for(var m=8,b=0,v=s.length;b<v;++b){var w=s[b];if(0===u&&(u=l,(p+=g)>=d&&(g=4*c+4*n*(m-1),p=f+(l+c)*(m<<1),m>>=1)),w===h)p+=4;else{var y=t[o+3*w],_=t[o+3*w+1],x=t[o+3*w+2];r[p++]=y,r[p++]=_,r[p++]=x,r[p++]=255}--u}}}function Ia(t,e,n,r){for(var i=t[e++],a=1<<i,o=a+1,h=o+1,l=i+1,c=(1<<l)-1,u=0,f=0,d=0,p=t[e++],g=new Int32Array(4096),m=null;;){for(;u<16&&0!==p;)f|=t[e++]<<u,u+=8,1===p?p=t[e++]:--p;if(u<l)break;var b=f&c;if(f>>=l,u-=l,b!==a){if(b===o)break;for(var v=b<h?b:m,w=0,y=v;y>a;)y=g[y]>>8,++w;var _=y;if(d+w+(v!==b?1:0)>r)return void s.log("Warning, gif stream longer than expected.");n[d++]=_;var x=d+=w;for(v!==b&&(n[d++]=_),y=v;w--;)y=g[y],n[--x]=255&y,y>>=8;null!==m&&h<4096&&(g[h++]=m<<8|_,h>=c+1&&l<12&&(++l,c=c<<1|1)),m=b}else h=o+1,c=(1<<(l=i+1))-1,m=null}return d!==r&&s.log("Warning, gif stream shorter than expected."),n}
/**
   * @license
    Copyright (c) 2008, Adobe Systems Incorporated
    All rights reserved.

    Redistribution and use in source and binary forms, with or without 
    modification, are permitted provided that the following conditions are
    met:

    * Redistributions of source code must retain the above copyright notice, 
      this list of conditions and the following disclaimer.
    
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the 
      documentation and/or other materials provided with the distribution.
    
    * Neither the name of Adobe Systems Incorporated nor the names of its 
      contributors may be used to endorse or promote products derived from 
      this software without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
    IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
    THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
    PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR 
    CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
    EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
    PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
    PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
    NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
    SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */function Ca(t){var e,n,r,i,a,s=Math.floor,o=new Array(64),h=new Array(64),l=new Array(64),c=new Array(64),u=new Array(65535),f=new Array(65535),d=new Array(64),p=new Array(64),g=[],m=0,b=7,v=new Array(64),w=new Array(64),y=new Array(64),_=new Array(256),x=new Array(2048),A=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],L=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],N=[0,1,2,3,4,5,6,7,8,9,10,11],S=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],k=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],P=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],F=[0,1,2,3,4,5,6,7,8,9,10,11],I=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],C=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function j(t,e){for(var n=0,r=0,i=new Array,a=1;a<=16;a++){for(var s=1;s<=t[a];s++)i[e[r]]=[],i[e[r]][0]=n,i[e[r]][1]=a,r++,n++;n*=2}return i}function E(t){for(var e=t[0],n=t[1]-1;n>=0;)e&1<<n&&(m|=1<<b),n--,--b<0&&(255==m?(O(255),O(0)):O(m),b=7,m=0)}function O(t){g.push(t)}function B(t){O(t>>8&255),O(255&t)}function M(t,e,n,r,i){for(var a,s=i[0],o=i[240],h=function(t,e){var n,r,i,a,s,o,h,l,c,u,f=0;for(c=0;c<8;++c){n=t[f],r=t[f+1],i=t[f+2],a=t[f+3],s=t[f+4],o=t[f+5],h=t[f+6];var p=n+(l=t[f+7]),g=n-l,m=r+h,b=r-h,v=i+o,w=i-o,y=a+s,_=a-s,x=p+y,A=p-y,L=m+v,N=m-v;t[f]=x+L,t[f+4]=x-L;var S=.707106781*(N+A);t[f+2]=A+S,t[f+6]=A-S;var k=.382683433*((x=_+w)-(N=b+g)),P=.5411961*x+k,F=1.306562965*N+k,I=.707106781*(L=w+b),C=g+I,j=g-I;t[f+5]=j+P,t[f+3]=j-P,t[f+1]=C+F,t[f+7]=C-F,f+=8}for(f=0,c=0;c<8;++c){n=t[f],r=t[f+8],i=t[f+16],a=t[f+24],s=t[f+32],o=t[f+40],h=t[f+48];var E=n+(l=t[f+56]),O=n-l,B=r+h,M=r-h,R=i+o,T=i-o,q=a+s,D=a-s,z=E+q,U=E-q,H=B+R,W=B-R;t[f]=z+H,t[f+32]=z-H;var V=.707106781*(W+U);t[f+16]=U+V,t[f+48]=U-V;var G=.382683433*((z=D+T)-(W=M+O)),Y=.5411961*z+G,Z=1.306562965*W+G,J=.707106781*(H=T+M),X=O+J,K=O-J;t[f+40]=K+Y,t[f+24]=K-Y,t[f+8]=X+Z,t[f+56]=X-Z,f++}for(c=0;c<64;++c)u=t[c]*e[c],d[c]=u>0?u+.5|0:u-.5|0;return d}(t,e),l=0;l<64;++l)p[A[l]]=h[l];var c=p[0]-n;n=p[0],0==c?E(r[0]):(E(r[f[a=32767+c]]),E(u[a]));for(var g=63;g>0&&0==p[g];)g--;if(0==g)return E(s),n;for(var m,b=1;b<=g;){for(var v=b;0==p[b]&&b<=g;)++b;var w=b-v;if(w>=16){m=w>>4;for(var y=1;y<=m;++y)E(o);w&=15}a=32767+p[b],E(i[(w<<4)+f[a]]),E(u[a]),b++}return 63!=g&&E(s),n}function R(t){t=Math.min(Math.max(t,1),100),a!=t&&(function(t){for(var e=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],n=0;n<64;n++){var r=s((e[n]*t+50)/100);r=Math.min(Math.max(r,1),255),o[A[n]]=r}for(var i=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],a=0;a<64;a++){var u=s((i[a]*t+50)/100);u=Math.min(Math.max(u,1),255),h[A[a]]=u}for(var f=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],d=0,p=0;p<8;p++)for(var g=0;g<8;g++)l[d]=1/(o[A[d]]*f[p]*f[g]*8),c[d]=1/(h[A[d]]*f[p]*f[g]*8),d++}(t<50?Math.floor(5e3/t):Math.floor(200-2*t)),a=t)}this.encode=function(t,a){a&&R(a),g=new Array,m=0,b=7,B(65496),B(65504),B(16),O(74),O(70),O(73),O(70),O(0),O(1),O(1),O(0),B(1),B(1),O(0),O(0),function(){B(65499),B(132),O(0);for(var t=0;t<64;t++)O(o[t]);O(1);for(var e=0;e<64;e++)O(h[e])}(),function(t,e){B(65472),B(17),O(8),B(e),B(t),O(3),O(1),O(17),O(0),O(2),O(17),O(1),O(3),O(17),O(1)}(t.width,t.height),function(){B(65476),B(418),O(0);for(var t=0;t<16;t++)O(L[t+1]);for(var e=0;e<=11;e++)O(N[e]);O(16);for(var n=0;n<16;n++)O(S[n+1]);for(var r=0;r<=161;r++)O(k[r]);O(1);for(var i=0;i<16;i++)O(P[i+1]);for(var a=0;a<=11;a++)O(F[a]);O(17);for(var s=0;s<16;s++)O(I[s+1]);for(var o=0;o<=161;o++)O(C[o])}(),B(65498),B(12),O(3),O(1),O(0),O(2),O(17),O(3),O(17),O(0),O(63),O(0);var s=0,u=0,f=0;m=0,b=7,this.encode.displayName="_encode_";for(var d,p,_,A,j,T,q,D,z,U=t.data,H=t.width,W=t.height,V=4*H,G=0;G<W;){for(d=0;d<V;){for(j=V*G+d,q=-1,D=0,z=0;z<64;z++)T=j+(D=z>>3)*V+(q=4*(7&z)),G+D>=W&&(T-=V*(G+1+D-W)),d+q>=V&&(T-=d+q-V+4),p=U[T++],_=U[T++],A=U[T++],v[z]=(x[p]+x[_+256|0]+x[A+512|0]>>16)-128,w[z]=(x[p+768|0]+x[_+1024|0]+x[A+1280|0]>>16)-128,y[z]=(x[p+1280|0]+x[_+1536|0]+x[A+1792|0]>>16)-128;s=M(v,l,s,e,r),u=M(w,c,u,n,i),f=M(y,c,f,n,i),d+=32}G+=8}if(b>=0){var Y=[];Y[1]=b+1,Y[0]=(1<<b+1)-1,E(Y)}return B(65497),new Uint8Array(g)},t=t||50,function(){for(var t=String.fromCharCode,e=0;e<256;e++)_[e]=t(e)}(),e=j(L,N),n=j(P,F),r=j(S,k),i=j(I,C),function(){for(var t=1,e=2,n=1;n<=15;n++){for(var r=t;r<e;r++)f[32767+r]=n,u[32767+r]=[],u[32767+r][1]=n,u[32767+r][0]=r;for(var i=-(e-1);i<=-t;i++)f[32767+i]=n,u[32767+i]=[],u[32767+i][1]=n,u[32767+i][0]=e-1+i;t<<=1,e<<=1}}(),function(){for(var t=0;t<256;t++)x[t]=19595*t,x[t+256|0]=38470*t,x[t+512|0]=7471*t+32768,x[t+768|0]=-11059*t,x[t+1024|0]=-21709*t,x[t+1280|0]=32768*t+8421375,x[t+1536|0]=-27439*t,x[t+1792|0]=-5329*t}(),R(t)}
/**
   * @license
   * Copyright (c) 2017 Aras Abbasi
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */function ja(t,e){if(this.pos=0,this.buffer=t,this.datav=new DataView(t.buffer),this.is_with_alpha=!!e,this.bottom_up=!0,this.flag=String.fromCharCode(this.buffer[0])+String.fromCharCode(this.buffer[1]),this.pos+=2,-1===["BM","BA","CI","CP","IC","PT"].indexOf(this.flag))throw new Error("Invalid BMP File");this.parseHeader(),this.parseBGR()}function Ea(t){function e(t){if(!t)throw Error("assert :P")}function n(t,e,n){for(var r=0;4>r;r++)if(t[e+r]!=n.charCodeAt(r))return!0;return!1}function r(t,e,n,r,i){for(var a=0;a<i;a++)t[e+a]=n[r+a]}function i(t,e,n,r){for(var i=0;i<r;i++)t[e+i]=n}function a(t){return new Int32Array(t)}function s(t,e){for(var n=[],r=0;r<t;r++)n.push(new e);return n}function o(t,e){var n=[];return function t(n,r,i){for(var a=i[r],s=0;s<a&&(n.push(i.length>r+1?[]:new e),!(i.length<r+1));s++)t(n[s],r+1,i)}(n,0,t),n}var h=function(){var t=this;function h(t,e){for(var n=1<<e-1>>>0;t&n;)n>>>=1;return n?(t&n-1)+n:t}function l(t,n,r,i,a){e(!(i%r));do{t[n+(i-=r)]=a}while(0<i)}function c(t,n,r,i,s){if(e(2328>=s),512>=s)var o=a(512);else if(null==(o=a(s)))return 0;return function(t,n,r,i,s,o){var c,f,d=n,p=1<<r,g=a(16),m=a(16);for(e(0!=s),e(null!=i),e(null!=t),e(0<r),f=0;f<s;++f){if(15<i[f])return 0;++g[i[f]]}if(g[0]==s)return 0;for(m[1]=0,c=1;15>c;++c){if(g[c]>1<<c)return 0;m[c+1]=m[c]+g[c]}for(f=0;f<s;++f)c=i[f],0<i[f]&&(o[m[c]++]=f);if(1==m[15])return(i=new u).g=0,i.value=o[0],l(t,d,1,p,i),p;var b,v=-1,w=p-1,y=0,_=1,x=1,A=1<<r;for(f=0,c=1,s=2;c<=r;++c,s<<=1){if(_+=x<<=1,0>(x-=g[c]))return 0;for(;0<g[c];--g[c])(i=new u).g=c,i.value=o[f++],l(t,d+y,s,A,i),y=h(y,c)}for(c=r+1,s=2;15>=c;++c,s<<=1){if(_+=x<<=1,0>(x-=g[c]))return 0;for(;0<g[c];--g[c]){if(i=new u,(y&w)!=v){for(d+=A,b=1<<(v=c)-r;15>v&&!(0>=(b-=g[v]));)++v,b<<=1;p+=A=1<<(b=v-r),t[n+(v=y&w)].g=b+r,t[n+v].value=d-n-v}i.g=c-r,i.value=o[f++],l(t,d+(y>>r),s,A,i),y=h(y,c)}}return _!=2*m[15]-1?0:p}(t,n,r,i,s,o)}function u(){this.value=this.g=0}function f(){this.value=this.g=0}function d(){this.G=s(5,u),this.H=a(5),this.jc=this.Qb=this.qb=this.nd=0,this.pd=s(Tn,f)}function p(t,n,r,i){e(null!=t),e(null!=n),e(2147483648>i),t.Ca=254,t.I=0,t.b=-8,t.Ka=0,t.oa=n,t.pa=r,t.Jd=n,t.Yc=r+i,t.Zc=4<=i?r+i-4+1:r,S(t)}function g(t,e){for(var n=0;0<e--;)n|=P(t,128)<<e;return n}function m(t,e){var n=g(t,e);return k(t)?-n:n}function b(t,n,r,i){var a,s=0;for(e(null!=t),e(null!=n),e(4294967288>i),t.Sb=i,t.Ra=0,t.u=0,t.h=0,4<i&&(i=4),a=0;a<i;++a)s+=n[r+a]<<8*a;t.Ra=s,t.bb=i,t.oa=n,t.pa=r}function v(t){for(;8<=t.u&&t.bb<t.Sb;)t.Ra>>>=8,t.Ra+=t.oa[t.pa+t.bb]<<zn-8>>>0,++t.bb,t.u-=8;A(t)&&(t.h=1,t.u=0)}function w(t,n){if(e(0<=n),!t.h&&n<=Dn){var r=x(t)&qn[n];return t.u+=n,v(t),r}return t.h=1,t.u=0}function y(){this.b=this.Ca=this.I=0,this.oa=[],this.pa=0,this.Jd=[],this.Yc=0,this.Zc=[],this.Ka=0}function _(){this.Ra=0,this.oa=[],this.h=this.u=this.bb=this.Sb=this.pa=0}function x(t){return t.Ra>>>(t.u&zn-1)>>>0}function A(t){return e(t.bb<=t.Sb),t.h||t.bb==t.Sb&&t.u>zn}function L(t,e){t.u=e,t.h=A(t)}function N(t){t.u>=Un&&(e(t.u>=Un),v(t))}function S(t){e(null!=t&&null!=t.oa),t.pa<t.Zc?(t.I=(t.oa[t.pa++]|t.I<<8)>>>0,t.b+=8):(e(null!=t&&null!=t.oa),t.pa<t.Yc?(t.b+=8,t.I=t.oa[t.pa++]|t.I<<8):t.Ka?t.b=0:(t.I<<=8,t.b+=8,t.Ka=1))}function k(t){return g(t,1)}function P(t,e){var n=t.Ca;0>t.b&&S(t);var r=t.b,i=n*e>>>8,a=(t.I>>>r>i)+0;for(a?(n-=i,t.I-=i+1<<r>>>0):n=i+1,r=n,i=0;256<=r;)i+=8,r>>=8;return r=7^i+Hn[r],t.b-=r,t.Ca=(n<<r)-1,a}function F(t,e,n){t[e+0]=n>>24&255,t[e+1]=n>>16&255,t[e+2]=n>>8&255,t[e+3]=255&n}function I(t,e){return t[e+0]|t[e+1]<<8}function C(t,e){return I(t,e)|t[e+2]<<16}function j(t,e){return I(t,e)|I(t,e+2)<<16}function E(t,n){var r=1<<n;return e(null!=t),e(0<n),t.X=a(r),null==t.X?0:(t.Mb=32-n,t.Xa=n,1)}function O(t,n){e(null!=t),e(null!=n),e(t.Xa==n.Xa),r(n.X,0,t.X,0,1<<n.Xa)}function B(){this.X=[],this.Xa=this.Mb=0}function M(t,n,r,i){e(null!=r),e(null!=i);var a=r[0],s=i[0];return 0==a&&(a=(t*s+n/2)/n),0==s&&(s=(n*a+t/2)/t),0>=a||0>=s?0:(r[0]=a,i[0]=s,1)}function R(t,e){return t+(1<<e)-1>>>e}function T(t,e){return((4278255360&t)+(4278255360&e)>>>0&4278255360)+((16711935&t)+(16711935&e)>>>0&16711935)>>>0}function q(e,n){t[n]=function(n,r,i,a,s,o,h){var l;for(l=0;l<s;++l){var c=t[e](o[h+l-1],i,a+l);o[h+l]=T(n[r+l],c)}}}function D(){this.ud=this.hd=this.jd=0}function z(t,e){return((4278124286&(t^e))>>>1)+(t&e)>>>0}function U(t){return 0<=t&&256>t?t:0>t?0:255<t?255:void 0}function H(t,e){return U(t+(t-e+.5>>1))}function W(t,e,n){return Math.abs(e-n)-Math.abs(t-n)}function V(t,e,n,r,i,a,s){for(r=a[s-1],n=0;n<i;++n)a[s+n]=r=T(t[e+n],r)}function G(t,e,n,r,i){var a;for(a=0;a<n;++a){var s=t[e+a],o=s>>8&255,h=16711935&(h=(h=16711935&s)+((o<<16)+o));r[i+a]=(4278255360&s)+h>>>0}}function Y(t,e){e.jd=255&t,e.hd=t>>8&255,e.ud=t>>16&255}function Z(t,e,n,r,i,a){var s;for(s=0;s<r;++s){var o=e[n+s],h=o>>>8,l=o,c=255&(c=(c=o>>>16)+((t.jd<<24>>24)*(h<<24>>24)>>>5));l=255&(l=(l+=(t.hd<<24>>24)*(h<<24>>24)>>>5)+((t.ud<<24>>24)*(c<<24>>24)>>>5)),i[a+s]=(4278255360&o)+(c<<16)+l}}function J(e,n,r,i,a){t[n]=function(t,e,n,r,s,o,h,l,c){for(r=h;r<l;++r)for(h=0;h<c;++h)s[o++]=a(n[i(t[e++])])},t[e]=function(e,n,s,o,h,l,c){var u=8>>e.b,f=e.Ea,d=e.K[0],p=e.w;if(8>u)for(e=(1<<e.b)-1,p=(1<<u)-1;n<s;++n){var g,m=0;for(g=0;g<f;++g)g&e||(m=i(o[h++])),l[c++]=a(d[m&p]),m>>=u}else t["VP8LMapColor"+r](o,h,d,p,l,c,n,s,f)}}function X(t,e,n,r,i){for(n=e+n;e<n;){var a=t[e++];r[i++]=a>>16&255,r[i++]=a>>8&255,r[i++]=255&a}}function K(t,e,n,r,i){for(n=e+n;e<n;){var a=t[e++];r[i++]=a>>16&255,r[i++]=a>>8&255,r[i++]=255&a,r[i++]=a>>24&255}}function $(t,e,n,r,i){for(n=e+n;e<n;){var a=(s=t[e++])>>16&240|s>>12&15,s=240&s|s>>28&15;r[i++]=a,r[i++]=s}}function Q(t,e,n,r,i){for(n=e+n;e<n;){var a=(s=t[e++])>>16&248|s>>13&7,s=s>>5&224|s>>3&31;r[i++]=a,r[i++]=s}}function tt(t,e,n,r,i){for(n=e+n;e<n;){var a=t[e++];r[i++]=255&a,r[i++]=a>>8&255,r[i++]=a>>16&255}}function et(t,e,n,i,a,s){if(0==s)for(n=e+n;e<n;)F(i,((s=t[e++])[0]>>24|s[1]>>8&65280|s[2]<<8&16711680|s[3]<<24)>>>0),a+=32;else r(i,a,t,e,n)}function nt(e,n){t[n][0]=t[e+"0"],t[n][1]=t[e+"1"],t[n][2]=t[e+"2"],t[n][3]=t[e+"3"],t[n][4]=t[e+"4"],t[n][5]=t[e+"5"],t[n][6]=t[e+"6"],t[n][7]=t[e+"7"],t[n][8]=t[e+"8"],t[n][9]=t[e+"9"],t[n][10]=t[e+"10"],t[n][11]=t[e+"11"],t[n][12]=t[e+"12"],t[n][13]=t[e+"13"],t[n][14]=t[e+"0"],t[n][15]=t[e+"0"]}function rt(t){return t==Ur||t==Hr||t==Wr||t==Vr}function it(){this.eb=[],this.size=this.A=this.fb=0}function at(){this.y=[],this.f=[],this.ea=[],this.F=[],this.Tc=this.Ed=this.Cd=this.Fd=this.lb=this.Db=this.Ab=this.fa=this.J=this.W=this.N=this.O=0}function st(){this.Rd=this.height=this.width=this.S=0,this.f={},this.f.RGBA=new it,this.f.kb=new at,this.sd=null}function ot(){this.width=[0],this.height=[0],this.Pd=[0],this.Qd=[0],this.format=[0]}function ht(){this.Id=this.fd=this.Md=this.hb=this.ib=this.da=this.bd=this.cd=this.j=this.v=this.Da=this.Sd=this.ob=0}function lt(t){return alert("todo:WebPSamplerProcessPlane"),t.T}function ct(t,e){var n=t.T,i=e.ba.f.RGBA,a=i.eb,s=i.fb+t.ka*i.A,o=mi[e.ba.S],h=t.y,l=t.O,c=t.f,u=t.N,f=t.ea,d=t.W,p=e.cc,g=e.dc,m=e.Mc,b=e.Nc,v=t.ka,w=t.ka+t.T,y=t.U,_=y+1>>1;for(0==v?o(h,l,null,null,c,u,f,d,c,u,f,d,a,s,null,null,y):(o(e.ec,e.fc,h,l,p,g,m,b,c,u,f,d,a,s-i.A,a,s,y),++n);v+2<w;v+=2)p=c,g=u,m=f,b=d,u+=t.Rc,d+=t.Rc,s+=2*i.A,o(h,(l+=2*t.fa)-t.fa,h,l,p,g,m,b,c,u,f,d,a,s-i.A,a,s,y);return l+=t.fa,t.j+w<t.o?(r(e.ec,e.fc,h,l,y),r(e.cc,e.dc,c,u,_),r(e.Mc,e.Nc,f,d,_),n--):1&w||o(h,l,null,null,c,u,f,d,c,u,f,d,a,s+i.A,null,null,y),n}function ut(t,n,r){var i=t.F,a=[t.J];if(null!=i){var s=t.U,o=n.ba.S,h=o==qr||o==Wr;n=n.ba.f.RGBA;var l=[0],c=t.ka;l[0]=t.T,t.Kb&&(0==c?--l[0]:(--c,a[0]-=t.width),t.j+t.ka+t.T==t.o&&(l[0]=t.o-t.j-c));var u=n.eb;c=n.fb+c*n.A,t=Lr(i,a[0],t.width,s,l,u,c+(h?0:3),n.A),e(r==l),t&&rt(o)&&xr(u,c,h,s,l,n.A)}return 0}function ft(t){var e=t.ma,n=e.ba.S,r=11>n,i=n==Mr||n==Tr||n==qr||n==Dr||12==n||rt(n);if(e.memory=null,e.Ib=null,e.Jb=null,e.Nd=null,!Bn(e.Oa,t,i?11:12))return 0;if(i&&rt(n)&&vn(),t.da)alert("todo:use_scaling");else{if(r){if(e.Ib=lt,t.Kb){if(n=t.U+1>>1,e.memory=a(t.U+2*n),null==e.memory)return 0;e.ec=e.memory,e.fc=0,e.cc=e.ec,e.dc=e.fc+t.U,e.Mc=e.cc,e.Nc=e.dc+n,e.Ib=ct,vn()}}else alert("todo:EmitYUV");i&&(e.Jb=ut,r&&mn())}if(r&&!Ii){for(t=0;256>t;++t)Ci[t]=89858*(t-128)+Ni>>Li,Oi[t]=-22014*(t-128)+Ni,Ei[t]=-45773*(t-128),ji[t]=113618*(t-128)+Ni>>Li;for(t=Si;t<ki;++t)e=76283*(t-16)+Ni>>Li,Bi[t-Si]=Vt(e,255),Mi[t-Si]=Vt(e+8>>4,15);Ii=1}return 1}function dt(t){var n=t.ma,r=t.U,i=t.T;return e(!(1&t.ka)),0>=r||0>=i?0:(r=n.Ib(t,n),null!=n.Jb&&n.Jb(t,n,r),n.Dc+=r,1)}function pt(t){t.ma.memory=null}function gt(t,e,n,r){return 47!=w(t,8)?0:(e[0]=w(t,14)+1,n[0]=w(t,14)+1,r[0]=w(t,1),0!=w(t,3)?0:!t.h)}function mt(t,e){if(4>t)return t+1;var n=t-2>>1;return(2+(1&t)<<n)+w(e,n)+1}function bt(t,e){return 120<e?e-120:1<=(n=((n=Kr[e-1])>>4)*t+(8-(15&n)))?n:1;var n}function vt(t,e,n){var r=x(n),i=t[e+=255&r].g-8;return 0<i&&(L(n,n.u+8),r=x(n),e+=t[e].value,e+=r&(1<<i)-1),L(n,n.u+t[e].g),t[e].value}function wt(t,n,r){return r.g+=t.g,r.value+=t.value<<n>>>0,e(8>=r.g),t.g}function yt(t,n,r){var i=t.xc;return e((n=0==i?0:t.vc[t.md*(r>>i)+(n>>i)])<t.Wb),t.Ya[n]}function _t(t,n,i,a){var s=t.ab,o=t.c*n,h=t.C;n=h+n;var l=i,c=a;for(a=t.Ta,i=t.Ua;0<s--;){var u=t.gc[s],f=h,d=n,p=l,g=c,m=(c=a,l=i,u.Ea);switch(e(f<d),e(d<=u.nc),u.hc){case 2:Gn(p,g,(d-f)*m,c,l);break;case 0:var b=f,v=d,w=c,y=l,_=(S=u).Ea;0==b&&(Wn(p,g,null,null,1,w,y),V(p,g+1,0,0,_-1,w,y+1),g+=_,y+=_,++b);for(var x=1<<S.b,A=x-1,L=R(_,S.b),N=S.K,S=S.w+(b>>S.b)*L;b<v;){var k=N,P=S,F=1;for(Vn(p,g,w,y-_,1,w,y);F<_;){var I=(F&~A)+x;I>_&&(I=_),(0,Kn[k[P++]>>8&15])(p,g+ +F,w,y+F-_,I-F,w,y+F),F=I}g+=_,y+=_,++b&A||(S+=L)}d!=u.nc&&r(c,l-m,c,l+(d-f-1)*m,m);break;case 1:for(m=p,v=g,_=(p=u.Ea)-(y=p&~(w=(g=1<<u.b)-1)),b=R(p,u.b),x=u.K,u=u.w+(f>>u.b)*b;f<d;){for(A=x,L=u,N=new D,S=v+y,k=v+p;v<S;)Y(A[L++],N),$n(N,m,v,g,c,l),v+=g,l+=g;v<k&&(Y(A[L++],N),$n(N,m,v,_,c,l),v+=_,l+=_),++f&w||(u+=b)}break;case 3:if(p==c&&g==l&&0<u.b){for(v=c,p=m=l+(d-f)*m-(y=(d-f)*R(u.Ea,u.b)),g=c,w=l,b=[],y=(_=y)-1;0<=y;--y)b[y]=g[w+y];for(y=_-1;0<=y;--y)v[p+y]=b[y];Yn(u,f,d,c,m,c,l)}else Yn(u,f,d,p,g,c,l)}l=a,c=i}c!=i&&r(a,i,l,c,o)}function xt(t,n){var r=t.V,i=t.Ba+t.c*t.C,a=n-t.C;if(e(n<=t.l.o),e(16>=a),0<a){var s=t.l,o=t.Ta,h=t.Ua,l=s.width;if(_t(t,a,r,i),a=h=[h],e((r=t.C)<(i=n)),e(s.v<s.va),i>s.o&&(i=s.o),r<s.j){var c=s.j-r;r=s.j,a[0]+=c*l}if(r>=i?r=0:(a[0]+=4*s.v,s.ka=r-s.j,s.U=s.va-s.v,s.T=i-r,r=1),r){if(h=h[0],11>(r=t.ca).S){var u=r.f.RGBA,f=(i=r.S,a=s.U,s=s.T,c=u.eb,u.A),d=s;for(u=u.fb+t.Ma*u.A;0<d--;){var p=o,g=h,m=a,b=c,v=u;switch(i){case Br:Qn(p,g,m,b,v);break;case Mr:tr(p,g,m,b,v);break;case Ur:tr(p,g,m,b,v),xr(b,v,0,m,1,0);break;case Rr:rr(p,g,m,b,v);break;case Tr:et(p,g,m,b,v,1);break;case Hr:et(p,g,m,b,v,1),xr(b,v,0,m,1,0);break;case qr:et(p,g,m,b,v,0);break;case Wr:et(p,g,m,b,v,0),xr(b,v,1,m,1,0);break;case Dr:er(p,g,m,b,v);break;case Vr:er(p,g,m,b,v),Ar(b,v,m,1,0);break;case zr:nr(p,g,m,b,v);break;default:e(0)}h+=l,u+=f}t.Ma+=s}else alert("todo:EmitRescaledRowsYUVA");e(t.Ma<=r.height)}}t.C=n,e(t.C<=t.i)}function At(t){var e;if(0<t.ua)return 0;for(e=0;e<t.Wb;++e){var n=t.Ya[e].G,r=t.Ya[e].H;if(0<n[1][r[1]+0].g||0<n[2][r[2]+0].g||0<n[3][r[3]+0].g)return 0}return 1}function Lt(t,n,r,i,a,s){if(0!=t.Z){var o=t.qd,h=t.rd;for(e(null!=gi[t.Z]);n<r;++n)gi[t.Z](o,h,i,a,i,a,s),o=i,h=a,a+=s;t.qd=o,t.rd=h}}function Nt(t,n){var r=t.l.ma,i=0==r.Z||1==r.Z?t.l.j:t.C;if(i=t.C<i?i:t.C,e(n<=t.l.o),n>i){var a=t.l.width,s=r.ca,o=r.tb+a*i,h=t.V,l=t.Ba+t.c*i,c=t.gc;e(1==t.ab),e(3==c[0].hc),Jn(c[0],i,n,h,l,s,o),Lt(r,i,n,s,o,a)}t.C=t.Ma=n}function St(t,n,r,i,a,s,o){var h=t.$/i,l=t.$%i,c=t.m,u=t.s,f=r+t.$,d=f;a=r+i*a;var p=r+i*s,g=280+u.ua,m=t.Pb?h:16777216,b=0<u.ua?u.Wa:null,v=u.wc,w=f<p?yt(u,l,h):null;e(t.C<s),e(p<=a);var y=!1;t:for(;;){for(;y||f<p;){var _=0;if(h>=m){var S=f-r;e((m=t).Pb),m.wd=m.m,m.xd=S,0<m.s.ua&&O(m.s.Wa,m.s.vb),m=h+Qr}if(l&v||(w=yt(u,l,h)),e(null!=w),w.Qb&&(n[f]=w.qb,y=!0),!y)if(N(c),w.jc){_=c,S=n;var k=f,P=w.pd[x(_)&Tn-1];e(w.jc),256>P.g?(L(_,_.u+P.g),S[k]=P.value,_=0):(L(_,_.u+P.g-256),e(256<=P.value),_=P.value),0==_&&(y=!0)}else _=vt(w.G[0],w.H[0],c);if(c.h)break;if(y||256>_){if(!y)if(w.nd)n[f]=(w.qb|_<<8)>>>0;else{if(N(c),y=vt(w.G[1],w.H[1],c),N(c),S=vt(w.G[2],w.H[2],c),k=vt(w.G[3],w.H[3],c),c.h)break;n[f]=(k<<24|y<<16|_<<8|S)>>>0}if(y=!1,++f,++l>=i&&(l=0,++h,null!=o&&h<=s&&!(h%16)&&o(t,h),null!=b))for(;d<f;)_=n[d++],b.X[(506832829*_&4294967295)>>>b.Mb]=_}else if(280>_){if(_=mt(_-256,c),S=vt(w.G[4],w.H[4],c),N(c),S=bt(i,S=mt(S,c)),c.h)break;if(f-r<S||a-f<_)break t;for(k=0;k<_;++k)n[f+k]=n[f+k-S];for(f+=_,l+=_;l>=i;)l-=i,++h,null!=o&&h<=s&&!(h%16)&&o(t,h);if(e(f<=a),l&v&&(w=yt(u,l,h)),null!=b)for(;d<f;)_=n[d++],b.X[(506832829*_&4294967295)>>>b.Mb]=_}else{if(!(_<g))break t;for(y=_-280,e(null!=b);d<f;)_=n[d++],b.X[(506832829*_&4294967295)>>>b.Mb]=_;_=f,e(!(y>>>(S=b).Xa)),n[_]=S.X[y],y=!0}y||e(c.h==A(c))}if(t.Pb&&c.h&&f<a)e(t.m.h),t.a=5,t.m=t.wd,t.$=t.xd,0<t.s.ua&&O(t.s.vb,t.s.Wa);else{if(c.h)break t;null!=o&&o(t,h>s?s:h),t.a=0,t.$=f-r}return 1}return t.a=3,0}function kt(t){e(null!=t),t.vc=null,t.yc=null,t.Ya=null;var n=t.Wa;null!=n&&(n.X=null),t.vb=null,e(null!=t)}function Pt(){var e=new sn;return null==e?null:(e.a=0,e.xb=pi,nt("Predictor","VP8LPredictors"),nt("Predictor","VP8LPredictors_C"),nt("PredictorAdd","VP8LPredictorsAdd"),nt("PredictorAdd","VP8LPredictorsAdd_C"),Gn=G,$n=Z,Qn=X,tr=K,er=$,nr=Q,rr=tt,t.VP8LMapColor32b=Zn,t.VP8LMapColor8b=Xn,e)}function Ft(t,n,r,o,h){var l=1,f=[t],p=[n],g=o.m,m=o.s,b=null,v=0;t:for(;;){if(r)for(;l&&w(g,1);){var y=f,_=p,A=o,S=1,k=A.m,P=A.gc[A.ab],F=w(k,2);if(A.Oc&1<<F)l=0;else{switch(A.Oc|=1<<F,P.hc=F,P.Ea=y[0],P.nc=_[0],P.K=[null],++A.ab,e(4>=A.ab),F){case 0:case 1:P.b=w(k,3)+2,S=Ft(R(P.Ea,P.b),R(P.nc,P.b),0,A,P.K),P.K=P.K[0];break;case 3:var I,C=w(k,8)+1,j=16<C?0:4<C?1:2<C?2:3;if(y[0]=R(P.Ea,j),P.b=j,I=S=Ft(C,1,0,A,P.K)){var O,B=C,M=P,q=1<<(8>>M.b),D=a(q);if(null==D)I=0;else{var z=M.K[0],U=M.w;for(D[0]=M.K[0][0],O=1;O<1*B;++O)D[O]=T(z[U+O],D[O-1]);for(;O<4*q;++O)D[O]=0;M.K[0]=null,M.K[0]=D,I=1}}S=I;break;case 2:break;default:e(0)}l=S}}if(f=f[0],p=p[0],l&&w(g,1)&&!(l=1<=(v=w(g,4))&&11>=v)){o.a=3;break t}var H;if(H=l)e:{var W,V,G,Y=o,Z=f,J=p,X=v,K=r,$=Y.m,Q=Y.s,tt=[null],et=1,nt=0,rt=$r[X];n:for(;;){if(K&&w($,1)){var it=w($,3)+2,at=R(Z,it),st=R(J,it),ot=at*st;if(!Ft(at,st,0,Y,tt))break n;for(tt=tt[0],Q.xc=it,W=0;W<ot;++W){var ht=tt[W]>>8&65535;tt[W]=ht,ht>=et&&(et=ht+1)}}if($.h)break n;for(V=0;5>V;++V){var lt=Zr[V];!V&&0<X&&(lt+=1<<X),nt<lt&&(nt=lt)}var ct=s(et*rt,u),ut=et,ft=s(ut,d);if(null==ft)var dt=null;else e(65536>=ut),dt=ft;var pt=a(nt);if(null==dt||null==pt||null==ct){Y.a=1;break n}var gt=ct;for(W=G=0;W<et;++W){var mt=dt[W],bt=mt.G,vt=mt.H,yt=0,_t=1,xt=0;for(V=0;5>V;++V){lt=Zr[V],bt[V]=gt,vt[V]=G,!V&&0<X&&(lt+=1<<X);r:{var At,Lt=lt,Nt=Y,Pt=pt,It=gt,Ct=G,jt=0,Et=Nt.m,Ot=w(Et,1);if(i(Pt,0,0,Lt),Ot){var Bt=w(Et,1)+1,Mt=w(Et,1),Rt=w(Et,0==Mt?1:8);Pt[Rt]=1,2==Bt&&(Pt[Rt=w(Et,8)]=1);var Tt=1}else{var qt=a(19),Dt=w(Et,4)+4;if(19<Dt){Nt.a=3;var zt=0;break r}for(At=0;At<Dt;++At)qt[Xr[At]]=w(Et,3);var Ut=void 0,Ht=void 0,Wt=Nt,Vt=qt,Gt=Lt,Yt=Pt,Zt=0,Jt=Wt.m,Xt=8,Kt=s(128,u);i:for(;c(Kt,0,7,Vt,19);){if(w(Jt,1)){var $t=2+2*w(Jt,3);if((Ut=2+w(Jt,$t))>Gt)break i}else Ut=Gt;for(Ht=0;Ht<Gt&&Ut--;){N(Jt);var Qt=Kt[0+(127&x(Jt))];L(Jt,Jt.u+Qt.g);var te=Qt.value;if(16>te)Yt[Ht++]=te,0!=te&&(Xt=te);else{var ee=16==te,ne=te-16,re=Yr[ne],ie=w(Jt,Gr[ne])+re;if(Ht+ie>Gt)break i;for(var ae=ee?Xt:0;0<ie--;)Yt[Ht++]=ae}}Zt=1;break i}Zt||(Wt.a=3),Tt=Zt}(Tt=Tt&&!Et.h)&&(jt=c(It,Ct,8,Pt,Lt)),Tt&&0!=jt?zt=jt:(Nt.a=3,zt=0)}if(0==zt)break n;if(_t&&1==Jr[V]&&(_t=0==gt[G].g),yt+=gt[G].g,G+=zt,3>=V){var se,oe=pt[0];for(se=1;se<lt;++se)pt[se]>oe&&(oe=pt[se]);xt+=oe}}if(mt.nd=_t,mt.Qb=0,_t&&(mt.qb=(bt[3][vt[3]+0].value<<24|bt[1][vt[1]+0].value<<16|bt[2][vt[2]+0].value)>>>0,0==yt&&256>bt[0][vt[0]+0].value&&(mt.Qb=1,mt.qb+=bt[0][vt[0]+0].value<<8)),mt.jc=!mt.Qb&&6>xt,mt.jc){var he,le=mt;for(he=0;he<Tn;++he){var ce=he,ue=le.pd[ce],fe=le.G[0][le.H[0]+ce];256<=fe.value?(ue.g=fe.g+256,ue.value=fe.value):(ue.g=0,ue.value=0,ce>>=wt(fe,8,ue),ce>>=wt(le.G[1][le.H[1]+ce],16,ue),ce>>=wt(le.G[2][le.H[2]+ce],0,ue),wt(le.G[3][le.H[3]+ce],24,ue))}}}Q.vc=tt,Q.Wb=et,Q.Ya=dt,Q.yc=ct,H=1;break e}H=0}if(!(l=H)){o.a=3;break t}if(0<v){if(m.ua=1<<v,!E(m.Wa,v)){o.a=1,l=0;break t}}else m.ua=0;var de=o,pe=f,ge=p,me=de.s,be=me.xc;if(de.c=pe,de.i=ge,me.md=R(pe,be),me.wc=0==be?-1:(1<<be)-1,r){o.xb=di;break t}if(null==(b=a(f*p))){o.a=1,l=0;break t}l=(l=St(o,b,0,f,p,p,null))&&!g.h;break t}return l?(null!=h?h[0]=b:(e(null==b),e(r)),o.$=0,r||kt(m)):kt(m),l}function It(t,n){var r=t.c*t.i,i=r+n+16*n;return e(t.c<=n),t.V=a(i),null==t.V?(t.Ta=null,t.Ua=0,t.a=1,0):(t.Ta=t.V,t.Ua=t.Ba+r+n,1)}function Ct(t,n){var r=t.C,i=n-r,a=t.V,s=t.Ba+t.c*r;for(e(n<=t.l.o);0<i;){var o=16<i?16:i,h=t.l.ma,l=t.l.width,c=l*o,u=h.ca,f=h.tb+l*r,d=t.Ta,p=t.Ua;_t(t,o,a,s),Nr(d,p,u,f,c),Lt(h,r,r+o,u,f,l),i-=o,a+=o*t.c,r+=o}e(r==n),t.C=t.Ma=n}function jt(){this.ub=this.yd=this.td=this.Rb=0}function Et(){this.Kd=this.Ld=this.Ud=this.Td=this.i=this.c=0}function Ot(){this.Fb=this.Bb=this.Cb=0,this.Zb=a(4),this.Lb=a(4)}function Bt(){this.Yb=function(){var t=[];return function t(e,n,r){for(var i=r[n],a=0;a<i&&(e.push(r.length>n+1?[]:0),!(r.length<n+1));a++)t(e[a],n+1,r)}(t,0,[3,11]),t}()}function Mt(){this.jb=a(3),this.Wc=o([4,8],Bt),this.Xc=o([4,17],Bt)}function Rt(){this.Pc=this.wb=this.Tb=this.zd=0,this.vd=new a(4),this.od=new a(4)}function Tt(){this.ld=this.La=this.dd=this.tc=0}function qt(){this.Na=this.la=0}function Dt(){this.Sc=[0,0],this.Eb=[0,0],this.Qc=[0,0],this.ia=this.lc=0}function zt(){this.ad=a(384),this.Za=0,this.Ob=a(16),this.$b=this.Ad=this.ia=this.Gc=this.Hc=this.Dd=0}function Ut(){this.uc=this.M=this.Nb=0,this.wa=Array(new Tt),this.Y=0,this.ya=Array(new zt),this.aa=0,this.l=new Gt}function Ht(){this.y=a(16),this.f=a(8),this.ea=a(8)}function Wt(){this.cb=this.a=0,this.sc="",this.m=new y,this.Od=new jt,this.Kc=new Et,this.ed=new Rt,this.Qa=new Ot,this.Ic=this.$c=this.Aa=0,this.D=new Ut,this.Xb=this.Va=this.Hb=this.zb=this.yb=this.Ub=this.za=0,this.Jc=s(8,y),this.ia=0,this.pb=s(4,Dt),this.Pa=new Mt,this.Bd=this.kc=0,this.Ac=[],this.Bc=0,this.zc=[0,0,0,0],this.Gd=Array(new Ht),this.Hd=0,this.rb=Array(new qt),this.sb=0,this.wa=Array(new Tt),this.Y=0,this.oc=[],this.pc=0,this.sa=[],this.ta=0,this.qa=[],this.ra=0,this.Ha=[],this.B=this.R=this.Ia=0,this.Ec=[],this.M=this.ja=this.Vb=this.Fc=0,this.ya=Array(new zt),this.L=this.aa=0,this.gd=o([4,2],Tt),this.ga=null,this.Fa=[],this.Cc=this.qc=this.P=0,this.Gb=[],this.Uc=0,this.mb=[],this.nb=0,this.rc=[],this.Ga=this.Vc=0}function Vt(t,e){return 0>t?0:t>e?e:t}function Gt(){this.T=this.U=this.ka=this.height=this.width=0,this.y=[],this.f=[],this.ea=[],this.Rc=this.fa=this.W=this.N=this.O=0,this.ma="void",this.put="VP8IoPutHook",this.ac="VP8IoSetupHook",this.bc="VP8IoTeardownHook",this.ha=this.Kb=0,this.data=[],this.hb=this.ib=this.da=this.o=this.j=this.va=this.v=this.Da=this.ob=this.w=0,this.F=[],this.J=0}function Yt(){var t=new Wt;return null!=t&&(t.a=0,t.sc="OK",t.cb=0,t.Xb=0,ni||(ni=Kt)),t}function Zt(t,e,n){return 0==t.a&&(t.a=e,t.sc=n,t.cb=0),0}function Jt(t,e,n){return 3<=n&&157==t[e+0]&&1==t[e+1]&&42==t[e+2]}function Xt(t,n){if(null==t)return 0;if(t.a=0,t.sc="OK",null==n)return Zt(t,2,"null VP8Io passed to VP8GetHeaders()");var r=n.data,a=n.w,s=n.ha;if(4>s)return Zt(t,7,"Truncated header.");var o=r[a+0]|r[a+1]<<8|r[a+2]<<16,h=t.Od;if(h.Rb=!(1&o),h.td=o>>1&7,h.yd=o>>4&1,h.ub=o>>5,3<h.td)return Zt(t,3,"Incorrect keyframe parameters.");if(!h.yd)return Zt(t,4,"Frame not displayable.");a+=3,s-=3;var l=t.Kc;if(h.Rb){if(7>s)return Zt(t,7,"cannot parse picture header");if(!Jt(r,a,s))return Zt(t,3,"Bad code word");l.c=16383&(r[a+4]<<8|r[a+3]),l.Td=r[a+4]>>6,l.i=16383&(r[a+6]<<8|r[a+5]),l.Ud=r[a+6]>>6,a+=7,s-=7,t.za=l.c+15>>4,t.Ub=l.i+15>>4,n.width=l.c,n.height=l.i,n.Da=0,n.j=0,n.v=0,n.va=n.width,n.o=n.height,n.da=0,n.ib=n.width,n.hb=n.height,n.U=n.width,n.T=n.height,i((o=t.Pa).jb,0,255,o.jb.length),e(null!=(o=t.Qa)),o.Cb=0,o.Bb=0,o.Fb=1,i(o.Zb,0,0,o.Zb.length),i(o.Lb,0,0,o.Lb)}if(h.ub>s)return Zt(t,7,"bad partition length");p(o=t.m,r,a,h.ub),a+=h.ub,s-=h.ub,h.Rb&&(l.Ld=k(o),l.Kd=k(o)),l=t.Qa;var c,u=t.Pa;if(e(null!=o),e(null!=l),l.Cb=k(o),l.Cb){if(l.Bb=k(o),k(o)){for(l.Fb=k(o),c=0;4>c;++c)l.Zb[c]=k(o)?m(o,7):0;for(c=0;4>c;++c)l.Lb[c]=k(o)?m(o,6):0}if(l.Bb)for(c=0;3>c;++c)u.jb[c]=k(o)?g(o,8):255}else l.Bb=0;if(o.Ka)return Zt(t,3,"cannot parse segment header");if((l=t.ed).zd=k(o),l.Tb=g(o,6),l.wb=g(o,3),l.Pc=k(o),l.Pc&&k(o)){for(u=0;4>u;++u)k(o)&&(l.vd[u]=m(o,6));for(u=0;4>u;++u)k(o)&&(l.od[u]=m(o,6))}if(t.L=0==l.Tb?0:l.zd?1:2,o.Ka)return Zt(t,3,"cannot parse filter header");var f=s;if(s=c=a,a=c+f,l=f,t.Xb=(1<<g(t.m,2))-1,f<3*(u=t.Xb))r=7;else{for(c+=3*u,l-=3*u,f=0;f<u;++f){var d=r[s+0]|r[s+1]<<8|r[s+2]<<16;d>l&&(d=l),p(t.Jc[+f],r,c,d),c+=d,l-=d,s+=3}p(t.Jc[+u],r,c,l),r=c<a?0:5}if(0!=r)return Zt(t,r,"cannot parse partitions");for(r=g(c=t.m,7),s=k(c)?m(c,4):0,a=k(c)?m(c,4):0,l=k(c)?m(c,4):0,u=k(c)?m(c,4):0,c=k(c)?m(c,4):0,f=t.Qa,d=0;4>d;++d){if(f.Cb){var b=f.Zb[d];f.Fb||(b+=r)}else{if(0<d){t.pb[d]=t.pb[0];continue}b=r}var v=t.pb[d];v.Sc[0]=ti[Vt(b+s,127)],v.Sc[1]=ei[Vt(b+0,127)],v.Eb[0]=2*ti[Vt(b+a,127)],v.Eb[1]=101581*ei[Vt(b+l,127)]>>16,8>v.Eb[1]&&(v.Eb[1]=8),v.Qc[0]=ti[Vt(b+u,117)],v.Qc[1]=ei[Vt(b+c,127)],v.lc=b+c}if(!h.Rb)return Zt(t,4,"Not a key frame.");for(k(o),h=t.Pa,r=0;4>r;++r){for(s=0;8>s;++s)for(a=0;3>a;++a)for(l=0;11>l;++l)u=P(o,hi[r][s][a][l])?g(o,8):si[r][s][a][l],h.Wc[r][s].Yb[a][l]=u;for(s=0;17>s;++s)h.Xc[r][s]=h.Wc[r][li[s]]}return t.kc=k(o),t.kc&&(t.Bd=g(o,8)),t.cb=1}function Kt(t,e,n,r,i,a,s){var o=e[i].Yb[n];for(n=0;16>i;++i){if(!P(t,o[n+0]))return i;for(;!P(t,o[n+1]);)if(o=e[++i].Yb[0],n=0,16==i)return 16;var h=e[i+1].Yb;if(P(t,o[n+2])){var l=t,c=0;if(P(l,(f=o)[(u=n)+3]))if(P(l,f[u+6])){for(o=0,u=2*(c=P(l,f[u+8]))+(f=P(l,f[u+9+c])),c=0,f=ri[u];f[o];++o)c+=c+P(l,f[o]);c+=3+(8<<u)}else P(l,f[u+7])?(c=7+2*P(l,165),c+=P(l,145)):c=5+P(l,159);else c=P(l,f[u+4])?3+P(l,f[u+5]):2;o=h[2]}else c=1,o=h[1];h=s+ii[i],0>(l=t).b&&S(l);var u,f=l.b,d=(u=l.Ca>>1)-(l.I>>f)>>31;--l.b,l.Ca+=d,l.Ca|=1,l.I-=(u+1&d)<<f,a[h]=((c^d)-d)*r[(0<i)+0]}return 16}function $t(t){var e=t.rb[t.sb-1];e.la=0,e.Na=0,i(t.zc,0,0,t.zc.length),t.ja=0}function Qt(t,e,n,r,i){i=t[e+n+32*r]+(i>>3),t[e+n+32*r]=-256&i?0>i?0:255:i}function te(t,e,n,r,i,a){Qt(t,e,0,n,r+i),Qt(t,e,1,n,r+a),Qt(t,e,2,n,r-a),Qt(t,e,3,n,r-i)}function ee(t){return(20091*t>>16)+t}function ne(t,e,n,r){var i,s=0,o=a(16);for(i=0;4>i;++i){var h=t[e+0]+t[e+8],l=t[e+0]-t[e+8],c=(35468*t[e+4]>>16)-ee(t[e+12]),u=ee(t[e+4])+(35468*t[e+12]>>16);o[s+0]=h+u,o[s+1]=l+c,o[s+2]=l-c,o[s+3]=h-u,s+=4,e++}for(i=s=0;4>i;++i)h=(t=o[s+0]+4)+o[s+8],l=t-o[s+8],c=(35468*o[s+4]>>16)-ee(o[s+12]),Qt(n,r,0,0,h+(u=ee(o[s+4])+(35468*o[s+12]>>16))),Qt(n,r,1,0,l+c),Qt(n,r,2,0,l-c),Qt(n,r,3,0,h-u),s++,r+=32}function re(t,e,n,r){var i=t[e+0]+4,a=35468*t[e+4]>>16,s=ee(t[e+4]),o=35468*t[e+1]>>16;te(n,r,0,i+s,t=ee(t[e+1]),o),te(n,r,1,i+a,t,o),te(n,r,2,i-a,t,o),te(n,r,3,i-s,t,o)}function ie(t,e,n,r,i){ne(t,e,n,r),i&&ne(t,e+16,n,r+4)}function ae(t,e,n,r){ar(t,e+0,n,r,1),ar(t,e+32,n,r+128,1)}function se(t,e,n,r){var i;for(t=t[e+0]+4,i=0;4>i;++i)for(e=0;4>e;++e)Qt(n,r,e,i,t)}function oe(t,e,n,r){t[e+0]&&hr(t,e+0,n,r),t[e+16]&&hr(t,e+16,n,r+4),t[e+32]&&hr(t,e+32,n,r+128),t[e+48]&&hr(t,e+48,n,r+128+4)}function he(t,e,n,r){var i,s=a(16);for(i=0;4>i;++i){var o=t[e+0+i]+t[e+12+i],h=t[e+4+i]+t[e+8+i],l=t[e+4+i]-t[e+8+i],c=t[e+0+i]-t[e+12+i];s[0+i]=o+h,s[8+i]=o-h,s[4+i]=c+l,s[12+i]=c-l}for(i=0;4>i;++i)o=(t=s[0+4*i]+3)+s[3+4*i],h=s[1+4*i]+s[2+4*i],l=s[1+4*i]-s[2+4*i],c=t-s[3+4*i],n[r+0]=o+h>>3,n[r+16]=c+l>>3,n[r+32]=o-h>>3,n[r+48]=c-l>>3,r+=64}function le(t,e,n){var r,i=e-32,a=Er,s=255-t[i-1];for(r=0;r<n;++r){var o,h=a,l=s+t[e-1];for(o=0;o<n;++o)t[e+o]=h[l+t[i+o]];e+=32}}function ce(t,e){le(t,e,4)}function ue(t,e){le(t,e,8)}function fe(t,e){le(t,e,16)}function de(t,e){var n;for(n=0;16>n;++n)r(t,e+32*n,t,e-32,16)}function pe(t,e){var n;for(n=16;0<n;--n)i(t,e,t[e-1],16),e+=32}function ge(t,e,n){var r;for(r=0;16>r;++r)i(e,n+32*r,t,16)}function me(t,e){var n,r=16;for(n=0;16>n;++n)r+=t[e-1+32*n]+t[e+n-32];ge(r>>5,t,e)}function be(t,e){var n,r=8;for(n=0;16>n;++n)r+=t[e-1+32*n];ge(r>>4,t,e)}function ve(t,e){var n,r=8;for(n=0;16>n;++n)r+=t[e+n-32];ge(r>>4,t,e)}function we(t,e){ge(128,t,e)}function ye(t,e,n){return t+2*e+n+2>>2}function _e(t,e){var n,i=e-32;for(i=new Uint8Array([ye(t[i-1],t[i+0],t[i+1]),ye(t[i+0],t[i+1],t[i+2]),ye(t[i+1],t[i+2],t[i+3]),ye(t[i+2],t[i+3],t[i+4])]),n=0;4>n;++n)r(t,e+32*n,i,0,i.length)}function xe(t,e){var n=t[e-1],r=t[e-1+32],i=t[e-1+64],a=t[e-1+96];F(t,e+0,16843009*ye(t[e-1-32],n,r)),F(t,e+32,16843009*ye(n,r,i)),F(t,e+64,16843009*ye(r,i,a)),F(t,e+96,16843009*ye(i,a,a))}function Ae(t,e){var n,r=4;for(n=0;4>n;++n)r+=t[e+n-32]+t[e-1+32*n];for(r>>=3,n=0;4>n;++n)i(t,e+32*n,r,4)}function Le(t,e){var n=t[e-1+0],r=t[e-1+32],i=t[e-1+64],a=t[e-1-32],s=t[e+0-32],o=t[e+1-32],h=t[e+2-32],l=t[e+3-32];t[e+0+96]=ye(r,i,t[e-1+96]),t[e+1+96]=t[e+0+64]=ye(n,r,i),t[e+2+96]=t[e+1+64]=t[e+0+32]=ye(a,n,r),t[e+3+96]=t[e+2+64]=t[e+1+32]=t[e+0+0]=ye(s,a,n),t[e+3+64]=t[e+2+32]=t[e+1+0]=ye(o,s,a),t[e+3+32]=t[e+2+0]=ye(h,o,s),t[e+3+0]=ye(l,h,o)}function Ne(t,e){var n=t[e+1-32],r=t[e+2-32],i=t[e+3-32],a=t[e+4-32],s=t[e+5-32],o=t[e+6-32],h=t[e+7-32];t[e+0+0]=ye(t[e+0-32],n,r),t[e+1+0]=t[e+0+32]=ye(n,r,i),t[e+2+0]=t[e+1+32]=t[e+0+64]=ye(r,i,a),t[e+3+0]=t[e+2+32]=t[e+1+64]=t[e+0+96]=ye(i,a,s),t[e+3+32]=t[e+2+64]=t[e+1+96]=ye(a,s,o),t[e+3+64]=t[e+2+96]=ye(s,o,h),t[e+3+96]=ye(o,h,h)}function Se(t,e){var n=t[e-1+0],r=t[e-1+32],i=t[e-1+64],a=t[e-1-32],s=t[e+0-32],o=t[e+1-32],h=t[e+2-32],l=t[e+3-32];t[e+0+0]=t[e+1+64]=a+s+1>>1,t[e+1+0]=t[e+2+64]=s+o+1>>1,t[e+2+0]=t[e+3+64]=o+h+1>>1,t[e+3+0]=h+l+1>>1,t[e+0+96]=ye(i,r,n),t[e+0+64]=ye(r,n,a),t[e+0+32]=t[e+1+96]=ye(n,a,s),t[e+1+32]=t[e+2+96]=ye(a,s,o),t[e+2+32]=t[e+3+96]=ye(s,o,h),t[e+3+32]=ye(o,h,l)}function ke(t,e){var n=t[e+0-32],r=t[e+1-32],i=t[e+2-32],a=t[e+3-32],s=t[e+4-32],o=t[e+5-32],h=t[e+6-32],l=t[e+7-32];t[e+0+0]=n+r+1>>1,t[e+1+0]=t[e+0+64]=r+i+1>>1,t[e+2+0]=t[e+1+64]=i+a+1>>1,t[e+3+0]=t[e+2+64]=a+s+1>>1,t[e+0+32]=ye(n,r,i),t[e+1+32]=t[e+0+96]=ye(r,i,a),t[e+2+32]=t[e+1+96]=ye(i,a,s),t[e+3+32]=t[e+2+96]=ye(a,s,o),t[e+3+64]=ye(s,o,h),t[e+3+96]=ye(o,h,l)}function Pe(t,e){var n=t[e-1+0],r=t[e-1+32],i=t[e-1+64],a=t[e-1+96];t[e+0+0]=n+r+1>>1,t[e+2+0]=t[e+0+32]=r+i+1>>1,t[e+2+32]=t[e+0+64]=i+a+1>>1,t[e+1+0]=ye(n,r,i),t[e+3+0]=t[e+1+32]=ye(r,i,a),t[e+3+32]=t[e+1+64]=ye(i,a,a),t[e+3+64]=t[e+2+64]=t[e+0+96]=t[e+1+96]=t[e+2+96]=t[e+3+96]=a}function Fe(t,e){var n=t[e-1+0],r=t[e-1+32],i=t[e-1+64],a=t[e-1+96],s=t[e-1-32],o=t[e+0-32],h=t[e+1-32],l=t[e+2-32];t[e+0+0]=t[e+2+32]=n+s+1>>1,t[e+0+32]=t[e+2+64]=r+n+1>>1,t[e+0+64]=t[e+2+96]=i+r+1>>1,t[e+0+96]=a+i+1>>1,t[e+3+0]=ye(o,h,l),t[e+2+0]=ye(s,o,h),t[e+1+0]=t[e+3+32]=ye(n,s,o),t[e+1+32]=t[e+3+64]=ye(r,n,s),t[e+1+64]=t[e+3+96]=ye(i,r,n),t[e+1+96]=ye(a,i,r)}function Ie(t,e){var n;for(n=0;8>n;++n)r(t,e+32*n,t,e-32,8)}function Ce(t,e){var n;for(n=0;8>n;++n)i(t,e,t[e-1],8),e+=32}function je(t,e,n){var r;for(r=0;8>r;++r)i(e,n+32*r,t,8)}function Ee(t,e){var n,r=8;for(n=0;8>n;++n)r+=t[e+n-32]+t[e-1+32*n];je(r>>4,t,e)}function Oe(t,e){var n,r=4;for(n=0;8>n;++n)r+=t[e+n-32];je(r>>3,t,e)}function Be(t,e){var n,r=4;for(n=0;8>n;++n)r+=t[e-1+32*n];je(r>>3,t,e)}function Me(t,e){je(128,t,e)}function Re(t,e,n){var r=t[e-n],i=t[e+0],a=3*(i-r)+Cr[1020+t[e-2*n]-t[e+n]],s=jr[112+(a+4>>3)];t[e-n]=Er[255+r+jr[112+(a+3>>3)]],t[e+0]=Er[255+i-s]}function Te(t,e,n,r){var i=t[e+0],a=t[e+n];return Or[255+t[e-2*n]-t[e-n]]>r||Or[255+a-i]>r}function qe(t,e,n,r){return 4*Or[255+t[e-n]-t[e+0]]+Or[255+t[e-2*n]-t[e+n]]<=r}function De(t,e,n,r,i){var a=t[e-3*n],s=t[e-2*n],o=t[e-n],h=t[e+0],l=t[e+n],c=t[e+2*n],u=t[e+3*n];return 4*Or[255+o-h]+Or[255+s-l]>r?0:Or[255+t[e-4*n]-a]<=i&&Or[255+a-s]<=i&&Or[255+s-o]<=i&&Or[255+u-c]<=i&&Or[255+c-l]<=i&&Or[255+l-h]<=i}function ze(t,e,n,r){var i=2*r+1;for(r=0;16>r;++r)qe(t,e+r,n,i)&&Re(t,e+r,n)}function Ue(t,e,n,r){var i=2*r+1;for(r=0;16>r;++r)qe(t,e+r*n,1,i)&&Re(t,e+r*n,1)}function He(t,e,n,r){var i;for(i=3;0<i;--i)ze(t,e+=4*n,n,r)}function We(t,e,n,r){var i;for(i=3;0<i;--i)Ue(t,e+=4,n,r)}function Ve(t,e,n,r,i,a,s,o){for(a=2*a+1;0<i--;){if(De(t,e,n,a,s))if(Te(t,e,n,o))Re(t,e,n);else{var h=t,l=e,c=n,u=h[l-2*c],f=h[l-c],d=h[l+0],p=h[l+c],g=h[l+2*c],m=27*(v=Cr[1020+3*(d-f)+Cr[1020+u-p]])+63>>7,b=18*v+63>>7,v=9*v+63>>7;h[l-3*c]=Er[255+h[l-3*c]+v],h[l-2*c]=Er[255+u+b],h[l-c]=Er[255+f+m],h[l+0]=Er[255+d-m],h[l+c]=Er[255+p-b],h[l+2*c]=Er[255+g-v]}e+=r}}function Ge(t,e,n,r,i,a,s,o){for(a=2*a+1;0<i--;){if(De(t,e,n,a,s))if(Te(t,e,n,o))Re(t,e,n);else{var h=t,l=e,c=n,u=h[l-c],f=h[l+0],d=h[l+c],p=jr[112+(4+(g=3*(f-u))>>3)],g=jr[112+(g+3>>3)],m=p+1>>1;h[l-2*c]=Er[255+h[l-2*c]+m],h[l-c]=Er[255+u+g],h[l+0]=Er[255+f-p],h[l+c]=Er[255+d-m]}e+=r}}function Ye(t,e,n,r,i,a){Ve(t,e,n,1,16,r,i,a)}function Ze(t,e,n,r,i,a){Ve(t,e,1,n,16,r,i,a)}function Je(t,e,n,r,i,a){var s;for(s=3;0<s;--s)Ge(t,e+=4*n,n,1,16,r,i,a)}function Xe(t,e,n,r,i,a){var s;for(s=3;0<s;--s)Ge(t,e+=4,1,n,16,r,i,a)}function Ke(t,e,n,r,i,a,s,o){Ve(t,e,i,1,8,a,s,o),Ve(n,r,i,1,8,a,s,o)}function $e(t,e,n,r,i,a,s,o){Ve(t,e,1,i,8,a,s,o),Ve(n,r,1,i,8,a,s,o)}function Qe(t,e,n,r,i,a,s,o){Ge(t,e+4*i,i,1,8,a,s,o),Ge(n,r+4*i,i,1,8,a,s,o)}function tn(t,e,n,r,i,a,s,o){Ge(t,e+4,1,i,8,a,s,o),Ge(n,r+4,1,i,8,a,s,o)}function en(){this.ba=new st,this.ec=[],this.cc=[],this.Mc=[],this.Dc=this.Nc=this.dc=this.fc=0,this.Oa=new ht,this.memory=0,this.Ib="OutputFunc",this.Jb="OutputAlphaFunc",this.Nd="OutputRowFunc"}function nn(){this.data=[],this.offset=this.kd=this.ha=this.w=0,this.na=[],this.xa=this.gb=this.Ja=this.Sa=this.P=0}function rn(){this.nc=this.Ea=this.b=this.hc=0,this.K=[],this.w=0}function an(){this.ua=0,this.Wa=new B,this.vb=new B,this.md=this.xc=this.wc=0,this.vc=[],this.Wb=0,this.Ya=new d,this.yc=new u}function sn(){this.xb=this.a=0,this.l=new Gt,this.ca=new st,this.V=[],this.Ba=0,this.Ta=[],this.Ua=0,this.m=new _,this.Pb=0,this.wd=new _,this.Ma=this.$=this.C=this.i=this.c=this.xd=0,this.s=new an,this.ab=0,this.gc=s(4,rn),this.Oc=0}function on(){this.Lc=this.Z=this.$a=this.i=this.c=0,this.l=new Gt,this.ic=0,this.ca=[],this.tb=0,this.qd=null,this.rd=0}function hn(t,e,n,r,i,a,s){for(t=null==t?0:t[e+0],e=0;e<s;++e)i[a+e]=t+n[r+e]&255,t=i[a+e]}function ln(t,e,n,r,i,a,s){var o;if(null==t)hn(null,null,n,r,i,a,s);else for(o=0;o<s;++o)i[a+o]=t[e+o]+n[r+o]&255}function cn(t,e,n,r,i,a,s){if(null==t)hn(null,null,n,r,i,a,s);else{var o,h=t[e+0],l=h,c=h;for(o=0;o<s;++o)l=c+(h=t[e+o])-l,c=n[r+o]+(-256&l?0>l?0:255:l)&255,l=h,i[a+o]=c}}function un(t,n,i,s){var o=n.width,h=n.o;if(e(null!=t&&null!=n),0>i||0>=s||i+s>h)return null;if(!t.Cc){if(null==t.ga){var l;if(t.ga=new on,(l=null==t.ga)||(l=n.width*n.o,e(0==t.Gb.length),t.Gb=a(l),t.Uc=0,null==t.Gb?l=0:(t.mb=t.Gb,t.nb=t.Uc,t.rc=null,l=1),l=!l),!l){l=t.ga;var c=t.Fa,u=t.P,f=t.qc,d=t.mb,p=t.nb,g=u+1,m=f-1,v=l.l;if(e(null!=c&&null!=d&&null!=n),gi[0]=null,gi[1]=hn,gi[2]=ln,gi[3]=cn,l.ca=d,l.tb=p,l.c=n.width,l.i=n.height,e(0<l.c&&0<l.i),1>=f)n=0;else if(l.$a=3&c[u+0],l.Z=c[u+0]>>2&3,l.Lc=c[u+0]>>4&3,u=c[u+0]>>6&3,0>l.$a||1<l.$a||4<=l.Z||1<l.Lc||u)n=0;else if(v.put=dt,v.ac=ft,v.bc=pt,v.ma=l,v.width=n.width,v.height=n.height,v.Da=n.Da,v.v=n.v,v.va=n.va,v.j=n.j,v.o=n.o,l.$a)t:{e(1==l.$a),n=Pt();e:for(;;){if(null==n){n=0;break t}if(e(null!=l),l.mc=n,n.c=l.c,n.i=l.i,n.l=l.l,n.l.ma=l,n.l.width=l.c,n.l.height=l.i,n.a=0,b(n.m,c,g,m),!Ft(l.c,l.i,1,n,null))break e;if(1==n.ab&&3==n.gc[0].hc&&At(n.s)?(l.ic=1,c=n.c*n.i,n.Ta=null,n.Ua=0,n.V=a(c),n.Ba=0,null==n.V?(n.a=1,n=0):n=1):(l.ic=0,n=It(n,l.c)),!n)break e;n=1;break t}l.mc=null,n=0}else n=m>=l.c*l.i;l=!n}if(l)return null;1!=t.ga.Lc?t.Ga=0:s=h-i}e(null!=t.ga),e(i+s<=h);t:{if(n=(c=t.ga).c,h=c.l.o,0==c.$a){if(g=t.rc,m=t.Vc,v=t.Fa,u=t.P+1+i*n,f=t.mb,d=t.nb+i*n,e(u<=t.P+t.qc),0!=c.Z)for(e(null!=gi[c.Z]),l=0;l<s;++l)gi[c.Z](g,m,v,u,f,d,n),g=f,m=d,d+=n,u+=n;else for(l=0;l<s;++l)r(f,d,v,u,n),g=f,m=d,d+=n,u+=n;t.rc=g,t.Vc=m}else{if(e(null!=c.mc),n=i+s,e(null!=(l=c.mc)),e(n<=l.i),l.C>=n)n=1;else if(c.ic||mn(),c.ic){c=l.V,g=l.Ba,m=l.c;var w=l.i,y=(v=1,u=l.$/m,f=l.$%m,d=l.m,p=l.s,l.$),_=m*w,x=m*n,L=p.wc,S=y<x?yt(p,f,u):null;e(y<=_),e(n<=w),e(At(p));e:for(;;){for(;!d.h&&y<x;){if(f&L||(S=yt(p,f,u)),e(null!=S),N(d),256>(w=vt(S.G[0],S.H[0],d)))c[g+y]=w,++y,++f>=m&&(f=0,++u<=n&&!(u%16)&&Nt(l,u));else{if(!(280>w)){v=0;break e}w=mt(w-256,d);var k,P=vt(S.G[4],S.H[4],d);if(N(d),!(y>=(P=bt(m,P=mt(P,d)))&&_-y>=w)){v=0;break e}for(k=0;k<w;++k)c[g+y+k]=c[g+y+k-P];for(y+=w,f+=w;f>=m;)f-=m,++u<=n&&!(u%16)&&Nt(l,u);y<x&&f&L&&(S=yt(p,f,u))}e(d.h==A(d))}Nt(l,u>n?n:u);break e}!v||d.h&&y<_?(v=0,l.a=d.h?5:3):l.$=y,n=v}else n=St(l,l.V,l.Ba,l.c,l.i,n,Ct);if(!n){s=0;break t}}i+s>=h&&(t.Cc=1),s=1}if(!s)return null;if(t.Cc&&(null!=(s=t.ga)&&(s.mc=null),t.ga=null,0<t.Ga))return alert("todo:WebPDequantizeLevels"),null}return t.nb+i*o}function fn(t,e,n,r,i,a){for(;0<i--;){var s,o=t,h=e+(n?1:0),l=t,c=e+(n?0:3);for(s=0;s<r;++s){var u=l[c+4*s];255!=u&&(u*=32897,o[h+4*s+0]=o[h+4*s+0]*u>>23,o[h+4*s+1]=o[h+4*s+1]*u>>23,o[h+4*s+2]=o[h+4*s+2]*u>>23)}e+=a}}function dn(t,e,n,r,i){for(;0<r--;){var a;for(a=0;a<n;++a){var s=t[e+2*a+0],o=15&(l=t[e+2*a+1]),h=4369*o,l=(240&l|l>>4)*h>>16;t[e+2*a+0]=(240&s|s>>4)*h>>16&240|(15&s|s<<4)*h>>16>>4&15,t[e+2*a+1]=240&l|o}e+=i}}function pn(t,e,n,r,i,a,s,o){var h,l,c=255;for(l=0;l<i;++l){for(h=0;h<r;++h){var u=t[e+h];a[s+4*h]=u,c&=u}e+=n,s+=o}return 255!=c}function gn(t,e,n,r,i){var a;for(a=0;a<i;++a)n[r+a]=t[e+a]>>8}function mn(){xr=fn,Ar=dn,Lr=pn,Nr=gn}function bn(n,r,i){t[n]=function(t,n,a,s,o,h,l,c,u,f,d,p,g,m,b,v,w){var y,_=w-1>>1,x=o[h+0]|l[c+0]<<16,A=u[f+0]|d[p+0]<<16;e(null!=t);var L=3*x+A+131074>>2;for(r(t[n+0],255&L,L>>16,g,m),null!=a&&(L=3*A+x+131074>>2,r(a[s+0],255&L,L>>16,b,v)),y=1;y<=_;++y){var N=o[h+y]|l[c+y]<<16,S=u[f+y]|d[p+y]<<16,k=x+N+A+S+524296,P=k+2*(N+A)>>3;L=P+x>>1,x=(k=k+2*(x+S)>>3)+N>>1,r(t[n+2*y-1],255&L,L>>16,g,m+(2*y-1)*i),r(t[n+2*y-0],255&x,x>>16,g,m+(2*y-0)*i),null!=a&&(L=k+A>>1,x=P+S>>1,r(a[s+2*y-1],255&L,L>>16,b,v+(2*y-1)*i),r(a[s+2*y+0],255&x,x>>16,b,v+(2*y+0)*i)),x=N,A=S}1&w||(L=3*x+A+131074>>2,r(t[n+w-1],255&L,L>>16,g,m+(w-1)*i),null!=a&&(L=3*A+x+131074>>2,r(a[s+w-1],255&L,L>>16,b,v+(w-1)*i)))}}function vn(){mi[Br]=bi,mi[Mr]=wi,mi[Rr]=vi,mi[Tr]=yi,mi[qr]=_i,mi[Dr]=xi,mi[zr]=Ai,mi[Ur]=wi,mi[Hr]=yi,mi[Wr]=_i,mi[Vr]=xi}function wn(t){return t&~Fi?0>t?0:255:t>>Pi}function yn(t,e){return wn((19077*t>>8)+(26149*e>>8)-14234)}function _n(t,e,n){return wn((19077*t>>8)-(6419*e>>8)-(13320*n>>8)+8708)}function xn(t,e){return wn((19077*t>>8)+(33050*e>>8)-17685)}function An(t,e,n,r,i){r[i+0]=yn(t,n),r[i+1]=_n(t,e,n),r[i+2]=xn(t,e)}function Ln(t,e,n,r,i){r[i+0]=xn(t,e),r[i+1]=_n(t,e,n),r[i+2]=yn(t,n)}function Nn(t,e,n,r,i){var a=_n(t,e,n);e=a<<3&224|xn(t,e)>>3,r[i+0]=248&yn(t,n)|a>>5,r[i+1]=e}function Sn(t,e,n,r,i){var a=240&xn(t,e)|15;r[i+0]=240&yn(t,n)|_n(t,e,n)>>4,r[i+1]=a}function kn(t,e,n,r,i){r[i+0]=255,An(t,e,n,r,i+1)}function Pn(t,e,n,r,i){Ln(t,e,n,r,i),r[i+3]=255}function Fn(t,e,n,r,i){An(t,e,n,r,i),r[i+3]=255}function In(e,n,r){t[e]=function(t,e,i,a,s,o,h,l,c){for(var u=l+(-2&c)*r;l!=u;)n(t[e+0],i[a+0],s[o+0],h,l),n(t[e+1],i[a+0],s[o+0],h,l+r),e+=2,++a,++o,l+=2*r;1&c&&n(t[e+0],i[a+0],s[o+0],h,l)}}function Cn(t,e,n){return 0==n?0==t?0==e?6:5:0==e?4:0:n}function jn(t,e,n,r,i){switch(t>>>30){case 3:ar(e,n,r,i,0);break;case 2:sr(e,n,r,i);break;case 1:hr(e,n,r,i)}}function En(t,e){var n,a,s=e.M,o=e.Nb,h=t.oc,l=t.pc+40,c=t.oc,u=t.pc+584,f=t.oc,d=t.pc+600;for(n=0;16>n;++n)h[l+32*n-1]=129;for(n=0;8>n;++n)c[u+32*n-1]=129,f[d+32*n-1]=129;for(0<s?h[l-1-32]=c[u-1-32]=f[d-1-32]=129:(i(h,l-32-1,127,21),i(c,u-32-1,127,9),i(f,d-32-1,127,9)),a=0;a<t.za;++a){var p=e.ya[e.aa+a];if(0<a){for(n=-1;16>n;++n)r(h,l+32*n-4,h,l+32*n+12,4);for(n=-1;8>n;++n)r(c,u+32*n-4,c,u+32*n+4,4),r(f,d+32*n-4,f,d+32*n+4,4)}var g=t.Gd,m=t.Hd+a,b=p.ad,v=p.Hc;if(0<s&&(r(h,l-32,g[m].y,0,16),r(c,u-32,g[m].f,0,8),r(f,d-32,g[m].ea,0,8)),p.Za){var w=h,y=l-32+16;for(0<s&&(a>=t.za-1?i(w,y,g[m].y[15],4):r(w,y,g[m+1].y,0,4)),n=0;4>n;n++)w[y+128+n]=w[y+256+n]=w[y+384+n]=w[y+0+n];for(n=0;16>n;++n,v<<=2)w=h,y=l+Ri[n],ui[p.Ob[n]](w,y),jn(v,b,16*+n,w,y)}else if(w=Cn(a,s,p.Ob[0]),ci[w](h,l),0!=v)for(n=0;16>n;++n,v<<=2)jn(v,b,16*+n,h,l+Ri[n]);for(n=p.Gc,w=Cn(a,s,p.Dd),fi[w](c,u),fi[w](f,d),v=b,w=c,y=u,255&(p=0|n)&&(170&p?or(v,256,w,y):lr(v,256,w,y)),p=f,v=d,255&(n>>=8)&&(170&n?or(b,320,p,v):lr(b,320,p,v)),s<t.Ub-1&&(r(g[m].y,0,h,l+480,16),r(g[m].f,0,c,u+224,8),r(g[m].ea,0,f,d+224,8)),n=8*o*t.B,g=t.sa,m=t.ta+16*a+16*o*t.R,b=t.qa,p=t.ra+8*a+n,v=t.Ha,w=t.Ia+8*a+n,n=0;16>n;++n)r(g,m+n*t.R,h,l+32*n,16);for(n=0;8>n;++n)r(b,p+n*t.B,c,u+32*n,8),r(v,w+n*t.B,f,d+32*n,8)}}function On(t,r,i,a,s,o,h,l,c){var u=[0],f=[0],d=0,p=null!=c?c.kd:0,g=null!=c?c:new nn;if(null==t||12>i)return 7;g.data=t,g.w=r,g.ha=i,r=[r],i=[i],g.gb=[g.gb];t:{var m=r,v=i,w=g.gb;if(e(null!=t),e(null!=v),e(null!=w),w[0]=0,12<=v[0]&&!n(t,m[0],"RIFF")){if(n(t,m[0]+8,"WEBP")){w=3;break t}var y=j(t,m[0]+4);if(12>y||4294967286<y){w=3;break t}if(p&&y>v[0]-8){w=7;break t}w[0]=y,m[0]+=12,v[0]-=12}w=0}if(0!=w)return w;for(y=0<g.gb[0],i=i[0];;){t:{var x=t;v=r,w=i;var A=u,L=f,N=m=[0];if((P=d=[d])[0]=0,8>w[0])w=7;else{if(!n(x,v[0],"VP8X")){if(10!=j(x,v[0]+4)){w=3;break t}if(18>w[0]){w=7;break t}var S=j(x,v[0]+8),k=1+C(x,v[0]+12);if(2147483648<=k*(x=1+C(x,v[0]+15))){w=3;break t}null!=N&&(N[0]=S),null!=A&&(A[0]=k),null!=L&&(L[0]=x),v[0]+=18,w[0]-=18,P[0]=1}w=0}}if(d=d[0],m=m[0],0!=w)return w;if(v=!!(2&m),!y&&d)return 3;if(null!=o&&(o[0]=!!(16&m)),null!=h&&(h[0]=v),null!=l&&(l[0]=0),h=u[0],m=f[0],d&&v&&null==c){w=0;break}if(4>i){w=7;break}if(y&&d||!y&&!d&&!n(t,r[0],"ALPH")){i=[i],g.na=[g.na],g.P=[g.P],g.Sa=[g.Sa];t:{S=t,w=r,y=i;var P=g.gb;A=g.na,L=g.P,N=g.Sa,k=22,e(null!=S),e(null!=y),x=w[0];var F=y[0];for(e(null!=A),e(null!=N),A[0]=null,L[0]=null,N[0]=0;;){if(w[0]=x,y[0]=F,8>F){w=7;break t}var I=j(S,x+4);if(4294967286<I){w=3;break t}var E=8+I+1&-2;if(k+=E,0<P&&k>P){w=3;break t}if(!n(S,x,"VP8 ")||!n(S,x,"VP8L")){w=0;break t}if(F[0]<E){w=7;break t}n(S,x,"ALPH")||(A[0]=S,L[0]=x+8,N[0]=I),x+=E,F-=E}}if(i=i[0],g.na=g.na[0],g.P=g.P[0],g.Sa=g.Sa[0],0!=w)break}i=[i],g.Ja=[g.Ja],g.xa=[g.xa];t:if(P=t,w=r,y=i,A=g.gb[0],L=g.Ja,N=g.xa,S=w[0],x=!n(P,S,"VP8 "),k=!n(P,S,"VP8L"),e(null!=P),e(null!=y),e(null!=L),e(null!=N),8>y[0])w=7;else{if(x||k){if(P=j(P,S+4),12<=A&&P>A-12){w=3;break t}if(p&&P>y[0]-8){w=7;break t}L[0]=P,w[0]+=8,y[0]-=8,N[0]=k}else N[0]=5<=y[0]&&47==P[S+0]&&!(P[S+4]>>5),L[0]=y[0];w=0}if(i=i[0],g.Ja=g.Ja[0],g.xa=g.xa[0],r=r[0],0!=w)break;if(4294967286<g.Ja)return 3;if(null==l||v||(l[0]=g.xa?2:1),h=[h],m=[m],g.xa){if(5>i){w=7;break}l=h,p=m,v=o,null==t||5>i?t=0:5<=i&&47==t[r+0]&&!(t[r+4]>>5)?(y=[0],P=[0],A=[0],b(L=new _,t,r,i),gt(L,y,P,A)?(null!=l&&(l[0]=y[0]),null!=p&&(p[0]=P[0]),null!=v&&(v[0]=A[0]),t=1):t=0):t=0}else{if(10>i){w=7;break}l=m,null==t||10>i||!Jt(t,r+3,i-3)?t=0:(p=t[r+0]|t[r+1]<<8|t[r+2]<<16,v=16383&(t[r+7]<<8|t[r+6]),t=16383&(t[r+9]<<8|t[r+8]),1&p||3<(p>>1&7)||!(p>>4&1)||p>>5>=g.Ja||!v||!t?t=0:(h&&(h[0]=v),l&&(l[0]=t),t=1))}if(!t)return 3;if(h=h[0],m=m[0],d&&(u[0]!=h||f[0]!=m))return 3;null!=c&&(c[0]=g,c.offset=r-c.w,e(4294967286>r-c.w),e(c.offset==c.ha-i));break}return 0==w||7==w&&d&&null==c?(null!=o&&(o[0]|=null!=g.na&&0<g.na.length),null!=a&&(a[0]=h),null!=s&&(s[0]=m),0):w}function Bn(t,e,n){var r=e.width,i=e.height,a=0,s=0,o=r,h=i;if(e.Da=null!=t&&0<t.Da,e.Da&&(o=t.cd,h=t.bd,a=t.v,s=t.j,11>n||(a&=-2,s&=-2),0>a||0>s||0>=o||0>=h||a+o>r||s+h>i))return 0;if(e.v=a,e.j=s,e.va=a+o,e.o=s+h,e.U=o,e.T=h,e.da=null!=t&&0<t.da,e.da){if(!M(o,h,n=[t.ib],a=[t.hb]))return 0;e.ib=n[0],e.hb=a[0]}return e.ob=null!=t&&t.ob,e.Kb=null==t||!t.Sd,e.da&&(e.ob=e.ib<3*r/4&&e.hb<3*i/4,e.Kb=0),1}function Mn(t){if(null==t)return 2;if(11>t.S){var e=t.f.RGBA;e.fb+=(t.height-1)*e.A,e.A=-e.A}else e=t.f.kb,t=t.height,e.O+=(t-1)*e.fa,e.fa=-e.fa,e.N+=(t-1>>1)*e.Ab,e.Ab=-e.Ab,e.W+=(t-1>>1)*e.Db,e.Db=-e.Db,null!=e.F&&(e.J+=(t-1)*e.lb,e.lb=-e.lb);return 0}function Rn(t,e,n,r){if(null==r||0>=t||0>=e)return 2;if(null!=n){if(n.Da){var i=n.cd,s=n.bd,o=-2&n.v,h=-2&n.j;if(0>o||0>h||0>=i||0>=s||o+i>t||h+s>e)return 2;t=i,e=s}if(n.da){if(!M(t,e,i=[n.ib],s=[n.hb]))return 2;t=i[0],e=s[0]}}r.width=t,r.height=e;t:{var l=r.width,c=r.height;if(t=r.S,0>=l||0>=c||!(t>=Br&&13>t))t=2;else{if(0>=r.Rd&&null==r.sd){o=s=i=e=0;var u=(h=l*zi[t])*c;if(11>t||(s=(c+1)/2*(e=(l+1)/2),12==t&&(o=(i=l)*c)),null==(c=a(u+2*s+o))){t=1;break t}r.sd=c,11>t?((l=r.f.RGBA).eb=c,l.fb=0,l.A=h,l.size=u):((l=r.f.kb).y=c,l.O=0,l.fa=h,l.Fd=u,l.f=c,l.N=0+u,l.Ab=e,l.Cd=s,l.ea=c,l.W=0+u+s,l.Db=e,l.Ed=s,12==t&&(l.F=c,l.J=0+u+2*s),l.Tc=o,l.lb=i)}if(e=1,i=r.S,s=r.width,o=r.height,i>=Br&&13>i)if(11>i)t=r.f.RGBA,e&=(h=Math.abs(t.A))*(o-1)+s<=t.size,e&=h>=s*zi[i],e&=null!=t.eb;else{t=r.f.kb,h=(s+1)/2,u=(o+1)/2,l=Math.abs(t.fa),c=Math.abs(t.Ab);var f=Math.abs(t.Db),d=Math.abs(t.lb),p=d*(o-1)+s;e&=l*(o-1)+s<=t.Fd,e&=c*(u-1)+h<=t.Cd,e=(e&=f*(u-1)+h<=t.Ed)&l>=s&c>=h&f>=h,e&=null!=t.y,e&=null!=t.f,e&=null!=t.ea,12==i&&(e&=d>=s,e&=p<=t.Tc,e&=null!=t.F)}else e=0;t=e?0:2}}return 0!=t||null!=n&&n.fd&&(t=Mn(r)),t}var Tn=64,qn=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215],Dn=24,zn=32,Un=8,Hn=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];q("Predictor0","PredictorAdd0"),t.Predictor0=function(){return 4278190080},t.Predictor1=function(t){return t},t.Predictor2=function(t,e,n){return e[n+0]},t.Predictor3=function(t,e,n){return e[n+1]},t.Predictor4=function(t,e,n){return e[n-1]},t.Predictor5=function(t,e,n){return z(z(t,e[n+1]),e[n+0])},t.Predictor6=function(t,e,n){return z(t,e[n-1])},t.Predictor7=function(t,e,n){return z(t,e[n+0])},t.Predictor8=function(t,e,n){return z(e[n-1],e[n+0])},t.Predictor9=function(t,e,n){return z(e[n+0],e[n+1])},t.Predictor10=function(t,e,n){return z(z(t,e[n-1]),z(e[n+0],e[n+1]))},t.Predictor11=function(t,e,n){var r=e[n+0];return 0>=W(r>>24&255,t>>24&255,(e=e[n-1])>>24&255)+W(r>>16&255,t>>16&255,e>>16&255)+W(r>>8&255,t>>8&255,e>>8&255)+W(255&r,255&t,255&e)?r:t},t.Predictor12=function(t,e,n){var r=e[n+0];return(U((t>>24&255)+(r>>24&255)-((e=e[n-1])>>24&255))<<24|U((t>>16&255)+(r>>16&255)-(e>>16&255))<<16|U((t>>8&255)+(r>>8&255)-(e>>8&255))<<8|U((255&t)+(255&r)-(255&e)))>>>0},t.Predictor13=function(t,e,n){var r=e[n-1];return(H((t=z(t,e[n+0]))>>24&255,r>>24&255)<<24|H(t>>16&255,r>>16&255)<<16|H(t>>8&255,r>>8&255)<<8|H(255&t,255&r))>>>0};var Wn=t.PredictorAdd0;t.PredictorAdd1=V,q("Predictor2","PredictorAdd2"),q("Predictor3","PredictorAdd3"),q("Predictor4","PredictorAdd4"),q("Predictor5","PredictorAdd5"),q("Predictor6","PredictorAdd6"),q("Predictor7","PredictorAdd7"),q("Predictor8","PredictorAdd8"),q("Predictor9","PredictorAdd9"),q("Predictor10","PredictorAdd10"),q("Predictor11","PredictorAdd11"),q("Predictor12","PredictorAdd12"),q("Predictor13","PredictorAdd13");var Vn=t.PredictorAdd2;J("ColorIndexInverseTransform","MapARGB","32b",function(t){return t>>8&255},function(t){return t}),J("VP8LColorIndexInverseTransformAlpha","MapAlpha","8b",function(t){return t},function(t){return t>>8&255});var Gn,Yn=t.ColorIndexInverseTransform,Zn=t.MapARGB,Jn=t.VP8LColorIndexInverseTransformAlpha,Xn=t.MapAlpha,Kn=t.VP8LPredictorsAdd=[];Kn.length=16,(t.VP8LPredictors=[]).length=16,(t.VP8LPredictorsAdd_C=[]).length=16,(t.VP8LPredictors_C=[]).length=16;var $n,Qn,tr,er,nr,rr,ir,ar,sr,or,hr,lr,cr,ur,fr,dr,pr,gr,mr,br,vr,wr,yr,_r,xr,Ar,Lr,Nr,Sr=a(511),kr=a(2041),Pr=a(225),Fr=a(767),Ir=0,Cr=kr,jr=Pr,Er=Fr,Or=Sr,Br=0,Mr=1,Rr=2,Tr=3,qr=4,Dr=5,zr=6,Ur=7,Hr=8,Wr=9,Vr=10,Gr=[2,3,7],Yr=[3,3,11],Zr=[280,256,256,256,40],Jr=[0,1,1,1,0],Xr=[17,18,0,1,2,3,4,5,16,6,7,8,9,10,11,12,13,14,15],Kr=[24,7,23,25,40,6,39,41,22,26,38,42,56,5,55,57,21,27,54,58,37,43,72,4,71,73,20,28,53,59,70,74,36,44,88,69,75,52,60,3,87,89,19,29,86,90,35,45,68,76,85,91,51,61,104,2,103,105,18,30,102,106,34,46,84,92,67,77,101,107,50,62,120,1,119,121,83,93,17,31,100,108,66,78,118,122,33,47,117,123,49,63,99,109,82,94,0,116,124,65,79,16,32,98,110,48,115,125,81,95,64,114,126,97,111,80,113,127,96,112],$r=[2954,2956,2958,2962,2970,2986,3018,3082,3212,3468,3980,5004],Qr=8,ti=[4,5,6,7,8,9,10,10,11,12,13,14,15,16,17,17,18,19,20,20,21,21,22,22,23,23,24,25,25,26,27,28,29,30,31,32,33,34,35,36,37,37,38,39,40,41,42,43,44,45,46,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,76,77,78,79,80,81,82,83,84,85,86,87,88,89,91,93,95,96,98,100,101,102,104,106,108,110,112,114,116,118,122,124,126,128,130,132,134,136,138,140,143,145,148,151,154,157],ei=[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,119,122,125,128,131,134,137,140,143,146,149,152,155,158,161,164,167,170,173,177,181,185,189,193,197,201,205,209,213,217,221,225,229,234,239,245,249,254,259,264,269,274,279,284],ni=null,ri=[[173,148,140,0],[176,155,140,135,0],[180,157,141,134,130,0],[254,254,243,230,196,177,153,140,133,130,129,0]],ii=[0,1,4,8,5,2,3,6,9,12,13,10,7,11,14,15],ai=[-0,1,-1,2,-2,3,4,6,-3,5,-4,-5,-6,7,-7,8,-8,-9],si=[[[[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128]],[[253,136,254,255,228,219,128,128,128,128,128],[189,129,242,255,227,213,255,219,128,128,128],[106,126,227,252,214,209,255,255,128,128,128]],[[1,98,248,255,236,226,255,255,128,128,128],[181,133,238,254,221,234,255,154,128,128,128],[78,134,202,247,198,180,255,219,128,128,128]],[[1,185,249,255,243,255,128,128,128,128,128],[184,150,247,255,236,224,128,128,128,128,128],[77,110,216,255,236,230,128,128,128,128,128]],[[1,101,251,255,241,255,128,128,128,128,128],[170,139,241,252,236,209,255,255,128,128,128],[37,116,196,243,228,255,255,255,128,128,128]],[[1,204,254,255,245,255,128,128,128,128,128],[207,160,250,255,238,128,128,128,128,128,128],[102,103,231,255,211,171,128,128,128,128,128]],[[1,152,252,255,240,255,128,128,128,128,128],[177,135,243,255,234,225,128,128,128,128,128],[80,129,211,255,194,224,128,128,128,128,128]],[[1,1,255,128,128,128,128,128,128,128,128],[246,1,255,128,128,128,128,128,128,128,128],[255,128,128,128,128,128,128,128,128,128,128]]],[[[198,35,237,223,193,187,162,160,145,155,62],[131,45,198,221,172,176,220,157,252,221,1],[68,47,146,208,149,167,221,162,255,223,128]],[[1,149,241,255,221,224,255,255,128,128,128],[184,141,234,253,222,220,255,199,128,128,128],[81,99,181,242,176,190,249,202,255,255,128]],[[1,129,232,253,214,197,242,196,255,255,128],[99,121,210,250,201,198,255,202,128,128,128],[23,91,163,242,170,187,247,210,255,255,128]],[[1,200,246,255,234,255,128,128,128,128,128],[109,178,241,255,231,245,255,255,128,128,128],[44,130,201,253,205,192,255,255,128,128,128]],[[1,132,239,251,219,209,255,165,128,128,128],[94,136,225,251,218,190,255,255,128,128,128],[22,100,174,245,186,161,255,199,128,128,128]],[[1,182,249,255,232,235,128,128,128,128,128],[124,143,241,255,227,234,128,128,128,128,128],[35,77,181,251,193,211,255,205,128,128,128]],[[1,157,247,255,236,231,255,255,128,128,128],[121,141,235,255,225,227,255,255,128,128,128],[45,99,188,251,195,217,255,224,128,128,128]],[[1,1,251,255,213,255,128,128,128,128,128],[203,1,248,255,255,128,128,128,128,128,128],[137,1,177,255,224,255,128,128,128,128,128]]],[[[253,9,248,251,207,208,255,192,128,128,128],[175,13,224,243,193,185,249,198,255,255,128],[73,17,171,221,161,179,236,167,255,234,128]],[[1,95,247,253,212,183,255,255,128,128,128],[239,90,244,250,211,209,255,255,128,128,128],[155,77,195,248,188,195,255,255,128,128,128]],[[1,24,239,251,218,219,255,205,128,128,128],[201,51,219,255,196,186,128,128,128,128,128],[69,46,190,239,201,218,255,228,128,128,128]],[[1,191,251,255,255,128,128,128,128,128,128],[223,165,249,255,213,255,128,128,128,128,128],[141,124,248,255,255,128,128,128,128,128,128]],[[1,16,248,255,255,128,128,128,128,128,128],[190,36,230,255,236,255,128,128,128,128,128],[149,1,255,128,128,128,128,128,128,128,128]],[[1,226,255,128,128,128,128,128,128,128,128],[247,192,255,128,128,128,128,128,128,128,128],[240,128,255,128,128,128,128,128,128,128,128]],[[1,134,252,255,255,128,128,128,128,128,128],[213,62,250,255,255,128,128,128,128,128,128],[55,93,255,128,128,128,128,128,128,128,128]],[[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128]]],[[[202,24,213,235,186,191,220,160,240,175,255],[126,38,182,232,169,184,228,174,255,187,128],[61,46,138,219,151,178,240,170,255,216,128]],[[1,112,230,250,199,191,247,159,255,255,128],[166,109,228,252,211,215,255,174,128,128,128],[39,77,162,232,172,180,245,178,255,255,128]],[[1,52,220,246,198,199,249,220,255,255,128],[124,74,191,243,183,193,250,221,255,255,128],[24,71,130,219,154,170,243,182,255,255,128]],[[1,182,225,249,219,240,255,224,128,128,128],[149,150,226,252,216,205,255,171,128,128,128],[28,108,170,242,183,194,254,223,255,255,128]],[[1,81,230,252,204,203,255,192,128,128,128],[123,102,209,247,188,196,255,233,128,128,128],[20,95,153,243,164,173,255,203,128,128,128]],[[1,222,248,255,216,213,128,128,128,128,128],[168,175,246,252,235,205,255,255,128,128,128],[47,116,215,255,211,212,255,255,128,128,128]],[[1,121,236,253,212,214,255,255,128,128,128],[141,84,213,252,201,202,255,219,128,128,128],[42,80,160,240,162,185,255,205,128,128,128]],[[1,1,255,128,128,128,128,128,128,128,128],[244,1,255,128,128,128,128,128,128,128,128],[238,1,255,128,128,128,128,128,128,128,128]]]],oi=[[[231,120,48,89,115,113,120,152,112],[152,179,64,126,170,118,46,70,95],[175,69,143,80,85,82,72,155,103],[56,58,10,171,218,189,17,13,152],[114,26,17,163,44,195,21,10,173],[121,24,80,195,26,62,44,64,85],[144,71,10,38,171,213,144,34,26],[170,46,55,19,136,160,33,206,71],[63,20,8,114,114,208,12,9,226],[81,40,11,96,182,84,29,16,36]],[[134,183,89,137,98,101,106,165,148],[72,187,100,130,157,111,32,75,80],[66,102,167,99,74,62,40,234,128],[41,53,9,178,241,141,26,8,107],[74,43,26,146,73,166,49,23,157],[65,38,105,160,51,52,31,115,128],[104,79,12,27,217,255,87,17,7],[87,68,71,44,114,51,15,186,23],[47,41,14,110,182,183,21,17,194],[66,45,25,102,197,189,23,18,22]],[[88,88,147,150,42,46,45,196,205],[43,97,183,117,85,38,35,179,61],[39,53,200,87,26,21,43,232,171],[56,34,51,104,114,102,29,93,77],[39,28,85,171,58,165,90,98,64],[34,22,116,206,23,34,43,166,73],[107,54,32,26,51,1,81,43,31],[68,25,106,22,64,171,36,225,114],[34,19,21,102,132,188,16,76,124],[62,18,78,95,85,57,50,48,51]],[[193,101,35,159,215,111,89,46,111],[60,148,31,172,219,228,21,18,111],[112,113,77,85,179,255,38,120,114],[40,42,1,196,245,209,10,25,109],[88,43,29,140,166,213,37,43,154],[61,63,30,155,67,45,68,1,209],[100,80,8,43,154,1,51,26,71],[142,78,78,16,255,128,34,197,171],[41,40,5,102,211,183,4,1,221],[51,50,17,168,209,192,23,25,82]],[[138,31,36,171,27,166,38,44,229],[67,87,58,169,82,115,26,59,179],[63,59,90,180,59,166,93,73,154],[40,40,21,116,143,209,34,39,175],[47,15,16,183,34,223,49,45,183],[46,17,33,183,6,98,15,32,183],[57,46,22,24,128,1,54,17,37],[65,32,73,115,28,128,23,128,205],[40,3,9,115,51,192,18,6,223],[87,37,9,115,59,77,64,21,47]],[[104,55,44,218,9,54,53,130,226],[64,90,70,205,40,41,23,26,57],[54,57,112,184,5,41,38,166,213],[30,34,26,133,152,116,10,32,134],[39,19,53,221,26,114,32,73,255],[31,9,65,234,2,15,1,118,73],[75,32,12,51,192,255,160,43,51],[88,31,35,67,102,85,55,186,85],[56,21,23,111,59,205,45,37,192],[55,38,70,124,73,102,1,34,98]],[[125,98,42,88,104,85,117,175,82],[95,84,53,89,128,100,113,101,45],[75,79,123,47,51,128,81,171,1],[57,17,5,71,102,57,53,41,49],[38,33,13,121,57,73,26,1,85],[41,10,67,138,77,110,90,47,114],[115,21,2,10,102,255,166,23,6],[101,29,16,10,85,128,101,196,26],[57,18,10,102,102,213,34,20,43],[117,20,15,36,163,128,68,1,26]],[[102,61,71,37,34,53,31,243,192],[69,60,71,38,73,119,28,222,37],[68,45,128,34,1,47,11,245,171],[62,17,19,70,146,85,55,62,70],[37,43,37,154,100,163,85,160,1],[63,9,92,136,28,64,32,201,85],[75,15,9,9,64,255,184,119,16],[86,6,28,5,64,255,25,248,1],[56,8,17,132,137,255,55,116,128],[58,15,20,82,135,57,26,121,40]],[[164,50,31,137,154,133,25,35,218],[51,103,44,131,131,123,31,6,158],[86,40,64,135,148,224,45,183,128],[22,26,17,131,240,154,14,1,209],[45,16,21,91,64,222,7,1,197],[56,21,39,155,60,138,23,102,213],[83,12,13,54,192,255,68,47,28],[85,26,85,85,128,128,32,146,171],[18,11,7,63,144,171,4,4,246],[35,27,10,146,174,171,12,26,128]],[[190,80,35,99,180,80,126,54,45],[85,126,47,87,176,51,41,20,32],[101,75,128,139,118,146,116,128,85],[56,41,15,176,236,85,37,9,62],[71,30,17,119,118,255,17,18,138],[101,38,60,138,55,70,43,26,142],[146,36,19,30,171,255,97,27,20],[138,45,61,62,219,1,81,188,64],[32,41,20,117,151,142,20,21,163],[112,19,12,61,195,128,48,4,24]]],hi=[[[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[176,246,255,255,255,255,255,255,255,255,255],[223,241,252,255,255,255,255,255,255,255,255],[249,253,253,255,255,255,255,255,255,255,255]],[[255,244,252,255,255,255,255,255,255,255,255],[234,254,254,255,255,255,255,255,255,255,255],[253,255,255,255,255,255,255,255,255,255,255]],[[255,246,254,255,255,255,255,255,255,255,255],[239,253,254,255,255,255,255,255,255,255,255],[254,255,254,255,255,255,255,255,255,255,255]],[[255,248,254,255,255,255,255,255,255,255,255],[251,255,254,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[251,254,254,255,255,255,255,255,255,255,255],[254,255,254,255,255,255,255,255,255,255,255]],[[255,254,253,255,254,255,255,255,255,255,255],[250,255,254,255,254,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[217,255,255,255,255,255,255,255,255,255,255],[225,252,241,253,255,255,254,255,255,255,255],[234,250,241,250,253,255,253,254,255,255,255]],[[255,254,255,255,255,255,255,255,255,255,255],[223,254,254,255,255,255,255,255,255,255,255],[238,253,254,254,255,255,255,255,255,255,255]],[[255,248,254,255,255,255,255,255,255,255,255],[249,254,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,255,255,255,255,255,255,255,255,255],[247,254,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[252,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,254,255,255,255,255,255,255,255,255],[253,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,253,255,255,255,255,255,255,255,255],[250,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[186,251,250,255,255,255,255,255,255,255,255],[234,251,244,254,255,255,255,255,255,255,255],[251,251,243,253,254,255,254,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[236,253,254,255,255,255,255,255,255,255,255],[251,253,253,254,254,255,255,255,255,255,255]],[[255,254,254,255,255,255,255,255,255,255,255],[254,254,254,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,255,255,255,255,255,255,255,255,255],[254,254,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[248,255,255,255,255,255,255,255,255,255,255],[250,254,252,254,255,255,255,255,255,255,255],[248,254,249,253,255,255,255,255,255,255,255]],[[255,253,253,255,255,255,255,255,255,255,255],[246,253,253,255,255,255,255,255,255,255,255],[252,254,251,254,254,255,255,255,255,255,255]],[[255,254,252,255,255,255,255,255,255,255,255],[248,254,253,255,255,255,255,255,255,255,255],[253,255,254,254,255,255,255,255,255,255,255]],[[255,251,254,255,255,255,255,255,255,255,255],[245,251,254,255,255,255,255,255,255,255,255],[253,253,254,255,255,255,255,255,255,255,255]],[[255,251,253,255,255,255,255,255,255,255,255],[252,253,254,255,255,255,255,255,255,255,255],[255,254,255,255,255,255,255,255,255,255,255]],[[255,252,255,255,255,255,255,255,255,255,255],[249,255,254,255,255,255,255,255,255,255,255],[255,255,254,255,255,255,255,255,255,255,255]],[[255,255,253,255,255,255,255,255,255,255,255],[250,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]]],li=[0,1,2,3,6,4,5,6,6,6,6,6,6,6,6,7,0],ci=[],ui=[],fi=[],di=1,pi=2,gi=[],mi=[];bn("UpsampleRgbLinePair",An,3),bn("UpsampleBgrLinePair",Ln,3),bn("UpsampleRgbaLinePair",Fn,4),bn("UpsampleBgraLinePair",Pn,4),bn("UpsampleArgbLinePair",kn,4),bn("UpsampleRgba4444LinePair",Sn,2),bn("UpsampleRgb565LinePair",Nn,2);var bi=t.UpsampleRgbLinePair,vi=t.UpsampleBgrLinePair,wi=t.UpsampleRgbaLinePair,yi=t.UpsampleBgraLinePair,_i=t.UpsampleArgbLinePair,xi=t.UpsampleRgba4444LinePair,Ai=t.UpsampleRgb565LinePair,Li=16,Ni=1<<Li-1,Si=-227,ki=482,Pi=6,Fi=(256<<Pi)-1,Ii=0,Ci=a(256),ji=a(256),Ei=a(256),Oi=a(256),Bi=a(ki-Si),Mi=a(ki-Si);In("YuvToRgbRow",An,3),In("YuvToBgrRow",Ln,3),In("YuvToRgbaRow",Fn,4),In("YuvToBgraRow",Pn,4),In("YuvToArgbRow",kn,4),In("YuvToRgba4444Row",Sn,2),In("YuvToRgb565Row",Nn,2);var Ri=[0,4,8,12,128,132,136,140,256,260,264,268,384,388,392,396],Ti=[0,2,8],qi=[8,7,6,4,4,2,2,2,1,1,1,1],Di=1;this.WebPDecodeRGBA=function(t,n,o,h,l){var c=Mr,u=new en,f=new st;u.ba=f,f.S=c,f.width=[f.width],f.height=[f.height];var d=f.width,p=f.height,g=new ot;if(null==g||null==t)var m=2;else e(null!=g),m=On(t,n,o,g.width,g.height,g.Pd,g.Qd,g.format,null);if(0!=m?d=0:(null!=d&&(d[0]=g.width[0]),null!=p&&(p[0]=g.height[0]),d=1),d){f.width=f.width[0],f.height=f.height[0],null!=h&&(h[0]=f.width),null!=l&&(l[0]=f.height);t:{if(h=new Gt,(l=new nn).data=t,l.w=n,l.ha=o,l.kd=1,n=[0],e(null!=l),(0==(t=On(l.data,l.w,l.ha,null,null,null,n,null,l))||7==t)&&n[0]&&(t=4),0==(n=t)){if(e(null!=u),h.data=l.data,h.w=l.w+l.offset,h.ha=l.ha-l.offset,h.put=dt,h.ac=ft,h.bc=pt,h.ma=u,l.xa){if(null==(t=Pt())){u=1;break t}if(function(t,n){var r=[0],i=[0],a=[0];e:for(;;){if(null==t)return 0;if(null==n)return t.a=2,0;if(t.l=n,t.a=0,b(t.m,n.data,n.w,n.ha),!gt(t.m,r,i,a)){t.a=3;break e}if(t.xb=pi,n.width=r[0],n.height=i[0],!Ft(r[0],i[0],1,t,null))break e;return 1}return e(0!=t.a),0}(t,h)){if(h=0==(n=Rn(h.width,h.height,u.Oa,u.ba))){e:{h=t;n:for(;;){if(null==h){h=0;break e}if(e(null!=h.s.yc),e(null!=h.s.Ya),e(0<h.s.Wb),e(null!=(o=h.l)),e(null!=(l=o.ma)),0!=h.xb){if(h.ca=l.ba,h.tb=l.tb,e(null!=h.ca),!Bn(l.Oa,o,Tr)){h.a=2;break n}if(!It(h,o.width))break n;if(o.da)break n;if((o.da||rt(h.ca.S))&&mn(),11>h.ca.S||(alert("todo:WebPInitConvertARGBToYUV"),null!=h.ca.f.kb.F&&mn()),h.Pb&&0<h.s.ua&&null==h.s.vb.X&&!E(h.s.vb,h.s.Wa.Xa)){h.a=1;break n}h.xb=0}if(!St(h,h.V,h.Ba,h.c,h.i,o.o,xt))break n;l.Dc=h.Ma,h=1;break e}e(0!=h.a),h=0}h=!h}h&&(n=t.a)}else n=t.a}else{if(null==(t=new Yt)){u=1;break t}if(t.Fa=l.na,t.P=l.P,t.qc=l.Sa,Xt(t,h)){if(0==(n=Rn(h.width,h.height,u.Oa,u.ba))){if(t.Aa=0,o=u.Oa,e(null!=(l=t)),null!=o){if(0<(d=0>(d=o.Md)?0:100<d?255:255*d/100)){for(p=g=0;4>p;++p)12>(m=l.pb[p]).lc&&(m.ia=d*qi[0>m.lc?0:m.lc]>>3),g|=m.ia;g&&(alert("todo:VP8InitRandom"),l.ia=1)}l.Ga=o.Id,100<l.Ga?l.Ga=100:0>l.Ga&&(l.Ga=0)}(function(t,n){if(null==t)return 0;if(null==n)return Zt(t,2,"NULL VP8Io parameter in VP8Decode().");if(!t.cb&&!Xt(t,n))return 0;if(e(t.cb),null==n.ac||n.ac(n)){n.ob&&(t.L=0);var o=Ti[t.L];if(2==t.L?(t.yb=0,t.zb=0):(t.yb=n.v-o>>4,t.zb=n.j-o>>4,0>t.yb&&(t.yb=0),0>t.zb&&(t.zb=0)),t.Va=n.o+15+o>>4,t.Hb=n.va+15+o>>4,t.Hb>t.za&&(t.Hb=t.za),t.Va>t.Ub&&(t.Va=t.Ub),0<t.L){var h=t.ed;for(o=0;4>o;++o){var l;if(t.Qa.Cb){var c=t.Qa.Lb[o];t.Qa.Fb||(c+=h.Tb)}else c=h.Tb;for(l=0;1>=l;++l){var u=t.gd[o][l],f=c;if(h.Pc&&(f+=h.vd[0],l&&(f+=h.od[0])),0<(f=0>f?0:63<f?63:f)){var d=f;0<h.wb&&(d=4<h.wb?d>>2:d>>1)>9-h.wb&&(d=9-h.wb),1>d&&(d=1),u.dd=d,u.tc=2*f+d,u.ld=40<=f?2:15<=f?1:0}else u.tc=0;u.La=l}}}o=0}else Zt(t,6,"Frame setup failed"),o=t.a;if(o=0==o){if(o){t.$c=0,0<t.Aa||(t.Ic=Di);e:{o=t.Ic,h=4*(d=t.za);var p=32*d,g=d+1,m=0<t.L?d*(0<t.Aa?2:1):0,b=(2==t.Aa?2:1)*d;if((u=h+832+(l=3*(16*o+Ti[t.L])/2*p)+(c=null!=t.Fa&&0<t.Fa.length?t.Kc.c*t.Kc.i:0))!=u)o=0;else{if(u>t.Vb){if(t.Vb=0,t.Ec=a(u),t.Fc=0,null==t.Ec){o=Zt(t,1,"no memory during frame initialization.");break e}t.Vb=u}u=t.Ec,f=t.Fc,t.Ac=u,t.Bc=f,f+=h,t.Gd=s(p,Ht),t.Hd=0,t.rb=s(g+1,qt),t.sb=1,t.wa=m?s(m,Tt):null,t.Y=0,t.D.Nb=0,t.D.wa=t.wa,t.D.Y=t.Y,0<t.Aa&&(t.D.Y+=d),e(!0),t.oc=u,t.pc=f,f+=832,t.ya=s(b,zt),t.aa=0,t.D.ya=t.ya,t.D.aa=t.aa,2==t.Aa&&(t.D.aa+=d),t.R=16*d,t.B=8*d,d=(p=Ti[t.L])*t.R,p=p/2*t.B,t.sa=u,t.ta=f+d,t.qa=t.sa,t.ra=t.ta+16*o*t.R+p,t.Ha=t.qa,t.Ia=t.ra+8*o*t.B+p,t.$c=0,f+=l,t.mb=c?u:null,t.nb=c?f:null,e(f+c<=t.Fc+t.Vb),$t(t),i(t.Ac,t.Bc,0,h),o=1}}if(o){if(n.ka=0,n.y=t.sa,n.O=t.ta,n.f=t.qa,n.N=t.ra,n.ea=t.Ha,n.Vd=t.Ia,n.fa=t.R,n.Rc=t.B,n.F=null,n.J=0,!Ir){for(o=-255;255>=o;++o)Sr[255+o]=0>o?-o:o;for(o=-1020;1020>=o;++o)kr[1020+o]=-128>o?-128:127<o?127:o;for(o=-112;112>=o;++o)Pr[112+o]=-16>o?-16:15<o?15:o;for(o=-255;510>=o;++o)Fr[255+o]=0>o?0:255<o?255:o;Ir=1}ir=he,ar=ie,or=ae,hr=se,lr=oe,sr=re,cr=Ye,ur=Ze,fr=Ke,dr=$e,pr=Je,gr=Xe,mr=Qe,br=tn,vr=ze,wr=Ue,yr=He,_r=We,ui[0]=Ae,ui[1]=ce,ui[2]=_e,ui[3]=xe,ui[4]=Le,ui[5]=Se,ui[6]=Ne,ui[7]=ke,ui[8]=Fe,ui[9]=Pe,ci[0]=me,ci[1]=fe,ci[2]=de,ci[3]=pe,ci[4]=be,ci[5]=ve,ci[6]=we,fi[0]=Ee,fi[1]=ue,fi[2]=Ie,fi[3]=Ce,fi[4]=Be,fi[5]=Oe,fi[6]=Me,o=1}else o=0}o&&(o=function(t,n){for(t.M=0;t.M<t.Va;++t.M){var s,o=t.Jc[t.M&t.Xb],h=t.m,l=t;for(s=0;s<l.za;++s){var c=h,u=l,f=u.Ac,d=u.Bc+4*s,p=u.zc,g=u.ya[u.aa+s];if(u.Qa.Bb?g.$b=P(c,u.Pa.jb[0])?2+P(c,u.Pa.jb[2]):P(c,u.Pa.jb[1]):g.$b=0,u.kc&&(g.Ad=P(c,u.Bd)),g.Za=!P(c,145)+0,g.Za){var m=g.Ob,b=0;for(u=0;4>u;++u){var v,w=p[0+u];for(v=0;4>v;++v){w=oi[f[d+v]][w];for(var y=ai[P(c,w[0])];0<y;)y=ai[2*y+P(c,w[y])];w=-y,f[d+v]=w}r(m,b,f,d,4),b+=4,p[0+u]=w}}else w=P(c,156)?P(c,128)?1:3:P(c,163)?2:0,g.Ob[0]=w,i(f,d,w,4),i(p,0,w,4);g.Dd=P(c,142)?P(c,114)?P(c,183)?1:3:2:0}if(l.m.Ka)return Zt(t,7,"Premature end-of-partition0 encountered.");for(;t.ja<t.za;++t.ja){if(l=o,c=(h=t).rb[h.sb-1],f=h.rb[h.sb+h.ja],s=h.ya[h.aa+h.ja],d=h.kc?s.Ad:0)c.la=f.la=0,s.Za||(c.Na=f.Na=0),s.Hc=0,s.Gc=0,s.ia=0;else{var _,x;if(c=f,f=l,d=h.Pa.Xc,p=h.ya[h.aa+h.ja],g=h.pb[p.$b],u=p.ad,m=0,b=h.rb[h.sb-1],w=v=0,i(u,m,0,384),p.Za)var A=0,L=d[3];else{y=a(16);var N=c.Na+b.Na;if(N=ni(f,d[1],N,g.Eb,0,y,0),c.Na=b.Na=(0<N)+0,1<N)ir(y,0,u,m);else{var S=y[0]+3>>3;for(y=0;256>y;y+=16)u[m+y]=S}A=1,L=d[0]}var k=15&c.la,F=15&b.la;for(y=0;4>y;++y){var I=1&F;for(S=x=0;4>S;++S)k=k>>1|(I=(N=ni(f,L,N=I+(1&k),g.Sc,A,u,m))>A)<<7,x=x<<2|(3<N?3:1<N?2:0!=u[m+0]),m+=16;k>>=4,F=F>>1|I<<7,v=(v<<8|x)>>>0}for(L=k,A=F>>4,_=0;4>_;_+=2){for(x=0,k=c.la>>4+_,F=b.la>>4+_,y=0;2>y;++y){for(I=1&F,S=0;2>S;++S)N=I+(1&k),k=k>>1|(I=0<(N=ni(f,d[2],N,g.Qc,0,u,m)))<<3,x=x<<2|(3<N?3:1<N?2:0!=u[m+0]),m+=16;k>>=2,F=F>>1|I<<5}w|=x<<4*_,L|=k<<4<<_,A|=(240&F)<<_}c.la=L,b.la=A,p.Hc=v,p.Gc=w,p.ia=43690&w?0:g.ia,d=!(v|w)}if(0<h.L&&(h.wa[h.Y+h.ja]=h.gd[s.$b][s.Za],h.wa[h.Y+h.ja].La|=!d),l.Ka)return Zt(t,7,"Premature end-of-file encountered.")}if($t(t),h=n,l=1,s=(o=t).D,c=0<o.L&&o.M>=o.zb&&o.M<=o.Va,0==o.Aa)e:{if(s.M=o.M,s.uc=c,En(o,s),l=1,s=(x=o.D).Nb,c=(w=Ti[o.L])*o.R,f=w/2*o.B,y=16*s*o.R,S=8*s*o.B,d=o.sa,p=o.ta-c+y,g=o.qa,u=o.ra-f+S,m=o.Ha,b=o.Ia-f+S,F=0==(k=x.M),v=k>=o.Va-1,2==o.Aa&&En(o,x),x.uc)for(I=(N=o).D.M,e(N.D.uc),x=N.yb;x<N.Hb;++x){A=x,L=I;var C=(j=(z=N).D).Nb;_=z.R;var j=j.wa[j.Y+A],E=z.sa,O=z.ta+16*C*_+16*A,B=j.dd,M=j.tc;if(0!=M)if(e(3<=M),1==z.L)0<A&&wr(E,O,_,M+4),j.La&&_r(E,O,_,M),0<L&&vr(E,O,_,M+4),j.La&&yr(E,O,_,M);else{var R=z.B,T=z.qa,q=z.ra+8*C*R+8*A,D=z.Ha,z=z.Ia+8*C*R+8*A;C=j.ld,0<A&&(ur(E,O,_,M+4,B,C),dr(T,q,D,z,R,M+4,B,C)),j.La&&(gr(E,O,_,M,B,C),br(T,q,D,z,R,M,B,C)),0<L&&(cr(E,O,_,M+4,B,C),fr(T,q,D,z,R,M+4,B,C)),j.La&&(pr(E,O,_,M,B,C),mr(T,q,D,z,R,M,B,C))}}if(o.ia&&alert("todo:DitherRow"),null!=h.put){if(x=16*k,k=16*(k+1),F?(h.y=o.sa,h.O=o.ta+y,h.f=o.qa,h.N=o.ra+S,h.ea=o.Ha,h.W=o.Ia+S):(x-=w,h.y=d,h.O=p,h.f=g,h.N=u,h.ea=m,h.W=b),v||(k-=w),k>h.o&&(k=h.o),h.F=null,h.J=null,null!=o.Fa&&0<o.Fa.length&&x<k&&(h.J=un(o,h,x,k-x),h.F=o.mb,null==h.F&&0==h.F.length)){l=Zt(o,3,"Could not decode alpha data.");break e}x<h.j&&(w=h.j-x,x=h.j,e(!(1&w)),h.O+=o.R*w,h.N+=o.B*(w>>1),h.W+=o.B*(w>>1),null!=h.F&&(h.J+=h.width*w)),x<k&&(h.O+=h.v,h.N+=h.v>>1,h.W+=h.v>>1,null!=h.F&&(h.J+=h.v),h.ka=x-h.j,h.U=h.va-h.v,h.T=k-x,l=h.put(h))}s+1!=o.Ic||v||(r(o.sa,o.ta-c,d,p+16*o.R,c),r(o.qa,o.ra-f,g,u+8*o.B,f),r(o.Ha,o.Ia-f,m,b+8*o.B,f))}if(!l)return Zt(t,6,"Output aborted.")}return 1}(t,n)),null!=n.bc&&n.bc(n),o&=1}return o?(t.cb=0,o):0})(t,h)||(n=t.a)}}else n=t.a}0==n&&null!=u.Oa&&u.Oa.fd&&(n=Mn(u.ba))}u=n}c=0!=u?null:11>c?f.f.RGBA.eb:f.f.kb.y}else c=null;return c};var zi=[3,4,3,4,4,2,2,4,4,4,2,1,1]};function l(t,e){for(var n="",r=0;r<4;r++)n+=String.fromCharCode(t[e++]);return n}function c(t,e){return t[e+0]|t[e+1]<<8}function u(t,e){return(t[e+0]|t[e+1]<<8|t[e+2]<<16)>>>0}function f(t,e){return(t[e+0]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}new h;var d=[0],p=[0],g=[],m=new h,b=t,v=function(t,e){var n={},r=0,i=!1,a=0,s=0;if(n.frames=[],!
/** @license
     * Copyright (c) 2017 Dominik Homberger
    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
    https://webpjs.appspot.com
    WebPRiffParser dominikhlbg@gmail.com
    */
function(t,e){for(var n=0;n<4;n++)if(t[e+n]!="RIFF".charCodeAt(n))return!0;return!1}(t,e)){for(f(t,e+=4),e+=8;e<t.length;){var o=l(t,e),h=f(t,e+=4);e+=4;var d=h+(1&h);switch(o){case"VP8 ":case"VP8L":void 0===n.frames[r]&&(n.frames[r]={}),(m=n.frames[r]).src_off=i?s:e-8,m.src_size=a+h+8,r++,i&&(i=!1,a=0,s=0);break;case"VP8X":(m=n.header={}).feature_flags=t[e];var p=e+4;m.canvas_width=1+u(t,p),p+=3,m.canvas_height=1+u(t,p),p+=3;break;case"ALPH":i=!0,a=d+8,s=e-8;break;case"ANIM":(m=n.header).bgcolor=f(t,e),p=e+4,m.loop_count=c(t,p),p+=2;break;case"ANMF":var g,m;(m=n.frames[r]={}).offset_x=2*u(t,e),e+=3,m.offset_y=2*u(t,e),e+=3,m.width=1+u(t,e),e+=3,m.height=1+u(t,e),e+=3,m.duration=u(t,e),e+=3,g=t[e++],m.dispose=1&g,m.blend=g>>1&1}"ANMF"!=o&&(e+=d)}return n}}(b,0);v.response=b,v.rgbaoutput=!0,v.dataurl=!1;var w=v.header?v.header:null,y=v.frames?v.frames:null;if(w){w.loop_counter=w.loop_count,d=[w.canvas_height],p=[w.canvas_width];for(var _=0;_<y.length&&0!=y[_].blend;_++);}var x=y[0],A=m.WebPDecodeRGBA(b,x.src_off,x.src_size,p,d);x.rgba=A,x.imgwidth=p[0],x.imgheight=d[0];for(var L=0;L<p[0]*d[0]*4;L++)g[L]=A[L];return this.width=p,this.height=d,this.data=g,this}!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.METRE=1]="METRE"}(fa||(fa={})),R.API.processPNG=function(t,e,r,i){if(this.__addimage__.isArrayBuffer(t)&&(t=new Uint8Array(t)),this.__addimage__.isArrayBufferView(t)){var a,s=new ua(t,{checkCrc:!0}).decode(),o=s.width,h=s.height,l=s.channels,c=s.palette,u=s.depth;a=c&&1===l?function(t){for(var e=t.width,r=t.height,i=t.data,a=t.palette,s=t.depth,o=!1,h=[],l=[],c=void 0,u=!1,f=0,d=0;d<a.length;d++){var p=n(a[d],4),g=p[0],m=p[1],b=p[2],v=p[3];h.push(g,m,b),null!=v&&(0===v?(f++,l.length<1&&l.push(d)):v<255&&(u=!0))}if(u||f>1){o=!0,l=void 0;var w=e*r;c=new Uint8Array(w);for(var y=new DataView(i.buffer),_=0;_<w;_++){var x=n(a[Sa(y,_,s)],4)[3];c[_]=x}}else 0===f&&(l=void 0);return{colorSpace:"Indexed",colorsPerPixel:1,sMaskBitsPerComponent:o?8:void 0,colorBytes:i,alphaBytes:c,needSMask:o,palette:h,mask:l}}(s):2===l||4===l?function(t){for(var e=t.data,n=t.width,r=t.height,i=t.channels,a=t.depth,s=2===i?"DeviceGray":"DeviceRGB",o=i-1,h=n*r,l=o,c=h*l,u=1*h,f=Math.ceil(c*a/8),d=Math.ceil(u*a/8),p=new Uint8Array(f),g=new Uint8Array(d),m=new DataView(e.buffer),b=new DataView(p.buffer),v=new DataView(g.buffer),w=!1,y=0;y<h;y++){for(var _=y*i,x=0;x<l;x++)ka(b,Sa(m,_+x,a),y*l+x,a);var A=Sa(m,_+l,a);A<(1<<a)-1&&(w=!0),ka(v,A,1*y,a)}return{colorSpace:s,colorsPerPixel:o,sMaskBitsPerComponent:w?a:void 0,colorBytes:p,alphaBytes:g,needSMask:w}}(s):function(t){var e,n=t.data,r=1===t.channels?"DeviceGray":"DeviceRGB",i="DeviceGray"===r?1:3;return e=n instanceof Uint16Array?function(t){for(var e=t.length,n=new Uint8Array(2*e),r=new DataView(n.buffer,n.byteOffset,n.byteLength),i=0;i<e;i++)r.setUint16(2*i,t[i],!1);return n}(n):n,{colorSpace:r,colorsPerPixel:i,colorBytes:e,needSMask:!1}}(s);var f,d,p,g=a,m=g.colorSpace,b=g.colorsPerPixel,v=g.sMaskBitsPerComponent,w=g.colorBytes,y=g.alphaBytes,_=g.needSMask,x=g.palette,A=g.mask,L=null;return i!==R.API.image_compression.NONE?(L=function(t){var e;switch(t){case R.API.image_compression.FAST:e=11;break;case R.API.image_compression.MEDIUM:e=13;break;case R.API.image_compression.SLOW:e=14;break;default:e=12}return e}(i),f=this.decode.FLATE_DECODE,d="/Predictor ".concat(L," /Colors ").concat(b," /BitsPerComponent ").concat(u," /Columns ").concat(o),t=va(w,Math.ceil(o*b*u/8),b,u,i),_&&(p=va(y,Math.ceil(o*v/8),1,v,i))):(f=void 0,d=void 0,t=w,_&&(p=y)),(this.__addimage__.isArrayBuffer(t)||this.__addimage__.isArrayBufferView(t))&&(t=this.__addimage__.arrayBufferToBinaryString(t)),(p&&this.__addimage__.isArrayBuffer(p)||this.__addimage__.isArrayBufferView(p))&&(p=this.__addimage__.arrayBufferToBinaryString(p)),{alias:r,data:t,index:e,filter:f,decodeParameters:d,transparency:A,palette:x,sMask:p,predictor:L,width:o,height:h,bitsPerComponent:u,sMaskBitsPerComponent:v,colorSpace:m}}},function(t){t.processGIF89A=function(e,n,r,i){var a=new Fa(e),s=a.width,o=a.height,h=[];a.decodeAndBlitFrameRGBA(0,h);var l={data:h,width:s,height:o},c=new Ca(100).encode(l,100);return t.processJPEG.call(this,c,n,r,i)},t.processGIF87A=t.processGIF89A}(R.API),ja.prototype.parseHeader=function(){if(this.fileSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.reserved=this.datav.getUint32(this.pos,!0),this.pos+=4,this.offset=this.datav.getUint32(this.pos,!0),this.pos+=4,this.headerSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.width=this.datav.getUint32(this.pos,!0),this.pos+=4,this.height=this.datav.getInt32(this.pos,!0),this.pos+=4,this.planes=this.datav.getUint16(this.pos,!0),this.pos+=2,this.bitPP=this.datav.getUint16(this.pos,!0),this.pos+=2,this.compress=this.datav.getUint32(this.pos,!0),this.pos+=4,this.rawSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.hr=this.datav.getUint32(this.pos,!0),this.pos+=4,this.vr=this.datav.getUint32(this.pos,!0),this.pos+=4,this.colors=this.datav.getUint32(this.pos,!0),this.pos+=4,this.importantColors=this.datav.getUint32(this.pos,!0),this.pos+=4,16===this.bitPP&&this.is_with_alpha&&(this.bitPP=15),this.bitPP<15){var t=0===this.colors?1<<this.bitPP:this.colors;this.palette=new Array(t);for(var e=0;e<t;e++){var n=this.datav.getUint8(this.pos++,!0),r=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0),a=this.datav.getUint8(this.pos++,!0);this.palette[e]={red:i,green:r,blue:n,quad:a}}}this.height<0&&(this.height*=-1,this.bottom_up=!1)},ja.prototype.parseBGR=function(){this.pos=this.offset;try{var t="bit"+this.bitPP,e=this.width*this.height*4;this.data=new Uint8Array(e),this[t]()}catch(es){s.log("bit decode error:"+es)}},ja.prototype.bit1=function(){var t,e=Math.ceil(this.width/8),n=e%4;for(t=this.height-1;t>=0;t--){for(var r=this.bottom_up?t:this.height-1-t,i=0;i<e;i++)for(var a=this.datav.getUint8(this.pos++,!0),s=r*this.width*4+8*i*4,o=0;o<8&&8*i+o<this.width;o++){var h=this.palette[a>>7-o&1];this.data[s+4*o]=h.blue,this.data[s+4*o+1]=h.green,this.data[s+4*o+2]=h.red,this.data[s+4*o+3]=255}0!==n&&(this.pos+=4-n)}},ja.prototype.bit4=function(){for(var t=Math.ceil(this.width/2),e=t%4,n=this.height-1;n>=0;n--){for(var r=this.bottom_up?n:this.height-1-n,i=0;i<t;i++){var a=this.datav.getUint8(this.pos++,!0),s=r*this.width*4+2*i*4,o=a>>4,h=15&a,l=this.palette[o];if(this.data[s]=l.blue,this.data[s+1]=l.green,this.data[s+2]=l.red,this.data[s+3]=255,2*i+1>=this.width)break;l=this.palette[h],this.data[s+4]=l.blue,this.data[s+4+1]=l.green,this.data[s+4+2]=l.red,this.data[s+4+3]=255}0!==e&&(this.pos+=4-e)}},ja.prototype.bit8=function(){for(var t=this.width%4,e=this.height-1;e>=0;e--){for(var n=this.bottom_up?e:this.height-1-e,r=0;r<this.width;r++){var i=this.datav.getUint8(this.pos++,!0),a=n*this.width*4+4*r;if(i<this.palette.length){var s=this.palette[i];this.data[a]=s.red,this.data[a+1]=s.green,this.data[a+2]=s.blue,this.data[a+3]=255}else this.data[a]=255,this.data[a+1]=255,this.data[a+2]=255,this.data[a+3]=255}0!==t&&(this.pos+=4-t)}},ja.prototype.bit15=function(){for(var t=this.width%3,e=parseInt("11111",2),n=this.height-1;n>=0;n--){for(var r=this.bottom_up?n:this.height-1-n,i=0;i<this.width;i++){var a=this.datav.getUint16(this.pos,!0);this.pos+=2;var s=(a&e)/e*255|0,o=(a>>5&e)/e*255|0,h=(a>>10&e)/e*255|0,l=a>>15?255:0,c=r*this.width*4+4*i;this.data[c]=h,this.data[c+1]=o,this.data[c+2]=s,this.data[c+3]=l}this.pos+=t}},ja.prototype.bit16=function(){for(var t=this.width%3,e=parseInt("11111",2),n=parseInt("111111",2),r=this.height-1;r>=0;r--){for(var i=this.bottom_up?r:this.height-1-r,a=0;a<this.width;a++){var s=this.datav.getUint16(this.pos,!0);this.pos+=2;var o=(s&e)/e*255|0,h=(s>>5&n)/n*255|0,l=(s>>11)/e*255|0,c=i*this.width*4+4*a;this.data[c]=l,this.data[c+1]=h,this.data[c+2]=o,this.data[c+3]=255}this.pos+=t}},ja.prototype.bit24=function(){for(var t=this.height-1;t>=0;t--){for(var e=this.bottom_up?t:this.height-1-t,n=0;n<this.width;n++){var r=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0),a=this.datav.getUint8(this.pos++,!0),s=e*this.width*4+4*n;this.data[s]=a,this.data[s+1]=i,this.data[s+2]=r,this.data[s+3]=255}this.pos+=this.width%4}},ja.prototype.bit32=function(){for(var t=this.height-1;t>=0;t--)for(var e=this.bottom_up?t:this.height-1-t,n=0;n<this.width;n++){var r=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0),a=this.datav.getUint8(this.pos++,!0),s=this.datav.getUint8(this.pos++,!0),o=e*this.width*4+4*n;this.data[o]=a,this.data[o+1]=i,this.data[o+2]=r,this.data[o+3]=s}},ja.prototype.getData=function(){return this.data},
/**
   * @license
   * Copyright (c) 2018 Aras Abbasi
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){t.processBMP=function(e,n,r,i){var a=new ja(e,!1),s=a.width,o=a.height,h={data:a.getData(),width:s,height:o},l=new Ca(100).encode(h,100);return t.processJPEG.call(this,l,n,r,i)}}(R.API),Ea.prototype.getData=function(){return this.data},
/**
   * @license
   * Copyright (c) 2019 Aras Abbasi
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){t.processWEBP=function(e,n,r,i){var a=new Ea(e),s=a.width,o=a.height,h={data:a.getData(),width:s,height:o},l=new Ca(100).encode(h,100);return t.processJPEG.call(this,l,n,r,i)}}(R.API),
/**
   * @license
   *
   * Copyright (c) 2021 Antti Palola, https://github.com/Pantura
   *
   * Permission is hereby granted, free of charge, to any person obtaining
   * a copy of this software and associated documentation files (the
   * "Software"), to deal in the Software without restriction, including
   * without limitation the rights to use, copy, modify, merge, publish,
   * distribute, sublicense, and/or sell copies of the Software, and to
   * permit persons to whom the Software is furnished to do so, subject to
   * the following conditions:
   *
   * The above copyright notice and this permission notice shall be
   * included in all copies or substantial portions of the Software.
   *
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
   * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
   * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
   * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
   * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
   * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
   * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
   * ====================================================================
   */
function(t){t.processRGBA=function(t,e,n){for(var r=t.data,i=r.length,a=new Uint8Array(i/4*3),s=new Uint8Array(i/4),o=0,h=0,l=0;l<i;l+=4){var c=r[l],u=r[l+1],f=r[l+2],d=r[l+3];a[o++]=c,a[o++]=u,a[o++]=f,s[h++]=d}var p=this.__addimage__.arrayBufferToBinaryString(a);return{alpha:this.__addimage__.arrayBufferToBinaryString(s),data:p,index:e,alias:n,colorSpace:"DeviceRGB",bitsPerComponent:8,width:t.width,height:t.height}}}(R.API),
/**
   * @license
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){t.setLanguage=function(t){return void 0===this.internal.languageSettings&&(this.internal.languageSettings={},this.internal.languageSettings.isSubscribed=!1),void 0!=={af:"Afrikaans",sq:"Albanian",ar:"Arabic (Standard)","ar-DZ":"Arabic (Algeria)","ar-BH":"Arabic (Bahrain)","ar-EG":"Arabic (Egypt)","ar-IQ":"Arabic (Iraq)","ar-JO":"Arabic (Jordan)","ar-KW":"Arabic (Kuwait)","ar-LB":"Arabic (Lebanon)","ar-LY":"Arabic (Libya)","ar-MA":"Arabic (Morocco)","ar-OM":"Arabic (Oman)","ar-QA":"Arabic (Qatar)","ar-SA":"Arabic (Saudi Arabia)","ar-SY":"Arabic (Syria)","ar-TN":"Arabic (Tunisia)","ar-AE":"Arabic (U.A.E.)","ar-YE":"Arabic (Yemen)",an:"Aragonese",hy:"Armenian",as:"Assamese",ast:"Asturian",az:"Azerbaijani",eu:"Basque",be:"Belarusian",bn:"Bengali",bs:"Bosnian",br:"Breton",bg:"Bulgarian",my:"Burmese",ca:"Catalan",ch:"Chamorro",ce:"Chechen",zh:"Chinese","zh-HK":"Chinese (Hong Kong)","zh-CN":"Chinese (PRC)","zh-SG":"Chinese (Singapore)","zh-TW":"Chinese (Taiwan)",cv:"Chuvash",co:"Corsican",cr:"Cree",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch (Standard)","nl-BE":"Dutch (Belgian)",en:"English","en-AU":"English (Australia)","en-BZ":"English (Belize)","en-CA":"English (Canada)","en-IE":"English (Ireland)","en-JM":"English (Jamaica)","en-NZ":"English (New Zealand)","en-PH":"English (Philippines)","en-ZA":"English (South Africa)","en-TT":"English (Trinidad & Tobago)","en-GB":"English (United Kingdom)","en-US":"English (United States)","en-ZW":"English (Zimbabwe)",eo:"Esperanto",et:"Estonian",fo:"Faeroese",fj:"Fijian",fi:"Finnish",fr:"French (Standard)","fr-BE":"French (Belgium)","fr-CA":"French (Canada)","fr-FR":"French (France)","fr-LU":"French (Luxembourg)","fr-MC":"French (Monaco)","fr-CH":"French (Switzerland)",fy:"Frisian",fur:"Friulian",gd:"Gaelic (Scots)","gd-IE":"Gaelic (Irish)",gl:"Galacian",ka:"Georgian",de:"German (Standard)","de-AT":"German (Austria)","de-DE":"German (Germany)","de-LI":"German (Liechtenstein)","de-LU":"German (Luxembourg)","de-CH":"German (Switzerland)",el:"Greek",gu:"Gujurati",ht:"Haitian",he:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",iu:"Inuktitut",ga:"Irish",it:"Italian (Standard)","it-CH":"Italian (Switzerland)",ja:"Japanese",kn:"Kannada",ks:"Kashmiri",kk:"Kazakh",km:"Khmer",ky:"Kirghiz",tlh:"Klingon",ko:"Korean","ko-KP":"Korean (North Korea)","ko-KR":"Korean (South Korea)",la:"Latin",lv:"Latvian",lt:"Lithuanian",lb:"Luxembourgish",mk:"North Macedonia",ms:"Malay",ml:"Malayalam",mt:"Maltese",mi:"Maori",mr:"Marathi",mo:"Moldavian",nv:"Navajo",ng:"Ndonga",ne:"Nepali",no:"Norwegian",nb:"Norwegian (Bokmal)",nn:"Norwegian (Nynorsk)",oc:"Occitan",or:"Oriya",om:"Oromo",fa:"Persian","fa-IR":"Persian/Iran",pl:"Polish",pt:"Portuguese","pt-BR":"Portuguese (Brazil)",pa:"Punjabi","pa-IN":"Punjabi (India)","pa-PK":"Punjabi (Pakistan)",qu:"Quechua",rm:"Rhaeto-Romanic",ro:"Romanian","ro-MO":"Romanian (Moldavia)",ru:"Russian","ru-MO":"Russian (Moldavia)",sz:"Sami (Lappish)",sg:"Sango",sa:"Sanskrit",sc:"Sardinian",sd:"Sindhi",si:"Singhalese",sr:"Serbian",sk:"Slovak",sl:"Slovenian",so:"Somani",sb:"Sorbian",es:"Spanish","es-AR":"Spanish (Argentina)","es-BO":"Spanish (Bolivia)","es-CL":"Spanish (Chile)","es-CO":"Spanish (Colombia)","es-CR":"Spanish (Costa Rica)","es-DO":"Spanish (Dominican Republic)","es-EC":"Spanish (Ecuador)","es-SV":"Spanish (El Salvador)","es-GT":"Spanish (Guatemala)","es-HN":"Spanish (Honduras)","es-MX":"Spanish (Mexico)","es-NI":"Spanish (Nicaragua)","es-PA":"Spanish (Panama)","es-PY":"Spanish (Paraguay)","es-PE":"Spanish (Peru)","es-PR":"Spanish (Puerto Rico)","es-ES":"Spanish (Spain)","es-UY":"Spanish (Uruguay)","es-VE":"Spanish (Venezuela)",sx:"Sutu",sw:"Swahili",sv:"Swedish","sv-FI":"Swedish (Finland)","sv-SV":"Swedish (Sweden)",ta:"Tamil",tt:"Tatar",te:"Teluga",th:"Thai",tig:"Tigre",ts:"Tsonga",tn:"Tswana",tr:"Turkish",tk:"Turkmen",uk:"Ukrainian",hsb:"Upper Sorbian",ur:"Urdu",ve:"Venda",vi:"Vietnamese",vo:"Volapuk",wa:"Walloon",cy:"Welsh",xh:"Xhosa",ji:"Yiddish",zu:"Zulu"}[t]&&(this.internal.languageSettings.languageCode=t,!1===this.internal.languageSettings.isSubscribed&&(this.internal.events.subscribe("putCatalog",function(){this.internal.write("/Lang ("+this.internal.languageSettings.languageCode+")")}),this.internal.languageSettings.isSubscribed=!0)),this}}(R.API),da=R.API,pa=da.getCharWidthsArray=function(t,e){var n,i,a=(e=e||{}).font||this.internal.getFont(),s=e.fontSize||this.internal.getFontSize(),o=e.charSpace||this.internal.getCharSpace(),h=e.widths?e.widths:a.metadata.Unicode.widths,l=h.fof?h.fof:1,c=e.kerning?e.kerning:a.metadata.Unicode.kerning,u=c.fof?c.fof:1,f=!1!==e.doKerning,d=0,p=t.length,g=0,m=h[0]||l,b=[];for(n=0;n<p;n++)i=t.charCodeAt(n),"function"==typeof a.metadata.widthOfString?b.push((a.metadata.widthOfGlyph(a.metadata.characterToGlyph(i))+o*(1e3/s)||0)/1e3):(d=f&&"object"===r(c[i])&&!isNaN(parseInt(c[i][g],10))?c[i][g]/u:0,b.push((h[i]||m)/l+d)),g=i;return b},ga=da.getStringUnitWidth=function(t,e){var n=(e=e||{}).fontSize||this.internal.getFontSize(),r=e.font||this.internal.getFont(),i=e.charSpace||this.internal.getCharSpace();return da.processArabic&&(t=da.processArabic(t)),"function"==typeof r.metadata.widthOfString?r.metadata.widthOfString(t,n,i)/n:pa.apply(this,arguments).reduce(function(t,e){return t+e},0)},ma=function(t,e,n,r){for(var i=[],a=0,s=t.length,o=0;a!==s&&o+e[a]<n;)o+=e[a],a++;i.push(t.slice(0,a));var h=a;for(o=0;a!==s;)o+e[a]>r&&(i.push(t.slice(h,a)),o=0,h=a),o+=e[a],a++;return h!==a&&i.push(t.slice(h,a)),i},ba=function(t,e,n){n||(n={});var r,i,a,s,o,h,l,c=[],u=[c],f=n.textIndent||0,d=0,p=0,g=t.split(" "),m=pa.apply(this,[" ",n])[0];if(h=-1===n.lineIndent?g[0].length+2:n.lineIndent||0){var b=Array(h).join(" "),v=[];g.map(function(t){(t=t.split(/\s*\n/)).length>1?v=v.concat(t.map(function(t,e){return(e&&t.length?"\n":"")+t})):v.push(t[0])}),g=v,h=ga.apply(this,[b,n])}for(a=0,s=g.length;a<s;a++){var w=0;if(r=g[a],h&&"\n"==r[0]&&(r=r.substr(1),w=1),f+d+(p=(i=pa.apply(this,[r,n])).reduce(function(t,e){return t+e},0))>e||w){if(p>e){for(o=ma.apply(this,[r,i,e-(f+d),e]),c.push(o.shift()),c=[o.pop()];o.length;)u.push([o.shift()]);p=i.slice(r.length-(c[0]?c[0].length:0)).reduce(function(t,e){return t+e},0)}else c=[r];u.push(c),f=p+h,d=m}else c.push(r),f+=d+p,d=m}return l=h?function(t,e){return(e?b:"")+t.join(" ")}:function(t){return t.join(" ")},u.map(l)},da.splitTextToSize=function(t,e,n){var r,i=(n=n||{}).fontSize||this.internal.getFontSize(),a=function(t){if(t.widths&&t.kerning)return{widths:t.widths,kerning:t.kerning};var e=this.internal.getFont(t.fontName,t.fontStyle),n="Unicode";return e.metadata[n]?{widths:e.metadata[n].widths||{0:1},kerning:e.metadata[n].kerning||{}}:{font:e.metadata,fontSize:this.internal.getFontSize(),charSpace:this.internal.getCharSpace()}}.call(this,n);r=Array.isArray(t)?t:String(t).split(/\r?\n/);var s=1*this.internal.scaleFactor*e/i;a.textIndent=n.textIndent?1*n.textIndent*this.internal.scaleFactor/i:0,a.lineIndent=n.lineIndent;var o,h,l=[];for(o=0,h=r.length;o<h;o++)l=l.concat(ba.apply(this,[r[o],s,a]));return l},function(t){t.__fontmetrics__=t.__fontmetrics__||{};for(var e="0123456789abcdef",n="klmnopqrstuvwxyz",i={},a={},s=0;s<16;s++)i[n[s]]=e[s],a[e[s]]=n[s];var o=function(t){return"0x"+parseInt(t,10).toString(16)},h=t.__fontmetrics__.compress=function(t){var e,n,i,s,l=["{"];for(var c in t){if(e=t[c],isNaN(parseInt(c,10))?n="'"+c+"'":(c=parseInt(c,10),n=(n=o(c).slice(2)).slice(0,-1)+a[n.slice(-1)]),"number"==typeof e)e<0?(i=o(e).slice(3),s="-"):(i=o(e).slice(2),s=""),i=s+i.slice(0,-1)+a[i.slice(-1)];else{if("object"!==r(e))throw new Error("Don't know what to do with value type "+r(e)+".");i=h(e)}l.push(n+i)}return l.push("}"),l.join("")},l=t.__fontmetrics__.uncompress=function(t){if("string"!=typeof t)throw new Error("Invalid argument passed to uncompress.");for(var e,n,r,a,s={},o=1,h=s,l=[],c="",u="",f=t.length-1,d=1;d<f;d+=1)"'"==(a=t[d])?e?(r=e.join(""),e=void 0):e=[]:e?e.push(a):"{"==a?(l.push([h,r]),h={},r=void 0):"}"==a?((n=l.pop())[0][n[1]]=h,r=void 0,h=n[0]):"-"==a?o=-1:void 0===r?i.hasOwnProperty(a)?(c+=i[a],r=parseInt(c,16)*o,o=1,c=""):c+=a:i.hasOwnProperty(a)?(u+=i[a],h[r]=parseInt(u,16)*o,o=1,r=void 0,u=""):u+=a;return s},c={codePages:["WinAnsiEncoding"],WinAnsiEncoding:l("{19m8n201n9q201o9r201s9l201t9m201u8m201w9n201x9o201y8o202k8q202l8r202m9p202q8p20aw8k203k8t203t8v203u9v2cq8s212m9t15m8w15n9w2dw9s16k8u16l9u17s9z17x8y17y9y}")},u={Unicode:{Courier:c,"Courier-Bold":c,"Courier-BoldOblique":c,"Courier-Oblique":c,Helvetica:c,"Helvetica-Bold":c,"Helvetica-BoldOblique":c,"Helvetica-Oblique":c,"Times-Roman":c,"Times-Bold":c,"Times-BoldItalic":c,"Times-Italic":c}},f={Unicode:{"Courier-Oblique":l("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-BoldItalic":l("{'widths'{k3o2q4ycx2r201n3m201o6o201s2l201t2l201u2l201w3m201x3m201y3m2k1t2l2r202m2n2n3m2o3m2p5n202q6o2r1w2s2l2t2l2u3m2v3t2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w3t3x3t3y3t3z3m4k5n4l4m4m4m4n4m4o4s4p4m4q4m4r4s4s4y4t2r4u3m4v4m4w3x4x5t4y4s4z4s5k3x5l4s5m4m5n3r5o3x5p4s5q4m5r5t5s4m5t3x5u3x5v2l5w1w5x2l5y3t5z3m6k2l6l3m6m3m6n2w6o3m6p2w6q2l6r3m6s3r6t1w6u1w6v3m6w1w6x4y6y3r6z3m7k3m7l3m7m2r7n2r7o1w7p3r7q2w7r4m7s3m7t2w7u2r7v2n7w1q7x2n7y3t202l3mcl4mal2ram3man3mao3map3mar3mas2lat4uau1uav3maw3way4uaz2lbk2sbl3t'fof'6obo2lbp3tbq3mbr1tbs2lbu1ybv3mbz3mck4m202k3mcm4mcn4mco4mcp4mcq5ycr4mcs4mct4mcu4mcv4mcw2r2m3rcy2rcz2rdl4sdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek3mel3mem3men3meo3mep3meq4ser2wes2wet2weu2wev2wew1wex1wey1wez1wfl3rfm3mfn3mfo3mfp3mfq3mfr3tfs3mft3rfu3rfv3rfw3rfz2w203k6o212m6o2dw2l2cq2l3t3m3u2l17s3x19m3m}'kerning'{cl{4qu5kt5qt5rs17ss5ts}201s{201ss}201t{cks4lscmscnscoscpscls2wu2yu201ts}201x{2wu2yu}2k{201ts}2w{4qx5kx5ou5qx5rs17su5tu}2x{17su5tu5ou}2y{4qx5kx5ou5qx5rs17ss5ts}'fof'-6ofn{17sw5tw5ou5qw5rs}7t{cksclscmscnscoscps4ls}3u{17su5tu5os5qs}3v{17su5tu5os5qs}7p{17su5tu}ck{4qu5kt5qt5rs17ss5ts}4l{4qu5kt5qt5rs17ss5ts}cm{4qu5kt5qt5rs17ss5ts}cn{4qu5kt5qt5rs17ss5ts}co{4qu5kt5qt5rs17ss5ts}cp{4qu5kt5qt5rs17ss5ts}6l{4qu5ou5qw5rt17su5tu}5q{ckuclucmucnucoucpu4lu}5r{ckuclucmucnucoucpu4lu}7q{cksclscmscnscoscps4ls}6p{4qu5ou5qw5rt17sw5tw}ek{4qu5ou5qw5rt17su5tu}el{4qu5ou5qw5rt17su5tu}em{4qu5ou5qw5rt17su5tu}en{4qu5ou5qw5rt17su5tu}eo{4qu5ou5qw5rt17su5tu}ep{4qu5ou5qw5rt17su5tu}es{17ss5ts5qs4qu}et{4qu5ou5qw5rt17sw5tw}eu{4qu5ou5qw5rt17ss5ts}ev{17ss5ts5qs4qu}6z{17sw5tw5ou5qw5rs}fm{17sw5tw5ou5qw5rs}7n{201ts}fo{17sw5tw5ou5qw5rs}fp{17sw5tw5ou5qw5rs}fq{17sw5tw5ou5qw5rs}7r{cksclscmscnscoscps4ls}fs{17sw5tw5ou5qw5rs}ft{17su5tu}fu{17su5tu}fv{17su5tu}fw{17su5tu}fz{cksclscmscnscoscps4ls}}}"),"Helvetica-Bold":l("{'widths'{k3s2q4scx1w201n3r201o6o201s1w201t1w201u1w201w3m201x3m201y3m2k1w2l2l202m2n2n3r2o3r2p5t202q6o2r1s2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v2l3w3u3x3u3y3u3z3x4k6l4l4s4m4s4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3r4v4s4w3x4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v2l5w1w5x2l5y3u5z3r6k2l6l3r6m3x6n3r6o3x6p3r6q2l6r3x6s3x6t1w6u1w6v3r6w1w6x5t6y3x6z3x7k3x7l3x7m2r7n3r7o2l7p3x7q3r7r4y7s3r7t3r7u3m7v2r7w1w7x2r7y3u202l3rcl4sal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3xbq3rbr1wbs2lbu2obv3rbz3xck4s202k3rcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw1w2m2zcy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3res3ret3reu3rev3rew1wex1wey1wez1wfl3xfm3xfn3xfo3xfp3xfq3xfr3ufs3xft3xfu3xfv3xfw3xfz3r203k6o212m6o2dw2l2cq2l3t3r3u2l17s4m19m3r}'kerning'{cl{4qs5ku5ot5qs17sv5tv}201t{2ww4wy2yw}201w{2ks}201x{2ww4wy2yw}2k{201ts201xs}2w{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}2x{5ow5qs}2y{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}'fof'-6o7p{17su5tu5ot}ck{4qs5ku5ot5qs17sv5tv}4l{4qs5ku5ot5qs17sv5tv}cm{4qs5ku5ot5qs17sv5tv}cn{4qs5ku5ot5qs17sv5tv}co{4qs5ku5ot5qs17sv5tv}cp{4qs5ku5ot5qs17sv5tv}6l{17st5tt5os}17s{2kwclvcmvcnvcovcpv4lv4wwckv}5o{2kucltcmtcntcotcpt4lt4wtckt}5q{2ksclscmscnscoscps4ls4wvcks}5r{2ks4ws}5t{2kwclvcmvcnvcovcpv4lv4wwckv}eo{17st5tt5os}fu{17su5tu5ot}6p{17ss5ts}ek{17st5tt5os}el{17st5tt5os}em{17st5tt5os}en{17st5tt5os}6o{201ts}ep{17st5tt5os}es{17ss5ts}et{17ss5ts}eu{17ss5ts}ev{17ss5ts}6z{17su5tu5os5qt}fm{17su5tu5os5qt}fn{17su5tu5os5qt}fo{17su5tu5os5qt}fp{17su5tu5os5qt}fq{17su5tu5os5qt}fs{17su5tu5os5qt}ft{17su5tu5ot}7m{5os}fv{17su5tu5ot}fw{17su5tu5ot}}}"),Courier:l("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Courier-BoldOblique":l("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-Bold":l("{'widths'{k3q2q5ncx2r201n3m201o6o201s2l201t2l201u2l201w3m201x3m201y3m2k1t2l2l202m2n2n3m2o3m2p6o202q6o2r1w2s2l2t2l2u3m2v3t2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w3t3x3t3y3t3z3m4k5x4l4s4m4m4n4s4o4s4p4m4q3x4r4y4s4y4t2r4u3m4v4y4w4m4x5y4y4s4z4y5k3x5l4y5m4s5n3r5o4m5p4s5q4s5r6o5s4s5t4s5u4m5v2l5w1w5x2l5y3u5z3m6k2l6l3m6m3r6n2w6o3r6p2w6q2l6r3m6s3r6t1w6u2l6v3r6w1w6x5n6y3r6z3m7k3r7l3r7m2w7n2r7o2l7p3r7q3m7r4s7s3m7t3m7u2w7v2r7w1q7x2r7y3o202l3mcl4sal2lam3man3mao3map3mar3mas2lat4uau1yav3maw3tay4uaz2lbk2sbl3t'fof'6obo2lbp3rbr1tbs2lbu2lbv3mbz3mck4s202k3mcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw2r2m3rcy2rcz2rdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3rek3mel3mem3men3meo3mep3meq4ser2wes2wet2weu2wev2wew1wex1wey1wez1wfl3rfm3mfn3mfo3mfp3mfq3mfr3tfs3mft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3m3u2l17s4s19m3m}'kerning'{cl{4qt5ks5ot5qy5rw17sv5tv}201t{cks4lscmscnscoscpscls4wv}2k{201ts}2w{4qu5ku7mu5os5qx5ru17su5tu}2x{17su5tu5ou5qs}2y{4qv5kv7mu5ot5qz5ru17su5tu}'fof'-6o7t{cksclscmscnscoscps4ls}3u{17su5tu5os5qu}3v{17su5tu5os5qu}fu{17su5tu5ou5qu}7p{17su5tu5ou5qu}ck{4qt5ks5ot5qy5rw17sv5tv}4l{4qt5ks5ot5qy5rw17sv5tv}cm{4qt5ks5ot5qy5rw17sv5tv}cn{4qt5ks5ot5qy5rw17sv5tv}co{4qt5ks5ot5qy5rw17sv5tv}cp{4qt5ks5ot5qy5rw17sv5tv}6l{17st5tt5ou5qu}17s{ckuclucmucnucoucpu4lu4wu}5o{ckuclucmucnucoucpu4lu4wu}5q{ckzclzcmzcnzcozcpz4lz4wu}5r{ckxclxcmxcnxcoxcpx4lx4wu}5t{ckuclucmucnucoucpu4lu4wu}7q{ckuclucmucnucoucpu4lu}6p{17sw5tw5ou5qu}ek{17st5tt5qu}el{17st5tt5ou5qu}em{17st5tt5qu}en{17st5tt5qu}eo{17st5tt5qu}ep{17st5tt5ou5qu}es{17ss5ts5qu}et{17sw5tw5ou5qu}eu{17sw5tw5ou5qu}ev{17ss5ts5qu}6z{17sw5tw5ou5qu5rs}fm{17sw5tw5ou5qu5rs}fn{17sw5tw5ou5qu5rs}fo{17sw5tw5ou5qu5rs}fp{17sw5tw5ou5qu5rs}fq{17sw5tw5ou5qu5rs}7r{cktcltcmtcntcotcpt4lt5os}fs{17sw5tw5ou5qu5rs}ft{17su5tu5ou5qu}7m{5os}fv{17su5tu5ou5qu}fw{17su5tu5ou5qu}fz{cksclscmscnscoscps4ls}}}"),Symbol:l("{'widths'{k3uaw4r19m3m2k1t2l2l202m2y2n3m2p5n202q6o3k3m2s2l2t2l2v3r2w1t3m3m2y1t2z1wbk2sbl3r'fof'6o3n3m3o3m3p3m3q3m3r3m3s3m3t3m3u1w3v1w3w3r3x3r3y3r3z2wbp3t3l3m5v2l5x2l5z3m2q4yfr3r7v3k7w1o7x3k}'kerning'{'fof'-6o}}"),Helvetica:l("{'widths'{k3p2q4mcx1w201n3r201o6o201s1q201t1q201u1q201w2l201x2l201y2l2k1w2l1w202m2n2n3r2o3r2p5t202q6o2r1n2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v1w3w3u3x3u3y3u3z3r4k6p4l4m4m4m4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3m4v4m4w3r4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v1w5w1w5x1w5y2z5z3r6k2l6l3r6m3r6n3m6o3r6p3r6q1w6r3r6s3r6t1q6u1q6v3m6w1q6x5n6y3r6z3r7k3r7l3r7m2l7n3m7o1w7p3r7q3m7r4s7s3m7t3m7u3m7v2l7w1u7x2l7y3u202l3rcl4mal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3rbr1wbs2lbu2obv3rbz3xck4m202k3rcm4mcn4mco4mcp4mcq6ocr4scs4mct4mcu4mcv4mcw1w2m2ncy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3mes3ret3reu3rev3rew1wex1wey1wez1wfl3rfm3rfn3rfo3rfp3rfq3rfr3ufs3xft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3r3u1w17s4m19m3r}'kerning'{5q{4wv}cl{4qs5kw5ow5qs17sv5tv}201t{2wu4w1k2yu}201x{2wu4wy2yu}17s{2ktclucmucnu4otcpu4lu4wycoucku}2w{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}2x{17sy5ty5oy5qs}2y{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}'fof'-6o7p{17sv5tv5ow}ck{4qs5kw5ow5qs17sv5tv}4l{4qs5kw5ow5qs17sv5tv}cm{4qs5kw5ow5qs17sv5tv}cn{4qs5kw5ow5qs17sv5tv}co{4qs5kw5ow5qs17sv5tv}cp{4qs5kw5ow5qs17sv5tv}6l{17sy5ty5ow}do{17st5tt}4z{17st5tt}7s{fst}dm{17st5tt}dn{17st5tt}5o{ckwclwcmwcnwcowcpw4lw4wv}dp{17st5tt}dq{17st5tt}7t{5ow}ds{17st5tt}5t{2ktclucmucnu4otcpu4lu4wycoucku}fu{17sv5tv5ow}6p{17sy5ty5ow5qs}ek{17sy5ty5ow}el{17sy5ty5ow}em{17sy5ty5ow}en{5ty}eo{17sy5ty5ow}ep{17sy5ty5ow}es{17sy5ty5qs}et{17sy5ty5ow5qs}eu{17sy5ty5ow5qs}ev{17sy5ty5ow5qs}6z{17sy5ty5ow5qs}fm{17sy5ty5ow5qs}fn{17sy5ty5ow5qs}fo{17sy5ty5ow5qs}fp{17sy5ty5qs}fq{17sy5ty5ow5qs}7r{5ow}fs{17sy5ty5ow5qs}ft{17sv5tv5ow}7m{5ow}fv{17sv5tv5ow}fw{17sv5tv5ow}}}"),"Helvetica-BoldOblique":l("{'widths'{k3s2q4scx1w201n3r201o6o201s1w201t1w201u1w201w3m201x3m201y3m2k1w2l2l202m2n2n3r2o3r2p5t202q6o2r1s2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v2l3w3u3x3u3y3u3z3x4k6l4l4s4m4s4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3r4v4s4w3x4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v2l5w1w5x2l5y3u5z3r6k2l6l3r6m3x6n3r6o3x6p3r6q2l6r3x6s3x6t1w6u1w6v3r6w1w6x5t6y3x6z3x7k3x7l3x7m2r7n3r7o2l7p3x7q3r7r4y7s3r7t3r7u3m7v2r7w1w7x2r7y3u202l3rcl4sal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3xbq3rbr1wbs2lbu2obv3rbz3xck4s202k3rcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw1w2m2zcy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3res3ret3reu3rev3rew1wex1wey1wez1wfl3xfm3xfn3xfo3xfp3xfq3xfr3ufs3xft3xfu3xfv3xfw3xfz3r203k6o212m6o2dw2l2cq2l3t3r3u2l17s4m19m3r}'kerning'{cl{4qs5ku5ot5qs17sv5tv}201t{2ww4wy2yw}201w{2ks}201x{2ww4wy2yw}2k{201ts201xs}2w{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}2x{5ow5qs}2y{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}'fof'-6o7p{17su5tu5ot}ck{4qs5ku5ot5qs17sv5tv}4l{4qs5ku5ot5qs17sv5tv}cm{4qs5ku5ot5qs17sv5tv}cn{4qs5ku5ot5qs17sv5tv}co{4qs5ku5ot5qs17sv5tv}cp{4qs5ku5ot5qs17sv5tv}6l{17st5tt5os}17s{2kwclvcmvcnvcovcpv4lv4wwckv}5o{2kucltcmtcntcotcpt4lt4wtckt}5q{2ksclscmscnscoscps4ls4wvcks}5r{2ks4ws}5t{2kwclvcmvcnvcovcpv4lv4wwckv}eo{17st5tt5os}fu{17su5tu5ot}6p{17ss5ts}ek{17st5tt5os}el{17st5tt5os}em{17st5tt5os}en{17st5tt5os}6o{201ts}ep{17st5tt5os}es{17ss5ts}et{17ss5ts}eu{17ss5ts}ev{17ss5ts}6z{17su5tu5os5qt}fm{17su5tu5os5qt}fn{17su5tu5os5qt}fo{17su5tu5os5qt}fp{17su5tu5os5qt}fq{17su5tu5os5qt}fs{17su5tu5os5qt}ft{17su5tu5ot}7m{5os}fv{17su5tu5ot}fw{17su5tu5ot}}}"),ZapfDingbats:l("{'widths'{k4u2k1w'fof'6o}'kerning'{'fof'-6o}}"),"Courier-Bold":l("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-Italic":l("{'widths'{k3n2q4ycx2l201n3m201o5t201s2l201t2l201u2l201w3r201x3r201y3r2k1t2l2l202m2n2n3m2o3m2p5n202q5t2r1p2s2l2t2l2u3m2v4n2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w4n3x4n3y4n3z3m4k5w4l3x4m3x4n4m4o4s4p3x4q3x4r4s4s4s4t2l4u2w4v4m4w3r4x5n4y4m4z4s5k3x5l4s5m3x5n3m5o3r5p4s5q3x5r5n5s3x5t3r5u3r5v2r5w1w5x2r5y2u5z3m6k2l6l3m6m3m6n2w6o3m6p2w6q1w6r3m6s3m6t1w6u1w6v2w6w1w6x4s6y3m6z3m7k3m7l3m7m2r7n2r7o1w7p3m7q2w7r4m7s2w7t2w7u2r7v2s7w1v7x2s7y3q202l3mcl3xal2ram3man3mao3map3mar3mas2lat4wau1vav3maw4nay4waz2lbk2sbl4n'fof'6obo2lbp3mbq3obr1tbs2lbu1zbv3mbz3mck3x202k3mcm3xcn3xco3xcp3xcq5tcr4mcs3xct3xcu3xcv3xcw2l2m2ucy2lcz2ldl4mdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek3mel3mem3men3meo3mep3meq4mer2wes2wet2weu2wev2wew1wex1wey1wez1wfl3mfm3mfn3mfo3mfp3mfq3mfr4nfs3mft3mfu3mfv3mfw3mfz2w203k6o212m6m2dw2l2cq2l3t3m3u2l17s3r19m3m}'kerning'{cl{5kt4qw}201s{201sw}201t{201tw2wy2yy6q-t}201x{2wy2yy}2k{201tw}2w{7qs4qy7rs5ky7mw5os5qx5ru17su5tu}2x{17ss5ts5os}2y{7qs4qy7rs5ky7mw5os5qx5ru17su5tu}'fof'-6o6t{17ss5ts5qs}7t{5os}3v{5qs}7p{17su5tu5qs}ck{5kt4qw}4l{5kt4qw}cm{5kt4qw}cn{5kt4qw}co{5kt4qw}cp{5kt4qw}6l{4qs5ks5ou5qw5ru17su5tu}17s{2ks}5q{ckvclvcmvcnvcovcpv4lv}5r{ckuclucmucnucoucpu4lu}5t{2ks}6p{4qs5ks5ou5qw5ru17su5tu}ek{4qs5ks5ou5qw5ru17su5tu}el{4qs5ks5ou5qw5ru17su5tu}em{4qs5ks5ou5qw5ru17su5tu}en{4qs5ks5ou5qw5ru17su5tu}eo{4qs5ks5ou5qw5ru17su5tu}ep{4qs5ks5ou5qw5ru17su5tu}es{5ks5qs4qs}et{4qs5ks5ou5qw5ru17su5tu}eu{4qs5ks5qw5ru17su5tu}ev{5ks5qs4qs}ex{17ss5ts5qs}6z{4qv5ks5ou5qw5ru17su5tu}fm{4qv5ks5ou5qw5ru17su5tu}fn{4qv5ks5ou5qw5ru17su5tu}fo{4qv5ks5ou5qw5ru17su5tu}fp{4qv5ks5ou5qw5ru17su5tu}fq{4qv5ks5ou5qw5ru17su5tu}7r{5os}fs{4qv5ks5ou5qw5ru17su5tu}ft{17su5tu5qs}fu{17su5tu5qs}fv{17su5tu5qs}fw{17su5tu5qs}}}"),"Times-Roman":l("{'widths'{k3n2q4ycx2l201n3m201o6o201s2l201t2l201u2l201w2w201x2w201y2w2k1t2l2l202m2n2n3m2o3m2p5n202q6o2r1m2s2l2t2l2u3m2v3s2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v1w3w3s3x3s3y3s3z2w4k5w4l4s4m4m4n4m4o4s4p3x4q3r4r4s4s4s4t2l4u2r4v4s4w3x4x5t4y4s4z4s5k3r5l4s5m4m5n3r5o3x5p4s5q4s5r5y5s4s5t4s5u3x5v2l5w1w5x2l5y2z5z3m6k2l6l2w6m3m6n2w6o3m6p2w6q2l6r3m6s3m6t1w6u1w6v3m6w1w6x4y6y3m6z3m7k3m7l3m7m2l7n2r7o1w7p3m7q3m7r4s7s3m7t3m7u2w7v3k7w1o7x3k7y3q202l3mcl4sal2lam3man3mao3map3mar3mas2lat4wau1vav3maw3say4waz2lbk2sbl3s'fof'6obo2lbp3mbq2xbr1tbs2lbu1zbv3mbz2wck4s202k3mcm4scn4sco4scp4scq5tcr4mcs3xct3xcu3xcv3xcw2l2m2tcy2lcz2ldl4sdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek2wel2wem2wen2weo2wep2weq4mer2wes2wet2weu2wev2wew1wex1wey1wez1wfl3mfm3mfn3mfo3mfp3mfq3mfr3sfs3mft3mfu3mfv3mfw3mfz3m203k6o212m6m2dw2l2cq2l3t3m3u1w17s4s19m3m}'kerning'{cl{4qs5ku17sw5ou5qy5rw201ss5tw201ws}201s{201ss}201t{ckw4lwcmwcnwcowcpwclw4wu201ts}2k{201ts}2w{4qs5kw5os5qx5ru17sx5tx}2x{17sw5tw5ou5qu}2y{4qs5kw5os5qx5ru17sx5tx}'fof'-6o7t{ckuclucmucnucoucpu4lu5os5rs}3u{17su5tu5qs}3v{17su5tu5qs}7p{17sw5tw5qs}ck{4qs5ku17sw5ou5qy5rw201ss5tw201ws}4l{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cm{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cn{4qs5ku17sw5ou5qy5rw201ss5tw201ws}co{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cp{4qs5ku17sw5ou5qy5rw201ss5tw201ws}6l{17su5tu5os5qw5rs}17s{2ktclvcmvcnvcovcpv4lv4wuckv}5o{ckwclwcmwcnwcowcpw4lw4wu}5q{ckyclycmycnycoycpy4ly4wu5ms}5r{cktcltcmtcntcotcpt4lt4ws}5t{2ktclvcmvcnvcovcpv4lv4wuckv}7q{cksclscmscnscoscps4ls}6p{17su5tu5qw5rs}ek{5qs5rs}el{17su5tu5os5qw5rs}em{17su5tu5os5qs5rs}en{17su5qs5rs}eo{5qs5rs}ep{17su5tu5os5qw5rs}es{5qs}et{17su5tu5qw5rs}eu{17su5tu5qs5rs}ev{5qs}6z{17sv5tv5os5qx5rs}fm{5os5qt5rs}fn{17sv5tv5os5qx5rs}fo{17sv5tv5os5qx5rs}fp{5os5qt5rs}fq{5os5qt5rs}7r{ckuclucmucnucoucpu4lu5os}fs{17sv5tv5os5qx5rs}ft{17ss5ts5qs}fu{17sw5tw5qs}fv{17sw5tw5qs}fw{17ss5ts5qs}fz{ckuclucmucnucoucpu4lu5os5rs}}}"),"Helvetica-Oblique":l("{'widths'{k3p2q4mcx1w201n3r201o6o201s1q201t1q201u1q201w2l201x2l201y2l2k1w2l1w202m2n2n3r2o3r2p5t202q6o2r1n2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v1w3w3u3x3u3y3u3z3r4k6p4l4m4m4m4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3m4v4m4w3r4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v1w5w1w5x1w5y2z5z3r6k2l6l3r6m3r6n3m6o3r6p3r6q1w6r3r6s3r6t1q6u1q6v3m6w1q6x5n6y3r6z3r7k3r7l3r7m2l7n3m7o1w7p3r7q3m7r4s7s3m7t3m7u3m7v2l7w1u7x2l7y3u202l3rcl4mal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3rbr1wbs2lbu2obv3rbz3xck4m202k3rcm4mcn4mco4mcp4mcq6ocr4scs4mct4mcu4mcv4mcw1w2m2ncy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3mes3ret3reu3rev3rew1wex1wey1wez1wfl3rfm3rfn3rfo3rfp3rfq3rfr3ufs3xft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3r3u1w17s4m19m3r}'kerning'{5q{4wv}cl{4qs5kw5ow5qs17sv5tv}201t{2wu4w1k2yu}201x{2wu4wy2yu}17s{2ktclucmucnu4otcpu4lu4wycoucku}2w{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}2x{17sy5ty5oy5qs}2y{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}'fof'-6o7p{17sv5tv5ow}ck{4qs5kw5ow5qs17sv5tv}4l{4qs5kw5ow5qs17sv5tv}cm{4qs5kw5ow5qs17sv5tv}cn{4qs5kw5ow5qs17sv5tv}co{4qs5kw5ow5qs17sv5tv}cp{4qs5kw5ow5qs17sv5tv}6l{17sy5ty5ow}do{17st5tt}4z{17st5tt}7s{fst}dm{17st5tt}dn{17st5tt}5o{ckwclwcmwcnwcowcpw4lw4wv}dp{17st5tt}dq{17st5tt}7t{5ow}ds{17st5tt}5t{2ktclucmucnu4otcpu4lu4wycoucku}fu{17sv5tv5ow}6p{17sy5ty5ow5qs}ek{17sy5ty5ow}el{17sy5ty5ow}em{17sy5ty5ow}en{5ty}eo{17sy5ty5ow}ep{17sy5ty5ow}es{17sy5ty5qs}et{17sy5ty5ow5qs}eu{17sy5ty5ow5qs}ev{17sy5ty5ow5qs}6z{17sy5ty5ow5qs}fm{17sy5ty5ow5qs}fn{17sy5ty5ow5qs}fo{17sy5ty5ow5qs}fp{17sy5ty5qs}fq{17sy5ty5ow5qs}7r{5ow}fs{17sy5ty5ow5qs}ft{17sv5tv5ow}7m{5ow}fv{17sv5tv5ow}fw{17sv5tv5ow}}}")}};t.events.push(["addFont",function(t){var e=t.font,n=f.Unicode[e.postScriptName];n&&(e.metadata.Unicode={},e.metadata.Unicode.widths=n.widths,e.metadata.Unicode.kerning=n.kerning);var r=u.Unicode[e.postScriptName];r&&(e.metadata.Unicode.encoding=r,e.encoding=r.codePages[0])}])}(R.API),
/**
   * @license
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e=function(t){for(var e=t.length,n=new Uint8Array(e),r=0;r<e;r++)n[r]=t.charCodeAt(r);return n};t.API.events.push(["addFont",function(n){var r=void 0,i=n.font,a=n.instance;if(!i.isStandardFont){if(void 0===a)throw new Error("Font does not exist in vFS, import fonts or remove declaration doc.addFont('"+i.postScriptName+"').");if("string"!=typeof(r=!1===a.existsFileInVFS(i.postScriptName)?a.loadFile(i.postScriptName):a.getFileFromVFS(i.postScriptName)))throw new Error("Font is not stored as string-data in vFS, import fonts or remove declaration doc.addFont('"+i.postScriptName+"').");!function(n,r){r=/^\x00\x01\x00\x00/.test(r)?e(r):e(f(r)),n.metadata=t.API.TTFFont.open(r),n.metadata.Unicode=n.metadata.Unicode||{encoding:{},kerning:{},widths:[]},n.metadata.glyIdsUsed=[0]}(i,r)}}])}(R),function(e){e.addSvgAsImage=function(e,n,a,o,h,l,c,u){if(isNaN(n)||isNaN(a))throw s.error("jsPDF.addSvgAsImage: Invalid coordinates",arguments),new Error("Invalid coordinates passed to jsPDF.addSvgAsImage");if(isNaN(o)||isNaN(h))throw s.error("jsPDF.addSvgAsImage: Invalid measurements",arguments),new Error("Invalid measurements (width and/or height) passed to jsPDF.addSvgAsImage");var f=document.createElement("canvas");f.width=o,f.height=h;var d=f.getContext("2d");d.fillStyle="#fff",d.fillRect(0,0,f.width,f.height);var p={ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0},g=this;return(i.canvg?Promise.resolve(i.canvg):"object"===(void 0===t?"undefined":r(t))&&"undefined"!=typeof module?new Promise(function(t,e){try{t(require("canvg"))}catch(es){e(es)}}):"function"==typeof define&&define.amd?new Promise(function(t,e){try{require(["canvg"],t)}catch(es){e(es)}}):Promise.reject(new Error("Could not load canvg"))).catch(function(t){return Promise.reject(new Error("Could not load canvg: "+t))}).then(function(t){return t.default?t.default:t}).then(function(t){return t.fromString(d,e,p)},function(){return Promise.reject(new Error("Could not load canvg."))}).then(function(t){return t.render(p)}).then(function(){g.addImage(f.toDataURL("image/jpeg",1),n,a,o,h,c,u)})}}(R.API),
/**
   * @license
   * ====================================================================
   * Copyright (c) 2013 Eduardo Menezes de Morais, eduardo.morais@usp.br
   *
   * Permission is hereby granted, free of charge, to any person obtaining
   * a copy of this software and associated documentation files (the
   * "Software"), to deal in the Software without restriction, including
   * without limitation the rights to use, copy, modify, merge, publish,
   * distribute, sublicense, and/or sell copies of the Software, and to
   * permit persons to whom the Software is furnished to do so, subject to
   * the following conditions:
   *
   * The above copyright notice and this permission notice shall be
   * included in all copies or substantial portions of the Software.
   *
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
   * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
   * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
   * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
   * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
   * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
   * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
   * ====================================================================
   */
function(t){t.putTotalPages=function(t){var e,n=0;parseInt(this.internal.getFont().id.substr(1),10)<15?(e=new RegExp(t,"g"),n=this.internal.getNumberOfPages()):(e=new RegExp(this.pdfEscape16(t,this.internal.getFont()),"g"),n=this.pdfEscape16(this.internal.getNumberOfPages()+"",this.internal.getFont()));for(var r=1;r<=this.internal.getNumberOfPages();r++)for(var i=0;i<this.internal.pages[r].length;i++)this.internal.pages[r][i]=this.internal.pages[r][i].replace(e,n);return this}}(R.API),function(t){t.viewerPreferences=function(t,e){var n;t=t||{},e=e||!1;var i,a,s,o={HideToolbar:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},HideMenubar:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},HideWindowUI:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},FitWindow:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},CenterWindow:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},DisplayDocTitle:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.4},NonFullScreenPageMode:{defaultValue:"UseNone",value:"UseNone",type:"name",explicitSet:!1,valueSet:["UseNone","UseOutlines","UseThumbs","UseOC"],pdfVersion:1.3},Direction:{defaultValue:"L2R",value:"L2R",type:"name",explicitSet:!1,valueSet:["L2R","R2L"],pdfVersion:1.3},ViewArea:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},ViewClip:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintArea:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintClip:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintScaling:{defaultValue:"AppDefault",value:"AppDefault",type:"name",explicitSet:!1,valueSet:["AppDefault","None"],pdfVersion:1.6},Duplex:{defaultValue:"",value:"none",type:"name",explicitSet:!1,valueSet:["Simplex","DuplexFlipShortEdge","DuplexFlipLongEdge","none"],pdfVersion:1.7},PickTrayByPDFSize:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.7},PrintPageRange:{defaultValue:"",value:"",type:"array",explicitSet:!1,valueSet:null,pdfVersion:1.7},NumCopies:{defaultValue:1,value:1,type:"integer",explicitSet:!1,valueSet:null,pdfVersion:1.7}},h=Object.keys(o),l=[],c=0,u=0,f=0;function d(t,e){var n,r=!1;for(n=0;n<t.length;n+=1)t[n]===e&&(r=!0);return r}if(void 0===this.internal.viewerpreferences&&(this.internal.viewerpreferences={},this.internal.viewerpreferences.configuration=JSON.parse(JSON.stringify(o)),this.internal.viewerpreferences.isSubscribed=!1),n=this.internal.viewerpreferences.configuration,"reset"===t||!0===e){var p=h.length;for(f=0;f<p;f+=1)n[h[f]].value=n[h[f]].defaultValue,n[h[f]].explicitSet=!1}if("object"===r(t))for(a in t)if(s=t[a],d(h,a)&&void 0!==s){if("boolean"===n[a].type&&"boolean"==typeof s)n[a].value=s;else if("name"===n[a].type&&d(n[a].valueSet,s))n[a].value=s;else if("integer"===n[a].type&&Number.isInteger(s))n[a].value=s;else if("array"===n[a].type){for(c=0;c<s.length;c+=1)if(i=!0,1===s[c].length&&"number"==typeof s[c][0])l.push(String(s[c]-1));else if(s[c].length>1){for(u=0;u<s[c].length;u+=1)"number"!=typeof s[c][u]&&(i=!1);!0===i&&l.push([s[c][0]-1,s[c][1]-1].join(" "))}n[a].value="["+l.join(" ")+"]"}else n[a].value=n[a].defaultValue;n[a].explicitSet=!0}return!1===this.internal.viewerpreferences.isSubscribed&&(this.internal.events.subscribe("putCatalog",function(){var t,e=[];for(t in n)!0===n[t].explicitSet&&("name"===n[t].type?e.push("/"+t+" /"+n[t].value):e.push("/"+t+" "+n[t].value));0!==e.length&&this.internal.write("/ViewerPreferences\n<<\n"+e.join("\n")+"\n>>")}),this.internal.viewerpreferences.isSubscribed=!0),this.internal.viewerpreferences.configuration=n,this}}(R.API),
/** ====================================================================
   * @license
   * jsPDF XMP metadata plugin
   * Copyright (c) 2016 Jussi Utunen, u-jussi@suomi24.fi
   *
   * Permission is hereby granted, free of charge, to any person obtaining
   * a copy of this software and associated documentation files (the
   * "Software"), to deal in the Software without restriction, including
   * without limitation the rights to use, copy, modify, merge, publish,
   * distribute, sublicense, and/or sell copies of the Software, and to
   * permit persons to whom the Software is furnished to do so, subject to
   * the following conditions:
   *
   * The above copyright notice and this permission notice shall be
   * included in all copies or substantial portions of the Software.
   *
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
   * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
   * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
   * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
   * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
   * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
   * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
   * ====================================================================
   */
function(t){var e=function(){var t='<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><rdf:Description rdf:about="" xmlns:jspdf="'+this.internal.__metadata__.namespaceuri+'"><jspdf:metadata>',e=unescape(encodeURIComponent('<x:xmpmeta xmlns:x="adobe:ns:meta/">')),n=unescape(encodeURIComponent(t)),r=unescape(encodeURIComponent(this.internal.__metadata__.metadata)),i=unescape(encodeURIComponent("</jspdf:metadata></rdf:Description></rdf:RDF>")),a=unescape(encodeURIComponent("</x:xmpmeta>")),s=n.length+r.length+i.length+e.length+a.length;this.internal.__metadata__.metadata_object_number=this.internal.newObject(),this.internal.write("<< /Type /Metadata /Subtype /XML /Length "+s+" >>"),this.internal.write("stream"),this.internal.write(e+n+r+i+a),this.internal.write("endstream"),this.internal.write("endobj")},n=function(){this.internal.__metadata__.metadata_object_number&&this.internal.write("/Metadata "+this.internal.__metadata__.metadata_object_number+" 0 R")};t.addMetadata=function(t,r){return void 0===this.internal.__metadata__&&(this.internal.__metadata__={metadata:t,namespaceuri:r||"http://jspdf.default.namespaceuri/"},this.internal.events.subscribe("putCatalog",n),this.internal.events.subscribe("postPutResources",e)),this}}(R.API),function(t){var e=t.API,n=e.pdfEscape16=function(t,e){for(var n,r=e.metadata.Unicode.widths,i=["","0","00","000","0000"],a=[""],s=0,o=t.length;s<o;++s){if(n=e.metadata.characterToGlyph(t.charCodeAt(s)),e.metadata.glyIdsUsed.push(n),e.metadata.toUnicode[n]=t.charCodeAt(s),-1==r.indexOf(n)&&(r.push(n),r.push([parseInt(e.metadata.widthOfGlyph(n),10)])),"0"==n)return a.join("");n=n.toString(16),a.push(i[4-n.length],n)}return a.join("")},r=function(t){var e,n,r,i,a,s,o;for(a="/CIDInit /ProcSet findresource begin\n12 dict begin\nbegincmap\n/CIDSystemInfo <<\n  /Registry (Adobe)\n  /Ordering (UCS)\n  /Supplement 0\n>> def\n/CMapName /Adobe-Identity-UCS def\n/CMapType 2 def\n1 begincodespacerange\n<0000><ffff>\nendcodespacerange",r=[],s=0,o=(n=Object.keys(t).sort(function(t,e){return t-e})).length;s<o;s++)e=n[s],r.length>=100&&(a+="\n"+r.length+" beginbfchar\n"+r.join("\n")+"\nendbfchar",r=[]),void 0!==t[e]&&null!==t[e]&&"function"==typeof t[e].toString&&(i=("0000"+t[e].toString(16)).slice(-4),e=("0000"+(+e).toString(16)).slice(-4),r.push("<"+e+"><"+i+">"));return r.length&&(a+="\n"+r.length+" beginbfchar\n"+r.join("\n")+"\nendbfchar\n"),a+"endcmap\nCMapName currentdict /CMap defineresource pop\nend\nend"};e.events.push(["putFont",function(e){!function(e){var n=e.font,i=e.out,a=e.newObject,s=e.putStream;if(n.metadata instanceof t.API.TTFFont&&"Identity-H"===n.encoding){for(var o=n.metadata.Unicode.widths,h=n.metadata.subset.encode(n.metadata.glyIdsUsed,1),l="",c=0;c<h.length;c++)l+=String.fromCharCode(h[c]);var u=a();s({data:l,addLength1:!0,objectId:u}),i("endobj");var f=a();s({data:r(n.metadata.toUnicode),addLength1:!0,objectId:f}),i("endobj");var d=a();i("<<"),i("/Type /FontDescriptor"),i("/FontName /"+C(n.fontName)),i("/FontFile2 "+u+" 0 R"),i("/FontBBox "+t.API.PDFObject.convert(n.metadata.bbox)),i("/Flags "+n.metadata.flags),i("/StemV "+n.metadata.stemV),i("/ItalicAngle "+n.metadata.italicAngle),i("/Ascent "+n.metadata.ascender),i("/Descent "+n.metadata.decender),i("/CapHeight "+n.metadata.capHeight),i(">>"),i("endobj");var p=a();i("<<"),i("/Type /Font"),i("/BaseFont /"+C(n.fontName)),i("/FontDescriptor "+d+" 0 R"),i("/W "+t.API.PDFObject.convert(o)),i("/CIDToGIDMap /Identity"),i("/DW 1000"),i("/Subtype /CIDFontType2"),i("/CIDSystemInfo"),i("<<"),i("/Supplement 0"),i("/Registry (Adobe)"),i("/Ordering ("+n.encoding+")"),i(">>"),i(">>"),i("endobj"),n.objectNumber=a(),i("<<"),i("/Type /Font"),i("/Subtype /Type0"),i("/ToUnicode "+f+" 0 R"),i("/BaseFont /"+C(n.fontName)),i("/Encoding /"+n.encoding),i("/DescendantFonts ["+p+" 0 R]"),i(">>"),i("endobj"),n.isAlreadyPutted=!0}}(e)}]),e.events.push(["putFont",function(e){!function(e){var n=e.font,i=e.out,a=e.newObject,s=e.putStream;if(n.metadata instanceof t.API.TTFFont&&"WinAnsiEncoding"===n.encoding){for(var o=n.metadata.rawData,h="",l=0;l<o.length;l++)h+=String.fromCharCode(o[l]);var c=a();s({data:h,addLength1:!0,objectId:c}),i("endobj");var u=a();s({data:r(n.metadata.toUnicode),addLength1:!0,objectId:u}),i("endobj");var f=a();i("<<"),i("/Descent "+n.metadata.decender),i("/CapHeight "+n.metadata.capHeight),i("/StemV "+n.metadata.stemV),i("/Type /FontDescriptor"),i("/FontFile2 "+c+" 0 R"),i("/Flags 96"),i("/FontBBox "+t.API.PDFObject.convert(n.metadata.bbox)),i("/FontName /"+C(n.fontName)),i("/ItalicAngle "+n.metadata.italicAngle),i("/Ascent "+n.metadata.ascender),i(">>"),i("endobj"),n.objectNumber=a();for(var d=0;d<n.metadata.hmtx.widths.length;d++)n.metadata.hmtx.widths[d]=parseInt(n.metadata.hmtx.widths[d]*(1e3/n.metadata.head.unitsPerEm));i("<</Subtype/TrueType/Type/Font/ToUnicode "+u+" 0 R/BaseFont/"+C(n.fontName)+"/FontDescriptor "+f+" 0 R/Encoding/"+n.encoding+" /FirstChar 29 /LastChar 255 /Widths "+t.API.PDFObject.convert(n.metadata.hmtx.widths)+">>"),i("endobj"),n.isAlreadyPutted=!0}}(e)}]);var i=function(t){var e,r=t.text||"",i=t.x,a=t.y,s=t.options||{},o=t.mutex||{},h=o.pdfEscape,l=o.activeFontKey,c=o.fonts,u=l,f="",d=0,p="",g=c[u].encoding;if("Identity-H"!==c[u].encoding)return{text:r,x:i,y:a,options:s,mutex:o};for(p=r,u=l,Array.isArray(r)&&(p=r[0]),d=0;d<p.length;d+=1)c[u].metadata.hasOwnProperty("cmap")&&(e=c[u].metadata.cmap.unicode.codeMap[p[d].charCodeAt(0)]),e||p[d].charCodeAt(0)<256&&c[u].metadata.hasOwnProperty("Unicode")?f+=p[d]:f+="";var m="";return parseInt(u.slice(1))<14||"WinAnsiEncoding"===g?m=h(f,u).split("").map(function(t){return t.charCodeAt(0).toString(16)}).join(""):"Identity-H"===g&&(m=n(f,c[u])),o.isHex=!0,{text:m,x:i,y:a,options:s,mutex:o}};e.events.push(["postProcessText",function(t){var e=t.text||"",n=[],r={text:e,x:t.x,y:t.y,options:t.options,mutex:t.mutex};if(Array.isArray(e)){var a=0;for(a=0;a<e.length;a+=1)Array.isArray(e[a])&&3===e[a].length?n.push([i(Object.assign({},r,{text:e[a][0]})).text,e[a][1],e[a][2]]):n.push(i(Object.assign({},r,{text:e[a]})).text);t.text=n}else t.text=i(Object.assign({},r,{text:e})).text}])}(R),
/**
   * @license
   * jsPDF virtual FileSystem functionality
   *
   * Licensed under the MIT License.
   * http://opensource.org/licenses/mit-license
   */
function(t){var e=function(){return void 0===this.internal.vFS&&(this.internal.vFS={}),!0};t.existsFileInVFS=function(t){return e.call(this),void 0!==this.internal.vFS[t]},t.addFileToVFS=function(t,n){return e.call(this),this.internal.vFS[t]=n,this},t.getFileFromVFS=function(t){return e.call(this),void 0!==this.internal.vFS[t]?this.internal.vFS[t]:null}}(R.API),
/**
   * @license
   * Unicode Bidi Engine based on the work of Alex Shensis (@asthensis)
   * MIT License
   */
function(t){t.__bidiEngine__=t.prototype.__bidiEngine__=function(t){var n,r,i,a,s,o,h,l=e,c=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],u=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],f={L:0,R:1,EN:2,AN:3,N:4,B:5,S:6},d={0:0,5:1,6:2,7:3,32:4,251:5,254:6,255:7},p=["(",")","(","<",">","<","[","]","[","{","}","{","«","»","«","‹","›","‹","⁅","⁆","⁅","⁽","⁾","⁽","₍","₎","₍","≤","≥","≤","〈","〉","〈","﹙","﹚","﹙","﹛","﹜","﹛","﹝","﹞","﹝","﹤","﹥","﹤"],g=new RegExp(/^([1-4|9]|1[0-9]|2[0-9]|3[0168]|4[04589]|5[012]|7[78]|159|16[0-9]|17[0-2]|21[569]|22[03489]|250)$/),m=!1,b=0;this.__bidiEngine__={};var v=function(t){var e=t.charCodeAt(),n=e>>8,r=d[n];return void 0!==r?l[256*r+(255&e)]:252===n||253===n?"AL":g.test(n)?"L":8===n?"R":"N"},w=function(t){for(var e,n=0;n<t.length;n++){if("L"===(e=v(t.charAt(n))))return!1;if("R"===e)return!0}return!1},y=function(t,e,s,o){var h,l,c,u,f=e[o];switch(f){case"L":case"R":case"LRE":case"RLE":case"LRO":case"RLO":case"PDF":m=!1;break;case"N":case"AN":break;case"EN":m&&(f="AN");break;case"AL":m=!0,f="R";break;case"WS":case"BN":f="N";break;case"CS":o<1||o+1>=e.length||"EN"!==(h=s[o-1])&&"AN"!==h||"EN"!==(l=e[o+1])&&"AN"!==l?f="N":m&&(l="AN"),f=l===h?l:"N";break;case"ES":f="EN"===(h=o>0?s[o-1]:"B")&&o+1<e.length&&"EN"===e[o+1]?"EN":"N";break;case"ET":if(o>0&&"EN"===s[o-1]){f="EN";break}if(m){f="N";break}for(c=o+1,u=e.length;c<u&&"ET"===e[c];)c++;f=c<u&&"EN"===e[c]?"EN":"N";break;case"NSM":if(i&&!a){for(u=e.length,c=o+1;c<u&&"NSM"===e[c];)c++;if(c<u){var d=t[o],p=d>=1425&&d<=2303||64286===d;if(h=e[c],p&&("R"===h||"AL"===h)){f="R";break}}}f=o<1||"B"===(h=e[o-1])?"N":s[o-1];break;case"B":m=!1,n=!0,f=b;break;case"S":r=!0,f="N"}return f},_=function(t,e,n){var r=t.split("");return n&&x(r,n,{hiLevel:b}),r.reverse(),e&&e.reverse(),r.join("")},x=function(t,e,i){var a,s,o,h,l,d=-1,p=t.length,g=0,w=[],_=b?u:c,x=[];for(m=!1,n=!1,r=!1,s=0;s<p;s++)x[s]=v(t[s]);for(o=0;o<p;o++){if(l=g,w[o]=y(t,x,w,o),a=240&(g=_[l][f[w[o]]]),g&=15,e[o]=h=_[g][5],a>0)if(16===a){for(s=d;s<o;s++)e[s]=1;d=-1}else d=-1;if(_[g][6])-1===d&&(d=o);else if(d>-1){for(s=d;s<o;s++)e[s]=h;d=-1}"B"===x[o]&&(e[o]=0),i.hiLevel|=h}r&&function(t,e,n){for(var r=0;r<n;r++)if("S"===t[r]){e[r]=b;for(var i=r-1;i>=0&&"WS"===t[i];i--)e[i]=b}}(x,e,p)},A=function(t,e,r,i,a){if(!(a.hiLevel<t)){if(1===t&&1===b&&!n)return e.reverse(),void(r&&r.reverse());for(var s,o,h,l,c=e.length,u=0;u<c;){if(i[u]>=t){for(h=u+1;h<c&&i[h]>=t;)h++;for(l=u,o=h-1;l<o;l++,o--)s=e[l],e[l]=e[o],e[o]=s,r&&(s=r[l],r[l]=r[o],r[o]=s);u=h}u++}}},L=function(t,e,n){var r=t.split(""),i={hiLevel:b};return n||(n=[]),x(r,n,i),function(t,e,n){if(0!==n.hiLevel&&h)for(var r,i=0;i<t.length;i++)1===e[i]&&(r=p.indexOf(t[i]))>=0&&(t[i]=p[r+1])}(r,n,i),A(2,r,e,n,i),A(1,r,e,n,i),r.join("")};return this.__bidiEngine__.doBidiReorder=function(t,e,n){if(function(t,e){if(e)for(var n=0;n<t.length;n++)e[n]=n;void 0===a&&(a=w(t)),void 0===o&&(o=w(t))}(t,e),i||!s||o)if(i&&s&&a^o)b=a?1:0,t=_(t,e,n);else if(!i&&s&&o)b=a?1:0,t=L(t,e,n),t=_(t,e);else if(!i||a||s||o){if(i&&!s&&a^o)t=_(t,e),a?(b=0,t=L(t,e,n)):(b=1,t=L(t,e,n),t=_(t,e));else if(i&&a&&!s&&o)b=1,t=L(t,e,n),t=_(t,e);else if(!i&&!s&&a^o){var r=h;a?(b=1,t=L(t,e,n),b=0,h=!1,t=L(t,e,n),h=r):(b=0,t=L(t,e,n),t=_(t,e),b=1,h=!1,t=L(t,e,n),h=r,t=_(t,e))}}else b=0,t=L(t,e,n);else b=a?1:0,t=L(t,e,n);return t},this.__bidiEngine__.setOptions=function(t){t&&(i=t.isInputVisual,s=t.isOutputVisual,a=t.isInputRtl,o=t.isOutputRtl,h=t.isSymmetricSwapping)},this.__bidiEngine__.setOptions(t),this.__bidiEngine__};var e=["BN","BN","BN","BN","BN","BN","BN","BN","BN","S","B","S","WS","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","B","B","B","S","WS","N","N","ET","ET","ET","N","N","N","N","N","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","BN","BN","BN","BN","BN","BN","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","CS","N","ET","ET","ET","ET","N","N","N","N","L","N","N","BN","N","N","ET","ET","EN","EN","N","L","N","N","N","EN","L","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","N","N","N","N","N","ET","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","R","NSM","R","NSM","NSM","R","NSM","NSM","R","NSM","N","N","N","N","N","N","N","N","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","N","N","N","N","N","R","R","R","R","R","N","N","N","N","N","N","N","N","N","N","N","AN","AN","AN","AN","AN","AN","N","N","AL","ET","ET","AL","CS","AL","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","AN","AN","AN","AN","AN","AN","AN","AN","AN","ET","AN","AN","AL","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","N","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","NSM","NSM","N","NSM","NSM","NSM","NSM","AL","AL","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","N","N","N","N","N","N","N","N","N","N","N","N","N","N","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","R","R","N","N","N","N","R","N","N","N","N","N","WS","WS","WS","WS","WS","WS","WS","WS","WS","WS","WS","BN","BN","BN","L","R","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","WS","B","LRE","RLE","PDF","LRO","RLO","CS","ET","ET","ET","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","CS","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","WS","BN","BN","BN","BN","BN","N","LRI","RLI","FSI","PDI","BN","BN","BN","BN","BN","BN","EN","L","N","N","EN","EN","EN","EN","EN","EN","ES","ES","N","N","N","L","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","ES","ES","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","L","L","N","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","N","N","N","N","N","R","NSM","R","R","R","R","R","R","R","R","R","R","ES","R","R","R","R","R","R","R","R","R","R","R","R","R","N","R","R","R","R","R","N","R","N","R","R","N","R","R","N","R","R","R","R","R","R","R","R","R","R","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","CS","N","CS","N","N","CS","N","N","N","N","N","N","N","N","N","ET","N","N","ES","ES","N","N","N","N","N","ET","ET","N","N","N","N","N","AL","AL","AL","AL","AL","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","N","BN","N","N","N","ET","ET","ET","N","N","N","N","N","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","L","L","L","L","L","L","N","N","L","L","L","L","L","L","N","N","L","L","L","L","L","L","N","N","L","L","L","N","N","N","ET","ET","N","N","N","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N"],n=new t.__bidiEngine__({isInputVisual:!0});t.API.events.push(["postProcessText",function(t){var e=t.text;t.x,t.y;var r=t.options||{};t.mutex,r.lang;var i=[];if(r.isInputVisual="boolean"!=typeof r.isInputVisual||r.isInputVisual,n.setOptions(r),"[object Array]"===Object.prototype.toString.call(e)){var a=0;for(i=[],a=0;a<e.length;a+=1)"[object Array]"===Object.prototype.toString.call(e[a])?i.push([n.doBidiReorder(e[a][0]),e[a][1],e[a][2]]):i.push([n.doBidiReorder(e[a])]);t.text=i}else t.text=n.doBidiReorder(e);n.setOptions({isInputVisual:!0})}])}(R),R.API.TTFFont=function(){function t(t){var e;if(this.rawData=t,e=this.contents=new Ba(t),this.contents.pos=4,"ttcf"===e.readString(4))throw new Error("TTCF not supported.");e.pos=0,this.parse(),this.subset=new ts(this),this.registerTTF()}return t.open=function(e){return new t(e)},t.prototype.parse=function(){return this.directory=new Ma(this.contents),this.head=new qa(this),this.name=new Ga(this),this.cmap=new za(this),this.toUnicode={},this.hhea=new Ua(this),this.maxp=new Ya(this),this.hmtx=new Za(this),this.post=new Wa(this),this.os2=new Ha(this),this.loca=new Qa(this),this.glyf=new Xa(this),this.ascender=this.os2.exists&&this.os2.ascender||this.hhea.ascender,this.decender=this.os2.exists&&this.os2.decender||this.hhea.decender,this.lineGap=this.os2.exists&&this.os2.lineGap||this.hhea.lineGap,this.bbox=[this.head.xMin,this.head.yMin,this.head.xMax,this.head.yMax]},t.prototype.registerTTF=function(){var t,e,n,r,i;if(this.scaleFactor=1e3/this.head.unitsPerEm,this.bbox=function(){var e,n,r,i;for(i=[],e=0,n=(r=this.bbox).length;e<n;e++)t=r[e],i.push(Math.round(t*this.scaleFactor));return i}.call(this),this.stemV=0,this.post.exists?(n=255&(r=this.post.italic_angle),32768&(e=r>>16)&&(e=-(1+(65535^e))),this.italicAngle=+(e+"."+n)):this.italicAngle=0,this.ascender=Math.round(this.ascender*this.scaleFactor),this.decender=Math.round(this.decender*this.scaleFactor),this.lineGap=Math.round(this.lineGap*this.scaleFactor),this.capHeight=this.os2.exists&&this.os2.capHeight||this.ascender,this.xHeight=this.os2.exists&&this.os2.xHeight||0,this.familyClass=(this.os2.exists&&this.os2.familyClass||0)>>8,this.isSerif=1===(i=this.familyClass)||2===i||3===i||4===i||5===i||7===i,this.isScript=10===this.familyClass,this.flags=0,this.post.isFixedPitch&&(this.flags|=1),this.isSerif&&(this.flags|=2),this.isScript&&(this.flags|=8),0!==this.italicAngle&&(this.flags|=64),this.flags|=32,!this.cmap.unicode)throw new Error("No unicode cmap for font")},t.prototype.characterToGlyph=function(t){var e;return(null!=(e=this.cmap.unicode)?e.codeMap[t]:void 0)||0},t.prototype.widthOfGlyph=function(t){var e;return e=1e3/this.head.unitsPerEm,this.hmtx.forGlyph(t).advance*e},t.prototype.widthOfString=function(t,e,n){var r,i,a,s;for(a=0,i=0,s=(t=""+t).length;0<=s?i<s:i>s;i=0<=s?++i:--i)r=t.charCodeAt(i),a+=this.widthOfGlyph(this.characterToGlyph(r))+n*(1e3/e)||0;return a*(e/1e3)},t.prototype.lineHeight=function(t,e){var n;return null==e&&(e=!1),n=e?this.lineGap:0,(this.ascender+n-this.decender)/1e3*t},t}();var Oa,Ba=function(){function t(t){this.data=null!=t?t:[],this.pos=0,this.length=this.data.length}return t.prototype.readByte=function(){return this.data[this.pos++]},t.prototype.writeByte=function(t){return this.data[this.pos++]=t},t.prototype.readUInt32=function(){return 16777216*this.readByte()+(this.readByte()<<16)+(this.readByte()<<8)+this.readByte()},t.prototype.writeUInt32=function(t){return this.writeByte(t>>>24&255),this.writeByte(t>>16&255),this.writeByte(t>>8&255),this.writeByte(255&t)},t.prototype.readInt32=function(){var t;return(t=this.readUInt32())>=2147483648?t-4294967296:t},t.prototype.writeInt32=function(t){return t<0&&(t+=4294967296),this.writeUInt32(t)},t.prototype.readUInt16=function(){return this.readByte()<<8|this.readByte()},t.prototype.writeUInt16=function(t){return this.writeByte(t>>8&255),this.writeByte(255&t)},t.prototype.readInt16=function(){var t;return(t=this.readUInt16())>=32768?t-65536:t},t.prototype.writeInt16=function(t){return t<0&&(t+=65536),this.writeUInt16(t)},t.prototype.readString=function(t){var e,n;for(n=[],e=0;0<=t?e<t:e>t;e=0<=t?++e:--e)n[e]=String.fromCharCode(this.readByte());return n.join("")},t.prototype.writeString=function(t){var e,n,r;for(r=[],e=0,n=t.length;0<=n?e<n:e>n;e=0<=n?++e:--e)r.push(this.writeByte(t.charCodeAt(e)));return r},t.prototype.readShort=function(){return this.readInt16()},t.prototype.writeShort=function(t){return this.writeInt16(t)},t.prototype.readLongLong=function(){var t,e,n,r,i,a,s,o;return t=this.readByte(),e=this.readByte(),n=this.readByte(),r=this.readByte(),i=this.readByte(),a=this.readByte(),s=this.readByte(),o=this.readByte(),128&t?-1*(72057594037927940*(255^t)+281474976710656*(255^e)+1099511627776*(255^n)+4294967296*(255^r)+16777216*(255^i)+65536*(255^a)+256*(255^s)+(255^o)+1):72057594037927940*t+281474976710656*e+1099511627776*n+4294967296*r+16777216*i+65536*a+256*s+o},t.prototype.writeLongLong=function(t){var e,n;return e=Math.floor(t/4294967296),n=4294967295&t,this.writeByte(e>>24&255),this.writeByte(e>>16&255),this.writeByte(e>>8&255),this.writeByte(255&e),this.writeByte(n>>24&255),this.writeByte(n>>16&255),this.writeByte(n>>8&255),this.writeByte(255&n)},t.prototype.readInt=function(){return this.readInt32()},t.prototype.writeInt=function(t){return this.writeInt32(t)},t.prototype.read=function(t){var e,n;for(e=[],n=0;0<=t?n<t:n>t;n=0<=t?++n:--n)e.push(this.readByte());return e},t.prototype.write=function(t){var e,n,r,i;for(i=[],n=0,r=t.length;n<r;n++)e=t[n],i.push(this.writeByte(e));return i},t}(),Ma=function(){var t;function e(t){var e,n,r;for(this.scalarType=t.readInt(),this.tableCount=t.readShort(),this.searchRange=t.readShort(),this.entrySelector=t.readShort(),this.rangeShift=t.readShort(),this.tables={},n=0,r=this.tableCount;0<=r?n<r:n>r;n=0<=r?++n:--n)e={tag:t.readString(4),checksum:t.readInt(),offset:t.readInt(),length:t.readInt()},this.tables[e.tag]=e}return e.prototype.encode=function(e){var n,r,i,a,s,o,h,l,c,u,f,d,p;for(p in f=Object.keys(e).length,o=Math.log(2),c=16*Math.floor(Math.log(f)/o),a=Math.floor(c/o),l=16*f-c,(r=new Ba).writeInt(this.scalarType),r.writeShort(f),r.writeShort(c),r.writeShort(a),r.writeShort(l),i=16*f,h=r.pos+i,s=null,d=[],e)for(u=e[p],r.writeString(p),r.writeInt(t(u)),r.writeInt(h),r.writeInt(u.length),d=d.concat(u),"head"===p&&(s=h),h+=u.length;h%4;)d.push(0),h++;return r.write(d),n=2981146554-t(r.data),r.pos=s+8,r.writeUInt32(n),r.data},t=function(t){var e,n,r,i;for(t=Ja.call(t);t.length%4;)t.push(0);for(r=new Ba(t),n=0,e=0,i=t.length;e<i;e=e+=4)n+=r.readUInt32();return 4294967295&n},e}(),Ra={}.hasOwnProperty,Ta=function(t,e){for(var n in e)Ra.call(e,n)&&(t[n]=e[n]);function r(){this.constructor=t}return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},qa=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="head",e.prototype.parse=function(t){return t.pos=this.offset,this.version=t.readInt(),this.revision=t.readInt(),this.checkSumAdjustment=t.readInt(),this.magicNumber=t.readInt(),this.flags=t.readShort(),this.unitsPerEm=t.readShort(),this.created=t.readLongLong(),this.modified=t.readLongLong(),this.xMin=t.readShort(),this.yMin=t.readShort(),this.xMax=t.readShort(),this.yMax=t.readShort(),this.macStyle=t.readShort(),this.lowestRecPPEM=t.readShort(),this.fontDirectionHint=t.readShort(),this.indexToLocFormat=t.readShort(),this.glyphDataFormat=t.readShort()},e.prototype.encode=function(t){var e;return(e=new Ba).writeInt(this.version),e.writeInt(this.revision),e.writeInt(this.checkSumAdjustment),e.writeInt(this.magicNumber),e.writeShort(this.flags),e.writeShort(this.unitsPerEm),e.writeLongLong(this.created),e.writeLongLong(this.modified),e.writeShort(this.xMin),e.writeShort(this.yMin),e.writeShort(this.xMax),e.writeShort(this.yMax),e.writeShort(this.macStyle),e.writeShort(this.lowestRecPPEM),e.writeShort(this.fontDirectionHint),e.writeShort(t),e.writeShort(this.glyphDataFormat),e.data},e}(Oa=function(){function t(t){var e;this.file=t,e=this.file.directory.tables[this.tag],this.exists=!!e,e&&(this.offset=e.offset,this.length=e.length,this.parse(this.file.contents))}return t.prototype.parse=function(){},t.prototype.encode=function(){},t.prototype.raw=function(){return this.exists?(this.file.contents.pos=this.offset,this.file.contents.read(this.length)):null},t}()),Da=function(){function t(t,e){var n,r,i,a,s,o,h,l,c,u,f,d,p,g,m,b,v;switch(this.platformID=t.readUInt16(),this.encodingID=t.readShort(),this.offset=e+t.readInt(),c=t.pos,t.pos=this.offset,this.format=t.readUInt16(),this.length=t.readUInt16(),this.language=t.readUInt16(),this.isUnicode=3===this.platformID&&1===this.encodingID&&4===this.format||0===this.platformID&&4===this.format,this.codeMap={},this.format){case 0:for(o=0;o<256;++o)this.codeMap[o]=t.readByte();break;case 4:for(f=t.readUInt16(),u=f/2,t.pos+=6,i=function(){var e,n;for(n=[],o=e=0;0<=u?e<u:e>u;o=0<=u?++e:--e)n.push(t.readUInt16());return n}(),t.pos+=2,p=function(){var e,n;for(n=[],o=e=0;0<=u?e<u:e>u;o=0<=u?++e:--e)n.push(t.readUInt16());return n}(),h=function(){var e,n;for(n=[],o=e=0;0<=u?e<u:e>u;o=0<=u?++e:--e)n.push(t.readUInt16());return n}(),l=function(){var e,n;for(n=[],o=e=0;0<=u?e<u:e>u;o=0<=u?++e:--e)n.push(t.readUInt16());return n}(),r=(this.length-t.pos+this.offset)/2,s=function(){var e,n;for(n=[],o=e=0;0<=r?e<r:e>r;o=0<=r?++e:--e)n.push(t.readUInt16());return n}(),o=m=0,v=i.length;m<v;o=++m)for(g=i[o],n=b=d=p[o];d<=g?b<=g:b>=g;n=d<=g?++b:--b)0===l[o]?a=n+h[o]:0!==(a=s[l[o]/2+(n-d)-(u-o)]||0)&&(a+=h[o]),this.codeMap[n]=65535&a}t.pos=c}return t.encode=function(t,e){var n,r,i,a,s,o,h,l,c,u,f,d,p,g,m,b,v,w,y,_,x,A,L,N,S,k,P,F,I,C,j,E,O,B,M,R,T,q,D,z,U,H,W,V,G,Y;switch(F=new Ba,a=Object.keys(t).sort(function(t,e){return t-e}),e){case"macroman":for(p=0,g=function(){var t=[];for(d=0;d<256;++d)t.push(0);return t}(),b={0:0},i={},I=0,O=a.length;I<O;I++)null==b[W=t[r=a[I]]]&&(b[W]=++p),i[r]={old:t[r],new:b[t[r]]},g[r]=b[t[r]];return F.writeUInt16(1),F.writeUInt16(0),F.writeUInt32(12),F.writeUInt16(0),F.writeUInt16(262),F.writeUInt16(0),F.write(g),{charMap:i,subtable:F.data,maxGlyphID:p+1};case"unicode":for(k=[],c=[],v=0,b={},n={},m=h=null,C=0,B=a.length;C<B;C++)null==b[y=t[r=a[C]]]&&(b[y]=++v),n[r]={old:y,new:b[y]},s=b[y]-r,null!=m&&s===h||(m&&c.push(m),k.push(r),h=s),m=r;for(m&&c.push(m),c.push(65535),k.push(65535),N=2*(L=k.length),A=2*Math.pow(Math.log(L)/Math.LN2,2),u=Math.log(A/2)/Math.LN2,x=2*L-A,o=[],_=[],f=[],d=j=0,M=k.length;j<M;d=++j){if(S=k[d],l=c[d],65535===S){o.push(0),_.push(0);break}if(S-(P=n[S].new)>=32768)for(o.push(0),_.push(2*(f.length+L-d)),r=E=S;S<=l?E<=l:E>=l;r=S<=l?++E:--E)f.push(n[r].new);else o.push(P-S),_.push(0)}for(F.writeUInt16(3),F.writeUInt16(1),F.writeUInt32(12),F.writeUInt16(4),F.writeUInt16(16+8*L+2*f.length),F.writeUInt16(0),F.writeUInt16(N),F.writeUInt16(A),F.writeUInt16(u),F.writeUInt16(x),U=0,R=c.length;U<R;U++)r=c[U],F.writeUInt16(r);for(F.writeUInt16(0),H=0,T=k.length;H<T;H++)r=k[H],F.writeUInt16(r);for(V=0,q=o.length;V<q;V++)s=o[V],F.writeUInt16(s);for(G=0,D=_.length;G<D;G++)w=_[G],F.writeUInt16(w);for(Y=0,z=f.length;Y<z;Y++)p=f[Y],F.writeUInt16(p);return{charMap:n,subtable:F.data,maxGlyphID:v+1}}},t}(),za=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="cmap",e.prototype.parse=function(t){var e,n,r;for(t.pos=this.offset,this.version=t.readUInt16(),r=t.readUInt16(),this.tables=[],this.unicode=null,n=0;0<=r?n<r:n>r;n=0<=r?++n:--n)e=new Da(t,this.offset),this.tables.push(e),e.isUnicode&&null==this.unicode&&(this.unicode=e);return!0},e.encode=function(t,e){var n,r;return null==e&&(e="macroman"),n=Da.encode(t,e),(r=new Ba).writeUInt16(0),r.writeUInt16(1),n.table=r.data.concat(n.subtable),n},e}(Oa),Ua=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="hhea",e.prototype.parse=function(t){return t.pos=this.offset,this.version=t.readInt(),this.ascender=t.readShort(),this.decender=t.readShort(),this.lineGap=t.readShort(),this.advanceWidthMax=t.readShort(),this.minLeftSideBearing=t.readShort(),this.minRightSideBearing=t.readShort(),this.xMaxExtent=t.readShort(),this.caretSlopeRise=t.readShort(),this.caretSlopeRun=t.readShort(),this.caretOffset=t.readShort(),t.pos+=8,this.metricDataFormat=t.readShort(),this.numberOfMetrics=t.readUInt16()},e}(Oa),Ha=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="OS/2",e.prototype.parse=function(t){if(t.pos=this.offset,this.version=t.readUInt16(),this.averageCharWidth=t.readShort(),this.weightClass=t.readUInt16(),this.widthClass=t.readUInt16(),this.type=t.readShort(),this.ySubscriptXSize=t.readShort(),this.ySubscriptYSize=t.readShort(),this.ySubscriptXOffset=t.readShort(),this.ySubscriptYOffset=t.readShort(),this.ySuperscriptXSize=t.readShort(),this.ySuperscriptYSize=t.readShort(),this.ySuperscriptXOffset=t.readShort(),this.ySuperscriptYOffset=t.readShort(),this.yStrikeoutSize=t.readShort(),this.yStrikeoutPosition=t.readShort(),this.familyClass=t.readShort(),this.panose=function(){var e,n;for(n=[],e=0;e<10;++e)n.push(t.readByte());return n}(),this.charRange=function(){var e,n;for(n=[],e=0;e<4;++e)n.push(t.readInt());return n}(),this.vendorID=t.readString(4),this.selection=t.readShort(),this.firstCharIndex=t.readShort(),this.lastCharIndex=t.readShort(),this.version>0&&(this.ascent=t.readShort(),this.descent=t.readShort(),this.lineGap=t.readShort(),this.winAscent=t.readShort(),this.winDescent=t.readShort(),this.codePageRange=function(){var e,n;for(n=[],e=0;e<2;e=++e)n.push(t.readInt());return n}(),this.version>1))return this.xHeight=t.readShort(),this.capHeight=t.readShort(),this.defaultChar=t.readShort(),this.breakChar=t.readShort(),this.maxContext=t.readShort()},e}(Oa),Wa=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="post",e.prototype.parse=function(t){var e,n,r;switch(t.pos=this.offset,this.format=t.readInt(),this.italicAngle=t.readInt(),this.underlinePosition=t.readShort(),this.underlineThickness=t.readShort(),this.isFixedPitch=t.readInt(),this.minMemType42=t.readInt(),this.maxMemType42=t.readInt(),this.minMemType1=t.readInt(),this.maxMemType1=t.readInt(),this.format){case 65536:case 196608:break;case 131072:var i;for(n=t.readUInt16(),this.glyphNameIndex=[],i=0;0<=n?i<n:i>n;i=0<=n?++i:--i)this.glyphNameIndex.push(t.readUInt16());for(this.names=[],r=[];t.pos<this.offset+this.length;)e=t.readByte(),r.push(this.names.push(t.readString(e)));return r;case 151552:return n=t.readUInt16(),this.offsets=t.read(n);case 262144:return this.map=function(){var e,n,r;for(r=[],i=e=0,n=this.file.maxp.numGlyphs;0<=n?e<n:e>n;i=0<=n?++e:--e)r.push(t.readUInt32());return r}.call(this)}},e}(Oa),Va=function(t,e){this.raw=t,this.length=t.length,this.platformID=e.platformID,this.encodingID=e.encodingID,this.languageID=e.languageID},Ga=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="name",e.prototype.parse=function(t){var e,n,r,i,a,s,o,h,l,c,u;for(t.pos=this.offset,t.readShort(),e=t.readShort(),s=t.readShort(),n=[],i=0;0<=e?i<e:i>e;i=0<=e?++i:--i)n.push({platformID:t.readShort(),encodingID:t.readShort(),languageID:t.readShort(),nameID:t.readShort(),length:t.readShort(),offset:this.offset+s+t.readShort()});for(o={},i=l=0,c=n.length;l<c;i=++l)r=n[i],t.pos=r.offset,h=t.readString(r.length),a=new Va(h,r),null==o[u=r.nameID]&&(o[u]=[]),o[r.nameID].push(a);this.strings=o,this.copyright=o[0],this.fontFamily=o[1],this.fontSubfamily=o[2],this.uniqueSubfamily=o[3],this.fontName=o[4],this.version=o[5];try{this.postscriptName=o[6][0].raw.replace(/[\x00-\x19\x80-\xff]/g,"")}catch(es){this.postscriptName=o[4][0].raw.replace(/[\x00-\x19\x80-\xff]/g,"")}return this.trademark=o[7],this.manufacturer=o[8],this.designer=o[9],this.description=o[10],this.vendorUrl=o[11],this.designerUrl=o[12],this.license=o[13],this.licenseUrl=o[14],this.preferredFamily=o[15],this.preferredSubfamily=o[17],this.compatibleFull=o[18],this.sampleText=o[19]},e}(Oa),Ya=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="maxp",e.prototype.parse=function(t){return t.pos=this.offset,this.version=t.readInt(),this.numGlyphs=t.readUInt16(),this.maxPoints=t.readUInt16(),this.maxContours=t.readUInt16(),this.maxCompositePoints=t.readUInt16(),this.maxComponentContours=t.readUInt16(),this.maxZones=t.readUInt16(),this.maxTwilightPoints=t.readUInt16(),this.maxStorage=t.readUInt16(),this.maxFunctionDefs=t.readUInt16(),this.maxInstructionDefs=t.readUInt16(),this.maxStackElements=t.readUInt16(),this.maxSizeOfInstructions=t.readUInt16(),this.maxComponentElements=t.readUInt16(),this.maxComponentDepth=t.readUInt16()},e}(Oa),Za=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="hmtx",e.prototype.parse=function(t){var e,n,r,i,a,s,o;for(t.pos=this.offset,this.metrics=[],e=0,s=this.file.hhea.numberOfMetrics;0<=s?e<s:e>s;e=0<=s?++e:--e)this.metrics.push({advance:t.readUInt16(),lsb:t.readInt16()});for(r=this.file.maxp.numGlyphs-this.file.hhea.numberOfMetrics,this.leftSideBearings=function(){var n,i;for(i=[],e=n=0;0<=r?n<r:n>r;e=0<=r?++n:--n)i.push(t.readInt16());return i}(),this.widths=function(){var t,e,n,r;for(r=[],t=0,e=(n=this.metrics).length;t<e;t++)i=n[t],r.push(i.advance);return r}.call(this),n=this.widths[this.widths.length-1],o=[],e=a=0;0<=r?a<r:a>r;e=0<=r?++a:--a)o.push(this.widths.push(n));return o},e.prototype.forGlyph=function(t){return t in this.metrics?this.metrics[t]:{advance:this.metrics[this.metrics.length-1].advance,lsb:this.leftSideBearings[t-this.metrics.length]}},e}(Oa),Ja=[].slice,Xa=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="glyf",e.prototype.parse=function(){return this.cache={}},e.prototype.glyphFor=function(t){var e,n,r,i,a,s,o,h,l,c;return t in this.cache?this.cache[t]:(i=this.file.loca,e=this.file.contents,n=i.indexOf(t),0===(r=i.lengthOf(t))?this.cache[t]=null:(e.pos=this.offset+n,a=(s=new Ba(e.read(r))).readShort(),h=s.readShort(),c=s.readShort(),o=s.readShort(),l=s.readShort(),this.cache[t]=-1===a?new $a(s,h,c,o,l):new Ka(s,a,h,c,o,l),this.cache[t]))},e.prototype.encode=function(t,e,n){var r,i,a,s,o;for(a=[],i=[],s=0,o=e.length;s<o;s++)r=t[e[s]],i.push(a.length),r&&(a=a.concat(r.encode(n)));return i.push(a.length),{table:a,offsets:i}},e}(Oa),Ka=function(){function t(t,e,n,r,i,a){this.raw=t,this.numberOfContours=e,this.xMin=n,this.yMin=r,this.xMax=i,this.yMax=a,this.compound=!1}return t.prototype.encode=function(){return this.raw.data},t}(),$a=function(){function t(t,e,n,r,i){var a,s;for(this.raw=t,this.xMin=e,this.yMin=n,this.xMax=r,this.yMax=i,this.compound=!0,this.glyphIDs=[],this.glyphOffsets=[],a=this.raw;s=a.readShort(),this.glyphOffsets.push(a.pos),this.glyphIDs.push(a.readUInt16()),32&s;)a.pos+=1&s?4:2,128&s?a.pos+=8:64&s?a.pos+=4:8&s&&(a.pos+=2)}return t.prototype.encode=function(){var t,e,n;for(e=new Ba(Ja.call(this.raw.data)),t=0,n=this.glyphIDs.length;t<n;++t)e.pos=this.glyphOffsets[t];return e.data},t}(),Qa=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return Ta(e,t),e.prototype.tag="loca",e.prototype.parse=function(t){var e,n;return t.pos=this.offset,e=this.file.head.indexToLocFormat,this.offsets=0===e?function(){var e,r;for(r=[],n=0,e=this.length;n<e;n+=2)r.push(2*t.readUInt16());return r}.call(this):function(){var e,r;for(r=[],n=0,e=this.length;n<e;n+=4)r.push(t.readUInt32());return r}.call(this)},e.prototype.indexOf=function(t){return this.offsets[t]},e.prototype.lengthOf=function(t){return this.offsets[t+1]-this.offsets[t]},e.prototype.encode=function(t,e){for(var n=new Uint32Array(this.offsets.length),r=0,i=0,a=0;a<n.length;++a)if(n[a]=r,i<e.length&&e[i]==a){++i,n[a]=r;var s=this.offsets[a],o=this.offsets[a+1]-s;o>0&&(r+=o)}for(var h=new Array(4*n.length),l=0;l<n.length;++l)h[4*l+3]=255&n[l],h[4*l+2]=(65280&n[l])>>8,h[4*l+1]=(16711680&n[l])>>16,h[4*l]=(4278190080&n[l])>>24;return h},e}(Oa),ts=function(){function t(t){this.font=t,this.subset={},this.unicodes={},this.next=33}return t.prototype.generateCmap=function(){var t,e,n,r,i;for(e in r=this.font.cmap.tables[0].codeMap,t={},i=this.subset)n=i[e],t[e]=r[n];return t},t.prototype.glyphsFor=function(t){var e,n,r,i,a,s,o;for(r={},a=0,s=t.length;a<s;a++)r[i=t[a]]=this.font.glyf.glyphFor(i);for(i in e=[],r)(null!=(n=r[i])?n.compound:void 0)&&e.push.apply(e,n.glyphIDs);if(e.length>0)for(i in o=this.glyphsFor(e))n=o[i],r[i]=n;return r},t.prototype.encode=function(t,e){var n,r,i,a,s,o,h,l,c,u,f,d,p,g,m;for(r in n=za.encode(this.generateCmap(),"unicode"),a=this.glyphsFor(t),f={0:0},m=n.charMap)f[(o=m[r]).old]=o.new;for(d in u=n.maxGlyphID,a)d in f||(f[d]=u++);return l=function(t){var e,n;for(e in n={},t)n[t[e]]=e;return n}(f),c=Object.keys(l).sort(function(t,e){return t-e}),p=function(){var t,e,n;for(n=[],t=0,e=c.length;t<e;t++)s=c[t],n.push(l[s]);return n}(),i=this.font.glyf.encode(a,p,f),h=this.font.loca.encode(i.offsets,p),g={cmap:this.font.cmap.raw(),glyf:i.table,loca:h,hmtx:this.font.hmtx.raw(),hhea:this.font.hhea.raw(),maxp:this.font.maxp.raw(),post:this.font.post.raw(),name:this.font.name.raw(),head:this.font.head.encode(e)},this.font.os2.exists&&(g["OS/2"]=this.font.os2.raw()),this.font.directory.encode(g)},t}();R.API.PDFObject=function(){var t;function e(){}return t=function(t,e){return(Array(e+1).join("0")+t).slice(-e)},e.convert=function(n){var r,i,a,s;if(Array.isArray(n))return"["+function(){var t,i,a;for(a=[],t=0,i=n.length;t<i;t++)r=n[t],a.push(e.convert(r));return a}().join(" ")+"]";if("string"==typeof n)return"/"+n;if(null!=n?n.isString:void 0)return"("+n+")";if(n instanceof Date)return"(D:"+t(n.getUTCFullYear(),4)+t(n.getUTCMonth(),2)+t(n.getUTCDate(),2)+t(n.getUTCHours(),2)+t(n.getUTCMinutes(),2)+t(n.getUTCSeconds(),2)+"Z)";if("[object Object]"==={}.toString.call(n)){for(i in a=["<<"],n)s=n[i],a.push("/"+i+" "+e.convert(s));return a.push(">>"),a.join("\n")}return""+n},e}(),t.AcroForm=Nt,t.AcroFormAppearance=At,t.AcroFormButton=mt,t.AcroFormCheckBox=yt,t.AcroFormChoiceField=ft,t.AcroFormComboBox=pt,t.AcroFormEditBox=gt,t.AcroFormListBox=dt,t.AcroFormPasswordField=xt,t.AcroFormPushButton=bt,t.AcroFormRadioButton=vt,t.AcroFormTextField=_t,t.GState=E,t.ShadingPattern=B,t.TilingPattern=M,t.default=R,t.jsPDF=R,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=jspdf.umd.min.js.map
</script>
  <script>/* Chart.js 4.4 embedded */
/*!
 * Chart.js v4.5.1
 * https://www.chartjs.org
 * (c) 2025 Chart.js Contributors
 * Released under the MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Chart=e()}(this,(function(){"use strict";var t=Object.freeze({__proto__:null,get Colors(){return Jo},get Decimation(){return ta},get Filler(){return ba},get Legend(){return Ma},get SubTitle(){return Pa},get Title(){return ka},get Tooltip(){return Na}});function e(){}const i=(()=>{let t=0;return()=>t++})();function s(t){return null==t}function n(t){if(Array.isArray&&Array.isArray(t))return!0;const e=Object.prototype.toString.call(t);return"[object"===e.slice(0,7)&&"Array]"===e.slice(-6)}function o(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function a(t){return("number"==typeof t||t instanceof Number)&&isFinite(+t)}function r(t,e){return a(t)?t:e}function l(t,e){return void 0===t?e:t}const h=(t,e)=>"string"==typeof t&&t.endsWith("%")?parseFloat(t)/100:+t/e,c=(t,e)=>"string"==typeof t&&t.endsWith("%")?parseFloat(t)/100*e:+t;function d(t,e,i){if(t&&"function"==typeof t.call)return t.apply(i,e)}function u(t,e,i,s){let a,r,l;if(n(t))if(r=t.length,s)for(a=r-1;a>=0;a--)e.call(i,t[a],a);else for(a=0;a<r;a++)e.call(i,t[a],a);else if(o(t))for(l=Object.keys(t),r=l.length,a=0;a<r;a++)e.call(i,t[l[a]],l[a])}function f(t,e){let i,s,n,o;if(!t||!e||t.length!==e.length)return!1;for(i=0,s=t.length;i<s;++i)if(n=t[i],o=e[i],n.datasetIndex!==o.datasetIndex||n.index!==o.index)return!1;return!0}function g(t){if(n(t))return t.map(g);if(o(t)){const e=Object.create(null),i=Object.keys(t),s=i.length;let n=0;for(;n<s;++n)e[i[n]]=g(t[i[n]]);return e}return t}function p(t){return-1===["__proto__","prototype","constructor"].indexOf(t)}function m(t,e,i,s){if(!p(t))return;const n=e[t],a=i[t];o(n)&&o(a)?x(n,a,s):e[t]=g(a)}function x(t,e,i){const s=n(e)?e:[e],a=s.length;if(!o(t))return t;const r=(i=i||{}).merger||m;let l;for(let e=0;e<a;++e){if(l=s[e],!o(l))continue;const n=Object.keys(l);for(let e=0,s=n.length;e<s;++e)r(n[e],t,l,i)}return t}function b(t,e){return x(t,e,{merger:_})}function _(t,e,i){if(!p(t))return;const s=e[t],n=i[t];o(s)&&o(n)?b(s,n):Object.prototype.hasOwnProperty.call(e,t)||(e[t]=g(n))}const y={"":t=>t,x:t=>t.x,y:t=>t.y};function v(t){const e=t.split("."),i=[];let s="";for(const t of e)s+=t,s.endsWith("\\")?s=s.slice(0,-1)+".":(i.push(s),s="");return i}function M(t,e){const i=y[e]||(y[e]=function(t){const e=v(t);return t=>{for(const i of e){if(""===i)break;t=t&&t[i]}return t}}(e));return i(t)}function w(t){return t.charAt(0).toUpperCase()+t.slice(1)}const k=t=>void 0!==t,S=t=>"function"==typeof t,P=(t,e)=>{if(t.size!==e.size)return!1;for(const i of t)if(!e.has(i))return!1;return!0};function D(t){return"mouseup"===t.type||"click"===t.type||"contextmenu"===t.type}const C=Math.PI,O=2*C,A=O+C,T=Number.POSITIVE_INFINITY,L=C/180,E=C/2,R=C/4,I=2*C/3,z=Math.log10,F=Math.sign;function V(t,e,i){return Math.abs(t-e)<i}function B(t){const e=Math.round(t);t=V(t,e,t/1e3)?e:t;const i=Math.pow(10,Math.floor(z(t))),s=t/i;return(s<=1?1:s<=2?2:s<=5?5:10)*i}function W(t){const e=[],i=Math.sqrt(t);let s;for(s=1;s<i;s++)t%s==0&&(e.push(s),e.push(t/s));return i===(0|i)&&e.push(i),e.sort(((t,e)=>t-e)).pop(),e}function N(t){return!function(t){return"symbol"==typeof t||"object"==typeof t&&null!==t&&!(Symbol.toPrimitive in t||"toString"in t||"valueOf"in t)}(t)&&!isNaN(parseFloat(t))&&isFinite(t)}function H(t,e){const i=Math.round(t);return i-e<=t&&i+e>=t}function j(t,e,i){let s,n,o;for(s=0,n=t.length;s<n;s++)o=t[s][i],isNaN(o)||(e.min=Math.min(e.min,o),e.max=Math.max(e.max,o))}function $(t){return t*(C/180)}function Y(t){return t*(180/C)}function U(t){if(!a(t))return;let e=1,i=0;for(;Math.round(t*e)/e!==t;)e*=10,i++;return i}function X(t,e){const i=e.x-t.x,s=e.y-t.y,n=Math.sqrt(i*i+s*s);let o=Math.atan2(s,i);return o<-.5*C&&(o+=O),{angle:o,distance:n}}function q(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function K(t,e){return(t-e+A)%O-C}function G(t){return(t%O+O)%O}function J(t,e,i,s){const n=G(t),o=G(e),a=G(i),r=G(o-n),l=G(a-n),h=G(n-o),c=G(n-a);return n===o||n===a||s&&o===a||r>l&&h<c}function Z(t,e,i){return Math.max(e,Math.min(i,t))}function Q(t){return Z(t,-32768,32767)}function tt(t,e,i,s=1e-6){return t>=Math.min(e,i)-s&&t<=Math.max(e,i)+s}function et(t,e,i){i=i||(i=>t[i]<e);let s,n=t.length-1,o=0;for(;n-o>1;)s=o+n>>1,i(s)?o=s:n=s;return{lo:o,hi:n}}const it=(t,e,i,s)=>et(t,i,s?s=>{const n=t[s][e];return n<i||n===i&&t[s+1][e]===i}:s=>t[s][e]<i),st=(t,e,i)=>et(t,i,(s=>t[s][e]>=i));function nt(t,e,i){let s=0,n=t.length;for(;s<n&&t[s]<e;)s++;for(;n>s&&t[n-1]>i;)n--;return s>0||n<t.length?t.slice(s,n):t}const ot=["push","pop","shift","splice","unshift"];function at(t,e){t._chartjs?t._chartjs.listeners.push(e):(Object.defineProperty(t,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[e]}}),ot.forEach((e=>{const i="_onData"+w(e),s=t[e];Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value(...e){const n=s.apply(this,e);return t._chartjs.listeners.forEach((t=>{"function"==typeof t[i]&&t[i](...e)})),n}})})))}function rt(t,e){const i=t._chartjs;if(!i)return;const s=i.listeners,n=s.indexOf(e);-1!==n&&s.splice(n,1),s.length>0||(ot.forEach((e=>{delete t[e]})),delete t._chartjs)}function lt(t){const e=new Set(t);return e.size===t.length?t:Array.from(e)}const ht="undefined"==typeof window?function(t){return t()}:window.requestAnimationFrame;function ct(t,e){let i=[],s=!1;return function(...n){i=n,s||(s=!0,ht.call(window,(()=>{s=!1,t.apply(e,i)})))}}function dt(t,e){let i;return function(...s){return e?(clearTimeout(i),i=setTimeout(t,e,s)):t.apply(this,s),e}}const ut=t=>"start"===t?"left":"end"===t?"right":"center",ft=(t,e,i)=>"start"===t?e:"end"===t?i:(e+i)/2,gt=(t,e,i,s)=>t===(s?"left":"right")?i:"center"===t?(e+i)/2:e;function pt(t,e,i){const n=e.length;let o=0,a=n;if(t._sorted){const{iScale:r,vScale:l,_parsed:h}=t,c=t.dataset&&t.dataset.options?t.dataset.options.spanGaps:null,d=r.axis,{min:u,max:f,minDefined:g,maxDefined:p}=r.getUserBounds();if(g){if(o=Math.min(it(h,d,u).lo,i?n:it(e,d,r.getPixelForValue(u)).lo),c){const t=h.slice(0,o+1).reverse().findIndex((t=>!s(t[l.axis])));o-=Math.max(0,t)}o=Z(o,0,n-1)}if(p){let t=Math.max(it(h,r.axis,f,!0).hi+1,i?0:it(e,d,r.getPixelForValue(f),!0).hi+1);if(c){const e=h.slice(t-1).findIndex((t=>!s(t[l.axis])));t+=Math.max(0,e)}a=Z(t,o,n)-o}else a=n-o}return{start:o,count:a}}function mt(t){const{xScale:e,yScale:i,_scaleRanges:s}=t,n={xmin:e.min,xmax:e.max,ymin:i.min,ymax:i.max};if(!s)return t._scaleRanges=n,!0;const o=s.xmin!==e.min||s.xmax!==e.max||s.ymin!==i.min||s.ymax!==i.max;return Object.assign(s,n),o}class xt{constructor(){this._request=null,this._charts=new Map,this._running=!1,this._lastDate=void 0}_notify(t,e,i,s){const n=e.listeners[s],o=e.duration;n.forEach((s=>s({chart:t,initial:e.initial,numSteps:o,currentStep:Math.min(i-e.start,o)})))}_refresh(){this._request||(this._running=!0,this._request=ht.call(window,(()=>{this._update(),this._request=null,this._running&&this._refresh()})))}_update(t=Date.now()){let e=0;this._charts.forEach(((i,s)=>{if(!i.running||!i.items.length)return;const n=i.items;let o,a=n.length-1,r=!1;for(;a>=0;--a)o=n[a],o._active?(o._total>i.duration&&(i.duration=o._total),o.tick(t),r=!0):(n[a]=n[n.length-1],n.pop());r&&(s.draw(),this._notify(s,i,t,"progress")),n.length||(i.running=!1,this._notify(s,i,t,"complete"),i.initial=!1),e+=n.length})),this._lastDate=t,0===e&&(this._running=!1)}_getAnims(t){const e=this._charts;let i=e.get(t);return i||(i={running:!1,initial:!0,items:[],listeners:{complete:[],progress:[]}},e.set(t,i)),i}listen(t,e,i){this._getAnims(t).listeners[e].push(i)}add(t,e){e&&e.length&&this._getAnims(t).items.push(...e)}has(t){return this._getAnims(t).items.length>0}start(t){const e=this._charts.get(t);e&&(e.running=!0,e.start=Date.now(),e.duration=e.items.reduce(((t,e)=>Math.max(t,e._duration)),0),this._refresh())}running(t){if(!this._running)return!1;const e=this._charts.get(t);return!!(e&&e.running&&e.items.length)}stop(t){const e=this._charts.get(t);if(!e||!e.items.length)return;const i=e.items;let s=i.length-1;for(;s>=0;--s)i[s].cancel();e.items=[],this._notify(t,e,Date.now(),"complete")}remove(t){return this._charts.delete(t)}}var bt=new xt;
/*!
 * @kurkle/color v0.3.2
 * https://github.com/kurkle/color#readme
 * (c) 2023 Jukka Kurkela
 * Released under the MIT License
 */function _t(t){return t+.5|0}const yt=(t,e,i)=>Math.max(Math.min(t,i),e);function vt(t){return yt(_t(2.55*t),0,255)}function Mt(t){return yt(_t(255*t),0,255)}function wt(t){return yt(_t(t/2.55)/100,0,1)}function kt(t){return yt(_t(100*t),0,100)}const St={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15},Pt=[..."0123456789ABCDEF"],Dt=t=>Pt[15&t],Ct=t=>Pt[(240&t)>>4]+Pt[15&t],Ot=t=>(240&t)>>4==(15&t);function At(t){var e=(t=>Ot(t.r)&&Ot(t.g)&&Ot(t.b)&&Ot(t.a))(t)?Dt:Ct;return t?"#"+e(t.r)+e(t.g)+e(t.b)+((t,e)=>t<255?e(t):"")(t.a,e):void 0}const Tt=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function Lt(t,e,i){const s=e*Math.min(i,1-i),n=(e,n=(e+t/30)%12)=>i-s*Math.max(Math.min(n-3,9-n,1),-1);return[n(0),n(8),n(4)]}function Et(t,e,i){const s=(s,n=(s+t/60)%6)=>i-i*e*Math.max(Math.min(n,4-n,1),0);return[s(5),s(3),s(1)]}function Rt(t,e,i){const s=Lt(t,1,.5);let n;for(e+i>1&&(n=1/(e+i),e*=n,i*=n),n=0;n<3;n++)s[n]*=1-e-i,s[n]+=e;return s}function It(t){const e=t.r/255,i=t.g/255,s=t.b/255,n=Math.max(e,i,s),o=Math.min(e,i,s),a=(n+o)/2;let r,l,h;return n!==o&&(h=n-o,l=a>.5?h/(2-n-o):h/(n+o),r=function(t,e,i,s,n){return t===n?(e-i)/s+(e<i?6:0):e===n?(i-t)/s+2:(t-e)/s+4}(e,i,s,h,n),r=60*r+.5),[0|r,l||0,a]}function zt(t,e,i,s){return(Array.isArray(e)?t(e[0],e[1],e[2]):t(e,i,s)).map(Mt)}function Ft(t,e,i){return zt(Lt,t,e,i)}function Vt(t){return(t%360+360)%360}function Bt(t){const e=Tt.exec(t);let i,s=255;if(!e)return;e[5]!==i&&(s=e[6]?vt(+e[5]):Mt(+e[5]));const n=Vt(+e[2]),o=+e[3]/100,a=+e[4]/100;return i="hwb"===e[1]?function(t,e,i){return zt(Rt,t,e,i)}(n,o,a):"hsv"===e[1]?function(t,e,i){return zt(Et,t,e,i)}(n,o,a):Ft(n,o,a),{r:i[0],g:i[1],b:i[2],a:s}}const Wt={x:"dark",Z:"light",Y:"re",X:"blu",W:"gr",V:"medium",U:"slate",A:"ee",T:"ol",S:"or",B:"ra",C:"lateg",D:"ights",R:"in",Q:"turquois",E:"hi",P:"ro",O:"al",N:"le",M:"de",L:"yello",F:"en",K:"ch",G:"arks",H:"ea",I:"ightg",J:"wh"},Nt={OiceXe:"f0f8ff",antiquewEte:"faebd7",aqua:"ffff",aquamarRe:"7fffd4",azuY:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"0",blanKedOmond:"ffebcd",Xe:"ff",XeviTet:"8a2be2",bPwn:"a52a2a",burlywood:"deb887",caMtXe:"5f9ea0",KartYuse:"7fff00",KocTate:"d2691e",cSO:"ff7f50",cSnflowerXe:"6495ed",cSnsilk:"fff8dc",crimson:"dc143c",cyan:"ffff",xXe:"8b",xcyan:"8b8b",xgTMnPd:"b8860b",xWay:"a9a9a9",xgYF:"6400",xgYy:"a9a9a9",xkhaki:"bdb76b",xmagFta:"8b008b",xTivegYF:"556b2f",xSange:"ff8c00",xScEd:"9932cc",xYd:"8b0000",xsOmon:"e9967a",xsHgYF:"8fbc8f",xUXe:"483d8b",xUWay:"2f4f4f",xUgYy:"2f4f4f",xQe:"ced1",xviTet:"9400d3",dAppRk:"ff1493",dApskyXe:"bfff",dimWay:"696969",dimgYy:"696969",dodgerXe:"1e90ff",fiYbrick:"b22222",flSOwEte:"fffaf0",foYstWAn:"228b22",fuKsia:"ff00ff",gaRsbSo:"dcdcdc",ghostwEte:"f8f8ff",gTd:"ffd700",gTMnPd:"daa520",Way:"808080",gYF:"8000",gYFLw:"adff2f",gYy:"808080",honeyMw:"f0fff0",hotpRk:"ff69b4",RdianYd:"cd5c5c",Rdigo:"4b0082",ivSy:"fffff0",khaki:"f0e68c",lavFMr:"e6e6fa",lavFMrXsh:"fff0f5",lawngYF:"7cfc00",NmoncEffon:"fffacd",ZXe:"add8e6",ZcSO:"f08080",Zcyan:"e0ffff",ZgTMnPdLw:"fafad2",ZWay:"d3d3d3",ZgYF:"90ee90",ZgYy:"d3d3d3",ZpRk:"ffb6c1",ZsOmon:"ffa07a",ZsHgYF:"20b2aa",ZskyXe:"87cefa",ZUWay:"778899",ZUgYy:"778899",ZstAlXe:"b0c4de",ZLw:"ffffe0",lime:"ff00",limegYF:"32cd32",lRF:"faf0e6",magFta:"ff00ff",maPon:"800000",VaquamarRe:"66cdaa",VXe:"cd",VScEd:"ba55d3",VpurpN:"9370db",VsHgYF:"3cb371",VUXe:"7b68ee",VsprRggYF:"fa9a",VQe:"48d1cc",VviTetYd:"c71585",midnightXe:"191970",mRtcYam:"f5fffa",mistyPse:"ffe4e1",moccasR:"ffe4b5",navajowEte:"ffdead",navy:"80",Tdlace:"fdf5e6",Tive:"808000",TivedBb:"6b8e23",Sange:"ffa500",SangeYd:"ff4500",ScEd:"da70d6",pOegTMnPd:"eee8aa",pOegYF:"98fb98",pOeQe:"afeeee",pOeviTetYd:"db7093",papayawEp:"ffefd5",pHKpuff:"ffdab9",peru:"cd853f",pRk:"ffc0cb",plum:"dda0dd",powMrXe:"b0e0e6",purpN:"800080",YbeccapurpN:"663399",Yd:"ff0000",Psybrown:"bc8f8f",PyOXe:"4169e1",saddNbPwn:"8b4513",sOmon:"fa8072",sandybPwn:"f4a460",sHgYF:"2e8b57",sHshell:"fff5ee",siFna:"a0522d",silver:"c0c0c0",skyXe:"87ceeb",UXe:"6a5acd",UWay:"708090",UgYy:"708090",snow:"fffafa",sprRggYF:"ff7f",stAlXe:"4682b4",tan:"d2b48c",teO:"8080",tEstN:"d8bfd8",tomato:"ff6347",Qe:"40e0d0",viTet:"ee82ee",JHt:"f5deb3",wEte:"ffffff",wEtesmoke:"f5f5f5",Lw:"ffff00",LwgYF:"9acd32"};let Ht;function jt(t){Ht||(Ht=function(){const t={},e=Object.keys(Nt),i=Object.keys(Wt);let s,n,o,a,r;for(s=0;s<e.length;s++){for(a=r=e[s],n=0;n<i.length;n++)o=i[n],r=r.replace(o,Wt[o]);o=parseInt(Nt[a],16),t[r]=[o>>16&255,o>>8&255,255&o]}return t}(),Ht.transparent=[0,0,0,0]);const e=Ht[t.toLowerCase()];return e&&{r:e[0],g:e[1],b:e[2],a:4===e.length?e[3]:255}}const $t=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/;const Yt=t=>t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055,Ut=t=>t<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4);function Xt(t,e,i){if(t){let s=It(t);s[e]=Math.max(0,Math.min(s[e]+s[e]*i,0===e?360:1)),s=Ft(s),t.r=s[0],t.g=s[1],t.b=s[2]}}function qt(t,e){return t?Object.assign(e||{},t):t}function Kt(t){var e={r:0,g:0,b:0,a:255};return Array.isArray(t)?t.length>=3&&(e={r:t[0],g:t[1],b:t[2],a:255},t.length>3&&(e.a=Mt(t[3]))):(e=qt(t,{r:0,g:0,b:0,a:1})).a=Mt(e.a),e}function Gt(t){return"r"===t.charAt(0)?function(t){const e=$t.exec(t);let i,s,n,o=255;if(e){if(e[7]!==i){const t=+e[7];o=e[8]?vt(t):yt(255*t,0,255)}return i=+e[1],s=+e[3],n=+e[5],i=255&(e[2]?vt(i):yt(i,0,255)),s=255&(e[4]?vt(s):yt(s,0,255)),n=255&(e[6]?vt(n):yt(n,0,255)),{r:i,g:s,b:n,a:o}}}(t):Bt(t)}class Jt{constructor(t){if(t instanceof Jt)return t;const e=typeof t;let i;var s,n,o;"object"===e?i=Kt(t):"string"===e&&(o=(s=t).length,"#"===s[0]&&(4===o||5===o?n={r:255&17*St[s[1]],g:255&17*St[s[2]],b:255&17*St[s[3]],a:5===o?17*St[s[4]]:255}:7!==o&&9!==o||(n={r:St[s[1]]<<4|St[s[2]],g:St[s[3]]<<4|St[s[4]],b:St[s[5]]<<4|St[s[6]],a:9===o?St[s[7]]<<4|St[s[8]]:255})),i=n||jt(t)||Gt(t)),this._rgb=i,this._valid=!!i}get valid(){return this._valid}get rgb(){var t=qt(this._rgb);return t&&(t.a=wt(t.a)),t}set rgb(t){this._rgb=Kt(t)}rgbString(){return this._valid?(t=this._rgb)&&(t.a<255?`rgba(${t.r}, ${t.g}, ${t.b}, ${wt(t.a)})`:`rgb(${t.r}, ${t.g}, ${t.b})`):void 0;var t}hexString(){return this._valid?At(this._rgb):void 0}hslString(){return this._valid?function(t){if(!t)return;const e=It(t),i=e[0],s=kt(e[1]),n=kt(e[2]);return t.a<255?`hsla(${i}, ${s}%, ${n}%, ${wt(t.a)})`:`hsl(${i}, ${s}%, ${n}%)`}(this._rgb):void 0}mix(t,e){if(t){const i=this.rgb,s=t.rgb;let n;const o=e===n?.5:e,a=2*o-1,r=i.a-s.a,l=((a*r==-1?a:(a+r)/(1+a*r))+1)/2;n=1-l,i.r=255&l*i.r+n*s.r+.5,i.g=255&l*i.g+n*s.g+.5,i.b=255&l*i.b+n*s.b+.5,i.a=o*i.a+(1-o)*s.a,this.rgb=i}return this}interpolate(t,e){return t&&(this._rgb=function(t,e,i){const s=Ut(wt(t.r)),n=Ut(wt(t.g)),o=Ut(wt(t.b));return{r:Mt(Yt(s+i*(Ut(wt(e.r))-s))),g:Mt(Yt(n+i*(Ut(wt(e.g))-n))),b:Mt(Yt(o+i*(Ut(wt(e.b))-o))),a:t.a+i*(e.a-t.a)}}(this._rgb,t._rgb,e)),this}clone(){return new Jt(this.rgb)}alpha(t){return this._rgb.a=Mt(t),this}clearer(t){return this._rgb.a*=1-t,this}greyscale(){const t=this._rgb,e=_t(.3*t.r+.59*t.g+.11*t.b);return t.r=t.g=t.b=e,this}opaquer(t){return this._rgb.a*=1+t,this}negate(){const t=this._rgb;return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,this}lighten(t){return Xt(this._rgb,2,t),this}darken(t){return Xt(this._rgb,2,-t),this}saturate(t){return Xt(this._rgb,1,t),this}desaturate(t){return Xt(this._rgb,1,-t),this}rotate(t){return function(t,e){var i=It(t);i[0]=Vt(i[0]+e),i=Ft(i),t.r=i[0],t.g=i[1],t.b=i[2]}(this._rgb,t),this}}function Zt(t){if(t&&"object"==typeof t){const e=t.toString();return"[object CanvasPattern]"===e||"[object CanvasGradient]"===e}return!1}function Qt(t){return Zt(t)?t:new Jt(t)}function te(t){return Zt(t)?t:new Jt(t).saturate(.5).darken(.1).hexString()}const ee=["x","y","borderWidth","radius","tension"],ie=["color","borderColor","backgroundColor"];const se=new Map;function ne(t,e,i){return function(t,e){e=e||{};const i=t+JSON.stringify(e);let s=se.get(i);return s||(s=new Intl.NumberFormat(t,e),se.set(i,s)),s}(e,i).format(t)}const oe={values:t=>n(t)?t:""+t,numeric(t,e,i){if(0===t)return"0";const s=this.chart.options.locale;let n,o=t;if(i.length>1){const e=Math.max(Math.abs(i[0].value),Math.abs(i[i.length-1].value));(e<1e-4||e>1e15)&&(n="scientific"),o=function(t,e){let i=e.length>3?e[2].value-e[1].value:e[1].value-e[0].value;Math.abs(i)>=1&&t!==Math.floor(t)&&(i=t-Math.floor(t));return i}(t,i)}const a=z(Math.abs(o)),r=isNaN(a)?1:Math.max(Math.min(-1*Math.floor(a),20),0),l={notation:n,minimumFractionDigits:r,maximumFractionDigits:r};return Object.assign(l,this.options.ticks.format),ne(t,s,l)},logarithmic(t,e,i){if(0===t)return"0";const s=i[e].significand||t/Math.pow(10,Math.floor(z(t)));return[1,2,3,5,10,15].includes(s)||e>.8*i.length?oe.numeric.call(this,t,e,i):""}};var ae={formatters:oe};const re=Object.create(null),le=Object.create(null);function he(t,e){if(!e)return t;const i=e.split(".");for(let e=0,s=i.length;e<s;++e){const s=i[e];t=t[s]||(t[s]=Object.create(null))}return t}function ce(t,e,i){return"string"==typeof e?x(he(t,e),i):x(he(t,""),e)}class de{constructor(t,e){this.animation=void 0,this.backgroundColor="rgba(0,0,0,0.1)",this.borderColor="rgba(0,0,0,0.1)",this.color="#666",this.datasets={},this.devicePixelRatio=t=>t.chart.platform.getDevicePixelRatio(),this.elements={},this.events=["mousemove","mouseout","click","touchstart","touchmove"],this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:"normal",lineHeight:1.2,weight:null},this.hover={},this.hoverBackgroundColor=(t,e)=>te(e.backgroundColor),this.hoverBorderColor=(t,e)=>te(e.borderColor),this.hoverColor=(t,e)=>te(e.color),this.indexAxis="x",this.interaction={mode:"nearest",intersect:!0,includeInvisible:!1},this.maintainAspectRatio=!0,this.onHover=null,this.onClick=null,this.parsing=!0,this.plugins={},this.responsive=!0,this.scale=void 0,this.scales={},this.showLine=!0,this.drawActiveElementsOnTop=!0,this.describe(t),this.apply(e)}set(t,e){return ce(this,t,e)}get(t){return he(this,t)}describe(t,e){return ce(le,t,e)}override(t,e){return ce(re,t,e)}route(t,e,i,s){const n=he(this,t),a=he(this,i),r="_"+e;Object.defineProperties(n,{[r]:{value:n[e],writable:!0},[e]:{enumerable:!0,get(){const t=this[r],e=a[s];return o(t)?Object.assign({},e,t):l(t,e)},set(t){this[r]=t}}})}apply(t){t.forEach((t=>t(this)))}}var ue=new de({_scriptable:t=>!t.startsWith("on"),_indexable:t=>"events"!==t,hover:{_fallback:"interaction"},interaction:{_scriptable:!1,_indexable:!1}},[function(t){t.set("animation",{delay:void 0,duration:1e3,easing:"easeOutQuart",fn:void 0,from:void 0,loop:void 0,to:void 0,type:void 0}),t.describe("animation",{_fallback:!1,_indexable:!1,_scriptable:t=>"onProgress"!==t&&"onComplete"!==t&&"fn"!==t}),t.set("animations",{colors:{type:"color",properties:ie},numbers:{type:"number",properties:ee}}),t.describe("animations",{_fallback:"animation"}),t.set("transitions",{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:"transparent"},visible:{type:"boolean",duration:0}}},hide:{animations:{colors:{to:"transparent"},visible:{type:"boolean",easing:"linear",fn:t=>0|t}}}})},function(t){t.set("layout",{autoPadding:!0,padding:{top:0,right:0,bottom:0,left:0}})},function(t){t.set("scale",{display:!0,offset:!1,reverse:!1,beginAtZero:!1,bounds:"ticks",clip:!0,grace:0,grid:{display:!0,lineWidth:1,drawOnChartArea:!0,drawTicks:!0,tickLength:8,tickWidth:(t,e)=>e.lineWidth,tickColor:(t,e)=>e.color,offset:!1},border:{display:!0,dash:[],dashOffset:0,width:1},title:{display:!1,text:"",padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:!1,textStrokeWidth:0,textStrokeColor:"",padding:3,display:!0,autoSkip:!0,autoSkipPadding:3,labelOffset:0,callback:ae.formatters.values,minor:{},major:{},align:"center",crossAlign:"near",showLabelBackdrop:!1,backdropColor:"rgba(255, 255, 255, 0.75)",backdropPadding:2}}),t.route("scale.ticks","color","","color"),t.route("scale.grid","color","","borderColor"),t.route("scale.border","color","","borderColor"),t.route("scale.title","color","","color"),t.describe("scale",{_fallback:!1,_scriptable:t=>!t.startsWith("before")&&!t.startsWith("after")&&"callback"!==t&&"parser"!==t,_indexable:t=>"borderDash"!==t&&"tickBorderDash"!==t&&"dash"!==t}),t.describe("scales",{_fallback:"scale"}),t.describe("scale.ticks",{_scriptable:t=>"backdropPadding"!==t&&"callback"!==t,_indexable:t=>"backdropPadding"!==t})}]);function fe(){return"undefined"!=typeof window&&"undefined"!=typeof document}function ge(t){let e=t.parentNode;return e&&"[object ShadowRoot]"===e.toString()&&(e=e.host),e}function pe(t,e,i){let s;return"string"==typeof t?(s=parseInt(t,10),-1!==t.indexOf("%")&&(s=s/100*e.parentNode[i])):s=t,s}const me=t=>t.ownerDocument.defaultView.getComputedStyle(t,null);function xe(t,e){return me(t).getPropertyValue(e)}const be=["top","right","bottom","left"];function _e(t,e,i){const s={};i=i?"-"+i:"";for(let n=0;n<4;n++){const o=be[n];s[o]=parseFloat(t[e+"-"+o+i])||0}return s.width=s.left+s.right,s.height=s.top+s.bottom,s}const ye=(t,e,i)=>(t>0||e>0)&&(!i||!i.shadowRoot);function ve(t,e){if("native"in t)return t;const{canvas:i,currentDevicePixelRatio:s}=e,n=me(i),o="border-box"===n.boxSizing,a=_e(n,"padding"),r=_e(n,"border","width"),{x:l,y:h,box:c}=function(t,e){const i=t.touches,s=i&&i.length?i[0]:t,{offsetX:n,offsetY:o}=s;let a,r,l=!1;if(ye(n,o,t.target))a=n,r=o;else{const t=e.getBoundingClientRect();a=s.clientX-t.left,r=s.clientY-t.top,l=!0}return{x:a,y:r,box:l}}(t,i),d=a.left+(c&&r.left),u=a.top+(c&&r.top);let{width:f,height:g}=e;return o&&(f-=a.width+r.width,g-=a.height+r.height),{x:Math.round((l-d)/f*i.width/s),y:Math.round((h-u)/g*i.height/s)}}const Me=t=>Math.round(10*t)/10;function we(t,e,i,s){const n=me(t),o=_e(n,"margin"),a=pe(n.maxWidth,t,"clientWidth")||T,r=pe(n.maxHeight,t,"clientHeight")||T,l=function(t,e,i){let s,n;if(void 0===e||void 0===i){const o=t&&ge(t);if(o){const t=o.getBoundingClientRect(),a=me(o),r=_e(a,"border","width"),l=_e(a,"padding");e=t.width-l.width-r.width,i=t.height-l.height-r.height,s=pe(a.maxWidth,o,"clientWidth"),n=pe(a.maxHeight,o,"clientHeight")}else e=t.clientWidth,i=t.clientHeight}return{width:e,height:i,maxWidth:s||T,maxHeight:n||T}}(t,e,i);let{width:h,height:c}=l;if("content-box"===n.boxSizing){const t=_e(n,"border","width"),e=_e(n,"padding");h-=e.width+t.width,c-=e.height+t.height}h=Math.max(0,h-o.width),c=Math.max(0,s?h/s:c-o.height),h=Me(Math.min(h,a,l.maxWidth)),c=Me(Math.min(c,r,l.maxHeight)),h&&!c&&(c=Me(h/2));return(void 0!==e||void 0!==i)&&s&&l.height&&c>l.height&&(c=l.height,h=Me(Math.floor(c*s))),{width:h,height:c}}function ke(t,e,i){const s=e||1,n=Me(t.height*s),o=Me(t.width*s);t.height=Me(t.height),t.width=Me(t.width);const a=t.canvas;return a.style&&(i||!a.style.height&&!a.style.width)&&(a.style.height=`${t.height}px`,a.style.width=`${t.width}px`),(t.currentDevicePixelRatio!==s||a.height!==n||a.width!==o)&&(t.currentDevicePixelRatio=s,a.height=n,a.width=o,t.ctx.setTransform(s,0,0,s,0,0),!0)}const Se=function(){let t=!1;try{const e={get passive(){return t=!0,!1}};fe()&&(window.addEventListener("test",null,e),window.removeEventListener("test",null,e))}catch(t){}return t}();function Pe(t,e){const i=xe(t,e),s=i&&i.match(/^(\d+)(\.\d+)?px$/);return s?+s[1]:void 0}function De(t){return!t||s(t.size)||s(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}function Ce(t,e,i,s,n){let o=e[n];return o||(o=e[n]=t.measureText(n).width,i.push(n)),o>s&&(s=o),s}function Oe(t,e,i,s){let o=(s=s||{}).data=s.data||{},a=s.garbageCollect=s.garbageCollect||[];s.font!==e&&(o=s.data={},a=s.garbageCollect=[],s.font=e),t.save(),t.font=e;let r=0;const l=i.length;let h,c,d,u,f;for(h=0;h<l;h++)if(u=i[h],null==u||n(u)){if(n(u))for(c=0,d=u.length;c<d;c++)f=u[c],null==f||n(f)||(r=Ce(t,o,a,r,f))}else r=Ce(t,o,a,r,u);t.restore();const g=a.length/2;if(g>i.length){for(h=0;h<g;h++)delete o[a[h]];a.splice(0,g)}return r}function Ae(t,e,i){const s=t.currentDevicePixelRatio,n=0!==i?Math.max(i/2,.5):0;return Math.round((e-n)*s)/s+n}function Te(t,e){(e||t)&&((e=e||t.getContext("2d")).save(),e.resetTransform(),e.clearRect(0,0,t.width,t.height),e.restore())}function Le(t,e,i,s){Ee(t,e,i,s,null)}function Ee(t,e,i,s,n){let o,a,r,l,h,c,d,u;const f=e.pointStyle,g=e.rotation,p=e.radius;let m=(g||0)*L;if(f&&"object"==typeof f&&(o=f.toString(),"[object HTMLImageElement]"===o||"[object HTMLCanvasElement]"===o))return t.save(),t.translate(i,s),t.rotate(m),t.drawImage(f,-f.width/2,-f.height/2,f.width,f.height),void t.restore();if(!(isNaN(p)||p<=0)){switch(t.beginPath(),f){default:n?t.ellipse(i,s,n/2,p,0,0,O):t.arc(i,s,p,0,O),t.closePath();break;case"triangle":c=n?n/2:p,t.moveTo(i+Math.sin(m)*c,s-Math.cos(m)*p),m+=I,t.lineTo(i+Math.sin(m)*c,s-Math.cos(m)*p),m+=I,t.lineTo(i+Math.sin(m)*c,s-Math.cos(m)*p),t.closePath();break;case"rectRounded":h=.516*p,l=p-h,a=Math.cos(m+R)*l,d=Math.cos(m+R)*(n?n/2-h:l),r=Math.sin(m+R)*l,u=Math.sin(m+R)*(n?n/2-h:l),t.arc(i-d,s-r,h,m-C,m-E),t.arc(i+u,s-a,h,m-E,m),t.arc(i+d,s+r,h,m,m+E),t.arc(i-u,s+a,h,m+E,m+C),t.closePath();break;case"rect":if(!g){l=Math.SQRT1_2*p,c=n?n/2:l,t.rect(i-c,s-l,2*c,2*l);break}m+=R;case"rectRot":d=Math.cos(m)*(n?n/2:p),a=Math.cos(m)*p,r=Math.sin(m)*p,u=Math.sin(m)*(n?n/2:p),t.moveTo(i-d,s-r),t.lineTo(i+u,s-a),t.lineTo(i+d,s+r),t.lineTo(i-u,s+a),t.closePath();break;case"crossRot":m+=R;case"cross":d=Math.cos(m)*(n?n/2:p),a=Math.cos(m)*p,r=Math.sin(m)*p,u=Math.sin(m)*(n?n/2:p),t.moveTo(i-d,s-r),t.lineTo(i+d,s+r),t.moveTo(i+u,s-a),t.lineTo(i-u,s+a);break;case"star":d=Math.cos(m)*(n?n/2:p),a=Math.cos(m)*p,r=Math.sin(m)*p,u=Math.sin(m)*(n?n/2:p),t.moveTo(i-d,s-r),t.lineTo(i+d,s+r),t.moveTo(i+u,s-a),t.lineTo(i-u,s+a),m+=R,d=Math.cos(m)*(n?n/2:p),a=Math.cos(m)*p,r=Math.sin(m)*p,u=Math.sin(m)*(n?n/2:p),t.moveTo(i-d,s-r),t.lineTo(i+d,s+r),t.moveTo(i+u,s-a),t.lineTo(i-u,s+a);break;case"line":a=n?n/2:Math.cos(m)*p,r=Math.sin(m)*p,t.moveTo(i-a,s-r),t.lineTo(i+a,s+r);break;case"dash":t.moveTo(i,s),t.lineTo(i+Math.cos(m)*(n?n/2:p),s+Math.sin(m)*p);break;case!1:t.closePath()}t.fill(),e.borderWidth>0&&t.stroke()}}function Re(t,e,i){return i=i||.5,!e||t&&t.x>e.left-i&&t.x<e.right+i&&t.y>e.top-i&&t.y<e.bottom+i}function Ie(t,e){t.save(),t.beginPath(),t.rect(e.left,e.top,e.right-e.left,e.bottom-e.top),t.clip()}function ze(t){t.restore()}function Fe(t,e,i,s,n){if(!e)return t.lineTo(i.x,i.y);if("middle"===n){const s=(e.x+i.x)/2;t.lineTo(s,e.y),t.lineTo(s,i.y)}else"after"===n!=!!s?t.lineTo(e.x,i.y):t.lineTo(i.x,e.y);t.lineTo(i.x,i.y)}function Ve(t,e,i,s){if(!e)return t.lineTo(i.x,i.y);t.bezierCurveTo(s?e.cp1x:e.cp2x,s?e.cp1y:e.cp2y,s?i.cp2x:i.cp1x,s?i.cp2y:i.cp1y,i.x,i.y)}function Be(t,e,i,s,n){if(n.strikethrough||n.underline){const o=t.measureText(s),a=e-o.actualBoundingBoxLeft,r=e+o.actualBoundingBoxRight,l=i-o.actualBoundingBoxAscent,h=i+o.actualBoundingBoxDescent,c=n.strikethrough?(l+h)/2:h;t.strokeStyle=t.fillStyle,t.beginPath(),t.lineWidth=n.decorationWidth||2,t.moveTo(a,c),t.lineTo(r,c),t.stroke()}}function We(t,e){const i=t.fillStyle;t.fillStyle=e.color,t.fillRect(e.left,e.top,e.width,e.height),t.fillStyle=i}function Ne(t,e,i,o,a,r={}){const l=n(e)?e:[e],h=r.strokeWidth>0&&""!==r.strokeColor;let c,d;for(t.save(),t.font=a.string,function(t,e){e.translation&&t.translate(e.translation[0],e.translation[1]),s(e.rotation)||t.rotate(e.rotation),e.color&&(t.fillStyle=e.color),e.textAlign&&(t.textAlign=e.textAlign),e.textBaseline&&(t.textBaseline=e.textBaseline)}(t,r),c=0;c<l.length;++c)d=l[c],r.backdrop&&We(t,r.backdrop),h&&(r.strokeColor&&(t.strokeStyle=r.strokeColor),s(r.strokeWidth)||(t.lineWidth=r.strokeWidth),t.strokeText(d,i,o,r.maxWidth)),t.fillText(d,i,o,r.maxWidth),Be(t,i,o,d,r),o+=Number(a.lineHeight);t.restore()}function He(t,e){const{x:i,y:s,w:n,h:o,radius:a}=e;t.arc(i+a.topLeft,s+a.topLeft,a.topLeft,1.5*C,C,!0),t.lineTo(i,s+o-a.bottomLeft),t.arc(i+a.bottomLeft,s+o-a.bottomLeft,a.bottomLeft,C,E,!0),t.lineTo(i+n-a.bottomRight,s+o),t.arc(i+n-a.bottomRight,s+o-a.bottomRight,a.bottomRight,E,0,!0),t.lineTo(i+n,s+a.topRight),t.arc(i+n-a.topRight,s+a.topRight,a.topRight,0,-E,!0),t.lineTo(i+a.topLeft,s)}function je(t,e=[""],i,s,n=(()=>t[0])){const o=i||t;void 0===s&&(s=ti("_fallback",t));const a={[Symbol.toStringTag]:"Object",_cacheable:!0,_scopes:t,_rootScopes:o,_fallback:s,_getTarget:n,override:i=>je([i,...t],e,o,s)};return new Proxy(a,{deleteProperty:(e,i)=>(delete e[i],delete e._keys,delete t[0][i],!0),get:(i,s)=>qe(i,s,(()=>function(t,e,i,s){let n;for(const o of e)if(n=ti(Ue(o,t),i),void 0!==n)return Xe(t,n)?Ze(i,s,t,n):n}(s,e,t,i))),getOwnPropertyDescriptor:(t,e)=>Reflect.getOwnPropertyDescriptor(t._scopes[0],e),getPrototypeOf:()=>Reflect.getPrototypeOf(t[0]),has:(t,e)=>ei(t).includes(e),ownKeys:t=>ei(t),set(t,e,i){const s=t._storage||(t._storage=n());return t[e]=s[e]=i,delete t._keys,!0}})}function $e(t,e,i,s){const a={_cacheable:!1,_proxy:t,_context:e,_subProxy:i,_stack:new Set,_descriptors:Ye(t,s),setContext:e=>$e(t,e,i,s),override:n=>$e(t.override(n),e,i,s)};return new Proxy(a,{deleteProperty:(e,i)=>(delete e[i],delete t[i],!0),get:(t,e,i)=>qe(t,e,(()=>function(t,e,i){const{_proxy:s,_context:a,_subProxy:r,_descriptors:l}=t;let h=s[e];S(h)&&l.isScriptable(e)&&(h=function(t,e,i,s){const{_proxy:n,_context:o,_subProxy:a,_stack:r}=i;if(r.has(t))throw new Error("Recursion detected: "+Array.from(r).join("->")+"->"+t);r.add(t);let l=e(o,a||s);r.delete(t),Xe(t,l)&&(l=Ze(n._scopes,n,t,l));return l}(e,h,t,i));n(h)&&h.length&&(h=function(t,e,i,s){const{_proxy:n,_context:a,_subProxy:r,_descriptors:l}=i;if(void 0!==a.index&&s(t))return e[a.index%e.length];if(o(e[0])){const i=e,s=n._scopes.filter((t=>t!==i));e=[];for(const o of i){const i=Ze(s,n,t,o);e.push($e(i,a,r&&r[t],l))}}return e}(e,h,t,l.isIndexable));Xe(e,h)&&(h=$e(h,a,r&&r[e],l));return h}(t,e,i))),getOwnPropertyDescriptor:(e,i)=>e._descriptors.allKeys?Reflect.has(t,i)?{enumerable:!0,configurable:!0}:void 0:Reflect.getOwnPropertyDescriptor(t,i),getPrototypeOf:()=>Reflect.getPrototypeOf(t),has:(e,i)=>Reflect.has(t,i),ownKeys:()=>Reflect.ownKeys(t),set:(e,i,s)=>(t[i]=s,delete e[i],!0)})}function Ye(t,e={scriptable:!0,indexable:!0}){const{_scriptable:i=e.scriptable,_indexable:s=e.indexable,_allKeys:n=e.allKeys}=t;return{allKeys:n,scriptable:i,indexable:s,isScriptable:S(i)?i:()=>i,isIndexable:S(s)?s:()=>s}}const Ue=(t,e)=>t?t+w(e):e,Xe=(t,e)=>o(e)&&"adapters"!==t&&(null===Object.getPrototypeOf(e)||e.constructor===Object);function qe(t,e,i){if(Object.prototype.hasOwnProperty.call(t,e)||"constructor"===e)return t[e];const s=i();return t[e]=s,s}function Ke(t,e,i){return S(t)?t(e,i):t}const Ge=(t,e)=>!0===t?e:"string"==typeof t?M(e,t):void 0;function Je(t,e,i,s,n){for(const o of e){const e=Ge(i,o);if(e){t.add(e);const o=Ke(e._fallback,i,n);if(void 0!==o&&o!==i&&o!==s)return o}else if(!1===e&&void 0!==s&&i!==s)return null}return!1}function Ze(t,e,i,s){const a=e._rootScopes,r=Ke(e._fallback,i,s),l=[...t,...a],h=new Set;h.add(s);let c=Qe(h,l,i,r||i,s);return null!==c&&((void 0===r||r===i||(c=Qe(h,l,r,c,s),null!==c))&&je(Array.from(h),[""],a,r,(()=>function(t,e,i){const s=t._getTarget();e in s||(s[e]={});const a=s[e];if(n(a)&&o(i))return i;return a||{}}(e,i,s))))}function Qe(t,e,i,s,n){for(;i;)i=Je(t,e,i,s,n);return i}function ti(t,e){for(const i of e){if(!i)continue;const e=i[t];if(void 0!==e)return e}}function ei(t){let e=t._keys;return e||(e=t._keys=function(t){const e=new Set;for(const i of t)for(const t of Object.keys(i).filter((t=>!t.startsWith("_"))))e.add(t);return Array.from(e)}(t._scopes)),e}function ii(t,e,i,s){const{iScale:n}=t,{key:o="r"}=this._parsing,a=new Array(s);let r,l,h,c;for(r=0,l=s;r<l;++r)h=r+i,c=e[h],a[r]={r:n.parse(M(c,o),h)};return a}const si=Number.EPSILON||1e-14,ni=(t,e)=>e<t.length&&!t[e].skip&&t[e],oi=t=>"x"===t?"y":"x";function ai(t,e,i,s){const n=t.skip?e:t,o=e,a=i.skip?e:i,r=q(o,n),l=q(a,o);let h=r/(r+l),c=l/(r+l);h=isNaN(h)?0:h,c=isNaN(c)?0:c;const d=s*h,u=s*c;return{previous:{x:o.x-d*(a.x-n.x),y:o.y-d*(a.y-n.y)},next:{x:o.x+u*(a.x-n.x),y:o.y+u*(a.y-n.y)}}}function ri(t,e="x"){const i=oi(e),s=t.length,n=Array(s).fill(0),o=Array(s);let a,r,l,h=ni(t,0);for(a=0;a<s;++a)if(r=l,l=h,h=ni(t,a+1),l){if(h){const t=h[e]-l[e];n[a]=0!==t?(h[i]-l[i])/t:0}o[a]=r?h?F(n[a-1])!==F(n[a])?0:(n[a-1]+n[a])/2:n[a-1]:n[a]}!function(t,e,i){const s=t.length;let n,o,a,r,l,h=ni(t,0);for(let c=0;c<s-1;++c)l=h,h=ni(t,c+1),l&&h&&(V(e[c],0,si)?i[c]=i[c+1]=0:(n=i[c]/e[c],o=i[c+1]/e[c],r=Math.pow(n,2)+Math.pow(o,2),r<=9||(a=3/Math.sqrt(r),i[c]=n*a*e[c],i[c+1]=o*a*e[c])))}(t,n,o),function(t,e,i="x"){const s=oi(i),n=t.length;let o,a,r,l=ni(t,0);for(let h=0;h<n;++h){if(a=r,r=l,l=ni(t,h+1),!r)continue;const n=r[i],c=r[s];a&&(o=(n-a[i])/3,r[`cp1${i}`]=n-o,r[`cp1${s}`]=c-o*e[h]),l&&(o=(l[i]-n)/3,r[`cp2${i}`]=n+o,r[`cp2${s}`]=c+o*e[h])}}(t,o,e)}function li(t,e,i){return Math.max(Math.min(t,i),e)}function hi(t,e,i,s,n){let o,a,r,l;if(e.spanGaps&&(t=t.filter((t=>!t.skip))),"monotone"===e.cubicInterpolationMode)ri(t,n);else{let i=s?t[t.length-1]:t[0];for(o=0,a=t.length;o<a;++o)r=t[o],l=ai(i,r,t[Math.min(o+1,a-(s?0:1))%a],e.tension),r.cp1x=l.previous.x,r.cp1y=l.previous.y,r.cp2x=l.next.x,r.cp2y=l.next.y,i=r}e.capBezierPoints&&function(t,e){let i,s,n,o,a,r=Re(t[0],e);for(i=0,s=t.length;i<s;++i)a=o,o=r,r=i<s-1&&Re(t[i+1],e),o&&(n=t[i],a&&(n.cp1x=li(n.cp1x,e.left,e.right),n.cp1y=li(n.cp1y,e.top,e.bottom)),r&&(n.cp2x=li(n.cp2x,e.left,e.right),n.cp2y=li(n.cp2y,e.top,e.bottom)))}(t,i)}const ci=t=>0===t||1===t,di=(t,e,i)=>-Math.pow(2,10*(t-=1))*Math.sin((t-e)*O/i),ui=(t,e,i)=>Math.pow(2,-10*t)*Math.sin((t-e)*O/i)+1,fi={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>-t*(t-2),easeInOutQuad:t=>(t/=.5)<1?.5*t*t:-.5*(--t*(t-2)-1),easeInCubic:t=>t*t*t,easeOutCubic:t=>(t-=1)*t*t+1,easeInOutCubic:t=>(t/=.5)<1?.5*t*t*t:.5*((t-=2)*t*t+2),easeInQuart:t=>t*t*t*t,easeOutQuart:t=>-((t-=1)*t*t*t-1),easeInOutQuart:t=>(t/=.5)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2),easeInQuint:t=>t*t*t*t*t,easeOutQuint:t=>(t-=1)*t*t*t*t+1,easeInOutQuint:t=>(t/=.5)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2),easeInSine:t=>1-Math.cos(t*E),easeOutSine:t=>Math.sin(t*E),easeInOutSine:t=>-.5*(Math.cos(C*t)-1),easeInExpo:t=>0===t?0:Math.pow(2,10*(t-1)),easeOutExpo:t=>1===t?1:1-Math.pow(2,-10*t),easeInOutExpo:t=>ci(t)?t:t<.5?.5*Math.pow(2,10*(2*t-1)):.5*(2-Math.pow(2,-10*(2*t-1))),easeInCirc:t=>t>=1?t:-(Math.sqrt(1-t*t)-1),easeOutCirc:t=>Math.sqrt(1-(t-=1)*t),easeInOutCirc:t=>(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1),easeInElastic:t=>ci(t)?t:di(t,.075,.3),easeOutElastic:t=>ci(t)?t:ui(t,.075,.3),easeInOutElastic(t){const e=.1125;return ci(t)?t:t<.5?.5*di(2*t,e,.45):.5+.5*ui(2*t-1,e,.45)},easeInBack(t){const e=1.70158;return t*t*((e+1)*t-e)},easeOutBack(t){const e=1.70158;return(t-=1)*t*((e+1)*t+e)+1},easeInOutBack(t){let e=1.70158;return(t/=.5)<1?t*t*((1+(e*=1.525))*t-e)*.5:.5*((t-=2)*t*((1+(e*=1.525))*t+e)+2)},easeInBounce:t=>1-fi.easeOutBounce(1-t),easeOutBounce(t){const e=7.5625,i=2.75;return t<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375},easeInOutBounce:t=>t<.5?.5*fi.easeInBounce(2*t):.5*fi.easeOutBounce(2*t-1)+.5};function gi(t,e,i,s){return{x:t.x+i*(e.x-t.x),y:t.y+i*(e.y-t.y)}}function pi(t,e,i,s){return{x:t.x+i*(e.x-t.x),y:"middle"===s?i<.5?t.y:e.y:"after"===s?i<1?t.y:e.y:i>0?e.y:t.y}}function mi(t,e,i,s){const n={x:t.cp2x,y:t.cp2y},o={x:e.cp1x,y:e.cp1y},a=gi(t,n,i),r=gi(n,o,i),l=gi(o,e,i),h=gi(a,r,i),c=gi(r,l,i);return gi(h,c,i)}const xi=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/,bi=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/;function _i(t,e){const i=(""+t).match(xi);if(!i||"normal"===i[1])return 1.2*e;switch(t=+i[2],i[3]){case"px":return t;case"%":t/=100}return e*t}const yi=t=>+t||0;function vi(t,e){const i={},s=o(e),n=s?Object.keys(e):e,a=o(t)?s?i=>l(t[i],t[e[i]]):e=>t[e]:()=>t;for(const t of n)i[t]=yi(a(t));return i}function Mi(t){return vi(t,{top:"y",right:"x",bottom:"y",left:"x"})}function wi(t){return vi(t,["topLeft","topRight","bottomLeft","bottomRight"])}function ki(t){const e=Mi(t);return e.width=e.left+e.right,e.height=e.top+e.bottom,e}function Si(t,e){t=t||{},e=e||ue.font;let i=l(t.size,e.size);"string"==typeof i&&(i=parseInt(i,10));let s=l(t.style,e.style);s&&!(""+s).match(bi)&&(console.warn('Invalid font style specified: "'+s+'"'),s=void 0);const n={family:l(t.family,e.family),lineHeight:_i(l(t.lineHeight,e.lineHeight),i),size:i,style:s,weight:l(t.weight,e.weight),string:""};return n.string=De(n),n}function Pi(t,e,i,s){let o,a,r,l=!0;for(o=0,a=t.length;o<a;++o)if(r=t[o],void 0!==r&&(void 0!==e&&"function"==typeof r&&(r=r(e),l=!1),void 0!==i&&n(r)&&(r=r[i%r.length],l=!1),void 0!==r))return s&&!l&&(s.cacheable=!1),r}function Di(t,e,i){const{min:s,max:n}=t,o=c(e,(n-s)/2),a=(t,e)=>i&&0===t?0:t+e;return{min:a(s,-Math.abs(o)),max:a(n,o)}}function Ci(t,e){return Object.assign(Object.create(t),e)}function Oi(t,e,i){return t?function(t,e){return{x:i=>t+t+e-i,setWidth(t){e=t},textAlign:t=>"center"===t?t:"right"===t?"left":"right",xPlus:(t,e)=>t-e,leftForLtr:(t,e)=>t-e}}(e,i):{x:t=>t,setWidth(t){},textAlign:t=>t,xPlus:(t,e)=>t+e,leftForLtr:(t,e)=>t}}function Ai(t,e){let i,s;"ltr"!==e&&"rtl"!==e||(i=t.canvas.style,s=[i.getPropertyValue("direction"),i.getPropertyPriority("direction")],i.setProperty("direction",e,"important"),t.prevTextDirection=s)}function Ti(t,e){void 0!==e&&(delete t.prevTextDirection,t.canvas.style.setProperty("direction",e[0],e[1]))}function Li(t){return"angle"===t?{between:J,compare:K,normalize:G}:{between:tt,compare:(t,e)=>t-e,normalize:t=>t}}function Ei({start:t,end:e,count:i,loop:s,style:n}){return{start:t%i,end:e%i,loop:s&&(e-t+1)%i==0,style:n}}function Ri(t,e,i){if(!i)return[t];const{property:s,start:n,end:o}=i,a=e.length,{compare:r,between:l,normalize:h}=Li(s),{start:c,end:d,loop:u,style:f}=function(t,e,i){const{property:s,start:n,end:o}=i,{between:a,normalize:r}=Li(s),l=e.length;let h,c,{start:d,end:u,loop:f}=t;if(f){for(d+=l,u+=l,h=0,c=l;h<c&&a(r(e[d%l][s]),n,o);++h)d--,u--;d%=l,u%=l}return u<d&&(u+=l),{start:d,end:u,loop:f,style:t.style}}(t,e,i),g=[];let p,m,x,b=!1,_=null;const y=()=>b||l(n,x,p)&&0!==r(n,x),v=()=>!b||0===r(o,p)||l(o,x,p);for(let t=c,i=c;t<=d;++t)m=e[t%a],m.skip||(p=h(m[s]),p!==x&&(b=l(p,n,o),null===_&&y()&&(_=0===r(p,n)?t:i),null!==_&&v()&&(g.push(Ei({start:_,end:t,loop:u,count:a,style:f})),_=null),i=t,x=p));return null!==_&&g.push(Ei({start:_,end:d,loop:u,count:a,style:f})),g}function Ii(t,e){const i=[],s=t.segments;for(let n=0;n<s.length;n++){const o=Ri(s[n],t.points,e);o.length&&i.push(...o)}return i}function zi(t,e){const i=t.points,s=t.options.spanGaps,n=i.length;if(!n)return[];const o=!!t._loop,{start:a,end:r}=function(t,e,i,s){let n=0,o=e-1;if(i&&!s)for(;n<e&&!t[n].skip;)n++;for(;n<e&&t[n].skip;)n++;for(n%=e,i&&(o+=n);o>n&&t[o%e].skip;)o--;return o%=e,{start:n,end:o}}(i,n,o,s);if(!0===s)return Fi(t,[{start:a,end:r,loop:o}],i,e);return Fi(t,function(t,e,i,s){const n=t.length,o=[];let a,r=e,l=t[e];for(a=e+1;a<=i;++a){const i=t[a%n];i.skip||i.stop?l.skip||(s=!1,o.push({start:e%n,end:(a-1)%n,loop:s}),e=r=i.stop?a:null):(r=a,l.skip&&(e=a)),l=i}return null!==r&&o.push({start:e%n,end:r%n,loop:s}),o}(i,a,r<a?r+n:r,!!t._fullLoop&&0===a&&r===n-1),i,e)}function Fi(t,e,i,s){return s&&s.setContext&&i?function(t,e,i,s){const n=t._chart.getContext(),o=Vi(t.options),{_datasetIndex:a,options:{spanGaps:r}}=t,l=i.length,h=[];let c=o,d=e[0].start,u=d;function f(t,e,s,n){const o=r?-1:1;if(t!==e){for(t+=l;i[t%l].skip;)t-=o;for(;i[e%l].skip;)e+=o;t%l!=e%l&&(h.push({start:t%l,end:e%l,loop:s,style:n}),c=n,d=e%l)}}for(const t of e){d=r?d:t.start;let e,o=i[d%l];for(u=d+1;u<=t.end;u++){const r=i[u%l];e=Vi(s.setContext(Ci(n,{type:"segment",p0:o,p1:r,p0DataIndex:(u-1)%l,p1DataIndex:u%l,datasetIndex:a}))),Bi(e,c)&&f(d,u-1,t.loop,c),o=r,c=e}d<u-1&&f(d,u-1,t.loop,c)}return h}(t,e,i,s):e}function Vi(t){return{backgroundColor:t.backgroundColor,borderCapStyle:t.borderCapStyle,borderDash:t.borderDash,borderDashOffset:t.borderDashOffset,borderJoinStyle:t.borderJoinStyle,borderWidth:t.borderWidth,borderColor:t.borderColor}}function Bi(t,e){if(!e)return!1;const i=[],s=function(t,e){return Zt(e)?(i.includes(e)||i.push(e),i.indexOf(e)):e};return JSON.stringify(t,s)!==JSON.stringify(e,s)}function Wi(t,e,i){return t.options.clip?t[i]:e[i]}function Ni(t,e){const i=e._clip;if(i.disabled)return!1;const s=function(t,e){const{xScale:i,yScale:s}=t;return i&&s?{left:Wi(i,e,"left"),right:Wi(i,e,"right"),top:Wi(s,e,"top"),bottom:Wi(s,e,"bottom")}:e}(e,t.chartArea);return{left:!1===i.left?0:s.left-(!0===i.left?0:i.left),right:!1===i.right?t.width:s.right+(!0===i.right?0:i.right),top:!1===i.top?0:s.top-(!0===i.top?0:i.top),bottom:!1===i.bottom?t.height:s.bottom+(!0===i.bottom?0:i.bottom)}}var Hi=Object.freeze({__proto__:null,HALF_PI:E,INFINITY:T,PI:C,PITAU:A,QUARTER_PI:R,RAD_PER_DEG:L,TAU:O,TWO_THIRDS_PI:I,_addGrace:Di,_alignPixel:Ae,_alignStartEnd:ft,_angleBetween:J,_angleDiff:K,_arrayUnique:lt,_attachContext:$e,_bezierCurveTo:Ve,_bezierInterpolation:mi,_boundSegment:Ri,_boundSegments:Ii,_capitalize:w,_computeSegments:zi,_createResolver:je,_decimalPlaces:U,_deprecated:function(t,e,i,s){void 0!==e&&console.warn(t+': "'+i+'" is deprecated. Please use "'+s+'" instead')},_descriptors:Ye,_elementsEqual:f,_factorize:W,_filterBetween:nt,_getParentNode:ge,_getStartAndCountOfVisiblePoints:pt,_int16Range:Q,_isBetween:tt,_isClickEvent:D,_isDomSupported:fe,_isPointInArea:Re,_limitValue:Z,_longestText:Oe,_lookup:et,_lookupByKey:it,_measureText:Ce,_merger:m,_mergerIf:_,_normalizeAngle:G,_parseObjectDataRadialScale:ii,_pointInLine:gi,_readValueToProps:vi,_rlookupByKey:st,_scaleRangesChanged:mt,_setMinAndMaxByKey:j,_splitKey:v,_steppedInterpolation:pi,_steppedLineTo:Fe,_textX:gt,_toLeftRightCenter:ut,_updateBezierControlPoints:hi,addRoundedRectPath:He,almostEquals:V,almostWhole:H,callback:d,clearCanvas:Te,clipArea:Ie,clone:g,color:Qt,createContext:Ci,debounce:dt,defined:k,distanceBetweenPoints:q,drawPoint:Le,drawPointLegend:Ee,each:u,easingEffects:fi,finiteOrDefault:r,fontString:function(t,e,i){return e+" "+t+"px "+i},formatNumber:ne,getAngleFromPoint:X,getDatasetClipArea:Ni,getHoverColor:te,getMaximumSize:we,getRelativePosition:ve,getRtlAdapter:Oi,getStyle:xe,isArray:n,isFinite:a,isFunction:S,isNullOrUndef:s,isNumber:N,isObject:o,isPatternOrGradient:Zt,listenArrayEvents:at,log10:z,merge:x,mergeIf:b,niceNum:B,noop:e,overrideTextDirection:Ai,readUsedSize:Pe,renderText:Ne,requestAnimFrame:ht,resolve:Pi,resolveObjectKey:M,restoreTextDirection:Ti,retinaScale:ke,setsEqual:P,sign:F,splineCurve:ai,splineCurveMonotone:ri,supportsEventListenerOptions:Se,throttled:ct,toDegrees:Y,toDimension:c,toFont:Si,toFontString:De,toLineHeight:_i,toPadding:ki,toPercentage:h,toRadians:$,toTRBL:Mi,toTRBLCorners:wi,uid:i,unclipArea:ze,unlistenArrayEvents:rt,valueOrDefault:l});function ji(t,e,i,n){const{controller:o,data:a,_sorted:r}=t,l=o._cachedMeta.iScale,h=t.dataset&&t.dataset.options?t.dataset.options.spanGaps:null;if(l&&e===l.axis&&"r"!==e&&r&&a.length){const r=l._reversePixels?st:it;if(!n){const n=r(a,e,i);if(h){const{vScale:e}=o._cachedMeta,{_parsed:i}=t,a=i.slice(0,n.lo+1).reverse().findIndex((t=>!s(t[e.axis])));n.lo-=Math.max(0,a);const r=i.slice(n.hi).findIndex((t=>!s(t[e.axis])));n.hi+=Math.max(0,r)}return n}if(o._sharedOptions){const t=a[0],s="function"==typeof t.getRange&&t.getRange(e);if(s){const t=r(a,e,i-s),n=r(a,e,i+s);return{lo:t.lo,hi:n.hi}}}}return{lo:0,hi:a.length-1}}function $i(t,e,i,s,n){const o=t.getSortedVisibleDatasetMetas(),a=i[e];for(let t=0,i=o.length;t<i;++t){const{index:i,data:r}=o[t],{lo:l,hi:h}=ji(o[t],e,a,n);for(let t=l;t<=h;++t){const e=r[t];e.skip||s(e,i,t)}}}function Yi(t,e,i,s,n){const o=[];if(!n&&!t.isPointInArea(e))return o;return $i(t,i,e,(function(i,a,r){(n||Re(i,t.chartArea,0))&&i.inRange(e.x,e.y,s)&&o.push({element:i,datasetIndex:a,index:r})}),!0),o}function Ui(t,e,i,s,n,o){let a=[];const r=function(t){const e=-1!==t.indexOf("x"),i=-1!==t.indexOf("y");return function(t,s){const n=e?Math.abs(t.x-s.x):0,o=i?Math.abs(t.y-s.y):0;return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))}}(i);let l=Number.POSITIVE_INFINITY;return $i(t,i,e,(function(i,h,c){const d=i.inRange(e.x,e.y,n);if(s&&!d)return;const u=i.getCenterPoint(n);if(!(!!o||t.isPointInArea(u))&&!d)return;const f=r(e,u);f<l?(a=[{element:i,datasetIndex:h,index:c}],l=f):f===l&&a.push({element:i,datasetIndex:h,index:c})})),a}function Xi(t,e,i,s,n,o){return o||t.isPointInArea(e)?"r"!==i||s?Ui(t,e,i,s,n,o):function(t,e,i,s){let n=[];return $i(t,i,e,(function(t,i,o){const{startAngle:a,endAngle:r}=t.getProps(["startAngle","endAngle"],s),{angle:l}=X(t,{x:e.x,y:e.y});J(l,a,r)&&n.push({element:t,datasetIndex:i,index:o})})),n}(t,e,i,n):[]}function qi(t,e,i,s,n){const o=[],a="x"===i?"inXRange":"inYRange";let r=!1;return $i(t,i,e,((t,s,l)=>{t[a]&&t[a](e[i],n)&&(o.push({element:t,datasetIndex:s,index:l}),r=r||t.inRange(e.x,e.y,n))})),s&&!r?[]:o}var Ki={evaluateInteractionItems:$i,modes:{index(t,e,i,s){const n=ve(e,t),o=i.axis||"x",a=i.includeInvisible||!1,r=i.intersect?Yi(t,n,o,s,a):Xi(t,n,o,!1,s,a),l=[];return r.length?(t.getSortedVisibleDatasetMetas().forEach((t=>{const e=r[0].index,i=t.data[e];i&&!i.skip&&l.push({element:i,datasetIndex:t.index,index:e})})),l):[]},dataset(t,e,i,s){const n=ve(e,t),o=i.axis||"xy",a=i.includeInvisible||!1;let r=i.intersect?Yi(t,n,o,s,a):Xi(t,n,o,!1,s,a);if(r.length>0){const e=r[0].datasetIndex,i=t.getDatasetMeta(e).data;r=[];for(let t=0;t<i.length;++t)r.push({element:i[t],datasetIndex:e,index:t})}return r},point:(t,e,i,s)=>Yi(t,ve(e,t),i.axis||"xy",s,i.includeInvisible||!1),nearest(t,e,i,s){const n=ve(e,t),o=i.axis||"xy",a=i.includeInvisible||!1;return Xi(t,n,o,i.intersect,s,a)},x:(t,e,i,s)=>qi(t,ve(e,t),"x",i.intersect,s),y:(t,e,i,s)=>qi(t,ve(e,t),"y",i.intersect,s)}};const Gi=["left","top","right","bottom"];function Ji(t,e){return t.filter((t=>t.pos===e))}function Zi(t,e){return t.filter((t=>-1===Gi.indexOf(t.pos)&&t.box.axis===e))}function Qi(t,e){return t.sort(((t,i)=>{const s=e?i:t,n=e?t:i;return s.weight===n.weight?s.index-n.index:s.weight-n.weight}))}function ts(t,e){const i=function(t){const e={};for(const i of t){const{stack:t,pos:s,stackWeight:n}=i;if(!t||!Gi.includes(s))continue;const o=e[t]||(e[t]={count:0,placed:0,weight:0,size:0});o.count++,o.weight+=n}return e}(t),{vBoxMaxWidth:s,hBoxMaxHeight:n}=e;let o,a,r;for(o=0,a=t.length;o<a;++o){r=t[o];const{fullSize:a}=r.box,l=i[r.stack],h=l&&r.stackWeight/l.weight;r.horizontal?(r.width=h?h*s:a&&e.availableWidth,r.height=n):(r.width=s,r.height=h?h*n:a&&e.availableHeight)}return i}function es(t,e,i,s){return Math.max(t[i],e[i])+Math.max(t[s],e[s])}function is(t,e){t.top=Math.max(t.top,e.top),t.left=Math.max(t.left,e.left),t.bottom=Math.max(t.bottom,e.bottom),t.right=Math.max(t.right,e.right)}function ss(t,e,i,s){const{pos:n,box:a}=i,r=t.maxPadding;if(!o(n)){i.size&&(t[n]-=i.size);const e=s[i.stack]||{size:0,count:1};e.size=Math.max(e.size,i.horizontal?a.height:a.width),i.size=e.size/e.count,t[n]+=i.size}a.getPadding&&is(r,a.getPadding());const l=Math.max(0,e.outerWidth-es(r,t,"left","right")),h=Math.max(0,e.outerHeight-es(r,t,"top","bottom")),c=l!==t.w,d=h!==t.h;return t.w=l,t.h=h,i.horizontal?{same:c,other:d}:{same:d,other:c}}function ns(t,e){const i=e.maxPadding;function s(t){const s={left:0,top:0,right:0,bottom:0};return t.forEach((t=>{s[t]=Math.max(e[t],i[t])})),s}return s(t?["left","right"]:["top","bottom"])}function os(t,e,i,s){const n=[];let o,a,r,l,h,c;for(o=0,a=t.length,h=0;o<a;++o){r=t[o],l=r.box,l.update(r.width||e.w,r.height||e.h,ns(r.horizontal,e));const{same:a,other:d}=ss(e,i,r,s);h|=a&&n.length,c=c||d,l.fullSize||n.push(r)}return h&&os(n,e,i,s)||c}function as(t,e,i,s,n){t.top=i,t.left=e,t.right=e+s,t.bottom=i+n,t.width=s,t.height=n}function rs(t,e,i,s){const n=i.padding;let{x:o,y:a}=e;for(const r of t){const t=r.box,l=s[r.stack]||{count:1,placed:0,weight:1},h=r.stackWeight/l.weight||1;if(r.horizontal){const s=e.w*h,o=l.size||t.height;k(l.start)&&(a=l.start),t.fullSize?as(t,n.left,a,i.outerWidth-n.right-n.left,o):as(t,e.left+l.placed,a,s,o),l.start=a,l.placed+=s,a=t.bottom}else{const s=e.h*h,a=l.size||t.width;k(l.start)&&(o=l.start),t.fullSize?as(t,o,n.top,a,i.outerHeight-n.bottom-n.top):as(t,o,e.top+l.placed,a,s),l.start=o,l.placed+=s,o=t.right}}e.x=o,e.y=a}var ls={addBox(t,e){t.boxes||(t.boxes=[]),e.fullSize=e.fullSize||!1,e.position=e.position||"top",e.weight=e.weight||0,e._layers=e._layers||function(){return[{z:0,draw(t){e.draw(t)}}]},t.boxes.push(e)},removeBox(t,e){const i=t.boxes?t.boxes.indexOf(e):-1;-1!==i&&t.boxes.splice(i,1)},configure(t,e,i){e.fullSize=i.fullSize,e.position=i.position,e.weight=i.weight},update(t,e,i,s){if(!t)return;const n=ki(t.options.layout.padding),o=Math.max(e-n.width,0),a=Math.max(i-n.height,0),r=function(t){const e=function(t){const e=[];let i,s,n,o,a,r;for(i=0,s=(t||[]).length;i<s;++i)n=t[i],({position:o,options:{stack:a,stackWeight:r=1}}=n),e.push({index:i,box:n,pos:o,horizontal:n.isHorizontal(),weight:n.weight,stack:a&&o+a,stackWeight:r});return e}(t),i=Qi(e.filter((t=>t.box.fullSize)),!0),s=Qi(Ji(e,"left"),!0),n=Qi(Ji(e,"right")),o=Qi(Ji(e,"top"),!0),a=Qi(Ji(e,"bottom")),r=Zi(e,"x"),l=Zi(e,"y");return{fullSize:i,leftAndTop:s.concat(o),rightAndBottom:n.concat(l).concat(a).concat(r),chartArea:Ji(e,"chartArea"),vertical:s.concat(n).concat(l),horizontal:o.concat(a).concat(r)}}(t.boxes),l=r.vertical,h=r.horizontal;u(t.boxes,(t=>{"function"==typeof t.beforeLayout&&t.beforeLayout()}));const c=l.reduce(((t,e)=>e.box.options&&!1===e.box.options.display?t:t+1),0)||1,d=Object.freeze({outerWidth:e,outerHeight:i,padding:n,availableWidth:o,availableHeight:a,vBoxMaxWidth:o/2/c,hBoxMaxHeight:a/2}),f=Object.assign({},n);is(f,ki(s));const g=Object.assign({maxPadding:f,w:o,h:a,x:n.left,y:n.top},n),p=ts(l.concat(h),d);os(r.fullSize,g,d,p),os(l,g,d,p),os(h,g,d,p)&&os(l,g,d,p),function(t){const e=t.maxPadding;function i(i){const s=Math.max(e[i]-t[i],0);return t[i]+=s,s}t.y+=i("top"),t.x+=i("left"),i("right"),i("bottom")}(g),rs(r.leftAndTop,g,d,p),g.x+=g.w,g.y+=g.h,rs(r.rightAndBottom,g,d,p),t.chartArea={left:g.left,top:g.top,right:g.left+g.w,bottom:g.top+g.h,height:g.h,width:g.w},u(r.chartArea,(e=>{const i=e.box;Object.assign(i,t.chartArea),i.update(g.w,g.h,{left:0,top:0,right:0,bottom:0})}))}};class hs{acquireContext(t,e){}releaseContext(t){return!1}addEventListener(t,e,i){}removeEventListener(t,e,i){}getDevicePixelRatio(){return 1}getMaximumSize(t,e,i,s){return e=Math.max(0,e||t.width),i=i||t.height,{width:e,height:Math.max(0,s?Math.floor(e/s):i)}}isAttached(t){return!0}updateConfig(t){}}class cs extends hs{acquireContext(t){return t&&t.getContext&&t.getContext("2d")||null}updateConfig(t){t.options.animation=!1}}const ds="$chartjs",us={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"},fs=t=>null===t||""===t;const gs=!!Se&&{passive:!0};function ps(t,e,i){t&&t.canvas&&t.canvas.removeEventListener(e,i,gs)}function ms(t,e){for(const i of t)if(i===e||i.contains(e))return!0}function xs(t,e,i){const s=t.canvas,n=new MutationObserver((t=>{let e=!1;for(const i of t)e=e||ms(i.addedNodes,s),e=e&&!ms(i.removedNodes,s);e&&i()}));return n.observe(document,{childList:!0,subtree:!0}),n}function bs(t,e,i){const s=t.canvas,n=new MutationObserver((t=>{let e=!1;for(const i of t)e=e||ms(i.removedNodes,s),e=e&&!ms(i.addedNodes,s);e&&i()}));return n.observe(document,{childList:!0,subtree:!0}),n}const _s=new Map;let ys=0;function vs(){const t=window.devicePixelRatio;t!==ys&&(ys=t,_s.forEach(((e,i)=>{i.currentDevicePixelRatio!==t&&e()})))}function Ms(t,e,i){const s=t.canvas,n=s&&ge(s);if(!n)return;const o=ct(((t,e)=>{const s=n.clientWidth;i(t,e),s<n.clientWidth&&i()}),window),a=new ResizeObserver((t=>{const e=t[0],i=e.contentRect.width,s=e.contentRect.height;0===i&&0===s||o(i,s)}));return a.observe(n),function(t,e){_s.size||window.addEventListener("resize",vs),_s.set(t,e)}(t,o),a}function ws(t,e,i){i&&i.disconnect(),"resize"===e&&function(t){_s.delete(t),_s.size||window.removeEventListener("resize",vs)}(t)}function ks(t,e,i){const s=t.canvas,n=ct((e=>{null!==t.ctx&&i(function(t,e){const i=us[t.type]||t.type,{x:s,y:n}=ve(t,e);return{type:i,chart:e,native:t,x:void 0!==s?s:null,y:void 0!==n?n:null}}(e,t))}),t);return function(t,e,i){t&&t.addEventListener(e,i,gs)}(s,e,n),n}class Ss extends hs{acquireContext(t,e){const i=t&&t.getContext&&t.getContext("2d");return i&&i.canvas===t?(function(t,e){const i=t.style,s=t.getAttribute("height"),n=t.getAttribute("width");if(t[ds]={initial:{height:s,width:n,style:{display:i.display,height:i.height,width:i.width}}},i.display=i.display||"block",i.boxSizing=i.boxSizing||"border-box",fs(n)){const e=Pe(t,"width");void 0!==e&&(t.width=e)}if(fs(s))if(""===t.style.height)t.height=t.width/(e||2);else{const e=Pe(t,"height");void 0!==e&&(t.height=e)}}(t,e),i):null}releaseContext(t){const e=t.canvas;if(!e[ds])return!1;const i=e[ds].initial;["height","width"].forEach((t=>{const n=i[t];s(n)?e.removeAttribute(t):e.setAttribute(t,n)}));const n=i.style||{};return Object.keys(n).forEach((t=>{e.style[t]=n[t]})),e.width=e.width,delete e[ds],!0}addEventListener(t,e,i){this.removeEventListener(t,e);const s=t.$proxies||(t.$proxies={}),n={attach:xs,detach:bs,resize:Ms}[e]||ks;s[e]=n(t,e,i)}removeEventListener(t,e){const i=t.$proxies||(t.$proxies={}),s=i[e];if(!s)return;({attach:ws,detach:ws,resize:ws}[e]||ps)(t,e,s),i[e]=void 0}getDevicePixelRatio(){return window.devicePixelRatio}getMaximumSize(t,e,i,s){return we(t,e,i,s)}isAttached(t){const e=t&&ge(t);return!(!e||!e.isConnected)}}function Ps(t){return!fe()||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas?cs:Ss}var Ds=Object.freeze({__proto__:null,BasePlatform:hs,BasicPlatform:cs,DomPlatform:Ss,_detectPlatform:Ps});const Cs="transparent",Os={boolean:(t,e,i)=>i>.5?e:t,color(t,e,i){const s=Qt(t||Cs),n=s.valid&&Qt(e||Cs);return n&&n.valid?n.mix(s,i).hexString():e},number:(t,e,i)=>t+(e-t)*i};class As{constructor(t,e,i,s){const n=e[i];s=Pi([t.to,s,n,t.from]);const o=Pi([t.from,n,s]);this._active=!0,this._fn=t.fn||Os[t.type||typeof o],this._easing=fi[t.easing]||fi.linear,this._start=Math.floor(Date.now()+(t.delay||0)),this._duration=this._total=Math.floor(t.duration),this._loop=!!t.loop,this._target=e,this._prop=i,this._from=o,this._to=s,this._promises=void 0}active(){return this._active}update(t,e,i){if(this._active){this._notify(!1);const s=this._target[this._prop],n=i-this._start,o=this._duration-n;this._start=i,this._duration=Math.floor(Math.max(o,t.duration)),this._total+=n,this._loop=!!t.loop,this._to=Pi([t.to,e,s,t.from]),this._from=Pi([t.from,s,e])}}cancel(){this._active&&(this.tick(Date.now()),this._active=!1,this._notify(!1))}tick(t){const e=t-this._start,i=this._duration,s=this._prop,n=this._from,o=this._loop,a=this._to;let r;if(this._active=n!==a&&(o||e<i),!this._active)return this._target[s]=a,void this._notify(!0);e<0?this._target[s]=n:(r=e/i%2,r=o&&r>1?2-r:r,r=this._easing(Math.min(1,Math.max(0,r))),this._target[s]=this._fn(n,a,r))}wait(){const t=this._promises||(this._promises=[]);return new Promise(((e,i)=>{t.push({res:e,rej:i})}))}_notify(t){const e=t?"res":"rej",i=this._promises||[];for(let t=0;t<i.length;t++)i[t][e]()}}class Ts{constructor(t,e){this._chart=t,this._properties=new Map,this.configure(e)}configure(t){if(!o(t))return;const e=Object.keys(ue.animation),i=this._properties;Object.getOwnPropertyNames(t).forEach((s=>{const a=t[s];if(!o(a))return;const r={};for(const t of e)r[t]=a[t];(n(a.properties)&&a.properties||[s]).forEach((t=>{t!==s&&i.has(t)||i.set(t,r)}))}))}_animateOptions(t,e){const i=e.options,s=function(t,e){if(!e)return;let i=t.options;if(!i)return void(t.options=e);i.$shared&&(t.options=i=Object.assign({},i,{$shared:!1,$animations:{}}));return i}(t,i);if(!s)return[];const n=this._createAnimations(s,i);return i.$shared&&function(t,e){const i=[],s=Object.keys(e);for(let e=0;e<s.length;e++){const n=t[s[e]];n&&n.active()&&i.push(n.wait())}return Promise.all(i)}(t.options.$animations,i).then((()=>{t.options=i}),(()=>{})),n}_createAnimations(t,e){const i=this._properties,s=[],n=t.$animations||(t.$animations={}),o=Object.keys(e),a=Date.now();let r;for(r=o.length-1;r>=0;--r){const l=o[r];if("$"===l.charAt(0))continue;if("options"===l){s.push(...this._animateOptions(t,e));continue}const h=e[l];let c=n[l];const d=i.get(l);if(c){if(d&&c.active()){c.update(d,h,a);continue}c.cancel()}d&&d.duration?(n[l]=c=new As(d,t,l,h),s.push(c)):t[l]=h}return s}update(t,e){if(0===this._properties.size)return void Object.assign(t,e);const i=this._createAnimations(t,e);return i.length?(bt.add(this._chart,i),!0):void 0}}function Ls(t,e){const i=t&&t.options||{},s=i.reverse,n=void 0===i.min?e:0,o=void 0===i.max?e:0;return{start:s?o:n,end:s?n:o}}function Es(t,e){const i=[],s=t._getSortedDatasetMetas(e);let n,o;for(n=0,o=s.length;n<o;++n)i.push(s[n].index);return i}function Rs(t,e,i,s={}){const n=t.keys,o="single"===s.mode;let r,l,h,c;if(null===e)return;let d=!1;for(r=0,l=n.length;r<l;++r){if(h=+n[r],h===i){if(d=!0,s.all)continue;break}c=t.values[h],a(c)&&(o||0===e||F(e)===F(c))&&(e+=c)}return d||s.all?e:0}function Is(t,e){const i=t&&t.options.stacked;return i||void 0===i&&void 0!==e.stack}function zs(t,e,i){const s=t[e]||(t[e]={});return s[i]||(s[i]={})}function Fs(t,e,i,s){for(const n of e.getMatchingVisibleMetas(s).reverse()){const e=t[n.index];if(i&&e>0||!i&&e<0)return n.index}return null}function Vs(t,e){const{chart:i,_cachedMeta:s}=t,n=i._stacks||(i._stacks={}),{iScale:o,vScale:a,index:r}=s,l=o.axis,h=a.axis,c=function(t,e,i){return`${t.id}.${e.id}.${i.stack||i.type}`}(o,a,s),d=e.length;let u;for(let t=0;t<d;++t){const i=e[t],{[l]:o,[h]:d}=i;u=(i._stacks||(i._stacks={}))[h]=zs(n,c,o),u[r]=d,u._top=Fs(u,a,!0,s.type),u._bottom=Fs(u,a,!1,s.type);(u._visualValues||(u._visualValues={}))[r]=d}}function Bs(t,e){const i=t.scales;return Object.keys(i).filter((t=>i[t].axis===e)).shift()}function Ws(t,e){const i=t.controller.index,s=t.vScale&&t.vScale.axis;if(s){e=e||t._parsed;for(const t of e){const e=t._stacks;if(!e||void 0===e[s]||void 0===e[s][i])return;delete e[s][i],void 0!==e[s]._visualValues&&void 0!==e[s]._visualValues[i]&&delete e[s]._visualValues[i]}}}const Ns=t=>"reset"===t||"none"===t,Hs=(t,e)=>e?t:Object.assign({},t);class js{static defaults={};static datasetElementType=null;static dataElementType=null;constructor(t,e){this.chart=t,this._ctx=t.ctx,this.index=e,this._cachedDataOpts={},this._cachedMeta=this.getMeta(),this._type=this._cachedMeta.type,this.options=void 0,this._parsing=!1,this._data=void 0,this._objectData=void 0,this._sharedOptions=void 0,this._drawStart=void 0,this._drawCount=void 0,this.enableOptionSharing=!1,this.supportsDecimation=!1,this.$context=void 0,this._syncList=[],this.datasetElementType=new.target.datasetElementType,this.dataElementType=new.target.dataElementType,this.initialize()}initialize(){const t=this._cachedMeta;this.configure(),this.linkScales(),t._stacked=Is(t.vScale,t),this.addElements(),this.options.fill&&!this.chart.isPluginEnabled("filler")&&console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options")}updateIndex(t){this.index!==t&&Ws(this._cachedMeta),this.index=t}linkScales(){const t=this.chart,e=this._cachedMeta,i=this.getDataset(),s=(t,e,i,s)=>"x"===t?e:"r"===t?s:i,n=e.xAxisID=l(i.xAxisID,Bs(t,"x")),o=e.yAxisID=l(i.yAxisID,Bs(t,"y")),a=e.rAxisID=l(i.rAxisID,Bs(t,"r")),r=e.indexAxis,h=e.iAxisID=s(r,n,o,a),c=e.vAxisID=s(r,o,n,a);e.xScale=this.getScaleForId(n),e.yScale=this.getScaleForId(o),e.rScale=this.getScaleForId(a),e.iScale=this.getScaleForId(h),e.vScale=this.getScaleForId(c)}getDataset(){return this.chart.data.datasets[this.index]}getMeta(){return this.chart.getDatasetMeta(this.index)}getScaleForId(t){return this.chart.scales[t]}_getOtherScale(t){const e=this._cachedMeta;return t===e.iScale?e.vScale:e.iScale}reset(){this._update("reset")}_destroy(){const t=this._cachedMeta;this._data&&rt(this._data,this),t._stacked&&Ws(t)}_dataCheck(){const t=this.getDataset(),e=t.data||(t.data=[]),i=this._data;if(o(e)){const t=this._cachedMeta;this._data=function(t,e){const{iScale:i,vScale:s}=e,n="x"===i.axis?"x":"y",o="x"===s.axis?"x":"y",a=Object.keys(t),r=new Array(a.length);let l,h,c;for(l=0,h=a.length;l<h;++l)c=a[l],r[l]={[n]:c,[o]:t[c]};return r}(e,t)}else if(i!==e){if(i){rt(i,this);const t=this._cachedMeta;Ws(t),t._parsed=[]}e&&Object.isExtensible(e)&&at(e,this),this._syncList=[],this._data=e}}addElements(){const t=this._cachedMeta;this._dataCheck(),this.datasetElementType&&(t.dataset=new this.datasetElementType)}buildOrUpdateElements(t){const e=this._cachedMeta,i=this.getDataset();let s=!1;this._dataCheck();const n=e._stacked;e._stacked=Is(e.vScale,e),e.stack!==i.stack&&(s=!0,Ws(e),e.stack=i.stack),this._resyncElements(t),(s||n!==e._stacked)&&(Vs(this,e._parsed),e._stacked=Is(e.vScale,e))}configure(){const t=this.chart.config,e=t.datasetScopeKeys(this._type),i=t.getOptionScopes(this.getDataset(),e,!0);this.options=t.createResolver(i,this.getContext()),this._parsing=this.options.parsing,this._cachedDataOpts={}}parse(t,e){const{_cachedMeta:i,_data:s}=this,{iScale:a,_stacked:r}=i,l=a.axis;let h,c,d,u=0===t&&e===s.length||i._sorted,f=t>0&&i._parsed[t-1];if(!1===this._parsing)i._parsed=s,i._sorted=!0,d=s;else{d=n(s[t])?this.parseArrayData(i,s,t,e):o(s[t])?this.parseObjectData(i,s,t,e):this.parsePrimitiveData(i,s,t,e);const a=()=>null===c[l]||f&&c[l]<f[l];for(h=0;h<e;++h)i._parsed[h+t]=c=d[h],u&&(a()&&(u=!1),f=c);i._sorted=u}r&&Vs(this,d)}parsePrimitiveData(t,e,i,s){const{iScale:n,vScale:o}=t,a=n.axis,r=o.axis,l=n.getLabels(),h=n===o,c=new Array(s);let d,u,f;for(d=0,u=s;d<u;++d)f=d+i,c[d]={[a]:h||n.parse(l[f],f),[r]:o.parse(e[f],f)};return c}parseArrayData(t,e,i,s){const{xScale:n,yScale:o}=t,a=new Array(s);let r,l,h,c;for(r=0,l=s;r<l;++r)h=r+i,c=e[h],a[r]={x:n.parse(c[0],h),y:o.parse(c[1],h)};return a}parseObjectData(t,e,i,s){const{xScale:n,yScale:o}=t,{xAxisKey:a="x",yAxisKey:r="y"}=this._parsing,l=new Array(s);let h,c,d,u;for(h=0,c=s;h<c;++h)d=h+i,u=e[d],l[h]={x:n.parse(M(u,a),d),y:o.parse(M(u,r),d)};return l}getParsed(t){return this._cachedMeta._parsed[t]}getDataElement(t){return this._cachedMeta.data[t]}applyStack(t,e,i){const s=this.chart,n=this._cachedMeta,o=e[t.axis];return Rs({keys:Es(s,!0),values:e._stacks[t.axis]._visualValues},o,n.index,{mode:i})}updateRangeFromParsed(t,e,i,s){const n=i[e.axis];let o=null===n?NaN:n;const a=s&&i._stacks[e.axis];s&&a&&(s.values=a,o=Rs(s,n,this._cachedMeta.index)),t.min=Math.min(t.min,o),t.max=Math.max(t.max,o)}getMinMax(t,e){const i=this._cachedMeta,s=i._parsed,n=i._sorted&&t===i.iScale,o=s.length,r=this._getOtherScale(t),l=((t,e,i)=>t&&!e.hidden&&e._stacked&&{keys:Es(i,!0),values:null})(e,i,this.chart),h={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},{min:c,max:d}=function(t){const{min:e,max:i,minDefined:s,maxDefined:n}=t.getUserBounds();return{min:s?e:Number.NEGATIVE_INFINITY,max:n?i:Number.POSITIVE_INFINITY}}(r);let u,f;function g(){f=s[u];const e=f[r.axis];return!a(f[t.axis])||c>e||d<e}for(u=0;u<o&&(g()||(this.updateRangeFromParsed(h,t,f,l),!n));++u);if(n)for(u=o-1;u>=0;--u)if(!g()){this.updateRangeFromParsed(h,t,f,l);break}return h}getAllParsedValues(t){const e=this._cachedMeta._parsed,i=[];let s,n,o;for(s=0,n=e.length;s<n;++s)o=e[s][t.axis],a(o)&&i.push(o);return i}getMaxOverflow(){return!1}getLabelAndValue(t){const e=this._cachedMeta,i=e.iScale,s=e.vScale,n=this.getParsed(t);return{label:i?""+i.getLabelForValue(n[i.axis]):"",value:s?""+s.getLabelForValue(n[s.axis]):""}}_update(t){const e=this._cachedMeta;this.update(t||"default"),e._clip=function(t){let e,i,s,n;return o(t)?(e=t.top,i=t.right,s=t.bottom,n=t.left):e=i=s=n=t,{top:e,right:i,bottom:s,left:n,disabled:!1===t}}(l(this.options.clip,function(t,e,i){if(!1===i)return!1;const s=Ls(t,i),n=Ls(e,i);return{top:n.end,right:s.end,bottom:n.start,left:s.start}}(e.xScale,e.yScale,this.getMaxOverflow())))}update(t){}draw(){const t=this._ctx,e=this.chart,i=this._cachedMeta,s=i.data||[],n=e.chartArea,o=[],a=this._drawStart||0,r=this._drawCount||s.length-a,l=this.options.drawActiveElementsOnTop;let h;for(i.dataset&&i.dataset.draw(t,n,a,r),h=a;h<a+r;++h){const e=s[h];e.hidden||(e.active&&l?o.push(e):e.draw(t,n))}for(h=0;h<o.length;++h)o[h].draw(t,n)}getStyle(t,e){const i=e?"active":"default";return void 0===t&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(i):this.resolveDataElementOptions(t||0,i)}getContext(t,e,i){const s=this.getDataset();let n;if(t>=0&&t<this._cachedMeta.data.length){const e=this._cachedMeta.data[t];n=e.$context||(e.$context=function(t,e,i){return Ci(t,{active:!1,dataIndex:e,parsed:void 0,raw:void 0,element:i,index:e,mode:"default",type:"data"})}(this.getContext(),t,e)),n.parsed=this.getParsed(t),n.raw=s.data[t],n.index=n.dataIndex=t}else n=this.$context||(this.$context=function(t,e){return Ci(t,{active:!1,dataset:void 0,datasetIndex:e,index:e,mode:"default",type:"dataset"})}(this.chart.getContext(),this.index)),n.dataset=s,n.index=n.datasetIndex=this.index;return n.active=!!e,n.mode=i,n}resolveDatasetElementOptions(t){return this._resolveElementOptions(this.datasetElementType.id,t)}resolveDataElementOptions(t,e){return this._resolveElementOptions(this.dataElementType.id,e,t)}_resolveElementOptions(t,e="default",i){const s="active"===e,n=this._cachedDataOpts,o=t+"-"+e,a=n[o],r=this.enableOptionSharing&&k(i);if(a)return Hs(a,r);const l=this.chart.config,h=l.datasetElementScopeKeys(this._type,t),c=s?[`${t}Hover`,"hover",t,""]:[t,""],d=l.getOptionScopes(this.getDataset(),h),u=Object.keys(ue.elements[t]),f=l.resolveNamedOptions(d,u,(()=>this.getContext(i,s,e)),c);return f.$shared&&(f.$shared=r,n[o]=Object.freeze(Hs(f,r))),f}_resolveAnimations(t,e,i){const s=this.chart,n=this._cachedDataOpts,o=`animation-${e}`,a=n[o];if(a)return a;let r;if(!1!==s.options.animation){const s=this.chart.config,n=s.datasetAnimationScopeKeys(this._type,e),o=s.getOptionScopes(this.getDataset(),n);r=s.createResolver(o,this.getContext(t,i,e))}const l=new Ts(s,r&&r.animations);return r&&r._cacheable&&(n[o]=Object.freeze(l)),l}getSharedOptions(t){if(t.$shared)return this._sharedOptions||(this._sharedOptions=Object.assign({},t))}includeOptions(t,e){return!e||Ns(t)||this.chart._animationsDisabled}_getSharedOptions(t,e){const i=this.resolveDataElementOptions(t,e),s=this._sharedOptions,n=this.getSharedOptions(i),o=this.includeOptions(e,n)||n!==s;return this.updateSharedOptions(n,e,i),{sharedOptions:n,includeOptions:o}}updateElement(t,e,i,s){Ns(s)?Object.assign(t,i):this._resolveAnimations(e,s).update(t,i)}updateSharedOptions(t,e,i){t&&!Ns(e)&&this._resolveAnimations(void 0,e).update(t,i)}_setStyle(t,e,i,s){t.active=s;const n=this.getStyle(e,s);this._resolveAnimations(e,i,s).update(t,{options:!s&&this.getSharedOptions(n)||n})}removeHoverStyle(t,e,i){this._setStyle(t,i,"active",!1)}setHoverStyle(t,e,i){this._setStyle(t,i,"active",!0)}_removeDatasetHoverStyle(){const t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!1)}_setDatasetHoverStyle(){const t=this._cachedMeta.dataset;t&&this._setStyle(t,void 0,"active",!0)}_resyncElements(t){const e=this._data,i=this._cachedMeta.data;for(const[t,e,i]of this._syncList)this[t](e,i);this._syncList=[];const s=i.length,n=e.length,o=Math.min(n,s);o&&this.parse(0,o),n>s?this._insertElements(s,n-s,t):n<s&&this._removeElements(n,s-n)}_insertElements(t,e,i=!0){const s=this._cachedMeta,n=s.data,o=t+e;let a;const r=t=>{for(t.length+=e,a=t.length-1;a>=o;a--)t[a]=t[a-e]};for(r(n),a=t;a<o;++a)n[a]=new this.dataElementType;this._parsing&&r(s._parsed),this.parse(t,e),i&&this.updateElements(n,t,e,"reset")}updateElements(t,e,i,s){}_removeElements(t,e){const i=this._cachedMeta;if(this._parsing){const s=i._parsed.splice(t,e);i._stacked&&Ws(i,s)}i.data.splice(t,e)}_sync(t){if(this._parsing)this._syncList.push(t);else{const[e,i,s]=t;this[e](i,s)}this.chart._dataChanges.push([this.index,...t])}_onDataPush(){const t=arguments.length;this._sync(["_insertElements",this.getDataset().data.length-t,t])}_onDataPop(){this._sync(["_removeElements",this._cachedMeta.data.length-1,1])}_onDataShift(){this._sync(["_removeElements",0,1])}_onDataSplice(t,e){e&&this._sync(["_removeElements",t,e]);const i=arguments.length-2;i&&this._sync(["_insertElements",t,i])}_onDataUnshift(){this._sync(["_insertElements",0,arguments.length])}}class $s{static defaults={};static defaultRoutes=void 0;x;y;active=!1;options;$animations;tooltipPosition(t){const{x:e,y:i}=this.getProps(["x","y"],t);return{x:e,y:i}}hasValue(){return N(this.x)&&N(this.y)}getProps(t,e){const i=this.$animations;if(!e||!i)return this;const s={};return t.forEach((t=>{s[t]=i[t]&&i[t].active()?i[t]._to:this[t]})),s}}function Ys(t,e){const i=t.options.ticks,n=function(t){const e=t.options.offset,i=t._tickSize(),s=t._length/i+(e?0:1),n=t._maxLength/i;return Math.floor(Math.min(s,n))}(t),o=Math.min(i.maxTicksLimit||n,n),a=i.major.enabled?function(t){const e=[];let i,s;for(i=0,s=t.length;i<s;i++)t[i].major&&e.push(i);return e}(e):[],r=a.length,l=a[0],h=a[r-1],c=[];if(r>o)return function(t,e,i,s){let n,o=0,a=i[0];for(s=Math.ceil(s),n=0;n<t.length;n++)n===a&&(e.push(t[n]),o++,a=i[o*s])}(e,c,a,r/o),c;const d=function(t,e,i){const s=function(t){const e=t.length;let i,s;if(e<2)return!1;for(s=t[0],i=1;i<e;++i)if(t[i]-t[i-1]!==s)return!1;return s}(t),n=e.length/i;if(!s)return Math.max(n,1);const o=W(s);for(let t=0,e=o.length-1;t<e;t++){const e=o[t];if(e>n)return e}return Math.max(n,1)}(a,e,o);if(r>0){let t,i;const n=r>1?Math.round((h-l)/(r-1)):null;for(Us(e,c,d,s(n)?0:l-n,l),t=0,i=r-1;t<i;t++)Us(e,c,d,a[t],a[t+1]);return Us(e,c,d,h,s(n)?e.length:h+n),c}return Us(e,c,d),c}function Us(t,e,i,s,n){const o=l(s,0),a=Math.min(l(n,t.length),t.length);let r,h,c,d=0;for(i=Math.ceil(i),n&&(r=n-s,i=r/Math.floor(r/i)),c=o;c<0;)d++,c=Math.round(o+d*i);for(h=Math.max(o,0);h<a;h++)h===c&&(e.push(t[h]),d++,c=Math.round(o+d*i))}const Xs=(t,e,i)=>"top"===e||"left"===e?t[e]+i:t[e]-i,qs=(t,e)=>Math.min(e||t,t);function Ks(t,e){const i=[],s=t.length/e,n=t.length;let o=0;for(;o<n;o+=s)i.push(t[Math.floor(o)]);return i}function Gs(t,e,i){const s=t.ticks.length,n=Math.min(e,s-1),o=t._startPixel,a=t._endPixel,r=1e-6;let l,h=t.getPixelForTick(n);if(!(i&&(l=1===s?Math.max(h-o,a-h):0===e?(t.getPixelForTick(1)-h)/2:(h-t.getPixelForTick(n-1))/2,h+=n<e?l:-l,h<o-r||h>a+r)))return h}function Js(t){return t.drawTicks?t.tickLength:0}function Zs(t,e){if(!t.display)return 0;const i=Si(t.font,e),s=ki(t.padding);return(n(t.text)?t.text.length:1)*i.lineHeight+s.height}function Qs(t,e,i){let s=ut(t);return(i&&"right"!==e||!i&&"right"===e)&&(s=(t=>"left"===t?"right":"right"===t?"left":t)(s)),s}class tn extends $s{constructor(t){super(),this.id=t.id,this.type=t.type,this.options=void 0,this.ctx=t.ctx,this.chart=t.chart,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this._margins={left:0,right:0,top:0,bottom:0},this.maxWidth=void 0,this.maxHeight=void 0,this.paddingTop=void 0,this.paddingBottom=void 0,this.paddingLeft=void 0,this.paddingRight=void 0,this.axis=void 0,this.labelRotation=void 0,this.min=void 0,this.max=void 0,this._range=void 0,this.ticks=[],this._gridLineItems=null,this._labelItems=null,this._labelSizes=null,this._length=0,this._maxLength=0,this._longestTextCache={},this._startPixel=void 0,this._endPixel=void 0,this._reversePixels=!1,this._userMax=void 0,this._userMin=void 0,this._suggestedMax=void 0,this._suggestedMin=void 0,this._ticksLength=0,this._borderValue=0,this._cache={},this._dataLimitsCached=!1,this.$context=void 0}init(t){this.options=t.setContext(this.getContext()),this.axis=t.axis,this._userMin=this.parse(t.min),this._userMax=this.parse(t.max),this._suggestedMin=this.parse(t.suggestedMin),this._suggestedMax=this.parse(t.suggestedMax)}parse(t,e){return t}getUserBounds(){let{_userMin:t,_userMax:e,_suggestedMin:i,_suggestedMax:s}=this;return t=r(t,Number.POSITIVE_INFINITY),e=r(e,Number.NEGATIVE_INFINITY),i=r(i,Number.POSITIVE_INFINITY),s=r(s,Number.NEGATIVE_INFINITY),{min:r(t,i),max:r(e,s),minDefined:a(t),maxDefined:a(e)}}getMinMax(t){let e,{min:i,max:s,minDefined:n,maxDefined:o}=this.getUserBounds();if(n&&o)return{min:i,max:s};const a=this.getMatchingVisibleMetas();for(let r=0,l=a.length;r<l;++r)e=a[r].controller.getMinMax(this,t),n||(i=Math.min(i,e.min)),o||(s=Math.max(s,e.max));return i=o&&i>s?s:i,s=n&&i>s?i:s,{min:r(i,r(s,i)),max:r(s,r(i,s))}}getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}}getTicks(){return this.ticks}getLabels(){const t=this.chart.data;return this.options.labels||(this.isHorizontal()?t.xLabels:t.yLabels)||t.labels||[]}getLabelItems(t=this.chart.chartArea){return this._labelItems||(this._labelItems=this._computeLabelItems(t))}beforeLayout(){this._cache={},this._dataLimitsCached=!1}beforeUpdate(){d(this.options.beforeUpdate,[this])}update(t,e,i){const{beginAtZero:s,grace:n,ticks:o}=this.options,a=o.sampleSize;this.beforeUpdate(),this.maxWidth=t,this.maxHeight=e,this._margins=i=Object.assign({left:0,right:0,top:0,bottom:0},i),this.ticks=null,this._labelSizes=null,this._gridLineItems=null,this._labelItems=null,this.beforeSetDimensions(),this.setDimensions(),this.afterSetDimensions(),this._maxLength=this.isHorizontal()?this.width+i.left+i.right:this.height+i.top+i.bottom,this._dataLimitsCached||(this.beforeDataLimits(),this.determineDataLimits(),this.afterDataLimits(),this._range=Di(this,n,s),this._dataLimitsCached=!0),this.beforeBuildTicks(),this.ticks=this.buildTicks()||[],this.afterBuildTicks();const r=a<this.ticks.length;this._convertTicksToLabels(r?Ks(this.ticks,a):this.ticks),this.configure(),this.beforeCalculateLabelRotation(),this.calculateLabelRotation(),this.afterCalculateLabelRotation(),o.display&&(o.autoSkip||"auto"===o.source)&&(this.ticks=Ys(this,this.ticks),this._labelSizes=null,this.afterAutoSkip()),r&&this._convertTicksToLabels(this.ticks),this.beforeFit(),this.fit(),this.afterFit(),this.afterUpdate()}configure(){let t,e,i=this.options.reverse;this.isHorizontal()?(t=this.left,e=this.right):(t=this.top,e=this.bottom,i=!i),this._startPixel=t,this._endPixel=e,this._reversePixels=i,this._length=e-t,this._alignToPixels=this.options.alignToPixels}afterUpdate(){d(this.options.afterUpdate,[this])}beforeSetDimensions(){d(this.options.beforeSetDimensions,[this])}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=0,this.right=this.width):(this.height=this.maxHeight,this.top=0,this.bottom=this.height),this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0}afterSetDimensions(){d(this.options.afterSetDimensions,[this])}_callHooks(t){this.chart.notifyPlugins(t,this.getContext()),d(this.options[t],[this])}beforeDataLimits(){this._callHooks("beforeDataLimits")}determineDataLimits(){}afterDataLimits(){this._callHooks("afterDataLimits")}beforeBuildTicks(){this._callHooks("beforeBuildTicks")}buildTicks(){return[]}afterBuildTicks(){this._callHooks("afterBuildTicks")}beforeTickToLabelConversion(){d(this.options.beforeTickToLabelConversion,[this])}generateTickLabels(t){const e=this.options.ticks;let i,s,n;for(i=0,s=t.length;i<s;i++)n=t[i],n.label=d(e.callback,[n.value,i,t],this)}afterTickToLabelConversion(){d(this.options.afterTickToLabelConversion,[this])}beforeCalculateLabelRotation(){d(this.options.beforeCalculateLabelRotation,[this])}calculateLabelRotation(){const t=this.options,e=t.ticks,i=qs(this.ticks.length,t.ticks.maxTicksLimit),s=e.minRotation||0,n=e.maxRotation;let o,a,r,l=s;if(!this._isVisible()||!e.display||s>=n||i<=1||!this.isHorizontal())return void(this.labelRotation=s);const h=this._getLabelSizes(),c=h.widest.width,d=h.highest.height,u=Z(this.chart.width-c,0,this.maxWidth);o=t.offset?this.maxWidth/i:u/(i-1),c+6>o&&(o=u/(i-(t.offset?.5:1)),a=this.maxHeight-Js(t.grid)-e.padding-Zs(t.title,this.chart.options.font),r=Math.sqrt(c*c+d*d),l=Y(Math.min(Math.asin(Z((h.highest.height+6)/o,-1,1)),Math.asin(Z(a/r,-1,1))-Math.asin(Z(d/r,-1,1)))),l=Math.max(s,Math.min(n,l))),this.labelRotation=l}afterCalculateLabelRotation(){d(this.options.afterCalculateLabelRotation,[this])}afterAutoSkip(){}beforeFit(){d(this.options.beforeFit,[this])}fit(){const t={width:0,height:0},{chart:e,options:{ticks:i,title:s,grid:n}}=this,o=this._isVisible(),a=this.isHorizontal();if(o){const o=Zs(s,e.options.font);if(a?(t.width=this.maxWidth,t.height=Js(n)+o):(t.height=this.maxHeight,t.width=Js(n)+o),i.display&&this.ticks.length){const{first:e,last:s,widest:n,highest:o}=this._getLabelSizes(),r=2*i.padding,l=$(this.labelRotation),h=Math.cos(l),c=Math.sin(l);if(a){const e=i.mirror?0:c*n.width+h*o.height;t.height=Math.min(this.maxHeight,t.height+e+r)}else{const e=i.mirror?0:h*n.width+c*o.height;t.width=Math.min(this.maxWidth,t.width+e+r)}this._calculatePadding(e,s,c,h)}}this._handleMargins(),a?(this.width=this._length=e.width-this._margins.left-this._margins.right,this.height=t.height):(this.width=t.width,this.height=this._length=e.height-this._margins.top-this._margins.bottom)}_calculatePadding(t,e,i,s){const{ticks:{align:n,padding:o},position:a}=this.options,r=0!==this.labelRotation,l="top"!==a&&"x"===this.axis;if(this.isHorizontal()){const a=this.getPixelForTick(0)-this.left,h=this.right-this.getPixelForTick(this.ticks.length-1);let c=0,d=0;r?l?(c=s*t.width,d=i*e.height):(c=i*t.height,d=s*e.width):"start"===n?d=e.width:"end"===n?c=t.width:"inner"!==n&&(c=t.width/2,d=e.width/2),this.paddingLeft=Math.max((c-a+o)*this.width/(this.width-a),0),this.paddingRight=Math.max((d-h+o)*this.width/(this.width-h),0)}else{let i=e.height/2,s=t.height/2;"start"===n?(i=0,s=t.height):"end"===n&&(i=e.height,s=0),this.paddingTop=i+o,this.paddingBottom=s+o}}_handleMargins(){this._margins&&(this._margins.left=Math.max(this.paddingLeft,this._margins.left),this._margins.top=Math.max(this.paddingTop,this._margins.top),this._margins.right=Math.max(this.paddingRight,this._margins.right),this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom))}afterFit(){d(this.options.afterFit,[this])}isHorizontal(){const{axis:t,position:e}=this.options;return"top"===e||"bottom"===e||"x"===t}isFullSize(){return this.options.fullSize}_convertTicksToLabels(t){let e,i;for(this.beforeTickToLabelConversion(),this.generateTickLabels(t),e=0,i=t.length;e<i;e++)s(t[e].label)&&(t.splice(e,1),i--,e--);this.afterTickToLabelConversion()}_getLabelSizes(){let t=this._labelSizes;if(!t){const e=this.options.ticks.sampleSize;let i=this.ticks;e<i.length&&(i=Ks(i,e)),this._labelSizes=t=this._computeLabelSizes(i,i.length,this.options.ticks.maxTicksLimit)}return t}_computeLabelSizes(t,e,i){const{ctx:o,_longestTextCache:a}=this,r=[],l=[],h=Math.floor(e/qs(e,i));let c,d,f,g,p,m,x,b,_,y,v,M=0,w=0;for(c=0;c<e;c+=h){if(g=t[c].label,p=this._resolveTickFontOptions(c),o.font=m=p.string,x=a[m]=a[m]||{data:{},gc:[]},b=p.lineHeight,_=y=0,s(g)||n(g)){if(n(g))for(d=0,f=g.length;d<f;++d)v=g[d],s(v)||n(v)||(_=Ce(o,x.data,x.gc,_,v),y+=b)}else _=Ce(o,x.data,x.gc,_,g),y=b;r.push(_),l.push(y),M=Math.max(_,M),w=Math.max(y,w)}!function(t,e){u(t,(t=>{const i=t.gc,s=i.length/2;let n;if(s>e){for(n=0;n<s;++n)delete t.data[i[n]];i.splice(0,s)}}))}(a,e);const k=r.indexOf(M),S=l.indexOf(w),P=t=>({width:r[t]||0,height:l[t]||0});return{first:P(0),last:P(e-1),widest:P(k),highest:P(S),widths:r,heights:l}}getLabelForValue(t){return t}getPixelForValue(t,e){return NaN}getValueForPixel(t){}getPixelForTick(t){const e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getPixelForDecimal(t){this._reversePixels&&(t=1-t);const e=this._startPixel+t*this._length;return Q(this._alignToPixels?Ae(this.chart,e,0):e)}getDecimalForPixel(t){const e=(t-this._startPixel)/this._length;return this._reversePixels?1-e:e}getBasePixel(){return this.getPixelForValue(this.getBaseValue())}getBaseValue(){const{min:t,max:e}=this;return t<0&&e<0?e:t>0&&e>0?t:0}getContext(t){const e=this.ticks||[];if(t>=0&&t<e.length){const i=e[t];return i.$context||(i.$context=function(t,e,i){return Ci(t,{tick:i,index:e,type:"tick"})}(this.getContext(),t,i))}return this.$context||(this.$context=Ci(this.chart.getContext(),{scale:this,type:"scale"}))}_tickSize(){const t=this.options.ticks,e=$(this.labelRotation),i=Math.abs(Math.cos(e)),s=Math.abs(Math.sin(e)),n=this._getLabelSizes(),o=t.autoSkipPadding||0,a=n?n.widest.width+o:0,r=n?n.highest.height+o:0;return this.isHorizontal()?r*i>a*s?a/i:r/s:r*s<a*i?r/i:a/s}_isVisible(){const t=this.options.display;return"auto"!==t?!!t:this.getMatchingVisibleMetas().length>0}_computeGridLineItems(t){const e=this.axis,i=this.chart,s=this.options,{grid:n,position:a,border:r}=s,h=n.offset,c=this.isHorizontal(),d=this.ticks.length+(h?1:0),u=Js(n),f=[],g=r.setContext(this.getContext()),p=g.display?g.width:0,m=p/2,x=function(t){return Ae(i,t,p)};let b,_,y,v,M,w,k,S,P,D,C,O;if("top"===a)b=x(this.bottom),w=this.bottom-u,S=b-m,D=x(t.top)+m,O=t.bottom;else if("bottom"===a)b=x(this.top),D=t.top,O=x(t.bottom)-m,w=b+m,S=this.top+u;else if("left"===a)b=x(this.right),M=this.right-u,k=b-m,P=x(t.left)+m,C=t.right;else if("right"===a)b=x(this.left),P=t.left,C=x(t.right)-m,M=b+m,k=this.left+u;else if("x"===e){if("center"===a)b=x((t.top+t.bottom)/2+.5);else if(o(a)){const t=Object.keys(a)[0],e=a[t];b=x(this.chart.scales[t].getPixelForValue(e))}D=t.top,O=t.bottom,w=b+m,S=w+u}else if("y"===e){if("center"===a)b=x((t.left+t.right)/2);else if(o(a)){const t=Object.keys(a)[0],e=a[t];b=x(this.chart.scales[t].getPixelForValue(e))}M=b-m,k=M-u,P=t.left,C=t.right}const A=l(s.ticks.maxTicksLimit,d),T=Math.max(1,Math.ceil(d/A));for(_=0;_<d;_+=T){const t=this.getContext(_),e=n.setContext(t),s=r.setContext(t),o=e.lineWidth,a=e.color,l=s.dash||[],d=s.dashOffset,u=e.tickWidth,g=e.tickColor,p=e.tickBorderDash||[],m=e.tickBorderDashOffset;y=Gs(this,_,h),void 0!==y&&(v=Ae(i,y,o),c?M=k=P=C=v:w=S=D=O=v,f.push({tx1:M,ty1:w,tx2:k,ty2:S,x1:P,y1:D,x2:C,y2:O,width:o,color:a,borderDash:l,borderDashOffset:d,tickWidth:u,tickColor:g,tickBorderDash:p,tickBorderDashOffset:m}))}return this._ticksLength=d,this._borderValue=b,f}_computeLabelItems(t){const e=this.axis,i=this.options,{position:s,ticks:a}=i,r=this.isHorizontal(),l=this.ticks,{align:h,crossAlign:c,padding:d,mirror:u}=a,f=Js(i.grid),g=f+d,p=u?-d:g,m=-$(this.labelRotation),x=[];let b,_,y,v,M,w,k,S,P,D,C,O,A="middle";if("top"===s)w=this.bottom-p,k=this._getXAxisLabelAlignment();else if("bottom"===s)w=this.top+p,k=this._getXAxisLabelAlignment();else if("left"===s){const t=this._getYAxisLabelAlignment(f);k=t.textAlign,M=t.x}else if("right"===s){const t=this._getYAxisLabelAlignment(f);k=t.textAlign,M=t.x}else if("x"===e){if("center"===s)w=(t.top+t.bottom)/2+g;else if(o(s)){const t=Object.keys(s)[0],e=s[t];w=this.chart.scales[t].getPixelForValue(e)+g}k=this._getXAxisLabelAlignment()}else if("y"===e){if("center"===s)M=(t.left+t.right)/2-g;else if(o(s)){const t=Object.keys(s)[0],e=s[t];M=this.chart.scales[t].getPixelForValue(e)}k=this._getYAxisLabelAlignment(f).textAlign}"y"===e&&("start"===h?A="top":"end"===h&&(A="bottom"));const T=this._getLabelSizes();for(b=0,_=l.length;b<_;++b){y=l[b],v=y.label;const t=a.setContext(this.getContext(b));S=this.getPixelForTick(b)+a.labelOffset,P=this._resolveTickFontOptions(b),D=P.lineHeight,C=n(v)?v.length:1;const e=C/2,i=t.color,o=t.textStrokeColor,h=t.textStrokeWidth;let d,f=k;if(r?(M=S,"inner"===k&&(f=b===_-1?this.options.reverse?"left":"right":0===b?this.options.reverse?"right":"left":"center"),O="top"===s?"near"===c||0!==m?-C*D+D/2:"center"===c?-T.highest.height/2-e*D+D:-T.highest.height+D/2:"near"===c||0!==m?D/2:"center"===c?T.highest.height/2-e*D:T.highest.height-C*D,u&&(O*=-1),0===m||t.showLabelBackdrop||(M+=D/2*Math.sin(m))):(w=S,O=(1-C)*D/2),t.showLabelBackdrop){const e=ki(t.backdropPadding),i=T.heights[b],s=T.widths[b];let n=O-e.top,o=0-e.left;switch(A){case"middle":n-=i/2;break;case"bottom":n-=i}switch(k){case"center":o-=s/2;break;case"right":o-=s;break;case"inner":b===_-1?o-=s:b>0&&(o-=s/2)}d={left:o,top:n,width:s+e.width,height:i+e.height,color:t.backdropColor}}x.push({label:v,font:P,textOffset:O,options:{rotation:m,color:i,strokeColor:o,strokeWidth:h,textAlign:f,textBaseline:A,translation:[M,w],backdrop:d}})}return x}_getXAxisLabelAlignment(){const{position:t,ticks:e}=this.options;if(-$(this.labelRotation))return"top"===t?"left":"right";let i="center";return"start"===e.align?i="left":"end"===e.align?i="right":"inner"===e.align&&(i="inner"),i}_getYAxisLabelAlignment(t){const{position:e,ticks:{crossAlign:i,mirror:s,padding:n}}=this.options,o=t+n,a=this._getLabelSizes().widest.width;let r,l;return"left"===e?s?(l=this.right+n,"near"===i?r="left":"center"===i?(r="center",l+=a/2):(r="right",l+=a)):(l=this.right-o,"near"===i?r="right":"center"===i?(r="center",l-=a/2):(r="left",l=this.left)):"right"===e?s?(l=this.left+n,"near"===i?r="right":"center"===i?(r="center",l-=a/2):(r="left",l-=a)):(l=this.left+o,"near"===i?r="left":"center"===i?(r="center",l+=a/2):(r="right",l=this.right)):r="right",{textAlign:r,x:l}}_computeLabelArea(){if(this.options.ticks.mirror)return;const t=this.chart,e=this.options.position;return"left"===e||"right"===e?{top:0,left:this.left,bottom:t.height,right:this.right}:"top"===e||"bottom"===e?{top:this.top,left:0,bottom:this.bottom,right:t.width}:void 0}drawBackground(){const{ctx:t,options:{backgroundColor:e},left:i,top:s,width:n,height:o}=this;e&&(t.save(),t.fillStyle=e,t.fillRect(i,s,n,o),t.restore())}getLineWidthForValue(t){const e=this.options.grid;if(!this._isVisible()||!e.display)return 0;const i=this.ticks.findIndex((e=>e.value===t));if(i>=0){return e.setContext(this.getContext(i)).lineWidth}return 0}drawGrid(t){const e=this.options.grid,i=this.ctx,s=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(t));let n,o;const a=(t,e,s)=>{s.width&&s.color&&(i.save(),i.lineWidth=s.width,i.strokeStyle=s.color,i.setLineDash(s.borderDash||[]),i.lineDashOffset=s.borderDashOffset,i.beginPath(),i.moveTo(t.x,t.y),i.lineTo(e.x,e.y),i.stroke(),i.restore())};if(e.display)for(n=0,o=s.length;n<o;++n){const t=s[n];e.drawOnChartArea&&a({x:t.x1,y:t.y1},{x:t.x2,y:t.y2},t),e.drawTicks&&a({x:t.tx1,y:t.ty1},{x:t.tx2,y:t.ty2},{color:t.tickColor,width:t.tickWidth,borderDash:t.tickBorderDash,borderDashOffset:t.tickBorderDashOffset})}}drawBorder(){const{chart:t,ctx:e,options:{border:i,grid:s}}=this,n=i.setContext(this.getContext()),o=i.display?n.width:0;if(!o)return;const a=s.setContext(this.getContext(0)).lineWidth,r=this._borderValue;let l,h,c,d;this.isHorizontal()?(l=Ae(t,this.left,o)-o/2,h=Ae(t,this.right,a)+a/2,c=d=r):(c=Ae(t,this.top,o)-o/2,d=Ae(t,this.bottom,a)+a/2,l=h=r),e.save(),e.lineWidth=n.width,e.strokeStyle=n.color,e.beginPath(),e.moveTo(l,c),e.lineTo(h,d),e.stroke(),e.restore()}drawLabels(t){if(!this.options.ticks.display)return;const e=this.ctx,i=this._computeLabelArea();i&&Ie(e,i);const s=this.getLabelItems(t);for(const t of s){const i=t.options,s=t.font;Ne(e,t.label,0,t.textOffset,s,i)}i&&ze(e)}drawTitle(){const{ctx:t,options:{position:e,title:i,reverse:s}}=this;if(!i.display)return;const a=Si(i.font),r=ki(i.padding),l=i.align;let h=a.lineHeight/2;"bottom"===e||"center"===e||o(e)?(h+=r.bottom,n(i.text)&&(h+=a.lineHeight*(i.text.length-1))):h+=r.top;const{titleX:c,titleY:d,maxWidth:u,rotation:f}=function(t,e,i,s){const{top:n,left:a,bottom:r,right:l,chart:h}=t,{chartArea:c,scales:d}=h;let u,f,g,p=0;const m=r-n,x=l-a;if(t.isHorizontal()){if(f=ft(s,a,l),o(i)){const t=Object.keys(i)[0],s=i[t];g=d[t].getPixelForValue(s)+m-e}else g="center"===i?(c.bottom+c.top)/2+m-e:Xs(t,i,e);u=l-a}else{if(o(i)){const t=Object.keys(i)[0],s=i[t];f=d[t].getPixelForValue(s)-x+e}else f="center"===i?(c.left+c.right)/2-x+e:Xs(t,i,e);g=ft(s,r,n),p="left"===i?-E:E}return{titleX:f,titleY:g,maxWidth:u,rotation:p}}(this,h,e,l);Ne(t,i.text,0,0,a,{color:i.color,maxWidth:u,rotation:f,textAlign:Qs(l,e,s),textBaseline:"middle",translation:[c,d]})}draw(t){this._isVisible()&&(this.drawBackground(),this.drawGrid(t),this.drawBorder(),this.drawTitle(),this.drawLabels(t))}_layers(){const t=this.options,e=t.ticks&&t.ticks.z||0,i=l(t.grid&&t.grid.z,-1),s=l(t.border&&t.border.z,0);return this._isVisible()&&this.draw===tn.prototype.draw?[{z:i,draw:t=>{this.drawBackground(),this.drawGrid(t),this.drawTitle()}},{z:s,draw:()=>{this.drawBorder()}},{z:e,draw:t=>{this.drawLabels(t)}}]:[{z:e,draw:t=>{this.draw(t)}}]}getMatchingVisibleMetas(t){const e=this.chart.getSortedVisibleDatasetMetas(),i=this.axis+"AxisID",s=[];let n,o;for(n=0,o=e.length;n<o;++n){const o=e[n];o[i]!==this.id||t&&o.type!==t||s.push(o)}return s}_resolveTickFontOptions(t){return Si(this.options.ticks.setContext(this.getContext(t)).font)}_maxDigits(){const t=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/t}}class en{constructor(t,e,i){this.type=t,this.scope=e,this.override=i,this.items=Object.create(null)}isForType(t){return Object.prototype.isPrototypeOf.call(this.type.prototype,t.prototype)}register(t){const e=Object.getPrototypeOf(t);let i;(function(t){return"id"in t&&"defaults"in t})(e)&&(i=this.register(e));const s=this.items,n=t.id,o=this.scope+"."+n;if(!n)throw new Error("class does not have id: "+t);return n in s||(s[n]=t,function(t,e,i){const s=x(Object.create(null),[i?ue.get(i):{},ue.get(e),t.defaults]);ue.set(e,s),t.defaultRoutes&&function(t,e){Object.keys(e).forEach((i=>{const s=i.split("."),n=s.pop(),o=[t].concat(s).join("."),a=e[i].split("."),r=a.pop(),l=a.join(".");ue.route(o,n,l,r)}))}(e,t.defaultRoutes);t.descriptors&&ue.describe(e,t.descriptors)}(t,o,i),this.override&&ue.override(t.id,t.overrides)),o}get(t){return this.items[t]}unregister(t){const e=this.items,i=t.id,s=this.scope;i in e&&delete e[i],s&&i in ue[s]&&(delete ue[s][i],this.override&&delete re[i])}}class sn{constructor(){this.controllers=new en(js,"datasets",!0),this.elements=new en($s,"elements"),this.plugins=new en(Object,"plugins"),this.scales=new en(tn,"scales"),this._typedRegistries=[this.controllers,this.scales,this.elements]}add(...t){this._each("register",t)}remove(...t){this._each("unregister",t)}addControllers(...t){this._each("register",t,this.controllers)}addElements(...t){this._each("register",t,this.elements)}addPlugins(...t){this._each("register",t,this.plugins)}addScales(...t){this._each("register",t,this.scales)}getController(t){return this._get(t,this.controllers,"controller")}getElement(t){return this._get(t,this.elements,"element")}getPlugin(t){return this._get(t,this.plugins,"plugin")}getScale(t){return this._get(t,this.scales,"scale")}removeControllers(...t){this._each("unregister",t,this.controllers)}removeElements(...t){this._each("unregister",t,this.elements)}removePlugins(...t){this._each("unregister",t,this.plugins)}removeScales(...t){this._each("unregister",t,this.scales)}_each(t,e,i){[...e].forEach((e=>{const s=i||this._getRegistryForType(e);i||s.isForType(e)||s===this.plugins&&e.id?this._exec(t,s,e):u(e,(e=>{const s=i||this._getRegistryForType(e);this._exec(t,s,e)}))}))}_exec(t,e,i){const s=w(t);d(i["before"+s],[],i),e[t](i),d(i["after"+s],[],i)}_getRegistryForType(t){for(let e=0;e<this._typedRegistries.length;e++){const i=this._typedRegistries[e];if(i.isForType(t))return i}return this.plugins}_get(t,e,i){const s=e.get(t);if(void 0===s)throw new Error('"'+t+'" is not a registered '+i+".");return s}}var nn=new sn;class on{constructor(){this._init=void 0}notify(t,e,i,s){if("beforeInit"===e&&(this._init=this._createDescriptors(t,!0),this._notify(this._init,t,"install")),void 0===this._init)return;const n=s?this._descriptors(t).filter(s):this._descriptors(t),o=this._notify(n,t,e,i);return"afterDestroy"===e&&(this._notify(n,t,"stop"),this._notify(this._init,t,"uninstall"),this._init=void 0),o}_notify(t,e,i,s){s=s||{};for(const n of t){const t=n.plugin;if(!1===d(t[i],[e,s,n.options],t)&&s.cancelable)return!1}return!0}invalidate(){s(this._cache)||(this._oldCache=this._cache,this._cache=void 0)}_descriptors(t){if(this._cache)return this._cache;const e=this._cache=this._createDescriptors(t);return this._notifyStateChanges(t),e}_createDescriptors(t,e){const i=t&&t.config,s=l(i.options&&i.options.plugins,{}),n=function(t){const e={},i=[],s=Object.keys(nn.plugins.items);for(let t=0;t<s.length;t++)i.push(nn.getPlugin(s[t]));const n=t.plugins||[];for(let t=0;t<n.length;t++){const s=n[t];-1===i.indexOf(s)&&(i.push(s),e[s.id]=!0)}return{plugins:i,localIds:e}}(i);return!1!==s||e?function(t,{plugins:e,localIds:i},s,n){const o=[],a=t.getContext();for(const r of e){const e=r.id,l=an(s[e],n);null!==l&&o.push({plugin:r,options:rn(t.config,{plugin:r,local:i[e]},l,a)})}return o}(t,n,s,e):[]}_notifyStateChanges(t){const e=this._oldCache||[],i=this._cache,s=(t,e)=>t.filter((t=>!e.some((e=>t.plugin.id===e.plugin.id))));this._notify(s(e,i),t,"stop"),this._notify(s(i,e),t,"start")}}function an(t,e){return e||!1!==t?!0===t?{}:t:null}function rn(t,{plugin:e,local:i},s,n){const o=t.pluginScopeKeys(e),a=t.getOptionScopes(s,o);return i&&e.defaults&&a.push(e.defaults),t.createResolver(a,n,[""],{scriptable:!1,indexable:!1,allKeys:!0})}function ln(t,e){const i=ue.datasets[t]||{};return((e.datasets||{})[t]||{}).indexAxis||e.indexAxis||i.indexAxis||"x"}function hn(t){if("x"===t||"y"===t||"r"===t)return t}function cn(t,...e){if(hn(t))return t;for(const s of e){const e=s.axis||("top"===(i=s.position)||"bottom"===i?"x":"left"===i||"right"===i?"y":void 0)||t.length>1&&hn(t[0].toLowerCase());if(e)return e}var i;throw new Error(`Cannot determine type of '${t}' axis. Please provide 'axis' or 'position' option.`)}function dn(t,e,i){if(i[e+"AxisID"]===t)return{axis:e}}function un(t,e){const i=re[t.type]||{scales:{}},s=e.scales||{},n=ln(t.type,e),a=Object.create(null);return Object.keys(s).forEach((e=>{const r=s[e];if(!o(r))return console.error(`Invalid scale configuration for scale: ${e}`);if(r._proxy)return console.warn(`Ignoring resolver passed as options for scale: ${e}`);const l=cn(e,r,function(t,e){if(e.data&&e.data.datasets){const i=e.data.datasets.filter((e=>e.xAxisID===t||e.yAxisID===t));if(i.length)return dn(t,"x",i[0])||dn(t,"y",i[0])}return{}}(e,t),ue.scales[r.type]),h=function(t,e){return t===e?"_index_":"_value_"}(l,n),c=i.scales||{};a[e]=b(Object.create(null),[{axis:l},r,c[l],c[h]])})),t.data.datasets.forEach((i=>{const n=i.type||t.type,o=i.indexAxis||ln(n,e),r=(re[n]||{}).scales||{};Object.keys(r).forEach((t=>{const e=function(t,e){let i=t;return"_index_"===t?i=e:"_value_"===t&&(i="x"===e?"y":"x"),i}(t,o),n=i[e+"AxisID"]||e;a[n]=a[n]||Object.create(null),b(a[n],[{axis:e},s[n],r[t]])}))})),Object.keys(a).forEach((t=>{const e=a[t];b(e,[ue.scales[e.type],ue.scale])})),a}function fn(t){const e=t.options||(t.options={});e.plugins=l(e.plugins,{}),e.scales=un(t,e)}function gn(t){return(t=t||{}).datasets=t.datasets||[],t.labels=t.labels||[],t}const pn=new Map,mn=new Set;function xn(t,e){let i=pn.get(t);return i||(i=e(),pn.set(t,i),mn.add(i)),i}const bn=(t,e,i)=>{const s=M(e,i);void 0!==s&&t.add(s)};class _n{constructor(t){this._config=function(t){return(t=t||{}).data=gn(t.data),fn(t),t}(t),this._scopeCache=new Map,this._resolverCache=new Map}get platform(){return this._config.platform}get type(){return this._config.type}set type(t){this._config.type=t}get data(){return this._config.data}set data(t){this._config.data=gn(t)}get options(){return this._config.options}set options(t){this._config.options=t}get plugins(){return this._config.plugins}update(){const t=this._config;this.clearCache(),fn(t)}clearCache(){this._scopeCache.clear(),this._resolverCache.clear()}datasetScopeKeys(t){return xn(t,(()=>[[`datasets.${t}`,""]]))}datasetAnimationScopeKeys(t,e){return xn(`${t}.transition.${e}`,(()=>[[`datasets.${t}.transitions.${e}`,`transitions.${e}`],[`datasets.${t}`,""]]))}datasetElementScopeKeys(t,e){return xn(`${t}-${e}`,(()=>[[`datasets.${t}.elements.${e}`,`datasets.${t}`,`elements.${e}`,""]]))}pluginScopeKeys(t){const e=t.id;return xn(`${this.type}-plugin-${e}`,(()=>[[`plugins.${e}`,...t.additionalOptionScopes||[]]]))}_cachedScopes(t,e){const i=this._scopeCache;let s=i.get(t);return s&&!e||(s=new Map,i.set(t,s)),s}getOptionScopes(t,e,i){const{options:s,type:n}=this,o=this._cachedScopes(t,i),a=o.get(e);if(a)return a;const r=new Set;e.forEach((e=>{t&&(r.add(t),e.forEach((e=>bn(r,t,e)))),e.forEach((t=>bn(r,s,t))),e.forEach((t=>bn(r,re[n]||{},t))),e.forEach((t=>bn(r,ue,t))),e.forEach((t=>bn(r,le,t)))}));const l=Array.from(r);return 0===l.length&&l.push(Object.create(null)),mn.has(e)&&o.set(e,l),l}chartOptionScopes(){const{options:t,type:e}=this;return[t,re[e]||{},ue.datasets[e]||{},{type:e},ue,le]}resolveNamedOptions(t,e,i,s=[""]){const o={$shared:!0},{resolver:a,subPrefixes:r}=yn(this._resolverCache,t,s);let l=a;if(function(t,e){const{isScriptable:i,isIndexable:s}=Ye(t);for(const o of e){const e=i(o),a=s(o),r=(a||e)&&t[o];if(e&&(S(r)||vn(r))||a&&n(r))return!0}return!1}(a,e)){o.$shared=!1;l=$e(a,i=S(i)?i():i,this.createResolver(t,i,r))}for(const t of e)o[t]=l[t];return o}createResolver(t,e,i=[""],s){const{resolver:n}=yn(this._resolverCache,t,i);return o(e)?$e(n,e,void 0,s):n}}function yn(t,e,i){let s=t.get(e);s||(s=new Map,t.set(e,s));const n=i.join();let o=s.get(n);if(!o){o={resolver:je(e,i),subPrefixes:i.filter((t=>!t.toLowerCase().includes("hover")))},s.set(n,o)}return o}const vn=t=>o(t)&&Object.getOwnPropertyNames(t).some((e=>S(t[e])));const Mn=["top","bottom","left","right","chartArea"];function wn(t,e){return"top"===t||"bottom"===t||-1===Mn.indexOf(t)&&"x"===e}function kn(t,e){return function(i,s){return i[t]===s[t]?i[e]-s[e]:i[t]-s[t]}}function Sn(t){const e=t.chart,i=e.options.animation;e.notifyPlugins("afterRender"),d(i&&i.onComplete,[t],e)}function Pn(t){const e=t.chart,i=e.options.animation;d(i&&i.onProgress,[t],e)}function Dn(t){return fe()&&"string"==typeof t?t=document.getElementById(t):t&&t.length&&(t=t[0]),t&&t.canvas&&(t=t.canvas),t}const Cn={},On=t=>{const e=Dn(t);return Object.values(Cn).filter((t=>t.canvas===e)).pop()};function An(t,e,i){const s=Object.keys(t);for(const n of s){const s=+n;if(s>=e){const o=t[n];delete t[n],(i>0||s>e)&&(t[s+i]=o)}}}class Tn{static defaults=ue;static instances=Cn;static overrides=re;static registry=nn;static version="4.5.1";static getChart=On;static register(...t){nn.add(...t),Ln()}static unregister(...t){nn.remove(...t),Ln()}constructor(t,e){const s=this.config=new _n(e),n=Dn(t),o=On(n);if(o)throw new Error("Canvas is already in use. Chart with ID '"+o.id+"' must be destroyed before the canvas with ID '"+o.canvas.id+"' can be reused.");const a=s.createResolver(s.chartOptionScopes(),this.getContext());this.platform=new(s.platform||Ps(n)),this.platform.updateConfig(s);const r=this.platform.acquireContext(n,a.aspectRatio),l=r&&r.canvas,h=l&&l.height,c=l&&l.width;this.id=i(),this.ctx=r,this.canvas=l,this.width=c,this.height=h,this._options=a,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this._plugins=new on,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=dt((t=>this.update(t)),a.resizeDelay||0),this._dataChanges=[],Cn[this.id]=this,r&&l?(bt.listen(this,"complete",Sn),bt.listen(this,"progress",Pn),this._initialize(),this.attached&&this.update()):console.error("Failed to create chart: can't acquire context from the given item")}get aspectRatio(){const{options:{aspectRatio:t,maintainAspectRatio:e},width:i,height:n,_aspectRatio:o}=this;return s(t)?e&&o?o:n?i/n:null:t}get data(){return this.config.data}set data(t){this.config.data=t}get options(){return this._options}set options(t){this.config.options=t}get registry(){return nn}_initialize(){return this.notifyPlugins("beforeInit"),this.options.responsive?this.resize():ke(this,this.options.devicePixelRatio),this.bindEvents(),this.notifyPlugins("afterInit"),this}clear(){return Te(this.canvas,this.ctx),this}stop(){return bt.stop(this),this}resize(t,e){bt.running(this)?this._resizeBeforeDraw={width:t,height:e}:this._resize(t,e)}_resize(t,e){const i=this.options,s=this.canvas,n=i.maintainAspectRatio&&this.aspectRatio,o=this.platform.getMaximumSize(s,t,e,n),a=i.devicePixelRatio||this.platform.getDevicePixelRatio(),r=this.width?"resize":"attach";this.width=o.width,this.height=o.height,this._aspectRatio=this.aspectRatio,ke(this,a,!0)&&(this.notifyPlugins("resize",{size:o}),d(i.onResize,[this,o],this),this.attached&&this._doResize(r)&&this.render())}ensureScalesHaveIDs(){u(this.options.scales||{},((t,e)=>{t.id=e}))}buildOrUpdateScales(){const t=this.options,e=t.scales,i=this.scales,s=Object.keys(i).reduce(((t,e)=>(t[e]=!1,t)),{});let n=[];e&&(n=n.concat(Object.keys(e).map((t=>{const i=e[t],s=cn(t,i),n="r"===s,o="x"===s;return{options:i,dposition:n?"chartArea":o?"bottom":"left",dtype:n?"radialLinear":o?"category":"linear"}})))),u(n,(e=>{const n=e.options,o=n.id,a=cn(o,n),r=l(n.type,e.dtype);void 0!==n.position&&wn(n.position,a)===wn(e.dposition)||(n.position=e.dposition),s[o]=!0;let h=null;if(o in i&&i[o].type===r)h=i[o];else{h=new(nn.getScale(r))({id:o,type:r,ctx:this.ctx,chart:this}),i[h.id]=h}h.init(n,t)})),u(s,((t,e)=>{t||delete i[e]})),u(i,(t=>{ls.configure(this,t,t.options),ls.addBox(this,t)}))}_updateMetasets(){const t=this._metasets,e=this.data.datasets.length,i=t.length;if(t.sort(((t,e)=>t.index-e.index)),i>e){for(let t=e;t<i;++t)this._destroyDatasetMeta(t);t.splice(e,i-e)}this._sortedMetasets=t.slice(0).sort(kn("order","index"))}_removeUnreferencedMetasets(){const{_metasets:t,data:{datasets:e}}=this;t.length>e.length&&delete this._stacks,t.forEach(((t,i)=>{0===e.filter((e=>e===t._dataset)).length&&this._destroyDatasetMeta(i)}))}buildOrUpdateControllers(){const t=[],e=this.data.datasets;let i,s;for(this._removeUnreferencedMetasets(),i=0,s=e.length;i<s;i++){const s=e[i];let n=this.getDatasetMeta(i);const o=s.type||this.config.type;if(n.type&&n.type!==o&&(this._destroyDatasetMeta(i),n=this.getDatasetMeta(i)),n.type=o,n.indexAxis=s.indexAxis||ln(o,this.options),n.order=s.order||0,n.index=i,n.label=""+s.label,n.visible=this.isDatasetVisible(i),n.controller)n.controller.updateIndex(i),n.controller.linkScales();else{const e=nn.getController(o),{datasetElementType:s,dataElementType:a}=ue.datasets[o];Object.assign(e,{dataElementType:nn.getElement(a),datasetElementType:s&&nn.getElement(s)}),n.controller=new e(this,i),t.push(n.controller)}}return this._updateMetasets(),t}_resetElements(){u(this.data.datasets,((t,e)=>{this.getDatasetMeta(e).controller.reset()}),this)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(t){const e=this.config;e.update();const i=this._options=e.createResolver(e.chartOptionScopes(),this.getContext()),s=this._animationsDisabled=!i.animation;if(this._updateScales(),this._checkEventBindings(),this._updateHiddenIndices(),this._plugins.invalidate(),!1===this.notifyPlugins("beforeUpdate",{mode:t,cancelable:!0}))return;const n=this.buildOrUpdateControllers();this.notifyPlugins("beforeElementsUpdate");let o=0;for(let t=0,e=this.data.datasets.length;t<e;t++){const{controller:e}=this.getDatasetMeta(t),i=!s&&-1===n.indexOf(e);e.buildOrUpdateElements(i),o=Math.max(+e.getMaxOverflow(),o)}o=this._minPadding=i.layout.autoPadding?o:0,this._updateLayout(o),s||u(n,(t=>{t.reset()})),this._updateDatasets(t),this.notifyPlugins("afterUpdate",{mode:t}),this._layers.sort(kn("z","_idx"));const{_active:a,_lastEvent:r}=this;r?this._eventHandler(r,!0):a.length&&this._updateHoverStyles(a,a,!0),this.render()}_updateScales(){u(this.scales,(t=>{ls.removeBox(this,t)})),this.ensureScalesHaveIDs(),this.buildOrUpdateScales()}_checkEventBindings(){const t=this.options,e=new Set(Object.keys(this._listeners)),i=new Set(t.events);P(e,i)&&!!this._responsiveListeners===t.responsive||(this.unbindEvents(),this.bindEvents())}_updateHiddenIndices(){const{_hiddenIndices:t}=this,e=this._getUniformDataChanges()||[];for(const{method:i,start:s,count:n}of e){An(t,s,"_removeElements"===i?-n:n)}}_getUniformDataChanges(){const t=this._dataChanges;if(!t||!t.length)return;this._dataChanges=[];const e=this.data.datasets.length,i=e=>new Set(t.filter((t=>t[0]===e)).map(((t,e)=>e+","+t.splice(1).join(",")))),s=i(0);for(let t=1;t<e;t++)if(!P(s,i(t)))return;return Array.from(s).map((t=>t.split(","))).map((t=>({method:t[1],start:+t[2],count:+t[3]})))}_updateLayout(t){if(!1===this.notifyPlugins("beforeLayout",{cancelable:!0}))return;ls.update(this,this.width,this.height,t);const e=this.chartArea,i=e.width<=0||e.height<=0;this._layers=[],u(this.boxes,(t=>{i&&"chartArea"===t.position||(t.configure&&t.configure(),this._layers.push(...t._layers()))}),this),this._layers.forEach(((t,e)=>{t._idx=e})),this.notifyPlugins("afterLayout")}_updateDatasets(t){if(!1!==this.notifyPlugins("beforeDatasetsUpdate",{mode:t,cancelable:!0})){for(let t=0,e=this.data.datasets.length;t<e;++t)this.getDatasetMeta(t).controller.configure();for(let e=0,i=this.data.datasets.length;e<i;++e)this._updateDataset(e,S(t)?t({datasetIndex:e}):t);this.notifyPlugins("afterDatasetsUpdate",{mode:t})}}_updateDataset(t,e){const i=this.getDatasetMeta(t),s={meta:i,index:t,mode:e,cancelable:!0};!1!==this.notifyPlugins("beforeDatasetUpdate",s)&&(i.controller._update(e),s.cancelable=!1,this.notifyPlugins("afterDatasetUpdate",s))}render(){!1!==this.notifyPlugins("beforeRender",{cancelable:!0})&&(bt.has(this)?this.attached&&!bt.running(this)&&bt.start(this):(this.draw(),Sn({chart:this})))}draw(){let t;if(this._resizeBeforeDraw){const{width:t,height:e}=this._resizeBeforeDraw;this._resizeBeforeDraw=null,this._resize(t,e)}if(this.clear(),this.width<=0||this.height<=0)return;if(!1===this.notifyPlugins("beforeDraw",{cancelable:!0}))return;const e=this._layers;for(t=0;t<e.length&&e[t].z<=0;++t)e[t].draw(this.chartArea);for(this._drawDatasets();t<e.length;++t)e[t].draw(this.chartArea);this.notifyPlugins("afterDraw")}_getSortedDatasetMetas(t){const e=this._sortedMetasets,i=[];let s,n;for(s=0,n=e.length;s<n;++s){const n=e[s];t&&!n.visible||i.push(n)}return i}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){if(!1===this.notifyPlugins("beforeDatasetsDraw",{cancelable:!0}))return;const t=this.getSortedVisibleDatasetMetas();for(let e=t.length-1;e>=0;--e)this._drawDataset(t[e]);this.notifyPlugins("afterDatasetsDraw")}_drawDataset(t){const e=this.ctx,i={meta:t,index:t.index,cancelable:!0},s=Ni(this,t);!1!==this.notifyPlugins("beforeDatasetDraw",i)&&(s&&Ie(e,s),t.controller.draw(),s&&ze(e),i.cancelable=!1,this.notifyPlugins("afterDatasetDraw",i))}isPointInArea(t){return Re(t,this.chartArea,this._minPadding)}getElementsAtEventForMode(t,e,i,s){const n=Ki.modes[e];return"function"==typeof n?n(this,t,i,s):[]}getDatasetMeta(t){const e=this.data.datasets[t],i=this._metasets;let s=i.filter((t=>t&&t._dataset===e)).pop();return s||(s={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:e&&e.order||0,index:t,_dataset:e,_parsed:[],_sorted:!1},i.push(s)),s}getContext(){return this.$context||(this.$context=Ci(null,{chart:this,type:"chart"}))}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(t){const e=this.data.datasets[t];if(!e)return!1;const i=this.getDatasetMeta(t);return"boolean"==typeof i.hidden?!i.hidden:!e.hidden}setDatasetVisibility(t,e){this.getDatasetMeta(t).hidden=!e}toggleDataVisibility(t){this._hiddenIndices[t]=!this._hiddenIndices[t]}getDataVisibility(t){return!this._hiddenIndices[t]}_updateVisibility(t,e,i){const s=i?"show":"hide",n=this.getDatasetMeta(t),o=n.controller._resolveAnimations(void 0,s);k(e)?(n.data[e].hidden=!i,this.update()):(this.setDatasetVisibility(t,i),o.update(n,{visible:i}),this.update((e=>e.datasetIndex===t?s:void 0)))}hide(t,e){this._updateVisibility(t,e,!1)}show(t,e){this._updateVisibility(t,e,!0)}_destroyDatasetMeta(t){const e=this._metasets[t];e&&e.controller&&e.controller._destroy(),delete this._metasets[t]}_stop(){let t,e;for(this.stop(),bt.remove(this),t=0,e=this.data.datasets.length;t<e;++t)this._destroyDatasetMeta(t)}destroy(){this.notifyPlugins("beforeDestroy");const{canvas:t,ctx:e}=this;this._stop(),this.config.clearCache(),t&&(this.unbindEvents(),Te(t,e),this.platform.releaseContext(e),this.canvas=null,this.ctx=null),delete Cn[this.id],this.notifyPlugins("afterDestroy")}toBase64Image(...t){return this.canvas.toDataURL(...t)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){const t=this._listeners,e=this.platform,i=(i,s)=>{e.addEventListener(this,i,s),t[i]=s},s=(t,e,i)=>{t.offsetX=e,t.offsetY=i,this._eventHandler(t)};u(this.options.events,(t=>i(t,s)))}bindResponsiveEvents(){this._responsiveListeners||(this._responsiveListeners={});const t=this._responsiveListeners,e=this.platform,i=(i,s)=>{e.addEventListener(this,i,s),t[i]=s},s=(i,s)=>{t[i]&&(e.removeEventListener(this,i,s),delete t[i])},n=(t,e)=>{this.canvas&&this.resize(t,e)};let o;const a=()=>{s("attach",a),this.attached=!0,this.resize(),i("resize",n),i("detach",o)};o=()=>{this.attached=!1,s("resize",n),this._stop(),this._resize(0,0),i("attach",a)},e.isAttached(this.canvas)?a():o()}unbindEvents(){u(this._listeners,((t,e)=>{this.platform.removeEventListener(this,e,t)})),this._listeners={},u(this._responsiveListeners,((t,e)=>{this.platform.removeEventListener(this,e,t)})),this._responsiveListeners=void 0}updateHoverStyle(t,e,i){const s=i?"set":"remove";let n,o,a,r;for("dataset"===e&&(n=this.getDatasetMeta(t[0].datasetIndex),n.controller["_"+s+"DatasetHoverStyle"]()),a=0,r=t.length;a<r;++a){o=t[a];const e=o&&this.getDatasetMeta(o.datasetIndex).controller;e&&e[s+"HoverStyle"](o.element,o.datasetIndex,o.index)}}getActiveElements(){return this._active||[]}setActiveElements(t){const e=this._active||[],i=t.map((({datasetIndex:t,index:e})=>{const i=this.getDatasetMeta(t);if(!i)throw new Error("No dataset found at index "+t);return{datasetIndex:t,element:i.data[e],index:e}}));!f(i,e)&&(this._active=i,this._lastEvent=null,this._updateHoverStyles(i,e))}notifyPlugins(t,e,i){return this._plugins.notify(this,t,e,i)}isPluginEnabled(t){return 1===this._plugins._cache.filter((e=>e.plugin.id===t)).length}_updateHoverStyles(t,e,i){const s=this.options.hover,n=(t,e)=>t.filter((t=>!e.some((e=>t.datasetIndex===e.datasetIndex&&t.index===e.index)))),o=n(e,t),a=i?t:n(t,e);o.length&&this.updateHoverStyle(o,s.mode,!1),a.length&&s.mode&&this.updateHoverStyle(a,s.mode,!0)}_eventHandler(t,e){const i={event:t,replay:e,cancelable:!0,inChartArea:this.isPointInArea(t)},s=e=>(e.options.events||this.options.events).includes(t.native.type);if(!1===this.notifyPlugins("beforeEvent",i,s))return;const n=this._handleEvent(t,e,i.inChartArea);return i.cancelable=!1,this.notifyPlugins("afterEvent",i,s),(n||i.changed)&&this.render(),this}_handleEvent(t,e,i){const{_active:s=[],options:n}=this,o=e,a=this._getActiveElements(t,s,i,o),r=D(t),l=function(t,e,i,s){return i&&"mouseout"!==t.type?s?e:t:null}(t,this._lastEvent,i,r);i&&(this._lastEvent=null,d(n.onHover,[t,a,this],this),r&&d(n.onClick,[t,a,this],this));const h=!f(a,s);return(h||e)&&(this._active=a,this._updateHoverStyles(a,s,e)),this._lastEvent=l,h}_getActiveElements(t,e,i,s){if("mouseout"===t.type)return[];if(!i)return e;const n=this.options.hover;return this.getElementsAtEventForMode(t,n.mode,n,s)}}function Ln(){return u(Tn.instances,(t=>t._plugins.invalidate()))}function En(){throw new Error("This method is not implemented: Check that a complete date adapter is provided.")}class Rn{static override(t){Object.assign(Rn.prototype,t)}options;constructor(t){this.options=t||{}}init(){}formats(){return En()}parse(){return En()}format(){return En()}add(){return En()}diff(){return En()}startOf(){return En()}endOf(){return En()}}var In={_date:Rn};function zn(t){const e=t.iScale,i=function(t,e){if(!t._cache.$bar){const i=t.getMatchingVisibleMetas(e);let s=[];for(let e=0,n=i.length;e<n;e++)s=s.concat(i[e].controller.getAllParsedValues(t));t._cache.$bar=lt(s.sort(((t,e)=>t-e)))}return t._cache.$bar}(e,t.type);let s,n,o,a,r=e._length;const l=()=>{32767!==o&&-32768!==o&&(k(a)&&(r=Math.min(r,Math.abs(o-a)||r)),a=o)};for(s=0,n=i.length;s<n;++s)o=e.getPixelForValue(i[s]),l();for(a=void 0,s=0,n=e.ticks.length;s<n;++s)o=e.getPixelForTick(s),l();return r}function Fn(t,e,i,s){return n(t)?function(t,e,i,s){const n=i.parse(t[0],s),o=i.parse(t[1],s),a=Math.min(n,o),r=Math.max(n,o);let l=a,h=r;Math.abs(a)>Math.abs(r)&&(l=r,h=a),e[i.axis]=h,e._custom={barStart:l,barEnd:h,start:n,end:o,min:a,max:r}}(t,e,i,s):e[i.axis]=i.parse(t,s),e}function Vn(t,e,i,s){const n=t.iScale,o=t.vScale,a=n.getLabels(),r=n===o,l=[];let h,c,d,u;for(h=i,c=i+s;h<c;++h)u=e[h],d={},d[n.axis]=r||n.parse(a[h],h),l.push(Fn(u,d,o,h));return l}function Bn(t){return t&&void 0!==t.barStart&&void 0!==t.barEnd}function Wn(t,e,i,s){let n=e.borderSkipped;const o={};if(!n)return void(t.borderSkipped=o);if(!0===n)return void(t.borderSkipped={top:!0,right:!0,bottom:!0,left:!0});const{start:a,end:r,reverse:l,top:h,bottom:c}=function(t){let e,i,s,n,o;return t.horizontal?(e=t.base>t.x,i="left",s="right"):(e=t.base<t.y,i="bottom",s="top"),e?(n="end",o="start"):(n="start",o="end"),{start:i,end:s,reverse:e,top:n,bottom:o}}(t);"middle"===n&&i&&(t.enableBorderRadius=!0,(i._top||0)===s?n=h:(i._bottom||0)===s?n=c:(o[Nn(c,a,r,l)]=!0,n=h)),o[Nn(n,a,r,l)]=!0,t.borderSkipped=o}function Nn(t,e,i,s){var n,o,a;return s?(a=i,t=Hn(t=(n=t)===(o=e)?a:n===a?o:n,i,e)):t=Hn(t,e,i),t}function Hn(t,e,i){return"start"===t?e:"end"===t?i:t}function jn(t,{inflateAmount:e},i){t.inflateAmount="auto"===e?1===i?.33:0:e}class $n extends js{static id="doughnut";static defaults={datasetElementType:!1,dataElementType:"arc",animation:{animateRotate:!0,animateScale:!1},animations:{numbers:{type:"number",properties:["circumference","endAngle","innerRadius","outerRadius","startAngle","x","y","offset","borderWidth","spacing"]}},cutout:"50%",rotation:0,circumference:360,radius:"100%",spacing:0,indexAxis:"r"};static descriptors={_scriptable:t=>"spacing"!==t,_indexable:t=>"spacing"!==t&&!t.startsWith("borderDash")&&!t.startsWith("hoverBorderDash")};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){const e=t.data,{labels:{pointStyle:i,textAlign:s,color:n,useBorderRadius:o,borderRadius:a}}=t.legend.options;return e.labels.length&&e.datasets.length?e.labels.map(((e,r)=>{const l=t.getDatasetMeta(0).controller.getStyle(r);return{text:e,fillStyle:l.backgroundColor,fontColor:n,hidden:!t.getDataVisibility(r),lineDash:l.borderDash,lineDashOffset:l.borderDashOffset,lineJoin:l.borderJoinStyle,lineWidth:l.borderWidth,strokeStyle:l.borderColor,textAlign:s,pointStyle:i,borderRadius:o&&(a||l.borderRadius),index:r}})):[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}}};constructor(t,e){super(t,e),this.enableOptionSharing=!0,this.innerRadius=void 0,this.outerRadius=void 0,this.offsetX=void 0,this.offsetY=void 0}linkScales(){}parse(t,e){const i=this.getDataset().data,s=this._cachedMeta;if(!1===this._parsing)s._parsed=i;else{let n,a,r=t=>+i[t];if(o(i[t])){const{key:t="value"}=this._parsing;r=e=>+M(i[e],t)}for(n=t,a=t+e;n<a;++n)s._parsed[n]=r(n)}}_getRotation(){return $(this.options.rotation-90)}_getCircumference(){return $(this.options.circumference)}_getRotationExtents(){let t=O,e=-O;for(let i=0;i<this.chart.data.datasets.length;++i)if(this.chart.isDatasetVisible(i)&&this.chart.getDatasetMeta(i).type===this._type){const s=this.chart.getDatasetMeta(i).controller,n=s._getRotation(),o=s._getCircumference();t=Math.min(t,n),e=Math.max(e,n+o)}return{rotation:t,circumference:e-t}}update(t){const e=this.chart,{chartArea:i}=e,s=this._cachedMeta,n=s.data,o=this.getMaxBorderWidth()+this.getMaxOffset(n)+this.options.spacing,a=Math.max((Math.min(i.width,i.height)-o)/2,0),r=Math.min(h(this.options.cutout,a),1),l=this._getRingWeight(this.index),{circumference:d,rotation:u}=this._getRotationExtents(),{ratioX:f,ratioY:g,offsetX:p,offsetY:m}=function(t,e,i){let s=1,n=1,o=0,a=0;if(e<O){const r=t,l=r+e,h=Math.cos(r),c=Math.sin(r),d=Math.cos(l),u=Math.sin(l),f=(t,e,s)=>J(t,r,l,!0)?1:Math.max(e,e*i,s,s*i),g=(t,e,s)=>J(t,r,l,!0)?-1:Math.min(e,e*i,s,s*i),p=f(0,h,d),m=f(E,c,u),x=g(C,h,d),b=g(C+E,c,u);s=(p-x)/2,n=(m-b)/2,o=-(p+x)/2,a=-(m+b)/2}return{ratioX:s,ratioY:n,offsetX:o,offsetY:a}}(u,d,r),x=(i.width-o)/f,b=(i.height-o)/g,_=Math.max(Math.min(x,b)/2,0),y=c(this.options.radius,_),v=(y-Math.max(y*r,0))/this._getVisibleDatasetWeightTotal();this.offsetX=p*y,this.offsetY=m*y,s.total=this.calculateTotal(),this.outerRadius=y-v*this._getRingWeightOffset(this.index),this.innerRadius=Math.max(this.outerRadius-v*l,0),this.updateElements(n,0,n.length,t)}_circumference(t,e){const i=this.options,s=this._cachedMeta,n=this._getCircumference();return e&&i.animation.animateRotate||!this.chart.getDataVisibility(t)||null===s._parsed[t]||s.data[t].hidden?0:this.calculateCircumference(s._parsed[t]*n/O)}updateElements(t,e,i,s){const n="reset"===s,o=this.chart,a=o.chartArea,r=o.options.animation,l=(a.left+a.right)/2,h=(a.top+a.bottom)/2,c=n&&r.animateScale,d=c?0:this.innerRadius,u=c?0:this.outerRadius,{sharedOptions:f,includeOptions:g}=this._getSharedOptions(e,s);let p,m=this._getRotation();for(p=0;p<e;++p)m+=this._circumference(p,n);for(p=e;p<e+i;++p){const e=this._circumference(p,n),i=t[p],o={x:l+this.offsetX,y:h+this.offsetY,startAngle:m,endAngle:m+e,circumference:e,outerRadius:u,innerRadius:d};g&&(o.options=f||this.resolveDataElementOptions(p,i.active?"active":s)),m+=e,this.updateElement(i,p,o,s)}}calculateTotal(){const t=this._cachedMeta,e=t.data;let i,s=0;for(i=0;i<e.length;i++){const n=t._parsed[i];null===n||isNaN(n)||!this.chart.getDataVisibility(i)||e[i].hidden||(s+=Math.abs(n))}return s}calculateCircumference(t){const e=this._cachedMeta.total;return e>0&&!isNaN(t)?O*(Math.abs(t)/e):0}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart,s=i.data.labels||[],n=ne(e._parsed[t],i.options.locale);return{label:s[t]||"",value:n}}getMaxBorderWidth(t){let e=0;const i=this.chart;let s,n,o,a,r;if(!t)for(s=0,n=i.data.datasets.length;s<n;++s)if(i.isDatasetVisible(s)){o=i.getDatasetMeta(s),t=o.data,a=o.controller;break}if(!t)return 0;for(s=0,n=t.length;s<n;++s)r=a.resolveDataElementOptions(s),"inner"!==r.borderAlign&&(e=Math.max(e,r.borderWidth||0,r.hoverBorderWidth||0));return e}getMaxOffset(t){let e=0;for(let i=0,s=t.length;i<s;++i){const t=this.resolveDataElementOptions(i);e=Math.max(e,t.offset||0,t.hoverOffset||0)}return e}_getRingWeightOffset(t){let e=0;for(let i=0;i<t;++i)this.chart.isDatasetVisible(i)&&(e+=this._getRingWeight(i));return e}_getRingWeight(t){return Math.max(l(this.chart.data.datasets[t].weight,1),0)}_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1}}class Yn extends js{static id="polarArea";static defaults={dataElementType:"arc",animation:{animateRotate:!0,animateScale:!0},animations:{numbers:{type:"number",properties:["x","y","startAngle","endAngle","innerRadius","outerRadius"]}},indexAxis:"r",startAngle:0};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(t){const e=t.data;if(e.labels.length&&e.datasets.length){const{labels:{pointStyle:i,color:s}}=t.legend.options;return e.labels.map(((e,n)=>{const o=t.getDatasetMeta(0).controller.getStyle(n);return{text:e,fillStyle:o.backgroundColor,strokeStyle:o.borderColor,fontColor:s,lineWidth:o.borderWidth,pointStyle:i,hidden:!t.getDataVisibility(n),index:n}}))}return[]}},onClick(t,e,i){i.chart.toggleDataVisibility(e.index),i.chart.update()}}},scales:{r:{type:"radialLinear",angleLines:{display:!1},beginAtZero:!0,grid:{circular:!0},pointLabels:{display:!1},startAngle:0}}};constructor(t,e){super(t,e),this.innerRadius=void 0,this.outerRadius=void 0}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart,s=i.data.labels||[],n=ne(e._parsed[t].r,i.options.locale);return{label:s[t]||"",value:n}}parseObjectData(t,e,i,s){return ii.bind(this)(t,e,i,s)}update(t){const e=this._cachedMeta.data;this._updateRadius(),this.updateElements(e,0,e.length,t)}getMinMax(){const t=this._cachedMeta,e={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};return t.data.forEach(((t,i)=>{const s=this.getParsed(i).r;!isNaN(s)&&this.chart.getDataVisibility(i)&&(s<e.min&&(e.min=s),s>e.max&&(e.max=s))})),e}_updateRadius(){const t=this.chart,e=t.chartArea,i=t.options,s=Math.min(e.right-e.left,e.bottom-e.top),n=Math.max(s/2,0),o=(n-Math.max(i.cutoutPercentage?n/100*i.cutoutPercentage:1,0))/t.getVisibleDatasetCount();this.outerRadius=n-o*this.index,this.innerRadius=this.outerRadius-o}updateElements(t,e,i,s){const n="reset"===s,o=this.chart,a=o.options.animation,r=this._cachedMeta.rScale,l=r.xCenter,h=r.yCenter,c=r.getIndexAngle(0)-.5*C;let d,u=c;const f=360/this.countVisibleElements();for(d=0;d<e;++d)u+=this._computeAngle(d,s,f);for(d=e;d<e+i;d++){const e=t[d];let i=u,g=u+this._computeAngle(d,s,f),p=o.getDataVisibility(d)?r.getDistanceFromCenterForValue(this.getParsed(d).r):0;u=g,n&&(a.animateScale&&(p=0),a.animateRotate&&(i=g=c));const m={x:l,y:h,innerRadius:0,outerRadius:p,startAngle:i,endAngle:g,options:this.resolveDataElementOptions(d,e.active?"active":s)};this.updateElement(e,d,m,s)}}countVisibleElements(){const t=this._cachedMeta;let e=0;return t.data.forEach(((t,i)=>{!isNaN(this.getParsed(i).r)&&this.chart.getDataVisibility(i)&&e++})),e}_computeAngle(t,e,i){return this.chart.getDataVisibility(t)?$(this.resolveDataElementOptions(t,e).angle||i):0}}var Un=Object.freeze({__proto__:null,BarController:class extends js{static id="bar";static defaults={datasetElementType:!1,dataElementType:"bar",categoryPercentage:.8,barPercentage:.9,grouped:!0,animations:{numbers:{type:"number",properties:["x","y","base","width","height"]}}};static overrides={scales:{_index_:{type:"category",offset:!0,grid:{offset:!0}},_value_:{type:"linear",beginAtZero:!0}}};parsePrimitiveData(t,e,i,s){return Vn(t,e,i,s)}parseArrayData(t,e,i,s){return Vn(t,e,i,s)}parseObjectData(t,e,i,s){const{iScale:n,vScale:o}=t,{xAxisKey:a="x",yAxisKey:r="y"}=this._parsing,l="x"===n.axis?a:r,h="x"===o.axis?a:r,c=[];let d,u,f,g;for(d=i,u=i+s;d<u;++d)g=e[d],f={},f[n.axis]=n.parse(M(g,l),d),c.push(Fn(M(g,h),f,o,d));return c}updateRangeFromParsed(t,e,i,s){super.updateRangeFromParsed(t,e,i,s);const n=i._custom;n&&e===this._cachedMeta.vScale&&(t.min=Math.min(t.min,n.min),t.max=Math.max(t.max,n.max))}getMaxOverflow(){return 0}getLabelAndValue(t){const e=this._cachedMeta,{iScale:i,vScale:s}=e,n=this.getParsed(t),o=n._custom,a=Bn(o)?"["+o.start+", "+o.end+"]":""+s.getLabelForValue(n[s.axis]);return{label:""+i.getLabelForValue(n[i.axis]),value:a}}initialize(){this.enableOptionSharing=!0,super.initialize();this._cachedMeta.stack=this.getDataset().stack}update(t){const e=this._cachedMeta;this.updateElements(e.data,0,e.data.length,t)}updateElements(t,e,i,n){const o="reset"===n,{index:a,_cachedMeta:{vScale:r}}=this,l=r.getBasePixel(),h=r.isHorizontal(),c=this._getRuler(),{sharedOptions:d,includeOptions:u}=this._getSharedOptions(e,n);for(let f=e;f<e+i;f++){const e=this.getParsed(f),i=o||s(e[r.axis])?{base:l,head:l}:this._calculateBarValuePixels(f),g=this._calculateBarIndexPixels(f,c),p=(e._stacks||{})[r.axis],m={horizontal:h,base:i.base,enableBorderRadius:!p||Bn(e._custom)||a===p._top||a===p._bottom,x:h?i.head:g.center,y:h?g.center:i.head,height:h?g.size:Math.abs(i.size),width:h?Math.abs(i.size):g.size};u&&(m.options=d||this.resolveDataElementOptions(f,t[f].active?"active":n));const x=m.options||t[f].options;Wn(m,x,p,a),jn(m,x,c.ratio),this.updateElement(t[f],f,m,n)}}_getStacks(t,e){const{iScale:i}=this._cachedMeta,n=i.getMatchingVisibleMetas(this._type).filter((t=>t.controller.options.grouped)),o=i.options.stacked,a=[],r=this._cachedMeta.controller.getParsed(e),l=r&&r[i.axis],h=t=>{const e=t._parsed.find((t=>t[i.axis]===l)),n=e&&e[t.vScale.axis];if(s(n)||isNaN(n))return!0};for(const i of n)if((void 0===e||!h(i))&&((!1===o||-1===a.indexOf(i.stack)||void 0===o&&void 0===i.stack)&&a.push(i.stack),i.index===t))break;return a.length||a.push(void 0),a}_getStackCount(t){return this._getStacks(void 0,t).length}_getAxisCount(){return this._getAxis().length}getFirstScaleIdForIndexAxis(){const t=this.chart.scales,e=this.chart.options.indexAxis;return Object.keys(t).filter((i=>t[i].axis===e)).shift()}_getAxis(){const t={},e=this.getFirstScaleIdForIndexAxis();for(const i of this.chart.data.datasets)t[l("x"===this.chart.options.indexAxis?i.xAxisID:i.yAxisID,e)]=!0;return Object.keys(t)}_getStackIndex(t,e,i){const s=this._getStacks(t,i),n=void 0!==e?s.indexOf(e):-1;return-1===n?s.length-1:n}_getRuler(){const t=this.options,e=this._cachedMeta,i=e.iScale,s=[];let n,o;for(n=0,o=e.data.length;n<o;++n)s.push(i.getPixelForValue(this.getParsed(n)[i.axis],n));const a=t.barThickness;return{min:a||zn(e),pixels:s,start:i._startPixel,end:i._endPixel,stackCount:this._getStackCount(),scale:i,grouped:t.grouped,ratio:a?1:t.categoryPercentage*t.barPercentage}}_calculateBarValuePixels(t){const{_cachedMeta:{vScale:e,_stacked:i,index:n},options:{base:o,minBarLength:a}}=this,r=o||0,l=this.getParsed(t),h=l._custom,c=Bn(h);let d,u,f=l[e.axis],g=0,p=i?this.applyStack(e,l,i):f;p!==f&&(g=p-f,p=f),c&&(f=h.barStart,p=h.barEnd-h.barStart,0!==f&&F(f)!==F(h.barEnd)&&(g=0),g+=f);const m=s(o)||c?g:o;let x=e.getPixelForValue(m);if(d=this.chart.getDataVisibility(t)?e.getPixelForValue(g+p):x,u=d-x,Math.abs(u)<a){u=function(t,e,i){return 0!==t?F(t):(e.isHorizontal()?1:-1)*(e.min>=i?1:-1)}(u,e,r)*a,f===r&&(x-=u/2);const t=e.getPixelForDecimal(0),s=e.getPixelForDecimal(1),o=Math.min(t,s),h=Math.max(t,s);x=Math.max(Math.min(x,h),o),d=x+u,i&&!c&&(l._stacks[e.axis]._visualValues[n]=e.getValueForPixel(d)-e.getValueForPixel(x))}if(x===e.getPixelForValue(r)){const t=F(u)*e.getLineWidthForValue(r)/2;x+=t,u-=t}return{size:u,base:x,head:d,center:d+u/2}}_calculateBarIndexPixels(t,e){const i=e.scale,n=this.options,o=n.skipNull,a=l(n.maxBarThickness,1/0);let r,h;const c=this._getAxisCount();if(e.grouped){const i=o?this._getStackCount(t):e.stackCount,d="flex"===n.barThickness?function(t,e,i,s){const n=e.pixels,o=n[t];let a=t>0?n[t-1]:null,r=t<n.length-1?n[t+1]:null;const l=i.categoryPercentage;null===a&&(a=o-(null===r?e.end-e.start:r-o)),null===r&&(r=o+o-a);const h=o-(o-Math.min(a,r))/2*l;return{chunk:Math.abs(r-a)/2*l/s,ratio:i.barPercentage,start:h}}(t,e,n,i*c):function(t,e,i,n){const o=i.barThickness;let a,r;return s(o)?(a=e.min*i.categoryPercentage,r=i.barPercentage):(a=o*n,r=1),{chunk:a/n,ratio:r,start:e.pixels[t]-a/2}}(t,e,n,i*c),u="x"===this.chart.options.indexAxis?this.getDataset().xAxisID:this.getDataset().yAxisID,f=this._getAxis().indexOf(l(u,this.getFirstScaleIdForIndexAxis())),g=this._getStackIndex(this.index,this._cachedMeta.stack,o?t:void 0)+f;r=d.start+d.chunk*g+d.chunk/2,h=Math.min(a,d.chunk*d.ratio)}else r=i.getPixelForValue(this.getParsed(t)[i.axis],t),h=Math.min(a,e.min*e.ratio);return{base:r-h/2,head:r+h/2,center:r,size:h}}draw(){const t=this._cachedMeta,e=t.vScale,i=t.data,s=i.length;let n=0;for(;n<s;++n)null===this.getParsed(n)[e.axis]||i[n].hidden||i[n].draw(this._ctx)}},BubbleController:class extends js{static id="bubble";static defaults={datasetElementType:!1,dataElementType:"point",animations:{numbers:{type:"number",properties:["x","y","borderWidth","radius"]}}};static overrides={scales:{x:{type:"linear"},y:{type:"linear"}}};initialize(){this.enableOptionSharing=!0,super.initialize()}parsePrimitiveData(t,e,i,s){const n=super.parsePrimitiveData(t,e,i,s);for(let t=0;t<n.length;t++)n[t]._custom=this.resolveDataElementOptions(t+i).radius;return n}parseArrayData(t,e,i,s){const n=super.parseArrayData(t,e,i,s);for(let t=0;t<n.length;t++){const s=e[i+t];n[t]._custom=l(s[2],this.resolveDataElementOptions(t+i).radius)}return n}parseObjectData(t,e,i,s){const n=super.parseObjectData(t,e,i,s);for(let t=0;t<n.length;t++){const s=e[i+t];n[t]._custom=l(s&&s.r&&+s.r,this.resolveDataElementOptions(t+i).radius)}return n}getMaxOverflow(){const t=this._cachedMeta.data;let e=0;for(let i=t.length-1;i>=0;--i)e=Math.max(e,t[i].size(this.resolveDataElementOptions(i))/2);return e>0&&e}getLabelAndValue(t){const e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:s,yScale:n}=e,o=this.getParsed(t),a=s.getLabelForValue(o.x),r=n.getLabelForValue(o.y),l=o._custom;return{label:i[t]||"",value:"("+a+", "+r+(l?", "+l:"")+")"}}update(t){const e=this._cachedMeta.data;this.updateElements(e,0,e.length,t)}updateElements(t,e,i,s){const n="reset"===s,{iScale:o,vScale:a}=this._cachedMeta,{sharedOptions:r,includeOptions:l}=this._getSharedOptions(e,s),h=o.axis,c=a.axis;for(let d=e;d<e+i;d++){const e=t[d],i=!n&&this.getParsed(d),u={},f=u[h]=n?o.getPixelForDecimal(.5):o.getPixelForValue(i[h]),g=u[c]=n?a.getBasePixel():a.getPixelForValue(i[c]);u.skip=isNaN(f)||isNaN(g),l&&(u.options=r||this.resolveDataElementOptions(d,e.active?"active":s),n&&(u.options.radius=0)),this.updateElement(e,d,u,s)}}resolveDataElementOptions(t,e){const i=this.getParsed(t);let s=super.resolveDataElementOptions(t,e);s.$shared&&(s=Object.assign({},s,{$shared:!1}));const n=s.radius;return"active"!==e&&(s.radius=0),s.radius+=l(i&&i._custom,n),s}},DoughnutController:$n,LineController:class extends js{static id="line";static defaults={datasetElementType:"line",dataElementType:"point",showLine:!0,spanGaps:!1};static overrides={scales:{_index_:{type:"category"},_value_:{type:"linear"}}};initialize(){this.enableOptionSharing=!0,this.supportsDecimation=!0,super.initialize()}update(t){const e=this._cachedMeta,{dataset:i,data:s=[],_dataset:n}=e,o=this.chart._animationsDisabled;let{start:a,count:r}=pt(e,s,o);this._drawStart=a,this._drawCount=r,mt(e)&&(a=0,r=s.length),i._chart=this.chart,i._datasetIndex=this.index,i._decimated=!!n._decimated,i.points=s;const l=this.resolveDatasetElementOptions(t);this.options.showLine||(l.borderWidth=0),l.segment=this.options.segment,this.updateElement(i,void 0,{animated:!o,options:l},t),this.updateElements(s,a,r,t)}updateElements(t,e,i,n){const o="reset"===n,{iScale:a,vScale:r,_stacked:l,_dataset:h}=this._cachedMeta,{sharedOptions:c,includeOptions:d}=this._getSharedOptions(e,n),u=a.axis,f=r.axis,{spanGaps:g,segment:p}=this.options,m=N(g)?g:Number.POSITIVE_INFINITY,x=this.chart._animationsDisabled||o||"none"===n,b=e+i,_=t.length;let y=e>0&&this.getParsed(e-1);for(let i=0;i<_;++i){const g=t[i],_=x?g:{};if(i<e||i>=b){_.skip=!0;continue}const v=this.getParsed(i),M=s(v[f]),w=_[u]=a.getPixelForValue(v[u],i),k=_[f]=o||M?r.getBasePixel():r.getPixelForValue(l?this.applyStack(r,v,l):v[f],i);_.skip=isNaN(w)||isNaN(k)||M,_.stop=i>0&&Math.abs(v[u]-y[u])>m,p&&(_.parsed=v,_.raw=h.data[i]),d&&(_.options=c||this.resolveDataElementOptions(i,g.active?"active":n)),x||this.updateElement(g,i,_,n),y=v}}getMaxOverflow(){const t=this._cachedMeta,e=t.dataset,i=e.options&&e.options.borderWidth||0,s=t.data||[];if(!s.length)return i;const n=s[0].size(this.resolveDataElementOptions(0)),o=s[s.length-1].size(this.resolveDataElementOptions(s.length-1));return Math.max(i,n,o)/2}draw(){const t=this._cachedMeta;t.dataset.updateControlPoints(this.chart.chartArea,t.iScale.axis),super.draw()}},PieController:class extends $n{static id="pie";static defaults={cutout:0,rotation:0,circumference:360,radius:"100%"}},PolarAreaController:Yn,RadarController:class extends js{static id="radar";static defaults={datasetElementType:"line",dataElementType:"point",indexAxis:"r",showLine:!0,elements:{line:{fill:"start"}}};static overrides={aspectRatio:1,scales:{r:{type:"radialLinear"}}};getLabelAndValue(t){const e=this._cachedMeta.vScale,i=this.getParsed(t);return{label:e.getLabels()[t],value:""+e.getLabelForValue(i[e.axis])}}parseObjectData(t,e,i,s){return ii.bind(this)(t,e,i,s)}update(t){const e=this._cachedMeta,i=e.dataset,s=e.data||[],n=e.iScale.getLabels();if(i.points=s,"resize"!==t){const e=this.resolveDatasetElementOptions(t);this.options.showLine||(e.borderWidth=0);const o={_loop:!0,_fullLoop:n.length===s.length,options:e};this.updateElement(i,void 0,o,t)}this.updateElements(s,0,s.length,t)}updateElements(t,e,i,s){const n=this._cachedMeta.rScale,o="reset"===s;for(let a=e;a<e+i;a++){const e=t[a],i=this.resolveDataElementOptions(a,e.active?"active":s),r=n.getPointPositionForValue(a,this.getParsed(a).r),l=o?n.xCenter:r.x,h=o?n.yCenter:r.y,c={x:l,y:h,angle:r.angle,skip:isNaN(l)||isNaN(h),options:i};this.updateElement(e,a,c,s)}}},ScatterController:class extends js{static id="scatter";static defaults={datasetElementType:!1,dataElementType:"point",showLine:!1,fill:!1};static overrides={interaction:{mode:"point"},scales:{x:{type:"linear"},y:{type:"linear"}}};getLabelAndValue(t){const e=this._cachedMeta,i=this.chart.data.labels||[],{xScale:s,yScale:n}=e,o=this.getParsed(t),a=s.getLabelForValue(o.x),r=n.getLabelForValue(o.y);return{label:i[t]||"",value:"("+a+", "+r+")"}}update(t){const e=this._cachedMeta,{data:i=[]}=e,s=this.chart._animationsDisabled;let{start:n,count:o}=pt(e,i,s);if(this._drawStart=n,this._drawCount=o,mt(e)&&(n=0,o=i.length),this.options.showLine){this.datasetElementType||this.addElements();const{dataset:n,_dataset:o}=e;n._chart=this.chart,n._datasetIndex=this.index,n._decimated=!!o._decimated,n.points=i;const a=this.resolveDatasetElementOptions(t);a.segment=this.options.segment,this.updateElement(n,void 0,{animated:!s,options:a},t)}else this.datasetElementType&&(delete e.dataset,this.datasetElementType=!1);this.updateElements(i,n,o,t)}addElements(){const{showLine:t}=this.options;!this.datasetElementType&&t&&(this.datasetElementType=this.chart.registry.getElement("line")),super.addElements()}updateElements(t,e,i,n){const o="reset"===n,{iScale:a,vScale:r,_stacked:l,_dataset:h}=this._cachedMeta,c=this.resolveDataElementOptions(e,n),d=this.getSharedOptions(c),u=this.includeOptions(n,d),f=a.axis,g=r.axis,{spanGaps:p,segment:m}=this.options,x=N(p)?p:Number.POSITIVE_INFINITY,b=this.chart._animationsDisabled||o||"none"===n;let _=e>0&&this.getParsed(e-1);for(let c=e;c<e+i;++c){const e=t[c],i=this.getParsed(c),p=b?e:{},y=s(i[g]),v=p[f]=a.getPixelForValue(i[f],c),M=p[g]=o||y?r.getBasePixel():r.getPixelForValue(l?this.applyStack(r,i,l):i[g],c);p.skip=isNaN(v)||isNaN(M)||y,p.stop=c>0&&Math.abs(i[f]-_[f])>x,m&&(p.parsed=i,p.raw=h.data[c]),u&&(p.options=d||this.resolveDataElementOptions(c,e.active?"active":n)),b||this.updateElement(e,c,p,n),_=i}this.updateSharedOptions(d,n,c)}getMaxOverflow(){const t=this._cachedMeta,e=t.data||[];if(!this.options.showLine){let t=0;for(let i=e.length-1;i>=0;--i)t=Math.max(t,e[i].size(this.resolveDataElementOptions(i))/2);return t>0&&t}const i=t.dataset,s=i.options&&i.options.borderWidth||0;if(!e.length)return s;const n=e[0].size(this.resolveDataElementOptions(0)),o=e[e.length-1].size(this.resolveDataElementOptions(e.length-1));return Math.max(s,n,o)/2}}});function Xn(t,e,i,s){const n=vi(t.options.borderRadius,["outerStart","outerEnd","innerStart","innerEnd"]);const o=(i-e)/2,a=Math.min(o,s*e/2),r=t=>{const e=(i-Math.min(o,t))*s/2;return Z(t,0,Math.min(o,e))};return{outerStart:r(n.outerStart),outerEnd:r(n.outerEnd),innerStart:Z(n.innerStart,0,a),innerEnd:Z(n.innerEnd,0,a)}}function qn(t,e,i,s){return{x:i+t*Math.cos(e),y:s+t*Math.sin(e)}}function Kn(t,e,i,s,n,o){const{x:a,y:r,startAngle:l,pixelMargin:h,innerRadius:c}=e,d=Math.max(e.outerRadius+s+i-h,0),u=c>0?c+s+i+h:0;let f=0;const g=n-l;if(s){const t=((c>0?c-s:0)+(d>0?d-s:0))/2;f=(g-(0!==t?g*t/(t+s):g))/2}const p=(g-Math.max(.001,g*d-i/C)/d)/2,m=l+p+f,x=n-p-f,{outerStart:b,outerEnd:_,innerStart:y,innerEnd:v}=Xn(e,u,d,x-m),M=d-b,w=d-_,k=m+b/M,S=x-_/w,P=u+y,D=u+v,O=m+y/P,A=x-v/D;if(t.beginPath(),o){const e=(k+S)/2;if(t.arc(a,r,d,k,e),t.arc(a,r,d,e,S),_>0){const e=qn(w,S,a,r);t.arc(e.x,e.y,_,S,x+E)}const i=qn(D,x,a,r);if(t.lineTo(i.x,i.y),v>0){const e=qn(D,A,a,r);t.arc(e.x,e.y,v,x+E,A+Math.PI)}const s=(x-v/u+(m+y/u))/2;if(t.arc(a,r,u,x-v/u,s,!0),t.arc(a,r,u,s,m+y/u,!0),y>0){const e=qn(P,O,a,r);t.arc(e.x,e.y,y,O+Math.PI,m-E)}const n=qn(M,m,a,r);if(t.lineTo(n.x,n.y),b>0){const e=qn(M,k,a,r);t.arc(e.x,e.y,b,m-E,k)}}else{t.moveTo(a,r);const e=Math.cos(k)*d+a,i=Math.sin(k)*d+r;t.lineTo(e,i);const s=Math.cos(S)*d+a,n=Math.sin(S)*d+r;t.lineTo(s,n)}t.closePath()}function Gn(t,e,i,s,n){const{fullCircles:o,startAngle:a,circumference:r,options:l}=e,{borderWidth:h,borderJoinStyle:c,borderDash:d,borderDashOffset:u,borderRadius:f}=l,g="inner"===l.borderAlign;if(!h)return;t.setLineDash(d||[]),t.lineDashOffset=u,g?(t.lineWidth=2*h,t.lineJoin=c||"round"):(t.lineWidth=h,t.lineJoin=c||"bevel");let p=e.endAngle;if(o){Kn(t,e,i,s,p,n);for(let e=0;e<o;++e)t.stroke();isNaN(r)||(p=a+(r%O||O))}g&&function(t,e,i){const{startAngle:s,pixelMargin:n,x:o,y:a,outerRadius:r,innerRadius:l}=e;let h=n/r;t.beginPath(),t.arc(o,a,r,s-h,i+h),l>n?(h=n/l,t.arc(o,a,l,i+h,s-h,!0)):t.arc(o,a,n,i+E,s-E),t.closePath(),t.clip()}(t,e,p),l.selfJoin&&p-a>=C&&0===f&&"miter"!==c&&function(t,e,i){const{startAngle:s,x:n,y:o,outerRadius:a,innerRadius:r,options:l}=e,{borderWidth:h,borderJoinStyle:c}=l,d=Math.min(h/a,G(s-i));if(t.beginPath(),t.arc(n,o,a-h/2,s+d/2,i-d/2),r>0){const e=Math.min(h/r,G(s-i));t.arc(n,o,r+h/2,i-e/2,s+e/2,!0)}else{const e=Math.min(h/2,a*G(s-i));if("round"===c)t.arc(n,o,e,i-C/2,s+C/2,!0);else if("bevel"===c){const a=2*e*e,r=-a*Math.cos(i+C/2)+n,l=-a*Math.sin(i+C/2)+o,h=a*Math.cos(s+C/2)+n,c=a*Math.sin(s+C/2)+o;t.lineTo(r,l),t.lineTo(h,c)}}t.closePath(),t.moveTo(0,0),t.rect(0,0,t.canvas.width,t.canvas.height),t.clip("evenodd")}(t,e,p),o||(Kn(t,e,i,s,p,n),t.stroke())}function Jn(t,e,i=e){t.lineCap=l(i.borderCapStyle,e.borderCapStyle),t.setLineDash(l(i.borderDash,e.borderDash)),t.lineDashOffset=l(i.borderDashOffset,e.borderDashOffset),t.lineJoin=l(i.borderJoinStyle,e.borderJoinStyle),t.lineWidth=l(i.borderWidth,e.borderWidth),t.strokeStyle=l(i.borderColor,e.borderColor)}function Zn(t,e,i){t.lineTo(i.x,i.y)}function Qn(t,e,i={}){const s=t.length,{start:n=0,end:o=s-1}=i,{start:a,end:r}=e,l=Math.max(n,a),h=Math.min(o,r),c=n<a&&o<a||n>r&&o>r;return{count:s,start:l,loop:e.loop,ilen:h<l&&!c?s+h-l:h-l}}function to(t,e,i,s){const{points:n,options:o}=e,{count:a,start:r,loop:l,ilen:h}=Qn(n,i,s),c=function(t){return t.stepped?Fe:t.tension||"monotone"===t.cubicInterpolationMode?Ve:Zn}(o);let d,u,f,{move:g=!0,reverse:p}=s||{};for(d=0;d<=h;++d)u=n[(r+(p?h-d:d))%a],u.skip||(g?(t.moveTo(u.x,u.y),g=!1):c(t,f,u,p,o.stepped),f=u);return l&&(u=n[(r+(p?h:0))%a],c(t,f,u,p,o.stepped)),!!l}function eo(t,e,i,s){const n=e.points,{count:o,start:a,ilen:r}=Qn(n,i,s),{move:l=!0,reverse:h}=s||{};let c,d,u,f,g,p,m=0,x=0;const b=t=>(a+(h?r-t:t))%o,_=()=>{f!==g&&(t.lineTo(m,g),t.lineTo(m,f),t.lineTo(m,p))};for(l&&(d=n[b(0)],t.moveTo(d.x,d.y)),c=0;c<=r;++c){if(d=n[b(c)],d.skip)continue;const e=d.x,i=d.y,s=0|e;s===u?(i<f?f=i:i>g&&(g=i),m=(x*m+e)/++x):(_(),t.lineTo(e,i),u=s,x=0,f=g=i),p=i}_()}function io(t){const e=t.options,i=e.borderDash&&e.borderDash.length;return!(t._decimated||t._loop||e.tension||"monotone"===e.cubicInterpolationMode||e.stepped||i)?eo:to}const so="function"==typeof Path2D;function no(t,e,i,s){so&&!e.options.segment?function(t,e,i,s){let n=e._path;n||(n=e._path=new Path2D,e.path(n,i,s)&&n.closePath()),Jn(t,e.options),t.stroke(n)}(t,e,i,s):function(t,e,i,s){const{segments:n,options:o}=e,a=io(e);for(const r of n)Jn(t,o,r.style),t.beginPath(),a(t,e,r,{start:i,end:i+s-1})&&t.closePath(),t.stroke()}(t,e,i,s)}class oo extends $s{static id="line";static defaults={borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",borderWidth:3,capBezierPoints:!0,cubicInterpolationMode:"default",fill:!1,spanGaps:!1,stepped:!1,tension:0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};static descriptors={_scriptable:!0,_indexable:t=>"borderDash"!==t&&"fill"!==t};constructor(t){super(),this.animated=!0,this.options=void 0,this._chart=void 0,this._loop=void 0,this._fullLoop=void 0,this._path=void 0,this._points=void 0,this._segments=void 0,this._decimated=!1,this._pointsUpdated=!1,this._datasetIndex=void 0,t&&Object.assign(this,t)}updateControlPoints(t,e){const i=this.options;if((i.tension||"monotone"===i.cubicInterpolationMode)&&!i.stepped&&!this._pointsUpdated){const s=i.spanGaps?this._loop:this._fullLoop;hi(this._points,i,t,s,e),this._pointsUpdated=!0}}set points(t){this._points=t,delete this._segments,delete this._path,this._pointsUpdated=!1}get points(){return this._points}get segments(){return this._segments||(this._segments=zi(this,this.options.segment))}first(){const t=this.segments,e=this.points;return t.length&&e[t[0].start]}last(){const t=this.segments,e=this.points,i=t.length;return i&&e[t[i-1].end]}interpolate(t,e){const i=this.options,s=t[e],n=this.points,o=Ii(this,{property:e,start:s,end:s});if(!o.length)return;const a=[],r=function(t){return t.stepped?pi:t.tension||"monotone"===t.cubicInterpolationMode?mi:gi}(i);let l,h;for(l=0,h=o.length;l<h;++l){const{start:h,end:c}=o[l],d=n[h],u=n[c];if(d===u){a.push(d);continue}const f=r(d,u,Math.abs((s-d[e])/(u[e]-d[e])),i.stepped);f[e]=t[e],a.push(f)}return 1===a.length?a[0]:a}pathSegment(t,e,i){return io(this)(t,this,e,i)}path(t,e,i){const s=this.segments,n=io(this);let o=this._loop;e=e||0,i=i||this.points.length-e;for(const a of s)o&=n(t,this,a,{start:e,end:e+i-1});return!!o}draw(t,e,i,s){const n=this.options||{};(this.points||[]).length&&n.borderWidth&&(t.save(),no(t,this,i,s),t.restore()),this.animated&&(this._pointsUpdated=!1,this._path=void 0)}}function ao(t,e,i,s){const n=t.options,{[i]:o}=t.getProps([i],s);return Math.abs(e-o)<n.radius+n.hitRadius}function ro(t,e){const{x:i,y:s,base:n,width:o,height:a}=t.getProps(["x","y","base","width","height"],e);let r,l,h,c,d;return t.horizontal?(d=a/2,r=Math.min(i,n),l=Math.max(i,n),h=s-d,c=s+d):(d=o/2,r=i-d,l=i+d,h=Math.min(s,n),c=Math.max(s,n)),{left:r,top:h,right:l,bottom:c}}function lo(t,e,i,s){return t?0:Z(e,i,s)}function ho(t){const e=ro(t),i=e.right-e.left,s=e.bottom-e.top,n=function(t,e,i){const s=t.options.borderWidth,n=t.borderSkipped,o=Mi(s);return{t:lo(n.top,o.top,0,i),r:lo(n.right,o.right,0,e),b:lo(n.bottom,o.bottom,0,i),l:lo(n.left,o.left,0,e)}}(t,i/2,s/2),a=function(t,e,i){const{enableBorderRadius:s}=t.getProps(["enableBorderRadius"]),n=t.options.borderRadius,a=wi(n),r=Math.min(e,i),l=t.borderSkipped,h=s||o(n);return{topLeft:lo(!h||l.top||l.left,a.topLeft,0,r),topRight:lo(!h||l.top||l.right,a.topRight,0,r),bottomLeft:lo(!h||l.bottom||l.left,a.bottomLeft,0,r),bottomRight:lo(!h||l.bottom||l.right,a.bottomRight,0,r)}}(t,i/2,s/2);return{outer:{x:e.left,y:e.top,w:i,h:s,radius:a},inner:{x:e.left+n.l,y:e.top+n.t,w:i-n.l-n.r,h:s-n.t-n.b,radius:{topLeft:Math.max(0,a.topLeft-Math.max(n.t,n.l)),topRight:Math.max(0,a.topRight-Math.max(n.t,n.r)),bottomLeft:Math.max(0,a.bottomLeft-Math.max(n.b,n.l)),bottomRight:Math.max(0,a.bottomRight-Math.max(n.b,n.r))}}}}function co(t,e,i,s){const n=null===e,o=null===i,a=t&&!(n&&o)&&ro(t,s);return a&&(n||tt(e,a.left,a.right))&&(o||tt(i,a.top,a.bottom))}function uo(t,e){t.rect(e.x,e.y,e.w,e.h)}function fo(t,e,i={}){const s=t.x!==i.x?-e:0,n=t.y!==i.y?-e:0,o=(t.x+t.w!==i.x+i.w?e:0)-s,a=(t.y+t.h!==i.y+i.h?e:0)-n;return{x:t.x+s,y:t.y+n,w:t.w+o,h:t.h+a,radius:t.radius}}var go=Object.freeze({__proto__:null,ArcElement:class extends $s{static id="arc";static defaults={borderAlign:"center",borderColor:"#fff",borderDash:[],borderDashOffset:0,borderJoinStyle:void 0,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:void 0,circular:!0,selfJoin:!1};static defaultRoutes={backgroundColor:"backgroundColor"};static descriptors={_scriptable:!0,_indexable:t=>"borderDash"!==t};circumference;endAngle;fullCircles;innerRadius;outerRadius;pixelMargin;startAngle;constructor(t){super(),this.options=void 0,this.circumference=void 0,this.startAngle=void 0,this.endAngle=void 0,this.innerRadius=void 0,this.outerRadius=void 0,this.pixelMargin=0,this.fullCircles=0,t&&Object.assign(this,t)}inRange(t,e,i){const s=this.getProps(["x","y"],i),{angle:n,distance:o}=X(s,{x:t,y:e}),{startAngle:a,endAngle:r,innerRadius:h,outerRadius:c,circumference:d}=this.getProps(["startAngle","endAngle","innerRadius","outerRadius","circumference"],i),u=(this.options.spacing+this.options.borderWidth)/2,f=l(d,r-a),g=J(n,a,r)&&a!==r,p=f>=O||g,m=tt(o,h+u,c+u);return p&&m}getCenterPoint(t){const{x:e,y:i,startAngle:s,endAngle:n,innerRadius:o,outerRadius:a}=this.getProps(["x","y","startAngle","endAngle","innerRadius","outerRadius"],t),{offset:r,spacing:l}=this.options,h=(s+n)/2,c=(o+a+l+r)/2;return{x:e+Math.cos(h)*c,y:i+Math.sin(h)*c}}tooltipPosition(t){return this.getCenterPoint(t)}draw(t){const{options:e,circumference:i}=this,s=(e.offset||0)/4,n=(e.spacing||0)/2,o=e.circular;if(this.pixelMargin="inner"===e.borderAlign?.33:0,this.fullCircles=i>O?Math.floor(i/O):0,0===i||this.innerRadius<0||this.outerRadius<0)return;t.save();const a=(this.startAngle+this.endAngle)/2;t.translate(Math.cos(a)*s,Math.sin(a)*s);const r=s*(1-Math.sin(Math.min(C,i||0)));t.fillStyle=e.backgroundColor,t.strokeStyle=e.borderColor,function(t,e,i,s,n){const{fullCircles:o,startAngle:a,circumference:r}=e;let l=e.endAngle;if(o){Kn(t,e,i,s,l,n);for(let e=0;e<o;++e)t.fill();isNaN(r)||(l=a+(r%O||O))}Kn(t,e,i,s,l,n),t.fill()}(t,this,r,n,o),Gn(t,this,r,n,o),t.restore()}},BarElement:class extends $s{static id="bar";static defaults={borderSkipped:"start",borderWidth:0,borderRadius:0,inflateAmount:"auto",pointStyle:void 0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};constructor(t){super(),this.options=void 0,this.horizontal=void 0,this.base=void 0,this.width=void 0,this.height=void 0,this.inflateAmount=void 0,t&&Object.assign(this,t)}draw(t){const{inflateAmount:e,options:{borderColor:i,backgroundColor:s}}=this,{inner:n,outer:o}=ho(this),a=(r=o.radius).topLeft||r.topRight||r.bottomLeft||r.bottomRight?He:uo;var r;t.save(),o.w===n.w&&o.h===n.h||(t.beginPath(),a(t,fo(o,e,n)),t.clip(),a(t,fo(n,-e,o)),t.fillStyle=i,t.fill("evenodd")),t.beginPath(),a(t,fo(n,e)),t.fillStyle=s,t.fill(),t.restore()}inRange(t,e,i){return co(this,t,e,i)}inXRange(t,e){return co(this,t,null,e)}inYRange(t,e){return co(this,null,t,e)}getCenterPoint(t){const{x:e,y:i,base:s,horizontal:n}=this.getProps(["x","y","base","horizontal"],t);return{x:n?(e+s)/2:e,y:n?i:(i+s)/2}}getRange(t){return"x"===t?this.width/2:this.height/2}},LineElement:oo,PointElement:class extends $s{static id="point";parsed;skip;stop;static defaults={borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:"circle",radius:3,rotation:0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};constructor(t){super(),this.options=void 0,this.parsed=void 0,this.skip=void 0,this.stop=void 0,t&&Object.assign(this,t)}inRange(t,e,i){const s=this.options,{x:n,y:o}=this.getProps(["x","y"],i);return Math.pow(t-n,2)+Math.pow(e-o,2)<Math.pow(s.hitRadius+s.radius,2)}inXRange(t,e){return ao(this,t,"x",e)}inYRange(t,e){return ao(this,t,"y",e)}getCenterPoint(t){const{x:e,y:i}=this.getProps(["x","y"],t);return{x:e,y:i}}size(t){let e=(t=t||this.options||{}).radius||0;e=Math.max(e,e&&t.hoverRadius||0);return 2*(e+(e&&t.borderWidth||0))}draw(t,e){const i=this.options;this.skip||i.radius<.1||!Re(this,e,this.size(i)/2)||(t.strokeStyle=i.borderColor,t.lineWidth=i.borderWidth,t.fillStyle=i.backgroundColor,Le(t,i,this.x,this.y))}getRange(){const t=this.options||{};return t.radius+t.hitRadius}}});function po(t,e,i,s){const n=t.indexOf(e);if(-1===n)return((t,e,i,s)=>("string"==typeof e?(i=t.push(e)-1,s.unshift({index:i,label:e})):isNaN(e)&&(i=null),i))(t,e,i,s);return n!==t.lastIndexOf(e)?i:n}function mo(t){const e=this.getLabels();return t>=0&&t<e.length?e[t]:t}function xo(t,e,{horizontal:i,minRotation:s}){const n=$(s),o=(i?Math.sin(n):Math.cos(n))||.001,a=.75*e*(""+t).length;return Math.min(e/o,a)}class bo extends tn{constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._endValue=void 0,this._valueRange=0}parse(t,e){return s(t)||("number"==typeof t||t instanceof Number)&&!isFinite(+t)?null:+t}handleTickRangeOptions(){const{beginAtZero:t}=this.options,{minDefined:e,maxDefined:i}=this.getUserBounds();let{min:s,max:n}=this;const o=t=>s=e?s:t,a=t=>n=i?n:t;if(t){const t=F(s),e=F(n);t<0&&e<0?a(0):t>0&&e>0&&o(0)}if(s===n){let e=0===n?1:Math.abs(.05*n);a(n+e),t||o(s-e)}this.min=s,this.max=n}getTickLimit(){const t=this.options.ticks;let e,{maxTicksLimit:i,stepSize:s}=t;return s?(e=Math.ceil(this.max/s)-Math.floor(this.min/s)+1,e>1e3&&(console.warn(`scales.${this.id}.ticks.stepSize: ${s} would result generating up to ${e} ticks. Limiting to 1000.`),e=1e3)):(e=this.computeTickLimit(),i=i||11),i&&(e=Math.min(i,e)),e}computeTickLimit(){return Number.POSITIVE_INFINITY}buildTicks(){const t=this.options,e=t.ticks;let i=this.getTickLimit();i=Math.max(2,i);const n=function(t,e){const i=[],{bounds:n,step:o,min:a,max:r,precision:l,count:h,maxTicks:c,maxDigits:d,includeBounds:u}=t,f=o||1,g=c-1,{min:p,max:m}=e,x=!s(a),b=!s(r),_=!s(h),y=(m-p)/(d+1);let v,M,w,k,S=B((m-p)/g/f)*f;if(S<1e-14&&!x&&!b)return[{value:p},{value:m}];k=Math.ceil(m/S)-Math.floor(p/S),k>g&&(S=B(k*S/g/f)*f),s(l)||(v=Math.pow(10,l),S=Math.ceil(S*v)/v),"ticks"===n?(M=Math.floor(p/S)*S,w=Math.ceil(m/S)*S):(M=p,w=m),x&&b&&o&&H((r-a)/o,S/1e3)?(k=Math.round(Math.min((r-a)/S,c)),S=(r-a)/k,M=a,w=r):_?(M=x?a:M,w=b?r:w,k=h-1,S=(w-M)/k):(k=(w-M)/S,k=V(k,Math.round(k),S/1e3)?Math.round(k):Math.ceil(k));const P=Math.max(U(S),U(M));v=Math.pow(10,s(l)?P:l),M=Math.round(M*v)/v,w=Math.round(w*v)/v;let D=0;for(x&&(u&&M!==a?(i.push({value:a}),M<a&&D++,V(Math.round((M+D*S)*v)/v,a,xo(a,y,t))&&D++):M<a&&D++);D<k;++D){const t=Math.round((M+D*S)*v)/v;if(b&&t>r)break;i.push({value:t})}return b&&u&&w!==r?i.length&&V(i[i.length-1].value,r,xo(r,y,t))?i[i.length-1].value=r:i.push({value:r}):b&&w!==r||i.push({value:w}),i}({maxTicks:i,bounds:t.bounds,min:t.min,max:t.max,precision:e.precision,step:e.stepSize,count:e.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:e.minRotation||0,includeBounds:!1!==e.includeBounds},this._range||this);return"ticks"===t.bounds&&j(n,this,"value"),t.reverse?(n.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),n}configure(){const t=this.ticks;let e=this.min,i=this.max;if(super.configure(),this.options.offset&&t.length){const s=(i-e)/Math.max(t.length-1,1)/2;e-=s,i+=s}this._startValue=e,this._endValue=i,this._valueRange=i-e}getLabelForValue(t){return ne(t,this.chart.options.locale,this.options.ticks.format)}}class _o extends bo{static id="linear";static defaults={ticks:{callback:ae.formatters.numeric}};determineDataLimits(){const{min:t,max:e}=this.getMinMax(!0);this.min=a(t)?t:0,this.max=a(e)?e:1,this.handleTickRangeOptions()}computeTickLimit(){const t=this.isHorizontal(),e=t?this.width:this.height,i=$(this.options.ticks.minRotation),s=(t?Math.sin(i):Math.cos(i))||.001,n=this._resolveTickFontOptions(0);return Math.ceil(e/Math.min(40,n.lineHeight/s))}getPixelForValue(t){return null===t?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getValueForPixel(t){return this._startValue+this.getDecimalForPixel(t)*this._valueRange}}const yo=t=>Math.floor(z(t)),vo=(t,e)=>Math.pow(10,yo(t)+e);function Mo(t){return 1===t/Math.pow(10,yo(t))}function wo(t,e,i){const s=Math.pow(10,i),n=Math.floor(t/s);return Math.ceil(e/s)-n}function ko(t,{min:e,max:i}){e=r(t.min,e);const s=[],n=yo(e);let o=function(t,e){let i=yo(e-t);for(;wo(t,e,i)>10;)i++;for(;wo(t,e,i)<10;)i--;return Math.min(i,yo(t))}(e,i),a=o<0?Math.pow(10,Math.abs(o)):1;const l=Math.pow(10,o),h=n>o?Math.pow(10,n):0,c=Math.round((e-h)*a)/a,d=Math.floor((e-h)/l/10)*l*10;let u=Math.floor((c-d)/Math.pow(10,o)),f=r(t.min,Math.round((h+d+u*Math.pow(10,o))*a)/a);for(;f<i;)s.push({value:f,major:Mo(f),significand:u}),u>=10?u=u<15?15:20:u++,u>=20&&(o++,u=2,a=o>=0?1:a),f=Math.round((h+d+u*Math.pow(10,o))*a)/a;const g=r(t.max,f);return s.push({value:g,major:Mo(g),significand:u}),s}class So extends tn{static id="logarithmic";static defaults={ticks:{callback:ae.formatters.logarithmic,major:{enabled:!0}}};constructor(t){super(t),this.start=void 0,this.end=void 0,this._startValue=void 0,this._valueRange=0}parse(t,e){const i=bo.prototype.parse.apply(this,[t,e]);if(0!==i)return a(i)&&i>0?i:null;this._zero=!0}determineDataLimits(){const{min:t,max:e}=this.getMinMax(!0);this.min=a(t)?Math.max(0,t):null,this.max=a(e)?Math.max(0,e):null,this.options.beginAtZero&&(this._zero=!0),this._zero&&this.min!==this._suggestedMin&&!a(this._userMin)&&(this.min=t===vo(this.min,0)?vo(this.min,-1):vo(this.min,0)),this.handleTickRangeOptions()}handleTickRangeOptions(){const{minDefined:t,maxDefined:e}=this.getUserBounds();let i=this.min,s=this.max;const n=e=>i=t?i:e,o=t=>s=e?s:t;i===s&&(i<=0?(n(1),o(10)):(n(vo(i,-1)),o(vo(s,1)))),i<=0&&n(vo(s,-1)),s<=0&&o(vo(i,1)),this.min=i,this.max=s}buildTicks(){const t=this.options,e=ko({min:this._userMin,max:this._userMax},this);return"ticks"===t.bounds&&j(e,this,"value"),t.reverse?(e.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),e}getLabelForValue(t){return void 0===t?"0":ne(t,this.chart.options.locale,this.options.ticks.format)}configure(){const t=this.min;super.configure(),this._startValue=z(t),this._valueRange=z(this.max)-z(t)}getPixelForValue(t){return void 0!==t&&0!==t||(t=this.min),null===t||isNaN(t)?NaN:this.getPixelForDecimal(t===this.min?0:(z(t)-this._startValue)/this._valueRange)}getValueForPixel(t){const e=this.getDecimalForPixel(t);return Math.pow(10,this._startValue+e*this._valueRange)}}function Po(t){const e=t.ticks;if(e.display&&t.display){const t=ki(e.backdropPadding);return l(e.font&&e.font.size,ue.font.size)+t.height}return 0}function Do(t,e,i,s,n){return t===s||t===n?{start:e-i/2,end:e+i/2}:t<s||t>n?{start:e-i,end:e}:{start:e,end:e+i}}function Co(t){const e={l:t.left+t._padding.left,r:t.right-t._padding.right,t:t.top+t._padding.top,b:t.bottom-t._padding.bottom},i=Object.assign({},e),s=[],o=[],a=t._pointLabels.length,r=t.options.pointLabels,l=r.centerPointLabels?C/a:0;for(let u=0;u<a;u++){const a=r.setContext(t.getPointLabelContext(u));o[u]=a.padding;const f=t.getPointPosition(u,t.drawingArea+o[u],l),g=Si(a.font),p=(h=t.ctx,c=g,d=n(d=t._pointLabels[u])?d:[d],{w:Oe(h,c.string,d),h:d.length*c.lineHeight});s[u]=p;const m=G(t.getIndexAngle(u)+l),x=Math.round(Y(m));Oo(i,e,m,Do(x,f.x,p.w,0,180),Do(x,f.y,p.h,90,270))}var h,c,d;t.setCenterPoint(e.l-i.l,i.r-e.r,e.t-i.t,i.b-e.b),t._pointLabelItems=function(t,e,i){const s=[],n=t._pointLabels.length,o=t.options,{centerPointLabels:a,display:r}=o.pointLabels,l={extra:Po(o)/2,additionalAngle:a?C/n:0};let h;for(let o=0;o<n;o++){l.padding=i[o],l.size=e[o];const n=Ao(t,o,l);s.push(n),"auto"===r&&(n.visible=To(n,h),n.visible&&(h=n))}return s}(t,s,o)}function Oo(t,e,i,s,n){const o=Math.abs(Math.sin(i)),a=Math.abs(Math.cos(i));let r=0,l=0;s.start<e.l?(r=(e.l-s.start)/o,t.l=Math.min(t.l,e.l-r)):s.end>e.r&&(r=(s.end-e.r)/o,t.r=Math.max(t.r,e.r+r)),n.start<e.t?(l=(e.t-n.start)/a,t.t=Math.min(t.t,e.t-l)):n.end>e.b&&(l=(n.end-e.b)/a,t.b=Math.max(t.b,e.b+l))}function Ao(t,e,i){const s=t.drawingArea,{extra:n,additionalAngle:o,padding:a,size:r}=i,l=t.getPointPosition(e,s+n+a,o),h=Math.round(Y(G(l.angle+E))),c=function(t,e,i){90===i||270===i?t-=e/2:(i>270||i<90)&&(t-=e);return t}(l.y,r.h,h),d=function(t){if(0===t||180===t)return"center";if(t<180)return"left";return"right"}(h),u=function(t,e,i){"right"===i?t-=e:"center"===i&&(t-=e/2);return t}(l.x,r.w,d);return{visible:!0,x:l.x,y:c,textAlign:d,left:u,top:c,right:u+r.w,bottom:c+r.h}}function To(t,e){if(!e)return!0;const{left:i,top:s,right:n,bottom:o}=t;return!(Re({x:i,y:s},e)||Re({x:i,y:o},e)||Re({x:n,y:s},e)||Re({x:n,y:o},e))}function Lo(t,e,i){const{left:n,top:o,right:a,bottom:r}=i,{backdropColor:l}=e;if(!s(l)){const i=wi(e.borderRadius),s=ki(e.backdropPadding);t.fillStyle=l;const h=n-s.left,c=o-s.top,d=a-n+s.width,u=r-o+s.height;Object.values(i).some((t=>0!==t))?(t.beginPath(),He(t,{x:h,y:c,w:d,h:u,radius:i}),t.fill()):t.fillRect(h,c,d,u)}}function Eo(t,e,i,s){const{ctx:n}=t;if(i)n.arc(t.xCenter,t.yCenter,e,0,O);else{let i=t.getPointPosition(0,e);n.moveTo(i.x,i.y);for(let o=1;o<s;o++)i=t.getPointPosition(o,e),n.lineTo(i.x,i.y)}}class Ro extends bo{static id="radialLinear";static defaults={display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,lineWidth:1,borderDash:[],borderDashOffset:0},grid:{circular:!1},startAngle:0,ticks:{showLabelBackdrop:!0,callback:ae.formatters.numeric},pointLabels:{backdropColor:void 0,backdropPadding:2,display:!0,font:{size:10},callback:t=>t,padding:5,centerPointLabels:!1}};static defaultRoutes={"angleLines.color":"borderColor","pointLabels.color":"color","ticks.color":"color"};static descriptors={angleLines:{_fallback:"grid"}};constructor(t){super(t),this.xCenter=void 0,this.yCenter=void 0,this.drawingArea=void 0,this._pointLabels=[],this._pointLabelItems=[]}setDimensions(){const t=this._padding=ki(Po(this.options)/2),e=this.width=this.maxWidth-t.width,i=this.height=this.maxHeight-t.height;this.xCenter=Math.floor(this.left+e/2+t.left),this.yCenter=Math.floor(this.top+i/2+t.top),this.drawingArea=Math.floor(Math.min(e,i)/2)}determineDataLimits(){const{min:t,max:e}=this.getMinMax(!1);this.min=a(t)&&!isNaN(t)?t:0,this.max=a(e)&&!isNaN(e)?e:0,this.handleTickRangeOptions()}computeTickLimit(){return Math.ceil(this.drawingArea/Po(this.options))}generateTickLabels(t){bo.prototype.generateTickLabels.call(this,t),this._pointLabels=this.getLabels().map(((t,e)=>{const i=d(this.options.pointLabels.callback,[t,e],this);return i||0===i?i:""})).filter(((t,e)=>this.chart.getDataVisibility(e)))}fit(){const t=this.options;t.display&&t.pointLabels.display?Co(this):this.setCenterPoint(0,0,0,0)}setCenterPoint(t,e,i,s){this.xCenter+=Math.floor((t-e)/2),this.yCenter+=Math.floor((i-s)/2),this.drawingArea-=Math.min(this.drawingArea/2,Math.max(t,e,i,s))}getIndexAngle(t){return G(t*(O/(this._pointLabels.length||1))+$(this.options.startAngle||0))}getDistanceFromCenterForValue(t){if(s(t))return NaN;const e=this.drawingArea/(this.max-this.min);return this.options.reverse?(this.max-t)*e:(t-this.min)*e}getValueForDistanceFromCenter(t){if(s(t))return NaN;const e=t/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-e:this.min+e}getPointLabelContext(t){const e=this._pointLabels||[];if(t>=0&&t<e.length){const i=e[t];return function(t,e,i){return Ci(t,{label:i,index:e,type:"pointLabel"})}(this.getContext(),t,i)}}getPointPosition(t,e,i=0){const s=this.getIndexAngle(t)-E+i;return{x:Math.cos(s)*e+this.xCenter,y:Math.sin(s)*e+this.yCenter,angle:s}}getPointPositionForValue(t,e){return this.getPointPosition(t,this.getDistanceFromCenterForValue(e))}getBasePosition(t){return this.getPointPositionForValue(t||0,this.getBaseValue())}getPointLabelPosition(t){const{left:e,top:i,right:s,bottom:n}=this._pointLabelItems[t];return{left:e,top:i,right:s,bottom:n}}drawBackground(){const{backgroundColor:t,grid:{circular:e}}=this.options;if(t){const i=this.ctx;i.save(),i.beginPath(),Eo(this,this.getDistanceFromCenterForValue(this._endValue),e,this._pointLabels.length),i.closePath(),i.fillStyle=t,i.fill(),i.restore()}}drawGrid(){const t=this.ctx,e=this.options,{angleLines:i,grid:s,border:n}=e,o=this._pointLabels.length;let a,r,l;if(e.pointLabels.display&&function(t,e){const{ctx:i,options:{pointLabels:s}}=t;for(let n=e-1;n>=0;n--){const e=t._pointLabelItems[n];if(!e.visible)continue;const o=s.setContext(t.getPointLabelContext(n));Lo(i,o,e);const a=Si(o.font),{x:r,y:l,textAlign:h}=e;Ne(i,t._pointLabels[n],r,l+a.lineHeight/2,a,{color:o.color,textAlign:h,textBaseline:"middle"})}}(this,o),s.display&&this.ticks.forEach(((t,e)=>{if(0!==e||0===e&&this.min<0){r=this.getDistanceFromCenterForValue(t.value);const i=this.getContext(e),a=s.setContext(i),l=n.setContext(i);!function(t,e,i,s,n){const o=t.ctx,a=e.circular,{color:r,lineWidth:l}=e;!a&&!s||!r||!l||i<0||(o.save(),o.strokeStyle=r,o.lineWidth=l,o.setLineDash(n.dash||[]),o.lineDashOffset=n.dashOffset,o.beginPath(),Eo(t,i,a,s),o.closePath(),o.stroke(),o.restore())}(this,a,r,o,l)}})),i.display){for(t.save(),a=o-1;a>=0;a--){const s=i.setContext(this.getPointLabelContext(a)),{color:n,lineWidth:o}=s;o&&n&&(t.lineWidth=o,t.strokeStyle=n,t.setLineDash(s.borderDash),t.lineDashOffset=s.borderDashOffset,r=this.getDistanceFromCenterForValue(e.reverse?this.min:this.max),l=this.getPointPosition(a,r),t.beginPath(),t.moveTo(this.xCenter,this.yCenter),t.lineTo(l.x,l.y),t.stroke())}t.restore()}}drawBorder(){}drawLabels(){const t=this.ctx,e=this.options,i=e.ticks;if(!i.display)return;const s=this.getIndexAngle(0);let n,o;t.save(),t.translate(this.xCenter,this.yCenter),t.rotate(s),t.textAlign="center",t.textBaseline="middle",this.ticks.forEach(((s,a)=>{if(0===a&&this.min>=0&&!e.reverse)return;const r=i.setContext(this.getContext(a)),l=Si(r.font);if(n=this.getDistanceFromCenterForValue(this.ticks[a].value),r.showLabelBackdrop){t.font=l.string,o=t.measureText(s.label).width,t.fillStyle=r.backdropColor;const e=ki(r.backdropPadding);t.fillRect(-o/2-e.left,-n-l.size/2-e.top,o+e.width,l.size+e.height)}Ne(t,s.label,0,-n,l,{color:r.color,strokeColor:r.textStrokeColor,strokeWidth:r.textStrokeWidth})})),t.restore()}drawTitle(){}}const Io={millisecond:{common:!0,size:1,steps:1e3},second:{common:!0,size:1e3,steps:60},minute:{common:!0,size:6e4,steps:60},hour:{common:!0,size:36e5,steps:24},day:{common:!0,size:864e5,steps:30},week:{common:!1,size:6048e5,steps:4},month:{common:!0,size:2628e6,steps:12},quarter:{common:!1,size:7884e6,steps:4},year:{common:!0,size:3154e7}},zo=Object.keys(Io);function Fo(t,e){return t-e}function Vo(t,e){if(s(e))return null;const i=t._adapter,{parser:n,round:o,isoWeekday:r}=t._parseOpts;let l=e;return"function"==typeof n&&(l=n(l)),a(l)||(l="string"==typeof n?i.parse(l,n):i.parse(l)),null===l?null:(o&&(l="week"!==o||!N(r)&&!0!==r?i.startOf(l,o):i.startOf(l,"isoWeek",r)),+l)}function Bo(t,e,i,s){const n=zo.length;for(let o=zo.indexOf(t);o<n-1;++o){const t=Io[zo[o]],n=t.steps?t.steps:Number.MAX_SAFE_INTEGER;if(t.common&&Math.ceil((i-e)/(n*t.size))<=s)return zo[o]}return zo[n-1]}function Wo(t,e,i){if(i){if(i.length){const{lo:s,hi:n}=et(i,e);t[i[s]>=e?i[s]:i[n]]=!0}}else t[e]=!0}function No(t,e,i){const s=[],n={},o=e.length;let a,r;for(a=0;a<o;++a)r=e[a],n[r]=a,s.push({value:r,major:!1});return 0!==o&&i?function(t,e,i,s){const n=t._adapter,o=+n.startOf(e[0].value,s),a=e[e.length-1].value;let r,l;for(r=o;r<=a;r=+n.add(r,1,s))l=i[r],l>=0&&(e[l].major=!0);return e}(t,s,n,i):s}class Ho extends tn{static id="time";static defaults={bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{source:"auto",callback:!1,major:{enabled:!1}}};constructor(t){super(t),this._cache={data:[],labels:[],all:[]},this._unit="day",this._majorUnit=void 0,this._offsets={},this._normalized=!1,this._parseOpts=void 0}init(t,e={}){const i=t.time||(t.time={}),s=this._adapter=new In._date(t.adapters.date);s.init(e),b(i.displayFormats,s.formats()),this._parseOpts={parser:i.parser,round:i.round,isoWeekday:i.isoWeekday},super.init(t),this._normalized=e.normalized}parse(t,e){return void 0===t?null:Vo(this,t)}beforeLayout(){super.beforeLayout(),this._cache={data:[],labels:[],all:[]}}determineDataLimits(){const t=this.options,e=this._adapter,i=t.time.unit||"day";let{min:s,max:n,minDefined:o,maxDefined:r}=this.getUserBounds();function l(t){o||isNaN(t.min)||(s=Math.min(s,t.min)),r||isNaN(t.max)||(n=Math.max(n,t.max))}o&&r||(l(this._getLabelBounds()),"ticks"===t.bounds&&"labels"===t.ticks.source||l(this.getMinMax(!1))),s=a(s)&&!isNaN(s)?s:+e.startOf(Date.now(),i),n=a(n)&&!isNaN(n)?n:+e.endOf(Date.now(),i)+1,this.min=Math.min(s,n-1),this.max=Math.max(s+1,n)}_getLabelBounds(){const t=this.getLabelTimestamps();let e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;return t.length&&(e=t[0],i=t[t.length-1]),{min:e,max:i}}buildTicks(){const t=this.options,e=t.time,i=t.ticks,s="labels"===i.source?this.getLabelTimestamps():this._generate();"ticks"===t.bounds&&s.length&&(this.min=this._userMin||s[0],this.max=this._userMax||s[s.length-1]);const n=this.min,o=nt(s,n,this.max);return this._unit=e.unit||(i.autoSkip?Bo(e.minUnit,this.min,this.max,this._getLabelCapacity(n)):function(t,e,i,s,n){for(let o=zo.length-1;o>=zo.indexOf(i);o--){const i=zo[o];if(Io[i].common&&t._adapter.diff(n,s,i)>=e-1)return i}return zo[i?zo.indexOf(i):0]}(this,o.length,e.minUnit,this.min,this.max)),this._majorUnit=i.major.enabled&&"year"!==this._unit?function(t){for(let e=zo.indexOf(t)+1,i=zo.length;e<i;++e)if(Io[zo[e]].common)return zo[e]}(this._unit):void 0,this.initOffsets(s),t.reverse&&o.reverse(),No(this,o,this._majorUnit)}afterAutoSkip(){this.options.offsetAfterAutoskip&&this.initOffsets(this.ticks.map((t=>+t.value)))}initOffsets(t=[]){let e,i,s=0,n=0;this.options.offset&&t.length&&(e=this.getDecimalForValue(t[0]),s=1===t.length?1-e:(this.getDecimalForValue(t[1])-e)/2,i=this.getDecimalForValue(t[t.length-1]),n=1===t.length?i:(i-this.getDecimalForValue(t[t.length-2]))/2);const o=t.length<3?.5:.25;s=Z(s,0,o),n=Z(n,0,o),this._offsets={start:s,end:n,factor:1/(s+1+n)}}_generate(){const t=this._adapter,e=this.min,i=this.max,s=this.options,n=s.time,o=n.unit||Bo(n.minUnit,e,i,this._getLabelCapacity(e)),a=l(s.ticks.stepSize,1),r="week"===o&&n.isoWeekday,h=N(r)||!0===r,c={};let d,u,f=e;if(h&&(f=+t.startOf(f,"isoWeek",r)),f=+t.startOf(f,h?"day":o),t.diff(i,e,o)>1e5*a)throw new Error(e+" and "+i+" are too far apart with stepSize of "+a+" "+o);const g="data"===s.ticks.source&&this.getDataTimestamps();for(d=f,u=0;d<i;d=+t.add(d,a,o),u++)Wo(c,d,g);return d!==i&&"ticks"!==s.bounds&&1!==u||Wo(c,d,g),Object.keys(c).sort(Fo).map((t=>+t))}getLabelForValue(t){const e=this._adapter,i=this.options.time;return i.tooltipFormat?e.format(t,i.tooltipFormat):e.format(t,i.displayFormats.datetime)}format(t,e){const i=this.options.time.displayFormats,s=this._unit,n=e||i[s];return this._adapter.format(t,n)}_tickFormatFunction(t,e,i,s){const n=this.options,o=n.ticks.callback;if(o)return d(o,[t,e,i],this);const a=n.time.displayFormats,r=this._unit,l=this._majorUnit,h=r&&a[r],c=l&&a[l],u=i[e],f=l&&c&&u&&u.major;return this._adapter.format(t,s||(f?c:h))}generateTickLabels(t){let e,i,s;for(e=0,i=t.length;e<i;++e)s=t[e],s.label=this._tickFormatFunction(s.value,e,t)}getDecimalForValue(t){return null===t?NaN:(t-this.min)/(this.max-this.min)}getPixelForValue(t){const e=this._offsets,i=this.getDecimalForValue(t);return this.getPixelForDecimal((e.start+i)*e.factor)}getValueForPixel(t){const e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return this.min+i*(this.max-this.min)}_getLabelSize(t){const e=this.options.ticks,i=this.ctx.measureText(t).width,s=$(this.isHorizontal()?e.maxRotation:e.minRotation),n=Math.cos(s),o=Math.sin(s),a=this._resolveTickFontOptions(0).size;return{w:i*n+a*o,h:i*o+a*n}}_getLabelCapacity(t){const e=this.options.time,i=e.displayFormats,s=i[e.unit]||i.millisecond,n=this._tickFormatFunction(t,0,No(this,[t],this._majorUnit),s),o=this._getLabelSize(n),a=Math.floor(this.isHorizontal()?this.width/o.w:this.height/o.h)-1;return a>0?a:1}getDataTimestamps(){let t,e,i=this._cache.data||[];if(i.length)return i;const s=this.getMatchingVisibleMetas();if(this._normalized&&s.length)return this._cache.data=s[0].controller.getAllParsedValues(this);for(t=0,e=s.length;t<e;++t)i=i.concat(s[t].controller.getAllParsedValues(this));return this._cache.data=this.normalize(i)}getLabelTimestamps(){const t=this._cache.labels||[];let e,i;if(t.length)return t;const s=this.getLabels();for(e=0,i=s.length;e<i;++e)t.push(Vo(this,s[e]));return this._cache.labels=this._normalized?t:this.normalize(t)}normalize(t){return lt(t.sort(Fo))}}function jo(t,e,i){let s,n,o,a,r=0,l=t.length-1;i?(e>=t[r].pos&&e<=t[l].pos&&({lo:r,hi:l}=it(t,"pos",e)),({pos:s,time:o}=t[r]),({pos:n,time:a}=t[l])):(e>=t[r].time&&e<=t[l].time&&({lo:r,hi:l}=it(t,"time",e)),({time:s,pos:o}=t[r]),({time:n,pos:a}=t[l]));const h=n-s;return h?o+(a-o)*(e-s)/h:o}var $o=Object.freeze({__proto__:null,CategoryScale:class extends tn{static id="category";static defaults={ticks:{callback:mo}};constructor(t){super(t),this._startValue=void 0,this._valueRange=0,this._addedLabels=[]}init(t){const e=this._addedLabels;if(e.length){const t=this.getLabels();for(const{index:i,label:s}of e)t[i]===s&&t.splice(i,1);this._addedLabels=[]}super.init(t)}parse(t,e){if(s(t))return null;const i=this.getLabels();return((t,e)=>null===t?null:Z(Math.round(t),0,e))(e=isFinite(e)&&i[e]===t?e:po(i,t,l(e,t),this._addedLabels),i.length-1)}determineDataLimits(){const{minDefined:t,maxDefined:e}=this.getUserBounds();let{min:i,max:s}=this.getMinMax(!0);"ticks"===this.options.bounds&&(t||(i=0),e||(s=this.getLabels().length-1)),this.min=i,this.max=s}buildTicks(){const t=this.min,e=this.max,i=this.options.offset,s=[];let n=this.getLabels();n=0===t&&e===n.length-1?n:n.slice(t,e+1),this._valueRange=Math.max(n.length-(i?0:1),1),this._startValue=this.min-(i?.5:0);for(let i=t;i<=e;i++)s.push({value:i});return s}getLabelForValue(t){return mo.call(this,t)}configure(){super.configure(),this.isHorizontal()||(this._reversePixels=!this._reversePixels)}getPixelForValue(t){return"number"!=typeof t&&(t=this.parse(t)),null===t?NaN:this.getPixelForDecimal((t-this._startValue)/this._valueRange)}getPixelForTick(t){const e=this.ticks;return t<0||t>e.length-1?null:this.getPixelForValue(e[t].value)}getValueForPixel(t){return Math.round(this._startValue+this.getDecimalForPixel(t)*this._valueRange)}getBasePixel(){return this.bottom}},LinearScale:_o,LogarithmicScale:So,RadialLinearScale:Ro,TimeScale:Ho,TimeSeriesScale:class extends Ho{static id="timeseries";static defaults=Ho.defaults;constructor(t){super(t),this._table=[],this._minPos=void 0,this._tableRange=void 0}initOffsets(){const t=this._getTimestampsForTable(),e=this._table=this.buildLookupTable(t);this._minPos=jo(e,this.min),this._tableRange=jo(e,this.max)-this._minPos,super.initOffsets(t)}buildLookupTable(t){const{min:e,max:i}=this,s=[],n=[];let o,a,r,l,h;for(o=0,a=t.length;o<a;++o)l=t[o],l>=e&&l<=i&&s.push(l);if(s.length<2)return[{time:e,pos:0},{time:i,pos:1}];for(o=0,a=s.length;o<a;++o)h=s[o+1],r=s[o-1],l=s[o],Math.round((h+r)/2)!==l&&n.push({time:l,pos:o/(a-1)});return n}_generate(){const t=this.min,e=this.max;let i=super.getDataTimestamps();return i.includes(t)&&i.length||i.splice(0,0,t),i.includes(e)&&1!==i.length||i.push(e),i.sort(((t,e)=>t-e))}_getTimestampsForTable(){let t=this._cache.all||[];if(t.length)return t;const e=this.getDataTimestamps(),i=this.getLabelTimestamps();return t=e.length&&i.length?this.normalize(e.concat(i)):e.length?e:i,t=this._cache.all=t,t}getDecimalForValue(t){return(jo(this._table,t)-this._minPos)/this._tableRange}getValueForPixel(t){const e=this._offsets,i=this.getDecimalForPixel(t)/e.factor-e.end;return jo(this._table,i*this._tableRange+this._minPos,!0)}}});const Yo=["rgb(54, 162, 235)","rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(153, 102, 255)","rgb(201, 203, 207)"],Uo=Yo.map((t=>t.replace("rgb(","rgba(").replace(")",", 0.5)")));function Xo(t){return Yo[t%Yo.length]}function qo(t){return Uo[t%Uo.length]}function Ko(t){let e=0;return(i,s)=>{const n=t.getDatasetMeta(s).controller;n instanceof $n?e=function(t,e){return t.backgroundColor=t.data.map((()=>Xo(e++))),e}(i,e):n instanceof Yn?e=function(t,e){return t.backgroundColor=t.data.map((()=>qo(e++))),e}(i,e):n&&(e=function(t,e){return t.borderColor=Xo(e),t.backgroundColor=qo(e),++e}(i,e))}}function Go(t){let e;for(e in t)if(t[e].borderColor||t[e].backgroundColor)return!0;return!1}var Jo={id:"colors",defaults:{enabled:!0,forceOverride:!1},beforeLayout(t,e,i){if(!i.enabled)return;const{data:{datasets:s},options:n}=t.config,{elements:o}=n,a=Go(s)||(r=n)&&(r.borderColor||r.backgroundColor)||o&&Go(o)||"rgba(0,0,0,0.1)"!==ue.borderColor||"rgba(0,0,0,0.1)"!==ue.backgroundColor;var r;if(!i.forceOverride&&a)return;const l=Ko(t);s.forEach(l)}};function Zo(t){if(t._decimated){const e=t._data;delete t._decimated,delete t._data,Object.defineProperty(t,"data",{configurable:!0,enumerable:!0,writable:!0,value:e})}}function Qo(t){t.data.datasets.forEach((t=>{Zo(t)}))}var ta={id:"decimation",defaults:{algorithm:"min-max",enabled:!1},beforeElementsUpdate:(t,e,i)=>{if(!i.enabled)return void Qo(t);const n=t.width;t.data.datasets.forEach(((e,o)=>{const{_data:a,indexAxis:r}=e,l=t.getDatasetMeta(o),h=a||e.data;if("y"===Pi([r,t.options.indexAxis]))return;if(!l.controller.supportsDecimation)return;const c=t.scales[l.xAxisID];if("linear"!==c.type&&"time"!==c.type)return;if(t.options.parsing)return;let{start:d,count:u}=function(t,e){const i=e.length;let s,n=0;const{iScale:o}=t,{min:a,max:r,minDefined:l,maxDefined:h}=o.getUserBounds();return l&&(n=Z(it(e,o.axis,a).lo,0,i-1)),s=h?Z(it(e,o.axis,r).hi+1,n,i)-n:i-n,{start:n,count:s}}(l,h);if(u<=(i.threshold||4*n))return void Zo(e);let f;switch(s(a)&&(e._data=h,delete e.data,Object.defineProperty(e,"data",{configurable:!0,enumerable:!0,get:function(){return this._decimated},set:function(t){this._data=t}})),i.algorithm){case"lttb":f=function(t,e,i,s,n){const o=n.samples||s;if(o>=i)return t.slice(e,e+i);const a=[],r=(i-2)/(o-2);let l=0;const h=e+i-1;let c,d,u,f,g,p=e;for(a[l++]=t[p],c=0;c<o-2;c++){let s,n=0,o=0;const h=Math.floor((c+1)*r)+1+e,m=Math.min(Math.floor((c+2)*r)+1,i)+e,x=m-h;for(s=h;s<m;s++)n+=t[s].x,o+=t[s].y;n/=x,o/=x;const b=Math.floor(c*r)+1+e,_=Math.min(Math.floor((c+1)*r)+1,i)+e,{x:y,y:v}=t[p];for(u=f=-1,s=b;s<_;s++)f=.5*Math.abs((y-n)*(t[s].y-v)-(y-t[s].x)*(o-v)),f>u&&(u=f,d=t[s],g=s);a[l++]=d,p=g}return a[l++]=t[h],a}(h,d,u,n,i);break;case"min-max":f=function(t,e,i,n){let o,a,r,l,h,c,d,u,f,g,p=0,m=0;const x=[],b=e+i-1,_=t[e].x,y=t[b].x-_;for(o=e;o<e+i;++o){a=t[o],r=(a.x-_)/y*n,l=a.y;const e=0|r;if(e===h)l<f?(f=l,c=o):l>g&&(g=l,d=o),p=(m*p+a.x)/++m;else{const i=o-1;if(!s(c)&&!s(d)){const e=Math.min(c,d),s=Math.max(c,d);e!==u&&e!==i&&x.push({...t[e],x:p}),s!==u&&s!==i&&x.push({...t[s],x:p})}o>0&&i!==u&&x.push(t[i]),x.push(a),h=e,m=0,f=g=l,c=d=u=o}}return x}(h,d,u,n);break;default:throw new Error(`Unsupported decimation algorithm '${i.algorithm}'`)}e._decimated=f}))},destroy(t){Qo(t)}};function ea(t,e,i,s){if(s)return;let n=e[t],o=i[t];return"angle"===t&&(n=G(n),o=G(o)),{property:t,start:n,end:o}}function ia(t,e,i){for(;e>t;e--){const t=i[e];if(!isNaN(t.x)&&!isNaN(t.y))break}return e}function sa(t,e,i,s){return t&&e?s(t[i],e[i]):t?t[i]:e?e[i]:0}function na(t,e){let i=[],s=!1;return n(t)?(s=!0,i=t):i=function(t,e){const{x:i=null,y:s=null}=t||{},n=e.points,o=[];return e.segments.forEach((({start:t,end:e})=>{e=ia(t,e,n);const a=n[t],r=n[e];null!==s?(o.push({x:a.x,y:s}),o.push({x:r.x,y:s})):null!==i&&(o.push({x:i,y:a.y}),o.push({x:i,y:r.y}))})),o}(t,e),i.length?new oo({points:i,options:{tension:0},_loop:s,_fullLoop:s}):null}function oa(t){return t&&!1!==t.fill}function aa(t,e,i){let s=t[e].fill;const n=[e];let o;if(!i)return s;for(;!1!==s&&-1===n.indexOf(s);){if(!a(s))return s;if(o=t[s],!o)return!1;if(o.visible)return s;n.push(s),s=o.fill}return!1}function ra(t,e,i){const s=function(t){const e=t.options,i=e.fill;let s=l(i&&i.target,i);void 0===s&&(s=!!e.backgroundColor);if(!1===s||null===s)return!1;if(!0===s)return"origin";return s}(t);if(o(s))return!isNaN(s.value)&&s;let n=parseFloat(s);return a(n)&&Math.floor(n)===n?function(t,e,i,s){"-"!==t&&"+"!==t||(i=e+i);if(i===e||i<0||i>=s)return!1;return i}(s[0],e,n,i):["origin","start","end","stack","shape"].indexOf(s)>=0&&s}function la(t,e,i){const s=[];for(let n=0;n<i.length;n++){const o=i[n],{first:a,last:r,point:l}=ha(o,e,"x");if(!(!l||a&&r))if(a)s.unshift(l);else if(t.push(l),!r)break}t.push(...s)}function ha(t,e,i){const s=t.interpolate(e,i);if(!s)return{};const n=s[i],o=t.segments,a=t.points;let r=!1,l=!1;for(let t=0;t<o.length;t++){const e=o[t],s=a[e.start][i],h=a[e.end][i];if(tt(n,s,h)){r=n===s,l=n===h;break}}return{first:r,last:l,point:s}}class ca{constructor(t){this.x=t.x,this.y=t.y,this.radius=t.radius}pathSegment(t,e,i){const{x:s,y:n,radius:o}=this;return e=e||{start:0,end:O},t.arc(s,n,o,e.end,e.start,!0),!i.bounds}interpolate(t){const{x:e,y:i,radius:s}=this,n=t.angle;return{x:e+Math.cos(n)*s,y:i+Math.sin(n)*s,angle:n}}}function da(t){const{chart:e,fill:i,line:s}=t;if(a(i))return function(t,e){const i=t.getDatasetMeta(e),s=i&&t.isDatasetVisible(e);return s?i.dataset:null}(e,i);if("stack"===i)return function(t){const{scale:e,index:i,line:s}=t,n=[],o=s.segments,a=s.points,r=function(t,e){const i=[],s=t.getMatchingVisibleMetas("line");for(let t=0;t<s.length;t++){const n=s[t];if(n.index===e)break;n.hidden||i.unshift(n.dataset)}return i}(e,i);r.push(na({x:null,y:e.bottom},s));for(let t=0;t<o.length;t++){const e=o[t];for(let t=e.start;t<=e.end;t++)la(n,a[t],r)}return new oo({points:n,options:{}})}(t);if("shape"===i)return!0;const n=function(t){const e=t.scale||{};if(e.getPointPositionForValue)return function(t){const{scale:e,fill:i}=t,s=e.options,n=e.getLabels().length,a=s.reverse?e.max:e.min,r=function(t,e,i){let s;return s="start"===t?i:"end"===t?e.options.reverse?e.min:e.max:o(t)?t.value:e.getBaseValue(),s}(i,e,a),l=[];if(s.grid.circular){const t=e.getPointPositionForValue(0,a);return new ca({x:t.x,y:t.y,radius:e.getDistanceFromCenterForValue(r)})}for(let t=0;t<n;++t)l.push(e.getPointPositionForValue(t,r));return l}(t);return function(t){const{scale:e={},fill:i}=t,s=function(t,e){let i=null;return"start"===t?i=e.bottom:"end"===t?i=e.top:o(t)?i=e.getPixelForValue(t.value):e.getBasePixel&&(i=e.getBasePixel()),i}(i,e);if(a(s)){const t=e.isHorizontal();return{x:t?s:null,y:t?null:s}}return null}(t)}(t);return n instanceof ca?n:na(n,s)}function ua(t,e,i){const s=da(e),{chart:n,index:o,line:a,scale:r,axis:l}=e,h=a.options,c=h.fill,d=h.backgroundColor,{above:u=d,below:f=d}=c||{},g=n.getDatasetMeta(o),p=Ni(n,g);s&&a.points.length&&(Ie(t,i),function(t,e){const{line:i,target:s,above:n,below:o,area:a,scale:r,clip:l}=e,h=i._loop?"angle":e.axis;t.save();let c=o;o!==n&&("x"===h?(fa(t,s,a.top),pa(t,{line:i,target:s,color:n,scale:r,property:h,clip:l}),t.restore(),t.save(),fa(t,s,a.bottom)):"y"===h&&(ga(t,s,a.left),pa(t,{line:i,target:s,color:o,scale:r,property:h,clip:l}),t.restore(),t.save(),ga(t,s,a.right),c=n));pa(t,{line:i,target:s,color:c,scale:r,property:h,clip:l}),t.restore()}(t,{line:a,target:s,above:u,below:f,area:i,scale:r,axis:l,clip:p}),ze(t))}function fa(t,e,i){const{segments:s,points:n}=e;let o=!0,a=!1;t.beginPath();for(const r of s){const{start:s,end:l}=r,h=n[s],c=n[ia(s,l,n)];o?(t.moveTo(h.x,h.y),o=!1):(t.lineTo(h.x,i),t.lineTo(h.x,h.y)),a=!!e.pathSegment(t,r,{move:a}),a?t.closePath():t.lineTo(c.x,i)}t.lineTo(e.first().x,i),t.closePath(),t.clip()}function ga(t,e,i){const{segments:s,points:n}=e;let o=!0,a=!1;t.beginPath();for(const r of s){const{start:s,end:l}=r,h=n[s],c=n[ia(s,l,n)];o?(t.moveTo(h.x,h.y),o=!1):(t.lineTo(i,h.y),t.lineTo(h.x,h.y)),a=!!e.pathSegment(t,r,{move:a}),a?t.closePath():t.lineTo(i,c.y)}t.lineTo(i,e.first().y),t.closePath(),t.clip()}function pa(t,e){const{line:i,target:s,property:n,color:o,scale:a,clip:r}=e,l=function(t,e,i){const s=t.segments,n=t.points,o=e.points,a=[];for(const t of s){let{start:s,end:r}=t;r=ia(s,r,n);const l=ea(i,n[s],n[r],t.loop);if(!e.segments){a.push({source:t,target:l,start:n[s],end:n[r]});continue}const h=Ii(e,l);for(const e of h){const s=ea(i,o[e.start],o[e.end],e.loop),r=Ri(t,n,s);for(const t of r)a.push({source:t,target:e,start:{[i]:sa(l,s,"start",Math.max)},end:{[i]:sa(l,s,"end",Math.min)}})}}return a}(i,s,n);for(const{source:e,target:h,start:c,end:d}of l){const{style:{backgroundColor:l=o}={}}=e,u=!0!==s;t.save(),t.fillStyle=l,ma(t,a,r,u&&ea(n,c,d)),t.beginPath();const f=!!i.pathSegment(t,e);let g;if(u){f?t.closePath():xa(t,s,d,n);const e=!!s.pathSegment(t,h,{move:f,reverse:!0});g=f&&e,g||xa(t,s,c,n)}t.closePath(),t.fill(g?"evenodd":"nonzero"),t.restore()}}function ma(t,e,i,s){const n=e.chart.chartArea,{property:o,start:a,end:r}=s||{};if("x"===o||"y"===o){let e,s,l,h;"x"===o?(e=a,s=n.top,l=r,h=n.bottom):(e=n.left,s=a,l=n.right,h=r),t.beginPath(),i&&(e=Math.max(e,i.left),l=Math.min(l,i.right),s=Math.max(s,i.top),h=Math.min(h,i.bottom)),t.rect(e,s,l-e,h-s),t.clip()}}function xa(t,e,i,s){const n=e.interpolate(i,s);n&&t.lineTo(n.x,n.y)}var ba={id:"filler",afterDatasetsUpdate(t,e,i){const s=(t.data.datasets||[]).length,n=[];let o,a,r,l;for(a=0;a<s;++a)o=t.getDatasetMeta(a),r=o.dataset,l=null,r&&r.options&&r instanceof oo&&(l={visible:t.isDatasetVisible(a),index:a,fill:ra(r,a,s),chart:t,axis:o.controller.options.indexAxis,scale:o.vScale,line:r}),o.$filler=l,n.push(l);for(a=0;a<s;++a)l=n[a],l&&!1!==l.fill&&(l.fill=aa(n,a,i.propagate))},beforeDraw(t,e,i){const s="beforeDraw"===i.drawTime,n=t.getSortedVisibleDatasetMetas(),o=t.chartArea;for(let e=n.length-1;e>=0;--e){const i=n[e].$filler;i&&(i.line.updateControlPoints(o,i.axis),s&&i.fill&&ua(t.ctx,i,o))}},beforeDatasetsDraw(t,e,i){if("beforeDatasetsDraw"!==i.drawTime)return;const s=t.getSortedVisibleDatasetMetas();for(let e=s.length-1;e>=0;--e){const i=s[e].$filler;oa(i)&&ua(t.ctx,i,t.chartArea)}},beforeDatasetDraw(t,e,i){const s=e.meta.$filler;oa(s)&&"beforeDatasetDraw"===i.drawTime&&ua(t.ctx,s,t.chartArea)},defaults:{propagate:!0,drawTime:"beforeDatasetDraw"}};const _a=(t,e)=>{let{boxHeight:i=e,boxWidth:s=e}=t;return t.usePointStyle&&(i=Math.min(i,e),s=t.pointStyleWidth||Math.min(s,e)),{boxWidth:s,boxHeight:i,itemHeight:Math.max(e,i)}};class ya extends $s{constructor(t){super(),this._added=!1,this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1,this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this.legendItems=void 0,this.columnSizes=void 0,this.lineWidths=void 0,this.maxHeight=void 0,this.maxWidth=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.height=void 0,this.width=void 0,this._margins=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e,i){this.maxWidth=t,this.maxHeight=e,this._margins=i,this.setDimensions(),this.buildLabels(),this.fit()}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=this._margins.left,this.right=this.width):(this.height=this.maxHeight,this.top=this._margins.top,this.bottom=this.height)}buildLabels(){const t=this.options.labels||{};let e=d(t.generateLabels,[this.chart],this)||[];t.filter&&(e=e.filter((e=>t.filter(e,this.chart.data)))),t.sort&&(e=e.sort(((e,i)=>t.sort(e,i,this.chart.data)))),this.options.reverse&&e.reverse(),this.legendItems=e}fit(){const{options:t,ctx:e}=this;if(!t.display)return void(this.width=this.height=0);const i=t.labels,s=Si(i.font),n=s.size,o=this._computeTitleHeight(),{boxWidth:a,itemHeight:r}=_a(i,n);let l,h;e.font=s.string,this.isHorizontal()?(l=this.maxWidth,h=this._fitRows(o,n,a,r)+10):(h=this.maxHeight,l=this._fitCols(o,s,a,r)+10),this.width=Math.min(l,t.maxWidth||this.maxWidth),this.height=Math.min(h,t.maxHeight||this.maxHeight)}_fitRows(t,e,i,s){const{ctx:n,maxWidth:o,options:{labels:{padding:a}}}=this,r=this.legendHitBoxes=[],l=this.lineWidths=[0],h=s+a;let c=t;n.textAlign="left",n.textBaseline="middle";let d=-1,u=-h;return this.legendItems.forEach(((t,f)=>{const g=i+e/2+n.measureText(t.text).width;(0===f||l[l.length-1]+g+2*a>o)&&(c+=h,l[l.length-(f>0?0:1)]=0,u+=h,d++),r[f]={left:0,top:u,row:d,width:g,height:s},l[l.length-1]+=g+a})),c}_fitCols(t,e,i,s){const{ctx:n,maxHeight:o,options:{labels:{padding:a}}}=this,r=this.legendHitBoxes=[],l=this.columnSizes=[],h=o-t;let c=a,d=0,u=0,f=0,g=0;return this.legendItems.forEach(((t,o)=>{const{itemWidth:p,itemHeight:m}=function(t,e,i,s,n){const o=function(t,e,i,s){let n=t.text;n&&"string"!=typeof n&&(n=n.reduce(((t,e)=>t.length>e.length?t:e)));return e+i.size/2+s.measureText(n).width}(s,t,e,i),a=function(t,e,i){let s=t;"string"!=typeof e.text&&(s=va(e,i));return s}(n,s,e.lineHeight);return{itemWidth:o,itemHeight:a}}(i,e,n,t,s);o>0&&u+m+2*a>h&&(c+=d+a,l.push({width:d,height:u}),f+=d+a,g++,d=u=0),r[o]={left:f,top:u,col:g,width:p,height:m},d=Math.max(d,p),u+=m+a})),c+=d,l.push({width:d,height:u}),c}adjustHitBoxes(){if(!this.options.display)return;const t=this._computeTitleHeight(),{legendHitBoxes:e,options:{align:i,labels:{padding:s},rtl:n}}=this,o=Oi(n,this.left,this.width);if(this.isHorizontal()){let n=0,a=ft(i,this.left+s,this.right-this.lineWidths[n]);for(const r of e)n!==r.row&&(n=r.row,a=ft(i,this.left+s,this.right-this.lineWidths[n])),r.top+=this.top+t+s,r.left=o.leftForLtr(o.x(a),r.width),a+=r.width+s}else{let n=0,a=ft(i,this.top+t+s,this.bottom-this.columnSizes[n].height);for(const r of e)r.col!==n&&(n=r.col,a=ft(i,this.top+t+s,this.bottom-this.columnSizes[n].height)),r.top=a,r.left+=this.left+s,r.left=o.leftForLtr(o.x(r.left),r.width),a+=r.height+s}}isHorizontal(){return"top"===this.options.position||"bottom"===this.options.position}draw(){if(this.options.display){const t=this.ctx;Ie(t,this),this._draw(),ze(t)}}_draw(){const{options:t,columnSizes:e,lineWidths:i,ctx:s}=this,{align:n,labels:o}=t,a=ue.color,r=Oi(t.rtl,this.left,this.width),h=Si(o.font),{padding:c}=o,d=h.size,u=d/2;let f;this.drawTitle(),s.textAlign=r.textAlign("left"),s.textBaseline="middle",s.lineWidth=.5,s.font=h.string;const{boxWidth:g,boxHeight:p,itemHeight:m}=_a(o,d),x=this.isHorizontal(),b=this._computeTitleHeight();f=x?{x:ft(n,this.left+c,this.right-i[0]),y:this.top+c+b,line:0}:{x:this.left+c,y:ft(n,this.top+b+c,this.bottom-e[0].height),line:0},Ai(this.ctx,t.textDirection);const _=m+c;this.legendItems.forEach(((y,v)=>{s.strokeStyle=y.fontColor,s.fillStyle=y.fontColor;const M=s.measureText(y.text).width,w=r.textAlign(y.textAlign||(y.textAlign=o.textAlign)),k=g+u+M;let S=f.x,P=f.y;r.setWidth(this.width),x?v>0&&S+k+c>this.right&&(P=f.y+=_,f.line++,S=f.x=ft(n,this.left+c,this.right-i[f.line])):v>0&&P+_>this.bottom&&(S=f.x=S+e[f.line].width+c,f.line++,P=f.y=ft(n,this.top+b+c,this.bottom-e[f.line].height));if(function(t,e,i){if(isNaN(g)||g<=0||isNaN(p)||p<0)return;s.save();const n=l(i.lineWidth,1);if(s.fillStyle=l(i.fillStyle,a),s.lineCap=l(i.lineCap,"butt"),s.lineDashOffset=l(i.lineDashOffset,0),s.lineJoin=l(i.lineJoin,"miter"),s.lineWidth=n,s.strokeStyle=l(i.strokeStyle,a),s.setLineDash(l(i.lineDash,[])),o.usePointStyle){const a={radius:p*Math.SQRT2/2,pointStyle:i.pointStyle,rotation:i.rotation,borderWidth:n},l=r.xPlus(t,g/2);Ee(s,a,l,e+u,o.pointStyleWidth&&g)}else{const o=e+Math.max((d-p)/2,0),a=r.leftForLtr(t,g),l=wi(i.borderRadius);s.beginPath(),Object.values(l).some((t=>0!==t))?He(s,{x:a,y:o,w:g,h:p,radius:l}):s.rect(a,o,g,p),s.fill(),0!==n&&s.stroke()}s.restore()}(r.x(S),P,y),S=gt(w,S+g+u,x?S+k:this.right,t.rtl),function(t,e,i){Ne(s,i.text,t,e+m/2,h,{strikethrough:i.hidden,textAlign:r.textAlign(i.textAlign)})}(r.x(S),P,y),x)f.x+=k+c;else if("string"!=typeof y.text){const t=h.lineHeight;f.y+=va(y,t)+c}else f.y+=_})),Ti(this.ctx,t.textDirection)}drawTitle(){const t=this.options,e=t.title,i=Si(e.font),s=ki(e.padding);if(!e.display)return;const n=Oi(t.rtl,this.left,this.width),o=this.ctx,a=e.position,r=i.size/2,l=s.top+r;let h,c=this.left,d=this.width;if(this.isHorizontal())d=Math.max(...this.lineWidths),h=this.top+l,c=ft(t.align,c,this.right-d);else{const e=this.columnSizes.reduce(((t,e)=>Math.max(t,e.height)),0);h=l+ft(t.align,this.top,this.bottom-e-t.labels.padding-this._computeTitleHeight())}const u=ft(a,c,c+d);o.textAlign=n.textAlign(ut(a)),o.textBaseline="middle",o.strokeStyle=e.color,o.fillStyle=e.color,o.font=i.string,Ne(o,e.text,u,h,i)}_computeTitleHeight(){const t=this.options.title,e=Si(t.font),i=ki(t.padding);return t.display?e.lineHeight+i.height:0}_getLegendItemAt(t,e){let i,s,n;if(tt(t,this.left,this.right)&&tt(e,this.top,this.bottom))for(n=this.legendHitBoxes,i=0;i<n.length;++i)if(s=n[i],tt(t,s.left,s.left+s.width)&&tt(e,s.top,s.top+s.height))return this.legendItems[i];return null}handleEvent(t){const e=this.options;if(!function(t,e){if(("mousemove"===t||"mouseout"===t)&&(e.onHover||e.onLeave))return!0;if(e.onClick&&("click"===t||"mouseup"===t))return!0;return!1}(t.type,e))return;const i=this._getLegendItemAt(t.x,t.y);if("mousemove"===t.type||"mouseout"===t.type){const o=this._hoveredItem,a=(n=i,null!==(s=o)&&null!==n&&s.datasetIndex===n.datasetIndex&&s.index===n.index);o&&!a&&d(e.onLeave,[t,o,this],this),this._hoveredItem=i,i&&!a&&d(e.onHover,[t,i,this],this)}else i&&d(e.onClick,[t,i,this],this);var s,n}}function va(t,e){return e*(t.text?t.text.length:0)}var Ma={id:"legend",_element:ya,start(t,e,i){const s=t.legend=new ya({ctx:t.ctx,options:i,chart:t});ls.configure(t,s,i),ls.addBox(t,s)},stop(t){ls.removeBox(t,t.legend),delete t.legend},beforeUpdate(t,e,i){const s=t.legend;ls.configure(t,s,i),s.options=i},afterUpdate(t){const e=t.legend;e.buildLabels(),e.adjustHitBoxes()},afterEvent(t,e){e.replay||t.legend.handleEvent(e.event)},defaults:{display:!0,position:"top",align:"center",fullSize:!0,reverse:!1,weight:1e3,onClick(t,e,i){const s=e.datasetIndex,n=i.chart;n.isDatasetVisible(s)?(n.hide(s),e.hidden=!0):(n.show(s),e.hidden=!1)},onHover:null,onLeave:null,labels:{color:t=>t.chart.options.color,boxWidth:40,padding:10,generateLabels(t){const e=t.data.datasets,{labels:{usePointStyle:i,pointStyle:s,textAlign:n,color:o,useBorderRadius:a,borderRadius:r}}=t.legend.options;return t._getSortedDatasetMetas().map((t=>{const l=t.controller.getStyle(i?0:void 0),h=ki(l.borderWidth);return{text:e[t.index].label,fillStyle:l.backgroundColor,fontColor:o,hidden:!t.visible,lineCap:l.borderCapStyle,lineDash:l.borderDash,lineDashOffset:l.borderDashOffset,lineJoin:l.borderJoinStyle,lineWidth:(h.width+h.height)/4,strokeStyle:l.borderColor,pointStyle:s||l.pointStyle,rotation:l.rotation,textAlign:n||l.textAlign,borderRadius:a&&(r||l.borderRadius),datasetIndex:t.index}}),this)}},title:{color:t=>t.chart.options.color,display:!1,position:"center",text:""}},descriptors:{_scriptable:t=>!t.startsWith("on"),labels:{_scriptable:t=>!["generateLabels","filter","sort"].includes(t)}}};class wa extends $s{constructor(t){super(),this.chart=t.chart,this.options=t.options,this.ctx=t.ctx,this._padding=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(t,e){const i=this.options;if(this.left=0,this.top=0,!i.display)return void(this.width=this.height=this.right=this.bottom=0);this.width=this.right=t,this.height=this.bottom=e;const s=n(i.text)?i.text.length:1;this._padding=ki(i.padding);const o=s*Si(i.font).lineHeight+this._padding.height;this.isHorizontal()?this.height=o:this.width=o}isHorizontal(){const t=this.options.position;return"top"===t||"bottom"===t}_drawArgs(t){const{top:e,left:i,bottom:s,right:n,options:o}=this,a=o.align;let r,l,h,c=0;return this.isHorizontal()?(l=ft(a,i,n),h=e+t,r=n-i):("left"===o.position?(l=i+t,h=ft(a,s,e),c=-.5*C):(l=n-t,h=ft(a,e,s),c=.5*C),r=s-e),{titleX:l,titleY:h,maxWidth:r,rotation:c}}draw(){const t=this.ctx,e=this.options;if(!e.display)return;const i=Si(e.font),s=i.lineHeight/2+this._padding.top,{titleX:n,titleY:o,maxWidth:a,rotation:r}=this._drawArgs(s);Ne(t,e.text,0,0,i,{color:e.color,maxWidth:a,rotation:r,textAlign:ut(e.align),textBaseline:"middle",translation:[n,o]})}}var ka={id:"title",_element:wa,start(t,e,i){!function(t,e){const i=new wa({ctx:t.ctx,options:e,chart:t});ls.configure(t,i,e),ls.addBox(t,i),t.titleBlock=i}(t,i)},stop(t){const e=t.titleBlock;ls.removeBox(t,e),delete t.titleBlock},beforeUpdate(t,e,i){const s=t.titleBlock;ls.configure(t,s,i),s.options=i},defaults:{align:"center",display:!1,font:{weight:"bold"},fullSize:!0,padding:10,position:"top",text:"",weight:2e3},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const Sa=new WeakMap;var Pa={id:"subtitle",start(t,e,i){const s=new wa({ctx:t.ctx,options:i,chart:t});ls.configure(t,s,i),ls.addBox(t,s),Sa.set(t,s)},stop(t){ls.removeBox(t,Sa.get(t)),Sa.delete(t)},beforeUpdate(t,e,i){const s=Sa.get(t);ls.configure(t,s,i),s.options=i},defaults:{align:"center",display:!1,font:{weight:"normal"},fullSize:!0,padding:0,position:"top",text:"",weight:1500},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const Da={average(t){if(!t.length)return!1;let e,i,s=new Set,n=0,o=0;for(e=0,i=t.length;e<i;++e){const i=t[e].element;if(i&&i.hasValue()){const t=i.tooltipPosition();s.add(t.x),n+=t.y,++o}}if(0===o||0===s.size)return!1;return{x:[...s].reduce(((t,e)=>t+e))/s.size,y:n/o}},nearest(t,e){if(!t.length)return!1;let i,s,n,o=e.x,a=e.y,r=Number.POSITIVE_INFINITY;for(i=0,s=t.length;i<s;++i){const s=t[i].element;if(s&&s.hasValue()){const t=q(e,s.getCenterPoint());t<r&&(r=t,n=s)}}if(n){const t=n.tooltipPosition();o=t.x,a=t.y}return{x:o,y:a}}};function Ca(t,e){return e&&(n(e)?Array.prototype.push.apply(t,e):t.push(e)),t}function Oa(t){return("string"==typeof t||t instanceof String)&&t.indexOf("\n")>-1?t.split("\n"):t}function Aa(t,e){const{element:i,datasetIndex:s,index:n}=e,o=t.getDatasetMeta(s).controller,{label:a,value:r}=o.getLabelAndValue(n);return{chart:t,label:a,parsed:o.getParsed(n),raw:t.data.datasets[s].data[n],formattedValue:r,dataset:o.getDataset(),dataIndex:n,datasetIndex:s,element:i}}function Ta(t,e){const i=t.chart.ctx,{body:s,footer:n,title:o}=t,{boxWidth:a,boxHeight:r}=e,l=Si(e.bodyFont),h=Si(e.titleFont),c=Si(e.footerFont),d=o.length,f=n.length,g=s.length,p=ki(e.padding);let m=p.height,x=0,b=s.reduce(((t,e)=>t+e.before.length+e.lines.length+e.after.length),0);if(b+=t.beforeBody.length+t.afterBody.length,d&&(m+=d*h.lineHeight+(d-1)*e.titleSpacing+e.titleMarginBottom),b){m+=g*(e.displayColors?Math.max(r,l.lineHeight):l.lineHeight)+(b-g)*l.lineHeight+(b-1)*e.bodySpacing}f&&(m+=e.footerMarginTop+f*c.lineHeight+(f-1)*e.footerSpacing);let _=0;const y=function(t){x=Math.max(x,i.measureText(t).width+_)};return i.save(),i.font=h.string,u(t.title,y),i.font=l.string,u(t.beforeBody.concat(t.afterBody),y),_=e.displayColors?a+2+e.boxPadding:0,u(s,(t=>{u(t.before,y),u(t.lines,y),u(t.after,y)})),_=0,i.font=c.string,u(t.footer,y),i.restore(),x+=p.width,{width:x,height:m}}function La(t,e,i,s){const{x:n,width:o}=i,{width:a,chartArea:{left:r,right:l}}=t;let h="center";return"center"===s?h=n<=(r+l)/2?"left":"right":n<=o/2?h="left":n>=a-o/2&&(h="right"),function(t,e,i,s){const{x:n,width:o}=s,a=i.caretSize+i.caretPadding;return"left"===t&&n+o+a>e.width||"right"===t&&n-o-a<0||void 0}(h,t,e,i)&&(h="center"),h}function Ea(t,e,i){const s=i.yAlign||e.yAlign||function(t,e){const{y:i,height:s}=e;return i<s/2?"top":i>t.height-s/2?"bottom":"center"}(t,i);return{xAlign:i.xAlign||e.xAlign||La(t,e,i,s),yAlign:s}}function Ra(t,e,i,s){const{caretSize:n,caretPadding:o,cornerRadius:a}=t,{xAlign:r,yAlign:l}=i,h=n+o,{topLeft:c,topRight:d,bottomLeft:u,bottomRight:f}=wi(a);let g=function(t,e){let{x:i,width:s}=t;return"right"===e?i-=s:"center"===e&&(i-=s/2),i}(e,r);const p=function(t,e,i){let{y:s,height:n}=t;return"top"===e?s+=i:s-="bottom"===e?n+i:n/2,s}(e,l,h);return"center"===l?"left"===r?g+=h:"right"===r&&(g-=h):"left"===r?g-=Math.max(c,u)+n:"right"===r&&(g+=Math.max(d,f)+n),{x:Z(g,0,s.width-e.width),y:Z(p,0,s.height-e.height)}}function Ia(t,e,i){const s=ki(i.padding);return"center"===e?t.x+t.width/2:"right"===e?t.x+t.width-s.right:t.x+s.left}function za(t){return Ca([],Oa(t))}function Fa(t,e){const i=e&&e.dataset&&e.dataset.tooltip&&e.dataset.tooltip.callbacks;return i?t.override(i):t}const Va={beforeTitle:e,title(t){if(t.length>0){const e=t[0],i=e.chart.data.labels,s=i?i.length:0;if(this&&this.options&&"dataset"===this.options.mode)return e.dataset.label||"";if(e.label)return e.label;if(s>0&&e.dataIndex<s)return i[e.dataIndex]}return""},afterTitle:e,beforeBody:e,beforeLabel:e,label(t){if(this&&this.options&&"dataset"===this.options.mode)return t.label+": "+t.formattedValue||t.formattedValue;let e=t.dataset.label||"";e&&(e+=": ");const i=t.formattedValue;return s(i)||(e+=i),e},labelColor(t){const e=t.chart.getDatasetMeta(t.datasetIndex).controller.getStyle(t.dataIndex);return{borderColor:e.borderColor,backgroundColor:e.backgroundColor,borderWidth:e.borderWidth,borderDash:e.borderDash,borderDashOffset:e.borderDashOffset,borderRadius:0}},labelTextColor(){return this.options.bodyColor},labelPointStyle(t){const e=t.chart.getDatasetMeta(t.datasetIndex).controller.getStyle(t.dataIndex);return{pointStyle:e.pointStyle,rotation:e.rotation}},afterLabel:e,afterBody:e,beforeFooter:e,footer:e,afterFooter:e};function Ba(t,e,i,s){const n=t[e].call(i,s);return void 0===n?Va[e].call(i,s):n}class Wa extends $s{static positioners=Da;constructor(t){super(),this.opacity=0,this._active=[],this._eventPosition=void 0,this._size=void 0,this._cachedAnimations=void 0,this._tooltipItems=[],this.$animations=void 0,this.$context=void 0,this.chart=t.chart,this.options=t.options,this.dataPoints=void 0,this.title=void 0,this.beforeBody=void 0,this.body=void 0,this.afterBody=void 0,this.footer=void 0,this.xAlign=void 0,this.yAlign=void 0,this.x=void 0,this.y=void 0,this.height=void 0,this.width=void 0,this.caretX=void 0,this.caretY=void 0,this.labelColors=void 0,this.labelPointStyles=void 0,this.labelTextColors=void 0}initialize(t){this.options=t,this._cachedAnimations=void 0,this.$context=void 0}_resolveAnimations(){const t=this._cachedAnimations;if(t)return t;const e=this.chart,i=this.options.setContext(this.getContext()),s=i.enabled&&e.options.animation&&i.animations,n=new Ts(this.chart,s);return s._cacheable&&(this._cachedAnimations=Object.freeze(n)),n}getContext(){return this.$context||(this.$context=(t=this.chart.getContext(),e=this,i=this._tooltipItems,Ci(t,{tooltip:e,tooltipItems:i,type:"tooltip"})));var t,e,i}getTitle(t,e){const{callbacks:i}=e,s=Ba(i,"beforeTitle",this,t),n=Ba(i,"title",this,t),o=Ba(i,"afterTitle",this,t);let a=[];return a=Ca(a,Oa(s)),a=Ca(a,Oa(n)),a=Ca(a,Oa(o)),a}getBeforeBody(t,e){return za(Ba(e.callbacks,"beforeBody",this,t))}getBody(t,e){const{callbacks:i}=e,s=[];return u(t,(t=>{const e={before:[],lines:[],after:[]},n=Fa(i,t);Ca(e.before,Oa(Ba(n,"beforeLabel",this,t))),Ca(e.lines,Ba(n,"label",this,t)),Ca(e.after,Oa(Ba(n,"afterLabel",this,t))),s.push(e)})),s}getAfterBody(t,e){return za(Ba(e.callbacks,"afterBody",this,t))}getFooter(t,e){const{callbacks:i}=e,s=Ba(i,"beforeFooter",this,t),n=Ba(i,"footer",this,t),o=Ba(i,"afterFooter",this,t);let a=[];return a=Ca(a,Oa(s)),a=Ca(a,Oa(n)),a=Ca(a,Oa(o)),a}_createItems(t){const e=this._active,i=this.chart.data,s=[],n=[],o=[];let a,r,l=[];for(a=0,r=e.length;a<r;++a)l.push(Aa(this.chart,e[a]));return t.filter&&(l=l.filter(((e,s,n)=>t.filter(e,s,n,i)))),t.itemSort&&(l=l.sort(((e,s)=>t.itemSort(e,s,i)))),u(l,(e=>{const i=Fa(t.callbacks,e);s.push(Ba(i,"labelColor",this,e)),n.push(Ba(i,"labelPointStyle",this,e)),o.push(Ba(i,"labelTextColor",this,e))})),this.labelColors=s,this.labelPointStyles=n,this.labelTextColors=o,this.dataPoints=l,l}update(t,e){const i=this.options.setContext(this.getContext()),s=this._active;let n,o=[];if(s.length){const t=Da[i.position].call(this,s,this._eventPosition);o=this._createItems(i),this.title=this.getTitle(o,i),this.beforeBody=this.getBeforeBody(o,i),this.body=this.getBody(o,i),this.afterBody=this.getAfterBody(o,i),this.footer=this.getFooter(o,i);const e=this._size=Ta(this,i),a=Object.assign({},t,e),r=Ea(this.chart,i,a),l=Ra(i,a,r,this.chart);this.xAlign=r.xAlign,this.yAlign=r.yAlign,n={opacity:1,x:l.x,y:l.y,width:e.width,height:e.height,caretX:t.x,caretY:t.y}}else 0!==this.opacity&&(n={opacity:0});this._tooltipItems=o,this.$context=void 0,n&&this._resolveAnimations().update(this,n),t&&i.external&&i.external.call(this,{chart:this.chart,tooltip:this,replay:e})}drawCaret(t,e,i,s){const n=this.getCaretPosition(t,i,s);e.lineTo(n.x1,n.y1),e.lineTo(n.x2,n.y2),e.lineTo(n.x3,n.y3)}getCaretPosition(t,e,i){const{xAlign:s,yAlign:n}=this,{caretSize:o,cornerRadius:a}=i,{topLeft:r,topRight:l,bottomLeft:h,bottomRight:c}=wi(a),{x:d,y:u}=t,{width:f,height:g}=e;let p,m,x,b,_,y;return"center"===n?(_=u+g/2,"left"===s?(p=d,m=p-o,b=_+o,y=_-o):(p=d+f,m=p+o,b=_-o,y=_+o),x=p):(m="left"===s?d+Math.max(r,h)+o:"right"===s?d+f-Math.max(l,c)-o:this.caretX,"top"===n?(b=u,_=b-o,p=m-o,x=m+o):(b=u+g,_=b+o,p=m+o,x=m-o),y=b),{x1:p,x2:m,x3:x,y1:b,y2:_,y3:y}}drawTitle(t,e,i){const s=this.title,n=s.length;let o,a,r;if(n){const l=Oi(i.rtl,this.x,this.width);for(t.x=Ia(this,i.titleAlign,i),e.textAlign=l.textAlign(i.titleAlign),e.textBaseline="middle",o=Si(i.titleFont),a=i.titleSpacing,e.fillStyle=i.titleColor,e.font=o.string,r=0;r<n;++r)e.fillText(s[r],l.x(t.x),t.y+o.lineHeight/2),t.y+=o.lineHeight+a,r+1===n&&(t.y+=i.titleMarginBottom-a)}}_drawColorBox(t,e,i,s,n){const a=this.labelColors[i],r=this.labelPointStyles[i],{boxHeight:l,boxWidth:h}=n,c=Si(n.bodyFont),d=Ia(this,"left",n),u=s.x(d),f=l<c.lineHeight?(c.lineHeight-l)/2:0,g=e.y+f;if(n.usePointStyle){const e={radius:Math.min(h,l)/2,pointStyle:r.pointStyle,rotation:r.rotation,borderWidth:1},i=s.leftForLtr(u,h)+h/2,o=g+l/2;t.strokeStyle=n.multiKeyBackground,t.fillStyle=n.multiKeyBackground,Le(t,e,i,o),t.strokeStyle=a.borderColor,t.fillStyle=a.backgroundColor,Le(t,e,i,o)}else{t.lineWidth=o(a.borderWidth)?Math.max(...Object.values(a.borderWidth)):a.borderWidth||1,t.strokeStyle=a.borderColor,t.setLineDash(a.borderDash||[]),t.lineDashOffset=a.borderDashOffset||0;const e=s.leftForLtr(u,h),i=s.leftForLtr(s.xPlus(u,1),h-2),r=wi(a.borderRadius);Object.values(r).some((t=>0!==t))?(t.beginPath(),t.fillStyle=n.multiKeyBackground,He(t,{x:e,y:g,w:h,h:l,radius:r}),t.fill(),t.stroke(),t.fillStyle=a.backgroundColor,t.beginPath(),He(t,{x:i,y:g+1,w:h-2,h:l-2,radius:r}),t.fill()):(t.fillStyle=n.multiKeyBackground,t.fillRect(e,g,h,l),t.strokeRect(e,g,h,l),t.fillStyle=a.backgroundColor,t.fillRect(i,g+1,h-2,l-2))}t.fillStyle=this.labelTextColors[i]}drawBody(t,e,i){const{body:s}=this,{bodySpacing:n,bodyAlign:o,displayColors:a,boxHeight:r,boxWidth:l,boxPadding:h}=i,c=Si(i.bodyFont);let d=c.lineHeight,f=0;const g=Oi(i.rtl,this.x,this.width),p=function(i){e.fillText(i,g.x(t.x+f),t.y+d/2),t.y+=d+n},m=g.textAlign(o);let x,b,_,y,v,M,w;for(e.textAlign=o,e.textBaseline="middle",e.font=c.string,t.x=Ia(this,m,i),e.fillStyle=i.bodyColor,u(this.beforeBody,p),f=a&&"right"!==m?"center"===o?l/2+h:l+2+h:0,y=0,M=s.length;y<M;++y){for(x=s[y],b=this.labelTextColors[y],e.fillStyle=b,u(x.before,p),_=x.lines,a&&_.length&&(this._drawColorBox(e,t,y,g,i),d=Math.max(c.lineHeight,r)),v=0,w=_.length;v<w;++v)p(_[v]),d=c.lineHeight;u(x.after,p)}f=0,d=c.lineHeight,u(this.afterBody,p),t.y-=n}drawFooter(t,e,i){const s=this.footer,n=s.length;let o,a;if(n){const r=Oi(i.rtl,this.x,this.width);for(t.x=Ia(this,i.footerAlign,i),t.y+=i.footerMarginTop,e.textAlign=r.textAlign(i.footerAlign),e.textBaseline="middle",o=Si(i.footerFont),e.fillStyle=i.footerColor,e.font=o.string,a=0;a<n;++a)e.fillText(s[a],r.x(t.x),t.y+o.lineHeight/2),t.y+=o.lineHeight+i.footerSpacing}}drawBackground(t,e,i,s){const{xAlign:n,yAlign:o}=this,{x:a,y:r}=t,{width:l,height:h}=i,{topLeft:c,topRight:d,bottomLeft:u,bottomRight:f}=wi(s.cornerRadius);e.fillStyle=s.backgroundColor,e.strokeStyle=s.borderColor,e.lineWidth=s.borderWidth,e.beginPath(),e.moveTo(a+c,r),"top"===o&&this.drawCaret(t,e,i,s),e.lineTo(a+l-d,r),e.quadraticCurveTo(a+l,r,a+l,r+d),"center"===o&&"right"===n&&this.drawCaret(t,e,i,s),e.lineTo(a+l,r+h-f),e.quadraticCurveTo(a+l,r+h,a+l-f,r+h),"bottom"===o&&this.drawCaret(t,e,i,s),e.lineTo(a+u,r+h),e.quadraticCurveTo(a,r+h,a,r+h-u),"center"===o&&"left"===n&&this.drawCaret(t,e,i,s),e.lineTo(a,r+c),e.quadraticCurveTo(a,r,a+c,r),e.closePath(),e.fill(),s.borderWidth>0&&e.stroke()}_updateAnimationTarget(t){const e=this.chart,i=this.$animations,s=i&&i.x,n=i&&i.y;if(s||n){const i=Da[t.position].call(this,this._active,this._eventPosition);if(!i)return;const o=this._size=Ta(this,t),a=Object.assign({},i,this._size),r=Ea(e,t,a),l=Ra(t,a,r,e);s._to===l.x&&n._to===l.y||(this.xAlign=r.xAlign,this.yAlign=r.yAlign,this.width=o.width,this.height=o.height,this.caretX=i.x,this.caretY=i.y,this._resolveAnimations().update(this,l))}}_willRender(){return!!this.opacity}draw(t){const e=this.options.setContext(this.getContext());let i=this.opacity;if(!i)return;this._updateAnimationTarget(e);const s={width:this.width,height:this.height},n={x:this.x,y:this.y};i=Math.abs(i)<.001?0:i;const o=ki(e.padding),a=this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length;e.enabled&&a&&(t.save(),t.globalAlpha=i,this.drawBackground(n,t,s,e),Ai(t,e.textDirection),n.y+=o.top,this.drawTitle(n,t,e),this.drawBody(n,t,e),this.drawFooter(n,t,e),Ti(t,e.textDirection),t.restore())}getActiveElements(){return this._active||[]}setActiveElements(t,e){const i=this._active,s=t.map((({datasetIndex:t,index:e})=>{const i=this.chart.getDatasetMeta(t);if(!i)throw new Error("Cannot find a dataset at index "+t);return{datasetIndex:t,element:i.data[e],index:e}})),n=!f(i,s),o=this._positionChanged(s,e);(n||o)&&(this._active=s,this._eventPosition=e,this._ignoreReplayEvents=!0,this.update(!0))}handleEvent(t,e,i=!0){if(e&&this._ignoreReplayEvents)return!1;this._ignoreReplayEvents=!1;const s=this.options,n=this._active||[],o=this._getActiveElements(t,n,e,i),a=this._positionChanged(o,t),r=e||!f(o,n)||a;return r&&(this._active=o,(s.enabled||s.external)&&(this._eventPosition={x:t.x,y:t.y},this.update(!0,e))),r}_getActiveElements(t,e,i,s){const n=this.options;if("mouseout"===t.type)return[];if(!s)return e.filter((t=>this.chart.data.datasets[t.datasetIndex]&&void 0!==this.chart.getDatasetMeta(t.datasetIndex).controller.getParsed(t.index)));const o=this.chart.getElementsAtEventForMode(t,n.mode,n,i);return n.reverse&&o.reverse(),o}_positionChanged(t,e){const{caretX:i,caretY:s,options:n}=this,o=Da[n.position].call(this,t,e);return!1!==o&&(i!==o.x||s!==o.y)}}var Na={id:"tooltip",_element:Wa,positioners:Da,afterInit(t,e,i){i&&(t.tooltip=new Wa({chart:t,options:i}))},beforeUpdate(t,e,i){t.tooltip&&t.tooltip.initialize(i)},reset(t,e,i){t.tooltip&&t.tooltip.initialize(i)},afterDraw(t){const e=t.tooltip;if(e&&e._willRender()){const i={tooltip:e};if(!1===t.notifyPlugins("beforeTooltipDraw",{...i,cancelable:!0}))return;e.draw(t.ctx),t.notifyPlugins("afterTooltipDraw",i)}},afterEvent(t,e){if(t.tooltip){const i=e.replay;t.tooltip.handleEvent(e.event,i,e.inChartArea)&&(e.changed=!0)}},defaults:{enabled:!0,external:null,position:"average",backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",titleFont:{weight:"bold"},titleSpacing:2,titleMarginBottom:6,titleAlign:"left",bodyColor:"#fff",bodySpacing:2,bodyFont:{},bodyAlign:"left",footerColor:"#fff",footerSpacing:2,footerMarginTop:6,footerFont:{weight:"bold"},footerAlign:"left",padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(t,e)=>e.bodyFont.size,boxWidth:(t,e)=>e.bodyFont.size,multiKeyBackground:"#fff",displayColors:!0,boxPadding:0,borderColor:"rgba(0,0,0,0)",borderWidth:0,animation:{duration:400,easing:"easeOutQuart"},animations:{numbers:{type:"number",properties:["x","y","width","height","caretX","caretY"]},opacity:{easing:"linear",duration:200}},callbacks:Va},defaultRoutes:{bodyFont:"font",footerFont:"font",titleFont:"font"},descriptors:{_scriptable:t=>"filter"!==t&&"itemSort"!==t&&"external"!==t,_indexable:!1,callbacks:{_scriptable:!1,_indexable:!1},animation:{_fallback:!1},animations:{_fallback:"animation"}},additionalOptionScopes:["interaction"]};return Tn.register(Un,$o,go,t),Tn.helpers={...Hi},Tn._adapters=In,Tn.Animation=As,Tn.Animations=Ts,Tn.animator=bt,Tn.controllers=nn.controllers.items,Tn.DatasetController=js,Tn.Element=$s,Tn.elements=go,Tn.Interaction=Ki,Tn.layouts=ls,Tn.platforms=Ds,Tn.Scale=tn,Tn.Ticks=ae,Object.assign(Tn,Un,$o,go,t,Ds),Tn.Chart=Tn,"undefined"!=typeof window&&(window.Chart=Tn),Tn}));
//# sourceMappingURL=chart.umd.js.map
</script>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-primary: #0a0a0b;
  --bg-secondary: #111113;
  --bg-tertiary: #1a1a1e;
  --bg-elevated: #222228;
  --glass-border: rgba(255, 255, 255, 0.08);
  --text-primary: #f4f4f5;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;
  --accent: #10b981;
  --accent-glow: rgba(16, 185, 129, 0.15);
  --success: #34d399;
  --success-glow: rgba(52, 211, 153, 0.12);
  --warning: #fbbf24;
  --warning-glow: rgba(251, 191, 36, 0.12);
  --danger: #f87171;
  --danger-glow: rgba(248, 113, 113, 0.12);
  --info: #60a5fa;
  --info-glow: rgba(96, 165, 250, 0.12);
  --provision: #a78bfa;
  --provision-glow: rgba(167, 139, 250, 0.12);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
}
[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f1f5f9;
  --bg-elevated: #ffffff;
  --glass-border: rgba(0, 0, 0, 0.08);
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --accent: #059669;
  --accent-glow: rgba(5, 150, 105, 0.12);
  --success: #10b981;
  --success-glow: rgba(16, 185, 129, 0.1);
  --warning: #f59e0b;
  --warning-glow: rgba(245, 158, 11, 0.1);
  --danger: #ef4444;
  --danger-glow: rgba(239, 68, 68, 0.1);
  --info: #3b82f6;
  --info-glow: rgba(59, 130, 246, 0.1);
  --provision: #8b5cf6;
  --provision-glow: rgba(139, 92, 246, 0.1);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; min-height: 100vh; padding-top: 52px; padding-bottom: 72px; }

.toast-container { position: fixed; top: 64px; right: 16px; z-index: 300; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { pointer-events: auto; background: var(--bg-elevated); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 14px 18px; display: flex; align-items: center; gap: 12px; font-size: 13px; font-weight: 500; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: toastIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); min-width: 280px; }
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.info { border-left: 4px solid var(--info); }
.toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; margin-left: auto; padding: 4px; font-size: 16px; }
@keyframes toastIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

.header { position: fixed; top: 0; left: 0; right: 0; background: rgba(10, 10, 11, 0.92); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); z-index: 100; }
.header-content { max-width: 900px; margin: 0 auto; padding: 8px 16px; display: flex; align-items: center; gap: 12px; }
.logo { font-size: 20px; font-weight: 800; background: linear-gradient(135deg, var(--accent), #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
.nav-tabs { display: flex; gap: 4px; background: var(--bg-tertiary); padding: 4px; border-radius: 10px; margin-left: auto; }
.nav-tab { background: transparent; color: var(--text-muted); border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; }
.nav-tab:hover { color: var(--text-secondary); }
.nav-tab.active { background: var(--accent); color: white; }
.period-selector { display: flex; align-items: center; gap: 4px; }
.period-btn { background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 4px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; transition: all 0.2s; }
.period-btn:hover { border-color: var(--accent); color: var(--text-secondary); }
.period-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
.period-select { background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-secondary); padding: 4px 6px; border-radius: 6px; font-size: 10px; cursor: pointer; outline: none; }
.period-select:focus { border-color: var(--accent); }
.period-input { background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 4px 6px; border-radius: 6px; font-size: 10px; width: 100px; }
.year-nav { display: flex; align-items: center; gap: 2px; }
.year-nav-btn { background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-muted); width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.year-nav-btn:hover { border-color: var(--accent); color: var(--accent); }

.container { max-width: 900px; margin: 0 auto; padding: 16px; }

.page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.page-title { font-size: 20px; font-weight: 800; }
.page-actions { display: flex; gap: 8px; }

.hero { background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 16px; position: relative; overflow: hidden; transition: all 0.3s; }
.hero:hover { border-color: var(--accent); transform: translateY(-2px); }
.hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--success)); }
.hero.negative::before { background: linear-gradient(90deg, var(--danger), var(--warning)); }
/* V49: Hero cliquable avec indicateur visible */
.hero.interactive { cursor: pointer; }
.hero.interactive::after { content: '↗ projections'; position: absolute; right: 16px; top: 16px; font-size: 10px; font-weight: 600; color: var(--accent); background: var(--accent-glow); padding: 4px 10px; border-radius: 12px; opacity: 0.85; transition: all 0.2s; }
.hero.interactive:hover::after { opacity: 1; background: var(--accent); color: white; }
.hero-main { text-align: center; }
.hero-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
.hero-value { font-size: 48px; font-weight: 800; letter-spacing: -2px; margin: 8px 0; }
.hero-value.positive { color: var(--success); }
.hero-value.negative { color: var(--danger); }
.hero-sub { font-size: 12px; color: var(--text-muted); }
.hero-stats { display: flex; justify-content: center; gap: 24px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--glass-border); }
.hero-stat { text-align: center; }
.hero-stat-value { font-size: 18px; font-weight: 700; }
.hero-stat-label { font-size: 10px; color: var(--text-muted); }

.alerts-container { margin-bottom: 16px; }
.alerts-summary { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; }
.alerts-summary:hover { border-color: var(--accent); }
.alerts-badge { background: var(--danger); color: white; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 12px; }
.alerts-text { flex: 1; font-size: 13px; }
.alerts-chevron { color: var(--text-muted); transition: transform 0.2s; }
.alerts-summary.open .alerts-chevron { transform: rotate(180deg); }
.alerts-list { display: none; margin-top: 8px; }
.alerts-list.open { display: block; }

.alert { padding: 14px 16px; border-radius: var(--radius-md); margin-bottom: 8px; display: flex; align-items: flex-start; gap: 12px; font-size: 13px; }
.alert-warning { background: var(--warning-glow); border: 1px solid rgba(251,191,36,0.25); }
.alert-success { background: var(--success-glow); border: 1px solid rgba(52,211,153,0.25); }
.alert-info { background: var(--info-glow); border: 1px solid rgba(96,165,250,0.25); }
.alert-danger { background: var(--danger-glow); border: 1px solid rgba(248,113,113,0.25); }
.alert-icon { font-size: 18px; flex-shrink: 0; }
.alert-content { flex: 1; }
.alert-title { font-weight: 700; font-size: 13px; }
.alert-text { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
.alert-btn { background: rgba(255,255,255,0.15); border: none; color: inherit; padding: 6px 14px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; margin-top: 8px; margin-right: 8px; transition: all 0.2s; }

.section { margin-bottom: 20px; }
.section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.section-title-icon { font-size: 14px; }

.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
@media (max-width: 600px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
.kpi { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 14px; transition: all 0.2s; position: relative; overflow: hidden; }
.kpi::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent); }
.kpi.success::before { background: var(--success); }
.kpi.warning::before { background: var(--warning); }
.kpi.danger::before { background: var(--danger); }
.kpi.info::before { background: var(--info); }
.kpi.provision::before { background: var(--provision); }
/* V48: KPI cliquables - indicateur TRÈS VISIBLE */
.kpi.interactive { cursor: pointer; }
.kpi.interactive:hover { background: var(--bg-tertiary); transform: translateY(-2px); border-color: var(--accent); }
/* V48: Badge textuel bien visible "↗ détail" - TOUJOURS AFFICHÉ */
.kpi.interactive::after { 
  content: '↗ détail'; 
  position: absolute; 
  right: 8px; 
  top: 8px; 
  font-size: 9px; 
  font-weight: 600;
  color: var(--accent); 
  background: var(--accent-glow);
  padding: 2px 6px;
  border-radius: 8px;
  opacity: 0.85; 
  transition: all 0.2s; 
}
.kpi.interactive:hover::after { opacity: 1; background: var(--accent); color: white; }
/* KPI non cliquables - pas de cursor pointer ni d'indicateur */
.kpi:not(.interactive) { cursor: default; }
.kpi-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 4px; }
.kpi-value { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
.kpi-sub { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
.kpi-badge { font-size: 9px; padding: 3px 8px; border-radius: 12px; display: inline-block; font-weight: 600; }
.kpi-sparkline { height: 24px; margin-top: 6px; }
.kpi-trend { font-size: 10px; padding: 2px 6px; border-radius: 8px; font-weight: 700; margin-left: 4px; }
.kpi-trend.up { background: var(--success-glow); color: var(--success); }
.kpi-trend.down { background: var(--danger-glow); color: var(--danger); }

/* V48: Classe universelle pour éléments EXPLICITEMENT cliquables */
.interactive { cursor: pointer; transition: all 0.2s; position: relative; }
.interactive:hover { background: var(--bg-tertiary); }
.interactive:active { transform: scale(0.98); }

.text-success { color: var(--success); }
.text-warning { color: var(--warning); }
.text-danger { color: var(--danger); }
.text-info { color: var(--info); }
.text-provision { color: var(--provision); }

.timeline { display: flex; gap: 4px; overflow-x: auto; padding: 8px 0; margin: -8px 0; scrollbar-width: none; }
.timeline::-webkit-scrollbar { display: none; }
.timeline-item { flex-shrink: 0; width: 60px; text-align: center; padding: 8px 4px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; position: relative; }
.timeline-item:hover { background: var(--bg-tertiary); transform: translateY(-2px); }
.timeline-item.active { background: var(--accent-glow); border-color: var(--accent); }
.timeline-item.past { opacity: 0.5; }
.timeline-item.past:hover { opacity: 0.8; }
.timeline-month { font-size: 10px; font-weight: 600; margin-bottom: 4px; }
.timeline-amount { font-size: 11px; font-weight: 700; }
.timeline-dot { width: 8px; height: 8px; border-radius: 50%; margin: 6px auto 0; }
.timeline-dot.paid { background: var(--success); }
.timeline-dot.pending { background: var(--warning); }
.timeline-dot.empty { background: var(--bg-tertiary); }
.timeline-dot.provision { background: var(--provision); }
.timeline-dot.late { background: var(--danger); animation: pulse 1s infinite; }
.timeline-dot.warning { background: var(--warning); }

.actions-widget { background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(59,130,246,0.08)); border: 1px solid rgba(139,92,246,0.25); border-radius: var(--radius-xl); padding: 16px; margin-bottom: 16px; }
.actions-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.actions-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.actions-badge { background: var(--accent); color: white; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; }
.actions-list { display: flex; flex-direction: column; gap: 8px; }
.action-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; }
.action-item:hover { border-color: var(--accent); transform: translateX(4px); }
.action-item.urgent { border-left: 3px solid var(--danger); background: linear-gradient(90deg, rgba(248,113,113,0.08), transparent); }
.action-item.warning { border-left: 3px solid var(--warning); background: linear-gradient(90deg, rgba(251,191,36,0.08), transparent); }
.action-item.info { border-left: 3px solid var(--info); }
.action-item.success { border-left: 3px solid var(--success); background: linear-gradient(90deg, rgba(52,211,153,0.08), transparent); }
.action-icon { font-size: 20px; flex-shrink: 0; }
.action-content { flex: 1; min-width: 0; }
.action-label { font-size: 13px; font-weight: 600; }
.action-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.action-btn { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
.action-btn:hover { background: var(--accent-hover); transform: scale(1.05); }
.action-btn.secondary { background: var(--bg-tertiary); color: var(--text-primary); }
.action-btn.danger { background: var(--danger); }
.action-btn.success { background: var(--success); }
.legal-timeline { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 20px; margin-bottom: 16px; overflow: hidden; }
.legal-timeline-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.legal-timeline-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.legal-timeline-track { position: relative; padding: 20px 0; }
.legal-timeline-line { position: absolute; top: 50%; left: 40px; right: 40px; height: 4px; background: linear-gradient(90deg, var(--success), var(--warning), var(--danger)); border-radius: 2px; transform: translateY(-50%); }
.legal-timeline-items { display: flex; justify-content: space-between; position: relative; z-index: 1; }
.legal-milestone { display: flex; flex-direction: column; align-items: center; width: 80px; cursor: pointer; transition: all 0.2s; }
.legal-milestone:hover { transform: translateY(-4px); }
.legal-milestone-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid var(--bg-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.2s; }
.legal-milestone-dot.passed { background: var(--success); }
.legal-milestone-dot.current { background: var(--warning); animation: pulse-glow 2s infinite; }
.legal-milestone-dot.upcoming { background: var(--bg-tertiary); border-color: var(--glass-border); }
.legal-milestone-dot.urgent { background: var(--danger); animation: pulse-urgent 1s infinite; }
@keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(251,191,36,0.4); } 50% { box-shadow: 0 0 0 8px rgba(251,191,36,0); } }
@keyframes pulse-urgent { 0%, 100% { box-shadow: 0 0 0 0 rgba(248,113,113,0.6); } 50% { box-shadow: 0 0 0 10px rgba(248,113,113,0); } }
.legal-milestone-label { margin-top: 10px; font-size: 10px; font-weight: 600; text-align: center; color: var(--text-secondary); }
.legal-milestone-date { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
.legal-milestone-countdown { font-size: 10px; font-weight: 700; margin-top: 4px; padding: 2px 8px; border-radius: 10px; }
.legal-milestone-countdown.urgent { background: var(--danger-glow); color: var(--danger); }
.legal-milestone-countdown.warning { background: var(--warning-glow); color: var(--warning); }
.legal-milestone-countdown.ok { background: var(--success-glow); color: var(--success); }
.health-score { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; }
.health-score:hover { border-color: var(--accent); transform: translateY(-2px); }
.health-score-header { display: flex; align-items: center; justify-content: space-between; }
.health-score-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.health-score-value { display: flex; align-items: center; gap: 12px; }
.health-score-circle { width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 800; position: relative; }
.health-score-circle::before { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 3px solid transparent; }
.health-score-circle.excellent { background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(16,185,129,0.1)); color: var(--success); }
.health-score-circle.excellent::before { border-color: var(--success); }
.health-score-circle.good { background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(59,130,246,0.1)); color: var(--info); }
.health-score-circle.good::before { border-color: var(--info); }
.health-score-circle.warning { background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1)); color: var(--warning); }
.health-score-circle.warning::before { border-color: var(--warning); }
.health-score-circle.danger { background: linear-gradient(135deg, rgba(248,113,113,0.2), rgba(239,68,68,0.1)); color: var(--danger); }
.health-score-circle.danger::before { border-color: var(--danger); }
.health-score-label { font-size: 16px; font-weight: 700; }
.health-score-sub { font-size: 11px; color: var(--text-muted); }
.health-score-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--glass-border); }
.health-metric { text-align: center; }
.health-metric-icon { font-size: 16px; margin-bottom: 4px; }
.health-metric-value { font-size: 12px; font-weight: 700; }
.health-metric-label { font-size: 9px; color: var(--text-muted); }
.tva-module { background: linear-gradient(135deg, rgba(236,72,153,0.08), rgba(139,92,246,0.08)); border: 1px solid rgba(236,72,153,0.25); border-radius: var(--radius-xl); padding: 16px; margin-bottom: 16px; cursor: pointer; }
.tva-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.tva-status-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; }
.tva-status-badge.franchise { background: var(--success-glow); color: var(--success); }
.tva-status-badge.assujetti { background: rgba(236,72,153,0.15); color: #ec4899; }
.tva-gauge { height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin: 12px 0; position: relative; }
.tva-gauge-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.tva-gauge-fill.safe { background: linear-gradient(90deg, var(--success), #34d399); }
.tva-gauge-fill.warning { background: linear-gradient(90deg, var(--warning), #fbbf24); }
.tva-gauge-fill.danger { background: linear-gradient(90deg, var(--danger), #f87171); }
.tva-gauge-marker { position: absolute; top: -4px; bottom: -4px; width: 2px; background: white; }
.tva-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
.tva-info-item { text-align: center; padding: 10px; background: var(--bg-secondary); border-radius: var(--radius-md); }
.tva-info-value { font-size: 14px; font-weight: 700; }
.tva-info-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
.quick-actions { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.quick-action-btn { display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: var(--bg-secondary); border: 1px dashed var(--glass-border); border-radius: var(--radius-md); font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
.quick-action-btn:hover { border-style: solid; border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.quick-action-btn .icon { font-size: 16px; }

.charges-panel { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); overflow: hidden; margin-bottom: 16px; }
.charges-tabs { display: flex; border-bottom: 1px solid var(--glass-border); }
.charges-tab { flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; color: var(--text-muted); }
.charges-tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.charges-tab.active { color: var(--accent); background: var(--bg-tertiary); }
.charges-tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--accent); }
.charges-tab-badge { background: var(--danger); color: white; font-size: 9px; padding: 2px 6px; border-radius: 8px; margin-left: 6px; }
.charges-list { padding: 12px; max-height: 280px; overflow-y: auto; }
.charge-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
.charge-item:hover { background: var(--accent-glow); }
.charge-item.paid { opacity: 0.5; }
.charge-cat-badge { font-size: 9px; font-weight: 700; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; margin-right: 10px; }
.charge-cat-badge.urssaf { background: rgba(248,113,113,0.15); color: var(--danger); }
.charge-cat-badge.tva { background: rgba(236,72,153,0.15); color: #ec4899; }
.charge-cat-badge.cfp { background: rgba(96,165,250,0.15); color: var(--info); }
.charge-cat-badge.ir { background: rgba(251,191,36,0.15); color: var(--warning); }
.charge-item-info { flex: 1; }
.charge-item-label { font-size: 12px; font-weight: 500; }
.charge-item-sub { font-size: 10px; color: var(--text-muted); }
.charge-item-amount { font-size: 13px; font-weight: 700; margin-right: 12px; }
.charge-check { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; transition: all 0.2s; }
.charge-check:hover { border-color: var(--success); background: var(--success-glow); }
.charge-check.checked { background: var(--success); border-color: var(--success); color: white; }
.charges-footer { padding: 12px; border-top: 1px solid var(--glass-border); display: flex; gap: 8px; }
.charges-footer .btn { flex: 1; font-size: 11px; padding: 8px; }
.compare-widget { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 16px; margin-bottom: 16px; }
.compare-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.compare-title { font-size: 14px; font-weight: 700; }
.compare-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.compare-item { text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); }
.compare-label { font-size: 10px; color: var(--text-muted); margin-bottom: 6px; }
.compare-values { display: flex; justify-content: center; align-items: baseline; gap: 8px; }
.compare-current { font-size: 16px; font-weight: 700; }
.compare-prev { font-size: 11px; color: var(--text-muted); }
.compare-delta { font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
.compare-delta.up { background: var(--success-glow); color: var(--success); }
.compare-delta.down { background: var(--danger-glow); color: var(--danger); }
.compare-delta.neutral { background: var(--bg-primary); color: var(--text-muted); }

.summary-card { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 16px; margin-bottom: 16px; }
.summary-text { font-size: 13px; line-height: 1.6; color: var(--text-secondary); }
.summary-text strong { color: var(--text-primary); }
.summary-text .good { color: var(--success); font-weight: 600; }
.summary-text .warning { color: var(--warning); font-weight: 600; }
.summary-text .bad { color: var(--danger); font-weight: 600; }
.export-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; background: linear-gradient(135deg, var(--accent), #7c3aed); border: none; border-radius: var(--radius-md); color: white; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 12px; }
.export-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
.insight-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-tertiary); border-radius: 20px; font-size: 11px; margin: 4px; }
.insight-chip.positive { background: var(--success-glow); color: var(--success); }
.insight-chip.negative { background: var(--danger-glow); color: var(--danger); }
.insight-chip.neutral { background: var(--warning-glow); color: var(--warning); }

.goal-widget { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(52,211,153,0.05)); border: 1px solid rgba(52,211,153,0.3); border-radius: var(--radius-xl); padding: 16px; margin-bottom: 16px; }
.goal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.goal-title { font-size: 14px; font-weight: 700; }
.goal-edit { font-size: 11px; color: var(--accent); cursor: pointer; }
.goal-progress { height: 12px; background: var(--bg-tertiary); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
.goal-progress-fill { height: 100%; border-radius: 6px; transition: width 0.5s; background: linear-gradient(90deg, var(--success), #34d399); }
.goal-progress-fill.warning { background: linear-gradient(90deg, var(--warning), #fbbf24); }
.goal-progress-fill.behind { background: linear-gradient(90deg, var(--danger), #f87171); }
.goal-stats { display: flex; justify-content: space-between; font-size: 11px; }
.goal-current { font-weight: 700; }
.goal-target { color: var(--text-muted); }
.goal-pace { margin-top: 8px; font-size: 11px; padding: 6px 10px; background: var(--bg-tertiary); border-radius: var(--radius-sm); }
.clients-widget { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-xl); padding: 16px; margin-bottom: 16px; }
.clients-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.clients-title { font-size: 14px; font-weight: 700; }
.client-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
.client-row:hover { background: var(--accent-glow); }
.client-info { flex: 1; }
.client-name { font-size: 12px; font-weight: 600; }
.client-sub { font-size: 10px; color: var(--text-muted); }
.client-ca { font-size: 14px; font-weight: 700; }
.client-bar { height: 4px; background: var(--bg-primary); border-radius: 2px; margin-top: 6px; overflow: hidden; }
.client-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; }
.conges-calendar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-top: 12px; }
.conges-month { text-align: center; padding: 8px 4px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; }
.conges-month:hover { background: var(--accent-glow); }
.conges-month-name { font-size: 9px; color: var(--text-muted); margin-bottom: 4px; }
.conges-month-days { font-size: 12px; font-weight: 700; }
.conges-month.has-conges { background: var(--warning-glow); }
.conges-month.current { border: 2px solid var(--accent); }

.keyboard-help { position: fixed; bottom: 80px; right: 20px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 16px; max-width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; display: none; }
.keyboard-help.show { display: block; animation: slideUp 0.2s ease; }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.keyboard-help-title { font-size: 12px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.keyboard-shortcut { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--glass-border); font-size: 11px; }
.keyboard-shortcut:last-child { border-bottom: none; }
.keyboard-key { background: var(--bg-tertiary); padding: 3px 8px; border-radius: 4px; font-family: monospace; font-size: 10px; font-weight: 700; }
.search-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-start; justify-content: center; padding-top: 100px; }
.search-overlay.show { display: flex; animation: fadeIn 0.15s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.search-box { background: var(--bg-secondary); border: 1px solid var(--accent); border-radius: var(--radius-lg); width: 90%; max-width: 500px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.search-input-wrap { display: flex; align-items: center; padding: 16px; gap: 12px; border-bottom: 1px solid var(--glass-border); }
.search-input-wrap input { flex: 1; background: transparent; border: none; font-size: 16px; color: var(--text-primary); outline: none; }
.search-results { max-height: 400px; overflow-y: auto; }
.search-result { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; transition: all 0.1s; }
.search-result:hover, .search-result.selected { background: var(--accent-glow); }
.search-result-icon { font-size: 20px; }
.search-result-info { flex: 1; }
.search-result-title { font-size: 13px; font-weight: 600; }
.search-result-sub { font-size: 11px; color: var(--text-muted); }
.search-result-badge { font-size: 10px; padding: 2px 8px; background: var(--bg-tertiary); border-radius: 4px; }
.search-empty { padding: 24px; text-align: center; color: var(--text-muted); font-size: 12px; }
.notif-badge { position: absolute; top: -4px; right: -4px; background: var(--danger); color: white; font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 8px; }
.backup-indicator { position: fixed; bottom: 20px; left: 20px; background: var(--success); color: white; padding: 8px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; display: none; z-index: 1000; }
.backup-indicator.show { display: flex; align-items: center; gap: 6px; animation: fadeIn 0.2s ease; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Sprint 13: Mobile improvements */
@media (max-width: 480px) {
  .header-content { padding: 6px 12px; gap: 8px; }
  .logo { font-size: 16px; }
  .period-selector { display: flex; gap: 2px; }
  .period-selector .period-btn { font-size: 10px; padding: 4px 6px; }
  .period-selector .year-nav-btn { font-size: 10px; width: 24px; height: 24px; }
  .period-selector .period-input { font-size: 10px; max-width: 100px; }
  .privacy-toggle { width: 32px; height: 32px; font-size: 14px; }
  .search-box { width: 95%; margin: 0 10px; }
  .search-input-wrap { padding: 12px; }
  .search-input-wrap input { font-size: 14px; }
  .keyboard-help { right: 10px; bottom: 70px; max-width: 240px; padding: 12px; }
  .modal-content { width: 95%; margin: 10px; padding: 16px; max-height: 90vh; }
  .modal-title { font-size: 16px; }
  .form-row { flex-direction: column; gap: 8px; }
  .form-group { min-width: 100%; }
  .fab { width: 48px; height: 48px; font-size: 20px; bottom: 70px; right: 12px; }
  .backup-indicator { bottom: 70px; left: 12px; padding: 6px 10px; font-size: 10px; }
  .card { padding: 12px; }
  .card-title { font-size: 12px; }
  .kpi { padding: 10px; }
  .kpi-value { font-size: 18px; }
  .kpi-label { font-size: 9px; }
  .timeline-item { padding: 8px 12px; }
  .action-item { padding: 8px 10px; }
}
@media (max-width: 360px) {
  .kpi-grid { grid-template-columns: 1fr; }
  .header-content { justify-content: space-between; }
  .nav-tabs { display: none; }
}

/* Sprint 14: Notification Center */
.notif-btn { position: relative; }
.notif-btn .notif-count { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 9px; font-weight: 700; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.notif-center { position: fixed; top: 60px; right: 20px; width: 320px; max-height: 70vh; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1500; display: none; overflow: hidden; }
.notif-center.show { display: block; animation: slideDown 0.2s ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.notif-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--glass-border); }
.notif-title { font-size: 13px; font-weight: 700; }
.notif-clear { font-size: 10px; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
.notif-clear:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.notif-list { max-height: calc(70vh - 50px); overflow-y: auto; }
.notif-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--glass-border); cursor: pointer; transition: all 0.15s; }
.notif-item:hover { background: var(--bg-tertiary); }
.notif-item.unread { background: var(--accent-glow); }
.notif-item.urgent { border-left: 3px solid var(--danger); }
.notif-item.warning { border-left: 3px solid var(--warning); }
.notif-item.info { border-left: 3px solid var(--info); }
.notif-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
.notif-icon.urgent { background: var(--danger-glow); }
.notif-icon.warning { background: var(--warning-glow); }
.notif-icon.info { background: var(--info-glow); }
.notif-icon.success { background: var(--success-glow); }
.notif-content { flex: 1; min-width: 0; }
.notif-text { font-size: 12px; font-weight: 500; margin-bottom: 2px; }
.notif-sub { font-size: 10px; color: var(--text-muted); }
.notif-time { font-size: 9px; color: var(--text-muted); white-space: nowrap; }
.notif-empty { padding: 32px; text-align: center; color: var(--text-muted); font-size: 12px; }
@media (max-width: 480px) { .notif-center { right: 10px; left: 10px; width: auto; top: 50px; } }

.aenc-list { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
.aenc-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(255,255,255,0.03); border-radius: 6px; cursor: pointer; font-size: 11px; }
.aenc-item:hover { background: rgba(255,255,255,0.06); }
.aenc-check { width: 16px; height: 16px; border: 2px solid var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--success); transition: all 0.2s; flex-shrink: 0; }
.aenc-check:hover { background: var(--success); color: white; }
.aenc-info { flex: 1; min-width: 0; }
.aenc-client { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.aenc-date { font-size: 9px; color: var(--text-muted); }
.aenc-amount { font-weight: 700; color: var(--warning); }
.aenc-amount.late { color: var(--danger); }

.card { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px; transition: all 0.2s; }
/* V46: Cards cliquables avec feedback visuel */
.card.clickable { cursor: pointer; }
.card.clickable:hover { border-color: var(--accent); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1); transform: translateY(-1px); }
.card-title { display: flex; align-items: center; justify-content: space-between; font-size: 14px; font-weight: 700; margin-bottom: 12px; }
.card-actions { display: flex; gap: 6px; align-items: center; }
.chart-container { height: 220px; min-height: 220px; position: relative; width: 100%; box-sizing: border-box; }
.chart-container canvas { display: block; width: 100% !important; height: 100% !important; }
.chart-toggle { display: flex; gap: 2px; background: var(--bg-tertiary); padding: 2px; border-radius: 6px; }
.chart-toggle-btn { background: transparent; border: none; color: var(--text-muted); padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.chart-toggle-btn.active { background: var(--accent); color: white; }

.detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--glass-border); }
.detail-row:last-child { border-bottom: none; }
.detail-row.clickable { cursor: pointer; transition: all 0.2s; }
.detail-row.clickable:hover { background: rgba(255,255,255,0.02); margin: 0 -16px; padding: 10px 16px; }
.detail-row.highlight { background: var(--success-glow); margin: 0 -16px; padding: 10px 16px; border-radius: var(--radius-sm); }
.detail-separator { height: 2px; background: var(--glass-border); margin: 8px 0; }
.detail-separator.accent { background: var(--accent); }

.toggle-check { width: 20px; height: 20px; border: 2px solid var(--glass-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: transparent; transition: all 0.2s; cursor: pointer; flex-shrink: 0; }
.toggle-check.paid { background: var(--success); border-color: var(--success); color: white; }
.toggle-check:hover { border-color: var(--success); }

.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 200; align-items: center; justify-content: center; padding: 16px; }
#formModal { z-index: 250; }
.modal.active { display: flex; }
.modal-content { background: var(--bg-secondary); border-radius: var(--radius-xl); width: 100%; max-width: 600px; max-height: 85vh; overflow-y: auto; animation: modalIn 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes modalIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.modal-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close { background: var(--bg-tertiary); border: none; color: var(--text-muted); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; }
.modal-body { padding: 20px; }

.projection-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.projection-tab { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 12px; border-radius: var(--radius-md); cursor: pointer; text-align: center; transition: all 0.2s; }
.projection-tab:hover { border-color: var(--accent); }
.projection-tab.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
.projection-tab-icon { font-size: 20px; margin-bottom: 4px; }
.projection-tab-label { font-size: 11px; font-weight: 600; }
.projection-tab-desc { font-size: 9px; opacity: 0.7; margin-top: 2px; }
.projection-params { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); }
.projection-param { display: flex; flex-direction: column; gap: 4px; }
.projection-param label { font-size: 10px; color: var(--text-muted); }
.projection-param input { background: var(--bg-elevated); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 8px; border-radius: 6px; font-size: 13px; }
.projection-result { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 16px; margin-top: 16px; }
.projection-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
.projection-metric { text-align: center; }
.projection-metric-value { font-size: 20px; font-weight: 800; }
.projection-metric-label { font-size: 10px; color: var(--text-muted); }
.projection-chart { height: 180px; margin-top: 16px; }

.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
.form-input, .form-select { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 12px; border-radius: var(--radius-sm); font-size: 14px; transition: all 0.2s; }
.form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

.btn { background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 12px 20px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
.btn:hover { background: var(--bg-elevated); border-color: var(--accent); }
.btn-success { background: var(--accent); border-color: var(--accent); color: white; }
.btn-success:hover { background: #059669; }
.btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
.btn-ghost { background: transparent; border-color: transparent; }
.btn-sm { padding: 8px 14px; font-size: 11px; }
.btn-block { width: 100%; }

.toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--glass-border); }
.toggle-label { font-size: 13px; font-weight: 500; }
.toggle-switch { position: relative; width: 44px; height: 24px; cursor: pointer; }
.toggle-switch input { display: none; }
.toggle-slider { position: absolute; inset: 0; background: var(--bg-tertiary); border-radius: 12px; transition: 0.3s; }
.toggle-slider::before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
.toggle-switch input:checked + .toggle-slider { background: var(--accent); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; }
.badge-success { background: var(--success-glow); color: var(--success); }
.badge-warning { background: var(--warning-glow); color: var(--warning); }
.badge-danger { background: var(--danger-glow); color: var(--danger); }
.badge-info { background: var(--info-glow); color: var(--info); }
.badge-muted { background: rgba(161,161,170,0.15); color: var(--text-muted); }
.badge-late { background: linear-gradient(135deg, var(--warning-glow), var(--danger-glow)); color: var(--danger); }

.days-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 12px; }
.days-table th { background: var(--bg-tertiary); padding: 10px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; color: var(--text-muted); }
.days-table td { padding: 8px 10px; border-bottom: 1px solid var(--glass-border); }
.days-table input { width: 50px; background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 6px; border-radius: 4px; text-align: center; font-size: 12px; }
.days-table .month-cell { font-weight: 600; }
.days-table .total-row { background: var(--bg-tertiary); font-weight: 700; }
.days-table .computed { color: var(--info); font-weight: 600; }

.treso-item { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 14px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
.treso-item:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15); }
/* V48: Badge textuel TRÈS VISIBLE - TOUJOURS AFFICHÉ */
.treso-item::after { 
  content: '↗'; 
  position: absolute; 
  right: 8px; 
  top: 8px; 
  font-size: 11px;
  font-weight: 700;
  color: white; 
  background: var(--accent);
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8; 
  transition: all 0.2s; 
}
.treso-item:hover::after { opacity: 1; transform: scale(1.1); }
.treso-item-value { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
.treso-item-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
.treso-item-count { font-size: 9px; color: var(--text-muted); margin-top: 2px; }

.mission-card { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
.mission-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.mission-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.mission-client { font-size: 16px; font-weight: 700; }
.mission-titre { font-size: 12px; color: var(--text-muted); }
.mission-status { font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 600; }
.mission-status.active { background: var(--success-glow); color: var(--success); }
.mission-status.upcoming { background: var(--info-glow); color: var(--info); }
.mission-status.ended { background: rgba(161,161,170,0.15); color: var(--text-muted); }
.mission-dates { font-size: 11px; color: var(--text-secondary); margin-bottom: 12px; }
.mission-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
.mission-stat { text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 8px; }
.mission-stat-value { font-size: 13px; font-weight: 700; }
.mission-stat-label { font-size: 8px; color: var(--text-muted); }
.mission-progress { margin-top: 10px; }
.mission-progress-bar { height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; }
.mission-progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }

.facture-card { display: flex; align-items: center; gap: 12px; background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
.facture-card:hover { border-color: var(--accent); }
.facture-info { flex: 1; }
.facture-id { font-weight: 700; font-size: 13px; }
.facture-meta { font-size: 11px; color: var(--text-muted); }
.facture-amount { text-align: right; }
.facture-ht { font-size: 15px; font-weight: 700; }
.facture-tva { font-size: 10px; color: var(--text-muted); }
.filter-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
.filter-chip { background: var(--bg-tertiary); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
.filter-chip:hover { border-color: var(--accent); }
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
.filter-chip .count { background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px; font-size: 10px; }

.empty-state { text-align: center; padding: 48px 24px; }
.empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.empty-text { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; }

.file-input-wrapper { position: relative; display: inline-block; }
.file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 11, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); display: none; z-index: 100; }
@media (max-width: 600px) { .bottom-nav { display: flex; } .nav-tabs { display: none; } }
.bottom-nav-tab { flex: 1; padding: 10px 8px; text-align: center; color: var(--text-muted); background: transparent; border: none; cursor: pointer; transition: all 0.2s; }
.bottom-nav-tab.active { color: var(--accent); }
.bottom-nav-icon { font-size: 18px; margin-bottom: 2px; }
.bottom-nav-label { font-size: 9px; font-weight: 600; }

.fab { position: fixed; bottom: 80px; right: 20px; width: 52px; height: 52px; background: var(--accent); border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4); transition: all 0.3s; z-index: 90; }
.fab:hover { transform: scale(1.1); }
@media (min-width: 601px) { .fab { bottom: 24px; } }

.info-box { background: var(--bg-tertiary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 12px; margin-bottom: 12px; }
.info-box-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
.info-row { display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0; }
.info-row-label { color: var(--text-muted); }

.filter-tabs { display: flex; gap: 4px; background: var(--bg-tertiary); padding: 4px; border-radius: 8px; margin-bottom: 12px; }
.filter-tab { flex: 1; background: transparent; border: none; color: var(--text-muted); padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.filter-tab.active { background: var(--accent); color: white; }

.annual-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; }
@media (max-width: 600px) { .annual-summary { grid-template-columns: repeat(2, 1fr); } }
.annual-item { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: 16px; text-align: center; }
.annual-value { font-size: 22px; font-weight: 800; }
.annual-label { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

.onboarding { display: none; position: fixed; inset: 0; background: var(--bg-primary); z-index: 500; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
.onboarding.active { display: flex; }
.onboarding-card { max-width: 400px; width: 100%; text-align: center; }
.onboarding-icon { font-size: 64px; margin-bottom: 24px; }
.onboarding-title { font-size: 28px; font-weight: 800; margin-bottom: 12px; }
.onboarding-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; }
.onboarding-steps { display: flex; justify-content: center; gap: 8px; margin-bottom: 32px; }
.onboarding-step { width: 8px; height: 8px; border-radius: 50%; background: var(--bg-tertiary); transition: all 0.3s; }
.onboarding-step.active { background: var(--accent); width: 24px; border-radius: 4px; }
.onboarding-step.done { background: var(--accent); }
.onboarding-form { text-align: left; margin-bottom: 24px; }
.onboarding-buttons { display: flex; gap: 12px; }
.onboarding-buttons .btn { flex: 1; }

#app { padding-bottom: 20px; }

/* SPRINT 2: Toggle Privacy Mode */
.privacy-toggle {
  background: transparent;
  border: 1px solid var(--glass-border);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  margin-right: 8px;
}
.privacy-toggle:hover { background: var(--bg-tertiary); }
.privacy-toggle.active { 
  background: var(--warning-glow); 
  border-color: var(--warning);
}
.privacy-toggle.active::after {
  content: '🔒';
  margin-left: 4px;
  font-size: 12px;
}

/* Mode Privacy: masquage des montants */
.privacy-blur {
  filter: blur(8px);
  user-select: none;
  pointer-events: none;
}

/* SPRINT 2: Indicateur sync cloud */
.sync-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  color: var(--text-muted);
  padding: 4px 8px;
  border-radius: 12px;
  background: var(--bg-tertiary);
}
.sync-indicator.synced { color: var(--success); }
.sync-indicator.syncing { color: var(--warning); }
.sync-indicator.error { color: var(--danger); }
.sync-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}
.sync-indicator.syncing .sync-dot {
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* SPRINT 3: Hiérarchie visuelle 3 niveaux (B16) */
.text-hero { font-size: 42px; font-weight: 800; letter-spacing: -1.5px; line-height: 1.1; }
.text-kpi { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
.text-detail { font-size: 11px; color: var(--text-muted); }
.text-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

/* SPRINT 3: Barre de recherche et filtres (B17, B18) */
.search-filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}
.search-box {
  flex: 1;
  min-width: 180px;
  position: relative;
}
.search-box input {
  width: 100%;
  background: var(--bg-secondary);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: 10px 12px 10px 36px;
  font-size: 13px;
  color: var(--text-primary);
  transition: all 0.2s;
}
.search-box input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg-tertiary);
}
.search-box input::placeholder { color: var(--text-muted); }
.search-box::before {
  content: '🔍';
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  opacity: 0.6;
  pointer-events: none;
}
.search-box .clear-search {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  padding: 0;
  display: none;
}
.search-box .clear-search.visible { display: block; }
.search-box .clear-search:hover { color: var(--text-primary); }

.filter-dropdown {
  background: var(--bg-secondary);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  padding: 10px 32px 10px 12px;
  font-size: 12px;
  color: var(--text-primary);
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  transition: all 0.2s;
  min-width: 120px;
}
.filter-dropdown:focus {
  outline: none;
  border-color: var(--accent);
}
.filter-dropdown:hover {
  background-color: var(--bg-tertiary);
}

.filter-chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.filter-chip {
  background: var(--bg-tertiary);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.filter-chip:hover { border-color: var(--accent); color: var(--text-primary); }
.filter-chip.active {
  background: var(--accent-glow);
  border-color: var(--accent);
  color: var(--accent);
}
.filter-chip .count {
  background: var(--bg-elevated);
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 700;
}
.filter-chip.active .count {
  background: var(--accent);
  color: var(--bg-primary);
}

/* Résultats de recherche / liste vide */
.search-results-info {
  text-align: center;
  padding: 24px;
  color: var(--text-muted);
  font-size: 13px;
}
.search-results-info .count { color: var(--accent); font-weight: 700; }
.no-results {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}
.no-results-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
.no-results-title { font-size: 15px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
.no-results-hint { font-size: 12px; }

/* Highlight recherche */
.search-highlight {
  background: var(--warning-glow);
  color: var(--warning);
  padding: 0 2px;
  border-radius: 2px;
}

/* Impression facture */
@media print {
  body > *:not(#invoiceOverlay) { display: none !important; }
  #invoiceOverlay { position: static !important; }
  #invoiceOverlay .no-print { display: none !important; }
  #invoiceContent { margin: 0 !important; padding: 20px !important; }
}
</style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  
  <header class="header">
    <div class="header-content">
      <div class="logo">Freel</div>
      <div class="period-selector">
        <div class="year-nav">
          <button class="year-nav-btn" id="prevYear">◀</button>
          <button class="period-btn active" id="periodYear">2025</button>
          <button class="year-nav-btn" id="nextYear">▶</button>
        </div>
        <select class="period-select" id="monthFilter" title="Filtrer par mois">
          <option value="">Année</option>
          <option value="0">Janvier</option>
          <option value="1">Février</option>
          <option value="2">Mars</option>
          <option value="3">Avril</option>
          <option value="4">Mai</option>
          <option value="5">Juin</option>
          <option value="6">Juillet</option>
          <option value="7">Août</option>
          <option value="8">Septembre</option>
          <option value="9">Octobre</option>
          <option value="10">Novembre</option>
          <option value="11">Décembre</option>
        </select>
        <button class="period-btn" id="periodCustomBtn">Période</button>
        <input type="month" class="period-input" id="periodStart" style="display:none">
        <input type="month" class="period-input" id="periodEnd" style="display:none">
      </div>
      <!-- Sprint 14: Notifications -->
      <button class="privacy-toggle notif-btn" id="notifBtn" title="Notifications" onclick="toggleNotifCenter()">🔔<span class="notif-count" id="notifBadge" style="display:none">0</span></button>
      <button class="privacy-toggle" id="themeToggle" title="Changer le thème" onclick="toggleTheme()">☀️</button>
      <button class="privacy-toggle" id="privacyToggle" title="Mode confidentialité">👁️</button>
      <button class="privacy-toggle" id="authBtn" title="Cloud Sync" onclick="showAuthModal()">🔒</button><span id="authStatus" style="font-size:10px;color:var(--success);margin-left:2px"></span>
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="accueil">🏠</button>
        <button class="nav-tab" data-view="performance">📊</button>
        <button class="nav-tab" data-view="finances">💰</button>
        <button class="nav-tab" data-view="params">⚙️</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app"></main>

  <nav class="bottom-nav">
    <button class="bottom-nav-tab active" data-view="accueil"><div class="bottom-nav-icon">🏠</div><div class="bottom-nav-label">Accueil</div></button>
    <button class="bottom-nav-tab" data-view="performance"><div class="bottom-nav-icon">📊</div><div class="bottom-nav-label">Perf</div></button>
    <button class="bottom-nav-tab" data-view="finances"><div class="bottom-nav-icon">💰</div><div class="bottom-nav-label">Finances</div></button>
    <button class="bottom-nav-tab" data-view="params"><div class="bottom-nav-icon">⚙️</div><div class="bottom-nav-label">Params</div></button>
  </nav>

  <button class="fab" id="fab">+</button>
  
  <div class="modal" id="fabModal">
    <div class="modal-content" style="max-height: auto; border-radius: var(--radius-xl);">
      <div class="modal-body" style="padding: 24px;">
        <div style="display: grid; gap: 12px;">
          <button class="btn btn-block" onclick="closeModal('fabModal'); showMissionModal();">💼 Nouvelle Mission</button>
          <button class="btn btn-block" onclick="closeModal('fabModal'); showChargeModal();">📋 Ajouter Charge</button>
          <button class="btn btn-block btn-success" onclick="closeModal('fabModal'); showSalaireModal();">💸 Verser Salaire</button>
          <button class="btn btn-ghost btn-block" onclick="closeModal('fabModal');">Annuler</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal" id="formModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="formModalTitle">Modal</h3>
        <button class="modal-close" onclick="closeModal('formModal')">×</button>
      </div>
      <div class="modal-body" id="formModalBody"></div>
    </div>
  </div>

  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="detailModalTitle">Détail</h3>
        <button class="modal-close" onclick="closeModal('detailModal')">×</button>
      </div>
      <div class="modal-body" id="detailModalBody"></div>
    </div>
  </div>

  <div class="onboarding" id="onboarding">
    <div class="onboarding-card">
      <div class="onboarding-icon" id="obIcon">👋</div>
      <h1 class="onboarding-title" id="obTitle">Bienvenue!</h1>
      <p class="onboarding-text" id="obText">Configurons ton activité freelance.</p>
      <div class="onboarding-steps" id="obSteps"></div>
      <div class="onboarding-form" id="obForm"></div>
      <div class="onboarding-buttons">
        <button class="btn btn-ghost" id="obSkip">Passer</button>
        <button class="btn btn-success" id="obNext">Continuer →</button>
      </div>
    </div>
  </div>
<script>
var APP_VERSION = 67; // V67: Provisions par type + édition/suppression mouvements
var TODAY = new Date();
var VIEW = 'accueil';
var DASHBOARD_SUB = 'accueil'; // V51: sous-onglets dashboard (accueil, analyse, charges)

// ═══════════════════════════════════════════════════════════════════════════
// SUPABASE CLOUD SYNC - V51
// ═══════════════════════════════════════════════════════════════════════════
// Pour activer la sync cloud:
// 1. Créer un projet gratuit sur https://supabase.com
// 2. Copier l'URL et la clé anon depuis Settings > API
// 3. Créer une table 'user_data' avec la structure SQL ci-dessous
// ═══════════════════════════════════════════════════════════════════════════
/*
  SQL pour créer la table dans Supabase:
  
  CREATE TABLE user_data (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    company JSONB,
    missions JSONB,
    clients JSONB,
    treasury JSONB,
    ir_config JSONB,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id)
  );
  
  -- Activer RLS
  ALTER TABLE user_data ENABLE ROW LEVEL SECURITY;
  
  -- Policy: utilisateurs peuvent lire/écrire leurs propres données
  CREATE POLICY "Users can manage own data" ON user_data
    FOR ALL USING (auth.uid() = user_id);
*/

var SUPABASE_URL = ''; // À remplir avec ton URL Supabase
var SUPABASE_ANON_KEY = ''; // À remplir avec ta clé anon
var supabase = null;
var CURRENT_USER = null;
var SYNC_ENABLED = false;

function initSupabase() {
  if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    SYNC_ENABLED = true;
    
    // Écouter les changements d'auth
    supabase.auth.onAuthStateChange(function(event, session) {
      CURRENT_USER = session ? session.user : null;
      updateAuthUI();
      if (event === 'SIGNED_IN') {
        loadFromCloud();
      }
    });
    
    // Vérifier session existante
    supabase.auth.getSession().then(function(result) {
      if (result.data.session) {
        CURRENT_USER = result.data.session.user;
        updateAuthUI();
        loadFromCloud();
      }
    });
  }
}

function updateAuthUI() {
  var authBtn = $('#authBtn');
  var authStatus = $('#authStatus');
  if (authBtn) {
    authBtn.textContent = CURRENT_USER ? '🔓' : '🔒';
    authBtn.title = CURRENT_USER ? 'Connecté: ' + CURRENT_USER.email : 'Se connecter';
  }
  if (authStatus) {
    authStatus.textContent = CURRENT_USER ? '☁️ Sync' : '';
  }
}

function showAuthModal() {
  if (!SYNC_ENABLED) {
    showToast('⚠️ Supabase non configuré. Voir Admin > Cloud Sync.', 'warning');
    return;
  }
  
  var content = el('div', { style: { padding: '20px' } });
  
  if (CURRENT_USER) {
    // Déjà connecté
    content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '20px' } }, [
      el('div', { style: { fontSize: '40px', marginBottom: '10px' } }, '👤'),
      el('div', { style: { fontWeight: '600' } }, CURRENT_USER.email),
      el('div', { style: { fontSize: '12px', color: 'var(--text-muted)' } }, '☁️ Données synchronisées')
    ]));
    
    var btns = el('div', { style: { display: 'flex', gap: '10px' } });
    btns.appendChild(el('button', { class: 'btn btn-primary', style: { flex: 1 }, onclick: function() { syncToCloud(); closeDynamicModal(); } }, '⬆️ Sauvegarder'));
    btns.appendChild(el('button', { class: 'btn', style: { flex: 1 }, onclick: function() { loadFromCloud(); closeDynamicModal(); } }, '⬇️ Charger'));
    btns.appendChild(el('button', { class: 'btn btn-danger', onclick: function() { signOut(); closeDynamicModal(); } }, '🚪 Déconnexion'));
    content.appendChild(btns);
  } else {
    // Non connecté - formulaire login
    content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '20px' } }, [
      el('div', { style: { fontSize: '40px', marginBottom: '10px' } }, '☁️'),
      el('div', { style: { fontWeight: '600' } }, 'Cloud Sync'),
      el('div', { style: { fontSize: '12px', color: 'var(--text-muted)' } }, 'Synchronise tes données sur tous tes appareils')
    ]));
    
    var form = el('div');
    form.appendChild(createInput('Email', 'email', 'authEmail', ''));
    form.appendChild(createInput('Mot de passe', 'password', 'authPassword', ''));
    content.appendChild(form);
    
    var btns = el('div', { style: { display: 'flex', gap: '10px', marginTop: '16px' } });
    btns.appendChild(el('button', { class: 'btn btn-primary', style: { flex: 1 }, onclick: signIn }, '🔐 Connexion'));
    btns.appendChild(el('button', { class: 'btn', style: { flex: 1 }, onclick: signUp }, '✨ Créer compte'));
    content.appendChild(btns);
  }
  
  showModal('Cloud Sync', content);
}

function signIn() {
  var email = $('#authEmail').value;
  var password = $('#authPassword').value;
  
  if (!email || !password) {
    showToast('Email et mot de passe requis', 'error');
    return;
  }
  
  supabase.auth.signInWithPassword({ email: email, password: password })
    .then(function(result) {
      if (result.error) {
        showToast('❌ ' + result.error.message, 'error');
      } else {
        showToast('✅ Connecté!', 'success');
        closeDynamicModal();
      }
    });
}

function signUp() {
  var email = $('#authEmail').value;
  var password = $('#authPassword').value;
  
  if (!email || !password) {
    showToast('Email et mot de passe requis', 'error');
    return;
  }
  
  supabase.auth.signUp({ email: email, password: password })
    .then(function(result) {
      if (result.error) {
        showToast('❌ ' + result.error.message, 'error');
      } else {
        showToast('✅ Compte créé! Vérifie ton email.', 'success');
        closeDynamicModal();
      }
    });
}

function signOut() {
  supabase.auth.signOut().then(function() {
    CURRENT_USER = null;
    updateAuthUI();
    showToast('🚪 Déconnecté', 'info');
  });
}

function syncToCloud() {
  if (!CURRENT_USER || !supabase) return;
  
  var data = {
    user_id: CURRENT_USER.id,
    company: COMPANY,
    missions: MISSIONS,
    clients: CLIENTS,
    treasury: TREASURY,
    ir_config: IR_CONFIG,
    updated_at: new Date().toISOString()
  };
  
  supabase.from('user_data')
    .upsert(data, { onConflict: 'user_id' })
    .then(function(result) {
      if (result.error) {
        showToast('❌ Erreur sync: ' + result.error.message, 'error');
      } else {
        showToast('☁️ Données sauvegardées!', 'success');
      }
    });
}

function loadFromCloud() {
  if (!CURRENT_USER || !supabase) return;
  
  supabase.from('user_data')
    .select('*')
    .eq('user_id', CURRENT_USER.id)
    .single()
    .then(function(result) {
      if (result.error) {
        if (result.error.code !== 'PGRST116') { // Not found is OK for new users
          showToast('❌ Erreur: ' + result.error.message, 'error');
        }
      } else if (result.data) {
        // Charger les données du cloud
        if (result.data.company) COMPANY = result.data.company;
        if (result.data.missions) MISSIONS = result.data.missions;
        if (result.data.clients) CLIENTS = result.data.clients;
        if (result.data.treasury) TREASURY = result.data.treasury;
        if (result.data.ir_config) IR_CONFIG = result.data.ir_config;
        
        saveAll(); // Sauvegarder localement aussi
        COMPUTED = compute();
        render();
        showToast('☁️ Données chargées du cloud!', 'success');
      }
    });
}

var PERIOD = { type: 'year', year: TODAY.getFullYear(), month: null }; // V72: month = null pour année entière, 0-11 pour mois spécifique
var TIMELINE_IDX = null;
var FACTURE_FILTER = 'all';
var SHOW_CUMUL = false;
var SHOW_CASH_DISPO = false;
var PROJECTION_SCENARIO = 'normal';
var PROV_VIEW = 'type'; // 'type' or 'month'
var ALERTS_OPEN = false;
var mainChart = null, soldeChart = null, projectionChart = null, salairesChart = null;

// Mode Privacy (floutage des montants)
var PRIVACY_MODE = false;

// Recherche et Filtres
var SEARCH_STATE = {
  factures: { query: '', client: 'all', status: 'all' },
  tresorerie: { query: '', type: 'all', category: 'all' }
};

// Taux officiels URSSAF - Sources: urssaf.fr, décret 2025-943
// V51: Taux officiels 2026 confirmés (source: autoentrepreneur.urssaf.fr)
var LEGAL = {
  // Cotisations URSSAF BNC (prestations de services libérales)
  urssafStd2025: 0.246,    // 24.6% - 2025
  urssafStd2026: 0.256,    // 25.6% - 2026 (confirmé URSSAF)
  urssafAcre2025: 0.123,   // 12.3% - ACRE 2025 (50% du taux standard)
  urssafAcre2026: 0.128,   // 12.8% - ACRE 2026 (50% du taux standard)
  cfp: 0.002,              // 0.2% - Formation professionnelle (CFP)
  impLib: 0.022,           // 2.2% - Versement libératoire IR (BNC)
  tvaRate: 0.20,           // 20% - TVA taux normal

  // Plafonds micro-entreprise 2025/2026
  plafondBNC: 77700,       // CA max prestations de services / BNC
  plafondVente: 188700,    // CA max vente de marchandises
  seuilTVA: 36800,         // Seuil franchise TVA (services)
  seuilTVAMajore: 39100,   // Seuil majoré (perte franchise)
  seuilTVAVente: 91900,    // Seuil franchise TVA (vente)
  seuilTVAVenteMajore: 101000, // Seuil majoré vente

  // ACRE: 4 trimestres civils (trimestre de création inclus)
  acreDureeQuarters: 4,

  lastUpdated: '2026-02-11'
};

var SCENARIOS = {
  nominal: { id: 'nominal', label: 'Nominal', icon: '⚡', desc: 'Plein régime', vacationWeeks: 0, intercontratMonths: 0 },
  normal: { id: 'normal', label: 'Normal', icon: '✅', desc: '5 sem. congés', vacationWeeks: 5, intercontratMonths: 0 },
  recherche: { id: 'recherche', label: 'Prudent', icon: '🔍', desc: 'Intercontrat', vacationWeeks: 5, intercontratMonths: 2 }
};

var IR_BRACKETS = [
  { max: 11294, rate: 0 }, { max: 28797, rate: 0.11 }, { max: 82341, rate: 0.30 }, { max: 177106, rate: 0.41 }, { max: Infinity, rate: 0.45 }
];

var COMPANY = {
  nom: 'Loïs MUSIC',
  siret: '92859030500015',
  debut: '2025-03-02',
  acre: true,
  prelevementLiberatoire: false,
  tvaDepuis: '2025-10',
  tvaIntracom: 'FR59928590005',
  iban: 'FR7617806006600003912844671',
  bic: 'AGRIFRPP878',
  adresse: 'Toulouse',
  ville: '',
  codePostal: '',
  commune: '',
  codeApe: '6201Z',
  email: '',
  telephone: '',
  urssafPeriodicite: 'mensuel',
  onboardingDone: true,
  invoiceCounter: {},
  invoiceRegistry: []
};
var MISSIONS = [
  {
    id: 'MIS' + Date.now(),
    client: 'ATR',
    description: 'Mission via Scalian',
    tjm: 380,
    debut: '2025-05-12',
    fin: '2026-03-31',
    statut: 'en_cours',
    lignes: [],
    factures: []
  }
];
var CLIENTS = [
  { id: 'CLI1', nom: 'ATR', adresse: '', siret: '', contact: '', email: '', notes: '', delaiPaiement: 2, jourPaiement: 15 }
];
var TREASURY = {
  soldeInitial: 5000,
  mouvements: [],
  paidCharges: {},
  conges: {}, // { '2025-08': [1,2,3], '2025-12': [23,24,25,26,27,28,29,30,31] }
  rendementActif: false,
  rendementTaux: 2.0,
  rendementHistorique: [],
  // V51: Paramètres trésorerie
  salaireEstime: 2200,    // Salaire mensuel estimé pour calcul autonomie
  reserveCompte: 150      // Réserve minimum sur compte pro
};
var IR_CONFIG = {}; // { '2025': { parts: 1, autresRevenus: 0, perAnnuel: 0 }, '2026': {...} }
var COMPUTED = {};

function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }
function el(tag, attrs, children) {
  var e = document.createElement(tag);
  if (attrs) Object.keys(attrs).forEach(function(k) { if (k === 'onclick' || k === 'onchange' || k === 'oninput') e[k] = attrs[k]; else if (k === 'style' && typeof attrs[k] === 'object') Object.assign(e.style, attrs[k]); else if (k === 'class') e.className = attrs[k]; else e.setAttribute(k, attrs[k]); });
  if (children) (Array.isArray(children) ? children : [children]).forEach(function(c) { if (c != null) e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
  return e;
}
function toast(msg, type) {
  type = type || 'info';
  var t = el('div', { class: 'toast ' + type }, [el('span', {}, msg), el('button', { class: 'toast-close', onclick: function() { t.remove(); } }, '×')]);
  $('#toastContainer').appendChild(t);
  setTimeout(function() { if (t.parentNode) t.remove(); }, 4000);
}

function EUR(n, forceShow) { 
  // Mode Privacy - floute les montants sauf si forceShow
  if (PRIVACY_MODE && !forceShow) return '•••••€';
  return (n || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }); 
}
function PCT(n) { return ((n || 0) * 100).toFixed(1) + '%'; }
function localISO(d) { return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); }
function ym(y, m) { return y + '-' + String(m + 1).padStart(2, '0'); }
function parseYM(s) { var p = s.split('-'); return { y: parseInt(p[0]), m: parseInt(p[1]) - 1 }; }
function fmtMonth(s) { var p = parseYM(s); return new Date(p.y, p.m).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }); }
function fmtMonthShort(s) { var p = parseYM(s); return new Date(p.y, p.m).toLocaleDateString('fr-FR', { month: 'short' }).replace('.', ''); }
function fmtLong(d) { return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }); }
function fmtDate(d) { return new Date(d).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function parseDate(s) {
  if (!s) return new Date();
  // Format YYYY-MM-DD ou YYYY-MM
  var parts = s.split('-');
  if (parts.length === 3) {
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  } else if (parts.length === 2) {
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
  }
  return new Date(s);
}

// Fonction highlight pour recherche textuelle (B17)
function highlightText(text, query) {
  if (!query || !text) return text;
  var regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
  return text.replace(regex, '<span class="search-highlight">$1</span>');
}

// ===== SPRINT 5: COMPOSANTS UI RÉUTILISABLES (A12) =====

/**
 * Composant KPI réutilisable
 * @param {Object} opts - { label, value, valueClass, sub, trend, sparkline, sparkColor, onClick, badge }
 */
function KPI(opts) {
  opts = opts || {};
  // V47: Ajouter la classe 'interactive' seulement si onClick est défini
  var classes = 'kpi' + (opts.type ? ' ' + opts.type : '');
  if (opts.onClick) classes += ' interactive';
  var kpi = el('div', { class: classes, onclick: opts.onClick || null });
  
  kpi.appendChild(el('div', { class: 'kpi-label' }, opts.label || ''));
  
  var valueEl = el('div', { class: 'kpi-value' + (opts.valueClass ? ' ' + opts.valueClass : '') });
  if (opts.valueStyle) Object.assign(valueEl.style, opts.valueStyle);
  valueEl.textContent = opts.value || '';
  
  // Trend indicator
  if (opts.trend && opts.trend.direction !== 'neutral') {
    var trendEl = el('span', { class: 'kpi-trend ' + opts.trend.direction }, 
      (opts.trend.direction === 'up' ? '↑' : '↓') + Math.abs(opts.trend.pct) + '%');
    var wrapper = el('div', { style: { display: 'flex', alignItems: 'baseline', gap: '4px' } });
    wrapper.appendChild(valueEl);
    wrapper.appendChild(trendEl);
    kpi.appendChild(wrapper);
  } else {
    kpi.appendChild(valueEl);
  }
  
  // Subtitle
  if (opts.sub) kpi.appendChild(el('div', { class: 'kpi-sub' }, opts.sub));
  
  // Badge
  if (opts.badge) {
    var badgeEl = el('div', { class: 'kpi-badge' }, opts.badge.text);
    if (opts.badge.style) Object.assign(badgeEl.style, opts.badge.style);
    kpi.appendChild(badgeEl);
  }
  
  // Sparkline
  if (opts.sparkline && opts.sparkline.length > 0) {
    var spark = el('div', { class: 'kpi-sparkline' });
    spark.innerHTML = createSparkline(opts.sparkline, opts.sparkColor || '#60a5fa');
    kpi.appendChild(spark);
  }
  
  // Custom content
  if (opts.content) kpi.appendChild(opts.content);
  
  return kpi;
}

/**
 * Composant SectionTitle réutilisable
 * @param {string} icon - Emoji icon
 * @param {string} text - Title text
 */
function SectionTitle(icon, text) {
  return el('div', { class: 'section-title' }, [
    el('span', { class: 'section-title-icon' }, icon),
    text
  ]);
}

/**
 * Composant Card réutilisable
 * @param {Object} opts - { title, titleIcon, actions, content, id }
 */
function Card(opts) {
  opts = opts || {};
  var card = el('div', { class: 'card' });
  if (opts.id) card.id = opts.id;
  
  if (opts.title) {
    var titleEl = el('div', { class: 'card-title' });
    titleEl.appendChild(el('span', {}, (opts.titleIcon || '') + ' ' + opts.title));
    if (opts.actions) {
      var actionsEl = el('div', { class: 'card-actions' });
      (Array.isArray(opts.actions) ? opts.actions : [opts.actions]).forEach(function(a) {
        actionsEl.appendChild(a);
      });
      titleEl.appendChild(actionsEl);
    }
    card.appendChild(titleEl);
  }
  
  if (opts.content) {
    (Array.isArray(opts.content) ? opts.content : [opts.content]).forEach(function(c) {
      card.appendChild(c);
    });
  }
  
  return card;
}

// ===== SPRINT 1: NUMÉROTATION SÉQUENTIELLE DES FACTURES =====
// Conforme Art. L441-9 Code de Commerce

function getNextInvoiceNumber(year) {
  year = year || TODAY.getFullYear();
  var yearStr = String(year);
  
  // Initialiser le compteur pour cette année si nécessaire
  if (!COMPANY.invoiceCounter) COMPANY.invoiceCounter = {};
  if (!COMPANY.invoiceCounter[yearStr]) COMPANY.invoiceCounter[yearStr] = 0;
  
  // Incrémenter et retourner
  COMPANY.invoiceCounter[yearStr]++;
  var num = COMPANY.invoiceCounter[yearStr];
  
  // Format: YYYY-NNN (ex: 2025-001, 2025-002, ...)
  return yearStr + '-' + String(num).padStart(3, '0');
}

function reserveInvoiceNumber(year) {
  // Réserve un numéro sans l'enregistrer (pour prévisualisation)
  year = year || TODAY.getFullYear();
  var yearStr = String(year);
  if (!COMPANY.invoiceCounter) COMPANY.invoiceCounter = {};
  if (!COMPANY.invoiceCounter[yearStr]) COMPANY.invoiceCounter[yearStr] = 0;
  var nextNum = COMPANY.invoiceCounter[yearStr] + 1;
  return yearStr + '-' + String(nextNum).padStart(3, '0');
}

function registerInvoice(invoiceData) {
  // Enregistre une facture dans le livre des recettes (obligatoire micro-entreprise)
  if (!COMPANY.invoiceRegistry) COMPANY.invoiceRegistry = [];
  
  var entry = {
    id: 'INV-' + Date.now(),
    numero: invoiceData.numero,
    date: invoiceData.date,
    dateEncaissement: invoiceData.dateEncaissement || null,
    client: invoiceData.client,
    nature: invoiceData.nature || 'Prestation de service',
    montantHT: invoiceData.montantHT,
    tva: invoiceData.tva || 0,
    montantTTC: invoiceData.montantTTC,
    modePaiement: invoiceData.modePaiement || 'Virement',
    missionId: invoiceData.missionId || null,
    mois: invoiceData.mois || null
  };
  
  COMPANY.invoiceRegistry.push(entry);
  saveAll();
  return entry;
}

function getInvoiceRegistry(year) {
  // Retourne le livre des recettes pour une année
  if (!COMPANY.invoiceRegistry) return [];
  if (!year) return COMPANY.invoiceRegistry;
  return COMPANY.invoiceRegistry.filter(function(inv) {
    return inv.date && inv.date.startsWith(String(year));
  });
}

// ===== SPRINT 8: VALIDATION NUMÉROTATION FACTURES (Art. L441-9) =====
// Vérifie que la séquence de numéros est continue (sans trous)
function validateInvoiceNumbering(year) {
  year = year || TODAY.getFullYear();
  var yearStr = String(year);
  var registry = getInvoiceRegistry(year);
  if (registry.length === 0) return { valid: true, gaps: [], duplicates: [], total: 0 };

  // Extraire les numéros de la forme YYYY-NNN
  var numbers = [];
  var seen = {};
  var duplicates = [];
  registry.forEach(function(inv) {
    if (!inv.numero) return;
    var match = inv.numero.match(/^(\d{4})-(\d{3})$/);
    if (match && match[1] === yearStr) {
      var num = parseInt(match[2]);
      if (seen[num]) {
        duplicates.push({ numero: inv.numero, client: inv.client, date: inv.date });
      } else {
        seen[num] = inv;
        numbers.push(num);
      }
    }
  });

  if (numbers.length === 0) return { valid: true, gaps: [], duplicates: duplicates, total: 0 };

  numbers.sort(function(a, b) { return a - b; });

  // Vérifier la séquence (doit commencer à 1 et être continue)
  var gaps = [];
  if (numbers[0] !== 1) {
    for (var i = 1; i < numbers[0]; i++) {
      gaps.push(yearStr + '-' + String(i).padStart(3, '0'));
    }
  }
  for (var j = 0; j < numbers.length - 1; j++) {
    if (numbers[j + 1] - numbers[j] > 1) {
      for (var k = numbers[j] + 1; k < numbers[j + 1]; k++) {
        gaps.push(yearStr + '-' + String(k).padStart(3, '0'));
      }
    }
  }

  return {
    valid: gaps.length === 0 && duplicates.length === 0,
    gaps: gaps,
    duplicates: duplicates,
    total: numbers.length,
    first: yearStr + '-' + String(numbers[0]).padStart(3, '0'),
    last: yearStr + '-' + String(numbers[numbers.length - 1]).padStart(3, '0')
  };
}

function exportLivreRecettes(year) {
  year = year || TODAY.getFullYear();
  var registry = getInvoiceRegistry(year);
  
  if (registry.length === 0) {
    toast('Aucune facture enregistrée pour ' + year, 'warning');
    return;
  }
  
  // Trier par date
  registry.sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); });
  
  // Générer CSV conforme
  var headers = ['Date', 'N° Facture', 'Client', 'Nature', 'Montant HT', 'TVA', 'Montant TTC', 'Mode paiement', 'Date encaissement'];
  var rows = registry.map(function(inv) {
    return [
      inv.date || '',
      inv.numero || '',
      (inv.client || '').replace(/"/g, '""'),
      (inv.nature || '').replace(/"/g, '""'),
      (inv.montantHT || 0).toFixed(2),
      (inv.tva || 0).toFixed(2),
      (inv.montantTTC || 0).toFixed(2),
      inv.modePaiement || '',
      inv.dateEncaissement || ''
    ].map(function(v) { return '"' + v + '"'; }).join(';');
  });
  
  var csv = '\uFEFF' + headers.join(';') + '\n' + rows.join('\n');
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'livre-recettes-' + year + '.csv';
  a.click();
  
  toast('Livre des recettes ' + year + ' exporté!', 'success');
}

// Export FEC (Fichier des Écritures Comptables)
// Format normé DGFIP - Art. L47 A-I LPF
function exportFEC(year) {
  year = year || TODAY.getFullYear();
  var entries = [];
  var journalCode = 'VT';
  var ecritureNum = 1;
  
  var yearFactures = [];
  MISSIONS.forEach(function(mis) {
    if (!mis.lignes) return;
    mis.lignes.forEach(function(l) {
      if (l.ym && l.ym.startsWith(year + '-') && l.facture) {
        yearFactures.push({
          date: l.facture.date || (year + '-' + l.ym.substr(5, 2) + '-' + String(mis.jourPaiement || 15).padStart(2, '0')),
          numero: l.facture.numero || 'F-' + l.ym,
          client: mis.client || 'Client',
          clientId: mis.clientId || '',
          ht: l.ht || 0,
          tva: l.tva || 0,
          ttc: l.ttc || 0
        });
      }
    });
  });
  
  yearFactures.sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); });
  
  yearFactures.forEach(function(f) {
    var dateComp = f.date.replace(/-/g, '');
    var pieceRef = f.numero;
    var libelle = 'Facture ' + f.numero + ' - ' + f.client;
    
    // Écriture client (411) - Débit TTC
    entries.push({
      JournalCode: journalCode, JournalLib: 'Ventes',
      EcritureNum: String(ecritureNum).padStart(6, '0'), EcritureDate: dateComp,
      CompteNum: '411' + (f.clientId ? f.clientId.slice(-4).padStart(4, '0') : '0000'),
      CompteLib: 'Client ' + f.client, CompAuxNum: '', CompAuxLib: '',
      PieceRef: pieceRef, PieceDate: dateComp, EcritureLib: libelle,
      Debit: f.ttc.toFixed(2), Credit: '0.00',
      EcritureLet: '', DateLet: '', ValidDate: dateComp, Montantdevise: '', Idevise: ''
    });
    
    // Écriture ventes (706) - Crédit HT
    entries.push({
      JournalCode: journalCode, JournalLib: 'Ventes',
      EcritureNum: String(ecritureNum).padStart(6, '0'), EcritureDate: dateComp,
      CompteNum: '706000', CompteLib: 'Prestations de services',
      CompAuxNum: '', CompAuxLib: '', PieceRef: pieceRef, PieceDate: dateComp,
      EcritureLib: libelle, Debit: '0.00', Credit: f.ht.toFixed(2),
      EcritureLet: '', DateLet: '', ValidDate: dateComp, Montantdevise: '', Idevise: ''
    });
    
    // Écriture TVA (445710) - Crédit TVA
    if (f.tva > 0) {
      entries.push({
        JournalCode: journalCode, JournalLib: 'Ventes',
        EcritureNum: String(ecritureNum).padStart(6, '0'), EcritureDate: dateComp,
        CompteNum: '445710', CompteLib: 'TVA collectée',
        CompAuxNum: '', CompAuxLib: '', PieceRef: pieceRef, PieceDate: dateComp,
        EcritureLib: libelle, Debit: '0.00', Credit: f.tva.toFixed(2),
        EcritureLet: '', DateLet: '', ValidDate: dateComp, Montantdevise: '', Idevise: ''
      });
    }
    ecritureNum++;
  });
  
  if (entries.length === 0) {
    toast('Aucune écriture pour ' + year, 'warning');
    return;
  }
  
  var headers = ['JournalCode', 'JournalLib', 'EcritureNum', 'EcritureDate', 'CompteNum', 'CompteLib', 'CompAuxNum', 'CompAuxLib', 'PieceRef', 'PieceDate', 'EcritureLib', 'Debit', 'Credit', 'EcritureLet', 'DateLet', 'ValidDate', 'Montantdevise', 'Idevise'];
  var rows = entries.map(function(e) { return headers.map(function(h) { return e[h] || ''; }).join('\t'); });
  var siren = (COMPANY.siret || '').substr(0, 9);
  var filename = siren + 'FEC' + year + '1231.txt';
  var content = headers.join('\t') + '\n' + rows.join('\n');
  var blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  toast('FEC ' + year + ' exporté (' + entries.length + ' écritures)', 'success');
}

// V46: Export PDF Livre des Recettes (conformité Art. L123-25 Code de Commerce)
function exportLivreRecettesPDF(year) {
  year = year || TODAY.getFullYear();
  
  // Récupérer les factures du registre pour l'année
  var registry = getInvoiceRegistry(year);
  
  if (registry.length === 0) {
    toast('Aucune recette enregistrée pour ' + year, 'warning');
    return;
  }
  
  // Trier par date
  registry.sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); });
  
  // Calculer les totaux
  var totalHT = registry.reduce(function(sum, r) { return sum + (r.montantHT || 0); }, 0);
  var totalTVA = registry.reduce(function(sum, r) { return sum + (r.tva || 0); }, 0);
  var totalTTC = registry.reduce(function(sum, r) { return sum + (r.montantTTC || 0); }, 0);
  
  // Créer le PDF
  var doc = new jspdf.jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  var pageWidth = 210;
  var margin = 15;
  var y = 20;
  
  // En-tête entreprise
  doc.setFontSize(16);
  doc.setFont('helvetica', 'bold');
  doc.text('LIVRE DES RECETTES', pageWidth / 2, y, { align: 'center' });
  y += 8;
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('Année ' + year, pageWidth / 2, y, { align: 'center' });
  y += 12;
  
  // Informations entreprise
  doc.setFontSize(9);
  doc.setFont('helvetica', 'bold');
  doc.text(COMPANY.nom || 'Entreprise', margin, y);
  y += 5;
  doc.setFont('helvetica', 'normal');
  doc.text('SIRET: ' + (COMPANY.siret || 'Non renseigné'), margin, y);
  y += 4;
  if (COMPANY.tvaNumber) {
    doc.text('TVA: ' + COMPANY.tvaNumber, margin, y);
    y += 4;
  }
  y += 8;
  
  // Note légale
  doc.setFontSize(7);
  doc.setTextColor(100);
  doc.text('Document établi conformément aux articles L123-25 et suivants du Code de Commerce', margin, y);
  doc.text('et aux obligations comptables des micro-entrepreneurs (Art. L526-13)', margin, y + 3);
  doc.setTextColor(0);
  y += 12;
  
  // Tableau des recettes
  var colWidths = [22, 28, 50, 28, 22, 30]; // Date, N° Facture, Client, Montant HT, TVA, TTC
  var headers = ['Date', 'N° Facture', 'Client', 'HT (€)', 'TVA (€)', 'TTC (€)'];
  var startX = margin;
  
  // En-tête tableau
  doc.setFillColor(40, 40, 45);
  doc.rect(startX, y, colWidths.reduce(function(a,b) { return a+b; }, 0), 8, 'F');
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(8);
  doc.setTextColor(255);
  
  var x = startX + 2;
  headers.forEach(function(h, i) {
    doc.text(h, x, y + 5.5);
    x += colWidths[i];
  });
  y += 8;
  doc.setTextColor(0);
  
  // Lignes du tableau
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(8);
  
  var rowHeight = 6;
  var pageHeight = 297;
  var footerSpace = 40;
  
  registry.forEach(function(entry, idx) {
    // Nouvelle page si nécessaire
    if (y + rowHeight > pageHeight - footerSpace) {
      doc.addPage();
      y = 20;
      
      // Répéter en-tête tableau
      doc.setFillColor(40, 40, 45);
      doc.rect(startX, y, colWidths.reduce(function(a,b) { return a+b; }, 0), 8, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255);
      x = startX + 2;
      headers.forEach(function(h, i) {
        doc.text(h, x, y + 5.5);
        x += colWidths[i];
      });
      y += 8;
      doc.setTextColor(0);
      doc.setFont('helvetica', 'normal');
    }
    
    // Alternance couleur lignes
    if (idx % 2 === 0) {
      doc.setFillColor(248, 248, 250);
      doc.rect(startX, y, colWidths.reduce(function(a,b) { return a+b; }, 0), rowHeight, 'F');
    }
    
    x = startX + 2;
    var dateStr = entry.date ? entry.date.split('-').reverse().join('/') : '';
    var values = [
      dateStr,
      entry.numero || '',
      (entry.client || '').substr(0, 25),
      (entry.montantHT || 0).toFixed(2),
      (entry.tva || 0).toFixed(2),
      (entry.montantTTC || 0).toFixed(2)
    ];
    
    values.forEach(function(v, i) {
      if (i >= 3) {
        // Alignement droite pour les montants
        doc.text(v, x + colWidths[i] - 4, y + 4, { align: 'right' });
      } else {
        doc.text(String(v), x, y + 4);
      }
      x += colWidths[i];
    });
    
    y += rowHeight;
  });
  
  // Ligne de total
  y += 2;
  doc.setFillColor(40, 40, 45);
  doc.rect(startX, y, colWidths.reduce(function(a,b) { return a+b; }, 0), 8, 'F');
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(9);
  doc.setTextColor(255);
  
  x = startX + 2;
  doc.text('TOTAL ' + year + ' (' + registry.length + ' factures)', x, y + 5.5);
  x = startX + colWidths[0] + colWidths[1] + colWidths[2] + 2;
  doc.text(totalHT.toFixed(2), x + colWidths[3] - 4, y + 5.5, { align: 'right' });
  x += colWidths[3];
  doc.text(totalTVA.toFixed(2), x + colWidths[4] - 4, y + 5.5, { align: 'right' });
  x += colWidths[4];
  doc.text(totalTTC.toFixed(2), x + colWidths[5] - 4, y + 5.5, { align: 'right' });
  
  y += 16;
  doc.setTextColor(0);
  
  // Signature / Certification
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(8);
  doc.text('Certifié sincère et conforme,', margin, y);
  y += 5;
  doc.text('Fait à ' + (COMPANY.ville || 'Toulouse') + ', le ' + TODAY.toLocaleDateString('fr-FR'), margin, y);
  y += 12;
  doc.setFont('helvetica', 'italic');
  doc.setFontSize(7);
  doc.text('Signature:', margin, y);
  
  // Pied de page
  var pageCount = doc.internal.getNumberOfPages();
  for (var i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(120);
    doc.text('Livre des Recettes ' + year + ' - ' + (COMPANY.nom || 'Entreprise') + ' - Page ' + i + '/' + pageCount, pageWidth / 2, 290, { align: 'center' });
    doc.text('Généré le ' + TODAY.toLocaleDateString('fr-FR') + ' à ' + TODAY.toLocaleTimeString('fr-FR'), pageWidth / 2, 294, { align: 'center' });
  }
  
  // Télécharger
  var filename = 'Livre_Recettes_' + (COMPANY.nom || 'Entreprise').replace(/[^a-zA-Z0-9]/g, '_') + '_' + year + '.pdf';
  doc.save(filename);
  toast('Livre des Recettes ' + year + ' exporté en PDF', 'success');
}

// Gestion des clients
function getClient(clientId) {
  return CLIENTS.find(function(c) { return c.id === clientId; });
}

function getClientByName(name) {
  return CLIENTS.find(function(c) { return c.nom === name; });
}

function showClientModal(client) {
  var isNew = !client;
  if (isNew) client = {
    id: 'CLI' + Date.now() + Math.random().toString(36).substr(2, 5),
    nom: '', adresse: '', siret: '', contact: '', email: '', notes: '',
    delaiPaiement: 2, jourPaiement: 15
  };
  
  $('#formModalTitle').textContent = isNew ? '🏢 Nouveau Client' : '✏️ ' + client.nom;
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  body.appendChild(createInput('Nom / Raison sociale *', 'text', 'cNom', client.nom));
  body.appendChild(createTextarea('Adresse complète', 'cAdresse', client.adresse, 'Adresse facturation'));
  body.appendChild(createInput('SIRET', 'text', 'cSiret', client.siret));
  
  var row = el('div', { class: 'form-row' });
  row.appendChild(createInput('Contact', 'text', 'cContact', client.contact));
  row.appendChild(createInput('Email', 'email', 'cEmail', client.email));
  body.appendChild(row);
  
  body.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '16px', marginBottom: '8px' } }, '💰 Conditions de paiement par défaut'));
  var row2 = el('div', { class: 'form-row' });
  row2.appendChild(createSelect('Délai', 'cDelai', [{ value: '1', label: 'M+1' }, { value: '2', label: 'M+2' }, { value: '3', label: 'M+3' }], String(client.delaiPaiement || 2)));
  row2.appendChild(createInput('Jour paiement', 'number', 'cJour', client.jourPaiement || 15));
  body.appendChild(row2);
  
  body.appendChild(createTextarea('Notes', 'cNotes', client.notes || ''));
  
  var btns = el('div', { style: { display: 'flex', gap: '10px', marginTop: '20px' } });
  btns.appendChild(el('button', { class: 'btn btn-success', style: { flex: '1' }, onclick: function() {
    var nom = $('#cNom').value.trim();
    if (!nom) { toast('Nom requis', 'error'); return; }
    client.nom = nom;
    client.adresse = $('#cAdresse').value;
    client.siret = $('#cSiret').value;
    client.contact = $('#cContact').value;
    client.email = $('#cEmail').value;
    client.delaiPaiement = parseInt($('#cDelai').value) || 2;
    client.jourPaiement = parseInt($('#cJour').value) || 15;
    client.notes = $('#cNotes').value;
    if (isNew) CLIENTS.push(client);
    saveAll(); closeModal('formModal'); render();
    toast(isNew ? 'Client créé!' : 'Client mis à jour', 'success');
  } }, '✅ Enregistrer'));
  
  if (!isNew) {
    var usedInMissions = MISSIONS.filter(function(m) { return m.clientId === client.id; }).length;
    if (usedInMissions === 0) {
      btns.appendChild(el('button', { class: 'btn btn-danger', onclick: function() {
        if (confirm('Supprimer ce client ?')) {
          CLIENTS = CLIENTS.filter(function(c) { return c.id !== client.id; });
          saveAll(); closeModal('formModal'); render();
          toast('Client supprimé', 'success');
        }
      } }, '🗑️'));
    }
  }
  
  body.appendChild(btns);
  openModal('formModal');
}

function calculatePaymentDeadline(invoiceDate, delaiJours) {
  delaiJours = delaiJours || 30;
  var date = new Date(invoiceDate);
  date.setDate(date.getDate() + delaiJours);
  return localISO(date);
}

function isInPeriod(ymStr) {
  if (!ymStr) return false;
  if (PERIOD.type === 'year') {
    // V72: Support filtrage mensuel
    if (PERIOD.month !== null && PERIOD.month !== undefined && PERIOD.month !== '') {
      return ymStr === ym(PERIOD.year, parseInt(PERIOD.month));
    }
    return ymStr.startsWith(PERIOD.year + '-');
  }
  return ymStr >= PERIOD.start && ymStr <= PERIOD.end;
}
function getPeriodMonths() {
  var months = [];
  if (PERIOD.type === 'year') {
    // V72: Si un mois spécifique est sélectionné, retourner uniquement ce mois
    if (PERIOD.month !== null && PERIOD.month !== undefined && PERIOD.month !== '') {
      months.push(ym(PERIOD.year, parseInt(PERIOD.month)));
    } else {
      for (var m = 0; m < 12; m++) months.push(ym(PERIOD.year, m));
    }
  } else {
    var start = parseYM(PERIOD.start), end = parseYM(PERIOD.end);
    var y = start.y, m = start.m;
    while (y < end.y || (y === end.y && m <= end.m)) { months.push(ym(y, m)); m++; if (m > 11) { m = 0; y++; } }
  }
  return months;
}

function frenchHolidays(year) {
  var holidays = [year + '-01-01', year + '-05-01', year + '-05-08', year + '-07-14', year + '-08-15', year + '-11-01', year + '-11-11', year + '-12-25'];
  var a = year % 19, b = Math.floor(year / 100), c = year % 100;
  var d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25);
  var g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30;
  var i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7;
  var mm = Math.floor((a + 11 * h + 22 * l) / 451), month = Math.floor((h + l - 7 * mm + 114) / 31);
  var day = ((h + l - 7 * mm + 114) % 31) + 1;
  var easter = new Date(year, month - 1, day);
  var addDays = function(d, n) { var r = new Date(d); r.setDate(r.getDate() + n); return localISO(r); };
  holidays.push(addDays(easter, 1), addDays(easter, 39), addDays(easter, 50));
  return holidays;
}

function daysBiz(year, month) {
  var holidays = frenchHolidays(year);
  var count = 0, d = new Date(year, month, 1);
  while (d.getMonth() === month) {
    var dow = d.getDay();
    if (dow !== 0 && dow !== 6 && holidays.indexOf(localISO(d)) === -1) count++;
    d.setDate(d.getDate() + 1);
  }
  return count;
}

// V56: Calcul des jours ouvrables dans une plage de dates pour un mois donné
// Utile pour le premier/dernier mois d'une mission qui ne couvre pas le mois entier
function daysBizInRange(year, month, startDay, endDay) {
  var holidays = frenchHolidays(year);
  var count = 0;
  var lastDayOfMonth = new Date(year, month + 1, 0).getDate();
  var fromDay = Math.max(1, startDay || 1);
  var toDay = Math.min(lastDayOfMonth, endDay || lastDayOfMonth);
  var d = new Date(year, month, fromDay);
  while (d.getDate() <= toDay && d.getMonth() === month) {
    var dow = d.getDay();
    if (dow !== 0 && dow !== 6 && holidays.indexOf(localISO(d)) === -1) count++;
    d.setDate(d.getDate() + 1);
  }
  return count;
}

// V57: Déterminer si une mission est active (en cours) basé sur ses dates
function isMissionActive(mission) {
  if (!mission.debut || !mission.fin) return false;
  var today = localISO(TODAY);
  return today >= mission.debut && today <= mission.fin;
}

// V60: Statut mission complet : 'active', 'a_venir', 'terminee'
function getMissionStatus(mission) {
  if (!mission.debut || !mission.fin) return 'terminee';
  var today = localISO(TODAY);
  if (today < mission.debut) return 'a_venir';
  if (today > mission.fin) return 'terminee';
  return 'active';
}

// ACRE: calcul automatique de la date d'expiration
function getAcreInfo() {
  if (!COMPANY.debut || !COMPANY.acre) return { active: false, expiryDate: null, expiryYm: null, startYm: null };
  var start = new Date(COMPANY.debut);
  var startYear = start.getFullYear();
  var startQ = Math.floor(start.getMonth() / 3); // 0=Q1, 1=Q2, 2=Q3, 3=Q4

  // ACRE = 4 trimestres CIVILS dont le trimestre de création
  // Exemple: début mars 2025 (Q1) → Q1+Q2+Q3+Q4 2025 → fin 31/12/2025
  var endQ = startQ + 3; // Dernier trimestre = startQ + 3 (4 trimestres au total)
  var endYear = startYear + Math.floor(endQ / 4);
  var endQmod = endQ % 4; // 0=Q1, 1=Q2, 2=Q3, 3=Q4

  // Dernier jour du trimestre: mois suivant le trimestre, jour 0
  var expiryMonth = (endQmod + 1) * 3; // Premier mois du trimestre suivant
  var expiryDate = new Date(endYear, expiryMonth, 0); // Jour 0 = dernier jour du mois précédent

  var daysLeft = Math.ceil((expiryDate - TODAY) / (1000 * 60 * 60 * 24));
  var expiryYm = ym(expiryDate.getFullYear(), expiryDate.getMonth());
  var startYm = ym(startYear, start.getMonth()); // Premier mois de l'ACRE
  return { active: daysLeft > 0, expiryDate: localISO(expiryDate), expiryYm: expiryYm, startYm: startYm, daysLeft: daysLeft };
}

// Taux URSSAF dynamique selon mois et ACRE
function getUrssafRate(monthYm) {
  var year = monthYm ? parseInt(monthYm.substring(0, 4)) : TODAY.getFullYear();
  var acre = getAcreInfo();

  // Si ACRE configuré ET le mois est dans la période ACRE (entre startYm et expiryYm)
  if (COMPANY.acre && acre.expiryYm && monthYm && monthYm >= acre.startYm && monthYm <= acre.expiryYm) {
    return year >= 2026 ? LEGAL.urssafAcre2026 : LEGAL.urssafAcre2025;
  }
  return year >= 2026 ? LEGAL.urssafStd2026 : LEGAL.urssafStd2025;
}

function isTVAApplicable(dateStr) {
  if (!COMPANY.tvaDepuis) return false;
  return dateStr >= COMPANY.tvaDepuis;
}

function calculateIR(revenuBrut, year) {
  year = year || TODAY.getFullYear();
  var cfg = getIRConfig(year);
  var abattement = Math.max(revenuBrut * 0.34, 305); // Abattement 34% BNC, minimum 305€, PAS de plafond (correction V45)
  var revenuNet = revenuBrut - abattement - (cfg.perAnnuel || 0) + (cfg.autresRevenus || 0);
  var parts = cfg.parts || 1;
  var quotient = revenuNet / parts;
  var impotBrut = 0, prev = 0;
  var tranchesDetail = []; // Détail de chaque tranche
  
  for (var i = 0; i < IR_BRACKETS.length; i++) {
    var b = IR_BRACKETS[i];
    var trancheMin = prev;
    var trancheMax = b.max;
    var trancheBase = 0;
    var trancheImpot = 0;
    
    if (quotient > b.max) { 
      trancheBase = b.max - prev;
      trancheImpot = trancheBase * b.rate;
      impotBrut += trancheImpot; 
      prev = b.max; 
    } else { 
      trancheBase = quotient - prev;
      trancheImpot = trancheBase * b.rate;
      impotBrut += trancheImpot;
      // Enregistrer cette tranche (partielle)
      if (trancheBase > 0) {
        tranchesDetail.push({ min: trancheMin, max: quotient, base: trancheBase, rate: b.rate, impot: trancheImpot });
      }
      break; 
    }
    // Enregistrer cette tranche (complète)
    if (trancheBase > 0) {
      tranchesDetail.push({ min: trancheMin, max: trancheMax, base: trancheBase, rate: b.rate, impot: trancheImpot });
    }
  }
  
  var tmi = 0;
  for (var j = 0; j < IR_BRACKETS.length; j++) {
    if (quotient <= IR_BRACKETS[j].max) { tmi = IR_BRACKETS[j].rate; break; }
  }
  return { revenuNet: revenuNet, quotient: quotient, impot: Math.round(impotBrut * parts), tmi: tmi, parts: parts, perAnnuel: cfg.perAnnuel, autresRevenus: cfg.autresRevenus, tranches: tranchesDetail, abattement: abattement };
}

// V65: Source unique de vérité pour l'IR d'une année
// L'IR est basé sur le CA ENCAISSÉ (date de réception des paiements) sur l'année fiscale
// = Factures payées + Factures à recevoir dont le paiement est prévu sur l'année
function getIRForYear(year) {
  year = year || TODAY.getFullYear();
  var yearStr = String(year);
  var caEncaisse = 0;    // Factures déjà payées sur l'année
  var caAEncaisser = 0;  // Factures non payées mais paiement prévu sur l'année
  var detail = { encaisse: [], aEncaisser: [] };

  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      var paymentYear = paymentMonth.split('-')[0];
      if (paymentYear !== yearStr) return;

      if (f.status === 'payée') {
        // Facture déjà payée
        caEncaisse += f.ht;
        detail.encaisse.push({ mission: mis.client, mois: paymentMonth, montant: f.ht, numero: f.numero });
      } else {
        // Facture non payée mais paiement prévu sur l'année
        caAEncaisser += f.ht;
        detail.aEncaisser.push({ mission: mis.client, mois: paymentMonth, montant: f.ht, numero: f.numero, status: f.status });
      }
    });
  });

  var caTotal = caEncaisse + caAEncaisser;
  var ir = calculateIR(caTotal, year);

  return {
    year: year,
    caEncaisse: caEncaisse,
    caAEncaisser: caAEncaisser,
    caTotal: caTotal,
    ir: ir,
    impot: ir.impot,
    detail: detail
  };
}

function createSparkline(data, color, height) {
  height = height || 24;
  if (!data || data.length < 2) return '';
  var max = Math.max.apply(null, data), min = Math.min.apply(null, data);
  var range = max - min || 1;
  var width = 80;
  var points = data.map(function(v, i) { return (i * width / (data.length - 1)) + ',' + (height - ((v - min) / range * height * 0.8 + height * 0.1)); }).join(' ');
  return '<svg width="' + width + '" height="' + height + '" style="display:block"><polyline points="' + points + '" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round"/></svg>';
}

function getTrend(data) {
  if (!data || data.length < 3) return { direction: 'neutral', pct: 0 };
  var recent = data.slice(-3), old = data.slice(0, 3);
  var avgRecent = recent.reduce(function(a, b) { return a + b; }, 0) / recent.length;
  var avgOld = old.reduce(function(a, b) { return a + b; }, 0) / old.length;
  if (avgOld === 0) return { direction: 'neutral', pct: 0 };
  var pct = Math.round(((avgRecent - avgOld) / avgOld) * 100);
  return { direction: pct > 5 ? 'up' : pct < -5 ? 'down' : 'neutral', pct: pct };
}

function isPaid(id) { return TREASURY.paidCharges[id] === true; }
function togglePaid(id) { TREASURY.paidCharges[id] = !isPaid(id); saveAll(); render(); }
function markAllPaid(ids) { ids.forEach(function(id) { TREASURY.paidCharges[id] = true; }); saveAll(); render(); toast('Marqué payé', 'success'); }

function setFactureStatus(factureId, newStatus) {
  MISSIONS.forEach(function(m) { if (m.factures) m.factures.forEach(function(f) { if (f.id === factureId) f.status = newStatus; }); });
  saveAll(); render(); toast('Facture mise à jour', 'success');
}

function getPaymentMonth(mois, delaiMois, jourPaiement) {
  var p = parseYM(mois);
  var d = new Date(p.y, p.m + (delaiMois || 2), jourPaiement || 15);
  return ym(d.getFullYear(), d.getMonth());
}

function getPaymentDate(mois, delaiMois, jourPaiement) {
  var p = parseYM(mois);
  return new Date(p.y, p.m + (delaiMois || 2), jourPaiement || 15);
}

// Calcule le solde BANCAIRE au début de la période (seulement charges PAYÉES)
function getBalanceAtStartOfPeriod() {
  var periodStart = PERIOD.type === 'year' ? ym(PERIOD.year, 0) : PERIOD.start;
  var balance = TREASURY.soldeInitial;
  
  // Parcourir toutes les factures payées AVANT la période
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth < periodStart) {
        balance += f.ttc; // Encaissement TTC
        // Soustraire uniquement les charges PAYÉES
        var rate = getUrssafRate(paymentMonth);
        if (isPaid('URSSAF-' + f.id)) balance -= Math.round(f.ht * rate);
        if (isPaid('CFP-' + f.id)) balance -= Math.round(f.ht * LEGAL.cfp);
        if (f.tva > 0 && isPaid('TVA-' + f.id)) balance -= Math.round(f.tva);
        if (COMPANY.prelevementLiberatoire && isPaid('IMPLIB-' + f.id)) balance -= Math.round(f.ht * LEGAL.impLib);
      }
    });
  });
  
  // Charges manuelles PAYÉES et salaires AVANT la période
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois < periodStart) {
      if (mv.type === 'Charge' && isPaid(mv.id)) balance -= mv.montant;
      if (mv.type === 'Salaire') balance -= mv.montant;
    }
  });
  
  return balance;
}

// Calcule les provisions NON PAYÉES avant la période (report)
function getProvisionsBeforePeriod() {
  var periodStart = PERIOD.type === 'year' ? ym(PERIOD.year, 0) : PERIOD.start;
  var provisions = 0;
  
  // Charges liées aux factures
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth < periodStart) {
        var rate = getUrssafRate(paymentMonth);
        if (!isPaid('URSSAF-' + f.id)) provisions += Math.round(f.ht * rate);
        if (!isPaid('CFP-' + f.id)) provisions += Math.round(f.ht * LEGAL.cfp);
        if (f.tva > 0 && !isPaid('TVA-' + f.id)) provisions += Math.round(f.tva);
        if (COMPANY.prelevementLiberatoire && !isPaid('IMPLIB-' + f.id)) provisions += Math.round(f.ht * LEGAL.impLib);
      }
    });
  });
  
  // IR Estimé (si pas prélèvement libératoire) - proportionnel au CA HT avant la période, PAR ANNÉE
  if (!COMPANY.prelevementLiberatoire) {
    var caParAnnee = {}; // { '2025': { total: X, mois: {...} }, '2026': {...} }
    MISSIONS.forEach(function(mis) {
      if (!mis.factures) return;
      mis.factures.forEach(function(f) {
        if (f.status !== 'payée' || f.jours <= 0) return;
        var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
        if (paymentMonth < periodStart) {
          var year = paymentMonth.split('-')[0];
          if (!caParAnnee[year]) caParAnnee[year] = { total: 0, mois: {} };
          caParAnnee[year].mois[paymentMonth] = (caParAnnee[year].mois[paymentMonth] || 0) + f.ht;
          caParAnnee[year].total += f.ht;
        }
      });
    });
    Object.keys(caParAnnee).forEach(function(year) {
      var anneeData = caParAnnee[year];
      if (anneeData.total > 0) {
        var irAnnuel = calculateIR(anneeData.total, parseInt(year)).impot;
        Object.keys(anneeData.mois).forEach(function(m) {
          var caHTMois = anneeData.mois[m];
          var irMois = Math.round(irAnnuel * caHTMois / anneeData.total);
          var irId = 'IR-' + m;
          if (irMois > 0 && !isPaid(irId)) provisions += irMois;
        });
      }
    });
  }
  
  // Charges manuelles
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois < periodStart && mv.type === 'Charge' && !isPaid(mv.id)) {
      provisions += mv.montant;
    }
  });
  
  return provisions;
}

// Calcule le solde ABSOLU du compte (indépendant du filtre)
function getAbsoluteBalance() {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var balance = TREASURY.soldeInitial;
  
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth <= nowYm) {
        balance += f.ttc;
        var rate = getUrssafRate(paymentMonth);
        if (isPaid('URSSAF-' + f.id)) balance -= Math.round(f.ht * rate);
        if (isPaid('CFP-' + f.id)) balance -= Math.round(f.ht * LEGAL.cfp);
        if (f.tva > 0 && isPaid('TVA-' + f.id)) balance -= Math.round(f.tva);
        if (COMPANY.prelevementLiberatoire && isPaid('IMPLIB-' + f.id)) balance -= Math.round(f.ht * LEGAL.impLib);
      }
    });
  });
  
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois <= nowYm) {
      if (mv.type === 'Charge' && isPaid(mv.id)) balance -= mv.montant;
      if (mv.type === 'Salaire') balance -= mv.montant;
    }
  });
  
  // V47: Ajouter les intérêts du compte pro si activé
  if (TREASURY.rendementActif && TREASURY.rendementHistorique) {
    TREASURY.rendementHistorique.forEach(function(int) {
      if (int.mois <= nowYm) {
        balance += int.montant;
      }
    });
  }
  
  return balance;
}

// V59: Retourne le détail de la composition du solde absolu (indépendant du filtre)
function getAbsoluteBalanceDetail() {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var detail = {
    soldeInitial: TREASURY.soldeInitial || 0,
    encaissements: 0,
    chargesPayees: 0,
    salaires: 0,
    interets: 0
  };

  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth <= nowYm) {
        detail.encaissements += f.ttc;
        var rate = getUrssafRate(paymentMonth);
        if (isPaid('URSSAF-' + f.id)) detail.chargesPayees += Math.round(f.ht * rate);
        if (isPaid('CFP-' + f.id)) detail.chargesPayees += Math.round(f.ht * LEGAL.cfp);
        if (f.tva > 0 && isPaid('TVA-' + f.id)) detail.chargesPayees += Math.round(f.tva);
        if (COMPANY.prelevementLiberatoire && isPaid('IMPLIB-' + f.id)) detail.chargesPayees += Math.round(f.ht * LEGAL.impLib);
      }
    });
  });

  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois <= nowYm) {
      if (mv.type === 'Charge' && isPaid(mv.id)) detail.chargesPayees += mv.montant;
      if (mv.type === 'Salaire') detail.salaires += mv.montant;
    }
  });

  if (TREASURY.rendementActif && TREASURY.rendementHistorique) {
    TREASURY.rendementHistorique.forEach(function(int) {
      if (int.mois <= nowYm) detail.interets += int.montant;
    });
  }

  detail.soldeActuel = detail.soldeInitial + detail.encaissements - detail.chargesPayees - detail.salaires + detail.interets;
  return detail;
}

// V47: Calcule le solde moyen pour un mois donné (approximation basée sur début + fin)
function getSoldeMoyenMois(targetYm) {
  // Calculer le solde au début du mois (1er jour)
  var soldeDebut = TREASURY.soldeInitial;
  
  // Ajouter tous les mouvements jusqu'au mois précédent inclus
  var prevYm = getPreviousMonth(targetYm);
  
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth <= prevYm) {
        soldeDebut += f.ttc;
        var rate = getUrssafRate(paymentMonth);
        if (isPaid('URSSAF-' + f.id)) soldeDebut -= Math.round(f.ht * rate);
        if (isPaid('CFP-' + f.id)) soldeDebut -= Math.round(f.ht * LEGAL.cfp);
        if (f.tva > 0 && isPaid('TVA-' + f.id)) soldeDebut -= Math.round(f.tva);
        if (COMPANY.prelevementLiberatoire && isPaid('IMPLIB-' + f.id)) soldeDebut -= Math.round(f.ht * LEGAL.impLib);
      }
    });
  });
  
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois <= prevYm) {
      if (mv.type === 'Charge' && isPaid(mv.id)) soldeDebut -= mv.montant;
      if (mv.type === 'Salaire') soldeDebut -= mv.montant;
    }
  });
  
  // Intérêts des mois précédents
  if (TREASURY.rendementHistorique) {
    TREASURY.rendementHistorique.forEach(function(int) {
      if (int.mois < targetYm) soldeDebut += int.montant;
    });
  }
  
  // Calculer le solde à la fin du mois
  var soldeFin = soldeDebut;
  
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth === targetYm) {
        soldeFin += f.ttc;
        var rate = getUrssafRate(paymentMonth);
        if (isPaid('URSSAF-' + f.id)) soldeFin -= Math.round(f.ht * rate);
        if (isPaid('CFP-' + f.id)) soldeFin -= Math.round(f.ht * LEGAL.cfp);
        if (f.tva > 0 && isPaid('TVA-' + f.id)) soldeFin -= Math.round(f.tva);
        if (COMPANY.prelevementLiberatoire && isPaid('IMPLIB-' + f.id)) soldeFin -= Math.round(f.ht * LEGAL.impLib);
      }
    });
  });
  
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois === targetYm) {
      if (mv.type === 'Charge' && isPaid(mv.id)) soldeFin -= mv.montant;
      if (mv.type === 'Salaire') soldeFin -= mv.montant;
    }
  });
  
  // Moyenne simple début/fin
  return Math.max(0, (soldeDebut + soldeFin) / 2);
}

// V47: Calcule les intérêts mensuels du compte pro
function calculerRendementMensuel(targetYm) {
  if (!TREASURY.rendementActif || !TREASURY.rendementTaux) return 0;
  
  var soldeMoyen = getSoldeMoyenMois(targetYm);
  var tauxMensuel = (TREASURY.rendementTaux || 0) / 100 / 12;
  var interets = Math.round(soldeMoyen * tauxMensuel * 100) / 100; // Arrondi 2 décimales
  
  return { 
    mois: targetYm, 
    soldeMoyen: Math.round(soldeMoyen), 
    montant: interets, 
    taux: TREASURY.rendementTaux 
  };
}

// V47: Met à jour l'historique des intérêts pour les mois passés
function updateRendementHistorique() {
  if (!TREASURY.rendementActif) return;
  if (!TREASURY.rendementHistorique) TREASURY.rendementHistorique = [];
  
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var startYm = COMPANY.debut ? COMPANY.debut.substr(0, 7) : '2025-01';
  
  // Parcourir tous les mois depuis le début jusqu'au mois précédent
  var current = startYm;
  while (current < nowYm) {
    // Vérifier si ce mois a déjà un intérêt enregistré
    var existing = TREASURY.rendementHistorique.find(function(h) { return h.mois === current; });
    
    if (!existing) {
      var interets = calculerRendementMensuel(current);
      if (interets.montant > 0) {
        TREASURY.rendementHistorique.push(interets);
      }
    }
    
    current = getNextMonth(current);
  }
  
  // Trier par mois
  TREASURY.rendementHistorique.sort(function(a, b) { return a.mois.localeCompare(b.mois); });
}

// V47: Obtenir le mois suivant au format YYYY-MM
function getNextMonth(ymStr) {
  var parts = ymStr.split('-');
  var y = parseInt(parts[0]);
  var m = parseInt(parts[1]);
  m++;
  if (m > 12) { m = 1; y++; }
  return ym(y, m - 1);
}

// V47: Obtenir le mois précédent au format YYYY-MM
function getPreviousMonth(ymStr) {
  var parts = ymStr.split('-');
  var y = parseInt(parts[0]);
  var m = parseInt(parts[1]);
  m--;
  if (m < 1) { m = 12; y--; }
  return ym(y, m - 1);
}

// V47: Total des intérêts perçus sur une période
function getTotalRendement(fromYm, toYm) {
  if (!TREASURY.rendementHistorique) return 0;
  return TREASURY.rendementHistorique
    .filter(function(h) { return (!fromYm || h.mois >= fromYm) && (!toYm || h.mois <= toYm); })
    .reduce(function(sum, h) { return sum + h.montant; }, 0);
}

// Calcule les provisions ABSOLUES (toutes les charges non payées) avec détail par type
function getAbsoluteProvisions() {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var result = { total: 0, byType: {}, detail: [] };

  // Charges liées aux factures payées
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth <= nowYm) {
        var rate = getUrssafRate(paymentMonth);
        var urssaf = Math.round(f.ht * rate);
        var cfp = Math.round(f.ht * LEGAL.cfp);
        var tva = f.tva > 0 ? Math.round(f.tva) : 0;
        var impLib = COMPANY.prelevementLiberatoire ? Math.round(f.ht * LEGAL.impLib) : 0;

        if (!isPaid('URSSAF-' + f.id)) {
          result.total += urssaf;
          result.byType['URSSAF'] = (result.byType['URSSAF'] || 0) + urssaf;
          result.detail.push({ cat: 'URSSAF', mois: paymentMonth, montant: urssaf, id: 'URSSAF-' + f.id, source: mis.client });
        }
        if (!isPaid('CFP-' + f.id)) {
          result.total += cfp;
          result.byType['CFP'] = (result.byType['CFP'] || 0) + cfp;
          result.detail.push({ cat: 'CFP', mois: paymentMonth, montant: cfp, id: 'CFP-' + f.id, source: mis.client });
        }
        if (tva > 0 && !isPaid('TVA-' + f.id)) {
          result.total += tva;
          result.byType['TVA'] = (result.byType['TVA'] || 0) + tva;
          result.detail.push({ cat: 'TVA', mois: paymentMonth, montant: tva, id: 'TVA-' + f.id, source: mis.client });
        }
        if (impLib > 0 && !isPaid('IMPLIB-' + f.id)) {
          result.total += impLib;
          result.byType['Impôt'] = (result.byType['Impôt'] || 0) + impLib;
          result.detail.push({ cat: 'Impôt PL', mois: paymentMonth, montant: impLib, id: 'IMPLIB-' + f.id, source: mis.client });
        }
      }
    });
  });

  // V65/V69/V70/V71: IR Estimé - provisions mensuelles lissées
  // IR divisé par le nb de mois avec prévision de facturation, provisionné sur les mois encaissés
  if (!COMPANY.prelevementLiberatoire) {
    var currentYear = TODAY.getFullYear();

    // V71: Trouver les mois avec CA encaissé (factures payées)
    function getMonthsWithCA(year) {
      var months = {};
      MISSIONS.forEach(function(mis) {
        if (!mis.factures) return;
        mis.factures.forEach(function(f) {
          if (f.jours <= 0 || f.status !== 'payée') return;
          var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
          if (paymentMonth.startsWith(year + '-')) {
            var month = parseInt(paymentMonth.split('-')[1]) - 1;
            months[month] = true;
          }
        });
      });
      return Object.keys(months).map(function(m) { return parseInt(m); }).sort(function(a, b) { return a - b; });
    }

    // V71: Compter les mois avec prévision de facturation (toutes factures, pas juste payées)
    function countMonthsWithPlannedCA(year) {
      var months = {};
      MISSIONS.forEach(function(mis) {
        if (!mis.factures) return;
        mis.factures.forEach(function(f) {
          if (f.jours <= 0) return;
          var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
          if (paymentMonth.startsWith(year + '-')) {
            var month = parseInt(paymentMonth.split('-')[1]) - 1;
            months[month] = true;
          }
        });
      });
      return Object.keys(months).length || 1; // Au moins 1 pour éviter division par 0
    }

    // Helper pour ajouter les acomptes IR
    // IR divisé par nb mois avec prévision, provisionné sur mois encaissés
    function addIRMonthlyProvisions(year, irData, monthsWithCA, nbMoisPrevu) {
      if (irData.impot <= 0 || monthsWithCA.length === 0) return;
      var irMensuel = Math.round(irData.impot / nbMoisPrevu);

      monthsWithCA.forEach(function(m) {
        var monthStr = String(m + 1).padStart(2, '0');
        var irMonthId = 'IR-' + year + '-' + monthStr;

        if (!isPaid(irMonthId) && irMensuel > 0) {
          result.total += irMensuel;
          result.byType['IR Estimé'] = (result.byType['IR Estimé'] || 0) + irMensuel;
          result.detail.push({
            cat: 'IR Estimé',
            mois: year + '-' + monthStr,
            montant: irMensuel,
            id: irMonthId,
            source: 'Acompte · IR ' + year + ': ' + EUR(irData.impot) + ' /' + nbMoisPrevu
          });
        }
      });
    }

    // IR année précédente
    var previousYear = currentYear - 1;
    var irPrevData = getIRForYear(previousYear);
    var prevMonthsWithCA = getMonthsWithCA(previousYear);
    var prevNbMoisPrevu = countMonthsWithPlannedCA(previousYear);
    addIRMonthlyProvisions(previousYear, irPrevData, prevMonthsWithCA, prevNbMoisPrevu);

    // IR année en cours
    var irData = getIRForYear(currentYear);
    var currMonthsWithCA = getMonthsWithCA(currentYear);
    var currNbMoisPrevu = countMonthsWithPlannedCA(currentYear);
    addIRMonthlyProvisions(currentYear, irData, currMonthsWithCA, currNbMoisPrevu);
  }

  // Charges manuelles
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois <= nowYm && mv.type === 'Charge' && !isPaid(mv.id)) {
      result.total += mv.montant;
      var cat = mv.categorie || 'Autres';
      result.byType[cat] = (result.byType[cat] || 0) + mv.montant;
      result.detail.push({ cat: cat, mois: mv.mois, montant: mv.montant, id: mv.id, source: mv.description || '' });
    }
  });

  return result;
}

// V68: Récupère TOUTES les charges (payées et non payées) pour un type donné
function getAllChargesForType(typeName) {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var items = [];

  // Normaliser le nom de type pour la comparaison
  var isIR = typeName === 'IR' || typeName === 'IR Estimé' || typeName === 'Impôt';
  var isTVA = typeName === 'TVA';
  var isURSSAF = typeName === 'URSSAF';
  var isCFP = typeName === 'CFP';

  // Charges liées aux factures payées
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth <= nowYm) {
        var rate = getUrssafRate(paymentMonth);

        if (isURSSAF) {
          var urssaf = Math.round(f.ht * rate);
          items.push({ cat: 'URSSAF', mois: paymentMonth, montant: urssaf, id: 'URSSAF-' + f.id, source: mis.client });
        }
        if (isCFP) {
          var cfp = Math.round(f.ht * LEGAL.cfp);
          items.push({ cat: 'CFP', mois: paymentMonth, montant: cfp, id: 'CFP-' + f.id, source: mis.client });
        }
        if (isTVA && f.tva > 0) {
          items.push({ cat: 'TVA', mois: paymentMonth, montant: Math.round(f.tva), id: 'TVA-' + f.id, source: mis.client });
        }
        if (isIR && COMPANY.prelevementLiberatoire) {
          var impLib = Math.round(f.ht * LEGAL.impLib);
          if (impLib > 0) items.push({ cat: 'Impôt PL', mois: paymentMonth, montant: impLib, id: 'IMPLIB-' + f.id, source: mis.client });
        }
      }
    });
  });

  // V69/V70/V71: IR Estimé (pour non-PL)
  // IR divisé par nb mois avec prévision, provisionné sur mois encaissés
  if (isIR && !COMPANY.prelevementLiberatoire) {
    var currentYear = TODAY.getFullYear();

    // Trouver les mois avec CA encaissé (factures payées)
    function getMonthsWithCA(year) {
      var months = {};
      MISSIONS.forEach(function(mis) {
        if (!mis.factures) return;
        mis.factures.forEach(function(f) {
          if (f.jours <= 0 || f.status !== 'payée') return;
          var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
          if (paymentMonth.startsWith(year + '-')) {
            var month = parseInt(paymentMonth.split('-')[1]) - 1;
            months[month] = true;
          }
        });
      });
      return Object.keys(months).map(function(m) { return parseInt(m); }).sort(function(a, b) { return a - b; });
    }

    // Compter les mois avec prévision de facturation (toutes factures)
    function countMonthsWithPlannedCA(year) {
      var months = {};
      MISSIONS.forEach(function(mis) {
        if (!mis.factures) return;
        mis.factures.forEach(function(f) {
          if (f.jours <= 0) return;
          var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
          if (paymentMonth.startsWith(year + '-')) {
            var month = parseInt(paymentMonth.split('-')[1]) - 1;
            months[month] = true;
          }
        });
      });
      return Object.keys(months).length || 1;
    }

    // Helper pour ajouter les acomptes IR
    function addIRItems(year, irData, monthsWithCA, nbMoisPrevu) {
      if (irData.impot <= 0 || monthsWithCA.length === 0) return;
      var irMensuel = Math.round(irData.impot / nbMoisPrevu);

      monthsWithCA.forEach(function(m) {
        var monthStr = String(m + 1).padStart(2, '0');
        var irMonthId = 'IR-' + year + '-' + monthStr;

        if (irMensuel > 0) {
          items.push({
            cat: 'IR Estimé',
            mois: year + '-' + monthStr,
            montant: irMensuel,
            id: irMonthId,
            source: 'Acompte · IR ' + year + ': ' + EUR(irData.impot) + ' /' + nbMoisPrevu
          });
        }
      });
    }

    // IR année précédente
    var previousYear = currentYear - 1;
    var irPrevData = getIRForYear(previousYear);
    var prevMonthsWithCA = getMonthsWithCA(previousYear);
    var prevNbMoisPrevu = countMonthsWithPlannedCA(previousYear);
    addIRItems(previousYear, irPrevData, prevMonthsWithCA, prevNbMoisPrevu);

    // IR année en cours
    var irData = getIRForYear(currentYear);
    var currMonthsWithCA = getMonthsWithCA(currentYear);
    var currNbMoisPrevu = countMonthsWithPlannedCA(currentYear);
    addIRItems(currentYear, irData, currMonthsWithCA, currNbMoisPrevu);
  }

  // Charges manuelles
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.mois <= nowYm && mv.type === 'Charge') {
      var cat = mv.categorie || 'Autres';
      var matchType = (typeName === cat) ||
                      (isTVA && cat === 'TVA') ||
                      (isURSSAF && cat === 'URSSAF') ||
                      (isCFP && cat === 'CFP') ||
                      (isIR && (cat === 'IR' || cat === 'Impôt' || cat.indexOf('IR') >= 0));
      if (matchType) {
        items.push({ cat: cat, mois: mv.mois, montant: mv.montant, id: mv.id, source: mv.description || '' });
      }
    }
  });

  return items;
}

function buildMission(mis) {
  if (!mis.debut || !mis.fin) return;
  var start = new Date(mis.debut), end = new Date(mis.fin);
  var lignes = mis.lignes || [];
  var existingMap = {};
  lignes.forEach(function(l) { existingMap[l.ym] = l; });
  var newLignes = [];
  var d = new Date(start.getFullYear(), start.getMonth(), 1);
  var startYm = ym(start.getFullYear(), start.getMonth());
  var endYm = ym(end.getFullYear(), end.getMonth());
  while (d <= end) {
    var key = ym(d.getFullYear(), d.getMonth());
    var existing = existingMap[key];
    // V56: Calculer les jours ouvrables en tenant compte des dates début/fin
    var joursOuvrables;
    if (key === startYm && key === endYm) {
      // Mois unique: du jour de début au jour de fin
      joursOuvrables = daysBizInRange(d.getFullYear(), d.getMonth(), start.getDate(), end.getDate());
    } else if (key === startYm) {
      // Premier mois: du jour de début à la fin du mois
      joursOuvrables = daysBizInRange(d.getFullYear(), d.getMonth(), start.getDate(), 31);
    } else if (key === endYm) {
      // Dernier mois: du début du mois au jour de fin
      joursOuvrables = daysBizInRange(d.getFullYear(), d.getMonth(), 1, end.getDate());
    } else {
      // Mois complet
      joursOuvrables = daysBiz(d.getFullYear(), d.getMonth());
    }
    if (existing) {
      // V72: Toujours mettre à jour joursOuvrables selon les vraies dates de mission
      var oldJoursOuvrables = existing.joursOuvrables || 0;
      existing.joursOuvrables = joursOuvrables;

      // V72: Recalculer joursPrevus si:
      // - joursOuvrables a changé ET joursPrevus était = ancien joursOuvrables (pas de modif manuelle)
      // - OU joursPrevus dépasse le nouveau joursOuvrables (impossible de travailler plus que dispo)
      if (oldJoursOuvrables !== joursOuvrables && existing.joursPrevus === oldJoursOuvrables) {
        existing.joursPrevus = joursOuvrables;
      } else if ((existing.joursPrevus || 0) > joursOuvrables) {
        // V72: Plafonner joursPrevus aux jours réellement disponibles
        existing.joursPrevus = joursOuvrables;
      }
      existing.joursPrevus = existing.joursPrevus || joursOuvrables;

      // V72: joursReels aussi ne peut pas dépasser joursOuvrables
      if ((existing.joursReels || 0) > joursOuvrables) {
        existing.joursReels = joursOuvrables;
      }
      newLignes.push(existing);
    }
    else { newLignes.push({ ym: key, joursOuvrables: joursOuvrables, joursPrevus: joursOuvrables, joursReels: 0, conges: 0 }); }
    d.setMonth(d.getMonth() + 1);
  }
  mis.lignes = newLignes;
  
  var factures = mis.factures || [];
  var facturesMap = {};
  factures.forEach(function(f) { facturesMap[f.mois] = f; });
  var newFactures = [];
  mis.lignes.forEach(function(l) {
    var existing = facturesMap[l.ym];
    // Jours réels = prévus - congés
    var jours = l.joursReels > 0 ? l.joursReels : Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
    l.joursReels = jours;
    var ht = jours * mis.tjm;
    var tva = isTVAApplicable(l.ym) ? Math.round(ht * LEGAL.tvaRate * 100) / 100 : 0;
    if (existing) { existing.jours = jours; existing.ht = ht; existing.tva = tva; existing.ttc = ht + tva; newFactures.push(existing); }
    else { newFactures.push({ id: 'F-' + mis.id + '-' + l.ym, mois: l.ym, client: mis.client, jours: jours, ht: ht, tva: tva, ttc: ht + tva, status: 'brouillon' }); }
  });
  mis.factures = newFactures;
}

function openModal(id) { $('#' + id).classList.add('active'); }
function closeModal(id) { $('#' + id).classList.remove('active'); }
function closeAllModals() { $$('.modal').forEach(function(m) { m.classList.remove('active'); }); }

// V51: Toast notifications
function showToast(message, type) {
  type = type || 'info';
  var colors = { success: 'var(--success)', error: 'var(--danger)', warning: 'var(--warning)', info: 'var(--accent)' };
  var toast = el('div', { 
    style: { 
      position: 'fixed', bottom: '80px', left: '50%', transform: 'translateX(-50%)', 
      background: 'var(--bg-elevated)', color: 'var(--text-primary)', 
      padding: '12px 20px', borderRadius: '8px', fontSize: '14px',
      boxShadow: '0 4px 12px rgba(0,0,0,0.3)', zIndex: 10000,
      borderLeft: '4px solid ' + (colors[type] || colors.info),
      animation: 'slideUp 0.3s ease'
    } 
  }, message);
  document.body.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 3000);
}

// V51: Dynamic modal
function showModal(title, content) {
  closeAllModals();
  // V55: Supprimer tout dynamicModal existant pour éviter les duplications
  var existingModal = $('#dynamicModal');
  if (existingModal) existingModal.remove();

  var overlay = el('div', {
    class: 'modal active',
    id: 'dynamicModal',
    onclick: function(e) { if (e.target === overlay) closeDynamicModal(); }
  });
  var modal = el('div', { class: 'modal-content', style: { maxWidth: '400px' } });
  var header = el('div', { class: 'modal-header' });
  header.appendChild(el('h3', { class: 'modal-title' }, title));
  header.appendChild(el('button', { class: 'modal-close', onclick: function() { closeDynamicModal(); } }, '✕'));
  modal.appendChild(header);
  modal.appendChild(el('div', { class: 'modal-body' }, [content]));
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

// V55: Fonction dédiée pour fermer et supprimer le modal dynamique
function closeDynamicModal() {
  var modal = $('#dynamicModal');
  if (modal) modal.remove();
}


function createInput(label, type, id, value, placeholder) {
  var g = el('div', { class: 'form-group' });
  g.appendChild(el('label', { class: 'form-label', for: id }, label));
  var inp = el('input', { class: 'form-input', type: type, id: id, placeholder: placeholder || '' });
  if (value !== undefined && value !== null) inp.value = value;
  g.appendChild(inp);
  return g;
}

function createSelect(label, id, options, value) {
  var g = el('div', { class: 'form-group' });
  g.appendChild(el('label', { class: 'form-label', for: id }, label));
  var sel = el('select', { class: 'form-select', id: id });
  options.forEach(function(o) { var opt = el('option', { value: o.value }, o.label); if (o.value === value) opt.selected = true; sel.appendChild(opt); });
  g.appendChild(sel);
  return g;
}

function createTextarea(label, id, value, placeholder) {
  var g = el('div', { class: 'form-group' });
  g.appendChild(el('label', { class: 'form-label', for: id }, label));
  var ta = el('textarea', { class: 'form-input', id: id, rows: 3, placeholder: placeholder || '', style: { resize: 'vertical', minHeight: '60px' } });
  ta.value = value || '';
  g.appendChild(ta);
  return g;
}

// V50: Constante pour le préfixe de stockage
var STORAGE_PREFIX = 'freel_v50_';
var OLD_STORAGE_PREFIX = 'freel_v39_';

function saveAll() {
  try {
    localStorage.setItem(STORAGE_PREFIX + 'company', JSON.stringify(COMPANY));
    localStorage.setItem(STORAGE_PREFIX + 'missions', JSON.stringify(MISSIONS));
    localStorage.setItem(STORAGE_PREFIX + 'clients', JSON.stringify(CLIENTS));
    localStorage.setItem(STORAGE_PREFIX + 'treasury', JSON.stringify(TREASURY));
    localStorage.setItem(STORAGE_PREFIX + 'ir_config', JSON.stringify(IR_CONFIG));
  } catch (e) {
    showToast('⚠️ Stockage plein! Exportez vos données.', 'error');
    return;
  }
  autoBackup();
  // V51: Sync to cloud if connected
  if (CURRENT_USER && SYNC_ENABLED) syncToCloud();
}

function loadAll() {
  try {
    // V50: Migration automatique des données v39 vers v50
    var needsMigration = !localStorage.getItem(STORAGE_PREFIX + 'company') &&
                         localStorage.getItem(OLD_STORAGE_PREFIX + 'company');
    var prefix = needsMigration ? OLD_STORAGE_PREFIX : STORAGE_PREFIX;

    var c = localStorage.getItem(prefix + 'company');
    var m = localStorage.getItem(prefix + 'missions');
    var cl = localStorage.getItem(prefix + 'clients');
    var t = localStorage.getItem(prefix + 'treasury');
    var ir = localStorage.getItem(prefix + 'ir_config');
    if (c) COMPANY = Object.assign(COMPANY, JSON.parse(c));
    if (m) MISSIONS = JSON.parse(m);
    if (cl) CLIENTS = JSON.parse(cl);
    if (t) TREASURY = Object.assign(TREASURY, JSON.parse(t));
    if (ir) IR_CONFIG = JSON.parse(ir);

    // Si migration effectuée, sauvegarder avec le nouveau préfixe
    if (needsMigration) saveAll();

    // Migration: si anciennes données IR dans COMPANY, migrer vers IR_CONFIG
    if (COMPANY.irParts !== undefined) {
      var year = String(TODAY.getFullYear());
      if (!IR_CONFIG[year]) IR_CONFIG[year] = {};
      IR_CONFIG[year].parts = COMPANY.irParts || 1;
      IR_CONFIG[year].autresRevenus = COMPANY.autresRevenus || 0;
      IR_CONFIG[year].perAnnuel = COMPANY.perAnnuel || 0;
      delete COMPANY.irParts; delete COMPANY.autresRevenus; delete COMPANY.perAnnuel;
    }
    // Migration - initialiser invoiceCounter et invoiceRegistry si absents
    if (!COMPANY.invoiceCounter) COMPANY.invoiceCounter = {};
    if (!COMPANY.invoiceRegistry) COMPANY.invoiceRegistry = [];
    // Migration clients depuis missions existantes
    if (CLIENTS.length === 0 && MISSIONS.length > 0) {
      var clientNames = {};
      MISSIONS.forEach(function(mis) {
        if (mis.client && !clientNames[mis.client]) {
          var cli = {
            id: 'CLI' + Date.now() + Math.random().toString(36).substr(2, 5),
            nom: mis.client,
            adresse: mis.adresseClient || '',
            siret: '', contact: '', email: '', notes: '',
            delaiPaiement: mis.delaiPaiement || 2,
            jourPaiement: mis.jourPaiement || 15
          };
          CLIENTS.push(cli);
          clientNames[mis.client] = cli.id;
        }
      });
      MISSIONS.forEach(function(mis) {
        if (mis.client && clientNames[mis.client]) {
          mis.clientId = clientNames[mis.client];
        }
      });
      if (CLIENTS.length > 0) saveAll();
    }
  } catch (e) { console.error('Load error', e); }
}

// Helper pour obtenir config IR d'une année
function getIRConfig(year) {
  var y = String(year);
  if (!IR_CONFIG[y]) IR_CONFIG[y] = { parts: 1, autresRevenus: 0, perAnnuel: 0 };
  return IR_CONFIG[y];
}

function exportData() {
  var data = { version: APP_VERSION, date: localISO(TODAY), company: COMPANY, missions: MISSIONS, clients: CLIENTS, treasury: TREASURY, irConfig: IR_CONFIG };
  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'freel-backup-' + localISO(TODAY) + '.json'; a.click();
  toast('Export téléchargé', 'success');
}

function importData(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (data.company) COMPANY = Object.assign(COMPANY, data.company);
      if (data.missions) MISSIONS = data.missions;
      if (data.clients) CLIENTS = data.clients;
      if (data.treasury) TREASURY = Object.assign(TREASURY, data.treasury);
      if (data.irConfig) IR_CONFIG = Object.assign(IR_CONFIG, data.irConfig);
      if (!COMPANY.invoiceCounter) COMPANY.invoiceCounter = {};
      if (!COMPANY.invoiceRegistry) COMPANY.invoiceRegistry = [];
      MISSIONS.forEach(buildMission);
      saveAll(); render();
      showToast('Import réussi!', 'success');
    } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
  };
  reader.readAsText(file);
}

// ===== GÉNÉRATION FACTURE PDF =====
// ===== RAPPELS ÉCHÉANCES =====
function getUpcomingDeadlines() {
  var deadlines = [];
  var today = new Date(TODAY);
  var currentMonth = today.getMonth();
  var currentYear = today.getFullYear();
  var dayOfMonth = today.getDate();
  
  // Calculer fin du mois courant
  var endOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  var daysUntilEndOfMonth = endOfMonth - dayOfMonth;
  
  // URSSAF - fin du mois suivant (pour le CA du mois précédent)
  if (COMPANY.urssafPeriodicite === 'mensuel') {
    // Mensuel: fin de chaque mois
    if (daysUntilEndOfMonth <= 7) {
      deadlines.push({
        type: 'URSSAF',
        label: 'Déclaration URSSAF',
        date: new Date(currentYear, currentMonth, endOfMonth),
        daysLeft: daysUntilEndOfMonth,
        color: 'var(--danger)',
        icon: '🏥'
      });
    }
  } else {
    // Trimestriel: 30/04, 31/07, 31/10, 31/01
    var trimestreDates = [
      { m: 0, d: 31 },  // 31 janvier (T4 année précédente)
      { m: 3, d: 30 },  // 30 avril (T1)
      { m: 6, d: 31 },  // 31 juillet (T2)
      { m: 9, d: 31 }   // 31 octobre (T3)
    ];
    trimestreDates.forEach(function(td) {
      var deadlineDate = new Date(currentYear, td.m, td.d);
      if (td.m === 0 && currentMonth > 1) deadlineDate.setFullYear(currentYear + 1);
      var diff = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
      if (diff >= 0 && diff <= 14) {
        deadlines.push({
          type: 'URSSAF',
          label: 'Déclaration URSSAF T' + (td.m === 0 ? '4' : Math.floor(td.m / 3)),
          date: deadlineDate,
          daysLeft: diff,
          color: 'var(--danger)',
          icon: '🏥'
        });
      }
    });
  }
  
  // CFE - 15 décembre
  var cfeDate = new Date(currentYear, 11, 15);
  var cfeDiff = Math.ceil((cfeDate - today) / (1000 * 60 * 60 * 24));
  if (cfeDiff >= 0 && cfeDiff <= 30) {
    deadlines.push({
      type: 'CFE',
      label: 'Paiement CFE',
      date: cfeDate,
      daysLeft: cfeDiff,
      color: 'var(--warning)',
      icon: '🏢'
    });
  }
  
  // TVA - si actif, acomptes en juillet et décembre
  if (COMPANY.tvaDepuis) {
    var tvaJuillet = new Date(currentYear, 6, 20);
    var tvaDec = new Date(currentYear, 11, 20);
    var tvaMai = new Date(currentYear, 4, 5);
    
    [
      { date: tvaMai, label: 'Déclaration TVA CA12' },
      { date: tvaJuillet, label: 'Acompte TVA (55%)' },
      { date: tvaDec, label: 'Acompte TVA (40%)' }
    ].forEach(function(t) {
      var diff = Math.ceil((t.date - today) / (1000 * 60 * 60 * 24));
      if (diff >= 0 && diff <= 30) {
        deadlines.push({
          type: 'TVA',
          label: t.label,
          date: t.date,
          daysLeft: diff,
          color: '#f472b6',
          icon: '🏛️'
        });
      }
    });
  }
  
  // IR - si pas prélèvement libératoire, acomptes le 15
  if (!COMPANY.prelevementLiberatoire) {
    var irDate = new Date(currentYear, currentMonth, 15);
    if (dayOfMonth > 15) irDate.setMonth(currentMonth + 1);
    var irDiff = Math.ceil((irDate - today) / (1000 * 60 * 60 * 24));
    if (irDiff >= 0 && irDiff <= 7) {
      deadlines.push({
        type: 'IR',
        label: 'Acompte IR',
        date: irDate,
        daysLeft: irDiff,
        color: '#fbbf24',
        icon: '💰'
      });
    }
  }
  
  // Trier par date
  deadlines.sort(function(a, b) { return a.daysLeft - b.daysLeft; });
  
  return deadlines;
}

// ===== VALIDATION INPUTS =====
function validateInput(value, type, options) {
  options = options || {};
  var errors = [];
  
  switch (type) {
    case 'siret':
      var siret = String(value).replace(/\s/g, '');
      if (siret && siret.length !== 14) errors.push('SIRET doit contenir 14 chiffres');
      if (siret && !/^\d+$/.test(siret)) errors.push('SIRET ne doit contenir que des chiffres');
      break;
    case 'iban':
      var iban = String(value).replace(/\s/g, '').toUpperCase();
      if (iban && iban.length < 14) errors.push('IBAN trop court');
      if (iban && !/^[A-Z]{2}\d{2}[A-Z0-9]+$/.test(iban)) errors.push('Format IBAN invalide');
      break;
    case 'email':
      if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) errors.push('Email invalide');
      break;
    case 'phone':
      var phone = String(value).replace(/\s/g, '');
      if (phone && !/^[\d+\-().]+$/.test(phone)) errors.push('Téléphone invalide');
      break;
    case 'number':
      if (isNaN(parseFloat(value))) errors.push('Nombre invalide');
      if (options.min !== undefined && parseFloat(value) < options.min) errors.push('Minimum: ' + options.min);
      if (options.max !== undefined && parseFloat(value) > options.max) errors.push('Maximum: ' + options.max);
      break;
    case 'date':
      if (value && isNaN(Date.parse(value))) errors.push('Date invalide');
      break;
  }
  
  return { valid: errors.length === 0, errors: errors };
}

function showValidationError(inputId, message) {
  var input = $('#' + inputId);
  if (!input) return;
  input.style.borderColor = 'var(--danger)';
  var existing = input.parentNode.querySelector('.validation-error');
  if (existing) existing.remove();
  var errorDiv = el('div', { class: 'validation-error', style: { color: 'var(--danger)', fontSize: '10px', marginTop: '4px' } }, message);
  input.parentNode.appendChild(errorDiv);
}

function clearValidationError(inputId) {
  var input = $('#' + inputId);
  if (!input) return;
  input.style.borderColor = '';
  var existing = input.parentNode.querySelector('.validation-error');
  if (existing) existing.remove();
}

// ===== SPRINT 5: SOUS-FONCTIONS DE COMPUTE (A3) =====

/**
 * Calcule les indicateurs KPI (TJM effectif, taux facturation, etc.)
 * @param {Object} data - Objet data de compute()
 * @param {Array} months - Mois de la période
 */
function computeIndicators(data, months) {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  
  // TJM Effectif = CA réel / jours travaillés
  data.tjmEffectif = data.joursReal > 0 ? Math.round(data.caReal / data.joursReal) : 0;
  
  // Taux de facturation = jours facturés / jours ouvrables
  var totalJoursOuvrables = 0;
  months.forEach(function(m) {
    totalJoursOuvrables += data.workedDays[m].ouvrables;
  });
  data.tauxFacturation = totalJoursOuvrables > 0 ? data.joursReal / totalJoursOuvrables : 0;
  data.joursOuvrables = totalJoursOuvrables;
  
  // TJM Net (après charges)
  var tauxCharges = getUrssafRate(nowYm) + LEGAL.cfp + (COMPANY.prelevementLiberatoire ? LEGAL.impLib : 0);
  data.tjmNet = data.tjmEffectif > 0 ? Math.round(data.tjmEffectif * (1 - tauxCharges)) : 0;
  
  // Salaire moyen (calculé avant runway)
  var salairesNonZero = data.sparklineData.salaires.filter(function(s) { return s > 0; });
  data.salaireMoyen = salairesNonZero.length > 0 ? Math.round(salairesNonZero.reduce(function(a, b) { return a + b; }, 0) / salairesNonZero.length) : 0;

  // V51: Runway (autonomie) = Cash / (Charges + Salaire estimé)
  var avgCharges = months.length > 0 ? data.totalCharges / months.length : 500;
  // V51: Utilise le salaire estimé paramétré ou le salaire moyen historique
  var salaireRef = TREASURY.salaireEstime || data.salaireMoyen || 2000;
  var depensesMensuelles = avgCharges + salaireRef;
  data.salaireEstime = salaireRef;
  data.avgCharges = Math.round(avgCharges);
  data.runway = depensesMensuelles > 0 ? Math.floor(data.cashDispoAbsolu / depensesMensuelles) : 99;
  data.depensesMensuelles = Math.round(depensesMensuelles);

  // V51: Salaire versable = Cash dispo - réserve minimum
  var reserveMin = TREASURY.reserveCompte || 150;
  data.salaireVersable = Math.max(0, Math.floor((data.cashDispoAbsolu - reserveMin) / 100) * 100);
  data.salaireReco = data.salaireVersable;
  data.reserveCompte = reserveMin;
}

/**
 * Génère les alertes basées sur l'état des données
 * @param {Object} data - Objet data de compute()
 */
function computeAlerts(data) {
  // ACRE expiration
  var acre = getAcreInfo();
  if (COMPANY.acre && acre.active && acre.daysLeft <= 90) {
    data.alerts.push({ type: 'warning', icon: '⚠️', title: 'ACRE expire ' + fmtLong(acre.expiryDate), text: 'Cotisations passeront à ' + PCT(getUrssafRate(ym(TODAY.getFullYear() + 1, 0))) });
  }
  
  // Factures en retard
  if (data.lateCount > 0) {
    data.alerts.push({ type: 'danger', icon: '🚨', title: data.lateCount + ' facture(s) en retard', text: 'Relance tes clients!' });
  }
  
  // Provisions à payer
  if (data.provisionsAbsolues > 1000) {
    data.alerts.push({ type: 'info', icon: '📋', title: 'Charges à payer: ' + EUR(data.provisionsAbsolues), text: 'Pense à provisionner', hasButtons: true });
  }
  
  // Salaire recommandé
  if (data.salaireReco >= 500) {
    data.alerts.push({ type: 'success', icon: '💡', title: 'Salaire possible: ' + EUR(data.salaireReco), text: 'Cash disponible suffisant', action: 'salaire' });
  }
  
  // Seuil micro-entreprise
  var currentYearCA = 0;
  var currentYear = TODAY.getFullYear();
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status === 'payée' && f.jours > 0) {
        var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
        if (paymentMonth.startsWith(currentYear + '-')) {
          currentYearCA += f.ht;
        }
      }
    });
  });
  data.caHTAnnuel = currentYearCA;
  
  var seuilMicro = 77700;
  var seuilTVA = 36800;
  var pctMicro = currentYearCA / seuilMicro;
  var pctTVA = currentYearCA / seuilTVA;
  
  if (currentYearCA >= seuilMicro * 0.9) {
    data.alerts.push({ type: 'danger', icon: '🚨', title: 'Seuil micro-entreprise: ' + PCT(pctMicro), text: 'CA: ' + EUR(currentYearCA) + ' / ' + EUR(seuilMicro) + ' - Risque de basculement régime réel!' });
  } else if (currentYearCA >= seuilMicro * 0.8) {
    data.alerts.push({ type: 'warning', icon: '⚠️', title: 'Approche seuil micro: ' + PCT(pctMicro), text: 'CA: ' + EUR(currentYearCA) + ' / ' + EUR(seuilMicro) });
  }
  
  // Seuil TVA
  if (!COMPANY.tvaDepuis && currentYearCA >= seuilTVA * 0.9) {
    data.alerts.push({ type: 'warning', icon: '🏛️', title: 'Seuil TVA: ' + PCT(pctTVA), text: 'Vous devrez facturer la TVA au-delà de ' + EUR(seuilTVA) });
  }
  
  // URSSAF reminder
  var dayOfMonth = TODAY.getDate();
  if (dayOfMonth >= 15 && dayOfMonth <= 20 && data.provByType['URSSAF'] > 0) {
    data.alerts.push({ type: 'warning', icon: '📅', title: 'Déclaration URSSAF', text: 'À faire avant le 20 du mois' });
  }
}

// COMPUTE - Charges liées au mois d'ENCAISSEMENT (pas réalisation)
function compute() {
  var months = getPeriodMonths();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  
  var data = {
    caReal: 0, caPrev: 0, caEnc: 0, caAEnc: 0, lateCount: 0,
    joursReal: 0, joursPrev: 0, joursOff: 0,
    chargesPayees: 0, chargesAPayer: 0, provisions: 0,
    salaires: 0, beneficeNet: 0, margeNette: 0,
    soldeDebut: getBalanceAtStartOfPeriod(), // Solde bancaire au début de la période
    provisionsReport: getProvisionsBeforePeriod(), // Provisions non payées avant la période
    solde: 0, cashDispo: 0, runway: 0,
    // Valeurs ABSOLUES (indépendantes du filtre)
    soldeAbsolu: getAbsoluteBalance(),
    provisionsAbsolues: 0, // calculé après
    provAbsoluesByType: {}, // par type
    allProvisionsDetail: [], // détail complet
    cashDispoAbsolu: 0, // calculé après
    tjmEffectif: 0, tauxOccupation: 0, salaireReco: 0, salaireMoyen: 0,
    monthsData: {}, workedDays: {}, sparklineData: { caReal: [], caEnc: [], aEnc: [], salaires: [] },
    facturesAEncaisser: [], alerts: [],
    facturesStats: { payees: 0, envoyees: 0, retard: 0, brouillon: 0 },
    detailEncaisse: [], detailChargesPayees: [], detailChargesAPayer: [], detailSalaires: [],
    provByType: {}, provByMonth: {},
    totalCharges: 0, chargesDetail: []
  };
  
  // Calculer provisions absolues avec détail
  var provAbsolues = getAbsoluteProvisions();
  data.provisionsAbsolues = provAbsolues.total;
  data.provAbsoluesByType = provAbsolues.byType;
  data.allProvisionsDetail = provAbsolues.detail;
  
  // Cash dispo début période = solde début - provisions reportées
  data.cashDispoDebut = data.soldeDebut - data.provisionsReport;
  // Cash dispo absolu
  data.cashDispoAbsolu = data.soldeAbsolu - data.provisionsAbsolues;
  
  // Init months
  months.forEach(function(m) {
    data.monthsData[m] = { prev: 0, real: 0, enc: 0, encHT: 0, charges: [], chargesPaid: 0, chargesUnpaid: 0, solde: 0, cashDispo: 0, salaires: 0 };
    data.workedDays[m] = { reels: 0, prevus: 0, conges: 0, ouvrables: daysBiz(parseYM(m).y, parseYM(m).m) };
    data.provByMonth[m] = 0;
  });
  
  // Process missions - CA réalisé et prévu (V64: définitions corrigées)
  // Réalisé = jours réellement travaillés jusqu'à aujourd'hui (passé + présent)
  // Prévu = jours planifiés dans le futur uniquement
  MISSIONS.forEach(function(mis) {
    if (!mis.lignes) return;
    mis.lignes.forEach(function(l) {
      if (!isInPeriod(l.ym)) return;
      var md = data.monthsData[l.ym];
      var wd = data.workedDays[l.ym];
      var joursReels = l.joursReels > 0 ? l.joursReels : 0;
      var joursPrevus = Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));

      // V64: Séparer passé/présent du futur
      if (l.ym <= nowYm) {
        // Mois passé ou actuel: seuls les jours réels comptent dans "réalisé"
        var caRealMois = joursReels * mis.tjm;
        md.real += caRealMois;
        data.caReal += caRealMois;
        data.joursReal += joursReels;
        wd.reels += joursReels;
      } else {
        // Mois futur: les jours prévus comptent dans "prévu"
        var caPrevMois = joursPrevus * mis.tjm;
        md.prev += caPrevMois;
        data.caPrev += caPrevMois;
        data.joursPrev += joursPrevus;
        wd.prevus += joursPrevus;
      }

      // Congés et jours ouvrables pour tous les mois
      data.joursOff += l.conges || 0;
      wd.conges += l.conges || 0;
    });
    
    // Factures et charges (liées au mois d'encaissement)
    if (mis.factures) {
      mis.factures.forEach(function(f) {
        if (f.jours <= 0) return;
        var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
        var paymentDate = getPaymentDate(f.mois, mis.delaiPaiement, mis.jourPaiement);
        f.paymentMonth = paymentMonth;
        f.paymentDate = paymentDate;
        f.jourPaiement = mis.jourPaiement;
        f.isLate = f.status === 'envoyée' && TODAY > paymentDate;
        
        // Inclure si mois réalisation OU mois paiement dans la période
        var inPeriodMois = isInPeriod(f.mois);
        var inPeriodPayment = isInPeriod(paymentMonth);
        if (!inPeriodMois && !inPeriodPayment) return;
        
        if (f.status === 'payée') {
          // Encaissement seulement si paymentMonth dans période
          if (inPeriodPayment) {
            data.caEnc += f.ttc;
            var encMd = data.monthsData[paymentMonth];
            if (encMd) {
              encMd.enc += f.ttc;
              encMd.encHT += f.ht; // Stocker aussi le CA HT
            }
            data.detailEncaisse.push({ client: f.client, mois: f.mois, montant: f.ttc, ht: f.ht, paymentMonth: paymentMonth });
          }
          data.facturesStats.payees++;
          
          // CHARGES LIÉES AU MOIS D'ENCAISSEMENT
          if (inPeriodPayment) {
            var chargeMonth = paymentMonth;
            var chMd = data.monthsData[chargeMonth];
            if (chMd) {
              var rate = getUrssafRate(chargeMonth);
              
              // URSSAF
              var urssaf = Math.round(f.ht * rate);
              var urssafId = 'URSSAF-' + f.id;
              chMd.charges.push({ id: urssafId, cat: 'URSSAF', desc: PCT(rate), montant: urssaf, mois: chargeMonth, source: f.client + ' ' + fmtMonthShort(f.mois) });
              if (isPaid(urssafId)) { data.chargesPayees += urssaf; chMd.chargesPaid += urssaf; data.detailChargesPayees.push({ cat: 'URSSAF', mois: chargeMonth, montant: urssaf, source: f.client }); }
              else { data.chargesAPayer += urssaf; chMd.chargesUnpaid += urssaf; data.provByMonth[chargeMonth] = (data.provByMonth[chargeMonth] || 0) + urssaf; data.provByType['URSSAF'] = (data.provByType['URSSAF'] || 0) + urssaf; data.detailChargesAPayer.push({ cat: 'URSSAF', mois: chargeMonth, montant: urssaf, id: urssafId, source: f.client }); }
              
              // CFP
              var cfp = Math.round(f.ht * LEGAL.cfp);
              var cfpId = 'CFP-' + f.id;
              chMd.charges.push({ id: cfpId, cat: 'CFP', desc: 'Formation', montant: cfp, mois: chargeMonth, source: f.client + ' ' + fmtMonthShort(f.mois) });
              if (isPaid(cfpId)) { data.chargesPayees += cfp; chMd.chargesPaid += cfp; data.detailChargesPayees.push({ cat: 'CFP', mois: chargeMonth, montant: cfp, source: f.client }); }
              else { data.chargesAPayer += cfp; chMd.chargesUnpaid += cfp; data.provByMonth[chargeMonth] = (data.provByMonth[chargeMonth] || 0) + cfp; data.provByType['CFP'] = (data.provByType['CFP'] || 0) + cfp; data.detailChargesAPayer.push({ cat: 'CFP', mois: chargeMonth, montant: cfp, id: cfpId, source: f.client }); }
              
              // TVA
              if (f.tva > 0) {
                var tvaId = 'TVA-' + f.id;
                chMd.charges.push({ id: tvaId, cat: 'TVA', desc: 'Collectée', montant: Math.round(f.tva), mois: chargeMonth, source: f.client + ' ' + fmtMonthShort(f.mois) });
                if (isPaid(tvaId)) { data.chargesPayees += Math.round(f.tva); chMd.chargesPaid += Math.round(f.tva); data.detailChargesPayees.push({ cat: 'TVA', mois: chargeMonth, montant: Math.round(f.tva), source: f.client }); }
                else { data.chargesAPayer += Math.round(f.tva); chMd.chargesUnpaid += Math.round(f.tva); data.provByMonth[chargeMonth] = (data.provByMonth[chargeMonth] || 0) + Math.round(f.tva); data.provByType['TVA'] = (data.provByType['TVA'] || 0) + Math.round(f.tva); data.detailChargesAPayer.push({ cat: 'TVA', mois: chargeMonth, montant: Math.round(f.tva), id: tvaId, source: f.client }); }
              }
              
              // Impôt (prél. libératoire)
              if (COMPANY.prelevementLiberatoire) {
                var impLib = Math.round(f.ht * LEGAL.impLib);
                var impId = 'IMPLIB-' + f.id;
                chMd.charges.push({ id: impId, cat: 'Impôt PL', desc: PCT(LEGAL.impLib), montant: impLib, mois: chargeMonth, source: f.client + ' ' + fmtMonthShort(f.mois) });
                if (isPaid(impId)) { data.chargesPayees += impLib; chMd.chargesPaid += impLib; data.detailChargesPayees.push({ cat: 'Impôt PL', mois: chargeMonth, montant: impLib, source: f.client }); }
                else { data.chargesAPayer += impLib; chMd.chargesUnpaid += impLib; data.provByMonth[chargeMonth] = (data.provByMonth[chargeMonth] || 0) + impLib; data.provByType['Impôt'] = (data.provByType['Impôt'] || 0) + impLib; data.detailChargesAPayer.push({ cat: 'Impôt PL', mois: chargeMonth, montant: impLib, id: impId, source: f.client }); }
              }
            }
          }
        } else if (f.status === 'envoyée' && inPeriodPayment) {
          data.caAEnc += f.ttc;
          data.facturesAEncaisser.push(f);
          data.facturesStats.envoyees++;
          if (f.isLate) { data.lateCount++; data.facturesStats.retard++; }
        } else if (inPeriodPayment) {
          // Brouillon = aussi à encaisser (projection)
          data.caAEnc += f.ttc;
          f.isBrouillon = true;
          data.facturesAEncaisser.push(f);
          data.facturesStats.brouillon++;
        }
      });
    }
  });
  
  // V65: IR estimé - utilise getIRForYear() comme source unique de vérité
  if (!COMPANY.prelevementLiberatoire) {
    var periodYear = parseInt(months[0].split('-')[0]);
    var irData = getIRForYear(periodYear);
    var irId = 'IR-' + periodYear;
    if (irData.impot > 0) {
      // Ajouter l'IR annuel comme charge à payer
      var lastMonth = months[months.length - 1];
      var md = data.monthsData[lastMonth];
      md.charges.push({ id: irId, cat: 'IR Estimé', desc: 'CA ' + periodYear + ': ' + EUR(irData.caTotal), montant: irData.impot, mois: lastMonth });
      if (isPaid(irId)) {
        data.chargesPayees += irData.impot;
        md.chargesPaid += irData.impot;
      } else {
        data.chargesAPayer += irData.impot;
        md.chargesUnpaid += irData.impot;
        data.provByMonth[lastMonth] = (data.provByMonth[lastMonth] || 0) + irData.impot;
        data.provByType['IR Estimé'] = irData.impot;
        data.detailChargesAPayer.push({
          cat: 'IR Estimé',
          mois: lastMonth,
          montant: irData.impot,
          id: irId,
          source: 'CA ' + periodYear + ': Encaissé ' + EUR(irData.caEncaisse) + ' + À encaisser ' + EUR(irData.caAEncaisser)
        });
      }
    }
  }
  
  // Charges manuelles
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.type === 'Charge' && isInPeriod(mv.mois)) {
      var md = data.monthsData[mv.mois];
      if (md) {
        md.charges.push({ id: mv.id, cat: mv.categorie, desc: mv.description, montant: mv.montant, mois: mv.mois, manual: true });
        if (isPaid(mv.id)) { data.chargesPayees += mv.montant; md.chargesPaid += mv.montant; data.detailChargesPayees.push({ cat: mv.categorie, desc: mv.description, mois: mv.mois, montant: mv.montant }); }
        else { data.chargesAPayer += mv.montant; md.chargesUnpaid += mv.montant; data.provByMonth[mv.mois] = (data.provByMonth[mv.mois] || 0) + mv.montant; data.provByType[mv.categorie] = (data.provByType[mv.categorie] || 0) + mv.montant; data.detailChargesAPayer.push({ cat: mv.categorie, desc: mv.description, mois: mv.mois, montant: mv.montant, id: mv.id }); }
      }
    }
  });
  
  // Salaires
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.type === 'Salaire' && isInPeriod(mv.mois)) {
      var md = data.monthsData[mv.mois];
      if (md) { md.salaires += mv.montant; data.salaires += mv.montant; data.detailSalaires.push({ mois: mv.mois, montant: mv.montant, date: mv.date }); }
    }
  });
  
  // Provisions totales
  data.provisions = data.chargesAPayer;
  data.totalCharges = data.chargesPayees + data.chargesAPayer;
  
  // Calcul solde progressif et cash dispo cumulé
  var soldeRunning = data.soldeDebut;
  var provisionsCumulees = 0;
  months.forEach(function(m) {
    var md = data.monthsData[m];
    soldeRunning += md.enc - md.chargesPaid - md.salaires;
    provisionsCumulees += md.chargesUnpaid;
    md.solde = soldeRunning;
    md.cashDispo = soldeRunning - provisionsCumulees; // Cash dispo = solde - TOUTES provisions jusqu'ici
  });
  
  data.solde = data.soldeDebut + data.caEnc - data.chargesPayees - data.salaires;
  data.cashDispo = data.solde - data.provisions;
  
  // Calculer "à encaisser" par mois pour projection
  data.facturesAEncaisser.forEach(function(f) {
    var md = data.monthsData[f.paymentMonth];
    if (md) {
      md.aEnc = (md.aEnc || 0) + f.ttc;
    }
  });
  
  // Sparklines
  months.forEach(function(m) {
    var md = data.monthsData[m];
    data.sparklineData.caReal.push(md.real);
    data.sparklineData.caEnc.push(md.enc);
    data.sparklineData.aEnc.push(md.aEnc || 0);
    data.sparklineData.salaires.push(md.salaires);
  });
  
  // Indicateurs
  data.tjmEffectif = data.joursReal > 0 ? Math.round(data.caReal / data.joursReal) : 0;
  var joursOuvrablesTotal = months.reduce(function(acc, m) { return acc + data.workedDays[m].ouvrables; }, 0);
  data.tauxOccupation = joursOuvrablesTotal > 0 ? data.joursReal / joursOuvrablesTotal : 0;
  
  // Détail des charges pour waterfall (groupées par catégorie)
  var chargesByCat = {};
  data.detailChargesPayees.concat(data.detailChargesAPayer).forEach(function(ch) {
    var cat = ch.cat.replace(' PL', '').replace(' Estimé', '');
    chargesByCat[cat] = (chargesByCat[cat] || 0) + ch.montant;
  });
  // Ajouter catégories à 0 pour exhaustivité
  ['URSSAF', 'TVA', 'CFP', 'Impôt', 'IR'].forEach(function(cat) {
    if (!chargesByCat[cat]) chargesByCat[cat] = 0;
  });
  data.chargesDetail = Object.keys(chargesByCat).map(function(cat) {
    return { cat: cat, montant: chargesByCat[cat] };
  }).sort(function(a, b) { return b.montant - a.montant; });
  
  // V61: Calculer TVA déductible sur achats pro
  data.tvaDeductible = 0;
  TREASURY.mouvements.forEach(function(mv) {
    if (mv.type === 'Charge' && mv.tvaDeductible > 0 && isInPeriod(mv.mois)) {
      data.tvaDeductible += mv.tvaDeductible;
    }
  });

  // Calculer TVA et CA HT pour la marge
  var tvaInCharges = data.chargesDetail.find(function(c) { return c.cat === 'TVA'; });
  data.tvaCollectee = tvaInCharges ? tvaInCharges.montant : 0;
  data.tvaTotale = data.tvaCollectee; // Pour rétrocompatibilité
  data.tvaNette = Math.max(0, data.tvaCollectee - data.tvaDeductible); // TVA à reverser = collectée - déductible
  data.caHT = data.caEnc - data.tvaCollectee;
  
  // Correction bénéfice - basé sur CA HT (la TVA n'est pas un revenu)
  // Charges hors TVA collectée (car TVA collectée = dette, pas une charge réelle)
  var chargesHorsTVA = data.totalCharges - data.tvaTotale;
  data.beneficeNet = data.caHT - chargesHorsTVA; // Bénéfice net = CA HT - charges (hors TVA)
  data.margeNette = data.caHT > 0 ? data.beneficeNet / data.caHT : 0;
  
  // Appel aux sous-fonctions (A3)
  computeIndicators(data, months);
  computeAlerts(data);
  
  // Sort factures
  data.facturesAEncaisser.sort(function(a, b) { return (a.paymentMonth || a.mois).localeCompare(b.paymentMonth || b.mois); });
  
  COMPUTED = data;
  return data;
}

function computeProjections(scenario, params) {
  params = params || {};
  var scen = SCENARIOS[scenario];
  var data = compute();
  
  var tjm = params.tjm || (MISSIONS.length > 0 ? MISSIONS[0].tjm : 400);
  var year = params.year || (TODAY.getMonth() >= 6 ? TODAY.getFullYear() + 1 : TODAY.getFullYear());
  var salairesMensuels = params.salaireMensuel || data.salaireMoyen || 2500;
  
  // V45: Amélioration - Trouver les missions actives pour chaque mois de l'année projetée
  function getMissionsForMonth(monthYm) {
    return MISSIONS.filter(function(m) {
      if (!m.debut || !m.fin) return false;
      var mDebut = m.debut.substring(0, 7);
      var mFin = m.fin.substring(0, 7);
      return monthYm >= mDebut && monthYm <= mFin;
    });
  }
  
  // Trouver fin dernière mission pour intercontrat
  var lastMissionEnd = null;
  MISSIONS.forEach(function(m) { if (!lastMissionEnd || m.fin > lastMissionEnd) lastMissionEnd = m.fin; });
  var intercontratStartMonth = lastMissionEnd ? parseInt(lastMissionEnd.substring(5, 7)) : 1;
  
  var vacationDaysPerYear = scen.vacationWeeks * 5;
  var vacationDaysPerMonth = vacationDaysPerYear / 12;
  
  var results = [];
  var solde = data.solde;
  var acre = getAcreInfo();
  
  for (var m = 0; m < 12; m++) {
    var monthYm = ym(year, m);
    var joursOuvrables = daysBiz(year, m);
    
    // V45: Vérifier les missions actives pour ce mois
    var activeMissions = getMissionsForMonth(monthYm);
    var hasActiveMission = activeMissions.length > 0;
    
    // V45: Calculer TJM pondéré si plusieurs missions
    var monthTjm = tjm;
    if (hasActiveMission) {
      var weightedTjm = activeMissions.reduce(function(acc, m) { return acc + (m.tjm || tjm); }, 0) / activeMissions.length;
      monthTjm = Math.round(weightedTjm);
    }
    
    // Mois intercontrat? (après fin mission, pendant X mois)
    var isIntercontrat = false;
    if (!hasActiveMission && scen.intercontratMonths > 0 && lastMissionEnd) {
      var lastEndYm = lastMissionEnd.substring(0, 7);
      if (monthYm > lastEndYm) {
        var monthsAfterEnd = (year - parseInt(lastEndYm.substring(0, 4))) * 12 + (m - (parseInt(lastEndYm.substring(5, 7)) - 1));
        if (monthsAfterEnd >= 1 && monthsAfterEnd <= scen.intercontratMonths) isIntercontrat = true;
      }
    }
    
    // V45: Si pas de mission active ET après fin de dernière mission = intercontrat automatique
    if (!hasActiveMission && lastMissionEnd && monthYm > lastMissionEnd.substring(0, 7)) {
      isIntercontrat = true;
    }
    
    var joursEffectifs = isIntercontrat ? 0 : Math.round(joursOuvrables - vacationDaysPerMonth);
    joursEffectifs = Math.max(0, joursEffectifs);
    
    var ca = joursEffectifs * monthTjm;
    
    // CHARGES SEULEMENT SI CA > 0
    var charges = 0;
    if (ca > 0) {
      // Taux URSSAF dynamique selon ACRE et mois
      var urssafRate = getUrssafRate(monthYm);
      charges = Math.round(ca * (urssafRate + LEGAL.cfp + (COMPANY.prelevementLiberatoire ? LEGAL.impLib : 0)));
      if (isTVAApplicable(monthYm)) charges += Math.round(ca * LEGAL.tvaRate);
    }
    
    var net = ca - charges - salairesMensuels;
    solde += net;
    
    results.push({ 
      mois: monthYm, 
      label: fmtMonthShort(monthYm), 
      joursOuvrables: joursOuvrables, 
      joursEffectifs: joursEffectifs, 
      isIntercontrat: isIntercontrat, 
      hasActiveMission: hasActiveMission, // V45: nouveau flag
      activeMissionsCount: activeMissions.length, // V45: compteur missions
      ca: ca, 
      charges: charges, 
      salaire: salairesMensuels, 
      net: net, 
      solde: solde, 
      urssafRate: getUrssafRate(monthYm),
      monthTjm: monthTjm // V45: TJM effectif du mois
    });
  }
  
  var totalCA = results.reduce(function(acc, r) { return acc + r.ca; }, 0);
  var totalCharges = results.reduce(function(acc, r) { return acc + r.charges; }, 0);
  var soldeFinal = results[results.length - 1].solde;
  
  // V45: Calculer le nombre de mois avec mission active
  var monthsWithMission = results.filter(function(r) { return r.hasActiveMission; }).length;
  
  return { scenario: scen, year: year, tjm: tjm, salaireMensuel: salairesMensuels, results: results, totalCA: totalCA, totalCharges: totalCharges, soldeFinal: soldeFinal, runway: Math.max(0, Math.floor(soldeFinal / (totalCharges / 12 + salairesMensuels))), beneficeNet: totalCA - totalCharges - (salairesMensuels * 12), monthsWithMission: monthsWithMission };
}

// === MODALS ===

// V60: Détail cliquable pour chaque ligne de la composition du compte
// V68: Toggle bidirectionnel pour charges payées + meilleur contraste
function showCompteLineDetail(type) {
  var data = compute();
  var content = el('div', { style: { padding: '10px' } });
  var items = [];
  var title = '';
  var isCharges = type === 'charges';
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());

  if (type === 'encaissements') {
    title = '💵 Encaissements TTC';
    // Grouper par mois puis par client
    MISSIONS.forEach(function(mis) {
      if (!mis.factures) return;
      mis.factures.forEach(function(f) {
        if (f.status !== 'payée' || f.jours <= 0) return;
        var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
        items.push({ mois: paymentMonth, type: f.client, montant: f.ttc, sub: fmtMonthShort(f.mois) + ' · ' + f.jours + 'j × ' + EUR(mis.tjm) });
      });
    });
  } else if (isCharges) {
    title = '📋 Charges Payées';
    // V68: Collecter TOUTES les charges (payées et non payées) pour permettre toggle bidirectionnel
    MISSIONS.forEach(function(mis) {
      if (!mis.factures) return;
      mis.factures.forEach(function(f) {
        if (f.status !== 'payée' || f.jours <= 0) return;
        var pm = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
        if (pm > nowYm) return; // Seulement les charges échues
        var rate = getUrssafRate(pm);
        var urssafId = 'URSSAF-' + f.id;
        var cfpId = 'CFP-' + f.id;
        var tvaId = 'TVA-' + f.id;
        var implibId = 'IMPLIB-' + f.id;
        items.push({ id: urssafId, mois: pm, type: 'URSSAF', montant: Math.round(f.ht * rate), sub: mis.client, paid: isPaid(urssafId) });
        items.push({ id: cfpId, mois: pm, type: 'CFP', montant: Math.round(f.ht * LEGAL.cfp), sub: mis.client, paid: isPaid(cfpId) });
        if (f.tva > 0) items.push({ id: tvaId, mois: pm, type: 'TVA', montant: Math.round(f.tva), sub: mis.client, paid: isPaid(tvaId) });
        if (COMPANY.prelevementLiberatoire) items.push({ id: implibId, mois: pm, type: 'Impôt PL', montant: Math.round(f.ht * LEGAL.impLib), sub: mis.client, paid: isPaid(implibId) });
      });
    });
    // Charges manuelles
    TREASURY.mouvements.forEach(function(mv) {
      if (mv.type === 'Charge' && mv.mois <= nowYm) {
        items.push({ id: mv.id, mois: mv.mois, type: mv.categorie || 'Autre', montant: mv.montant, sub: mv.description || '', paid: isPaid(mv.id) });
      }
    });
  } else if (type === 'salaires') {
    title = '💸 Salaires Versés';
    TREASURY.mouvements.forEach(function(mv) {
      if (mv.type === 'Salaire') {
        items.push({ mois: mv.mois, type: 'Salaire', montant: mv.montant, sub: '' });
      }
    });
  }

  // Calculer totaux payés et non payés pour les charges
  var paidTotal = isCharges ? items.filter(function(i) { return i.paid; }).reduce(function(s, i) { return s + i.montant; }, 0) : 0;
  var unpaidTotal = isCharges ? items.filter(function(i) { return !i.paid; }).reduce(function(s, i) { return s + i.montant; }, 0) : 0;
  var total = items.reduce(function(s, i) { return s + i.montant; }, 0);

  // Header avec totaux
  if (isCharges) {
    var headerDiv = el('div', { style: { display: 'flex', gap: '12px', marginBottom: '16px' } });
    headerDiv.appendChild(el('div', { style: { flex: '1', background: 'rgba(34, 197, 94, 0.15)', padding: '14px', borderRadius: '8px', textAlign: 'center' } }, [
      el('div', { style: { fontSize: '10px', color: 'var(--success)', textTransform: 'uppercase', fontWeight: '600' } }, '✓ Payé'),
      el('div', { style: { fontSize: '22px', fontWeight: '800', color: 'var(--success)' } }, EUR(paidTotal))
    ]));
    headerDiv.appendChild(el('div', { style: { flex: '1', background: 'rgba(251, 191, 36, 0.15)', padding: '14px', borderRadius: '8px', textAlign: 'center' } }, [
      el('div', { style: { fontSize: '10px', color: 'var(--warning)', textTransform: 'uppercase', fontWeight: '600' } }, 'En provision'),
      el('div', { style: { fontSize: '22px', fontWeight: '800', color: 'var(--warning)' } }, EUR(unpaidTotal))
    ]));
    content.appendChild(headerDiv);
  } else {
    content.appendChild(el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '16px' } }, [
      el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, title),
      el('div', { style: { fontSize: '24px', fontWeight: '800' } }, EUR(total))
    ]));
  }

  // Grouper par mois
  var byMonth = {};
  items.forEach(function(it) {
    if (!byMonth[it.mois]) byMonth[it.mois] = [];
    byMonth[it.mois].push(it);
  });

  var sortedMonths = Object.keys(byMonth).sort().reverse();

  // Détail par mois
  var list = el('div', { style: { maxHeight: '350px', overflowY: 'auto' } });
  sortedMonths.forEach(function(mois) {
    var monthItems = byMonth[mois];
    var monthPaid = monthItems.filter(function(i) { return i.paid; }).reduce(function(s, i) { return s + i.montant; }, 0);
    var monthUnpaid = monthItems.filter(function(i) { return !i.paid; }).reduce(function(s, i) { return s + i.montant; }, 0);
    var monthTotal = monthItems.reduce(function(s, i) { return s + i.montant; }, 0);

    // Header mois avec meilleur contraste
    var monthHeader = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '12px', fontWeight: '700', color: 'var(--accent)', padding: '10px 8px 6px', borderBottom: '2px solid var(--accent)', marginTop: '8px' } });
    monthHeader.appendChild(el('span', {}, fmtMonth(mois)));
    if (isCharges) {
      monthHeader.appendChild(el('div', { style: { display: 'flex', gap: '8px', fontSize: '11px' } }, [
        monthPaid > 0 ? el('span', { style: { color: 'var(--success)' } }, '✓ ' + EUR(monthPaid)) : null,
        monthUnpaid > 0 ? el('span', { style: { color: 'var(--warning)' } }, EUR(monthUnpaid)) : null
      ].filter(Boolean)));
    } else {
      monthHeader.appendChild(el('span', {}, EUR(monthTotal)));
    }
    list.appendChild(monthHeader);

    // Grouper par type dans le mois
    var byType = {};
    monthItems.forEach(function(it) {
      var key = it.type + (isCharges && it.id ? '-' + it.id : '');
      if (!byType[key]) byType[key] = { type: it.type, montant: 0, subs: [], id: it.id, paid: it.paid };
      byType[key].montant += it.montant;
      if (it.sub && byType[key].subs.indexOf(it.sub) < 0) byType[key].subs.push(it.sub);
    });

    Object.keys(byType).forEach(function(k) {
      var entry = byType[k];
      var isPaidItem = entry.paid;

      if (isCharges) {
        // Affichage avec toggle pour les charges
        var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', padding: '8px 10px', margin: '4px 0', borderRadius: '6px', background: isPaidItem ? 'rgba(34, 197, 94, 0.1)' : 'rgba(251, 191, 36, 0.08)', border: isPaidItem ? '1px solid rgba(34, 197, 94, 0.3)' : '1px solid rgba(251, 191, 36, 0.2)' } });

        // Toggle checkbox
        row.appendChild(el('div', {
          style: { width: '22px', height: '22px', borderRadius: '5px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: '700', background: isPaidItem ? 'var(--success)' : 'transparent', border: isPaidItem ? 'none' : '2px solid var(--warning)', color: isPaidItem ? 'white' : 'var(--warning)' },
          title: isPaidItem ? 'Remettre en provision' : 'Marquer payé',
          onclick: function(e) {
            e.stopPropagation();
            TREASURY.paidCharges[entry.id] = !isPaidItem;
            saveAll();
            closeModal('formModal');
            showCompteLineDetail(type);
          }
        }, isPaidItem ? '✓' : ''));

        // Info
        var left = el('div', { style: { flex: '1' } });
        left.appendChild(el('span', { style: { fontWeight: '600', fontSize: '12px', color: isPaidItem ? 'var(--success)' : 'var(--text-primary)' } }, entry.type));
        if (entry.subs.length > 0) {
          left.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, entry.subs.slice(0, 2).join(', ') + (entry.subs.length > 2 ? ' +' + (entry.subs.length - 2) : '')));
        }
        row.appendChild(left);

        // Montant
        row.appendChild(el('span', { style: { fontWeight: '700', fontSize: '13px', color: isPaidItem ? 'var(--success)' : 'var(--text-primary)' } }, EUR(entry.montant)));

        list.appendChild(row);
      } else {
        // Affichage standard pour non-charges
        var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '6px 10px', fontSize: '12px', background: 'var(--bg-secondary)', borderRadius: '4px', margin: '3px 0' } });
        var left = el('div', {});
        left.appendChild(el('span', { style: { fontWeight: '600' } }, entry.type));
        if (entry.subs.length > 0 && entry.subs.length <= 3) {
          left.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, entry.subs.join(', ')));
        } else if (entry.subs.length > 3) {
          left.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, entry.subs.length + ' éléments'));
        }
        row.appendChild(left);
        row.appendChild(el('span', { style: { fontWeight: '600' } }, EUR(entry.montant)));
        list.appendChild(row);
      }
    });
  });
  content.appendChild(list);

  // Boutons d'action en masse pour les charges
  if (isCharges) {
    var paidIds = items.filter(function(i) { return i.paid; }).map(function(i) { return i.id; });
    var unpaidIds = items.filter(function(i) { return !i.paid; }).map(function(i) { return i.id; });

    if (paidIds.length > 0 || unpaidIds.length > 0) {
      var btnsDiv = el('div', { style: { display: 'flex', gap: '8px', marginTop: '16px' } });

      if (unpaidIds.length > 0) {
        btnsDiv.appendChild(el('button', {
          class: 'btn btn-success',
          style: { flex: '1', padding: '10px' },
          onclick: function() {
            unpaidIds.forEach(function(id) { TREASURY.paidCharges[id] = true; });
            saveAll();
            closeModal('formModal');
            showCompteLineDetail(type);
          }
        }, '✅ Tout payer (' + unpaidIds.length + ')'));
      }

      if (paidIds.length > 0) {
        btnsDiv.appendChild(el('button', {
          class: 'btn btn-warning',
          style: { flex: '1', padding: '10px' },
          onclick: function() {
            paidIds.forEach(function(id) { TREASURY.paidCharges[id] = false; });
            saveAll();
            closeModal('formModal');
            showCompteLineDetail(type);
          }
        }, '↩️ Tout en provision (' + paidIds.length + ')'));
      }

      content.appendChild(btnsDiv);
    }
  }

  if (sortedMonths.length === 0) {
    content.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '20px' } }, 'Aucun mouvement'));
  }

  showModal(title, content);
}

function showCashDetail() {
  var data = compute();
  $('#detailModalTitle').textContent = '💰 Trésorerie & Projections';
  var body = $('#detailModalBody');
  body.innerHTML = '';
  
  // Calculs préliminaires
  var tvaTotal = data.chargesDetail.find(function(c) { return c.cat === 'TVA'; });
  tvaTotal = tvaTotal ? tvaTotal.montant : 0;
  var tvaPaid = data.detailChargesPayees.filter(function(c) { return c.cat === 'TVA'; }).reduce(function(a, c) { return a + c.montant; }, 0);
  var tvaProv = data.detailChargesAPayer.filter(function(c) { return c.cat === 'TVA'; }).reduce(function(a, c) { return a + c.montant; }, 0);
  var irPaid = data.detailChargesPayees.filter(function(c) { return c.cat.indexOf('Impôt') >= 0; }).reduce(function(a, c) { return a + c.montant; }, 0);
  var irProv = data.detailChargesAPayer.filter(function(c) { return c.cat.indexOf('Impôt') >= 0; }).reduce(function(a, c) { return a + c.montant; }, 0);
  
  var caHT = data.caEnc - tvaTotal;
  
  // Grouper charges par catégorie avec items détaillés
  var chargesByCat = {};
  data.detailChargesPayees.concat(data.detailChargesAPayer).forEach(function(c) {
    var cat = c.cat.replace(' PL', '');
    if (!chargesByCat[cat]) chargesByCat[cat] = { total: 0, items: [] };
    chargesByCat[cat].total += c.montant;
    chargesByCat[cat].items.push(c);
  });
  
  // Section trésorerie
  var section1 = el('div', { style: { marginBottom: '24px' } });
  section1.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', marginBottom: '12px', textTransform: 'uppercase' } }, '📊 Situation Actuelle'));
  
  var calc = el('div', { style: { background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', padding: '20px' } });
  
  // Helper pour ligne
  function row(label, value, color, isMain, indent, onClick) {
    var style = { 
      display: 'flex', justifyContent: 'space-between', alignItems: 'center',
      padding: isMain ? '12px 14px' : '8px 14px',
      marginLeft: indent ? '16px' : '0',
      background: isMain ? 'var(--bg-tertiary)' : 'transparent',
      borderRadius: isMain ? 'var(--radius-sm)' : '0',
      marginBottom: '6px',
      cursor: onClick ? 'pointer' : 'default'
    };
    var r = el('div', { style: style, onclick: onClick || null });
    r.appendChild(el('span', { style: { fontSize: isMain ? '13px' : '12px', fontWeight: isMain ? '600' : '400', color: indent ? 'var(--text-muted)' : 'inherit' } }, label));
    r.appendChild(el('span', { style: { fontSize: isMain ? '15px' : '12px', fontWeight: isMain ? '700' : '600', color: color } }, value));
    if (onClick) r.classList.add('clickable');
    return r;
  }
  
  // Cash dispo début de période (= fin période précédente)
  calc.appendChild(row('💰 Cash dispo début période', EUR(data.cashDispoDebut), 'inherit', false));
  if (data.provisionsReport > 0) {
    calc.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginLeft: '14px', marginBottom: '8px' } }, '(Solde: ' + EUR(data.soldeDebut) + ' - Provisions reportées: ' + EUR(data.provisionsReport) + ')'));
  }
  calc.appendChild(el('div', { style: { height: '8px' } }));
  
  // CA TTC → HT
  calc.appendChild(row('💵 CA Encaissé TTC', '+ ' + EUR(data.caEnc), 'var(--success)', true, false, function() { closeModal('detailModal'); showDetailList('Factures Encaissées', data.detailEncaisse, 'success', function(i) { return i.client + ' · ' + fmtMonthShort(i.mois); }); }));
  if (tvaTotal > 0) {
    calc.appendChild(row('↳ TVA collectée', '- ' + EUR(tvaTotal), '#f472b6', false, true));
    if (data.tvaDeductible > 0) {
      calc.appendChild(row('↳ TVA déductible (achats)', '+ ' + EUR(data.tvaDeductible), '#34d399', false, true));
      calc.appendChild(row('↳ TVA nette à reverser', EUR(data.tvaNette), '#f472b6', false, true));
    }
  }
  calc.appendChild(row('= CA HT', EUR(caHT), 'var(--info)', true));
  
  calc.appendChild(el('div', { style: { height: '12px' } }));
  calc.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '8px' } }, 'Charges payées (cliquer pour détail)'));
  
  // Charges payées - triées décroissant, cliquables
  var sortedCats = Object.keys(chargesByCat).filter(function(cat) { return cat !== 'TVA' && cat !== 'Impôt'; }).map(function(cat) {
    var paidItems = chargesByCat[cat].items.filter(function(i) { return !i.id || isPaid(i.id); });
    var paidTotal = paidItems.reduce(function(a, c) { return a + c.montant; }, 0);
    return { cat: cat, total: paidTotal, items: paidItems };
  }).filter(function(c) { return c.total > 0; }).sort(function(a, b) { return b.total - a.total; });
  
  sortedCats.forEach(function(item) {
    var pct = caHT > 0 ? item.total / caHT : 0;
    var color = getChargeColor(item.cat);
    calc.appendChild(row('📋 ' + item.cat + ' (' + PCT(pct) + ')', '- ' + EUR(item.total), color, false, false, function() { closeModal('detailModal'); showChargeTypeDetail(item.cat, item.items, color); }));
  });
  
  // Salaires
  if (data.salaires > 0) {
    var salPct = caHT > 0 ? data.salaires / caHT : 0;
    calc.appendChild(row('💸 Salaires (' + PCT(salPct) + ')', '- ' + EUR(data.salaires), 'var(--info)', false, false, function() { closeModal('detailModal'); showDetailList('Salaires Versés', data.detailSalaires, 'info', function(i) { return fmtMonth(i.mois); }); }));
  }
  
  // SOLDE COMPTE (ABSOLU) - BASE 100%
  calc.appendChild(el('div', { style: { height: '12px' } }));
  calc.appendChild(el('div', { style: { background: 'var(--bg-tertiary)', padding: '14px', borderRadius: 'var(--radius-md)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
    el('span', { style: { fontWeight: '700', fontSize: '14px' } }, '= SOLDE COMPTE (100%)'),
    el('span', { style: { fontWeight: '800', fontSize: '18px', color: data.soldeAbsolu >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(data.soldeAbsolu))
  ]));
  
  // Provisions (ABSOLUES - toutes les charges non payées, indépendant du filtre)
  calc.appendChild(el('div', { style: { height: '12px' } }));
  calc.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '8px' } }, 'À provisionner (cliquer pour détail)'));
  
  // Utiliser les provisions ABSOLUES (data.allProvisionsDetail) - pas filtrées par période
  var allTvaPItems = data.allProvisionsDetail.filter(function(c) { return c.cat === 'TVA'; });
  var allIrPItems = data.allProvisionsDetail.filter(function(c) { return c.cat.indexOf('Impôt') >= 0 || c.cat.indexOf('IR') >= 0; });
  var allAutresPItems = data.allProvisionsDetail.filter(function(c) { return c.cat !== 'TVA' && c.cat.indexOf('Impôt') < 0 && c.cat.indexOf('IR') < 0; });
  
  var allTvaProv = allTvaPItems.reduce(function(a, c) { return a + c.montant; }, 0);
  var allIrProv = allIrPItems.reduce(function(a, c) { return a + c.montant; }, 0);
  
  // Helper pour calculer le % par rapport au solde compte
  var pctOfSolde = function(montant) {
    return data.soldeAbsolu > 0 ? ' (' + PCT(montant / data.soldeAbsolu) + ')' : '';
  };
  
  if (allTvaProv > 0) {
    var tvaNetProv = Math.max(0, allTvaProv - (data.tvaDeductible || 0));
    var tvaLabel = data.tvaDeductible > 0 ? '📦 TVA nette à reverser' + pctOfSolde(tvaNetProv) : '📦 TVA à reverser' + pctOfSolde(allTvaProv);
    var tvaMontant = data.tvaDeductible > 0 ? tvaNetProv : allTvaProv;
    calc.appendChild(row(tvaLabel, '- ' + EUR(tvaMontant), '#f472b6', false, false, function() { showProvisionTypeDetail('TVA', allTvaPItems, '#f472b6'); }));
    if (data.tvaDeductible > 0) {
      calc.appendChild(row('  ↳ Collectée: ' + EUR(allTvaProv) + ' - Déductible: ' + EUR(data.tvaDeductible), '', '#a78bfa', false, true));
    }
  }
  if (allIrProv > 0) calc.appendChild(row('📦 IR à payer' + pctOfSolde(allIrProv), '- ' + EUR(allIrProv), '#fbbf24', false, false, function() { showProvisionTypeDetail('IR', allIrPItems, '#fbbf24'); }));
  
  // Autres provisions groupées par catégorie
  var allAutresProvByCat = {};
  allAutresPItems.forEach(function(c) { allAutresProvByCat[c.cat] = (allAutresProvByCat[c.cat] || 0) + c.montant; });
  Object.keys(allAutresProvByCat).sort(function(a, b) { return allAutresProvByCat[b] - allAutresProvByCat[a]; }).forEach(function(cat) {
    var items = allAutresPItems.filter(function(c) { return c.cat === cat; });
    var montant = allAutresProvByCat[cat];
    calc.appendChild(row('📦 ' + cat + pctOfSolde(montant), '- ' + EUR(montant), 'var(--provision)', false, false, function() { showProvisionTypeDetail(cat, items, 'var(--provision)'); }));
  });
  
  // Total provisions avec pourcentage
  var totalProvPct = data.soldeAbsolu > 0 ? PCT(data.provisionsAbsolues / data.soldeAbsolu) : '0%';
  calc.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 14px', marginTop: '8px', background: 'rgba(168,85,247,0.1)', borderRadius: 'var(--radius-sm)' } }, [
    el('span', { style: { fontSize: '11px', color: 'var(--provision)', fontWeight: '600' } }, '= TOTAL PROVISIONS (' + totalProvPct + ')'),
    el('span', { style: { fontSize: '14px', fontWeight: '700', color: 'var(--provision)' } }, EUR(data.provisionsAbsolues))
  ]));
  
  // CASH DISPONIBLE (ABSOLU) avec pourcentage
  var cashDispoPct = data.soldeAbsolu > 0 ? PCT(data.cashDispoAbsolu / data.soldeAbsolu) : '0%';
  calc.appendChild(el('div', { style: { height: '12px' } }));
  calc.appendChild(el('div', { style: { background: data.cashDispoAbsolu >= 0 ? 'var(--success-glow)' : 'var(--danger-glow)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '4px' } }, 'CASH DISPONIBLE (' + cashDispoPct + ' du solde)'),
    el('div', { style: { fontWeight: '800', fontSize: '24px', color: data.cashDispoAbsolu >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(data.cashDispoAbsolu)),
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '6px' } }, '💡 Autonomie: ' + data.runway + ' mois')
  ]));
  
  section1.appendChild(calc);
  body.appendChild(section1);
  
  // Projections
  var section2 = el('div');
  section2.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', marginBottom: '12px', textTransform: 'uppercase' } }, '🔮 Projections Annuelles'));
  
  var projYear = TODAY.getMonth() >= 6 ? TODAY.getFullYear() + 1 : TODAY.getFullYear();
  var defaultTJM = MISSIONS.length > 0 ? MISSIONS[0].tjm : 400;
  var defaultSalaire = data.salaireMoyen || 2500;
  
  var paramsDiv = el('div', { class: 'projection-params' });
  paramsDiv.appendChild(el('div', { class: 'projection-param' }, [el('label', {}, 'Année'), el('input', { type: 'number', id: 'projYear', value: projYear })]));
  paramsDiv.appendChild(el('div', { class: 'projection-param' }, [el('label', {}, 'TJM (€)'), el('input', { type: 'number', id: 'projTJM', value: defaultTJM })]));
  paramsDiv.appendChild(el('div', { class: 'projection-param' }, [el('label', {}, 'Salaire/mois'), el('input', { type: 'number', id: 'projSalaire', value: defaultSalaire })]));
  paramsDiv.appendChild(el('div', { class: 'projection-param', style: { alignItems: 'flex-end' } }, [el('button', { class: 'btn btn-sm btn-success', onclick: updateProjections }, '🔄 Calculer')]));
  section2.appendChild(paramsDiv);
  
  var tabs = el('div', { class: 'projection-tabs', id: 'projTabs' });
  Object.keys(SCENARIOS).forEach(function(key) {
    var s = SCENARIOS[key];
    var tab = el('div', { class: 'projection-tab' + (PROJECTION_SCENARIO === key ? ' active' : ''), 'data-scenario': key, onclick: function() { PROJECTION_SCENARIO = key; $$('.projection-tab').forEach(function(t) { t.classList.remove('active'); }); this.classList.add('active'); updateProjections(); } });
    tab.appendChild(el('div', { class: 'projection-tab-icon' }, s.icon));
    tab.appendChild(el('div', { class: 'projection-tab-label' }, s.label));
    tab.appendChild(el('div', { class: 'projection-tab-desc' }, s.desc));
    tabs.appendChild(tab);
  });
  section2.appendChild(tabs);
  section2.appendChild(el('div', { id: 'projResults' }));
  section2.appendChild(el('div', { class: 'projection-chart' }, [el('canvas', { id: 'projChart' })]));
  body.appendChild(section2);
  
  openModal('detailModal');
  setTimeout(updateProjections, 100);
}

// Afficher détail d'un type de charge
function showChargeTypeDetail(typeName, items, color) {
  var total = items.reduce(function(a, c) { return a + c.montant; }, 0);
  $('#formModalTitle').textContent = '📋 ' + typeName + ' payé';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  body.appendChild(el('div', { style: { background: 'var(--bg-tertiary)', padding: '14px', borderRadius: 'var(--radius-md)', marginBottom: '16px', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Total ' + typeName),
    el('div', { style: { fontWeight: '800', fontSize: '20px', color: color } }, EUR(total))
  ]));
  
  if (items.length > 0) {
    items.sort(function(a, b) { return b.montant - a.montant; });
    items.forEach(function(item) {
      body.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-sm)', marginBottom: '6px' } }, [
        el('div', {}, [
          el('div', { style: { fontSize: '12px', fontWeight: '500' } }, item.source || typeName),
          el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, fmtMonth(item.mois))
        ]),
        el('span', { style: { fontWeight: '600', color: color } }, EUR(item.montant))
      ]));
    });
  } else {
    body.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '20px' } }, 'Aucune charge'));
  }
  
  openModal('formModal');
}

function updateProjections() {
  var params = { year: parseInt($('#projYear').value) || TODAY.getFullYear(), tjm: parseInt($('#projTJM').value) || 400, salaireMensuel: parseInt($('#projSalaire').value) || 2500 };
  var proj = computeProjections(PROJECTION_SCENARIO, params);
  var resultsDiv = $('#projResults');
  resultsDiv.innerHTML = '';
  
  var resultBox = el('div', { class: 'projection-result' });
  var acre = getAcreInfo();
  var acreNote = acre.active ? 'ACRE jusqu\'à ' + fmtMonthShort(acre.expiryYm) : 'Sans ACRE';
  // V45: Ajouter info missions actives
  var missionNote = proj.monthsWithMission > 0 ? ' · ' + proj.monthsWithMission + ' mois avec mission' : ' · Aucune mission confirmée';
  resultBox.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px' } }, proj.scenario.icon + ' ' + proj.scenario.label + ' · ' + proj.year + ' · ' + acreNote + missionNote));
  
  var metrics = el('div', { class: 'projection-metrics' });
  metrics.appendChild(el('div', { class: 'projection-metric' }, [el('div', { class: 'projection-metric-value', style: { color: proj.soldeFinal >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(proj.soldeFinal)), el('div', { class: 'projection-metric-label' }, 'Solde fin ' + proj.year)]));
  metrics.appendChild(el('div', { class: 'projection-metric' }, [el('div', { class: 'projection-metric-value text-info' }, proj.runway + ' mois'), el('div', { class: 'projection-metric-label' }, 'Autonomie')]));
  metrics.appendChild(el('div', { class: 'projection-metric' }, [el('div', { class: 'projection-metric-value text-success' }, EUR(proj.totalCA)), el('div', { class: 'projection-metric-label' }, 'CA Total')]));
  resultBox.appendChild(metrics);
  resultsDiv.appendChild(resultBox);
  
  var canvas = $('#projChart');
  if (canvas) {
    var ctx = canvas.getContext('2d');
    if (projectionChart) projectionChart.destroy();
    // V45: Couleurs différentes selon mission active ou non
    projectionChart = new Chart(ctx, {
      type: 'line',
      data: { labels: proj.results.map(function(r) { return r.label + (r.isIntercontrat ? ' 🔍' : r.hasActiveMission ? ' ✓' : ''); }), datasets: [{ label: 'Solde', data: proj.results.map(function(r) { return r.solde; }), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: proj.results.map(function(r) { return r.isIntercontrat ? '#f59e0b' : r.hasActiveMission ? '#10b981' : '#6b7280'; }) }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#71717a', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#71717a', font: { size: 10 }, callback: function(v) { return v >= 1000 ? (v/1000) + 'k€' : v + '€'; } }, grid: { color: 'rgba(255,255,255,0.04)' } } } }
    });
  }
}

function showProvisionTypeDetail(typeName, passedItems, color) {
  // V68: Utiliser getAllChargesForType pour avoir TOUS les items (payés et non payés)
  var allItems = getAllChargesForType(typeName);

  // Calculer totaux payés et non payés
  var unpaidTotal = 0;
  var paidTotal = 0;
  allItems.forEach(function(item) {
    if (isPaid(item.id)) {
      paidTotal += item.montant;
    } else {
      unpaidTotal += item.montant;
    }
  });

  $('#formModalTitle').textContent = '📦 ' + typeName;
  var body = $('#formModalBody');
  body.innerHTML = '';

  // Bouton retour
  body.appendChild(el('button', { class: 'btn btn-sm', style: { marginBottom: '12px' }, onclick: function() { closeModal('formModal'); render(); } }, '← Retour'));

  // Total header avec deux sections
  var headerDiv = el('div', { style: { display: 'flex', gap: '12px', marginBottom: '16px' } });

  // À provisionner
  headerDiv.appendChild(el('div', { style: { flex: '1', background: 'var(--bg-tertiary)', padding: '14px', borderRadius: 'var(--radius-md)', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'À provisionner'),
    el('div', { style: { fontWeight: '800', fontSize: '20px', color: color } }, EUR(unpaidTotal))
  ]));

  // Déjà payé
  headerDiv.appendChild(el('div', { style: { flex: '1', background: 'rgba(34, 197, 94, 0.1)', padding: '14px', borderRadius: 'var(--radius-md)', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--success)', textTransform: 'uppercase' } }, 'Déjà payé'),
    el('div', { style: { fontWeight: '800', fontSize: '20px', color: 'var(--success)' } }, EUR(paidTotal))
  ]));

  body.appendChild(headerDiv);

  // Grouper par année
  var byYear = {};
  allItems.forEach(function(item) {
    var year = item.mois ? item.mois.substring(0, 4) : 'Autre';
    if (!byYear[year]) byYear[year] = [];
    byYear[year].push(item);
  });

  // Afficher par année (triées décroissant)
  var years = Object.keys(byYear).sort(function(a, b) { return b.localeCompare(a); });

  var listContainer = el('div', { style: { maxHeight: '350px', overflowY: 'auto' } });

  years.forEach(function(year) {
    var yearItems = byYear[year];
    var yearUnpaid = yearItems.filter(function(i) { return !isPaid(i.id); }).reduce(function(a, c) { return a + c.montant; }, 0);
    var yearPaid = yearItems.filter(function(i) { return isPaid(i.id); }).reduce(function(a, c) { return a + c.montant; }, 0);

    // Header année
    listContainer.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 14px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-sm)', marginTop: '12px', marginBottom: '8px' } }, [
      el('span', { style: { fontWeight: '700', fontSize: '13px' } }, '📅 ' + year),
      el('div', { style: { display: 'flex', gap: '12px' } }, [
        yearUnpaid > 0 ? el('span', { style: { fontWeight: '600', fontSize: '12px', color: color } }, EUR(yearUnpaid) + ' à payer') : null,
        yearPaid > 0 ? el('span', { style: { fontWeight: '600', fontSize: '12px', color: 'var(--success)' } }, '✓ ' + EUR(yearPaid)) : null
      ].filter(Boolean))
    ]));

    // Items de cette année - triés: non payés d'abord, puis payés
    yearItems.sort(function(a, b) {
      var aPaid = isPaid(a.id) ? 1 : 0;
      var bPaid = isPaid(b.id) ? 1 : 0;
      if (aPaid !== bPaid) return aPaid - bPaid;
      return b.montant - a.montant;
    });

    yearItems.forEach(function(item) {
      var paid = isPaid(item.id);
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: paid ? 'rgba(34, 197, 94, 0.08)' : 'var(--bg-secondary)', borderRadius: 'var(--radius-sm)', marginBottom: '6px', marginLeft: '12px', border: paid ? '1px solid rgba(34, 197, 94, 0.2)' : '1px solid transparent' } });

      // Checkbox toggle payé (bidirectionnel: payé ↔ provisionné)
      row.appendChild(el('div', {
        class: 'toggle-check ' + (paid ? 'paid' : ''),
        style: { width: '24px', height: '24px', fontSize: '14px', flexShrink: '0', cursor: 'pointer', background: paid ? 'var(--success)' : 'var(--bg-tertiary)', borderRadius: '6px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: paid ? 'white' : 'var(--text-muted)', border: paid ? 'none' : '2px solid var(--border)' },
        title: paid ? 'Remettre en provision' : 'Marquer payé',
        onclick: function(e) {
          e.stopPropagation();
          TREASURY.paidCharges[item.id] = !isPaid(item.id);
          saveAll();
          showProvisionTypeDetail(typeName, null, color);
        }
      }, paid ? '✓' : ''));

      // Info
      row.appendChild(el('div', { style: { flex: '1' } }, [
        el('div', { style: { fontSize: '13px', fontWeight: '600', color: paid ? 'var(--success)' : 'var(--text-primary)', textDecoration: paid ? 'line-through' : 'none' } }, item.source || item.desc || typeName),
        el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, fmtMonth(item.mois))
      ]));

      // Montant
      row.appendChild(el('span', { style: { fontWeight: '700', fontSize: '14px', color: paid ? 'var(--success)' : 'var(--text-primary)' } }, EUR(item.montant)));

      // Boutons d'action
      var actions = el('div', { style: { display: 'flex', gap: '4px' } });

      // Vérifier si c'est un mouvement manuel (éditable/supprimable)
      var isManualMovement = item.id && (item.id.startsWith('CH') || item.id.startsWith('SAL'));

      // Bouton éditer (seulement pour mouvements manuels)
      if (isManualMovement) {
        actions.appendChild(el('button', {
          class: 'btn btn-sm',
          style: { padding: '4px 8px', fontSize: '11px' },
          title: 'Modifier',
          onclick: function(e) { e.stopPropagation(); closeModal('formModal'); editMovement(item.id); }
        }, '✏️'));
      }

      // Bouton supprimer (seulement pour mouvements manuels)
      if (isManualMovement) {
        actions.appendChild(el('button', {
          class: 'btn btn-sm btn-danger',
          style: { padding: '4px 8px', fontSize: '11px' },
          title: 'Supprimer',
          onclick: function(e) {
            e.stopPropagation();
            if (confirm('Supprimer cet élément ?')) {
              deleteMovement(item.id);
              closeModal('formModal');
              render();
            }
          }
        }, '🗑️'));
      }

      row.appendChild(actions);
      listContainer.appendChild(row);
    });
  });

  body.appendChild(listContainer);

  // Boutons d'action en masse
  var btnsDiv = el('div', { style: { display: 'flex', gap: '8px', marginTop: '16px' } });

  var unpaidIds = allItems.filter(function(i) { return !isPaid(i.id); }).map(function(i) { return i.id; });
  var paidIds = allItems.filter(function(i) { return isPaid(i.id); }).map(function(i) { return i.id; });

  if (unpaidIds.length > 0) {
    btnsDiv.appendChild(el('button', {
      class: 'btn btn-success',
      style: { flex: '1' },
      onclick: function() {
        unpaidIds.forEach(function(id) { TREASURY.paidCharges[id] = true; });
        saveAll();
        showProvisionTypeDetail(typeName, null, color);
      }
    }, '✅ Tout payer (' + unpaidIds.length + ')'));
  }

  if (paidIds.length > 0) {
    btnsDiv.appendChild(el('button', {
      class: 'btn btn-warning',
      style: { flex: '1' },
      onclick: function() {
        paidIds.forEach(function(id) { TREASURY.paidCharges[id] = false; });
        saveAll();
        showProvisionTypeDetail(typeName, null, color);
      }
    }, '↩️ Remettre en provision (' + paidIds.length + ')'));
  }

  if (unpaidIds.length > 0 || paidIds.length > 0) {
    body.appendChild(btnsDiv);
  }

  if (allItems.length === 0) {
    body.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '20px' } }, 'Aucun élément'));
  }

  openModal('formModal');
}

// Afficher provisions d'un mois spécifique
function showProvisionMonthDetail(monthKey) {
  var data = compute();
  var items = data.detailChargesAPayer.filter(function(c) { return c.mois === monthKey; });
  var total = items.reduce(function(a, c) { return a + c.montant; }, 0);
  
  $('#formModalTitle').textContent = '📦 Provisions ' + fmtMonth(monthKey);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Bouton retour
  body.appendChild(el('button', { class: 'btn btn-sm', style: { marginBottom: '12px' }, onclick: function() { closeModal('formModal'); showProvisionsDetail(); } }, '← Retour'));
  
  // Total
  body.appendChild(el('div', { style: { background: 'var(--bg-tertiary)', padding: '14px', borderRadius: 'var(--radius-md)', marginBottom: '16px', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Total ' + fmtMonth(monthKey)),
    el('div', { style: { fontWeight: '800', fontSize: '22px', color: 'var(--provision)' } }, EUR(total))
  ]));
  
  // Liste des items avec checkbox et couleurs par type
  if (items.length > 0) {
    items.sort(function(a, b) { return b.montant - a.montant; });
    items.forEach(function(item) {
      var paid = isPaid(item.id);
      var color = getChargeColor(item.cat);
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-sm)', marginBottom: '8px', cursor: 'pointer' }, onclick: function() { togglePaid(item.id); showProvisionMonthDetail(monthKey); } });
      row.appendChild(el('div', { class: 'toggle-check ' + (paid ? 'paid' : ''), style: { width: '22px', height: '22px', fontSize: '13px', flexShrink: '0' } }, paid ? '✓' : ''));
      row.appendChild(el('div', { style: { flex: '1' } }, [
        el('div', { style: { fontSize: '13px', fontWeight: '600', color: paid ? 'var(--text-muted)' : color, textDecoration: paid ? 'line-through' : 'none' } }, item.cat),
        el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, item.source || item.desc || '')
      ]));
      row.appendChild(el('span', { style: { fontWeight: '700', fontSize: '14px', color: paid ? 'var(--success)' : color } }, EUR(item.montant)));
      body.appendChild(row);
    });
    
    var unpaidIds = items.filter(function(i) { return !isPaid(i.id); }).map(function(i) { return i.id; });
    if (unpaidIds.length > 0) {
      body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '16px' }, onclick: function() { markAllPaid(unpaidIds); closeModal('formModal'); } }, '✅ Tout marquer payé'));
    }
  } else {
    body.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '20px' } }, 'Tout est payé ! 🎉'));
  }
  
  openModal('formModal');
}

// Helper pour couleur par type de charge
function getChargeColor(cat) {
  if (cat === 'TVA') return '#f472b6';
  if (cat.indexOf('Impôt') >= 0 || cat.indexOf('IR') >= 0) return '#fbbf24';
  if (cat === 'URSSAF') return 'var(--danger)';
  if (cat === 'CFP') return 'var(--danger)';
  return 'var(--danger)';
}

function showProvisionsDetail() {
  var data = compute();
  $('#formModalTitle').textContent = '📦 Provisions à Payer';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Total global
  var grandTotal = data.provisions;
  body.appendChild(el('div', { style: { background: 'var(--provision-glow)', padding: '16px', borderRadius: 'var(--radius-md)', marginBottom: '20px', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'Total à provisionner'),
    el('div', { style: { fontWeight: '800', fontSize: '28px', color: 'var(--provision)' } }, EUR(grandTotal))
  ]));
  
  // Tabs Par Type / Par Mois
  var tabs = el('div', { class: 'filter-tabs', style: { marginBottom: '16px' } });
  tabs.appendChild(el('button', { class: 'filter-tab' + (PROV_VIEW === 'type' ? ' active' : ''), onclick: function() { PROV_VIEW = 'type'; showProvisionsDetail(); } }, '📋 Par Type'));
  tabs.appendChild(el('button', { class: 'filter-tab' + (PROV_VIEW === 'month' ? ' active' : ''), onclick: function() { PROV_VIEW = 'month'; showProvisionsDetail(); } }, '📅 Par Mois'));
  body.appendChild(tabs);
  
  if (PROV_VIEW === 'type') {
    // Grouper par type avec clic pour voir détail
    var types = [
      { key: 'TVA', label: 'TVA', color: '#f472b6', icon: '🏛️' },
      { key: 'URSSAF', label: 'URSSAF', color: 'var(--danger)', icon: '🏥' },
      { key: 'CFP', label: 'CFP', color: 'var(--danger)', icon: '📚' },
      { key: 'Impôt', label: 'Impôt / IR', color: '#fbbf24', icon: '💰' }
    ];
    
    types.forEach(function(t) {
      var items = data.detailChargesAPayer.filter(function(c) { 
        if (t.key === 'Impôt') return c.cat.indexOf('Impôt') >= 0 || c.cat.indexOf('IR') >= 0;
        return c.cat === t.key; 
      });
      if (items.length === 0) return;
      
      var montant = items.reduce(function(a, c) { return a + c.montant; }, 0);
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '14px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)', marginBottom: '10px', cursor: 'pointer' }, onclick: function() { showProvisionTypeDetail(t.label, items, t.color); } });
      row.appendChild(el('div', { style: { fontSize: '20px' } }, t.icon));
      row.appendChild(el('div', { style: { flex: '1' } }, [
        el('div', { style: { fontSize: '14px', fontWeight: '600', color: t.color } }, t.label),
        el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, items.length + ' élément' + (items.length > 1 ? 's' : ''))
      ]));
      row.appendChild(el('div', { style: { textAlign: 'right' } }, [
        el('div', { style: { fontWeight: '800', fontSize: '16px', color: t.color } }, EUR(montant)),
        el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, '→ Détail')
      ]));
      body.appendChild(row);
    });
    
    // Autres charges (RC Pro, Mutuelle, etc.)
    var autresItems = data.detailChargesAPayer.filter(function(c) { 
      return c.cat !== 'TVA' && c.cat !== 'URSSAF' && c.cat !== 'CFP' && c.cat.indexOf('Impôt') < 0 && c.cat.indexOf('IR') < 0;
    });
    if (autresItems.length > 0) {
      var autreMontant = autresItems.reduce(function(a, c) { return a + c.montant; }, 0);
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '14px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)', marginBottom: '10px', cursor: 'pointer' }, onclick: function() { showProvisionTypeDetail('Autres charges', autresItems, 'var(--warning)'); } });
      row.appendChild(el('div', { style: { fontSize: '20px' } }, '📋'));
      row.appendChild(el('div', { style: { flex: '1' } }, [
        el('div', { style: { fontSize: '14px', fontWeight: '600', color: 'var(--warning)' } }, 'Autres charges'),
        el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, autresItems.length + ' élément' + (autresItems.length > 1 ? 's' : ''))
      ]));
      row.appendChild(el('div', { style: { textAlign: 'right' } }, [
        el('div', { style: { fontWeight: '800', fontSize: '16px', color: 'var(--warning)' } }, EUR(autreMontant)),
        el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, '→ Détail')
      ]));
      body.appendChild(row);
    }
    
  } else {
    // Grouper par mois avec clic pour voir détail
    var months = Object.keys(data.provByMonth).filter(function(m) { return data.provByMonth[m] > 0; }).sort();
    months.forEach(function(m) {
      var montant = data.provByMonth[m];
      var items = data.detailChargesAPayer.filter(function(c) { return c.mois === m; });
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '14px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)', marginBottom: '10px', cursor: 'pointer' }, onclick: function() { showProvisionMonthDetail(m); } });
      row.appendChild(el('div', { style: { fontSize: '20px' } }, '📅'));
      row.appendChild(el('div', { style: { flex: '1' } }, [
        el('div', { style: { fontSize: '14px', fontWeight: '600' } }, fmtMonth(m)),
        el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, items.length + ' charge' + (items.length > 1 ? 's' : ''))
      ]));
      row.appendChild(el('div', { style: { textAlign: 'right' } }, [
        el('div', { style: { fontWeight: '800', fontSize: '16px', color: 'var(--provision)' } }, EUR(montant)),
        el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, '→ Détail')
      ]));
      body.appendChild(row);
    });
  }
  
  // Boutons rapides
  if (grandTotal > 0) {
    body.appendChild(el('div', { style: { marginTop: '20px', paddingTop: '16px', borderTop: '1px solid var(--glass-border)' } }));
    body.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '10px' } }, '⚡ Actions rapides'));
    var btns = el('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } });
    
    if (data.provByType['URSSAF']) {
      var ids = data.detailChargesAPayer.filter(function(c) { return c.cat === 'URSSAF'; }).map(function(c) { return c.id; });
      btns.appendChild(el('button', { class: 'btn btn-sm', style: { background: 'var(--danger)', color: 'white' }, onclick: function() { markAllPaid(ids); closeModal('formModal'); } }, '✅ URSSAF'));
    }
    if (data.provByType['TVA']) {
      var ids2 = data.detailChargesAPayer.filter(function(c) { return c.cat === 'TVA'; }).map(function(c) { return c.id; });
      btns.appendChild(el('button', { class: 'btn btn-sm', style: { background: '#f472b6', color: 'white' }, onclick: function() { markAllPaid(ids2); closeModal('formModal'); } }, '✅ TVA'));
    }
    if (data.provByType['Impôt'] || data.provByType['Impôt PL'] || data.provByType['IR Estimé']) {
      var ids3 = data.detailChargesAPayer.filter(function(c) { return c.cat.indexOf('Impôt') >= 0 || c.cat.indexOf('IR') >= 0; }).map(function(c) { return c.id; });
      btns.appendChild(el('button', { class: 'btn btn-sm', style: { background: '#fbbf24', color: 'black' }, onclick: function() { markAllPaid(ids3); closeModal('formModal'); } }, '✅ Impôts'));
    }
    body.appendChild(btns);
  }
  
  openModal('formModal');
}

function showDetailList(title, items, colorType, labelFn) {
  $('#formModalTitle').textContent = title;
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  if (!items || items.length === 0) {
    body.appendChild(el('div', { style: { textAlign: 'center', padding: '24px', color: 'var(--text-muted)' } }, 'Aucun élément'));
    openModal('formModal');
    return;
  }
  
  var total = 0;
  items.forEach(function(item) {
    var row = el('div', { class: 'detail-row' });
    var label = labelFn ? labelFn(item) : (item.cat || item.client || 'Item');
    if (item.mois && !labelFn) label += ' · ' + fmtMonthShort(item.mois);
    row.appendChild(el('span', {}, label));
    row.appendChild(el('span', { class: 'text-' + colorType, style: { fontWeight: '600' } }, EUR(item.montant)));
    body.appendChild(row);
    total += item.montant;
  });
  
  body.appendChild(el('div', { class: 'detail-separator' }));
  body.appendChild(el('div', { class: 'detail-row' }, [el('span', { style: { fontWeight: '700' } }, 'TOTAL'), el('span', { class: 'text-' + colorType, style: { fontWeight: '800' } }, EUR(total))]));
  
  openModal('formModal');
}

// V49: Configuration ET visualisation du rendement - accessible depuis le dashboard
function showRendementConfig() {
  $('#formModalTitle').textContent = '📈 Rendement Compte Pro';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // === Section Configuration ===
  var configSection = el('div', { style: { background: 'var(--bg-tertiary)', padding: '16px', borderRadius: '10px', marginBottom: '16px' } });
  configSection.appendChild(el('div', { style: { fontSize: '12px', fontWeight: '700', marginBottom: '12px' } }, '⚙️ Configuration'));
  
  // Toggle activer/désactiver
  var toggleRow = el('div', { class: 'toggle-row', style: { borderBottom: 'none', paddingBottom: '12px' } });
  toggleRow.appendChild(el('span', { class: 'toggle-label' }, 'Activer le rendement'));
  var switchEl = el('label', { class: 'toggle-switch' });
  var inputToggle = el('input', { type: 'checkbox', id: 'rendementToggle', checked: TREASURY.rendementActif || false });
  inputToggle.onchange = function() {
    var tauxInput = $('#rendementTaux');
    if (tauxInput) tauxInput.disabled = !this.checked;
  };
  switchEl.appendChild(inputToggle);
  switchEl.appendChild(el('span', { class: 'toggle-slider' }));
  toggleRow.appendChild(switchEl);
  configSection.appendChild(toggleRow);
  
  // Champ taux
  var tauxRow = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } });
  tauxRow.appendChild(el('label', { style: { fontSize: '12px', flex: '1' } }, 'Taux annuel brut (%)'));
  var tauxInput = el('input', { 
    class: 'form-input', 
    type: 'number', 
    id: 'rendementTaux', 
    value: TREASURY.rendementTaux || 2,
    step: '0.1',
    min: '0',
    max: '20',
    style: { width: '80px', textAlign: 'right' },
    disabled: !(TREASURY.rendementActif || false)
  });
  tauxRow.appendChild(tauxInput);
  tauxRow.appendChild(el('span', { style: { fontSize: '12px', color: 'var(--text-muted)' } }, '%'));
  configSection.appendChild(tauxRow);
  
  // Exemple de calcul
  var tauxMensuel = ((TREASURY.rendementTaux || 2) / 12).toFixed(3);
  var exempleInterets = Math.round(10000 * (TREASURY.rendementTaux || 2) / 100 / 12 * 100) / 100;
  configSection.appendChild(el('div', { style: { marginTop: '12px', padding: '8px', background: 'var(--bg-secondary)', borderRadius: '6px', fontSize: '10px', color: 'var(--text-muted)' } }, 
    '💡 Exemple: 10 000€ × ' + tauxMensuel + '%/mois = ' + EUR(exempleInterets) + '/mois'
  ));
  
  body.appendChild(configSection);
  
  // === Section Historique (si actif) ===
  if (TREASURY.rendementActif && TREASURY.rendementHistorique && TREASURY.rendementHistorique.length > 0) {
    var histSection = el('div', { style: { marginBottom: '16px' } });
    histSection.appendChild(el('div', { style: { fontSize: '12px', fontWeight: '700', marginBottom: '8px' } }, '📊 Historique des intérêts'));
    
    var total = 0;
    TREASURY.rendementHistorique.slice(-6).reverse().forEach(function(int) {
      var row = el('div', { class: 'detail-row' });
      var leftDiv = el('div', {});
      leftDiv.appendChild(el('div', { style: { fontWeight: '600' } }, fmtMonth(int.mois)));
      leftDiv.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Solde moy: ' + EUR(int.soldeMoyen)));
      row.appendChild(leftDiv);
      row.appendChild(el('span', { class: 'text-success', style: { fontWeight: '700' } }, '+' + EUR(int.montant)));
      histSection.appendChild(row);
      total += int.montant;
    });
    
    // Total
    var totalAll = getTotalRendement();
    histSection.appendChild(el('div', { class: 'detail-separator' }));
    histSection.appendChild(el('div', { class: 'detail-row' }, [
      el('span', { style: { fontWeight: '700' } }, 'TOTAL (' + TREASURY.rendementHistorique.length + ' mois)'),
      el('span', { class: 'text-success', style: { fontWeight: '800' } }, '+' + EUR(totalAll))
    ]));
    
    body.appendChild(histSection);
  } else if (TREASURY.rendementActif) {
    body.appendChild(el('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-muted)', background: 'var(--bg-secondary)', borderRadius: '8px', marginBottom: '16px' } }, 
      'Les intérêts seront calculés à partir du mois prochain'
    ));
  }
  
  // Note fiscale
  body.appendChild(el('div', { style: { padding: '10px', background: 'var(--warning-glow)', borderRadius: '6px', fontSize: '10px', marginBottom: '16px' } }, [
    el('span', { style: { fontWeight: '700' } }, '⚠️ Fiscalité: '),
    el('span', {}, 'Intérêts soumis au PFU 30% (12.8% IR + 17.2% PS)')
  ]));
  
  // Bouton sauvegarder
  body.appendChild(el('button', { class: 'btn btn-success btn-block', onclick: function() {
    var wasActive = TREASURY.rendementActif;
    TREASURY.rendementActif = $('#rendementToggle').checked;
    TREASURY.rendementTaux = parseFloat($('#rendementTaux').value) || 2;
    
    // Si activé ou taux changé, recalculer l'historique
    if (TREASURY.rendementActif) {
      TREASURY.rendementHistorique = [];
      updateRendementHistorique();
    }
    
    saveAll();
    closeModal('formModal');
    render();
    toast(TREASURY.rendementActif ? 'Rendement activé à ' + TREASURY.rendementTaux + '%' : 'Rendement désactivé', 'success');
  } }, '✅ Sauvegarder'));
  
  openModal('formModal');
}

// Alias pour compatibilité
function showRendementDetail() { showRendementConfig(); }

function showWaterfallDetail() {
  var data = compute();
  $('#formModalTitle').textContent = '📊 Décomposition Bénéfice';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Calculs
  var tvaTotal = data.chargesDetail.find(function(c) { return c.cat === 'TVA'; });
  tvaTotal = tvaTotal ? tvaTotal.montant : 0;
  var irTotal = data.chargesDetail.filter(function(c) { return c.cat === 'Impôt' || c.cat === 'IR'; }).reduce(function(a, c) { return a + c.montant; }, 0);
  var autresCharges = data.chargesDetail.filter(function(c) { return c.cat !== 'TVA' && c.cat !== 'Impôt' && c.cat !== 'IR' && c.montant > 0; });
  var autresChargesTotal = autresCharges.reduce(function(a, c) { return a + c.montant; }, 0);
  
  var caHT = data.caEnc - tvaTotal;
  var beneficeBrut = caHT - autresChargesTotal;
  var beneficeNet = data.beneficeNet;
  var margeNette = caHT > 0 ? beneficeNet / caHT : 0;
  
  // Helper ligne simple
  function row(label, value, color, isMain, indent) {
    var style = { 
      display: 'flex', 
      justifyContent: 'space-between', 
      alignItems: 'center',
      padding: isMain ? '14px 16px' : '10px 16px',
      marginLeft: indent ? '20px' : '0',
      background: isMain ? 'var(--bg-tertiary)' : 'transparent',
      borderRadius: isMain ? 'var(--radius-sm)' : '0',
      marginBottom: isMain ? '8px' : '4px'
    };
    return el('div', { style: style }, [
      el('span', { style: { fontSize: isMain ? '13px' : '12px', fontWeight: isMain ? '700' : '400', color: indent ? 'var(--text-muted)' : 'inherit' } }, label),
      el('span', { style: { fontSize: isMain ? '16px' : '13px', fontWeight: isMain ? '800' : '600', color: color } }, value)
    ]);
  }
  
  // === BLOC 1: Du TTC au HT ===
  var bloc1 = el('div', { style: { marginBottom: '20px' } });
  bloc1.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '① CA TTC → CA HT'));
  bloc1.appendChild(row('CA Encaissé TTC', EUR(data.caEnc), 'var(--success)', true));
  bloc1.appendChild(row('- TVA collectée', '- ' + EUR(tvaTotal), '#f472b6', false, true));
  if (data.tvaDeductible > 0) {
    bloc1.appendChild(row('+ TVA déductible', '+ ' + EUR(data.tvaDeductible), '#34d399', false, true));
    bloc1.appendChild(row('= TVA nette', EUR(data.tvaNette), '#f472b6', false, true));
  }
  bloc1.appendChild(row('= CA HT', EUR(caHT), 'var(--info)', true));
  body.appendChild(bloc1);
  
  // === BLOC 2: Du HT au Bénéfice Brut ===
  var bloc2 = el('div', { style: { marginBottom: '20px' } });
  bloc2.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '② CA HT → Bénéfice Brut'));
  bloc2.appendChild(row('CA HT', EUR(caHT), 'var(--info)', true));
  
  autresCharges.sort(function(a, b) { return b.montant - a.montant; });
  autresCharges.forEach(function(ch) {
    var pct = caHT > 0 ? ch.montant / caHT : 0;
    bloc2.appendChild(row('- ' + ch.cat + ' (' + PCT(pct) + ')', '- ' + EUR(ch.montant), 'var(--danger)', false, true));
  });
  
  bloc2.appendChild(row('= Bénéfice Brut', EUR(beneficeBrut), beneficeBrut >= 0 ? 'var(--success)' : 'var(--danger)', true));
  body.appendChild(bloc2);
  
  // === BLOC 3: Du Brut au Net ===
  var bloc3 = el('div', { style: { marginBottom: '20px' } });
  bloc3.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '③ Bénéfice Brut → Net'));
  bloc3.appendChild(row('Bénéfice Brut', EUR(beneficeBrut), beneficeBrut >= 0 ? 'var(--success)' : 'var(--danger)', true));
  if (irTotal > 0) {
    var irPct = Math.abs(beneficeBrut) > 0 ? irTotal / Math.abs(beneficeBrut) : 0;
    bloc3.appendChild(row('- Impôt/IR (' + PCT(irPct) + ')', '- ' + EUR(irTotal), '#fbbf24', false, true));
  }
  body.appendChild(bloc3);
  
  // === RÉSULTAT FINAL ===
  body.appendChild(el('div', { style: { background: beneficeNet >= 0 ? 'var(--success-glow)' : 'var(--danger-glow)', padding: '20px', borderRadius: 'var(--radius-lg)', textAlign: 'center' } }, [
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '4px', textTransform: 'uppercase' } }, 'Bénéfice Net'),
    el('div', { style: { fontSize: '28px', fontWeight: '800', color: beneficeNet >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(beneficeNet)),
    el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px' } }, 'Marge nette: ' + PCT(margeNette) + ' sur CA HT')
  ]));
  
  // Légende couleurs
  body.appendChild(el('div', { style: { display: 'flex', gap: '12px', justifyContent: 'center', marginTop: '16px', fontSize: '10px' } }, [
    el('span', { style: { color: '#f472b6' } }, '● TVA'),
    el('span', { style: { color: '#fbbf24' } }, '● IR'),
    el('span', { style: { color: 'var(--danger)' } }, '● Charges')
  ]));
  
  openModal('formModal');
}

// Mode confidentialité
function togglePrivacy() {
  PRIVACY_MODE = !PRIVACY_MODE;
  var btn = $('#privacyToggle');
  if (btn) {
    btn.classList.toggle('active', PRIVACY_MODE);
    btn.innerHTML = PRIVACY_MODE ? '🔒' : '👁️';
    btn.title = PRIVACY_MODE ? 'Mode confidentialité activé (Ctrl+P)' : 'Mode confidentialité (Ctrl+P)';
  }
  // Appliquer le blur sur les éléments sensibles si activé
  $$('.kpi-value, .hero-amount, .treso-value').forEach(function(el) {
    el.classList.toggle('privacy-blur', PRIVACY_MODE);
  });
  // Re-render les graphiques pour masquer/afficher les valeurs
  if (typeof drawMainChart === 'function') drawMainChart();
  if (typeof drawSoldeChart === 'function') drawSoldeChart();
}

// Détail TJM Effectif et TJM Net
function showTJMDetail() {
  var data = compute();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  
  // Calcul du TJM moyen par mission
  var missionsTJM = [];
  MISSIONS.forEach(function(m) {
    var joursM = 0, caM = 0;
    if (m.lignes) m.lignes.forEach(function(l) {
      if (isInPeriod(l.ym) && l.joursReels) {
        joursM += l.joursReels;
        caM += l.joursReels * m.tjm;
      }
    });
    if (joursM > 0) {
      missionsTJM.push({ client: m.client, tjm: m.tjm, jours: joursM, ca: caM });
    }
  });
  
  $('#formModalTitle').textContent = '📊 Analyse TJM';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // KPIs principaux
  var kpis = el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '20px' } });
  
  var kpi1 = el('div', { style: { background: 'var(--info-glow)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' } });
  kpi1.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'TJM Effectif'));
  kpi1.appendChild(el('div', { style: { fontSize: '28px', fontWeight: '800', color: 'var(--info)' } }, EUR(data.tjmEffectif)));
  kpi1.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'CA HT / jours travaillés'));
  kpis.appendChild(kpi1);
  
  var kpi2 = el('div', { style: { background: 'var(--success-glow)', padding: '16px', borderRadius: 'var(--radius-md)', textAlign: 'center' } });
  kpi2.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'TJM Net'));
  kpi2.appendChild(el('div', { style: { fontSize: '28px', fontWeight: '800', color: 'var(--success)' } }, EUR(data.tjmNet)));
  kpi2.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Après charges sociales'));
  kpis.appendChild(kpi2);
  
  body.appendChild(kpis);
  
  // Détail du calcul
  var tauxCharges = getUrssafRate(nowYm) + LEGAL.cfp + (COMPANY.prelevementLiberatoire ? LEGAL.impLib : 0);
  
  var calcDiv = el('div', { class: 'card', style: { marginBottom: '16px' } });
  calcDiv.appendChild(el('div', { class: 'card-title' }, '📐 Détail du calcul'));
  calcDiv.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'CA Réalisé (HT)'), el('span', { style: { fontWeight: '700' } }, EUR(data.caReal))]));
  calcDiv.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Jours travaillés'), el('span', { style: { fontWeight: '700' } }, data.joursReal + ' jours')]));
  calcDiv.appendChild(el('div', { class: 'detail-row', style: { borderTop: '1px solid var(--glass-border)', paddingTop: '8px', marginTop: '8px' } }, [el('span', {}, 'TJM Effectif'), el('span', { style: { fontWeight: '700', color: 'var(--info)' } }, EUR(data.tjmEffectif))]));
  calcDiv.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Taux charges (' + PCT(tauxCharges) + ')'), el('span', { style: { color: 'var(--danger)' } }, '- ' + EUR(Math.round(data.tjmEffectif * tauxCharges)))]));
  calcDiv.appendChild(el('div', { class: 'detail-row', style: { borderTop: '1px solid var(--glass-border)', paddingTop: '8px', marginTop: '8px' } }, [el('span', {}, 'TJM Net'), el('span', { style: { fontWeight: '700', color: 'var(--success)' } }, EUR(data.tjmNet))]));
  body.appendChild(calcDiv);
  
  // TJM par mission
  if (missionsTJM.length > 0) {
    var missionsDiv = el('div', { class: 'card' });
    missionsDiv.appendChild(el('div', { class: 'card-title' }, '💼 TJM par mission'));
    missionsTJM.forEach(function(m) {
      missionsDiv.appendChild(el('div', { class: 'detail-row' }, [
        el('span', {}, m.client + ' (' + m.jours + 'j)'),
        el('span', { style: { fontWeight: '700' } }, EUR(m.tjm))
      ]));
    });
    body.appendChild(missionsDiv);
  }
  
  // Comparaison marché
  var benchmarkDiv = el('div', { style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: 'var(--radius-md)', fontSize: '11px', color: 'var(--text-muted)' } });
  benchmarkDiv.innerHTML = '<strong>💡 Repères marché (IT/Conseil):</strong><br>' +
    '• Junior (0-3 ans): 350-450€/j<br>' +
    '• Confirmé (3-7 ans): 450-600€/j<br>' +
    '• Senior (7+ ans): 600-900€/j';
  body.appendChild(benchmarkDiv);
  
  openModal('formModal');
}

// V54: Détail CA Réalisé
function showCARealisedDetail(data) {
  if (!data) data = compute();
  var content = el('div', { style: { padding: '10px' } });

  // KPI principal
  content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '20px', padding: '20px', background: 'var(--bg-tertiary)', borderRadius: '12px' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'CA Réalisé HT'),
    el('div', { style: { fontSize: '32px', fontWeight: '800', color: 'var(--info)' } }, EUR(data.caReal)),
    el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' } }, 'Prévu: ' + EUR(data.caPrev) + ' · Écart: ' + (data.caReal >= data.caPrev ? '+' : '') + EUR(data.caReal - data.caPrev))
  ]));

  // Détail par client
  var clients = getClientsStats();
  if (clients.length > 0) {
    content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '👥 CA par Client'));
    var list = el('div', { style: { maxHeight: '200px', overflowY: 'auto' } });
    clients.forEach(function(c) {
      var pct = data.caReal > 0 ? Math.round((c.ca / data.caReal) * 100) : 0;
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px', marginBottom: '4px', fontSize: '12px' } });
      row.appendChild(el('span', {}, c.name + ' (' + c.jours + 'j)'));
      row.appendChild(el('span', { style: { fontWeight: '600' } }, EUR(c.ca) + ' (' + pct + '%)'));
      list.appendChild(row);
    });
    content.appendChild(list);
  }

  // Détail par mois
  content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', margin: '16px 0 8px', textTransform: 'uppercase' } }, '📅 CA par Mois'));
  var months = getPeriodMonths();
  var monthsList = el('div', { style: { maxHeight: '150px', overflowY: 'auto' } });
  months.forEach(function(m) {
    var md = data.monthsData[m];
    if (md && md.real > 0) {
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '6px 8px', background: 'var(--bg-tertiary)', borderRadius: '4px', marginBottom: '2px', fontSize: '11px' } });
      row.appendChild(el('span', {}, fmtMonthShort(m)));
      row.appendChild(el('span', { style: { fontWeight: '600' } }, EUR(md.real)));
      monthsList.appendChild(row);
    }
  });
  content.appendChild(monthsList);

  showModal('📊 Détail CA Réalisé', content);
}

// V54: Détail Encaissé
function showEncaisseDetail(data) {
  if (!data) data = compute();
  var content = el('div', { style: { padding: '10px' } });

  // KPIs
  var kpis = el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '16px' } });
  // V60: Afficher le vrai CA HT (pas TTC) quand on dit "Encaissé HT"
  kpis.appendChild(el('div', { style: { textAlign: 'center', padding: '12px', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '8px' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Encaissé HT'),
    el('div', { style: { fontSize: '20px', fontWeight: '800', color: 'var(--success)' } }, EUR(data.caHT)),
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'TTC: ' + EUR(data.caEnc))
  ]));
  kpis.appendChild(el('div', { style: { textAlign: 'center', padding: '12px', background: 'rgba(251, 191, 36, 0.1)', borderRadius: '8px' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'À Encaisser'),
    el('div', { style: { fontSize: '20px', fontWeight: '800', color: 'var(--warning)' } }, EUR(data.caAEnc))
  ]));
  content.appendChild(kpis);

  // Factures encaissées
  if (data.detailEncaisse.length > 0) {
    content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '✅ Factures Encaissées'));
    var list = el('div', { style: { maxHeight: '150px', overflowY: 'auto' } });
    data.detailEncaisse.forEach(function(f) {
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '6px 8px', background: 'var(--bg-tertiary)', borderRadius: '4px', marginBottom: '2px', fontSize: '11px' } });
      row.appendChild(el('span', {}, f.client + ' · ' + fmtMonthShort(f.mois)));
      row.appendChild(el('span', { style: { fontWeight: '600', color: 'var(--success)' } }, EUR(f.ht) + ' HT'));
      list.appendChild(row);
    });
    content.appendChild(list);
  }

  // Factures à encaisser
  if (data.facturesAEncaisser.length > 0) {
    content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', margin: '16px 0 8px', textTransform: 'uppercase' } }, '⏳ Factures à Encaisser'));
    var list2 = el('div', { style: { maxHeight: '150px', overflowY: 'auto' } });
    data.facturesAEncaisser.forEach(function(f) {
      var bgColor = f.isLate ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-tertiary)';
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '6px 8px', background: bgColor, borderRadius: '4px', marginBottom: '2px', fontSize: '11px' } });
      row.appendChild(el('span', {}, f.client + ' · ' + fmtMonthShort(f.mois) + (f.isLate ? ' ⚠️' : '')));
      row.appendChild(el('span', { style: { fontWeight: '600', color: f.isLate ? 'var(--danger)' : 'var(--warning)' } }, EUR(f.ht) + ' HT'));
      list2.appendChild(row);
    });
    content.appendChild(list2);
  }

  showModal('💵 Détail Encaissements', content);
}

// V54: Détail Bénéfice Net
function showBeneficeDetail(data) {
  if (!data) data = compute();
  var content = el('div', { style: { padding: '10px' } });

  // V57: Utiliser CA HT encaissé (pas réalisé) et charges hors TVA
  var caHT = data.caHT || 0;
  var chargesHorsTVA = (data.totalCharges || 0) - (data.tvaTotale || 0);
  var salaires = data.salaires || 0;
  var benefice = caHT - chargesHorsTVA - salaires;

  // KPI principal
  var benColor = benefice >= 0 ? 'var(--success)' : 'var(--danger)';
  content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '20px', padding: '20px', background: 'var(--bg-tertiary)', borderRadius: '12px' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'Bénéfice Net'),
    el('div', { style: { fontSize: '32px', fontWeight: '800', color: benColor } }, EUR(benefice)),
    el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' } }, 'Marge: ' + PCT(caHT > 0 ? benefice / caHT : 0))
  ]));

  // Décomposition
  content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '📐 Décomposition'));
  var calc = el('div', { style: { background: 'var(--bg-tertiary)', borderRadius: '8px', padding: '12px' } });
  calc.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' } }, [el('span', {}, 'CA Encaissé HT'), el('span', { style: { fontWeight: '600', color: 'var(--success)' } }, '+ ' + EUR(caHT))]));
  calc.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' } }, [el('span', {}, 'Charges sociales & fiscales'), el('span', { style: { fontWeight: '600', color: 'var(--danger)' } }, '- ' + EUR(chargesHorsTVA))]));
  calc.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '4px 0', fontSize: '12px' } }, [el('span', {}, 'Salaires versés'), el('span', { style: { fontWeight: '600', color: 'var(--info)' } }, '- ' + EUR(salaires))]));
  calc.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '8px 0 0', fontSize: '13px', borderTop: '1px solid var(--border)', marginTop: '8px' } }, [el('span', { style: { fontWeight: '600' } }, 'Bénéfice Net'), el('span', { style: { fontWeight: '700', color: benColor } }, EUR(benefice))]));
  content.appendChild(calc);

  // Répartition charges
  content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', margin: '16px 0 8px', textTransform: 'uppercase' } }, '💳 Répartition des Charges'));
  var chargesTypes = Object.keys(data.provByType || {});
  if (chargesTypes.length > 0) {
    var chargesList = el('div', { style: { maxHeight: '120px', overflowY: 'auto' } });
    chargesTypes.sort(function(a, b) { return data.provByType[b] - data.provByType[a]; }).forEach(function(type) {
      var montant = data.provByType[type];
      var pct = caHT > 0 ? Math.round((montant / caHT) * 100) : 0;
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '6px 8px', background: 'var(--bg-tertiary)', borderRadius: '4px', marginBottom: '2px', fontSize: '11px' } });
      row.appendChild(el('span', {}, type));
      row.appendChild(el('span', { style: { fontWeight: '600' } }, EUR(montant) + ' (' + pct + '% CA)'));
      chargesList.appendChild(row);
    });
    content.appendChild(chargesList);
  }

  showModal('📊 Détail Bénéfice Net', content);
}

// Détail Taux de facturation
function showTauxFacturationDetail(data) {
  if (!data) data = compute();
  
  $('#formModalTitle').textContent = '📅 Taux de Facturation';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // KPI principal
  var tauxColor = data.tauxFacturation >= 0.8 ? 'var(--success)' : data.tauxFacturation >= 0.6 ? 'var(--warning)' : 'var(--danger)';
  var heroDiv = el('div', { style: { background: 'var(--bg-tertiary)', padding: '20px', borderRadius: 'var(--radius-lg)', textAlign: 'center', marginBottom: '20px' } });
  heroDiv.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'Taux de Facturation'));
  heroDiv.appendChild(el('div', { style: { fontSize: '36px', fontWeight: '800', color: tauxColor } }, PCT(data.tauxFacturation)));
  heroDiv.appendChild(el('div', { style: { fontSize: '13px', color: 'var(--text-secondary)', marginTop: '8px' } }, data.joursReal + ' jours facturés sur ' + data.joursOuvrables + ' jours ouvrables'));
  body.appendChild(heroDiv);
  
  // Détail par mois
  var months = getPeriodMonths();
  
  // V51: Sous-onglets dashboard
  renderDashboardSubTabs(container);
  
  // Afficher le contenu selon le sous-onglet actif
  if (DASHBOARD_SUB === 'charges') {
    renderChargesSubTab(container, data);
    return;
  }
  if (DASHBOARD_SUB === 'analyse') {
    renderAnalyseSubTab(container, data, months);
    return;
  }
  // Sinon: Accueil (défaut)
  var monthsDiv = el('div', { class: 'card', style: { marginBottom: '16px' } });
  monthsDiv.appendChild(el('div', { class: 'card-title' }, '📆 Détail par mois'));
  
  months.forEach(function(m) {
    var wd = data.workedDays[m];
    if (!wd) return;
    var taux = wd.ouvrables > 0 ? wd.reels / wd.ouvrables : 0;
    var color = taux >= 0.8 ? 'var(--success)' : taux >= 0.6 ? 'var(--warning)' : taux > 0 ? 'var(--danger)' : 'var(--text-muted)';
    
    var row = el('div', { class: 'detail-row' });
    row.appendChild(el('span', {}, fmtMonth(m)));
    row.appendChild(el('span', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
      el('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, wd.reels + '/' + wd.ouvrables + 'j'),
      el('span', { style: { fontWeight: '700', color: color, minWidth: '45px', textAlign: 'right' } }, PCT(taux))
    ]));
    monthsDiv.appendChild(row);
  });
  body.appendChild(monthsDiv);
  
  // Stats congés
  if (data.joursOff > 0) {
    var congesDiv = el('div', { class: 'card' });
    congesDiv.appendChild(el('div', { class: 'card-title' }, '🏖️ Congés posés'));
    congesDiv.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Jours de congés'), el('span', { style: { fontWeight: '700' } }, data.joursOff + ' jours')]));
    congesDiv.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Équivalent CA'), el('span', { style: { fontWeight: '700', color: 'var(--warning)' } }, EUR(data.joursOff * data.tjmEffectif))]));
    body.appendChild(congesDiv);
  }
  
  // Objectifs benchmark
  var benchDiv = el('div', { style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: 'var(--radius-md)', fontSize: '11px', color: 'var(--text-muted)' } });
  benchDiv.innerHTML = '<strong>💡 Objectifs recommandés:</strong><br>' +
    '• 80%+ = Excellent (mission longue durée)<br>' +
    '• 70-80% = Bon (compte tenu des congés)<br>' +
    '• 60-70% = À surveiller (intercontrat?)<br>' +
    '• <60% = Problématique';
  body.appendChild(benchDiv);
  
  openModal('formModal');
}

function showIRDetail() {
  var data = compute();
  var currentYear = PERIOD.year || TODAY.getFullYear(); // V64: Respecter le filtre de période
  
  $('#formModalTitle').textContent = '💶 Simulation IR';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Sélecteur d'année
  var yearSelect = el('div', { style: { display: 'flex', gap: '8px', marginBottom: '16px', justifyContent: 'center' } });
  [currentYear - 1, currentYear, currentYear + 1].forEach(function(y) {
    var btn = el('button', { 
      class: 'btn btn-sm' + (y === currentYear ? ' btn-success' : ''), 
      id: 'irYear' + y,
      onclick: function() { renderIRForYear(y); } 
    }, String(y));
    yearSelect.appendChild(btn);
  });
  body.appendChild(yearSelect);
  
  // Container pour le contenu
  body.appendChild(el('div', { id: 'irContent' }));
  
  // Afficher pour l'année courante
  renderIRForYear(currentYear);
  
  openModal('formModal');
}

function renderIRForYear(year) {
  var cfg = getIRConfig(year);

  // V65: Utilise getIRForYear() comme source unique de vérité
  var irData = getIRForYear(year);
  var ir = irData.ir;
  var caEncaisse = irData.caEncaisse;
  var caAEncaisser = irData.caAEncaisser;
  var caTotal = irData.caTotal;
  
  // Update boutons année
  [TODAY.getFullYear() - 1, TODAY.getFullYear(), TODAY.getFullYear() + 1].forEach(function(y) {
    var btn = $('#irYear' + y);
    if (btn) {
      btn.className = 'btn btn-sm' + (y === year ? ' btn-success' : '');
    }
  });
  
  var content = $('#irContent');
  content.innerHTML = '';
  
  // Formulaire d'édition
  var form = el('div', { style: { background: 'var(--bg-secondary)', padding: '16px', borderRadius: 'var(--radius-md)', marginBottom: '16px' } });
  form.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '12px', textTransform: 'uppercase' } }, '⚙️ Paramètres ' + year));
  
  var row1 = el('div', { class: 'form-row' });
  row1.appendChild(createInput('Parts fiscales', 'number', 'irParts', cfg.parts || 1));
  row1.appendChild(createInput('Autres revenus (€)', 'number', 'irAutres', cfg.autresRevenus || 0));
  form.appendChild(row1);
  
  form.appendChild(createInput('PER annuel (€)', 'number', 'irPER', cfg.perAnnuel || 0));
  
  // V59: IIFE pour capturer correctement la valeur de year
  form.appendChild(el('button', { class: 'btn btn-success btn-sm', style: { marginTop: '12px' }, onclick: (function(yearToSave) {
    return function() {
      var y = String(yearToSave);
      if (!IR_CONFIG[y]) IR_CONFIG[y] = {};
      IR_CONFIG[y].parts = parseFloat($('#irParts').value) || 1;
      IR_CONFIG[y].autresRevenus = parseFloat($('#irAutres').value) || 0;
      IR_CONFIG[y].perAnnuel = parseFloat($('#irPER').value) || 0;
      saveAll();
      renderIRForYear(yearToSave);
      toast('Paramètres ' + yearToSave + ' sauvegardés', 'success');
    };
  })(year) }, '💾 Sauvegarder'));
  
  content.appendChild(form);
  
  // Calcul détaillé
  var calc = el('div', { style: { background: 'var(--bg-tertiary)', padding: '16px', borderRadius: 'var(--radius-md)' } });
  calc.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '12px', textTransform: 'uppercase' } }, '📊 Calcul ' + year));
  
  // V65: Afficher CA encaissé + à encaisser (base de l'IR = date de paiement des factures)
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'CA Encaissé (factures payées)'), el('span', { style: { fontWeight: '600', color: 'var(--success)' } }, EUR(caEncaisse))]));
  if (caAEncaisser > 0) {
    calc.appendChild(el('div', { class: 'detail-row' }, [el('span', { style: { color: '#a78bfa' } }, '+ CA À encaisser (paiement prévu ' + year + ')'), el('span', { style: { fontWeight: '600', color: '#a78bfa' } }, EUR(caAEncaisser))]));
  }
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', { style: { fontWeight: '700' } }, '= CA HT total ' + year), el('span', { style: { fontWeight: '700' } }, EUR(caTotal))]))
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Abattement 34% (min 305€)'), el('span', { class: 'text-success' }, '- ' + EUR(ir.abattement))]));
  
  if (ir.perAnnuel > 0) {
    calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'PER'), el('span', { class: 'text-success' }, '- ' + EUR(ir.perAnnuel))]));
  }
  if (ir.autresRevenus > 0) {
    calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Autres revenus'), el('span', { class: 'text-warning' }, '+ ' + EUR(ir.autresRevenus))]));
  }
  
  calc.appendChild(el('div', { class: 'detail-separator' }));
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Revenu imposable'), el('span', { style: { fontWeight: '600' } }, EUR(ir.revenuNet))]));
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Parts fiscales'), el('span', {}, String(ir.parts))]));
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Quotient familial'), el('span', { style: { fontWeight: '600' } }, EUR(ir.quotient))]));
  
  // Répartition détaillée dans les tranches d'IR
  if (ir.tranches && ir.tranches.length > 0) {
    calc.appendChild(el('div', { style: { marginTop: '16px', marginBottom: '8px', fontSize: '10px', color: 'var(--accent)', fontWeight: '600', textTransform: 'uppercase' } }, '📐 Répartition par tranche'));
    
    var tranchesLabels = ['0%', '11%', '30%', '41%', '45%'];
    var tranchesMax = [11294, 28797, 82341, 177106, Infinity];
    
    ir.tranches.forEach(function(t, idx) {
      var trancheLabel = PCT(t.rate) + ' (jusqu\'à ' + (t.max === Infinity ? '∞' : EUR(tranchesMax[idx])) + ')';
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-sm)', marginBottom: '6px' } });
      
      // Indicateur de tranche avec couleur
      var trancheColor = t.rate === 0 ? 'var(--success)' : t.rate <= 0.11 ? '#22d3ee' : t.rate <= 0.30 ? '#fbbf24' : 'var(--danger)';
      row.appendChild(el('div', { style: { width: '6px', height: '100%', minHeight: '24px', background: trancheColor, borderRadius: '3px', flexShrink: '0' } }));
      
      var info = el('div', { style: { flex: '1' } });
      info.appendChild(el('div', { style: { fontSize: '11px', fontWeight: '600' } }, 'Tranche ' + PCT(t.rate)));
      info.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, EUR(t.base) + ' × ' + PCT(t.rate)));
      row.appendChild(info);
      
      row.appendChild(el('div', { style: { fontWeight: '700', fontSize: '13px', color: trancheColor } }, EUR(Math.round(t.impot))));
      calc.appendChild(row);
    });
    
    // Total des tranches pour vérification
    var totalTranches = ir.tranches.reduce(function(a, t) { return a + t.impot; }, 0);
    calc.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '6px 12px', fontSize: '11px', color: 'var(--text-muted)' } }, [
      el('span', {}, 'Total tranches (× ' + ir.parts + ' parts)'),
      el('span', { style: { fontWeight: '600' } }, EUR(Math.round(totalTranches)) + ' × ' + ir.parts + ' = ' + EUR(Math.round(totalTranches * ir.parts)))
    ]));
  }
  
  calc.appendChild(el('div', { class: 'detail-separator' }));
  calc.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'TMI'), el('span', { class: 'text-warning' }, PCT(ir.tmi))]));
  calc.appendChild(el('div', { class: 'detail-separator accent' }));
  calc.appendChild(el('div', { class: 'detail-row highlight' }, [el('span', { style: { fontWeight: '700' } }, 'IR Estimé ' + year), el('span', { style: { fontWeight: '800', fontSize: '20px', color: 'var(--warning)' } }, EUR(ir.impot))]));

  // V66: Si CA à encaisser inclus, montrer la différence
  if (caAEncaisser > 0) {
    var irEncaisseSeul = calculateIR(caEncaisse, year);
    calc.appendChild(el('div', { style: { marginTop: '8px', padding: '8px', background: 'rgba(167,139,250,0.08)', borderRadius: '6px', fontSize: '11px', borderLeft: '3px solid #a78bfa' } }, [
      el('div', { style: { color: '#a78bfa', fontWeight: '600' } }, '🔮 Projection incluse (factures à encaisser)'),
      el('div', { style: { color: 'var(--text-muted)', marginTop: '4px' } }, 'IR sur encaissé seul: ' + EUR(irEncaisseSeul.impot)),
      el('div', { style: { color: 'var(--text-muted)' } }, 'Surplus dû aux factures à venir: ' + EUR(ir.impot - irEncaisseSeul.impot))
    ]));
  }

  content.appendChild(calc);
  
  // Info prélèvement libératoire
  if (COMPANY.prelevementLiberatoire) {
    var plImpot = Math.round(caTotal * LEGAL.impLib);
    var plInfo = el('div', { style: { background: 'var(--success-glow)', padding: '14px', borderRadius: 'var(--radius-md)', marginTop: '16px', fontSize: '12px' } });
    plInfo.innerHTML = '✅ <strong>Prélèvement libératoire actif</strong><br>Tu paies ' + PCT(LEGAL.impLib) + ' sur CA HT = ' + EUR(plImpot);
    content.appendChild(plInfo);
  }
}

function showMissionModal(mission) {
  var isNew = !mission;
  if (isNew) mission = { 
    id: 'M' + Date.now(), client: '', clientId: '', titre: '', site: '', debut: '', fin: '', 
    tjm: 0, delaiPaiement: 2, jourPaiement: 15,
    adresseClient: '', numeroCommande: '', descriptifFacture: ''
  };
  
  $('#formModalTitle').textContent = isNew ? '💼 Nouvelle Mission' : '✏️ ' + mission.client;
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Section Mission
  body.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px', textTransform: 'uppercase' } }, '📋 Informations Mission'));
  
  // Dropdown client si des clients existent
  if (CLIENTS.length > 0) {
    var clientOptions = [{ value: '', label: '-- Sélectionner --' }];
    CLIENTS.forEach(function(c) { clientOptions.push({ value: c.id, label: c.nom }); });
    clientOptions.push({ value: '_new_', label: '+ Nouveau client...' });
    body.appendChild(createSelect('Client', 'mClientId', clientOptions, mission.clientId || ''));
    setTimeout(function() {
      var sel = $('#mClientId');
      if (sel) {
        sel.addEventListener('change', function() {
          if (sel.value === '_new_') {
            closeModal('formModal');
            showClientModal();
          } else if (sel.value) {
            var cli = getClient(sel.value);
            if (cli && cli.adresse && !$('#mAdresseClient').value) {
              $('#mAdresseClient').value = cli.adresse;
            }
            if (cli) {
              $('#mDelai').value = String(cli.delaiPaiement || 2);
              $('#mJour').value = cli.jourPaiement || 15;
            }
          }
        });
      }
    }, 0);
  } else {
    body.appendChild(createInput('Client', 'text', 'mClient', mission.client));
  }
  
  body.appendChild(createInput('Titre / Projet', 'text', 'mTitre', mission.titre));
  body.appendChild(createInput('Site / Lieu', 'text', 'mSite', mission.site));
  
  var row1 = el('div', { class: 'form-row' });
  row1.appendChild(createInput('Début', 'date', 'mDebut', mission.debut));
  row1.appendChild(createInput('Fin', 'date', 'mFin', mission.fin));
  body.appendChild(row1);
  
  var row2 = el('div', { class: 'form-row-3' });
  row2.appendChild(createInput('TJM (€)', 'number', 'mTJM', mission.tjm));
  row2.appendChild(createSelect('Délai', 'mDelai', [{ value: '1', label: 'M+1' }, { value: '2', label: 'M+2' }, { value: '3', label: 'M+3' }], String(mission.delaiPaiement)));
  row2.appendChild(createInput('Jour paie', 'number', 'mJour', mission.jourPaiement));
  body.appendChild(row2);
  
  // Section Facturation
  body.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '16px', marginBottom: '8px', paddingTop: '12px', borderTop: '1px solid var(--glass-border)', textTransform: 'uppercase' } }, '📄 Informations Facturation'));
  body.appendChild(createInput('Adresse client (pour facture)', 'text', 'mAdresseClient', mission.adresseClient || '', 'Ex: 14 Rue Paul Mesple, 31100 Toulouse'));
  body.appendChild(createInput('N° Commande client', 'text', 'mNumCommande', mission.numeroCommande || '', 'Ex: 10004903'));
  body.appendChild(createTextarea('Descriptif standard facture', 'mDescriptif', mission.descriptifFacture || '', 'Ex: Prestation de service consultant'));
  
  var btns = el('div', { style: { display: 'flex', gap: '10px', marginTop: '20px' } });
  btns.appendChild(el('button', { class: 'btn btn-success', style: { flex: '1' }, onclick: function() {
    // Gérer client via dropdown ou input texte
    var clientId = $('#mClientId') ? $('#mClientId').value : '';
    if (clientId && clientId !== '_new_') {
      var cli = getClient(clientId);
      mission.clientId = clientId;
      mission.client = cli ? cli.nom : '';
    } else if ($('#mClient')) {
      mission.client = $('#mClient').value;
      mission.clientId = '';
    }
    mission.titre = $('#mTitre').value; mission.site = $('#mSite').value;
    mission.debut = $('#mDebut').value; mission.fin = $('#mFin').value;
    mission.tjm = parseFloat($('#mTJM').value) || 0;
    mission.delaiPaiement = parseInt($('#mDelai').value) || 2;
    mission.jourPaiement = parseInt($('#mJour').value) || 15;
    mission.adresseClient = $('#mAdresseClient').value;
    mission.numeroCommande = $('#mNumCommande').value;
    mission.descriptifFacture = $('#mDescriptif').value;
    buildMission(mission);
    if (isNew) MISSIONS.push(mission);
    saveAll(); closeModal('formModal'); render();
    toast(isNew ? 'Mission créée!' : 'Mission mise à jour', 'success');
  } }, '✅ Enregistrer'));
  if (!isNew) {
    btns.appendChild(el('button', { class: 'btn', onclick: function() { closeModal('formModal'); showDaysEditor(mission); } }, '📅'));
    btns.appendChild(el('button', { class: 'btn btn-danger', onclick: function() { if (confirm('Supprimer?')) { MISSIONS = MISSIONS.filter(function(m) { return m.id !== mission.id; }); saveAll(); closeModal('formModal'); render(); } } }, '🗑️'));
  }
  body.appendChild(btns);
  openModal('formModal');
}

function showDaysEditor(mission) {
  $('#formModalTitle').textContent = '📅 Jours - ' + mission.client;
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  if (!mission.lignes || mission.lignes.length === 0) {
    body.appendChild(el('div', { style: { textAlign: 'center', padding: '24px', color: 'var(--text-muted)' } }, 'Configure d\'abord les dates'));
    openModal('formModal');
    return;
  }
  
  var table = el('table', { class: 'days-table' });
  var thead = el('thead');
  var headerRow = el('tr');
  ['Mois', 'Ouvrés', 'Prévus', 'Congés', 'Réels', 'CA'].forEach(function(h) { headerRow.appendChild(el('th', {}, h)); });
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  var tbody = el('tbody', { id: 'daysBody' });
  mission.lignes.forEach(function(l, idx) {
    var tr = el('tr');
    tr.appendChild(el('td', { class: 'month-cell' }, fmtMonthShort(l.ym)));
    tr.appendChild(el('td', {}, String(l.joursOuvrables)));
    
    var prevInput = el('input', { type: 'number', value: l.joursPrevus || 0, min: 0, max: l.joursOuvrables, 'data-idx': idx, 'data-field': 'joursPrevus' });
    prevInput.oninput = function() { recalcDaysTable(mission); };
    tr.appendChild(el('td', {}, [prevInput]));
    
    var congesInput = el('input', { type: 'number', value: l.conges || 0, min: 0, 'data-idx': idx, 'data-field': 'conges' });
    congesInput.oninput = function() { recalcDaysTable(mission); };
    tr.appendChild(el('td', {}, [congesInput]));
    
    var reels = Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
    tr.appendChild(el('td', { class: 'computed', 'data-idx': idx, 'data-type': 'reels' }, String(reels)));
    tr.appendChild(el('td', { class: 'computed', 'data-idx': idx, 'data-type': 'ca' }, EUR(reels * mission.tjm)));
    tbody.appendChild(tr);
  });
  
  var totalRow = el('tr', { class: 'total-row' });
  totalRow.appendChild(el('td', {}, 'TOTAL'));
  ['totalOuvres', 'totalPrevus', 'totalConges', 'totalReels', 'totalCA'].forEach(function(id) { totalRow.appendChild(el('td', { id: id }, '')); });
  tbody.appendChild(totalRow);
  table.appendChild(tbody);
  body.appendChild(table);
  
  var actions = el('div', { style: { display: 'flex', gap: '8px', marginTop: '16px' } });
  actions.appendChild(el('button', { class: 'btn btn-sm', onclick: function() { fillAllDays(mission, 'all'); } }, 'Tous les jours'));
  actions.appendChild(el('button', { class: 'btn btn-sm', onclick: function() { fillAllDays(mission, 'none'); } }, 'Reset'));
  body.appendChild(actions);
  
  body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '16px' }, onclick: function() { saveDaysFromEditor(mission); closeModal('formModal'); render(); toast('Jours enregistrés', 'success'); } }, '✅ Enregistrer'));
  
  openModal('formModal');
  recalcDaysTable(mission);
}

function recalcDaysTable(mission) {
  var totals = { ouvres: 0, prevus: 0, conges: 0, reels: 0, ca: 0 };
  mission.lignes.forEach(function(l, idx) {
    var prevInput = $('input[data-idx="' + idx + '"][data-field="joursPrevus"]');
    var congesInput = $('input[data-idx="' + idx + '"][data-field="conges"]');
    if (!prevInput || !congesInput) return;
    var prevus = parseInt(prevInput.value) || 0;
    var conges = parseInt(congesInput.value) || 0;
    var reels = Math.max(0, prevus - conges);
    var reelsCell = $('td[data-idx="' + idx + '"][data-type="reels"]');
    var caCell = $('td[data-idx="' + idx + '"][data-type="ca"]');
    if (reelsCell) reelsCell.textContent = reels;
    if (caCell) caCell.textContent = EUR(reels * mission.tjm);
    totals.ouvres += l.joursOuvrables;
    totals.prevus += prevus;
    totals.conges += conges;
    totals.reels += reels;
    totals.ca += reels * mission.tjm;
  });
  if ($('#totalOuvres')) $('#totalOuvres').textContent = totals.ouvres;
  if ($('#totalPrevus')) $('#totalPrevus').textContent = totals.prevus;
  if ($('#totalConges')) $('#totalConges').textContent = totals.conges;
  if ($('#totalReels')) $('#totalReels').textContent = totals.reels;
  if ($('#totalCA')) $('#totalCA').textContent = EUR(totals.ca);
}

function saveDaysFromEditor(mission) {
  mission.lignes.forEach(function(l, idx) {
    var prevInput = $('input[data-idx="' + idx + '"][data-field="joursPrevus"]');
    var congesInput = $('input[data-idx="' + idx + '"][data-field="conges"]');
    if (prevInput) l.joursPrevus = parseInt(prevInput.value) || 0;
    if (congesInput) l.conges = parseInt(congesInput.value) || 0;
    l.joursReels = Math.max(0, l.joursPrevus - l.conges);
  });
  buildMission(mission);
  saveAll();
}

function fillAllDays(mission, mode) {
  mission.lignes.forEach(function(l, idx) {
    var prevInput = $('input[data-idx="' + idx + '"][data-field="joursPrevus"]');
    var congesInput = $('input[data-idx="' + idx + '"][data-field="conges"]');
    if (mode === 'all') { if (prevInput) prevInput.value = l.joursOuvrables; if (congesInput) congesInput.value = 0; }
    else { if (prevInput) prevInput.value = 0; if (congesInput) congesInput.value = 0; }
  });
  recalcDaysTable(mission);
}

// Liste des catégories de charges courantes
var CHARGE_CATEGORIES = [
  { value: 'RC Pro', label: '🛡️ RC Pro (Assurance)' },
  { value: 'Mutuelle', label: '🏥 Mutuelle' },
  { value: 'Prévoyance', label: '💊 Prévoyance' },
  { value: 'CFE', label: '🏛️ CFE' },
  { value: 'Comptable', label: '📊 Comptable' },
  { value: 'Logiciel', label: '💻 Logiciel / Abonnement' },
  { value: 'Matériel', label: '🖥️ Matériel' },
  { value: 'Téléphone', label: '📱 Téléphone / Internet' },
  { value: 'Transport', label: '🚗 Transport' },
  { value: 'Repas', label: '🍽️ Repas' },
  { value: 'Coworking', label: '🏢 Coworking / Location' },
  { value: 'Formation', label: '📚 Formation' },
  { value: 'Banque', label: '🏦 Frais bancaires' },
  { value: 'Autre', label: '📦 Autre' }
];

function showChargeModal() {
  $('#formModalTitle').textContent = '📋 Ajouter une Charge';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Onglets: Ponctuelle / Récurrente
  var tabs = el('div', { class: 'filter-tabs', style: { marginBottom: '16px' } });
  tabs.appendChild(el('button', { class: 'filter-tab active', id: 'tabPonctuelle', onclick: function() { showChargePonctuelle(); } }, '📌 Ponctuelle'));
  tabs.appendChild(el('button', { class: 'filter-tab', id: 'tabRecurrente', onclick: function() { showChargeRecurrente(); } }, '🔄 Récurrente'));
  body.appendChild(tabs);
  
  body.appendChild(el('div', { id: 'chargeFormContent' }));
  showChargePonctuelle();
  
  openModal('formModal');
}

function showChargePonctuelle() {
  $('#tabPonctuelle').classList.add('active');
  $('#tabRecurrente').classList.remove('active');
  var content = $('#chargeFormContent');
  content.innerHTML = '';

  content.appendChild(createSelect('Catégorie', 'chCat', CHARGE_CATEGORIES, 'Autre'));
  content.appendChild(createInput('Description', 'text', 'chDesc', '', 'Ex: Abonnement Notion'));
  content.appendChild(createInput('Montant (€)', 'number', 'chMontant', ''));
  content.appendChild(createInput('Mois', 'month', 'chMois', ym(TODAY.getFullYear(), TODAY.getMonth())));

  // V61: TVA déductible sur achats pro
  var tvaSection = el('div', { id: 'chTvaSection', style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: 'var(--radius-md)', marginTop: '12px' } });
  var tvaToggle = el('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' } });
  var tvaCheckbox = el('input', { type: 'checkbox', id: 'chTvaToggle', style: { accentColor: 'var(--accent)' } });
  tvaToggle.appendChild(tvaCheckbox);
  tvaToggle.appendChild(el('span', { style: { fontSize: '12px' } }, 'Montant TTC (récupérer la TVA déductible)'));
  tvaSection.appendChild(tvaToggle);
  var tvaDetail = el('div', { id: 'chTvaDetail', style: { display: 'none', marginTop: '10px' } });
  tvaDetail.appendChild(createSelect('Taux TVA', 'chTvaRate', [
    { value: '20', label: '20% (taux normal)' },
    { value: '10', label: '10% (taux intermédiaire)' },
    { value: '5.5', label: '5,5% (taux réduit)' }
  ], '20'));
  var tvaInfo = el('div', { id: 'chTvaInfo', style: { fontSize: '11px', color: 'var(--success)', marginTop: '8px' } });
  tvaDetail.appendChild(tvaInfo);
  tvaSection.appendChild(tvaDetail);
  tvaCheckbox.onchange = function() {
    tvaDetail.style.display = tvaCheckbox.checked ? 'block' : 'none';
    updateTvaInfo();
  };
  var updateTvaInfo = function() {
    var montantTTC = parseFloat($('#chMontant') ? $('#chMontant').value : 0) || 0;
    var rate = parseFloat($('#chTvaRate') ? $('#chTvaRate').value : 20) || 20;
    if (montantTTC > 0 && tvaCheckbox.checked) {
      var ht = Math.round(montantTTC / (1 + rate / 100) * 100) / 100;
      var tva = Math.round((montantTTC - ht) * 100) / 100;
      tvaInfo.textContent = 'HT: ' + ht.toFixed(2) + ' € · TVA récupérable: ' + tva.toFixed(2) + ' €';
    } else {
      tvaInfo.textContent = '';
    }
  };
  content.appendChild(tvaSection);
  // Mettre à jour l'info TVA quand le montant change
  setTimeout(function() {
    var montantInput = $('#chMontant');
    if (montantInput) montantInput.addEventListener('input', updateTvaInfo);
    var rateSelect = $('#chTvaRate');
    if (rateSelect) rateSelect.addEventListener('change', updateTvaInfo);
  }, 50);

  content.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '20px' }, onclick: function() {
    var montant = parseFloat($('#chMontant').value) || 0;
    var isTTC = tvaCheckbox.checked;
    var tvaRate = parseFloat($('#chTvaRate') ? $('#chTvaRate').value : 0) || 0;
    var montantHT = montant;
    var tvaDeductible = 0;
    if (isTTC && tvaRate > 0) {
      montantHT = Math.round(montant / (1 + tvaRate / 100) * 100) / 100;
      tvaDeductible = Math.round((montant - montantHT) * 100) / 100;
    }
    var mv = { id: 'CH' + Date.now(), type: 'Charge', categorie: $('#chCat').value, description: $('#chDesc').value, montant: montantHT, montantTTC: isTTC ? montant : montantHT, tvaDeductible: tvaDeductible, tvaRate: isTTC ? tvaRate : 0, mois: $('#chMois').value, date: localISO(TODAY) };
    TREASURY.mouvements.push(mv);
    saveAll(); closeModal('formModal'); render();
    toast('Charge ajoutée' + (tvaDeductible > 0 ? ' (TVA ' + tvaDeductible.toFixed(2) + '€ déductible)' : ''), 'success');
  } }, '✅ Ajouter'));
}

function showChargeRecurrente() {
  $('#tabPonctuelle').classList.remove('active');
  $('#tabRecurrente').classList.add('active');
  var content = $('#chargeFormContent');
  content.innerHTML = '';
  
  content.appendChild(el('div', { style: { background: 'var(--info-glow)', padding: '12px', borderRadius: 'var(--radius-md)', marginBottom: '16px', fontSize: '12px' } }, 
    '💡 La charge sera créée automatiquement chaque mois de la période sélectionnée'));
  
  content.appendChild(createSelect('Catégorie', 'chCat', CHARGE_CATEGORIES, 'RC Pro'));
  content.appendChild(createInput('Description', 'text', 'chDesc', '', 'Ex: Assurance HISCOX'));
  content.appendChild(createInput('Montant mensuel (€)', 'number', 'chMontant', ''));
  content.appendChild(createInput('Du mois', 'month', 'chDebut', ym(TODAY.getFullYear(), 0)));
  content.appendChild(createInput('Au mois', 'month', 'chFin', ym(TODAY.getFullYear(), 11)));
  
  content.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '20px' }, onclick: function() {
    var cat = $('#chCat').value;
    var desc = $('#chDesc').value;
    var montant = parseFloat($('#chMontant').value) || 0;
    var debut = $('#chDebut').value;
    var fin = $('#chFin').value;
    
    if (montant <= 0) { toast('Montant invalide', 'error'); return; }
    if (debut > fin) { toast('La date de fin doit être après la date de début', 'error'); return; }
    
    // Créer une charge pour chaque mois
    var count = 0;
    var current = debut;
    while (current <= fin) {
      var mv = { 
        id: 'CHR' + Date.now() + '-' + count, 
        type: 'Charge', 
        categorie: cat, 
        description: desc + ' (récurrent)', 
        montant: montant, 
        mois: current, 
        date: localISO(TODAY),
        recurrent: true
      };
      TREASURY.mouvements.push(mv);
      
      // Passer au mois suivant
      var parts = current.split('-');
      var y = parseInt(parts[0]);
      var m = parseInt(parts[1]) - 1;
      m++;
      if (m > 11) { m = 0; y++; }
      current = ym(y, m);
      count++;
    }
    
    saveAll(); closeModal('formModal'); render();
    toast(count + ' charges récurrentes créées', 'success');
  } }, '🔄 Créer ' + 'les charges'));
  
  // Liste des charges récurrentes existantes
  var recurrents = TREASURY.mouvements.filter(function(mv) { return mv.recurrent; });
  if (recurrents.length > 0) {
    content.appendChild(el('div', { style: { marginTop: '24px', paddingTop: '16px', borderTop: '1px solid var(--glass-border)' } }));
    content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '10px' } }, '📋 Charges récurrentes existantes'));
    
    // Grouper par catégorie/desc
    var groups = {};
    recurrents.forEach(function(mv) {
      var key = mv.categorie + '|' + (mv.description || '');
      if (!groups[key]) groups[key] = { cat: mv.categorie, desc: mv.description, items: [] };
      groups[key].items.push(mv);
    });
    
    Object.keys(groups).forEach(function(key) {
      var g = groups[key];
      var total = g.items.reduce(function(a, m) { return a + m.montant; }, 0);
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-sm)', marginBottom: '6px' } });
      row.appendChild(el('div', {}, [
        el('div', { style: { fontSize: '12px', fontWeight: '600' } }, g.cat),
        el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, g.items.length + ' mois · ' + EUR(g.items[0].montant) + '/mois')
      ]));
      row.appendChild(el('button', { class: 'btn btn-sm btn-danger', style: { padding: '4px 8px', fontSize: '10px' }, onclick: function() {
        if (confirm('Supprimer toutes les charges "' + g.cat + '" récurrentes ?')) {
          g.items.forEach(function(item) {
            var idx = TREASURY.mouvements.findIndex(function(m) { return m.id === item.id; });
            if (idx >= 0) TREASURY.mouvements.splice(idx, 1);
          });
          saveAll(); showChargeModal(); render();
          toast('Charges supprimées', 'success');
        }
      } }, '🗑️'));
      content.appendChild(row);
    });
  }
}

function showSalaireModal(montant) {
  var data = compute();
  $('#formModalTitle').textContent = '💸 Verser un Salaire';
  var body = $('#formModalBody');
  body.innerHTML = '';
  var info = el('div', { style: { background: 'var(--success-glow)', padding: '14px', borderRadius: 'var(--radius-md)', marginBottom: '16px' } });
  info.innerHTML = '<strong>💡 Recommandation</strong><br>Cash dispo: ' + EUR(data.cashDispoAbsolu) + ' → Suggéré: <strong>' + EUR(data.salaireReco) + '</strong>';
  body.appendChild(info);
  body.appendChild(createInput('Montant (€)', 'number', 'salMontant', montant || data.salaireReco || ''));
  body.appendChild(createInput('Mois', 'month', 'salMois', ym(TODAY.getFullYear(), TODAY.getMonth())));
  body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '20px' }, onclick: function() {
    var mv = { id: 'SAL' + Date.now(), type: 'Salaire', montant: parseFloat($('#salMontant').value) || 0, mois: $('#salMois').value, date: localISO(TODAY) };
    TREASURY.mouvements.push(mv);
    saveAll(); closeModal('formModal'); render();
    toast('Salaire versé!', 'success');
  } }, '💸 Verser'));
  openModal('formModal');
}

// V66: Éditer un mouvement (charge ou salaire)
function editMovement(mvId) {
  var mv = TREASURY.mouvements.find(function(m) { return m.id === mvId; });
  if (!mv) { toast('Mouvement non trouvé', 'error'); return; }

  $('#formModalTitle').textContent = '✏️ Modifier ' + (mv.type === 'Salaire' ? 'Salaire' : 'Charge');
  var body = $('#formModalBody');
  body.innerHTML = '';

  if (mv.type === 'Salaire') {
    body.appendChild(createInput('Montant (€)', 'number', 'editMontant', mv.montant));
    body.appendChild(createInput('Mois', 'month', 'editMois', mv.mois));
  } else {
    // Charge
    var catSelect = el('select', { id: 'editCat', class: 'form-control', style: { marginBottom: '12px' } });
    ['URSSAF', 'CFP', 'CFE', 'TVA', 'Assurance', 'Comptabilité', 'Logiciel', 'Matériel', 'Transport', 'Repas', 'Télécom', 'Formation', 'Marketing', 'Autre'].forEach(function(c) {
      var opt = el('option', { value: c }, c);
      if (mv.categorie === c) opt.selected = true;
      catSelect.appendChild(opt);
    });
    body.appendChild(el('label', { style: { fontSize: '12px', marginBottom: '4px', display: 'block' } }, 'Catégorie'));
    body.appendChild(catSelect);
    body.appendChild(createInput('Description', 'text', 'editDesc', mv.description || ''));
    body.appendChild(createInput('Montant HT (€)', 'number', 'editMontant', mv.montant));
    body.appendChild(createInput('Mois', 'month', 'editMois', mv.mois));
  }

  // Boutons
  var btns = el('div', { style: { display: 'flex', gap: '8px', marginTop: '20px' } });

  btns.appendChild(el('button', { class: 'btn btn-success', style: { flex: '1' }, onclick: function() {
    mv.montant = parseFloat($('#editMontant').value) || 0;
    mv.mois = $('#editMois').value;
    if (mv.type !== 'Salaire') {
      mv.categorie = $('#editCat').value;
      mv.description = $('#editDesc').value;
    }
    saveAll();
    closeModal('formModal');
    render();
    toast('Modification enregistrée', 'success');
  } }, '💾 Sauvegarder'));

  btns.appendChild(el('button', { class: 'btn btn-danger', onclick: function() {
    if (confirm('Supprimer définitivement ?')) {
      deleteMovement(mvId);
      closeModal('formModal');
      render();
    }
  } }, '🗑️ Supprimer'));

  body.appendChild(btns);
  openModal('formModal');
}

// V66: Supprimer un mouvement
function deleteMovement(mvId) {
  var idx = TREASURY.mouvements.findIndex(function(m) { return m.id === mvId; });
  if (idx >= 0) {
    TREASURY.mouvements.splice(idx, 1);
    // V68: Retirer aussi du statut payé si présent (paidCharges est un objet, pas un tableau)
    if (TREASURY.paidCharges[mvId]) {
      delete TREASURY.paidCharges[mvId];
    }
    saveAll();
    toast('Élément supprimé', 'info');
  }
}

function showMonthCongesModal(monthYm) {
  $('#formModalTitle').textContent = '📅 Congés - ' + fmtMonth(monthYm);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Tableau des missions pour ce mois
  var hasMissions = false;
  MISSIONS.forEach(function(m) {
    if (!m.lignes) return;
    var ligne = m.lignes.find(function(l) { return l.ym === monthYm; });
    if (ligne) {
      hasMissions = true;
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-md)', marginBottom: '8px' } });
      row.appendChild(el('div', { style: { flex: '1' } }, [el('div', { style: { fontWeight: '700' } }, m.client), el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Ouvrés: ' + ligne.joursOuvrables + 'j · Prévus: ' + (ligne.joursPrevus || ligne.joursOuvrables) + 'j')]));
      var input = el('input', { type: 'number', class: 'form-input', style: { width: '60px', textAlign: 'center' }, value: ligne.conges || 0, min: 0, 'data-mission': m.id });
      row.appendChild(input);
      row.appendChild(el('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'congés'));
      body.appendChild(row);
    }
  });
  
  if (!hasMissions) {
    body.appendChild(el('div', { style: { textAlign: 'center', padding: '24px', color: 'var(--text-muted)' } }, 'Aucune mission ce mois'));
    openModal('formModal');
    return;
  }
  
  body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '16px' }, onclick: function() {
    MISSIONS.forEach(function(m) {
      var input = $('input[data-mission="' + m.id + '"]');
      if (input && m.lignes) {
        var ligne = m.lignes.find(function(l) { return l.ym === monthYm; });
        if (ligne) {
          ligne.conges = parseInt(input.value) || 0;
          ligne.joursReels = Math.max(0, (ligne.joursPrevus || 0) - ligne.conges);
        }
        buildMission(m);
      }
    });
    saveAll(); closeModal('formModal'); render();
    toast('Congés enregistrés', 'success');
  } }, '✅ Enregistrer'));
  
  openModal('formModal');
}

function showCongesOverview() {
  var data = compute();
  $('#formModalTitle').textContent = '📅 Vue Congés';
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  var months = getPeriodMonths();

  var table = el('table', { class: 'days-table' });
  var thead = el('thead');
  var headerRow = el('tr');
  headerRow.appendChild(el('th', {}, 'Mois'));
  headerRow.appendChild(el('th', {}, 'Ouvrés'));
  headerRow.appendChild(el('th', {}, 'Congés'));
  headerRow.appendChild(el('th', {}, 'Travaillés'));
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  var tbody = el('tbody');
  var totalOuvres = 0, totalConges = 0, totalTravailles = 0;
  
  months.forEach(function(m) {
    var wd = data.workedDays[m];
    totalOuvres += wd.ouvrables;
    totalConges += wd.conges;
    totalTravailles += wd.reels;
    
    var tr = el('tr', { style: { cursor: 'pointer' }, onclick: function() { closeModal('formModal'); showMonthCongesModal(m); } });
    tr.appendChild(el('td', { class: 'month-cell' }, fmtMonthShort(m)));
    tr.appendChild(el('td', {}, String(wd.ouvrables)));
    tr.appendChild(el('td', { style: { color: wd.conges > 0 ? 'var(--warning)' : '' } }, String(wd.conges)));
    tr.appendChild(el('td', { class: 'computed' }, String(wd.reels)));
    tbody.appendChild(tr);
  });
  
  var totalRow = el('tr', { class: 'total-row' });
  totalRow.appendChild(el('td', {}, 'TOTAL'));
  totalRow.appendChild(el('td', {}, String(totalOuvres)));
  totalRow.appendChild(el('td', {}, String(totalConges)));
  totalRow.appendChild(el('td', {}, String(totalTravailles)));
  tbody.appendChild(totalRow);
  table.appendChild(tbody);
  body.appendChild(table);
  
  body.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '12px', textAlign: 'center' } }, 'Clique sur un mois pour modifier les congés'));
  
  openModal('formModal');
}

function showFactureModal(facture) {
  $('#formModalTitle').textContent = '📄 ' + facture.client + ' · ' + fmtMonthShort(facture.mois);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Trouver la mission associée
  var mission = MISSIONS.find(function(m) { return m.factures && m.factures.some(function(f) { return f.id === facture.id; }); });
  
  var info = el('div', { class: 'card', style: { marginBottom: '16px' } });
  info.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Période'), el('span', {}, fmtMonth(facture.mois))]));
  info.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Jours'), el('span', {}, facture.jours + 'j')]));
  info.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Montant HT'), el('span', { style: { fontWeight: '700' } }, EUR(facture.ht))]));
  if (facture.tva > 0) {
    info.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'TVA'), el('span', {}, EUR(facture.tva))]));
    info.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'TTC'), el('span', { style: { fontWeight: '700' } }, EUR(facture.ttc))]));
  }
  info.appendChild(el('div', { class: 'detail-row' }, [el('span', {}, 'Paiement attendu'), el('span', {}, fmtMonth(facture.paymentMonth))]));
  body.appendChild(info);
  
  body.appendChild(createSelect('Statut', 'fStatus', [
    { value: 'brouillon', label: '📝 Brouillon' }, { value: 'envoyée', label: '📤 Envoyée' }, { value: 'payée', label: '✅ Payée' }
  ], facture.status));
  
  // Boutons
  var btns = el('div', { style: { display: 'flex', gap: '10px', marginTop: '20px' } });
  btns.appendChild(el('button', { class: 'btn btn-success', style: { flex: '1' }, onclick: function() { setFactureStatus(facture.id, $('#fStatus').value); closeModal('formModal'); } }, '✅ Mettre à jour'));
  
  // Bouton PDF
  if (mission) {
    btns.appendChild(el('button', { class: 'btn', style: { background: 'var(--info)', color: 'white' }, onclick: function() { 
      closeModal('formModal'); 
      showInvoiceGeneratorModal(mission, facture.mois); 
    } }, '📄 Facture'));
  }
  body.appendChild(btns);
  
  openModal('formModal');
}

// Modal pour personnaliser et générer la facture PDF
function showInvoiceGeneratorModal(mission, monthYm) {
  var ligne = mission.lignes ? mission.lignes.find(function(l) { return l.ym === monthYm; }) : null;
  if (!ligne) { toast('Aucune donnée pour ce mois', 'error'); return; }
  
  var jours = ligne.joursReels || ligne.joursPrevus || 0;
  var totalHT = jours * mission.tjm;
  var tvaApplicable = isTVAApplicable(monthYm + '-01');
  var tvaAmount = tvaApplicable ? Math.round(totalHT * LEGAL.tvaRate) : 0;
  var totalTTC = totalHT + tvaAmount;
  
  // Numérotation séquentielle automatique
  // Si la facture a déjà un numéro définitif, le réutiliser
  var hasDefinitiveNumber = ligne.invoiceFinalized && ligne.lastInvoiceNum;
  var defaultNum = hasDefinitiveNumber ? ligne.lastInvoiceNum : reserveInvoiceNumber(TODAY.getFullYear());
  var defaultDate = ligne.lastInvoiceDate || localISO(TODAY);
  var defaultCommande = ligne.numeroCommande || mission.numeroCommande || '';
  var defaultDelai = mission.delaiPaiementFacture || 30;
  
  $('#formModalTitle').textContent = '📄 Facture ' + mission.client + ' - ' + fmtMonth(monthYm);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Avertissement si numéro déjà finalisé
  if (hasDefinitiveNumber) {
    var lockedInfo = el('div', { style: { background: 'var(--success-glow)', padding: '10px', borderRadius: 'var(--radius-sm)', marginBottom: '12px', fontSize: '11px' } });
    lockedInfo.innerHTML = '🔒 Facture n°' + ligne.lastInvoiceNum + ' déjà enregistrée dans le livre des recettes';
    body.appendChild(lockedInfo);
  }
  
  // Aperçu montants
  var summary = el('div', { style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: 'var(--radius-md)', marginBottom: '12px', textAlign: 'center' } });
  summary.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, jours + ' jours × ' + EUR(mission.tjm)));
  summary.appendChild(el('div', { style: { fontSize: '20px', fontWeight: '700', color: 'var(--success)' } }, EUR(totalTTC) + ' TTC'));
  summary.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, EUR(totalHT) + ' HT' + (tvaApplicable ? ' + ' + EUR(tvaAmount) + ' TVA' : '')));
  body.appendChild(summary);
  
  // Champs facture
  var fieldsDiv = el('div', { style: { background: 'var(--bg-secondary)', padding: '12px', borderRadius: 'var(--radius-md)', marginBottom: '12px' } });
  
  // N° Facture (lecture seule si finalisé)
  var numInput = createInput('N° Facture', 'text', 'invNum', defaultNum);
  if (hasDefinitiveNumber) {
    numInput.querySelector('input').readOnly = true;
    numInput.querySelector('input').style.opacity = '0.7';
  }
  
  fieldsDiv.appendChild(el('div', { class: 'form-row' }, [
    numInput,
    createInput('Date émission', 'date', 'invDate', defaultDate)
  ]));
  
  // Ajout délai de paiement configurable
  fieldsDiv.appendChild(el('div', { class: 'form-row' }, [
    createInput('N° Commande client', 'text', 'invCommande', defaultCommande, 'Ex: 10004903'),
    createInput('Délai paiement (jours)', 'number', 'invDelai', defaultDelai)
  ]));
  
  body.appendChild(fieldsDiv);
  
  // Vérification infos entreprise
  var missingInfos = [];
  if (!COMPANY.nom) missingInfos.push('Nom');
  if (!COMPANY.siret) missingInfos.push('SIRET');
  if (!COMPANY.adresse) missingInfos.push('Adresse');
  
  if (missingInfos.length > 0) {
    var warning = el('div', { style: { background: 'var(--warning-glow)', padding: '10px', borderRadius: 'var(--radius-sm)', marginBottom: '12px', fontSize: '10px' } });
    warning.innerHTML = '⚠️ Infos manquantes: ' + missingInfos.join(', ') + ' → Compléter dans Admin';
    body.appendChild(warning);
  }
  
  // Instructions
  body.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '12px', textAlign: 'center' } }, '💡 Le numéro sera verrouillé après génération (Art. L441-9)'));
  
  // Bouton générer
  body.appendChild(el('button', { class: 'btn btn-success btn-block', onclick: function() {
    var invoiceNum = $('#invNum').value;
    var invoiceDate = $('#invDate').value;
    var delaiPaiement = parseInt($('#invDelai').value) || 30;
    
    // Si pas encore finalisé, enregistrer le numéro définitif
    if (!hasDefinitiveNumber) {
      // Utiliser le numéro séquentiel officiel
      invoiceNum = getNextInvoiceNumber(TODAY.getFullYear());
      
      // Enregistrer dans le livre des recettes
      registerInvoice({
        numero: invoiceNum,
        date: invoiceDate,
        client: mission.client,
        nature: mission.descriptifFacture || 'Prestation de service',
        montantHT: totalHT,
        tva: tvaAmount,
        montantTTC: totalTTC,
        missionId: mission.id,
        mois: monthYm
      });
      
      // Marquer comme finalisé
      ligne.invoiceFinalized = true;
    }
    
    var opts = {
      invoiceNum: invoiceNum,
      invoiceDate: invoiceDate,
      numeroCommande: $('#invCommande').value,
      delaiPaiement: delaiPaiement
    };
    
    // Sauvegarder les valeurs dans la ligne
    ligne.lastInvoiceNum = opts.invoiceNum;
    ligne.lastInvoiceDate = opts.invoiceDate;
    ligne.numeroCommande = opts.numeroCommande;
    mission.delaiPaiementFacture = delaiPaiement;
    saveAll();
    
    openInvoiceHTML(mission, monthYm, opts);
    closeModal('formModal');
  } }, hasDefinitiveNumber ? '📄 Régénérer Facture' : '📄 Générer & Enregistrer'));
  
  openModal('formModal');
}

// Générer et afficher la facture avec preview
function openInvoiceHTML(mission, monthYm, options) {
  var ligne = mission.lignes.find(function(l) { return l.ym === monthYm; });
  if (!ligne) { toast('Aucune donnée pour ce mois', 'error'); return; }
  
  var jours = ligne.joursReels || ligne.joursPrevus || 0;
  var totalHT = jours * mission.tjm;
  var tvaApplicable = isTVAApplicable(monthYm + '-01');
  var tvaAmount = tvaApplicable ? Math.round(totalHT * LEGAL.tvaRate) : 0;
  var totalTTC = totalHT + tvaAmount;
  
  var invoiceNum = options.invoiceNum || '';
  var invoiceDate = options.invoiceDate || localISO(TODAY);
  var numCommande = options.numeroCommande || '';
  var delaiPaiement = options.delaiPaiement || 30;
  
  // Calcul de la date d'échéance
  var dateEcheance = calculatePaymentDeadline(invoiceDate, delaiPaiement);
  
  var p = parseYM(monthYm);
  var moisNom = new Date(p.y, p.m).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  moisNom = moisNom.charAt(0).toUpperCase() + moisNom.slice(1);
  
  var finMois = new Date(p.y, p.m + 1, 0).getDate();
  var jourFin = Math.min(jours, finMois) || finMois;
  var siren = COMPANY.siret ? COMPANY.siret.substring(0, 9) : '';
  
  var titre = mission.client || '';
  if (numCommande) titre += ' - Commande n°' + numCommande;
  titre += ' - ' + moisNom;
  
  var descriptif = mission.descriptifFacture || ('Prestation de service consultant ' + (mission.titre || ''));
  var periode = 'du 01 au ' + String(jourFin).padStart(2, '0') + ' ' + moisNom.split(' ')[0] + ' ' + p.y;
  
  // Données facture pour l'affichage
  var invoiceData = {
    num: invoiceNum,
    date: fmtDate(invoiceDate),
    dateEcheance: fmtDate(dateEcheance), // Ajout échéance
    delaiPaiement: delaiPaiement, // Délai en jours
    client: mission.client || '',
    adresseClient: mission.adresseClient || '',
    emetteur: COMPANY.nom || '',
    adresseEmetteur: (COMPANY.adresse || '') + (COMPANY.codePostal ? ', ' + COMPANY.codePostal : '') + (COMPANY.commune ? ' ' + COMPANY.commune : ''),
    siret: COMPANY.siret || '',
    siren: siren,
    tvaIntra: COMPANY.tvaIntracom || '',
    iban: COMPANY.iban || '',
    titre: titre,
    descriptif: descriptif,
    periode: periode,
    jours: jours,
    tjm: mission.tjm,
    totalHT: totalHT,
    tvaRate: tvaApplicable ? 20 : 0,
    tvaAmount: tvaAmount,
    totalTTC: totalTTC,
    numCommande: numCommande
  };
  
  // Créer l'overlay de prévisualisation
  showInvoicePreview(invoiceData);
}

// Afficher l'overlay de prévisualisation de facture
function showInvoicePreview(data) {
  // Supprimer overlay existant
  var existing = document.getElementById('invoicePreviewOverlay');
  if (existing) existing.remove();
  
  var overlay = document.createElement('div');
  overlay.id = 'invoicePreviewOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;flex-direction:column;overflow:auto;';
  
  // Toolbar
  var toolbar = document.createElement('div');
  toolbar.style.cssText = 'background:#1a1a2e;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #333;position:sticky;top:0;z-index:1;';
  toolbar.innerHTML = '<div style="display:flex;align-items:center;gap:12px;"><span style="font-size:18px;">📄</span><span style="font-weight:600;color:#fff;">Facture ' + data.num + '</span><span style="font-size:11px;color:#888;">Ctrl+P pour imprimer/PDF</span></div>';
  
  var btns = document.createElement('div');
  btns.style.cssText = 'display:flex;gap:10px;';
  
  var btnHTML = document.createElement('button');
  btnHTML.textContent = '📥 Télécharger HTML';
  btnHTML.style.cssText = 'background:linear-gradient(135deg,#00d9ff,#0099ff);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;';
  btnHTML.onclick = function() { downloadInvoiceHTML(data); };
  
  var btnClose = document.createElement('button');
  btnClose.textContent = '✕';
  btnClose.style.cssText = 'background:#444;color:#fff;border:none;width:36px;height:36px;border-radius:8px;cursor:pointer;font-size:16px;';
  btnClose.onclick = function() { overlay.remove(); };
  
  btns.appendChild(btnHTML);
  btns.appendChild(btnClose);
  toolbar.appendChild(btns);
  overlay.appendChild(toolbar);
  
  // Container facture
  var container = document.createElement('div');
  container.style.cssText = 'flex:1;display:flex;justify-content:center;padding:20px;';
  
  var invoice = document.createElement('div');
  invoice.style.cssText = 'background:#fff;width:210mm;min-height:297mm;padding:20mm;box-sizing:border-box;color:#000;font-family:Arial,sans-serif;font-size:10pt;box-shadow:0 0 30px rgba(0,0,0,0.3);';
  
  // Contenu de la facture
  invoice.innerHTML = generateInvoiceHTMLContent(data);
  
  container.appendChild(invoice);
  overlay.appendChild(container);
  document.body.appendChild(overlay);
  
  // Fermer avec Escape
  var escHandler = function(e) { if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', escHandler); } };
  document.addEventListener('keydown', escHandler);
}

// Générer le contenu HTML de la facture (pour preview)
function generateInvoiceHTMLContent(d) {
  var fmtEur = function(n) { return n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €'; };
  
  return '<div style="display:flex;justify-content:space-between;margin-bottom:25px;">' +
    // Emetteur (gauche)
    '<div style="flex:1;">' +
      '<div style="font-size:14pt;font-weight:bold;color:#1a1a2e;margin-bottom:8px;">Entreprise individuelle</div>' +
      '<div style="font-size:12pt;font-weight:bold;margin-bottom:4px;">' + d.emetteur + '</div>' +
      '<div style="color:#555;font-size:9pt;line-height:1.5;">' +
        (d.adresseEmetteur ? d.adresseEmetteur + '<br>' : '') +
        'France<br>' +
        (d.siret ? 'SIRET: ' + d.siret + '<br>' : '') +
        (d.tvaIntra ? 'TVA Intra: ' + d.tvaIntra : '') +
      '</div>' +
    '</div>' +
    // Client (droite)
    '<div style="background:#f0f4f8;border-left:4px solid #0099ff;padding:15px;min-width:200px;">' +
      '<div style="font-size:9pt;color:#666;margin-bottom:4px;">FACTURER À</div>' +
      '<div style="font-weight:bold;font-size:11pt;">' + d.client + '</div>' +
      (d.adresseClient ? '<div style="color:#555;font-size:9pt;margin-top:4px;">' + d.adresseClient.replace(/,/g, '<br>') + '</div>' : '') +
    '</div>' +
  '</div>' +
  // Infos facture
  '<div style="display:flex;gap:30px;margin-bottom:20px;font-size:10pt;padding:12px;background:#f8f9fa;border-radius:6px;">' +
    '<div><span style="color:#666;">Facture N° </span><strong style="color:#1a1a2e;">' + d.num + '</strong></div>' +
    '<div><span style="color:#666;">Date: </span><strong>' + d.date + '</strong></div>' +
    '<div><span style="color:#666;">Échéance: </span><strong style="color:#c53030;">' + d.dateEcheance + '</strong></div>' +
    (d.numCommande ? '<div><span style="color:#666;">Réf. commande: </span><strong>' + d.numCommande + '</strong></div>' : '') +
  '</div>' +
  // Titre
  '<div style="font-size:11pt;font-weight:bold;color:#1a1a2e;margin-bottom:15px;">' + d.titre + '</div>' +
  // Tableau prestations avec totaux intégrés
  '<table style="width:100%;border-collapse:collapse;margin-bottom:20px;">' +
    '<thead><tr style="background:#1a1a2e;color:#fff;">' +
      '<th style="padding:10px;text-align:left;font-weight:500;">Désignation</th>' +
      '<th style="padding:10px;text-align:center;width:50px;font-weight:500;">Qté</th>' +
      '<th style="padding:10px;text-align:center;width:50px;font-weight:500;">Unité</th>' +
      '<th style="padding:10px;text-align:right;width:80px;font-weight:500;">P.U. HT</th>' +
      '<th style="padding:10px;text-align:center;width:45px;font-weight:500;">TVA</th>' +
      '<th style="padding:10px;text-align:right;width:90px;font-weight:500;">Montant HT</th>' +
    '</tr></thead>' +
    '<tbody>' +
      '<tr style="border-bottom:1px solid #eee;">' +
        '<td style="padding:12px 10px;vertical-align:top;">' +
          '<div style="font-weight:500;">' + d.descriptif + '</div>' +
          '<div style="font-size:9pt;color:#666;margin-top:4px;">Période: ' + d.periode + '</div>' +
        '</td>' +
        '<td style="padding:12px 10px;text-align:center;">' + d.jours + '</td>' +
        '<td style="padding:12px 10px;text-align:center;">jour(s)</td>' +
        '<td style="padding:12px 10px;text-align:right;">' + fmtEur(d.tjm) + '</td>' +
        '<td style="padding:12px 10px;text-align:center;">' + d.tvaRate + '%</td>' +
        '<td style="padding:12px 10px;text-align:right;font-weight:500;">' + fmtEur(d.totalHT) + '</td>' +
      '</tr>' +
      // Ligne vide séparatrice
      '<tr><td colspan="6" style="padding:5px;"></td></tr>' +
      // Total HT
      '<tr style="background:#f8f9fa;">' +
        '<td colspan="4"></td>' +
        '<td style="padding:8px 10px;text-align:right;font-weight:500;color:#666;">Total HT</td>' +
        '<td style="padding:8px 10px;text-align:right;font-weight:600;">' + fmtEur(d.totalHT) + '</td>' +
      '</tr>' +
      // TVA
      '<tr style="background:#f8f9fa;">' +
        '<td colspan="4"></td>' +
        '<td style="padding:8px 10px;text-align:right;font-weight:500;color:#666;">TVA ' + d.tvaRate + '%</td>' +
        '<td style="padding:8px 10px;text-align:right;font-weight:600;">' + fmtEur(d.tvaAmount) + '</td>' +
      '</tr>' +
      // Total TTC
      '<tr style="background:#1a1a2e;color:#fff;">' +
        '<td colspan="4"></td>' +
        '<td style="padding:10px;text-align:right;font-weight:bold;">TOTAL TTC</td>' +
        '<td style="padding:10px;text-align:right;font-weight:bold;font-size:12pt;">' + fmtEur(d.totalTTC) + '</td>' +
      '</tr>' +
    '</tbody>' +
  '</table>' +
  // Coordonnées bancaires
  (d.iban ? '<div style="background:#f8f9fa;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:20px;">' +
    '<div style="font-weight:bold;margin-bottom:8px;font-size:10pt;">💳 Coordonnées bancaires</div>' +
    '<div style="font-family:monospace;font-size:11pt;letter-spacing:1px;">' + d.iban + '</div>' +
  '</div>' : '') +
  // Mentions légales - SPRINT 1: Conditions de paiement complètes (Art. L441-9)
  '<div style="font-size:8pt;color:#888;line-height:1.6;border-top:1px solid #ddd;padding-top:15px;">' +
    '<div style="margin-bottom:8px;"><strong>Conditions de paiement:</strong> Paiement à ' + (d.delaiPaiement || 30) + ' jours à compter de la date de facturation. Date d\'échéance: ' + d.dateEcheance + '</div>' +
    '<div style="margin-bottom:8px;">En cas de retard de paiement, une pénalité de 3 fois le taux d\'intérêt légal sera appliquée (taux BCE + 10 points), ' +
    'à laquelle s\'ajoutera une indemnité forfaitaire pour frais de recouvrement de 40 €. Pas d\'escompte pour paiement anticipé.</div>' +
    '<div>SIREN ' + d.siren + ' - RCS TOULOUSE - APE 6201Z</div>' +
    (d.tvaRate === 0 ? '<div style="font-weight:500;margin-top:4px;">TVA non applicable, article 293 B du CGI</div>' : '') +
  '</div>';
}

// Télécharger la facture - PDF si possible, sinon HTML
function downloadInvoiceHTML(data) {
  // Tenter d'abord jsPDF (fonctionne en local)
  if (window.jspdf && window.jspdf.jsPDF) {
    try {
      generateAndDownloadPDF(data);
      return;
    } catch(e) { console.error('PDF generation failed:', e); }
  }
  
  // Fallback: télécharger en HTML
  downloadInvoiceAsHTML(data);
}

// Générer et télécharger le PDF avec jsPDF
function generateAndDownloadPDF(data) {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF();
  var fmtN = function(n) { return (n == null || isNaN(n) ? 0 : n).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}); };
  
  // === EN-TÊTE ÉMETTEUR (gauche) ===
  doc.setFontSize(13);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(26, 26, 46);
  doc.text('Entreprise individuelle', 20, 22);
  
  doc.setFontSize(11);
  doc.text(data.emetteur, 20, 30);
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(100);
  var yE = 38;
  if (data.adresseEmetteur) {
    var addrLines = data.adresseEmetteur.split(',');
    addrLines.forEach(function(line) {
      doc.text(line.trim(), 20, yE);
      yE += 5;
    });
  }
  doc.text('France', 20, yE); yE += 5;
  if (data.siret) { doc.text('SIRET: ' + data.siret, 20, yE); yE += 5; }
  if (data.tvaIntra) { doc.text('TVA Intra: ' + data.tvaIntra, 20, yE); }
  
  // === CLIENT (droite) ===
  doc.setFillColor(240, 244, 248);
  doc.rect(120, 18, 75, 30, 'F');
  doc.setFillColor(0, 153, 255);
  doc.rect(120, 18, 3, 30, 'F');
  
  doc.setFontSize(8);
  doc.setTextColor(100);
  doc.text('FACTURER A', 128, 25);
  
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(0);
  doc.text(data.client, 128, 33);
  
  if (data.adresseClient) {
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(80);
    var clientAddr = data.adresseClient.replace(/,/g, ' - ');
    if (clientAddr.length > 40) clientAddr = clientAddr.substring(0, 40) + '...';
    doc.text(clientAddr, 128, 41);
  }
  
  // === INFOS FACTURE ===
  var yInfo = 60;
  doc.setFillColor(248, 249, 250);
  doc.rect(20, yInfo - 5, 175, 18, 'F');
  
  doc.setFontSize(9);
  doc.setTextColor(100);
  doc.setFont('helvetica', 'normal');
  doc.text('Facture N.', 25, yInfo + 2);
  doc.text('Date:', 70, yInfo + 2);
  doc.text('Echeance:', 115, yInfo + 2);
  if (data.numCommande) doc.text('Ref. commande:', 155, yInfo + 2);
  
  doc.setTextColor(26, 26, 46);
  doc.setFont('helvetica', 'bold');
  doc.text(data.num, 25, yInfo + 8);
  doc.text(data.date, 70, yInfo + 8);
  doc.setTextColor(180, 0, 0); // Rouge pour l'échéance
  doc.text(data.dateEcheance || '30 jours', 115, yInfo + 8);
  doc.setTextColor(26, 26, 46);
  if (data.numCommande) doc.text(data.numCommande, 155, yInfo + 8);
  
  // === TITRE ===
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(26, 26, 46);
  var titreLines = doc.splitTextToSize(data.titre, 170);
  doc.text(titreLines, 20, 88);
  
  // === TABLEAU ===
  var tableY = 100;
  
  // Header
  doc.setFillColor(26, 26, 46);
  doc.rect(20, tableY, 175, 10, 'F');
  doc.setFontSize(8);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255);
  doc.text('Designation', 22, tableY + 7);
  doc.text('Qte', 110, tableY + 7);
  doc.text('Unite', 125, tableY + 7);
  doc.text('P.U. HT', 145, tableY + 7);
  doc.text('TVA', 165, tableY + 7);
  doc.text('Montant HT', 180, tableY + 7);
  
  // Ligne de données
  tableY += 12;
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(0);
  doc.setFontSize(9);
  
  var descLines = doc.splitTextToSize(data.descriptif, 85);
  descLines.forEach(function(line, idx) {
    doc.text(line, 22, tableY + 5 + (idx * 4));
  });
  
  doc.setFontSize(8);
  doc.setTextColor(100);
  doc.text('Periode: ' + data.periode, 22, tableY + 5 + descLines.length * 4 + 2);
  
  var dataY = tableY + 5 + Math.max(descLines.length * 4, 4);
  doc.setTextColor(0);
  doc.setFontSize(9);
  doc.text(String(data.jours), 110, dataY);
  doc.text('jour(s)', 125, dataY);
  doc.text(fmtN(data.tjm), 145, dataY);
  doc.text(data.tvaRate + '%', 165, dataY);
  doc.setFont('helvetica', 'bold');
  doc.text(fmtN(data.totalHT), 180, dataY);
  
  // Ligne séparation
  doc.setDrawColor(200);
  doc.line(20, dataY + 8, 195, dataY + 8);
  
  // === TOTAUX (dans le tableau) ===
  var totY = dataY + 16;
  
  // Total HT
  doc.setFillColor(248, 249, 250);
  doc.rect(120, totY - 4, 75, 10, 'F');
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(9);
  doc.setTextColor(100);
  doc.text('Total HT', 145, totY + 2);
  doc.setTextColor(0);
  doc.setFont('helvetica', 'bold');
  doc.text(fmtN(data.totalHT) + ' EUR', 192, totY + 2, { align: 'right' });
  
  // TVA
  totY += 10;
  doc.setFillColor(248, 249, 250);
  doc.rect(120, totY - 4, 75, 10, 'F');
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(100);
  doc.text('TVA ' + data.tvaRate + '%', 145, totY + 2);
  doc.setTextColor(0);
  doc.setFont('helvetica', 'bold');
  doc.text(fmtN(data.tvaAmount) + ' EUR', 192, totY + 2, { align: 'right' });
  
  // Total TTC
  totY += 10;
  doc.setFillColor(26, 26, 46);
  doc.rect(120, totY - 4, 75, 12, 'F');
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255);
  doc.text('TOTAL TTC', 145, totY + 3);
  doc.text(fmtN(data.totalTTC) + ' EUR', 192, totY + 3, { align: 'right' });
  
  // === COORDONNÉES BANCAIRES ===
  if (data.iban) {
    var ibanY = totY + 20;
    doc.setFillColor(248, 249, 250);
    doc.setDrawColor(200);
    doc.roundedRect(20, ibanY, 175, 16, 2, 2, 'FD');
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0);
    doc.text('Coordonnees bancaires', 25, ibanY + 6);
    
    doc.setFont('courier', 'normal');
    doc.setFontSize(10);
    doc.text(data.iban, 25, ibanY + 12);
  }
  
  // === FOOTER ===
  doc.setFontSize(7);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(130);
  // Conditions de paiement complètes
  doc.text('Conditions de paiement: ' + (data.delaiPaiement || 30) + ' jours. Echeance: ' + (data.dateEcheance || 'A reception'), 20, 250);
  doc.text('En cas de retard de paiement, une penalite de 3 fois le taux d\'interet legal sera appliquee (taux BCE + 10 pts),', 20, 255);
  doc.text('a laquelle s\'ajoutera une indemnite forfaitaire pour frais de recouvrement de 40 EUR. Pas d\'escompte pour paiement anticipe.', 20, 259);
  doc.text('SIREN ' + data.siren + ' - RCS TOULOUSE - APE 6201Z', 20, 265);
  if (data.tvaRate === 0) {
    doc.text('TVA non applicable, article 293 B du CGI', 20, 269);
  }
  
  // Télécharger
  doc.save('Facture-' + data.num + '.pdf');
  toast('PDF telecharge!', 'success');
}

// Fallback: télécharger en HTML
function downloadInvoiceAsHTML(data) {
  var fmtEur = function(n) { return n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' EUR'; };
  
  var htmlContent = '<!DOCTYPE html>\n<html lang="fr">\n<head>\n<meta charset="UTF-8">\n<title>Facture ' + data.num + '</title>\n' +
    '<style>\n' +
      '@page { size: A4; margin: 15mm; }\n' +
      '@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }\n' +
      'body { font-family: Arial, sans-serif; font-size: 10pt; color: #000; max-width: 210mm; margin: 0 auto; padding: 20mm; box-sizing: border-box; }\n' +
      '.header { display: flex; justify-content: space-between; margin-bottom: 25px; }\n' +
      '.emetteur { flex: 1; }\n' +
      '.emetteur h1 { font-size: 14pt; color: #1a1a2e; margin: 0 0 8px 0; }\n' +
      '.emetteur h2 { font-size: 12pt; margin: 0 0 4px 0; }\n' +
      '.emetteur p { color: #555; font-size: 9pt; line-height: 1.5; margin: 0; }\n' +
      '.client { background: #f0f4f8; border-left: 4px solid #0099ff; padding: 15px; min-width: 200px; }\n' +
      '.client-label { font-size: 9pt; color: #666; margin-bottom: 4px; }\n' +
      '.client-name { font-weight: bold; font-size: 11pt; }\n' +
      '.client-addr { color: #555; font-size: 9pt; margin-top: 4px; }\n' +
      '.info-bar { display: flex; gap: 30px; margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px; }\n' +
      '.info-bar span { color: #666; }\n' +
      '.info-bar strong { color: #1a1a2e; }\n' +
      '.titre { font-size: 11pt; font-weight: bold; color: #1a1a2e; margin-bottom: 15px; }\n' +
      'table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }\n' +
      'th { background: #1a1a2e; color: #fff; padding: 10px; font-weight: 500; }\n' +
      'td { padding: 10px; }\n' +
      '.total-row { background: #f8f9fa; }\n' +
      '.total-label { text-align: right; font-weight: 500; color: #666; }\n' +
      '.total-value { text-align: right; font-weight: 600; }\n' +
      '.grand-total { background: #1a1a2e; color: #fff; }\n' +
      '.grand-total td { padding: 10px; font-weight: bold; }\n' +
      '.iban { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; }\n' +
      '.footer { font-size: 8pt; color: #888; line-height: 1.6; border-top: 1px solid #ddd; padding-top: 15px; }\n' +
    '</style>\n</head>\n<body>\n' +
    '<div class="header">\n' +
      '<div class="emetteur"><h1>Entreprise individuelle</h1><h2>' + data.emetteur + '</h2>\n' +
        '<p>' + (data.adresseEmetteur || '') + '<br>France<br>' + (data.siret ? 'SIRET: ' + data.siret + '<br>' : '') + (data.tvaIntra ? 'TVA Intra: ' + data.tvaIntra : '') + '</p></div>\n' +
      '<div class="client"><div class="client-label">FACTURER A</div><div class="client-name">' + data.client + '</div>' + (data.adresseClient ? '<div class="client-addr">' + data.adresseClient.replace(/,/g, '<br>') + '</div>' : '') + '</div>\n' +
    '</div>\n' +
    '<div class="info-bar"><div><span>Facture N. </span><strong>' + data.num + '</strong></div><div><span>Date: </span><strong>' + data.date + '</strong></div><div><span>Echeance: </span><strong>30 jours</strong></div>' + (data.numCommande ? '<div><span>Ref: </span><strong>' + data.numCommande + '</strong></div>' : '') + '</div>\n' +
    '<div class="titre">' + data.titre + '</div>\n' +
    '<table><thead><tr><th style="text-align:left">Designation</th><th>Qte</th><th>Unite</th><th>P.U. HT</th><th>TVA</th><th style="text-align:right">Montant HT</th></tr></thead>\n' +
    '<tbody><tr style="border-bottom:1px solid #eee"><td>' + data.descriptif + '<br><small style="color:#666">Periode: ' + data.periode + '</small></td><td style="text-align:center">' + data.jours + '</td><td style="text-align:center">jour(s)</td><td style="text-align:right">' + fmtEur(data.tjm) + '</td><td style="text-align:center">' + data.tvaRate + '%</td><td style="text-align:right;font-weight:bold">' + fmtEur(data.totalHT) + '</td></tr>\n' +
    '<tr><td colspan="6"></td></tr>\n' +
    '<tr class="total-row"><td colspan="4"></td><td class="total-label">Total HT</td><td class="total-value">' + fmtEur(data.totalHT) + '</td></tr>\n' +
    '<tr class="total-row"><td colspan="4"></td><td class="total-label">TVA ' + data.tvaRate + '%</td><td class="total-value">' + fmtEur(data.tvaAmount) + '</td></tr>\n' +
    '<tr class="grand-total"><td colspan="4"></td><td style="text-align:right;color:#fff">TOTAL TTC</td><td style="text-align:right;font-size:12pt">' + fmtEur(data.totalTTC) + '</td></tr>\n' +
    '</tbody></table>\n' +
    (data.iban ? '<div class="iban"><strong>Coordonnees bancaires</strong><br><span style="font-family:monospace;font-size:11pt">' + data.iban + '</span></div>\n' : '') +
    '<div class="footer">En cas de retard de paiement, penalite de 3x le taux legal + 40 EUR de frais.<br>SIREN ' + data.siren + ' - RCS TOULOUSE' + (data.tvaRate === 0 ? '<br>TVA non applicable, article 293 B du CGI' : '') + '</div>\n' +
    '</body></html>';
  
  try {
    var blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'Facture-' + data.num + '.html';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    toast('HTML telecharge - Ouvrez en local pour PDF direct', 'info');
  } catch(e) {
    toast('Erreur: ' + e.message, 'error');
  }
}

function showMonthDetail(monthKey) {
  var data = COMPUTED;
  var md = data.monthsData[monthKey];
  if (!md) return;
  
  $('#formModalTitle').textContent = '📅 ' + fmtMonth(monthKey);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  // Calculs préliminaires
  var tvaMonth = md.charges.filter(function(c) { return c.cat === 'TVA'; }).reduce(function(a, c) { return a + c.montant; }, 0);
  var chargesTotal = md.charges.reduce(function(a, c) { return a + c.montant; }, 0);
  var caHT = md.enc - tvaMonth;
  var cashRestant = caHT - (chargesTotal - tvaMonth) - md.salaires; // Cash non attribué du mois
  
  var calc = el('div', { class: 'card', style: { marginBottom: '16px', background: 'var(--bg-secondary)', padding: '16px' } });
  
  // CA Réalisé
  calc.appendChild(el('div', { class: 'detail-row' }, [
    el('span', { style: { color: 'var(--text-muted)', fontSize: '12px' } }, '📊 CA Réalisé'),
    el('span', { style: { fontWeight: '600', color: 'var(--info)' } }, EUR(md.real))
  ]));
  
  // CA Encaissé TTC
  calc.appendChild(el('div', { class: 'detail-row' }, [
    el('span', { style: { fontSize: '12px' } }, '💵 CA Encaissé TTC'),
    el('span', { class: 'text-success', style: { fontWeight: '700' } }, EUR(md.enc))
  ]));
  
  // TVA
  if (tvaMonth > 0) {
    calc.appendChild(el('div', { class: 'detail-row', style: { paddingLeft: '12px' } }, [
      el('span', { style: { color: '#f472b6', fontSize: '11px' } }, '↳ TVA'),
      el('span', { style: { fontWeight: '500', color: '#f472b6', fontSize: '11px' } }, '- ' + EUR(tvaMonth))
    ]));
  }
  
  // CA HT
  calc.appendChild(el('div', { class: 'detail-row', style: { background: 'var(--bg-tertiary)', margin: '8px -16px', padding: '10px 16px' } }, [
    el('span', { style: { fontWeight: '700', fontSize: '13px' } }, '= CA HT'),
    el('span', { style: { fontWeight: '700', color: 'var(--info)', fontSize: '15px' } }, EUR(caHT))
  ]));
  
  // Cash restant du mois
  calc.appendChild(el('div', { class: 'detail-row', style: { marginTop: '8px' } }, [
    el('span', { style: { fontSize: '12px', color: 'var(--text-muted)' } }, '💰 Cash restant (non attribué)'),
    el('span', { style: { fontWeight: '700', color: cashRestant >= 0 ? 'var(--success)' : 'var(--danger)', fontSize: '14px' } }, EUR(cashRestant))
  ]));
  
  body.appendChild(calc);
  
  // === Charges avec checkbox intégrées ===
  if (md.charges.length > 0) {
    body.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, 'Charges du mois (% sur CA HT)'));
    
    // Trier par montant décroissant
    var sortedCharges = md.charges.slice().sort(function(a, b) { return b.montant - a.montant; });
    
    sortedCharges.forEach(function(ch) {
      var paid = isPaid(ch.id);
      var pct = caHT > 0 ? ch.montant / caHT : 0;
      var color = getChargeColor(ch.cat);
      
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 12px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-sm)', marginBottom: '6px', cursor: 'pointer' }, onclick: function() { togglePaid(ch.id); closeModal('formModal'); showMonthDetail(monthKey); } });
      
      // Checkbox
      row.appendChild(el('div', { class: 'toggle-check ' + (paid ? 'paid' : ''), style: { width: '20px', height: '20px', fontSize: '12px', flexShrink: '0' } }, paid ? '✓' : ''));
      
      // Info
      var info = el('div', { style: { flex: '1', minWidth: '0' } });
      info.appendChild(el('div', { style: { fontSize: '12px', fontWeight: '500', color: paid ? 'var(--text-muted)' : color, textDecoration: paid ? 'line-through' : 'none' } }, ch.cat + (ch.source ? ' · ' + ch.source : '')));
      info.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, PCT(pct) + ' du CA HT'));
      row.appendChild(info);
      
      // Montant
      row.appendChild(el('div', { style: { fontWeight: '700', fontSize: '13px', color: paid ? 'var(--success)' : color } }, EUR(ch.montant)));
      
      body.appendChild(row);
    });
    
    var unpaidIds = md.charges.filter(function(c) { return !isPaid(c.id); }).map(function(c) { return c.id; });
    if (unpaidIds.length > 0) {
      body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '12px' }, onclick: function() { markAllPaid(unpaidIds); closeModal('formModal'); } }, '✅ Tout marquer payé'));
    }
  }
  
  // Salaires
  body.appendChild(el('div', { style: { marginTop: '16px', padding: '14px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-md)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
    el('div', {}, [
      el('div', { style: { fontSize: '12px', fontWeight: '600' } }, '💸 Salaires versés'),
      el('button', { class: 'btn btn-sm', style: { marginTop: '6px', padding: '4px 10px', fontSize: '10px' }, onclick: function() { closeModal('formModal'); showSalaireModalForMonth(monthKey); } }, '+ Verser')
    ]),
    el('span', { style: { fontWeight: '800', color: 'var(--info)', fontSize: '18px' } }, EUR(md.salaires))
  ]));
  
  // Solde fin de mois
  body.appendChild(el('div', { style: { background: md.solde >= 0 ? 'var(--success-glow)' : 'var(--danger-glow)', padding: '14px', borderRadius: 'var(--radius-md)', marginTop: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
    el('span', { style: { fontWeight: '700', fontSize: '13px' } }, '= Solde fin de mois'),
    el('span', { style: { fontWeight: '800', fontSize: '20px', color: md.solde >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(md.solde))
  ]));
  
  openModal('formModal');
}

// Popup simplifié pour l'échéancier (juste les charges)
function showTimelineMonthCharges(monthKey) {
  var data = COMPUTED;
  var md = data.monthsData[monthKey];
  if (!md) return;
  
  $('#formModalTitle').textContent = '📋 Charges ' + fmtMonth(monthKey);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  if (md.charges.length === 0) {
    body.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '30px' } }, 'Aucune charge ce mois'));
    openModal('formModal');
    return;
  }
  
  var tvaMonth = md.charges.filter(function(c) { return c.cat === 'TVA'; }).reduce(function(a, c) { return a + c.montant; }, 0);
  var caHT = md.enc - tvaMonth;
  
  // Trier par montant décroissant
  var sortedCharges = md.charges.slice().sort(function(a, b) { return b.montant - a.montant; });
  
  sortedCharges.forEach(function(ch) {
    var paid = isPaid(ch.id);
    var pct = caHT > 0 ? ch.montant / caHT : 0;
    var color = getChargeColor(ch.cat);
    
    var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-sm)', marginBottom: '8px', cursor: 'pointer' }, onclick: function() { togglePaid(ch.id); closeModal('formModal'); showTimelineMonthCharges(monthKey); } });
    
    row.appendChild(el('div', { class: 'toggle-check ' + (paid ? 'paid' : ''), style: { width: '22px', height: '22px', fontSize: '13px', flexShrink: '0' } }, paid ? '✓' : ''));
    
    var info = el('div', { style: { flex: '1' } });
    info.appendChild(el('div', { style: { fontSize: '13px', fontWeight: '600', color: paid ? 'var(--text-muted)' : color, textDecoration: paid ? 'line-through' : 'none' } }, ch.cat));
    if (ch.source) info.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, ch.source));
    info.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px' } }, PCT(pct) + ' du CA HT'));
    row.appendChild(info);
    
    row.appendChild(el('div', { style: { fontWeight: '700', fontSize: '14px', color: paid ? 'var(--success)' : color } }, EUR(ch.montant)));
    
    body.appendChild(row);
  });
  
  // Total
  var totalUnpaid = md.charges.filter(function(c) { return !isPaid(c.id); }).reduce(function(a, c) { return a + c.montant; }, 0);
  var totalPaid = md.charges.filter(function(c) { return isPaid(c.id); }).reduce(function(a, c) { return a + c.montant; }, 0);
  
  body.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-md)', marginTop: '12px' } }, [
    el('div', {}, [
      el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Payé: ' + EUR(totalPaid)),
      el('div', { style: { fontSize: '11px', color: 'var(--provision)' } }, 'À payer: ' + EUR(totalUnpaid))
    ]),
    el('div', { style: { fontWeight: '700', fontSize: '15px' } }, 'Total: ' + EUR(totalPaid + totalUnpaid))
  ]));
  
  var unpaidIds = md.charges.filter(function(c) { return !isPaid(c.id); }).map(function(c) { return c.id; });
  if (unpaidIds.length > 0) {
    body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '12px' }, onclick: function() { markAllPaid(unpaidIds); closeModal('formModal'); } }, '✅ Tout marquer payé'));
  }
  
  openModal('formModal');
}

function showSalaireModalForMonth(monthKey) {
  var data = compute();
  $('#formModalTitle').textContent = '💸 Verser Salaire - ' + fmtMonth(monthKey);
  var body = $('#formModalBody');
  body.innerHTML = '';
  
  var info = el('div', { style: { background: 'var(--success-glow)', padding: '14px', borderRadius: 'var(--radius-md)', marginBottom: '16px' } });
  info.innerHTML = '<strong>💡 Recommandation</strong><br>Cash dispo global: ' + EUR(data.cashDispoAbsolu) + ' → Suggéré: <strong>' + EUR(data.salaireReco) + '</strong>';
  body.appendChild(info);
  
  var g = el('div', { class: 'form-group' });
  g.appendChild(el('label', { class: 'form-label' }, 'Montant (€)'));
  var inp = el('input', { class: 'form-input', type: 'number', id: 'salMontant', value: data.salaireReco || '' });
  g.appendChild(inp);
  body.appendChild(g);
  
  body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '20px' }, onclick: function() {
    var mv = { id: 'SAL' + Date.now(), type: 'Salaire', montant: parseFloat($('#salMontant').value) || 0, mois: monthKey, date: localISO(TODAY) };
    TREASURY.mouvements.push(mv);
    saveAll(); closeModal('formModal'); render();
    toast('Salaire versé!', 'success');
  } }, '💸 Verser'));
  
  openModal('formModal');
}

// === RENDER ===

// ===== SPRINT 5: SOUS-FONCTIONS DE RENDER DASHBOARD (A4) =====

/**
 * Affiche les échéances imminentes
 */

function fmtShort(d) { return new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }); }

function calculateHealthScore() {
  var data = compute();
  var score = 100;
  var details = [];
  var tresoScore = 25;
  if (data.cashDispoAbsolu < 0) { tresoScore = 0; details.push({ icon: '🔴', label: 'Cash négatif', impact: -25 }); }
  else if (data.runway < 2) { tresoScore = 5; details.push({ icon: '🟠', label: 'Autonomie < 2 mois', impact: -20 }); }
  else if (data.runway < 4) { tresoScore = 15; details.push({ icon: '🟡', label: 'Autonomie < 4 mois', impact: -10 }); }
  else { details.push({ icon: '🟢', label: 'Trésorerie saine', impact: 0 }); }
  score = score - 25 + tresoScore;
  var retardScore = 25;
  if (data.lateCount > 3) { retardScore = 0; details.push({ icon: '🔴', label: data.lateCount + ' factures en retard', impact: -25 }); }
  else if (data.lateCount > 0) { retardScore = 25 - (data.lateCount * 8); details.push({ icon: '🟠', label: data.lateCount + ' facture(s) en retard', impact: -(data.lateCount * 8) }); }
  else { details.push({ icon: '🟢', label: 'Aucun retard', impact: 0 }); }
  score = score - 25 + retardScore;
  var seuilScore = 25;
  var pctMicro = (data.caHTAnnuel || 0) / 77700;
  if (pctMicro >= 1) { seuilScore = 0; details.push({ icon: '🔴', label: 'Seuil micro dépassé!', impact: -25 }); }
  else if (pctMicro >= 0.9) { seuilScore = 5; details.push({ icon: '🟠', label: 'Proche seuil micro', impact: -20 }); }
  else { details.push({ icon: '🟢', label: 'Seuils OK', impact: 0 }); }
  score = score - 25 + seuilScore;
  var actScore = 25;
  if (data.tauxFacturation < 0.5) { actScore = 5; details.push({ icon: '🟠', label: 'Taux facturation faible', impact: -20 }); }
  else if (data.tauxFacturation < 0.7) { actScore = 15; details.push({ icon: '🟡', label: 'Taux facturation moyen', impact: -10 }); }
  else { details.push({ icon: '🟢', label: 'Bonne activité', impact: 0 }); }
  score = score - 25 + actScore;
  var level = score >= 80 ? 'excellent' : score >= 60 ? 'good' : score >= 40 ? 'warning' : 'danger';
  var label = score >= 80 ? 'Excellente' : score >= 60 ? 'Bonne' : score >= 40 ? 'À surveiller' : 'Critique';
  return { score: Math.max(0, Math.round(score)), level: level, label: label, details: details, data: data };
}

function showHealthScoreDetail() {
  var health = calculateHealthScore();
  $('#formModalTitle').textContent = '🏥 Santé de l\'Entreprise';
  var body = $('#formModalBody');
  body.innerHTML = '';
  var scoreDiv = el('div', { style: { textAlign: 'center', marginBottom: '20px' } });
  scoreDiv.appendChild(el('div', { class: 'health-score-circle ' + health.level, style: { margin: '0 auto 12px', width: '80px', height: '80px', fontSize: '28px' } }, String(health.score)));
  scoreDiv.appendChild(el('div', { style: { fontSize: '18px', fontWeight: '700' } }, health.label));
  body.appendChild(scoreDiv);
  var detailsDiv = el('div', { class: 'card' });
  health.details.forEach(function(d) {
    var row = el('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid var(--glass-border)' } });
    row.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [el('span', {}, d.icon), el('span', { style: { fontSize: '12px' } }, d.label)]));
    row.appendChild(el('span', { style: { fontSize: '12px', fontWeight: '700', color: d.impact === 0 ? 'var(--success)' : 'var(--danger)' } }, d.impact === 0 ? '+0' : String(d.impact)));
    detailsDiv.appendChild(row);
  });
  body.appendChild(detailsDiv);
  openModal('formModal');
}

function getNextUrssafDeadline() {
  var today = new Date(TODAY);
  var currentMonth = today.getMonth();
  var currentYear = today.getFullYear();
  if (COMPANY.urssafPeriodicite === 'mensuel') {
    var endOfMonth = new Date(currentYear, currentMonth + 1, 0);
    return { date: localISO(endOfMonth), daysLeft: Math.ceil((endOfMonth - today) / (1000 * 60 * 60 * 24)), period: fmtMonthShort(ym(currentYear, currentMonth)) };
  } else {
    var quarters = [[0, 31, 'T4'], [3, 30, 'T1'], [6, 31, 'T2'], [9, 31, 'T3']];
    for (var i = 0; i < quarters.length; i++) {
      var q = quarters[i];
      var deadlineDate = new Date(currentYear, q[0], q[1]);
      if (q[0] === 0 && currentMonth > 1) deadlineDate.setFullYear(currentYear + 1);
      var diff = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
      if (diff >= 0 && diff <= 45) return { date: localISO(deadlineDate), daysLeft: diff, period: q[2] };
    }
    return null;
  }
}

function getLegalMilestones() {
  var milestones = [];
  var today = new Date(TODAY);
  var currentYear = today.getFullYear();
  var acre = getAcreInfo();
  if (COMPANY.acre && acre.expiryDate) {
    var acreDays = Math.ceil((new Date(acre.expiryDate) - today) / (1000 * 60 * 60 * 24));
    milestones.push({ id: 'acre', label: 'Fin ACRE', icon: '🎓', date: acre.expiryDate, daysLeft: acreDays, status: acreDays <= 0 ? 'passed' : acreDays <= 30 ? 'urgent' : acreDays <= 90 ? 'current' : 'upcoming' });
  }
  var cfeDate = new Date(currentYear, 11, 15);
  var cfeDays = Math.ceil((cfeDate - today) / (1000 * 60 * 60 * 24));
  if (cfeDays >= -30 && cfeDays <= 180) {
    milestones.push({ id: 'cfe', label: 'CFE', icon: '🏢', date: localISO(cfeDate), daysLeft: cfeDays, status: cfeDays <= 0 ? 'passed' : cfeDays <= 7 ? 'urgent' : cfeDays <= 30 ? 'current' : 'upcoming' });
  }
  var urssaf = getNextUrssafDeadline();
  if (urssaf) {
    milestones.push({ id: 'urssaf', label: 'URSSAF', icon: '🏥', date: urssaf.date, daysLeft: urssaf.daysLeft, status: urssaf.daysLeft <= 3 ? 'urgent' : urssaf.daysLeft <= 7 ? 'current' : 'upcoming' });
  }
  if (!COMPANY.prelevementLiberatoire) {
    var irDate = new Date(currentYear, 4, 25);
    var irDays = Math.ceil((irDate - today) / (1000 * 60 * 60 * 24));
    if (irDays >= -30 && irDays <= 180) {
      milestones.push({ id: 'ir', label: 'Décla IR', icon: '💰', date: localISO(irDate), daysLeft: irDays, status: irDays <= 0 ? 'passed' : irDays <= 7 ? 'urgent' : irDays <= 30 ? 'current' : 'upcoming' });
    }
  }
  milestones.sort(function(a, b) { return (a.daysLeft || 999) - (b.daysLeft || 999); });
  return milestones.slice(0, 5);
}

// V72: Timeline complète avec TOUS les jalons fiscaux de l'année
function getAllYearMilestones() {
  var today = new Date(TODAY);
  var year = today.getFullYear();
  var milestones = [];

  function addM(date, label, icon, cat, detail) {
    var d = new Date(date);
    var daysLeft = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
    milestones.push({
      date: localISO(d), daysLeft: daysLeft, label: label, icon: icon, cat: cat, detail: detail || '',
      status: daysLeft < 0 ? 'passed' : daysLeft === 0 ? 'today' : daysLeft <= 7 ? 'urgent' : daysLeft <= 30 ? 'soon' : 'upcoming'
    });
  }

  // URSSAF declarations
  if (COMPANY.urssafPeriodicite === 'mensuel') {
    for (var m = 0; m < 12; m++) {
      var endMonth = new Date(year, m + 1, 0);
      addM(endMonth, 'URSSAF ' + fmtMonthShort(ym(year, m)), '🏥', 'urssaf', 'Déclaration mensuelle URSSAF');
    }
  } else {
    // Trimestriel: Jan 31, Apr 30, Jul 31, Oct 31
    addM(new Date(year, 0, 31), 'URSSAF T4 ' + (year - 1), '🏥', 'urssaf', 'Déclaration CA T4 ' + (year - 1));
    addM(new Date(year, 3, 30), 'URSSAF T1', '🏥', 'urssaf', 'Déclaration CA T1 ' + year);
    addM(new Date(year, 6, 31), 'URSSAF T2', '🏥', 'urssaf', 'Déclaration CA T2 ' + year);
    addM(new Date(year, 9, 31), 'URSSAF T3', '🏥', 'urssaf', 'Déclaration CA T3 ' + year);
  }

  // TVA (si assujetti)
  var prevYearData = getIRForYear(year - 1);
  var caPrevYear = prevYearData.caTotal || 0;
  var isAssujettiTVA = COMPANY.tvaDepuis || caPrevYear > 37500;
  if (isAssujettiTVA) {
    // Déclarations TVA trimestrielles (CA3)
    addM(new Date(year, 3, 24), 'TVA T1', '💰', 'tva', 'Déclaration & paiement TVA T1');
    addM(new Date(year, 6, 24), 'TVA T2', '💰', 'tva', 'Déclaration & paiement TVA T2');
    addM(new Date(year, 9, 24), 'TVA T3', '💰', 'tva', 'Déclaration & paiement TVA T3');
    addM(new Date(year + 1, 0, 24), 'TVA T4', '💰', 'tva', 'Déclaration & paiement TVA T4');
  }

  // Impôt sur le Revenu
  if (!COMPANY.prelevementLiberatoire) {
    // Déclaration annuelle
    addM(new Date(year, 4, 22), 'Décla IR', '📋', 'ir', 'Déclaration revenus ' + (year - 1) + ' (en ligne)');
    // Acomptes IR (si pas prélèvement libératoire et pas 1ère année)
    addM(new Date(year, 0, 15), 'Acompte IR 1', '🧾', 'ir', '1er acompte impôt sur le revenu');
    addM(new Date(year, 4, 15), 'Acompte IR 2', '🧾', 'ir', '2ème acompte impôt sur le revenu');
    addM(new Date(year, 8, 15), 'Acompte IR 3', '🧾', 'ir', '3ème acompte impôt sur le revenu');
    addM(new Date(year, 11, 15), 'Solde IR', '🧾', 'ir', 'Solde impôt sur le revenu');
  } else {
    addM(new Date(year, 4, 22), 'Décla IR', '📋', 'ir', 'Déclaration revenus ' + (year - 1) + ' (en ligne, prélèvement libératoire)');
  }

  // CFE (Cotisation Foncière des Entreprises)
  addM(new Date(year, 11, 15), 'CFE', '🏢', 'cfe', 'Cotisation Foncière des Entreprises');

  // ACRE
  var acre = getAcreInfo();
  if (COMPANY.acre && acre.expiryDate) {
    addM(new Date(acre.expiryDate), 'Fin ACRE', '🎓', 'acre', 'Fin de l\'exonération ACRE - taux URSSAF plein');
  }

  milestones.sort(function(a, b) {
    var da = new Date(a.date);
    var db = new Date(b.date);
    return da - db;
  });
  return milestones;
}

function projectTVADate() {
  if (COMPANY.tvaDepuis) return { month: null };
  var data = compute();
  var caActuel = data.caHTAnnuel || 0;
  if (caActuel >= 41250) return { month: ym(TODAY.getFullYear(), TODAY.getMonth()), daysLeft: 0, immediate: true };
  if (caActuel >= 37500) return { month: ym(TODAY.getFullYear(), 11), daysLeft: Math.ceil((new Date(TODAY.getFullYear(), 11, 31) - TODAY) / (1000 * 60 * 60 * 24)), warning: true };
  var monthsElapsed = TODAY.getMonth() + 1;
  var caParMois = caActuel / monthsElapsed;
  if (caParMois <= 0) return { month: null };
  var moisRestants = Math.ceil((37500 - caActuel) / caParMois);
  var projectedMonth = TODAY.getMonth() + moisRestants;
  var projectedYear = TODAY.getFullYear() + Math.floor(projectedMonth / 12);
  projectedMonth = projectedMonth % 12;
  return { month: ym(projectedYear, projectedMonth), daysLeft: Math.ceil((new Date(projectedYear, projectedMonth, 1) - TODAY) / (1000 * 60 * 60 * 24)), caActuel: caActuel, caParMois: Math.round(caParMois) };
}

function showTVADetail() {
  var projection = projectTVADate();
  var data = compute();
  $('#formModalTitle').textContent = '🏛️ TVA - Règles & Projection';
  var body = $('#formModalBody');
  body.innerHTML = '';
  var statusDiv = el('div', { style: { textAlign: 'center', marginBottom: '20px', padding: '16px', background: COMPANY.tvaDepuis ? 'rgba(236,72,153,0.1)' : 'var(--success-glow)', borderRadius: 'var(--radius-lg)' } });
  statusDiv.appendChild(el('div', { style: { fontSize: '24px', marginBottom: '8px' } }, COMPANY.tvaDepuis ? '🏛️' : '✅'));
  statusDiv.appendChild(el('div', { style: { fontSize: '16px', fontWeight: '700' } }, COMPANY.tvaDepuis ? 'Assujetti TVA' : 'Franchise de TVA'));
  body.appendChild(statusDiv);
  var pct = Math.min(1, (data.caHTAnnuel || 0) / 41250);
  var gaugeDiv = el('div', { style: { marginBottom: '20px' } });
  gaugeDiv.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '11px', marginBottom: '4px' } }, [el('span', {}, 'CA: ' + EUR(data.caHTAnnuel || 0)), el('span', {}, Math.round(pct * 100) + '%')]));
  var gauge = el('div', { style: { height: '12px', background: 'var(--bg-tertiary)', borderRadius: '6px', position: 'relative' } });
  gauge.appendChild(el('div', { style: { height: '100%', width: (pct * 100) + '%', borderRadius: '6px', background: pct >= 1 ? 'var(--danger)' : pct >= 0.94 ? 'var(--warning)' : 'var(--success)' } }));
  gaugeDiv.appendChild(gauge);
  body.appendChild(gaugeDiv);
  if (!COMPANY.tvaDepuis && projection.month) {
    var projDiv = el('div', { class: 'card', style: { marginBottom: '16px' } });
    projDiv.appendChild(el('div', { style: { fontWeight: '700', marginBottom: '8px' } }, '📈 Projection'));
    projDiv.appendChild(el('div', {}, projection.immediate ? '⚠️ Seuil dépassé - TVA immédiate!' : 'TVA obligatoire en ' + fmtMonth(projection.month)));
    body.appendChild(projDiv);
  }
  var rulesDiv = el('div', { style: { background: 'var(--bg-tertiary)', padding: '14px', borderRadius: 'var(--radius-md)', fontSize: '11px' } });
  rulesDiv.appendChild(el('div', { style: { fontWeight: '700', marginBottom: '8px' } }, '📜 Règles Micro-Entreprise'));
  var rules = ['• Seuil franchise: 37 500€/an (services)', '• Seuil majoré: 41 250€ → TVA immédiate', '• CA N-1 > 37 500€ → TVA dès le 1er janvier N', '• CA N-1 ≤ 37 500€ → retour franchise automatique au 1er janv', '• Plus de tolérance depuis 2025 (1 seul dépassement suffit)'];
  rules.forEach(function(r) { rulesDiv.appendChild(el('div', { style: { color: 'var(--text-secondary)', marginBottom: '4px' } }, r)); });
  body.appendChild(rulesDiv);
  openModal('formModal');
}

function getActionsList() {
  var actions = [];
  var data = compute();
  if (data.lateCount > 0) {
    data.facturesAEncaisser.filter(function(f) { return f.isLate; }).slice(0, 2).forEach(function(f) {
      actions.push({ priority: 1, type: 'urgent', icon: '🚨', label: 'Relancer ' + f.client, sub: EUR(f.ttc) + ' en retard', action: function() { showFactureModal(f); }, btnLabel: 'Voir', btnClass: 'danger' });
    });
  }
  data.detailChargesAPayer.slice(0, 2).forEach(function(c) {
    actions.push({ priority: 2, type: 'warning', icon: '💳', label: 'Payer ' + c.cat, sub: EUR(c.montant) + ' · ' + fmtMonthShort(c.mois), action: function() { togglePaid(c.id); }, btnLabel: 'Payé', btnClass: 'success' });
  });
  if (data.salaireReco >= 500) {
    actions.push({ priority: 3, type: 'success', icon: '💸', label: 'Verser un salaire', sub: EUR(data.salaireReco) + ' disponible', action: function() { showSalaireModal(data.salaireReco); }, btnLabel: 'Verser', btnClass: '' });
  }
  actions.sort(function(a, b) { return a.priority - b.priority; });
  return actions.slice(0, 4);
}

function renderActionsWidget(container) {
  var actions = getActionsList();
  if (actions.length === 0) return;
  var widget = el('div', { class: 'actions-widget' });
  widget.appendChild(el('div', { class: 'actions-header' }, [el('div', { class: 'actions-title' }, [el('span', {}, '⚡'), el('span', {}, 'Actions du Jour'), el('span', { class: 'actions-badge' }, String(actions.length))])]));
  var list = el('div', { class: 'actions-list' });
  actions.forEach(function(a) {
    var item = el('div', { class: 'action-item ' + a.type });
    item.appendChild(el('div', { class: 'action-icon' }, a.icon));
    item.appendChild(el('div', { class: 'action-content' }, [el('div', { class: 'action-label' }, a.label), el('div', { class: 'action-sub' }, a.sub)]));
    item.appendChild(el('button', { class: 'action-btn ' + a.btnClass, onclick: function(e) { e.stopPropagation(); a.action(); } }, a.btnLabel));
    list.appendChild(item);
  });
  widget.appendChild(list);
  container.appendChild(widget);
}

function renderLegalTimeline(container) {
  var milestones = getLegalMilestones();
  if (milestones.length === 0) return;
  var timeline = el('div', { class: 'legal-timeline' });
  timeline.appendChild(el('div', { class: 'legal-timeline-header' }, [el('div', { class: 'legal-timeline-title' }, [el('span', {}, '📅'), el('span', {}, 'Jalons Légaux')])]));
  var track = el('div', { class: 'legal-timeline-track' });
  track.appendChild(el('div', { class: 'legal-timeline-line' }));
  var items = el('div', { class: 'legal-timeline-items' });
  milestones.forEach(function(m) {
    var milestone = el('div', { class: 'legal-milestone', onclick: function() { toast(m.label + (m.date ? ' - ' + fmtShort(m.date) : ''), 'info'); } });
    milestone.appendChild(el('div', { class: 'legal-milestone-dot ' + m.status }, m.icon));
    milestone.appendChild(el('div', { class: 'legal-milestone-label' }, m.label));
    if (m.date) milestone.appendChild(el('div', { class: 'legal-milestone-date' }, fmtShort(m.date)));
    if (m.daysLeft !== null && m.daysLeft >= 0) {
      var cls = m.daysLeft <= 7 ? 'urgent' : m.daysLeft <= 30 ? 'warning' : 'ok';
      milestone.appendChild(el('div', { class: 'legal-milestone-countdown ' + cls }, m.daysLeft === 0 ? 'Auj.' : 'J-' + m.daysLeft));
    }
    items.appendChild(milestone);
  });
  track.appendChild(items);
  timeline.appendChild(track);
  container.appendChild(timeline);
}

function renderHealthScore(container) {
  var health = calculateHealthScore();
  var widget = el('div', { class: 'health-score', onclick: showHealthScoreDetail });
  var header = el('div', { class: 'health-score-header' });
  header.appendChild(el('div', { class: 'health-score-title' }, 'Santé Entreprise'));
  var valueDiv = el('div', { class: 'health-score-value' });
  valueDiv.appendChild(el('div', { class: 'health-score-circle ' + health.level }, String(health.score)));
  valueDiv.appendChild(el('div', {}, [el('div', { class: 'health-score-label' }, health.label), el('div', { class: 'health-score-sub' }, 'Cliquer pour détails')]));
  header.appendChild(valueDiv);
  widget.appendChild(header);
  var details = el('div', { class: 'health-score-details' });
  [{ icon: '💰', value: EUR(health.data.cashDispoAbsolu), label: 'Cash' }, { icon: '📊', value: PCT(health.data.tauxFacturation), label: 'Activité' }, { icon: '⏱️', value: health.data.runway + ' mois', label: 'Autonomie' }, { icon: '⚠️', value: String(health.data.lateCount), label: 'Retards' }].forEach(function(m) {
    details.appendChild(el('div', { class: 'health-metric' }, [el('div', { class: 'health-metric-icon' }, m.icon), el('div', { class: 'health-metric-value' }, m.value), el('div', { class: 'health-metric-label' }, m.label)]));
  });
  widget.appendChild(details);
  container.appendChild(widget);
}

function renderTVAModule(container) {
  var data = compute();
  var projection = projectTVADate();
  var pct = Math.min(1, (data.caHTAnnuel || 0) / 41250);
  var module = el('div', { class: 'tva-module', onclick: showTVADetail });
  var header = el('div', { class: 'tva-header' });
  header.appendChild(el('div', { style: { fontWeight: '700', display: 'flex', alignItems: 'center', gap: '8px' } }, [el('span', {}, '🏛️'), el('span', {}, 'TVA')]));
  header.appendChild(el('span', { class: 'tva-status-badge ' + (COMPANY.tvaDepuis ? 'assujetti' : 'franchise') }, COMPANY.tvaDepuis ? 'Assujetti' : 'Franchise'));
  module.appendChild(header);
  var gauge = el('div', { class: 'tva-gauge' });
  gauge.appendChild(el('div', { class: 'tva-gauge-fill ' + (pct >= 1 ? 'danger' : pct >= 0.94 ? 'warning' : 'safe'), style: { width: (pct * 100) + '%' } }));
  gauge.appendChild(el('div', { class: 'tva-gauge-marker', style: { left: '94%' } }));
  module.appendChild(gauge);
  var info = el('div', { class: 'tva-info' });
  info.appendChild(el('div', { class: 'tva-info-item' }, [el('div', { class: 'tva-info-value' }, EUR(data.caHTAnnuel || 0)), el('div', { class: 'tva-info-label' }, 'CA ' + TODAY.getFullYear())]));
  info.appendChild(el('div', { class: 'tva-info-item' }, [el('div', { class: 'tva-info-value' }, EUR(36800 - (data.caHTAnnuel || 0))), el('div', { class: 'tva-info-label' }, 'Avant seuil')]));
  if (!COMPANY.tvaDepuis && projection.month) {
    info.appendChild(el('div', { class: 'tva-info-item' }, [el('div', { class: 'tva-info-value' }, fmtMonthShort(projection.month)), el('div', { class: 'tva-info-label' }, 'Projection')]));
  } else {
    info.appendChild(el('div', { class: 'tva-info-item' }, [el('div', { class: 'tva-info-value' }, Math.round(pct * 100) + '%'), el('div', { class: 'tva-info-label' }, 'Du seuil')]));
  }
  module.appendChild(info);
  container.appendChild(module);
}

function renderQuickActions(container) {
  var quick = el('div', { class: 'quick-actions' });
  quick.appendChild(el('div', { class: 'quick-action-btn', onclick: function() { showMonthCongesModal(ym(TODAY.getFullYear(), TODAY.getMonth())); } }, [el('span', { class: 'icon' }, '🏖️'), el('span', {}, 'Congés')]));
  quick.appendChild(el('div', { class: 'quick-action-btn', onclick: function() { showSalaireModal(); } }, [el('span', { class: 'icon' }, '💸'), el('span', {}, 'Salaire')]));
  quick.appendChild(el('div', { class: 'quick-action-btn', onclick: showChargeModal }, [el('span', { class: 'icon' }, '➕'), el('span', {}, 'Dépense')]));
  container.appendChild(quick);
}


var CHARGES_TAB = 'apayer';

function getChargesData() {
  var data = compute();
  var aPayer = data.allProvisionsDetail || [];
  var payees = data.detailChargesPayees || [];
  var totalAPayer = aPayer.reduce(function(sum, c) { return sum + c.montant; }, 0);
  var totalPayees = payees.reduce(function(sum, c) { return sum + c.montant; }, 0);
  return { aPayer: aPayer, payees: payees, totalAPayer: totalAPayer, totalPayees: totalPayees };
}

function renderChargesPanel(container) {
  var charges = getChargesData();
  var panel = el('div', { class: 'charges-panel' });
  var tabs = el('div', { class: 'charges-tabs' });
  var tabAPayer = el('div', { class: 'charges-tab' + (CHARGES_TAB === 'apayer' ? ' active' : ''), onclick: function() { CHARGES_TAB = 'apayer'; render(); } });
  tabAPayer.appendChild(el('span', {}, 'À payer'));
  if (charges.aPayer.length > 0) tabAPayer.appendChild(el('span', { class: 'charges-tab-badge' }, String(charges.aPayer.length)));
  tabs.appendChild(tabAPayer);
  var tabPayees = el('div', { class: 'charges-tab' + (CHARGES_TAB === 'payees' ? ' active' : ''), onclick: function() { CHARGES_TAB = 'payees'; render(); } });
  tabPayees.appendChild(el('span', {}, 'Payées'));
  tabs.appendChild(tabPayees);
  panel.appendChild(tabs);
  var list = el('div', { class: 'charges-list' });
  var items = CHARGES_TAB === 'apayer' ? charges.aPayer : charges.payees;
  if (items.length === 0) {
    list.appendChild(el('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-muted)', fontSize: '12px' } }, CHARGES_TAB === 'apayer' ? '✅ Aucune charge à payer' : 'Aucune charge payée'));
  } else {
    items.slice(0, 10).forEach(function(c) {
      var item = el('div', { class: 'charge-item' + (isPaid(c.id) ? ' paid' : ''), onclick: function() { togglePaid(c.id); } });
      var catClass = (c.cat || '').toLowerCase().replace(/[^a-z]/g, '');
      if (!['urssaf', 'tva', 'cfp', 'ir'].includes(catClass)) catClass = 'cfp';
      item.appendChild(el('span', { class: 'charge-cat-badge ' + catClass }, c.cat || 'Autre'));
      item.appendChild(el('div', { class: 'charge-item-info' }, [el('div', { class: 'charge-item-label' }, c.label || c.cat), el('div', { class: 'charge-item-sub' }, fmtMonthShort(c.mois))]));
      item.appendChild(el('div', { class: 'charge-item-amount' }, EUR(c.montant)));
      item.appendChild(el('div', { class: 'charge-check' + (isPaid(c.id) ? ' checked' : '') }, isPaid(c.id) ? '✓' : ''));
      list.appendChild(item);
    });
  }
  panel.appendChild(list);
  if (CHARGES_TAB === 'apayer' && charges.aPayer.length > 0) {
    var footer = el('div', { class: 'charges-footer' });
    var types = {};
    charges.aPayer.forEach(function(c) { types[c.cat] = true; });
    if (types['URSSAF']) footer.appendChild(el('button', { class: 'btn btn-success', onclick: function() { charges.aPayer.filter(function(c) { return c.cat === 'URSSAF'; }).forEach(function(c) { TREASURY.paidCharges[c.id] = true; }); saveAll(); render(); toast('URSSAF marqué payé', 'success'); } }, '✓ URSSAF'));
    if (types['TVA']) footer.appendChild(el('button', { class: 'btn', style: { background: '#ec4899', color: 'white' }, onclick: function() { charges.aPayer.filter(function(c) { return c.cat === 'TVA'; }).forEach(function(c) { TREASURY.paidCharges[c.id] = true; }); saveAll(); render(); toast('TVA marquée payée', 'success'); } }, '✓ TVA'));
    panel.appendChild(footer);
  }
  container.appendChild(panel);
}

// V60: Comparaison avec projections
function getCompareData() {
  var currentYear = PERIOD.year || TODAY.getFullYear();
  var prevYear = currentYear - 1;
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var currentData = { ca: 0, caProjecte: 0, charges: 0, benefice: 0, jours: 0 };
  var prevData = { ca: 0, charges: 0, benefice: 0, jours: 0 };
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.status !== 'payée' || f.jours <= 0) return;
      var year = parseInt((f.mois || '').substring(0, 4));
      var ht = f.ht || 0;
      var rate = getUrssafRate(f.mois);
      var charges = Math.round(ht * (rate + LEGAL.cfp));
      if (year === currentYear) { currentData.ca += ht; currentData.charges += charges; currentData.jours += f.jours; }
      else if (year === prevYear) { prevData.ca += ht; prevData.charges += charges; prevData.jours += f.jours; }
    });
    // V60: CA projeté pour l'année en cours
    if (mis.lignes && mis.tjm) {
      mis.lignes.forEach(function(l) {
        if (!l.ym || l.ym <= nowYm) return;
        var lYear = parseInt(l.ym.split('-')[0]);
        if (lYear !== currentYear) return;
        var joursFuturs = l.joursReels > 0 ? 0 : Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
        if (joursFuturs > 0) currentData.caProjecte += joursFuturs * mis.tjm;
      });
    }
  });
  currentData.benefice = currentData.ca - currentData.charges;
  prevData.benefice = prevData.ca - prevData.charges;
  return { current: currentData, prev: prevData, currentYear: currentYear, prevYear: prevYear };
}

function renderCompareWidget(container) {
  var cmp = getCompareData();
  if (cmp.prev.ca === 0 && cmp.current.ca === 0) return;
  var widget = el('div', { class: 'compare-widget' });
  widget.appendChild(el('div', { class: 'compare-header' }, [el('div', { class: 'compare-title' }, '📊 ' + cmp.currentYear + ' vs ' + cmp.prevYear)]));
  var grid = el('div', { class: 'compare-grid' });
  function addItem(label, current, prev, inverse) {
    var delta = prev > 0 ? Math.round(((current - prev) / prev) * 100) : (current > 0 ? 100 : 0);
    var deltaClass = delta > 5 ? (inverse ? 'down' : 'up') : delta < -5 ? (inverse ? 'up' : 'down') : 'neutral';
    var item = el('div', { class: 'compare-item' });
    item.appendChild(el('div', { class: 'compare-label' }, label));
    item.appendChild(el('div', { class: 'compare-values' }, [el('span', { class: 'compare-current' }, EUR(current)), el('span', { class: 'compare-prev' }, 'vs ' + EUR(prev))]));
    item.appendChild(el('span', { class: 'compare-delta ' + deltaClass }, (delta >= 0 ? '+' : '') + delta + '%'));
    grid.appendChild(item);
  }
  addItem('CA HT (réalisé)', cmp.current.ca, cmp.prev.ca, false);
  // V60: Ajouter la projection si disponible
  if (cmp.current.caProjecte > 0) {
    addItem('CA HT (estimé total)', cmp.current.ca + cmp.current.caProjecte, cmp.prev.ca, false);
  }
  addItem('Charges', cmp.current.charges, cmp.prev.charges, true);
  addItem('Bénéfice', cmp.current.benefice, cmp.prev.benefice, false);
  widget.appendChild(grid);
  container.appendChild(widget);
}

function showProjectionsModal() {
  var data = compute();
  $('#formModalTitle').textContent = '📈 Projections Financières';
  var body = $('#formModalBody');
  body.innerHTML = '';
  var scenarios = [
    { name: 'Optimiste', months: 12, vacances: 4, color: 'var(--success)' },
    { name: 'Normal', months: 12, vacances: 5, color: 'var(--info)' },
    { name: 'Prudent', months: 12, vacances: 7, color: 'var(--warning)' }
  ];
  var tjmMoyen = data.tjmEffectif || 450;
  var joursParMois = 18;
  scenarios.forEach(function(s) {
    var moisTravailles = s.months - Math.ceil(s.vacances / joursParMois);
    var caProj = moisTravailles * joursParMois * tjmMoyen;
    var chargesProj = Math.round(caProj * (getUrssafRate(ym(TODAY.getFullYear(), 6)) + LEGAL.cfp));
    var benefProj = caProj - chargesProj;
    var card = el('div', { style: { padding: '14px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-md)', marginBottom: '10px', borderLeft: '4px solid ' + s.color } });
    card.appendChild(el('div', { style: { fontWeight: '700', marginBottom: '8px', color: s.color } }, s.name + ' (' + s.vacances + ' sem. congés)'));
    var grid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', fontSize: '12px' } });
    grid.appendChild(el('div', {}, [el('div', { style: { color: 'var(--text-muted)', fontSize: '10px' } }, 'CA projeté'), el('div', { style: { fontWeight: '700' } }, EUR(caProj))]));
    grid.appendChild(el('div', {}, [el('div', { style: { color: 'var(--text-muted)', fontSize: '10px' } }, 'Charges'), el('div', { style: { fontWeight: '700' } }, EUR(chargesProj))]));
    grid.appendChild(el('div', {}, [el('div', { style: { color: 'var(--text-muted)', fontSize: '10px' } }, 'Bénéfice'), el('div', { style: { fontWeight: '700', color: s.color } }, EUR(benefProj))]));
    card.appendChild(grid);
    body.appendChild(card);
  });
  var note = el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '12px' } });
  note.innerHTML = 'Basé sur TJM moyen: ' + EUR(tjmMoyen) + ' · ' + joursParMois + 'j/mois';
  body.appendChild(note);
  openModal('formModal');
}


function generateSummaryText() {
  var data = compute();
  var health = calculateHealthScore();
  var cmp = getCompareData();
  var lines = [];
  
  // Intro
  if (health.score >= 80) lines.push('🎉 <strong>Excellente situation !</strong> Ton activité se porte très bien.');
  else if (health.score >= 60) lines.push('👍 <strong>Bonne situation.</strong> Quelques points d\'attention.');
  else if (health.score >= 40) lines.push('⚠️ <strong>Situation à surveiller.</strong> Actions recommandées.');
  else lines.push('🚨 <strong>Situation critique.</strong> Actions urgentes nécessaires.');
  
  // CA
  var caText = 'CA encaissé : <strong>' + EUR(data.caHT) + '</strong>';
  if (cmp.prev.ca > 0) {
    var delta = Math.round(((cmp.current.ca - cmp.prev.ca) / cmp.prev.ca) * 100);
    caText += delta >= 0 ? ' <span class="good">(+' + delta + '% vs N-1)</span>' : ' <span class="bad">(' + delta + '% vs N-1)</span>';
  }
  lines.push(caText);
  
  // Trésorerie
  var tresoClass = data.cashDispoAbsolu >= 5000 ? 'good' : data.cashDispoAbsolu >= 0 ? 'warning' : 'bad';
  lines.push('Cash disponible : <span class="' + tresoClass + '">' + EUR(data.cashDispoAbsolu) + '</span> (' + data.runway + ' mois d\'autonomie)');
  
  // Retards
  if (data.lateCount > 0) lines.push('<span class="bad">⚠️ ' + data.lateCount + ' facture(s) en retard</span> - Pense à relancer !');
  
  // Charges
  if (data.provisionsAbsolues > 0) lines.push('Charges à payer : <span class="warning">' + EUR(data.provisionsAbsolues) + '</span>');
  
  // Salaire
  if (data.salaireReco >= 500) lines.push('💡 Tu peux te verser <span class="good">' + EUR(data.salaireReco) + '</span> de salaire.');
  
  return lines.join('<br>');
}

function renderSummaryCard(container) {
  var card = el('div', { class: 'summary-card' });
  card.appendChild(el('div', { style: { fontWeight: '700', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '8px' } }, [el('span', {}, '📋'), el('span', {}, 'En résumé')]));
  var text = el('div', { class: 'summary-text' });
  text.innerHTML = generateSummaryText();
  card.appendChild(text);
  card.appendChild(el('button', { class: 'export-btn', onclick: exportPDFReport }, [el('span', {}, '📄'), el('span', {}, 'Exporter rapport PDF')]));
  container.appendChild(card);
}

function exportPDFReport() {
  var data = compute();
  var health = calculateHealthScore();
  var cmp = getCompareData();
  
  var doc = new jspdf.jsPDF();
  var y = 20;
  var margin = 20;
  var pageWidth = doc.internal.pageSize.getWidth();
  
  // Titre
  doc.setFontSize(20);
  doc.setFont('helvetica', 'bold');
  doc.text('Rapport de Gestion', margin, y);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.text(COMPANY.nom || 'Mon Entreprise', margin, y + 8);
  doc.text(fmtLong(localISO(TODAY)), margin, y + 14);
  y += 30;
  
  // Score santé
  doc.setFillColor(health.level === 'excellent' ? 52 : health.level === 'good' ? 96 : health.level === 'warning' ? 251 : 248, health.level === 'excellent' ? 211 : health.level === 'good' ? 165 : health.level === 'warning' ? 191 : 113, health.level === 'excellent' ? 153 : health.level === 'good' ? 250 : health.level === 'warning' ? 36 : 113);
  doc.roundedRect(margin, y, 50, 25, 3, 3, 'F');
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255, 255, 255);
  doc.text(health.score + '/100', margin + 10, y + 16);
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(12);
  doc.text('Santé: ' + health.label, margin + 55, y + 16);
  y += 35;
  
  // KPIs
  doc.setFont('helvetica', 'bold');
  doc.text('Indicateurs Clés', margin, y);
  y += 8;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  var kpis = [
    ['CA Encaissé HT', EUR(data.caHT)],
    ['Bénéfice Net', EUR(data.beneficeNet)],
    ['Cash Disponible', EUR(data.cashDispoAbsolu)],
    ['Charges à payer', EUR(data.provisionsAbsolues)],
    ['TJM Effectif', EUR(data.tjmEffectif)],
    ['Taux Facturation', PCT(data.tauxFacturation)],
    ['Autonomie', data.runway + ' mois'],
    ['Factures en retard', String(data.lateCount)]
  ];
  kpis.forEach(function(kpi, i) {
    var col = i % 2;
    var row = Math.floor(i / 2);
    doc.text(kpi[0] + ':', margin + col * 90, y + row * 7);
    doc.setFont('helvetica', 'bold');
    doc.text(kpi[1], margin + col * 90 + 50, y + row * 7);
    doc.setFont('helvetica', 'normal');
  });
  y += 35;
  
  // Comparatif
  if (cmp.prev.ca > 0) {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Comparatif ' + cmp.currentYear + ' vs ' + cmp.prevYear, margin, y);
    y += 8;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    var delta = Math.round(((cmp.current.ca - cmp.prev.ca) / cmp.prev.ca) * 100);
    doc.text('CA: ' + EUR(cmp.current.ca) + ' vs ' + EUR(cmp.prev.ca) + ' (' + (delta >= 0 ? '+' : '') + delta + '%)', margin, y);
    y += 15;
  }
  
  // Charges détail
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.text('Charges à Payer', margin, y);
  y += 8;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  var charges = getChargesData();
  if (charges.aPayer.length === 0) {
    doc.text('Aucune charge en attente', margin, y);
  } else {
    charges.aPayer.slice(0, 8).forEach(function(c, i) {
      doc.text(c.cat + ' - ' + fmtMonthShort(c.mois) + ': ' + EUR(c.montant), margin, y + i * 5);
    });
  }
  
  // Pied de page
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.text('Généré par Freel V50 - ' + localISO(TODAY), margin, 285);
  
  doc.save('rapport-gestion-' + localISO(TODAY) + '.pdf');
  toast('PDF exporté !', 'success');
}

function getInsights() {
  var data = compute();
  var insights = [];
  
  if (data.tauxFacturation >= 0.85) insights.push({ type: 'positive', text: 'Excellent taux de facturation' });
  else if (data.tauxFacturation < 0.6) insights.push({ type: 'negative', text: 'Taux facturation faible' });
  
  if (data.runway >= 6) insights.push({ type: 'positive', text: '+6 mois d\'autonomie' });
  else if (data.runway < 3) insights.push({ type: 'negative', text: 'Autonomie < 3 mois' });
  
  if (data.lateCount === 0) insights.push({ type: 'positive', text: 'Aucun retard' });
  else insights.push({ type: 'negative', text: data.lateCount + ' retard(s)' });
  
  var cmp = getCompareData();
  if (cmp.prev.ca > 0) {
    var delta = ((cmp.current.ca - cmp.prev.ca) / cmp.prev.ca) * 100;
    if (delta > 10) insights.push({ type: 'positive', text: 'CA en hausse +' + Math.round(delta) + '%' });
    else if (delta < -10) insights.push({ type: 'negative', text: 'CA en baisse ' + Math.round(delta) + '%' });
  }
  
  return insights;
}

function renderInsights(container) {
  var insights = getInsights();
  if (insights.length === 0) return;
  var div = el('div', { style: { marginBottom: '12px', display: 'flex', flexWrap: 'wrap' } });
  insights.forEach(function(i) {
    div.appendChild(el('span', { class: 'insight-chip ' + i.type }, i.text));
  });
  container.appendChild(div);
}


var GOAL_CA = localStorage.getItem('freel_goal_ca') ? parseInt(localStorage.getItem('freel_goal_ca')) : 0;

function setGoalCA(amount) {
  GOAL_CA = amount;
  localStorage.setItem('freel_goal_ca', String(amount));
}

function showGoalModal() {
  $('#formModalTitle').textContent = '🎯 Objectif CA Annuel';
  var body = $('#formModalBody');
  body.innerHTML = '';
  body.appendChild(el('div', { style: { marginBottom: '16px', fontSize: '12px', color: 'var(--text-muted)' } }, 'Définis ton objectif de chiffre d\'affaires pour ' + (PERIOD.year || TODAY.getFullYear())));
  body.appendChild(createInput('Objectif CA HT (€)', 'number', 'goalAmount', GOAL_CA || ''));
  var presets = el('div', { style: { display: 'flex', gap: '8px', marginTop: '12px', flexWrap: 'wrap' } });
  [50000, 60000, 70000, 80000, 100000].forEach(function(v) {
    presets.appendChild(el('button', { class: 'btn btn-sm', onclick: function() { $('#goalAmount').value = v; } }, EUR(v)));
  });
  body.appendChild(presets);
  body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '20px' }, onclick: function() {
    var amount = parseInt($('#goalAmount').value) || 0;
    setGoalCA(amount);
    closeModal('formModal');
    render();
    toast('Objectif enregistré !', 'success');
  } }, '✅ Définir l\'objectif'));
  openModal('formModal');
}

function renderGoalWidget(container) {
  var data = compute();
  var year = PERIOD.year || TODAY.getFullYear();
  var currentCA = data.caHT || 0;
  var monthsPassed = TODAY.getMonth() + 1;
  var monthsTotal = 12;
  var expectedPct = monthsPassed / monthsTotal;
  
  var widget = el('div', { class: 'goal-widget' });
  var header = el('div', { class: 'goal-header' });
  header.appendChild(el('div', { class: 'goal-title' }, '🎯 Objectif ' + year));
  header.appendChild(el('div', { class: 'goal-edit', onclick: showGoalModal }, '⚙️ Modifier'));
  widget.appendChild(header);
  
  if (!GOAL_CA || GOAL_CA <= 0) {
    widget.appendChild(el('div', { style: { textAlign: 'center', padding: '12px', fontSize: '12px', color: 'var(--text-muted)' } }, 'Aucun objectif défini'));
    widget.appendChild(el('button', { class: 'btn btn-sm', style: { width: '100%' }, onclick: showGoalModal }, '+ Définir un objectif'));
    container.appendChild(widget);
    return;
  }
  
  var pct = Math.min(1, currentCA / GOAL_CA);
  var pctExpected = expectedPct;
  var isOnTrack = pct >= pctExpected * 0.9;
  var isBehind = pct < pctExpected * 0.7;
  
  var progress = el('div', { class: 'goal-progress' });
  progress.appendChild(el('div', { class: 'goal-progress-fill' + (isBehind ? ' behind' : isOnTrack ? '' : ' warning'), style: { width: (pct * 100) + '%' } }));
  widget.appendChild(progress);
  
  var stats = el('div', { class: 'goal-stats' });
  stats.appendChild(el('span', { class: 'goal-current' }, EUR(currentCA) + ' (' + Math.round(pct * 100) + '%)'));
  stats.appendChild(el('span', { class: 'goal-target' }, 'Objectif: ' + EUR(GOAL_CA)));
  widget.appendChild(stats);
  
  var remaining = GOAL_CA - currentCA;
  var monthsLeft = 12 - monthsPassed;
  var neededPerMonth = monthsLeft > 0 ? Math.round(remaining / monthsLeft) : remaining;
  var pace = el('div', { class: 'goal-pace' });
  if (remaining <= 0) {
    pace.innerHTML = '🎉 <strong style="color:var(--success)">Objectif atteint !</strong>';
  } else if (isOnTrack) {
    pace.innerHTML = '✅ En bonne voie · Besoin: <strong>' + EUR(neededPerMonth) + '/mois</strong>';
  } else {
    pace.innerHTML = '⚠️ En retard · Besoin: <strong style="color:var(--warning)">' + EUR(neededPerMonth) + '/mois</strong>';
  }
  widget.appendChild(pace);
  
  container.appendChild(widget);
}

// V60: Inclure CA réalisé + projeté dans les stats par client
function getClientsStats() {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var stats = {};
  MISSIONS.forEach(function(mis) {
    var clientName = mis.client || 'Sans client';
    if (!stats[clientName]) stats[clientName] = { ca: 0, caProjecte: 0, jours: 0, factures: 0 };
    if (mis.factures) {
      mis.factures.forEach(function(f) {
        if (f.status === 'payée' && f.jours > 0) {
          stats[clientName].ca += f.ht || 0;
          stats[clientName].jours += f.jours || 0;
          stats[clientName].factures++;
        }
      });
    }
    // V60: CA projeté (jours futurs non réalisés)
    if (mis.lignes && mis.tjm) {
      mis.lignes.forEach(function(l) {
        if (!l.ym || l.ym <= nowYm) return;
        if (!isInPeriod(l.ym)) return;
        var joursFuturs = l.joursReels > 0 ? 0 : Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
        if (joursFuturs > 0) stats[clientName].caProjecte += joursFuturs * mis.tjm;
      });
    }
  });
  var arr = Object.keys(stats).map(function(name) {
    return {
      name: name, ca: stats[name].ca, caProjecte: stats[name].caProjecte,
      caTotal: stats[name].ca + stats[name].caProjecte,
      jours: stats[name].jours, factures: stats[name].factures,
      tjm: stats[name].jours > 0 ? Math.round(stats[name].ca / stats[name].jours) : 0
    };
  });
  arr.sort(function(a, b) { return b.caTotal - a.caTotal; });
  return arr;
}

function renderClientsWidget(container) {
  var clients = getClientsStats();
  if (clients.length === 0) return;
  var maxCA = clients[0].ca || 1;
  
  var widget = el('div', { class: 'clients-widget' });
  widget.appendChild(el('div', { class: 'clients-header' }, [el('div', { class: 'clients-title' }, '👥 CA par Client')]));
  
  clients.slice(0, 5).forEach(function(c) {
    var row = el('div', { class: 'client-row' });
    row.appendChild(el('div', { class: 'client-info' }, [
      el('div', { class: 'client-name' }, c.name),
      el('div', { class: 'client-sub' }, c.jours + 'j · TJM ' + EUR(c.tjm))
    ]));
    row.appendChild(el('div', { class: 'client-ca' }, EUR(c.ca)));
    var bar = el('div', { class: 'client-bar' });
    bar.appendChild(el('div', { class: 'client-bar-fill', style: { width: (c.ca / maxCA * 100) + '%' } }));
    row.appendChild(bar);
    widget.appendChild(row);
  });
  
  container.appendChild(widget);
}

// V55: Widget clients avec camembert et barres horizontales pour meilleure visualisation
function renderClientsWidgetVisual(container, data) {
  var clients = getClientsStats();
  if (clients.length === 0) {
    container.appendChild(el('div', { class: 'card', style: { textAlign: 'center', padding: '24px', color: 'var(--text-muted)' } }, 'Aucun client'));
    return;
  }

  // V60: Utiliser caTotal (réalisé + projeté) pour le graphique
  var totalCA = clients.reduce(function(sum, c) { return sum + c.caTotal; }, 0) || 1;
  var totalProjecte = clients.reduce(function(sum, c) { return sum + c.caProjecte; }, 0);
  var maxCA = clients[0].caTotal || 1;

  // Couleurs pour le camembert
  var colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

  var widget = el('div', { class: 'card' });

  // V55: Layout horizontal avec camembert à gauche et liste à droite
  var content = el('div', { style: { display: 'flex', gap: '16px', alignItems: 'flex-start' } });

  // Camembert SVG
  var pieSize = 120;
  var pieContainer = el('div', { style: { flexShrink: '0' } });
  var pieDiv = el('div', { style: { position: 'relative', width: pieSize + 'px', height: pieSize + 'px' } });

  var svgNS = 'http://www.w3.org/2000/svg';
  var svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('width', pieSize);
  svg.setAttribute('height', pieSize);
  svg.setAttribute('viewBox', '0 0 100 100');

  // Dessiner les segments du camembert
  var cumAngle = -90; // Commencer à 12h
  clients.slice(0, 6).forEach(function(client, i) {
    var pct = (client.caTotal / totalCA) * 100;
    var angle = (pct / 100) * 360;

    if (pct > 0) {
      var startAngle = cumAngle * (Math.PI / 180);
      var endAngle = (cumAngle + angle) * (Math.PI / 180);

      var x1 = 50 + 40 * Math.cos(startAngle);
      var y1 = 50 + 40 * Math.sin(startAngle);
      var x2 = 50 + 40 * Math.cos(endAngle);
      var y2 = 50 + 40 * Math.sin(endAngle);

      var largeArc = angle > 180 ? 1 : 0;

      var path = document.createElementNS(svgNS, 'path');
      if (clients.length === 1 || pct >= 99.5) {
        // Cercle complet si un seul client ou 100%
        path.setAttribute('d', 'M 50 10 A 40 40 0 1 1 49.99 10 Z');
      } else {
        path.setAttribute('d', 'M 50 50 L ' + x1 + ' ' + y1 + ' A 40 40 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z');
      }
      path.setAttribute('fill', colors[i % colors.length]);
      svg.appendChild(path);

      cumAngle += angle;
    }
  });

  // Centre blanc pour effet donut
  var centerCircle = document.createElementNS(svgNS, 'circle');
  centerCircle.setAttribute('cx', '50');
  centerCircle.setAttribute('cy', '50');
  centerCircle.setAttribute('r', '25');
  centerCircle.setAttribute('fill', 'var(--bg-secondary)');
  svg.appendChild(centerCircle);

  pieDiv.appendChild(svg);

  // Total au centre
  var centerLabel = el('div', { style: {
    position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
    textAlign: 'center', lineHeight: '1.2'
  }});
  centerLabel.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Total'));
  centerLabel.appendChild(el('div', { style: { fontSize: '12px', fontWeight: '700' } }, EUR(totalCA, true)));
  pieDiv.appendChild(centerLabel);

  pieContainer.appendChild(pieDiv);
  content.appendChild(pieContainer);

  // Liste des clients avec barres horizontales
  var listContainer = el('div', { style: { flex: '1', minWidth: '0' } });

  clients.slice(0, 6).forEach(function(client, i) {
    var pct = Math.round((client.caTotal / totalCA) * 100);
    var barWidthReal = (client.ca / maxCA) * 100;
    var barWidthProj = (client.caProjecte / maxCA) * 100;

    var row = el('div', { style: { marginBottom: '8px' } });

    // Header: nom + CA + %
    var header = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '11px', marginBottom: '2px' } });
    header.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } }, [
      el('div', { style: { width: '8px', height: '8px', borderRadius: '2px', background: colors[i % colors.length] } }),
      el('span', { style: { fontWeight: '600' } }, client.name)
    ]));
    // V60: Afficher réalisé + projeté
    var caText = EUR(client.ca);
    if (client.caProjecte > 0) caText += ' + ' + EUR(client.caProjecte);
    header.appendChild(el('span', { style: { color: 'var(--text-muted)' } }, caText + ' (' + pct + '%)'));
    row.appendChild(header);

    // V60: Barre de progression double (réalisé + projeté)
    var barBg = el('div', { style: { height: '6px', background: 'var(--bg-tertiary)', borderRadius: '3px', overflow: 'hidden', display: 'flex' } });
    barBg.appendChild(el('div', { style: { height: '100%', width: barWidthReal + '%', background: colors[i % colors.length], borderRadius: '3px 0 0 3px' } }));
    if (barWidthProj > 0) {
      barBg.appendChild(el('div', { style: { height: '100%', width: barWidthProj + '%', background: colors[i % colors.length], opacity: '0.4', borderRadius: '0 3px 3px 0' } }));
    }
    row.appendChild(barBg);

    // Sous-info
    var subText = client.jours + ' jours · TJM ' + EUR(client.tjm);
    if (client.caProjecte > 0) subText += ' · Projeté: ' + EUR(client.caProjecte);
    row.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px' } }, subText));

    listContainer.appendChild(row);
  });

  // Si plus de 6 clients, afficher "et X autres"
  if (clients.length > 6) {
    var othersCA = clients.slice(6).reduce(function(sum, c) { return sum + c.caTotal; }, 0);
    var othersPct = Math.round((othersCA / totalCA) * 100);
    listContainer.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '8px', textAlign: 'center' } },
      '+ ' + (clients.length - 6) + ' autres (' + EUR(othersCA) + ', ' + othersPct + '%)'));
  }

  content.appendChild(listContainer);
  widget.appendChild(content);
  container.appendChild(widget);
}

function renderCongesCalendar(container) {
  var data = compute();
  var months = getPeriodMonths();
  
  // V51: Sous-onglets dashboard
  renderDashboardSubTabs(container);
  
  // Afficher le contenu selon le sous-onglet actif
  if (DASHBOARD_SUB === 'charges') {
    renderChargesSubTab(container, data);
    return;
  }
  if (DASHBOARD_SUB === 'analyse') {
    renderAnalyseSubTab(container, data, months);
    return;
  }
  // Sinon: Accueil (défaut)
  var currentYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  
  var widget = el('div', { class: 'clients-widget' });
  widget.appendChild(el('div', { class: 'clients-header' }, [el('div', { class: 'clients-title' }, '🏖️ Congés')]));
  
  var calendar = el('div', { class: 'conges-calendar' });
  months.forEach(function(m) {
    var wd = data.workedDays[m] || { conges: 0 };
    var monthDiv = el('div', { class: 'conges-month' + (wd.conges > 0 ? ' has-conges' : '') + (m === currentYm ? ' current' : ''), onclick: function() { showMonthCongesModal(m); } });
    monthDiv.appendChild(el('div', { class: 'conges-month-name' }, fmtMonthShort(m).substring(0, 4)));
    monthDiv.appendChild(el('div', { class: 'conges-month-days' }, wd.conges > 0 ? wd.conges + 'j' : '-'));
    calendar.appendChild(monthDiv);
  });
  widget.appendChild(calendar);
  
  var total = months.reduce(function(sum, m) { return sum + (data.workedDays[m] ? data.workedDays[m].conges : 0); }, 0);
  widget.appendChild(el('div', { style: { marginTop: '10px', fontSize: '11px', color: 'var(--text-muted)', textAlign: 'center' } }, 'Total: ' + total + ' jours de congés'));
  
  container.appendChild(widget);
}


var SEARCH_OPEN = false;
var SEARCH_RESULTS = [];
var SEARCH_INDEX = 0;
var HELP_OPEN = false;

function toggleKeyboardHelp() {
  HELP_OPEN = !HELP_OPEN;
  var help = $('#keyboardHelp');
  if (help) help.classList.toggle('show', HELP_OPEN);
}

function showSearch() {
  SEARCH_OPEN = true;
  SEARCH_RESULTS = [];
  SEARCH_INDEX = 0;
  var overlay = $('#searchOverlay');
  if (overlay) {
    overlay.classList.add('show');
    var input = overlay.querySelector('input');
    if (input) { input.value = ''; input.focus(); }
    updateSearchResults('');
  }
}

function hideSearch() {
  SEARCH_OPEN = false;
  var overlay = $('#searchOverlay');
  if (overlay) overlay.classList.remove('show');
}

function performSearch(query) {
  query = (query || '').toLowerCase().trim();
  var results = [];
  
  if (!query) {
    SEARCH_RESULTS = [];
    updateSearchResults('');
    return;
  }
  
  // Recherche clients
  CLIENTS.forEach(function(c) {
    if ((c.nom || '').toLowerCase().includes(query)) {
      results.push({ type: 'client', icon: '👤', title: c.nom, sub: c.email || 'Client', action: function() { showClientModal(c); } });
    }
  });
  
  // Recherche missions
  MISSIONS.forEach(function(m) {
    if ((m.client || '').toLowerCase().includes(query) || (m.titre || '').toLowerCase().includes(query)) {
      results.push({ type: 'mission', icon: '💼', title: m.client + (m.titre ? ' - ' + m.titre : ''), sub: EUR(m.tjm) + '/j', action: function() { showMissionModal(m); } });
    }
  });
  
  // Recherche factures
  MISSIONS.forEach(function(m) {
    if (m.factures) {
      m.factures.forEach(function(f) {
        if ((f.client || m.client || '').toLowerCase().includes(query) || (f.numero || '').toLowerCase().includes(query)) {
          results.push({ type: 'facture', icon: '📄', title: (f.client || m.client) + ' · ' + fmtMonthShort(f.mois), sub: EUR(f.ttc) + ' · ' + f.status, action: function() { showFactureModal(f); } });
        }
      });
    }
  });
  
  // Actions rapides
  if ('salaire'.includes(query)) results.push({ type: 'action', icon: '💸', title: 'Verser un salaire', sub: 'Action rapide', action: function() { showSalaireModal(); } });
  if ('congés'.includes(query) || 'conges'.includes(query)) results.push({ type: 'action', icon: '🏖️', title: 'Gérer les congés', sub: 'Action rapide', action: function() { showCongesOverview(); } });
  if ('export'.includes(query) || 'pdf'.includes(query)) results.push({ type: 'action', icon: '📄', title: 'Exporter PDF', sub: 'Action rapide', action: exportPDFReport });
  if ('objectif'.includes(query)) results.push({ type: 'action', icon: '🎯', title: 'Définir objectif', sub: 'Action rapide', action: showGoalModal });
  if ('backup'.includes(query) || 'json'.includes(query) || 'export'.includes(query)) results.push({ type: 'action', icon: '💾', title: 'Exporter données JSON', sub: 'Backup complet', action: exportJSON });
  if ('import'.includes(query) || 'restaurer'.includes(query)) results.push({ type: 'action', icon: '📥', title: 'Importer données JSON', sub: 'Restaurer backup', action: importJSON });
  if ('theme'.includes(query) || 'sombre'.includes(query) || 'clair'.includes(query)) results.push({ type: 'action', icon: '🎨', title: 'Changer le thème', sub: THEME === 'dark' ? 'Passer en clair' : 'Passer en sombre', action: toggleTheme });

  SEARCH_RESULTS = results.slice(0, 10);
  SEARCH_INDEX = 0;
  updateSearchResults(query);
}

function updateSearchResults(query) {
  var container = $('#searchResults');
  if (!container) return;
  container.innerHTML = '';
  
  if (SEARCH_RESULTS.length === 0) {
    container.appendChild(el('div', { class: 'search-empty' }, query ? 'Aucun résultat pour "' + query + '"' : 'Tape pour rechercher...'));
    return;
  }
  
  SEARCH_RESULTS.forEach(function(r, i) {
    var item = el('div', { class: 'search-result' + (i === SEARCH_INDEX ? ' selected' : ''), onclick: function() { hideSearch(); r.action(); } });
    item.appendChild(el('div', { class: 'search-result-icon' }, r.icon));
    item.appendChild(el('div', { class: 'search-result-info' }, [el('div', { class: 'search-result-title' }, r.title), el('div', { class: 'search-result-sub' }, r.sub)]));
    item.appendChild(el('div', { class: 'search-result-badge' }, r.type));
    container.appendChild(item);
  });
}

function handleSearchKey(e) {
  if (e.key === 'Escape') { hideSearch(); return; }
  if (e.key === 'ArrowDown') { SEARCH_INDEX = Math.min(SEARCH_INDEX + 1, SEARCH_RESULTS.length - 1); updateSearchResults(''); e.preventDefault(); }
  if (e.key === 'ArrowUp') { SEARCH_INDEX = Math.max(SEARCH_INDEX - 1, 0); updateSearchResults(''); e.preventDefault(); }
  if (e.key === 'Enter' && SEARCH_RESULTS[SEARCH_INDEX]) { hideSearch(); SEARCH_RESULTS[SEARCH_INDEX].action(); }
}

function autoBackup() {
  var data = { company: COMPANY, missions: MISSIONS, clients: CLIENTS, treasury: TREASURY, irConfig: IR_CONFIG, version: 'V50', date: localISO(TODAY) };
  var key = 'freel_backup_' + localISO(TODAY);
  localStorage.setItem(key, JSON.stringify(data));
  
  // Garder seulement les 7 derniers backups
  var keys = [];
  for (var i = 0; i < localStorage.length; i++) {
    var k = localStorage.key(i);
    if (k && k.startsWith('freel_backup_')) keys.push(k);
  }
  keys.sort().reverse();
  keys.slice(7).forEach(function(k) { localStorage.removeItem(k); });
  
  showBackupIndicator();
}

function showBackupIndicator() {
  var indicator = $('#backupIndicator');
  if (indicator) {
    indicator.classList.add('show');
    setTimeout(function() { indicator.classList.remove('show'); }, 2000);
  }
}

function initKeyboardShortcuts() {
  document.addEventListener('keydown', function(e) {
    if (SEARCH_OPEN) { handleSearchKey(e); return; }
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    if (e.key === '?' || (e.key === '/' && e.shiftKey)) { e.preventDefault(); toggleKeyboardHelp(); }
    if (e.key === '/' || (e.key === 'k' && (e.metaKey || e.ctrlKey))) { e.preventDefault(); showSearch(); }
    if (e.key === 'Escape') { hideSearch(); if (HELP_OPEN) toggleKeyboardHelp(); }
    if (e.key === 'n' && !e.metaKey && !e.ctrlKey) showMissionModal();
    if (e.key === 's' && !e.metaKey && !e.ctrlKey) showSalaireModal();
    if (e.key === 'c' && !e.metaKey && !e.ctrlKey) showChargeModal();
    if (e.key === 'e' && !e.metaKey && !e.ctrlKey) exportPDFReport();
    if (e.key === 'g' && !e.metaKey && !e.ctrlKey) showGoalModal();
  });
}

function createSearchOverlay() {
  var overlay = el('div', { id: 'searchOverlay', class: 'search-overlay', onclick: function(e) { if (e.target === overlay) hideSearch(); } });
  var box = el('div', { class: 'search-box' });
  var inputWrap = el('div', { class: 'search-input-wrap' });
  inputWrap.appendChild(el('span', {}, '🔍'));
  var input = el('input', { type: 'text', placeholder: 'Rechercher clients, factures, actions...', oninput: function() { performSearch(this.value); } });
  inputWrap.appendChild(input);
  inputWrap.appendChild(el('span', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'ESC'));
  box.appendChild(inputWrap);
  box.appendChild(el('div', { id: 'searchResults', class: 'search-results' }));
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function createKeyboardHelp() {
  var help = el('div', { id: 'keyboardHelp', class: 'keyboard-help' });
  help.appendChild(el('div', { class: 'keyboard-help-title' }, [el('span', {}, '⌨️'), el('span', {}, 'Raccourcis')]));
  var shortcuts = [
    ['/', 'Recherche'],
    ['N', 'Nouvelle mission'],
    ['S', 'Verser salaire'],
    ['C', 'Ajouter charge'],
    ['E', 'Export PDF'],
    ['G', 'Objectif CA'],
    ['?', 'Aide raccourcis'],
    ['Esc', 'Fermer']
  ];
  shortcuts.forEach(function(s) {
    var row = el('div', { class: 'keyboard-shortcut' });
    row.appendChild(el('span', {}, s[1]));
    row.appendChild(el('span', { class: 'keyboard-key' }, s[0]));
    help.appendChild(row);
  });
  document.body.appendChild(help);
}

function createBackupIndicator() {
  var indicator = el('div', { id: 'backupIndicator', class: 'backup-indicator' });
  indicator.appendChild(el('span', {}, '✓'));
  indicator.appendChild(el('span', {}, 'Sauvegardé'));
  document.body.appendChild(indicator);
}

// Sprint 13: Export/Import JSON
function exportJSON() {
  var data = {
    company: COMPANY,
    missions: MISSIONS,
    clients: CLIENTS,
    treasury: TREASURY,
    irConfig: IR_CONFIG,
    goalCA: localStorage.getItem('freel_goal_ca'),
    version: 'V50',
    exportDate: localISO(TODAY)
  };
  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'freel_backup_' + localISO(TODAY) + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Export JSON téléchargé', 'success');
}

function importJSON() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var data = JSON.parse(ev.target.result);
        if (data.company) COMPANY = Object.assign(COMPANY, data.company);
        if (data.missions) MISSIONS = data.missions;
        if (data.clients) CLIENTS = data.clients;
        if (data.treasury) TREASURY = Object.assign(TREASURY, data.treasury);
        if (data.irConfig) IR_CONFIG = Object.assign(IR_CONFIG, data.irConfig);
        if (data.goalCA) localStorage.setItem('freel_goal_ca', data.goalCA);
        MISSIONS.forEach(buildMission);
        saveAll();
        render();
        toast('Import réussi! Données restaurées.', 'success');
      } catch (err) {
        toast('Erreur: fichier JSON invalide', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Sprint 13: Theme toggle
var THEME = localStorage.getItem('freel_theme') || 'dark';

function toggleTheme() {
  THEME = THEME === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', THEME);
  localStorage.setItem('freel_theme', THEME);
  updateThemeButton();
}

function updateThemeButton() {
  var btn = $('#themeToggle');
  if (btn) btn.textContent = THEME === 'dark' ? '☀️' : '🌙';
}

function initTheme() {
  if (THEME === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  }
  updateThemeButton();
}

// Calcule le CA total de l'année en cours
function getTotalCA() {
  var currentYear = TODAY.getFullYear();
  var total = 0;
  MISSIONS.forEach(function(m) {
    if (m.factures) {
      m.factures.forEach(function(f) {
        if (f.status === 'payée' && f.mois && f.mois.startsWith(currentYear + '-')) {
          total += (f.montantHT || (f.jours * (m.tjm || 0)));
        }
      });
    }
  });
  return total;
}

// Sprint 14: Notification Center
var NOTIF_OPEN = false;
var NOTIF_READ = JSON.parse(localStorage.getItem('freel_notif_read') || '[]');

function getNotifications() {
  var notifs = [];
  var now = TODAY;

  // Factures en retard
  MISSIONS.forEach(function(m) {
    if (m.factures) {
      m.factures.forEach(function(f) {
        if (f.status === 'envoyée') {
          var echeance = parseDate(f.echeance || f.mois);
          var days = Math.floor((now - echeance) / 86400000);
          if (days > 0) {
            notifs.push({
              id: 'facture_' + f.numero,
              type: 'urgent',
              icon: '⚠️',
              text: 'Facture ' + (f.client || m.client) + ' en retard',
              sub: EUR(f.ttc) + ' · ' + days + ' jour' + (days > 1 ? 's' : '') + ' de retard',
              time: days + 'j',
              action: function() { showFactureModal(f); }
            });
          } else if (days >= -3) {
            notifs.push({
              id: 'facture_soon_' + f.numero,
              type: 'warning',
              icon: '📄',
              text: 'Facture ' + (f.client || m.client) + ' bientôt due',
              sub: EUR(f.ttc) + ' · échéance ' + fmtDate(echeance),
              time: Math.abs(days) + 'j',
              action: function() { showFactureModal(f); }
            });
          }
        }
      });
    }
  });

  // Échéances légales
  var deadlines = getUpcomingDeadlines ? getUpcomingDeadlines() : [];
  deadlines.forEach(function(d) {
    if (d.daysLeft <= 7) {
      notifs.push({
        id: 'deadline_' + d.label.replace(/\s/g, '_'),
        type: d.daysLeft <= 3 ? 'urgent' : 'warning',
        icon: d.icon,
        text: d.label,
        sub: d.daysLeft === 0 ? 'Aujourd\'hui!' : d.daysLeft === 1 ? 'Demain' : 'Dans ' + d.daysLeft + ' jours',
        time: 'J-' + d.daysLeft
      });
    }
  });

  // Seuil TVA proche
  var ca = getTotalCA();
  var seuilTVA = LEGAL.seuilTVA;
  if (ca >= seuilTVA * 0.9 && ca < seuilTVA) {
    notifs.push({
      id: 'tva_seuil',
      type: 'info',
      icon: '📊',
      text: 'Seuil TVA proche',
      sub: 'CA: ' + EUR(ca) + ' / ' + EUR(seuilTVA) + ' (' + Math.round(ca/seuilTVA*100) + '%)',
      time: 'Info'
    });
  }

  // ACRE expiration
  if (COMPANY.debut) {
    var creation = parseDate(COMPANY.debut);
    var acreEnd = new Date(creation);
    acreEnd.setFullYear(acreEnd.getFullYear() + 1);
    var daysToAcre = Math.floor((acreEnd - now) / 86400000);
    if (daysToAcre > 0 && daysToAcre <= 30) {
      notifs.push({
        id: 'acre_expire',
        type: daysToAcre <= 7 ? 'warning' : 'info',
        icon: '🎁',
        text: 'ACRE expire bientôt',
        sub: 'Fin le ' + fmtDate(acreEnd) + ' · Cotisations +' + Math.round((0.222 - 0.111) * 100) + '%',
        time: 'J-' + daysToAcre
      });
    }
  }

  // Marquer comme lu/non lu
  notifs.forEach(function(n) {
    n.unread = NOTIF_READ.indexOf(n.id) === -1;
  });

  return notifs.sort(function(a, b) {
    if (a.type === 'urgent' && b.type !== 'urgent') return -1;
    if (b.type === 'urgent' && a.type !== 'urgent') return 1;
    return 0;
  });
}

function toggleNotifCenter() {
  NOTIF_OPEN = !NOTIF_OPEN;
  var center = $('#notifCenter');
  if (center) center.classList.toggle('show', NOTIF_OPEN);
  if (NOTIF_OPEN) renderNotifList();
}

function renderNotifList() {
  var list = $('#notifList');
  if (!list) return;
  list.innerHTML = '';

  var notifs = getNotifications();
  if (notifs.length === 0) {
    list.appendChild(el('div', { class: 'notif-empty' }, '✓ Aucune notification'));
    return;
  }

  notifs.forEach(function(n) {
    var item = el('div', {
      class: 'notif-item ' + n.type + (n.unread ? ' unread' : ''),
      onclick: function() {
        markNotifRead(n.id);
        if (n.action) { toggleNotifCenter(); n.action(); }
      }
    });
    item.appendChild(el('div', { class: 'notif-icon ' + n.type }, n.icon));
    var content = el('div', { class: 'notif-content' });
    content.appendChild(el('div', { class: 'notif-text' }, n.text));
    content.appendChild(el('div', { class: 'notif-sub' }, n.sub));
    item.appendChild(content);
    item.appendChild(el('div', { class: 'notif-time' }, n.time));
    list.appendChild(item);
  });
}

function markNotifRead(id) {
  if (NOTIF_READ.indexOf(id) === -1) {
    NOTIF_READ.push(id);
    localStorage.setItem('freel_notif_read', JSON.stringify(NOTIF_READ));
    updateNotifBadge();
  }
}

function clearAllNotifs() {
  var notifs = getNotifications();
  notifs.forEach(function(n) { markNotifRead(n.id); });
  renderNotifList();
}

function updateNotifBadge() {
  var notifs = getNotifications();
  var unread = notifs.filter(function(n) { return n.unread; }).length;
  var badge = $('#notifBadge');
  if (badge) {
    badge.textContent = unread;
    badge.style.display = unread > 0 ? 'flex' : 'none';
  }
}

function createNotifCenter() {
  var center = el('div', { id: 'notifCenter', class: 'notif-center' });
  var header = el('div', { class: 'notif-header' });
  header.appendChild(el('div', { class: 'notif-title' }, '🔔 Notifications'));
  header.appendChild(el('div', { class: 'notif-clear', onclick: clearAllNotifs }, 'Tout marquer lu'));
  center.appendChild(header);
  center.appendChild(el('div', { id: 'notifList', class: 'notif-list' }));
  document.body.appendChild(center);

  document.addEventListener('click', function(e) {
    if (NOTIF_OPEN && !e.target.closest('.notif-center') && !e.target.closest('.notif-btn')) {
      toggleNotifCenter();
    }
  });
}

function renderDashboardDeadlines(container) {
  var deadlines = getUpcomingDeadlines();
  if (deadlines.length === 0) return;
  
  var deadlinesDiv = el('div', { style: { background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(239, 68, 68, 0.1))', border: '1px solid rgba(251, 191, 36, 0.3)', borderRadius: 'var(--radius-lg)', padding: '12px 16px', marginBottom: '12px' } });
  deadlinesDiv.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--warning)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '⏰ Échéances à venir'));
  var deadlinesList = el('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '8px' } });
  deadlines.slice(0, 3).forEach(function(d) {
    var urgency = d.daysLeft <= 3 ? 'var(--danger)' : d.daysLeft <= 7 ? 'var(--warning)' : 'var(--text-secondary)';
    var chip = el('div', { style: { display: 'flex', alignItems: 'center', gap: '6px', background: 'var(--bg-tertiary)', padding: '6px 10px', borderRadius: '20px', fontSize: '11px' } });
    chip.appendChild(el('span', {}, d.icon));
    chip.appendChild(el('span', { style: { fontWeight: '500' } }, d.label));
    chip.appendChild(el('span', { style: { color: urgency, fontWeight: '700' } }, d.daysLeft === 0 ? 'Aujourd\'hui!' : d.daysLeft === 1 ? 'Demain' : 'J-' + d.daysLeft));
    deadlinesList.appendChild(chip);
  });
  deadlinesDiv.appendChild(deadlinesList);
  container.appendChild(deadlinesDiv);
}

/**
 * Affiche les alertes groupées
 */
function renderDashboardAlerts(container, data) {
  if (data.alerts.length === 0) return;
  
  var alertsDiv = el('div', { class: 'alerts-container' });
  var summary = el('div', { class: 'alerts-summary' + (ALERTS_OPEN ? ' open' : ''), onclick: function() { ALERTS_OPEN = !ALERTS_OPEN; render(); } });
  summary.appendChild(el('span', { class: 'alerts-badge' }, String(data.alerts.length)));
  summary.appendChild(el('span', { class: 'alerts-text' }, data.alerts.length === 1 ? data.alerts[0].title : data.alerts.length + ' notifications'));
  summary.appendChild(el('span', { class: 'alerts-chevron' }, '▼'));
  alertsDiv.appendChild(summary);
  
  var list = el('div', { class: 'alerts-list' + (ALERTS_OPEN ? ' open' : '') });
  data.alerts.forEach(function(a) {
    var alert = el('div', { class: 'alert alert-' + a.type });
    alert.appendChild(el('span', { class: 'alert-icon' }, a.icon));
    var content = el('div', { class: 'alert-content' });
    content.appendChild(el('div', { class: 'alert-title' }, a.title));
    if (a.text) content.appendChild(el('div', { class: 'alert-text' }, a.text));
    
    if (a.hasButtons) {
      var btns = el('div', { style: { marginTop: '8px' } });
      if (data.provByType['URSSAF']) btns.appendChild(el('button', { class: 'alert-btn', onclick: function(e) { e.stopPropagation(); var ids = data.detailChargesAPayer.filter(function(c) { return c.cat === 'URSSAF'; }).map(function(c) { return c.id; }); markAllPaid(ids); } }, '✅ URSSAF'));
      if (data.provByType['TVA']) btns.appendChild(el('button', { class: 'alert-btn', onclick: function(e) { e.stopPropagation(); var ids = data.detailChargesAPayer.filter(function(c) { return c.cat === 'TVA'; }).map(function(c) { return c.id; }); markAllPaid(ids); } }, '✅ TVA'));
      content.appendChild(btns);
    }
    if (a.action === 'salaire') {
      content.appendChild(el('button', { class: 'alert-btn', onclick: function(e) { e.stopPropagation(); showSalaireModal(data.salaireReco); } }, '💸 Verser'));
    }
    alert.appendChild(content);
    list.appendChild(alert);
  });
  alertsDiv.appendChild(list);
  container.appendChild(alertsDiv);
}

/**
 * Affiche la carte Hero avec cash disponible et camembert répartition
 */
function renderDashboardHero(container, data) {
  // V53: Hero section avec camembert répartition
  var hero = el('div', { class: 'hero' + (data.soldeAbsolu < 0 ? ' negative' : '') });

  // Ligne principale: Cash + Settings
  var heroHeader = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } });

  var heroMain = el('div', { class: 'hero-main', onclick: showCashDetail, style: { cursor: 'pointer', flex: 1 } });
  heroMain.appendChild(el('div', { class: 'hero-label' }, '💰 Cash Disponible'));
  heroMain.appendChild(el('div', { class: 'hero-value ' + (data.cashDispoAbsolu >= 0 ? 'positive' : 'negative') }, EUR(data.cashDispoAbsolu)));
  heroHeader.appendChild(heroMain);

  // Bouton paramètres
  heroHeader.appendChild(el('button', {
    class: 'btn btn-sm',
    style: { background: 'var(--bg-tertiary)', border: 'none' },
    onclick: function(e) { e.stopPropagation(); showTresoSettings(); },
    title: 'Paramètres trésorerie'
  }, '⚙️'));

  hero.appendChild(heroHeader);

  // V53: Camembert répartition du compte pro
  var solde = Math.max(0, data.soldeAbsolu);
  var pctCash = solde > 0 ? (data.cashDispoAbsolu / solde * 100) : 0;
  var pctProv = solde > 0 ? (data.provisionsAbsolues / solde * 100) : 0;

  // Correction si cash négatif
  if (data.cashDispoAbsolu < 0) {
    pctCash = 0;
    pctProv = 100;
  }

  var pieContainer = el('div', { style: {
    display: 'flex', alignItems: 'center', gap: '16px', marginTop: '16px',
    padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '12px'
  }});

  // Pie chart SVG
  var pieSize = 70;
  var pieDiv = el('div', { style: { position: 'relative', width: pieSize + 'px', height: pieSize + 'px' } });
  var angle1 = (pctCash / 100) * 360;
  var svgNS = 'http://www.w3.org/2000/svg';
  var svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('width', pieSize);
  svg.setAttribute('height', pieSize);
  svg.setAttribute('viewBox', '0 0 100 100');

  // Background circle (provisions)
  var bgCircle = document.createElementNS(svgNS, 'circle');
  bgCircle.setAttribute('cx', '50');
  bgCircle.setAttribute('cy', '50');
  bgCircle.setAttribute('r', '40');
  bgCircle.setAttribute('fill', 'none');
  bgCircle.setAttribute('stroke', '#a855f7');
  bgCircle.setAttribute('stroke-width', '20');
  svg.appendChild(bgCircle);

  // Cash disponible arc
  if (pctCash > 0) {
    var cashCircle = document.createElementNS(svgNS, 'circle');
    cashCircle.setAttribute('cx', '50');
    cashCircle.setAttribute('cy', '50');
    cashCircle.setAttribute('r', '40');
    cashCircle.setAttribute('fill', 'none');
    cashCircle.setAttribute('stroke', '#22c55e');
    cashCircle.setAttribute('stroke-width', '20');
    cashCircle.setAttribute('stroke-dasharray', (pctCash * 2.51) + ' 251');
    cashCircle.setAttribute('transform', 'rotate(-90 50 50)');
    svg.appendChild(cashCircle);
  }

  pieDiv.appendChild(svg);

  // Solde au centre
  var centerLabel = el('div', { style: {
    position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
    fontSize: '10px', fontWeight: '700', textAlign: 'center', lineHeight: '1.2'
  }});
  centerLabel.appendChild(el('div', { style: { fontSize: '11px', fontWeight: '800' } }, EUR(data.soldeAbsolu, true)));
  centerLabel.appendChild(el('div', { style: { fontSize: '8px', color: 'var(--text-muted)' } }, 'Solde'));
  pieDiv.appendChild(centerLabel);
  pieContainer.appendChild(pieDiv);

  // Légende
  var legend = el('div', { style: { flex: 1, fontSize: '12px' } });
  legend.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' } }, [
    el('div', { style: { width: '12px', height: '12px', borderRadius: '3px', background: '#22c55e' } }),
    el('span', {}, 'Cash: ' + EUR(data.cashDispoAbsolu) + ' (' + Math.round(pctCash) + '%)')
  ]));
  legend.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
    el('div', { style: { width: '12px', height: '12px', borderRadius: '3px', background: '#a855f7' } }),
    el('span', {}, 'Provisions: ' + EUR(data.provisionsAbsolues) + ' (' + Math.round(pctProv) + '%)')
  ]));

  // V67: Détail provisions par type - cliquable pour voir/modifier
  if (data.provAbsoluesByType && Object.keys(data.provAbsoluesByType).length > 0) {
    var provTypes = Object.keys(data.provAbsoluesByType).sort(function(a, b) {
      return data.provAbsoluesByType[b] - data.provAbsoluesByType[a];
    });
    var provDetail = el('div', { style: { marginLeft: '20px', marginTop: '4px', fontSize: '10px' } });
    provTypes.forEach(function(type) {
      var montant = data.provAbsoluesByType[type];
      if (montant > 0) {
        var items = data.allProvisionsDetail.filter(function(p) { return p.cat === type || (type === 'IR Estimé' && p.cat.indexOf('IR') >= 0); });
        var typeRow = el('div', {
          style: { display: 'flex', justifyContent: 'space-between', padding: '3px 6px', borderRadius: '4px', cursor: 'pointer', color: 'var(--text-muted)' },
          onclick: function() { showProvisionTypeDetail(type, items, '#a855f7'); }
        }, [
          el('span', {}, '• ' + type + ' ›'),
          el('span', { style: { fontWeight: '600', color: '#a855f7' } }, EUR(montant))
        ]);
        typeRow.onmouseenter = function() { typeRow.style.background = 'var(--bg-secondary)'; };
        typeRow.onmouseleave = function() { typeRow.style.background = 'none'; };
        provDetail.appendChild(typeRow);
      }
    });
    legend.appendChild(provDetail);
  }

  pieContainer.appendChild(legend);

  hero.appendChild(pieContainer);

  // V60: Réorganisation - Composition Compte d'abord, puis Salaire + Autonomie côte à côte en dernier
  // V59: Bloc composition compte pro (ABSOLU - indépendant des filtres)
  var balDetail = getAbsoluteBalanceDetail();
  var compteBlock = el('div', { style: { marginTop: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  compteBlock.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '8px', fontWeight: '600', textTransform: 'uppercase' } }, '📊 Composition Compte (actuel)'));

  // V60: Lignes cliquables avec détail groupé par mois/type
  var detailRow = function(label, amount, color, onClick) {
    var row = el('div', {
      style: { display: 'flex', justifyContent: 'space-between', padding: '5px 4px', fontSize: '11px', borderRadius: '4px', cursor: onClick ? 'pointer' : 'default' },
      onclick: onClick || null
    }, [
      el('span', {}, label + (onClick ? ' ›' : '')),
      el('span', { style: { fontWeight: '600', color: color || 'inherit' } }, EUR(amount))
    ]);
    if (onClick) { row.onmouseenter = function() { row.style.background = 'var(--bg-secondary)'; }; row.onmouseleave = function() { row.style.background = 'none'; }; }
    return row;
  };

  compteBlock.appendChild(detailRow('Solde initial', balDetail.soldeInitial));
  compteBlock.appendChild(detailRow('+ Encaissements TTC', balDetail.encaissements, 'var(--success)', function() { showCompteLineDetail('encaissements'); }));
  compteBlock.appendChild(detailRow('- Charges payées', balDetail.chargesPayees, 'var(--danger)', function() { showCompteLineDetail('charges'); }));
  compteBlock.appendChild(detailRow('- Salaires versés', balDetail.salaires, 'var(--info)', function() { showCompteLineDetail('salaires'); }));
  if (balDetail.interets > 0) {
    compteBlock.appendChild(detailRow('+ Intérêts compte', balDetail.interets, 'var(--success)'));
  }
  compteBlock.appendChild(el('div', { style: { borderTop: '1px solid var(--border)', marginTop: '6px', paddingTop: '6px', display: 'flex', justifyContent: 'space-between', fontWeight: '700', fontSize: '12px' } }, [
    el('span', {}, '= Solde compte'),
    el('span', { style: { color: balDetail.soldeActuel >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(balDetail.soldeActuel))
  ]));

  hero.appendChild(compteBlock);

  // V60: Salaire versable + Autonomie côte à côte en dernier
  var bottomRow = el('div', { style: { display: 'flex', gap: '8px', marginTop: '12px' } });

  // Salaire versable
  var salaireDiv = el('div', { style: {
    flex: '1', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px'
  }});
  salaireDiv.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, '💸 Salaire versable'));
  salaireDiv.appendChild(el('div', { style: { fontWeight: '700', fontSize: '18px', color: 'var(--success)' } }, EUR(data.salaireVersable)));
  salaireDiv.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Cash - ' + EUR(data.reserveCompte) + ' réserve'));
  if (data.salaireVersable >= 500) {
    salaireDiv.appendChild(el('button', {
      class: 'btn btn-success btn-sm',
      style: { marginTop: '8px', width: '100%' },
      onclick: function(e) { e.stopPropagation(); showSalaireModal(data.salaireVersable); }
    }, 'Verser'));
  }
  bottomRow.appendChild(salaireDiv);

  // Autonomie
  var autoDiv = el('div', {
    style: { flex: '1', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', cursor: 'pointer' },
    onclick: function(e) { e.stopPropagation(); showProjectionAutonomieModal(); },
    title: 'Cliquer pour voir la projection d\'autonomie'
  });
  autoDiv.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, '⏱️ Autonomie'));
  autoDiv.appendChild(el('div', { style: { fontWeight: '700', fontSize: '18px', color: data.runway > 6 ? 'var(--success)' : data.runway > 3 ? 'var(--warning)' : 'var(--danger)' } }, data.runway + ' mois'));
  autoDiv.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Sans nouveau CA'));
  autoDiv.appendChild(el('div', { style: { fontSize: '9px', color: 'var(--accent)', marginTop: '4px' } }, 'Voir projection →'));
  bottomRow.appendChild(autoDiv);

  hero.appendChild(bottomRow);

  container.appendChild(hero);
}

// V51: Modal paramètres trésorerie
function showTresoSettings() {
  var content = el('div', { style: { padding: '10px' } });
  
  content.appendChild(createInput('Salaire mensuel estimé (€)', 'number', 'tresoSalaireEstime', TREASURY.salaireEstime || 2200));
  content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '-8px', marginBottom: '12px' } }, 'Utilisé pour calculer l\'autonomie'));
  
  content.appendChild(createInput('Réserve minimum compte (€)', 'number', 'tresoReserve', TREASURY.reserveCompte || 150));
  content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '-8px', marginBottom: '12px' } }, 'Montant à garder sur le compte pro'));
  
  content.appendChild(el('button', { class: 'btn btn-primary', style: { width: '100%', marginTop: '12px' }, onclick: function() {
    TREASURY.salaireEstime = parseFloat($('#tresoSalaireEstime').value) || 2200;
    TREASURY.reserveCompte = parseFloat($('#tresoReserve').value) || 150;
    saveAll();
    closeDynamicModal();
    render();
    showToast('✅ Paramètres enregistrés', 'success');
  }}, '💾 Enregistrer'));
  
  showModal('⚙️ Paramètres Trésorerie', content);
}

// V60/V71: Widget CA ANNUEL avec réalisé + projeté + conséquences plafond
function renderCAPlafondWidget(container) {
  var data = compute();
  var year = PERIOD.year || TODAY.getFullYear();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var currentCA = data.caHT || 0;

  // Seuils micro-entrepreneur BNC 2024-2026
  var plafond = 77700;        // Plafond micro-entrepreneur (régime fiscal)
  // Note: Le seuil majoré n'existe QUE pour la TVA (41,250€ pour services), pas pour le statut micro
  var seuilTVA = 37500;       // Franchise TVA (services BNC)
  var seuilTVAMajore = 41250; // Seuil majoré TVA = assujettissement immédiat

  // V71: Calculer le CA projeté à partir des factures non payées (encaissement prévu sur l'année)
  var caProjecte = 0;
  MISSIONS.forEach(function(mis) {
    if (!mis.factures) return;
    mis.factures.forEach(function(f) {
      if (f.jours <= 0 || f.status === 'payée') return;
      var paymentMonth = getPaymentMonth(f.mois, mis.delaiPaiement, mis.jourPaiement);
      if (paymentMonth.startsWith(year + '-') && paymentMonth > nowYm) {
        caProjecte += f.ht;
      }
    });
  });

  // V71: CA année précédente pour règle des 2 ans consécutifs
  var prevYearData = getIRForYear(year - 1);
  var caPrevYear = prevYearData.caTotal || 0;
  var prevYearOverLimit = caPrevYear > plafond;

  var caTotal = currentCA + caProjecte;
  var pctRealise = Math.min(1, currentCA / plafond);
  var pctTotal = Math.min(1.3, caTotal / plafond);
  var pctColor = caTotal >= plafond ? '#f97316' : caTotal >= plafond * 0.9 ? 'var(--warning)' : 'var(--success)';

  var widget = el('div', { class: 'card', style: { marginBottom: '16px' } });

  // Header
  var header = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' } });
  header.appendChild(el('div', { class: 'card-title', style: { margin: 0 } }, '📊 CA Annuel ' + year));
  header.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textAlign: 'right' } }, [
    el('div', {}, 'Plafond micro: ' + EUR(plafond)),
    el('div', { style: { color: currentCA > seuilTVA ? 'var(--warning)' : 'inherit' } }, 'Franchise TVA: ' + EUR(seuilTVA))
  ]));
  widget.appendChild(header);

  // Barre de progression avec réalisé + projeté + indicateur limite
  // V72: Echelle dynamique - la barre représente de 0 à maxScale
  var maxScale = Math.max(plafond * 1.15, caTotal * 1.05);
  var progressContainer = el('div', { style: { position: 'relative', marginBottom: '24px' } });

  // Barre fond
  var progressBg = el('div', { style: {
    height: '32px', background: 'var(--bg-tertiary)', borderRadius: '16px', overflow: 'hidden', position: 'relative'
  }});

  // Partie réalisée
  var realWidth = Math.min(100, (currentCA / maxScale) * 100);
  var realBar = el('div', { style: {
    height: '100%', width: realWidth + '%',
    background: pctColor,
    borderRadius: '16px 0 0 16px',
    display: 'flex', alignItems: 'center', justifyContent: 'center',
    color: 'white', fontSize: '10px', fontWeight: '700',
    position: 'absolute', left: '0', top: '0', zIndex: 2
  } }, realWidth > 18 ? EUR(currentCA) : '');
  progressBg.appendChild(realBar);

  // Partie projetée (transparente avec motif)
  if (caProjecte > 0) {
    var projWidth = Math.min(100 - realWidth, (caProjecte / maxScale) * 100);
    var projBar = el('div', { style: {
      height: '100%', width: projWidth + '%',
      background: 'repeating-linear-gradient(90deg, rgba(167,139,250,0.3) 0px, rgba(167,139,250,0.3) 4px, rgba(167,139,250,0.15) 4px, rgba(167,139,250,0.15) 8px)',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      color: '#a78bfa', fontSize: '10px', fontWeight: '700',
      position: 'absolute', left: realWidth + '%', top: '0', zIndex: 1
    } }, projWidth > 12 ? '+' + EUR(caProjecte) : '');
    progressBg.appendChild(projBar);
  }

  progressContainer.appendChild(progressBg);

  // V72: Indicateur limite plafond - positionné proportionnellement à l'échelle
  var plafondPct = (plafond / maxScale) * 100;
  var limitIndicator = el('div', { style: {
    position: 'absolute', left: 'calc(' + plafondPct.toFixed(1) + '% - 1px)', top: '-4px', bottom: '-4px',
    width: '3px', background: 'var(--danger)', borderRadius: '2px', zIndex: 10
  }});
  var limitLabel = el('div', { style: {
    position: 'absolute', left: plafondPct.toFixed(1) + '%', top: '-18px', transform: 'translateX(-50%)',
    fontSize: '9px', color: 'var(--danger)', fontWeight: '700', whiteSpace: 'nowrap'
  } }, '▼ ' + EUR(plafond, true));
  progressContainer.appendChild(limitIndicator);
  progressContainer.appendChild(limitLabel);

  widget.appendChild(progressContainer);

  // Stats : Réalisé + Projeté
  var stats = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' } });

  var leftStats = el('div', {});
  leftStats.appendChild(el('div', { style: { fontSize: '22px', fontWeight: '800', color: pctColor } }, EUR(currentCA)));
  leftStats.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Encaissé · ' + Math.round(pctRealise * 100) + '%'));
  if (caProjecte > 0) {
    leftStats.appendChild(el('div', { style: { fontSize: '12px', color: '#a78bfa', fontWeight: '600', marginTop: '2px' } }, '+ ' + EUR(caProjecte) + ' à encaisser'));
    leftStats.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Total prévu: ' + EUR(caTotal) + ' (' + Math.round(pctTotal * 100) + '%)'));
  }
  stats.appendChild(leftStats);

  var remaining = plafond - caTotal;
  var rightStats = el('div', { style: { textAlign: 'right' } });
  if (remaining > 0) {
    rightStats.appendChild(el('div', { style: { fontSize: '14px', fontWeight: '600' } }, EUR(remaining)));
    rightStats.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'disponible'));
  } else {
    rightStats.appendChild(el('div', { style: { fontSize: '14px', fontWeight: '600', color: 'var(--danger)' } }, '⚠️ +' + EUR(Math.abs(remaining))));
    rightStats.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--danger)' } }, 'au-delà plafond'));
  }
  stats.appendChild(rightStats);
  widget.appendChild(stats);

  // V71: Conséquences avec vraies règles fiscales
  var conseqDiv = el('div', { style: { marginTop: '12px', padding: '10px', borderRadius: '8px', fontSize: '11px' } });

  if (caTotal > plafond && prevYearOverLimit) {
    // 2ème année consécutive de dépassement = sortie
    conseqDiv.style.background = 'rgba(239, 68, 68, 0.15)';
    conseqDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
    conseqDiv.style.color = 'var(--danger)';
    conseqDiv.innerHTML = '🚨 <strong>2ème année de dépassement</strong><br>' + (year - 1) + ': ' + EUR(caPrevYear) + ' · ' + year + ': ' + EUR(caTotal) + '<br>Sortie du régime micro au 1er janvier ' + (year + 1) + '. Préparez le passage au réel.';
  } else if (caTotal > plafond) {
    // 1ère année de dépassement = tolérance
    conseqDiv.style.background = 'rgba(251, 191, 36, 0.15)';
    conseqDiv.style.border = '1px solid rgba(251, 191, 36, 0.3)';
    conseqDiv.style.color = '#b45309';
    conseqDiv.innerHTML = '⚠️ <strong>Dépassement plafond - 1ère année</strong><br>Tolérance accordée si le dépassement n\'est pas renouvelé en ' + (year + 1) + '. Restez sous ' + EUR(plafond) + ' l\'an prochain pour conserver le régime micro.';
  } else if (caTotal > plafond * 0.9) {
    conseqDiv.style.background = 'rgba(251, 191, 36, 0.1)';
    conseqDiv.style.color = 'var(--warning)';
    conseqDiv.innerHTML = '⚡ <strong>Proche du plafond</strong> (' + Math.round(pctTotal * 100) + '%)<br>Marge restante: ' + EUR(remaining) + '. Anticipez pour éviter un dépassement.';
  } else if (caTotal > plafond * 0.7) {
    conseqDiv.style.background = 'rgba(34, 197, 94, 0.08)';
    conseqDiv.style.color = 'var(--text-secondary)';
    conseqDiv.innerHTML = '✅ <strong>Bonne progression</strong><br>Marge de ' + EUR(remaining) + ' avant le plafond (' + Math.round((1 - pctTotal) * 100) + '% disponible).';
  } else {
    conseqDiv.style.background = 'rgba(34, 197, 94, 0.05)';
    conseqDiv.style.color = 'var(--text-muted)';
    conseqDiv.innerHTML = '✅ Large marge disponible sous le plafond micro-entrepreneur.';
  }

  // Info année précédente si pertinent
  if (caPrevYear > 0 && caTotal > plafond * 0.8) {
    var prevInfo = el('div', { style: { marginTop: '8px', paddingTop: '8px', borderTop: '1px solid var(--border)', fontSize: '10px', color: 'var(--text-muted)' } });
    prevInfo.innerHTML = '📅 CA ' + (year - 1) + ': ' + EUR(caPrevYear) + (prevYearOverLimit ? ' <span style="color:var(--danger)">(> plafond)</span>' : ' <span style="color:var(--success)">(OK)</span>');
    conseqDiv.appendChild(prevInfo);
  }

  widget.appendChild(conseqDiv);

  // V72: Info TVA séparée (franchise TVA ≠ statut micro)
  // Règles officielles (BOFiP, service-public.fr):
  // - CA N-1 > 37,500€ → assujetti TVA au 1er janvier N (plus d'année de tolérance depuis 2025)
  // - CA en cours > 41,250€ (seuil majoré) → assujetti TVA immédiat
  // - CA N-1 ≤ 37,500€ → retour automatique en franchise au 1er janvier N
  var prevYearOverTVA = caPrevYear > seuilTVA;
  var assujettiTVAThisYear = prevYearOverTVA; // Si CA N-1 > seuil → assujetti au 1er janv
  var tvaDiv = el('div', { style: { marginTop: '12px', padding: '10px', borderRadius: '8px', fontSize: '11px' } });
  var showTVA = false;

  if (assujettiTVAThisYear) {
    // Assujetti TVA cette année car CA année précédente > seuil
    showTVA = true;
    tvaDiv.style.background = 'rgba(236, 72, 153, 0.12)';
    tvaDiv.style.border = '1px solid rgba(236, 72, 153, 0.25)';
    tvaDiv.style.color = '#db2777';
    var tvaMsg = '💰 <strong>Assujetti TVA en ' + year + '</strong><br>';
    tvaMsg += 'CA ' + (year - 1) + ': ' + EUR(caPrevYear) + ' > franchise ' + EUR(seuilTVA) + ' → Vous devez collecter et reverser la TVA toute l\'année ' + year + '.';
    // Projection pour l'année prochaine
    if (caTotal <= seuilTVA) {
      tvaMsg += '<br><span style="color:var(--success)">📉 Si votre CA ' + year + ' reste ≤ ' + EUR(seuilTVA) + ', retour automatique en franchise TVA au 1er janvier ' + (year + 1) + '.</span>';
    } else {
      tvaMsg += '<br>CA prévu ' + year + ': ' + EUR(caTotal) + ' > ' + EUR(seuilTVA) + ' → Vous resterez assujetti TVA en ' + (year + 1) + '.';
    }
    tvaDiv.innerHTML = tvaMsg;
  } else if (currentCA > seuilTVAMajore) {
    // Seuil majoré dépassé en cours d'année → TVA immédiate
    showTVA = true;
    tvaDiv.style.background = 'rgba(236, 72, 153, 0.15)';
    tvaDiv.style.border = '1px solid rgba(236, 72, 153, 0.3)';
    tvaDiv.style.color = '#db2777';
    tvaDiv.innerHTML = '💰 <strong>Seuil majoré TVA dépassé</strong><br>CA encaissé ' + EUR(currentCA) + ' > ' + EUR(seuilTVAMajore) + ' → Assujettissement TVA immédiat. Facturez la TVA dès maintenant.';
  } else if (currentCA > seuilTVA || caTotal > seuilTVA) {
    // Seuil de base dépassé cette année → TVA au 1er janvier prochain
    showTVA = true;
    tvaDiv.style.background = 'rgba(236, 72, 153, 0.08)';
    tvaDiv.style.border = '1px solid rgba(236, 72, 153, 0.15)';
    tvaDiv.style.color = '#ec4899';
    if (currentCA > seuilTVA) {
      tvaDiv.innerHTML = '💰 <strong>Franchise TVA dépassée</strong><br>CA encaissé ' + EUR(currentCA) + ' > ' + EUR(seuilTVA) + ' → TVA applicable au 1er janvier ' + (year + 1) + '. Préparez vos factures avec TVA.';
    } else {
      tvaDiv.innerHTML = '💰 <strong>Attention TVA</strong><br>CA prévu ' + EUR(caTotal) + ' > franchise ' + EUR(seuilTVA) + '. Si confirmé, assujettissement TVA au 1er janvier ' + (year + 1) + '.';
    }
  }

  if (showTVA) widget.appendChild(tvaDiv);

  container.appendChild(widget);
}

// V51: Widget PROJECTION AUTONOMIE avec barre horizontale
function renderProjectionAutonomie(container) {
  var data = compute();
  var runway = data.runway || 0;
  var maxMonths = 12; // Afficher sur 12 mois max
  var pct = Math.min(1, runway / maxMonths);

  var depensesMensuelles = (data.salaireEstime || 2200) + (data.avgCharges || 500);

  var widget = el('div', { class: 'card', style: { marginBottom: '16px' } });

  // Header
  widget.appendChild(el('div', { class: 'card-title' }, '🔮 Projection Autonomie'));

  // Dépenses mensuelles
  var depenses = el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginBottom: '12px' } });
  depenses.innerHTML = 'Dépenses mensuelles: <strong>' + EUR(depensesMensuelles) + '</strong> (' +
    EUR(data.salaireEstime || 2200) + ' salaire + ' + EUR(data.avgCharges || 500) + ' charges)';
  widget.appendChild(depenses);

  // Barre horizontale avec zones
  var barContainer = el('div', { style: { position: 'relative', marginBottom: '8px' } });

  // Labels au-dessus
  var labels = el('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '10px', color: 'var(--text-muted)', marginBottom: '4px' } });
  labels.appendChild(el('span', {}, 'Aujourd\'hui'));
  labels.appendChild(el('span', {}, '3 mois'));
  labels.appendChild(el('span', {}, '6 mois'));
  labels.appendChild(el('span', {}, '12 mois'));
  barContainer.appendChild(labels);

  // Barre avec zones colorées
  var bar = el('div', { style: {
    height: '20px', borderRadius: '10px', overflow: 'hidden', display: 'flex',
    background: 'var(--bg-tertiary)'
  }});

  // Zone OK (0-3 mois = 25%)
  bar.appendChild(el('div', { style: { width: '25%', background: 'var(--success)', opacity: runway >= 3 ? '1' : '0.3' }}));
  // Zone Attention (3-6 mois = 25%)
  bar.appendChild(el('div', { style: { width: '25%', background: 'var(--warning)', opacity: runway >= 6 ? '1' : runway >= 3 ? '0.3' : '0.15' }}));
  // Zone Critique (6-12 mois = 50%)
  bar.appendChild(el('div', { style: { width: '50%', background: 'var(--danger)', opacity: runway >= 12 ? '1' : runway >= 6 ? '0.3' : '0.15' }}));
  barContainer.appendChild(bar);

  // Marqueur position actuelle
  var markerPos = Math.min(100, (runway / maxMonths) * 100);
  var marker = el('div', { style: {
    position: 'absolute', bottom: '0', left: markerPos + '%', transform: 'translateX(-50%)',
    width: '3px', height: '20px', background: 'white', borderRadius: '2px',
    boxShadow: '0 0 4px rgba(0,0,0,0.5)'
  }});
  barContainer.appendChild(marker);

  widget.appendChild(barContainer);

  // Légende
  var legend = el('div', { style: { display: 'flex', gap: '16px', fontSize: '10px', marginTop: '8px' } });
  legend.appendChild(el('span', { style: { display: 'flex', alignItems: 'center', gap: '4px' } }, [
    el('span', { style: { width: '8px', height: '8px', borderRadius: '50%', background: 'var(--success)' } }),
    document.createTextNode('OK')
  ]));
  legend.appendChild(el('span', { style: { display: 'flex', alignItems: 'center', gap: '4px' } }, [
    el('span', { style: { width: '8px', height: '8px', borderRadius: '50%', background: 'var(--warning)' } }),
    document.createTextNode('Attention')
  ]));
  legend.appendChild(el('span', { style: { display: 'flex', alignItems: 'center', gap: '4px' } }, [
    el('span', { style: { width: '8px', height: '8px', borderRadius: '50%', background: 'var(--danger)' } }),
    document.createTextNode('Critique')
  ]));
  widget.appendChild(legend);

  // Statut
  var status = el('div', { style: {
    marginTop: '12px', padding: '8px 12px', borderRadius: '8px', fontSize: '12px',
    background: runway > 6 ? 'rgba(34, 197, 94, 0.1)' : runway > 3 ? 'rgba(251, 191, 36, 0.1)' : 'rgba(239, 68, 68, 0.1)',
    color: runway > 6 ? 'var(--success)' : runway > 3 ? 'var(--warning)' : 'var(--danger)'
  }});

  if (runway > 6) {
    status.innerHTML = '✅ <strong>' + runway + ' mois</strong> d\'autonomie - Situation confortable';
  } else if (runway > 3) {
    status.innerHTML = '⚠️ <strong>' + runway + ' mois</strong> d\'autonomie - Prévoir nouvelle mission';
  } else {
    status.innerHTML = '🔴 <strong>' + runway + ' mois</strong> d\'autonomie - Action urgente requise';
  }
  widget.appendChild(status);

  container.appendChild(widget);
}

// V54: Modal Projection Autonomie simplifiée basée sur la situation réelle
function showProjectionAutonomieModal() {
  var data = compute();
  var content = el('div', { style: { padding: '10px' } });

  // Données actuelles
  var salaireEstime = data.salaireEstime || TREASURY.salaireEstime || 2200;
  var cashDispo = data.cashDispoAbsolu || 0;

  // Section: Ma situation actuelle
  var heroSection = el('div', { style: { textAlign: 'center', marginBottom: '20px', padding: '16px', background: 'var(--bg-tertiary)', borderRadius: '12px' } });
  heroSection.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, 'Cash Disponible'));
  heroSection.appendChild(el('div', { style: { fontSize: '28px', fontWeight: '800', color: cashDispo >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(cashDispo)));
  heroSection.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' } }, 'Solde compte: ' + EUR(data.soldeAbsolu) + ' · Provisions: ' + EUR(data.provisionsAbsolues)));
  content.appendChild(heroSection);

  // Explication simple
  content.appendChild(el('div', { style: { fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '16px', padding: '12px', background: 'rgba(96, 165, 250, 0.1)', borderRadius: '8px' } },
    '💡 Si je n\'ai plus aucun revenu, combien de temps puis-je tenir en me versant un salaire mensuel ?'));

  // Input salaire mensuel
  var inputRow = el('div', { style: { marginBottom: '16px' } });
  inputRow.appendChild(el('label', { style: { display: 'block', fontSize: '12px', marginBottom: '4px', fontWeight: '600' } }, '💸 Salaire mensuel que je veux me verser'));
  var salaireInput = el('input', {
    type: 'number',
    id: 'projSalaireMensuel',
    value: salaireEstime,
    style: { width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid var(--border)', background: 'var(--bg-secondary)', color: 'var(--text-primary)', fontSize: '18px', fontWeight: '600' },
    oninput: function() { updateProjectionCalcSimple(cashDispo); }
  });
  inputRow.appendChild(salaireInput);
  content.appendChild(inputRow);

  // Résultat (calculé en temps réel)
  var resultDiv = el('div', { id: 'projAutonomieResult' });
  content.appendChild(resultDiv);

  // Section explication
  var explainSection = el('div', { style: { padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '11px', color: 'var(--text-muted)', marginTop: '16px' } });
  explainSection.innerHTML = '<strong>📐 Calcul:</strong> Cash Disponible ÷ Salaire mensuel = Autonomie en mois<br><br>' +
    '<em>Note: Sans nouveau revenu, vous n\'aurez pas de nouvelles charges sociales à payer.</em>';
  content.appendChild(explainSection);

  showModal('📅 Projection Annuelle', content);

  // Calcul initial
  setTimeout(function() { updateProjectionCalcSimple(cashDispo); }, 50);
}

// V54: Calcul simplifié de projection
function updateProjectionCalcSimple(cashDispo) {
  var salaireInput = $('#projSalaireMensuel');
  var salaire = parseFloat(salaireInput ? salaireInput.value : 0) || 0;
  var autonomie = salaire > 0 ? Math.floor(cashDispo / salaire) : 0;
  if (autonomie < 0) autonomie = 0;

  var resultDiv = $('#projAutonomieResult');
  if (!resultDiv) return;
  resultDiv.innerHTML = '';

  // Barre visuelle
  var maxMonths = 12;
  var pct = Math.min(100, (autonomie / maxMonths) * 100);
  var barColor = autonomie > 6 ? 'var(--success)' : autonomie > 3 ? 'var(--warning)' : 'var(--danger)';

  // Résultat principal
  var resultBox = el('div', { style: {
    textAlign: 'center', padding: '20px', borderRadius: '12px', marginBottom: '12px',
    background: autonomie > 6 ? 'rgba(34, 197, 94, 0.1)' : autonomie > 3 ? 'rgba(251, 191, 36, 0.1)' : 'rgba(239, 68, 68, 0.1)'
  }});
  resultBox.appendChild(el('div', { style: { fontSize: '40px', fontWeight: '800', color: barColor } }, autonomie + ' mois'));
  resultBox.appendChild(el('div', { style: { fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' } }, 'd\'autonomie avec ' + EUR(salaire) + '/mois'));
  resultDiv.appendChild(resultBox);

  // Barre de progression
  var barContainer = el('div', { style: { marginBottom: '12px' } });
  var labels = el('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '9px', color: 'var(--text-muted)', marginBottom: '4px' } });
  labels.appendChild(el('span', {}, '0'));
  labels.appendChild(el('span', {}, '3m'));
  labels.appendChild(el('span', {}, '6m'));
  labels.appendChild(el('span', {}, '12m+'));
  barContainer.appendChild(labels);

  var bar = el('div', { style: { height: '20px', background: 'var(--bg-tertiary)', borderRadius: '10px', overflow: 'hidden', position: 'relative' } });
  bar.appendChild(el('div', { style: { height: '100%', width: pct + '%', background: barColor, borderRadius: '10px', transition: 'width 0.3s' } }));
  barContainer.appendChild(bar);
  resultDiv.appendChild(barContainer);

  // Conseil
  var conseil = el('div', { style: { padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '12px', textAlign: 'center' } });
  if (autonomie > 12) {
    conseil.innerHTML = '✅ <strong>Excellent!</strong> Plus d\'un an d\'autonomie.';
  } else if (autonomie > 6) {
    conseil.innerHTML = '✅ <strong>Confortable</strong> - Bonne marge de sécurité.';
  } else if (autonomie > 3) {
    conseil.innerHTML = '⚠️ <strong>Attention</strong> - Pensez à sécuriser de nouveaux revenus.';
  } else if (autonomie > 0) {
    conseil.innerHTML = '🔴 <strong>Urgent</strong> - Réduisez votre salaire ou trouvez des missions.';
  } else {
    conseil.innerHTML = '❌ <strong>Insuffisant</strong> - Pas de salaire possible sans nouveau revenu.';
  }
  resultDiv.appendChild(conseil);

  // Section: Explication
  var explainSection = el('div', { style: { padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '11px', color: 'var(--text-muted)' } });
  explainSection.innerHTML = '<strong>💡 Comment c\'est calculé ?</strong><br>' +
    'Autonomie = Cash Disponible ÷ (Salaire mensuel + Charges récurrentes)<br><br>' +
    'Cette projection suppose que vous n\'avez aucun nouveau revenu pendant cette période.';
  content.appendChild(explainSection);

  showModal('⏱️ Projection Autonomie', content);

  // Calcul initial
  setTimeout(function() { updateProjectionCalc(cashDispo, chargesRecurrentes); }, 100);
}

function updateProjectionCalc(cashDispo, chargesRecurrentes) {
  var salaireInput = $('#projSalaireMensuel');
  var salaire = parseFloat(salaireInput ? salaireInput.value : 0) || 0;
  var depensesMensuelles = salaire + chargesRecurrentes;
  var autonomie = depensesMensuelles > 0 ? Math.floor(cashDispo / depensesMensuelles) : 0;
  if (autonomie < 0) autonomie = 0;

  var resultDiv = $('#projAutonomieResult');
  if (!resultDiv) return;
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = '';

  // Barre visuelle
  var maxMonths = 12;
  var pct = Math.min(100, (autonomie / maxMonths) * 100);
  var barColor = autonomie > 6 ? 'var(--success)' : autonomie > 3 ? 'var(--warning)' : 'var(--danger)';

  var barContainer = el('div', { style: { marginBottom: '16px' } });
  var bar = el('div', { style: { height: '24px', background: 'var(--bg-tertiary)', borderRadius: '12px', overflow: 'hidden', position: 'relative' } });
  bar.appendChild(el('div', { style: { height: '100%', width: pct + '%', background: barColor, borderRadius: '12px', transition: 'width 0.3s' } }));

  // Marqueurs
  var markers = el('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '9px', color: 'var(--text-muted)', marginTop: '4px' } });
  markers.appendChild(el('span', {}, '0'));
  markers.appendChild(el('span', {}, '3m'));
  markers.appendChild(el('span', {}, '6m'));
  markers.appendChild(el('span', {}, '12m'));
  barContainer.appendChild(bar);
  barContainer.appendChild(markers);
  resultDiv.appendChild(barContainer);

  // Résultat principal
  var resultBox = el('div', { style: {
    textAlign: 'center', padding: '16px', borderRadius: '12px',
    background: autonomie > 6 ? 'rgba(34, 197, 94, 0.1)' : autonomie > 3 ? 'rgba(251, 191, 36, 0.1)' : 'rgba(239, 68, 68, 0.1)'
  }});
  resultBox.appendChild(el('div', { style: { fontSize: '32px', fontWeight: '800', color: barColor } }, autonomie + ' mois'));
  resultBox.appendChild(el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' } }, 'd\'autonomie avec ' + EUR(salaire) + '/mois de salaire'));
  resultDiv.appendChild(resultBox);

  // Détail calcul
  var detail = el('div', { style: { marginTop: '12px', fontSize: '11px', color: 'var(--text-muted)' } });
  detail.innerHTML = '<strong>Détail:</strong> ' + EUR(cashDispo) + ' ÷ (' + EUR(salaire) + ' + ' + EUR(chargesRecurrentes) + ') = ' + autonomie + ' mois';
  resultDiv.appendChild(detail);

  // Conseil
  var conseil = el('div', { style: { marginTop: '12px', padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '11px' } });
  if (autonomie > 6) {
    conseil.innerHTML = '✅ <strong>Confortable</strong> - Vous avez une bonne marge de sécurité.';
  } else if (autonomie > 3) {
    conseil.innerHTML = '⚠️ <strong>Attention</strong> - Pensez à sécuriser de nouveaux revenus prochainement.';
  } else {
    conseil.innerHTML = '🔴 <strong>Urgent</strong> - Réduisez votre salaire ou trouvez rapidement des missions.';
  }
  resultDiv.appendChild(conseil);
}

// V53: Fusionner Actions + Jalons dans une même forme
function renderActionsAndMilestones(container) {
  var actions = getActionsList();
  var milestones = getLegalMilestones();

  if (actions.length === 0 && milestones.length === 0) return;

  var widget = el('div', { class: 'card', style: { marginBottom: '16px' } });
  widget.appendChild(el('div', { class: 'card-title' }, '⚡ À Faire'));

  // V72: Timeline horizontale scrollable avec tous les jalons de l'année
  var allMilestones = getAllYearMilestones();
  if (allMilestones.length > 0) {
    var timelineSection = el('div', { style: { marginBottom: '16px' } });
    timelineSection.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', fontWeight: '600', marginBottom: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
      el('span', {}, '📅 Timeline Fiscale ' + (PERIOD.year || TODAY.getFullYear())),
      el('span', { style: { fontSize: '9px', opacity: 0.6 } }, '← balayer →')
    ]));

    // Container scrollable
    var scrollContainer = el('div', { style: {
      overflowX: 'auto', overflowY: 'hidden', WebkitOverflowScrolling: 'touch',
      scrollbarWidth: 'none', msOverflowStyle: 'none', position: 'relative', paddingBottom: '8px'
    }});

    // La timeline elle-même
    var timeline = el('div', { style: {
      display: 'flex', alignItems: 'flex-start', gap: '0',
      minWidth: 'max-content', position: 'relative', paddingTop: '20px', paddingBottom: '4px'
    }});

    // Ligne horizontale
    var line = el('div', { style: {
      position: 'absolute', top: '38px', left: '30px', right: '30px', height: '2px',
      background: 'var(--border)', zIndex: 0
    }});
    timeline.appendChild(line);

    // Couleurs par catégorie
    var catColors = { urssaf: '#10b981', tva: '#ec4899', ir: '#f59e0b', cfe: '#8b5cf6', acre: '#06b6d4' };
    var catBg = { urssaf: 'rgba(16,185,129,0.12)', tva: 'rgba(236,72,153,0.12)', ir: 'rgba(245,158,11,0.12)', cfe: 'rgba(139,92,246,0.12)', acre: 'rgba(6,182,212,0.12)' };

    // Trouver le premier futur pour scroll auto
    var firstFutureIdx = -1;

    allMilestones.forEach(function(m, idx) {
      var isPast = m.daysLeft < 0;
      var isToday = m.daysLeft === 0;
      var isUrgent = m.daysLeft > 0 && m.daysLeft <= 7;
      var isSoon = m.daysLeft > 7 && m.daysLeft <= 30;
      if (firstFutureIdx === -1 && m.daysLeft >= 0) firstFutureIdx = idx;

      var color = catColors[m.cat] || 'var(--text-muted)';
      var bg = catBg[m.cat] || 'var(--bg-tertiary)';

      var item = el('div', {
        style: {
          display: 'flex', flexDirection: 'column', alignItems: 'center',
          minWidth: '70px', maxWidth: '80px', position: 'relative', zIndex: 1,
          opacity: isPast ? '0.4' : '1', cursor: 'pointer',
          transition: 'transform 0.15s ease'
        },
        onclick: function() { showMilestoneDetail(m); }
      });

      // Date en haut
      var dateStr = m.date ? m.date.substring(5) : '';
      var dateParts = dateStr.split('-');
      var dateDisplay = dateParts.length === 2 ? dateParts[1] + '/' + dateParts[0] : dateStr;
      item.appendChild(el('div', { style: {
        fontSize: '9px', color: isPast ? 'var(--text-muted)' : color, fontWeight: '600', marginBottom: '6px'
      }}, dateDisplay));

      // Point sur la ligne
      var dotSize = isToday || isUrgent ? '14px' : '10px';
      var dotBorder = isToday ? '3px solid var(--danger)' : isUrgent ? '2px solid ' + color : isPast ? '2px solid var(--border)' : '2px solid ' + color;
      var dotBg = isPast ? 'var(--border)' : isToday ? 'var(--danger)' : bg;
      item.appendChild(el('div', { style: {
        width: dotSize, height: dotSize, borderRadius: '50%', background: dotBg,
        border: dotBorder, marginBottom: '8px', boxShadow: isToday ? '0 0 8px rgba(239,68,68,0.5)' : isUrgent ? '0 0 6px ' + color + '40' : 'none'
      }}));

      // Icône
      item.appendChild(el('div', { style: { fontSize: '16px', marginBottom: '2px' } }, m.icon));

      // Label
      item.appendChild(el('div', { style: {
        fontSize: '9px', fontWeight: '600', textAlign: 'center', lineHeight: '1.2',
        color: isPast ? 'var(--text-muted)' : 'var(--text-primary)', maxWidth: '70px'
      }}, m.label));

      // Badge J-X
      if (!isPast) {
        var badgeColor = isToday ? 'var(--danger)' : isUrgent ? 'var(--danger)' : isSoon ? 'var(--warning)' : color;
        var badgeText = isToday ? 'Auj.' : 'J-' + m.daysLeft;
        item.appendChild(el('div', { style: {
          fontSize: '8px', fontWeight: '800', color: 'white', background: badgeColor,
          borderRadius: '8px', padding: '1px 5px', marginTop: '3px'
        }}, badgeText));
      }

      timeline.appendChild(item);
    });

    scrollContainer.appendChild(timeline);
    timelineSection.appendChild(scrollContainer);
    widget.appendChild(timelineSection);

    // Scroll auto vers le prochain jalon
    if (firstFutureIdx > 1) {
      setTimeout(function() {
        var scrollTarget = Math.max(0, (firstFutureIdx - 1) * 75);
        scrollContainer.scrollLeft = scrollTarget;
      }, 100);
    }
  }

  // Section Actions (en bas)
  if (actions.length > 0) {
    var actionsSection = el('div');
    actionsSection.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', fontWeight: '600', marginBottom: '8px' } }, '🎯 Actions Immédiates'));

    var actionsList = el('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } });
    actions.forEach(function(a) {
      var bgColor = a.type === 'urgent' ? 'rgba(239, 68, 68, 0.1)' : a.type === 'warning' ? 'rgba(251, 191, 36, 0.1)' : 'var(--bg-tertiary)';
      var item = el('div', {
        style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '10px', background: bgColor, borderRadius: '8px', cursor: 'pointer' },
        onclick: function() { showActionDetail(a); }
      });
      item.appendChild(el('div', { style: { fontSize: '20px' } }, a.icon));
      item.appendChild(el('div', { style: { flex: 1 } }, [
        el('div', { style: { fontSize: '13px', fontWeight: '600' } }, a.label),
        el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, a.sub)
      ]));
      item.appendChild(el('button', {
        class: 'btn btn-sm ' + a.btnClass,
        onclick: function(e) { e.stopPropagation(); a.action(); }
      }, a.btnLabel));
      actionsList.appendChild(item);
    });
    actionsSection.appendChild(actionsList);
    widget.appendChild(actionsSection);
  }

  container.appendChild(widget);
}

// V53: Détail d'un jalon
function showMilestoneDetail(m) {
  var content = el('div', { style: { padding: '10px' } });

  content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '16px' } }, [
    el('div', { style: { fontSize: '40px', marginBottom: '8px' } }, m.icon),
    el('div', { style: { fontSize: '18px', fontWeight: '700' } }, m.label)
  ]));

  if (m.date) {
    content.appendChild(el('div', { style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: '8px', marginBottom: '12px', textAlign: 'center' } }, [
      el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Date d\'échéance'),
      el('div', { style: { fontWeight: '700', fontSize: '16px' } }, fmtLong ? fmtLong(m.date) : fmtMonth(m.date)),
      m.daysLeft !== null ? el('div', { style: { fontSize: '12px', color: m.daysLeft <= 7 ? 'var(--danger)' : m.daysLeft <= 30 ? 'var(--warning)' : 'var(--success)', fontWeight: '600', marginTop: '4px' } }, m.daysLeft === 0 ? 'Aujourd\'hui !' : 'Dans ' + m.daysLeft + ' jours') : null
    ].filter(Boolean)));
  }

  var desc = m.description || m.detail;
  if (desc) {
    content.appendChild(el('div', { style: { fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' } }, desc));
  }

  showModal(m.icon + ' ' + m.label, content);
}

// V53: Détail d'une action
function showActionDetail(a) {
  var data = compute();
  var content = el('div', { style: { padding: '10px' } });

  content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '16px' } }, [
    el('div', { style: { fontSize: '40px', marginBottom: '8px' } }, a.icon),
    el('div', { style: { fontSize: '18px', fontWeight: '700' } }, a.label)
  ]));

  content.appendChild(el('div', { style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: '8px', marginBottom: '16px', textAlign: 'center' } }, [
    el('div', { style: { fontWeight: '600', fontSize: '14px' } }, a.sub)
  ]));

  // Si c'est une action de type charge à payer, afficher les détails
  if (a.type === 'warning' && a.label.indexOf('Payer') >= 0) {
    var chargesAPayer = data.detailChargesAPayer || [];
    if (chargesAPayer.length > 0) {
      content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', fontWeight: '600', marginBottom: '8px' } }, 'Détail des charges à payer:'));
      var list = el('div', { style: { maxHeight: '200px', overflowY: 'auto' } });
      chargesAPayer.slice(0, 10).forEach(function(c) {
        var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px', marginBottom: '4px', fontSize: '12px' } });
        row.appendChild(el('span', {}, c.cat + ' - ' + fmtMonthShort(c.mois)));
        row.appendChild(el('span', { style: { fontWeight: '600' } }, EUR(c.montant)));
        list.appendChild(row);
      });
      content.appendChild(list);
    }
  }

  // Si c'est une facture en retard
  if (a.type === 'urgent' && a.label.indexOf('Relancer') >= 0) {
    var facturesRetard = data.facturesAEncaisser ? data.facturesAEncaisser.filter(function(f) { return f.isLate; }) : [];
    if (facturesRetard.length > 0) {
      content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', fontWeight: '600', marginBottom: '8px' } }, 'Factures en retard:'));
      var list = el('div', { style: { maxHeight: '200px', overflowY: 'auto' } });
      facturesRetard.forEach(function(f) {
        var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '8px', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '6px', marginBottom: '4px', fontSize: '12px' } });
        row.appendChild(el('span', {}, f.client + ' - ' + fmtMonthShort(f.mois)));
        row.appendChild(el('span', { style: { fontWeight: '600', color: 'var(--danger)' } }, EUR(f.ttc)));
        list.appendChild(row);
      });
      content.appendChild(list);
    }
  }

  // Bouton action
  content.appendChild(el('button', {
    class: 'btn ' + (a.btnClass || 'btn-primary'),
    style: { width: '100%', marginTop: '12px' },
    onclick: function() { closeDynamicModal(); a.action(); }
  }, a.btnLabel));

  showModal(a.icon + ' Action', content);
}

function renderDashboardCharts(container, months) {
  // Graph CA
  var chartCard = el('div', { class: 'card' });
  var chartTitle = el('div', { class: 'card-title' });
  chartTitle.appendChild(el('span', {}, '📊 Chiffre d\'Affaires (HT)'));
  var chartActions = el('div', { class: 'card-actions' });
  chartActions.appendChild(el('button', { class: 'btn btn-sm', onclick: showCongesOverview }, '📅 Congés'));
  var toggle = el('div', { class: 'chart-toggle' });
  toggle.appendChild(el('button', { class: 'chart-toggle-btn' + (!SHOW_CUMUL ? ' active' : ''), onclick: function() { SHOW_CUMUL = false; render(); } }, 'Mensuel'));
  toggle.appendChild(el('button', { class: 'chart-toggle-btn' + (SHOW_CUMUL ? ' active' : ''), onclick: function() { SHOW_CUMUL = true; render(); } }, 'Cumulé'));
  chartActions.appendChild(toggle);
  chartTitle.appendChild(chartActions);
  chartCard.appendChild(chartTitle);
  // V61: Canvas avec style explicite pour garantir le rendu Chart.js
  var chartContainer = el('div', { class: 'chart-container' });
  var mainCanvas = el('canvas', { id: 'mainChart', style: { width: '100%', height: '100%', display: 'block' } });
  chartContainer.appendChild(mainCanvas);
  chartCard.appendChild(chartContainer);
  container.appendChild(chartCard);

  // Graph Tréso
  var soldeCard = el('div', { class: 'card' });
  var soldeTitle = el('div', { class: 'card-title' });
  soldeTitle.appendChild(el('span', {}, '📈 Trésorerie & Salaires'));
  var soldeToggle = el('div', { class: 'card-actions chart-toggle' });
  soldeToggle.appendChild(el('button', { class: 'chart-toggle-btn' + (!SHOW_CASH_DISPO ? ' active' : ''), onclick: function() { SHOW_CASH_DISPO = false; render(); } }, 'Solde'));
  soldeToggle.appendChild(el('button', { class: 'chart-toggle-btn' + (SHOW_CASH_DISPO ? ' active' : ''), onclick: function() { SHOW_CASH_DISPO = true; render(); } }, 'Cash'));
  soldeTitle.appendChild(soldeToggle);
  soldeCard.appendChild(soldeTitle);
  // V61: Canvas avec style explicite pour garantir le rendu Chart.js
  var soldeContainer = el('div', { class: 'chart-container' });
  var soldeCanvas = el('canvas', { id: 'soldeChart', style: { width: '100%', height: '100%', display: 'block' } });
  soldeContainer.appendChild(soldeCanvas);
  soldeCard.appendChild(soldeContainer);
  container.appendChild(soldeCard);
}

function renderDashboardSubTabs(container) {
  var tabs = [
    { id: 'accueil', label: 'Accueil', icon: '🏠' },
    { id: 'analyse', label: 'Analyse', icon: '📊' },
    { id: 'charges', label: 'Impôts & Charges', icon: '💳' }
  ];
  
  var tabBar = el('div', { class: 'sub-tabs', style: { 
    display: 'flex', gap: '8px', marginBottom: '16px', 
    padding: '4px', background: 'var(--bg-secondary)', borderRadius: '12px'
  }});
  
  tabs.forEach(function(tab) {
    var isActive = DASHBOARD_SUB === tab.id;
    var btn = el('button', { 
      class: 'sub-tab' + (isActive ? ' active' : ''),
      style: {
        flex: 1, padding: '10px 12px', border: 'none', borderRadius: '8px',
        background: isActive ? 'var(--accent)' : 'transparent',
        color: isActive ? 'white' : 'var(--text-secondary)',
        fontSize: '12px', fontWeight: '600', cursor: 'pointer',
        transition: 'all 0.2s ease'
      },
      onclick: function() { DASHBOARD_SUB = tab.id; render(); }
    }, tab.icon + ' ' + tab.label);
    tabBar.appendChild(btn);
  });
  
  container.appendChild(tabBar);
}


// V56: Sous-onglet Impôts & Charges avec camembert style clients
function renderChargesSubTab(container, data) {
  container.appendChild(SectionTitle('💳', 'Impôts & Charges'));

  // V57: Utiliser CA HT encaissé pour les calculs
  var caHT = data.caHT || data.caEnc || 1;

  // Catégories avec couleurs
  var categories = [
    { id: 'URSSAF', label: 'URSSAF', icon: '🏥', color: '#ef4444' },
    { id: 'TVA', label: 'TVA', icon: '🏛️', color: '#3b82f6' },
    { id: 'IR', label: 'Impôt Revenu', icon: '💰', color: '#f59e0b' },
    { id: 'CFP', label: 'CFP', icon: '📚', color: '#8b5cf6' },
    { id: 'CFE', label: 'CFE', icon: '🏢', color: '#6b7280' },
    { id: 'Impôt PL', label: 'Impôt PL', icon: '📋', color: '#f97316' },
    { id: 'Autres', label: 'Autres', icon: '📦', color: '#94a3b8' }
  ];

  // V57: Utiliser les données filtrées par période (detailChargesPayees + detailChargesAPayer)
  // au lieu des provisions absolues
  var periodCharges = (data.detailChargesPayees || []).concat(data.detailChargesAPayer || []);

  // Calculer les totaux - V57: Afficher TOUTES les catégories même à 0
  var chargeTypes = [];
  categories.forEach(function(cat) {
    var charges = periodCharges.filter(function(c) {
      if (cat.id === 'IR') return c.cat === 'IR Estimé' || c.cat === 'IR';
      if (cat.id === 'Autres') {
        var standard = ['URSSAF', 'TVA', 'IR Estimé', 'IR', 'CFP', 'CFE', 'Impôt PL', 'Impôt'];
        return !standard.some(function(s) { return c.cat === s || c.cat.indexOf(s) === 0; });
      }
      return c.cat === cat.id || c.cat.indexOf(cat.id) === 0;
    });
    var montant = charges.reduce(function(sum, c) { return sum + c.montant; }, 0);
    // V57: Calculer paid vs unpaid
    var paidAmount = charges.filter(function(c) { return !c.id || isPaid(c.id); }).reduce(function(s, c) { return s + c.montant; }, 0);
    var unpaidAmount = montant - paidAmount;
    // V57: Inclure TOUTES les catégories, même à 0
    chargeTypes.push({
      id: cat.id, label: cat.label, icon: cat.icon, color: cat.color,
      montant: montant, pctCA: caHT > 0 ? (montant / caHT) * 100 : 0,
      unpaidCount: charges.filter(function(c) { return c.id && !isPaid(c.id); }).length,
      paidAmount: paidAmount, unpaidAmount: unpaidAmount
    });
  });

  // Trier par montant décroissant
  chargeTypes.sort(function(a, b) { return b.montant - a.montant; });

  var totalCharges = chargeTypes.reduce(function(sum, c) { return sum + c.montant; }, 0) || 1;
  var chargesWithAmount = chargeTypes.filter(function(c) { return c.montant > 0; });
  var maxMontant = chargesWithAmount.length > 0 ? chargesWithAmount[0].montant : 1;

  var widget = el('div', { class: 'card' });

  // V56: Layout horizontal avec camembert à gauche et liste à droite (style clients)
  var content = el('div', { style: { display: 'flex', gap: '16px', alignItems: 'flex-start' } });

  // Camembert SVG - V57: Utiliser uniquement les catégories avec montant > 0
  var pieSize = 120;
  var pieContainer = el('div', { style: { flexShrink: '0' } });
  var pieDiv = el('div', { style: { position: 'relative', width: pieSize + 'px', height: pieSize + 'px' } });

  var svgNS = 'http://www.w3.org/2000/svg';
  var svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('width', pieSize);
  svg.setAttribute('height', pieSize);
  svg.setAttribute('viewBox', '0 0 100 100');

  // V57: Si aucune charge, afficher cercle vide
  if (chargesWithAmount.length === 0) {
    var emptyCircle = document.createElementNS(svgNS, 'circle');
    emptyCircle.setAttribute('cx', '50');
    emptyCircle.setAttribute('cy', '50');
    emptyCircle.setAttribute('r', '40');
    emptyCircle.setAttribute('fill', 'var(--bg-tertiary)');
    svg.appendChild(emptyCircle);
  } else {
    // Dessiner les segments du camembert
    var cumAngle = -90;
    chargesWithAmount.slice(0, 7).forEach(function(charge, i) {
      var pct = (charge.montant / totalCharges) * 100;
      var angle = (pct / 100) * 360;

      if (pct > 0) {
        var startAngle = cumAngle * (Math.PI / 180);
        var endAngle = (cumAngle + angle) * (Math.PI / 180);

        var x1 = 50 + 40 * Math.cos(startAngle);
        var y1 = 50 + 40 * Math.sin(startAngle);
        var x2 = 50 + 40 * Math.cos(endAngle);
        var y2 = 50 + 40 * Math.sin(endAngle);

        var largeArc = angle > 180 ? 1 : 0;

        var path = document.createElementNS(svgNS, 'path');
        if (chargesWithAmount.length === 1 || pct >= 99.5) {
          path.setAttribute('d', 'M 50 10 A 40 40 0 1 1 49.99 10 Z');
        } else {
          path.setAttribute('d', 'M 50 50 L ' + x1 + ' ' + y1 + ' A 40 40 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z');
        }
        path.setAttribute('fill', charge.color);
        svg.appendChild(path);

        cumAngle += angle;
      }
    });
  }

  // Centre blanc pour effet donut
  var centerCircle = document.createElementNS(svgNS, 'circle');
  centerCircle.setAttribute('cx', '50');
  centerCircle.setAttribute('cy', '50');
  centerCircle.setAttribute('r', '25');
  centerCircle.setAttribute('fill', 'var(--bg-secondary)');
  svg.appendChild(centerCircle);

  pieDiv.appendChild(svg);

  // Total au centre
  var centerLabel = el('div', { style: {
    position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
    textAlign: 'center', lineHeight: '1.2'
  }});
  centerLabel.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Total'));
  centerLabel.appendChild(el('div', { style: { fontSize: '12px', fontWeight: '700', color: 'var(--danger)' } }, EUR(totalCharges, true)));
  pieDiv.appendChild(centerLabel);

  pieContainer.appendChild(pieDiv);
  content.appendChild(pieContainer);

  // Liste des charges avec barres horizontales - V57: Afficher TOUTES les catégories
  var listContainer = el('div', { style: { flex: '1', minWidth: '0' } });

  chargeTypes.forEach(function(charge) {
    var pct = totalCharges > 0 ? Math.round((charge.montant / totalCharges) * 100) : 0;
    var barWidth = maxMontant > 0 ? (charge.montant / maxMontant) * 100 : 0;

    var row = el('div', {
      style: { marginBottom: '8px', cursor: charge.montant > 0 ? 'pointer' : 'default', opacity: charge.montant > 0 ? '1' : '0.5' },
      onclick: charge.montant > 0 ? function() { showChargeDetailEnhanced(charge.id, data, caHT); } : null
    });

    // Header: nom + montant + %
    var header = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: '11px', marginBottom: '2px' } });
    header.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } }, [
      el('div', { style: { width: '8px', height: '8px', borderRadius: '2px', background: charge.color } }),
      el('span', { style: { fontWeight: '600' } }, charge.icon + ' ' + charge.label)
    ]));
    header.appendChild(el('span', { style: { color: 'var(--text-muted)' } }, charge.montant > 0 ? EUR(charge.montant) + ' (' + pct + '%)' : '0 €'));
    row.appendChild(header);

    // V57: Barre de progression avec distinction payé vs provision
    var barBg = el('div', { style: { height: '6px', background: 'var(--bg-tertiary)', borderRadius: '3px', overflow: 'hidden', display: 'flex' } });
    if (charge.montant > 0) {
      // Partie payée (vert)
      var paidWidth = charge.paidAmount > 0 ? (charge.paidAmount / charge.montant) * barWidth : 0;
      if (paidWidth > 0) {
        barBg.appendChild(el('div', { style: { height: '100%', width: paidWidth + '%', background: 'var(--success)' } }));
      }
      // Partie provision (couleur de la catégorie avec opacité)
      var unpaidWidth = barWidth - paidWidth;
      if (unpaidWidth > 0) {
        barBg.appendChild(el('div', { style: { height: '100%', width: unpaidWidth + '%', background: charge.color } }));
      }
    }
    row.appendChild(barBg);

    // V57: Sous-info améliorée: % du CA + statut payé/provision
    var subInfo = charge.pctCA.toFixed(1) + '% du CA HT';
    if (charge.montant > 0 && charge.paidAmount > 0 && charge.unpaidAmount > 0) {
      subInfo += ' · ' + EUR(charge.paidAmount, true) + ' payé, ' + EUR(charge.unpaidAmount, true) + ' à payer';
    } else if (charge.montant > 0 && charge.paidAmount > 0) {
      subInfo += ' · Tout payé ✓';
    } else if (charge.montant > 0 && charge.unpaidAmount > 0) {
      subInfo += ' · ' + EUR(charge.unpaidAmount, true) + ' à provisionner';
    }
    row.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px' } }, subInfo));

    listContainer.appendChild(row);
  });

  content.appendChild(listContainer);
  widget.appendChild(content);
  container.appendChild(widget);

  // V60: Graphique composition des provisions (stacked horizontal bar)
  var provTypes = chargeTypes.filter(function(c) { return c.unpaidAmount > 0; });
  if (provTypes.length > 0) {
    var provWidget = el('div', { class: 'card', style: { marginTop: '12px' } });
    provWidget.appendChild(el('div', { class: 'card-title' }, '🔒 Composition des Provisions'));

    var totalProv = provTypes.reduce(function(s, c) { return s + c.unpaidAmount; }, 0);

    // Stacked bar
    var stackedBar = el('div', { style: { display: 'flex', height: '28px', borderRadius: '14px', overflow: 'hidden', marginBottom: '12px' } });
    provTypes.forEach(function(c) {
      var pctW = totalProv > 0 ? (c.unpaidAmount / totalProv * 100) : 0;
      if (pctW > 0) {
        stackedBar.appendChild(el('div', {
          style: { width: pctW + '%', background: c.color, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '9px', fontWeight: '700', minWidth: pctW > 8 ? '0' : '0' },
          title: c.label + ': ' + EUR(c.unpaidAmount)
        }, pctW > 12 ? Math.round(pctW) + '%' : ''));
      }
    });
    provWidget.appendChild(stackedBar);

    // Légende détaillée avec barres horizontales
    provTypes.sort(function(a, b) { return b.unpaidAmount - a.unpaidAmount; });
    var maxProv = provTypes[0].unpaidAmount || 1;
    provTypes.forEach(function(c) {
      var pctOfTotal = totalProv > 0 ? Math.round(c.unpaidAmount / totalProv * 100) : 0;
      var row = el('div', { style: { marginBottom: '6px' } });
      var header = el('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '11px', marginBottom: '2px' } });
      header.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } }, [
        el('div', { style: { width: '8px', height: '8px', borderRadius: '2px', background: c.color } }),
        el('span', { style: { fontWeight: '600' } }, c.icon + ' ' + c.label)
      ]));
      header.appendChild(el('span', {}, EUR(c.unpaidAmount) + ' (' + pctOfTotal + '%)'));
      row.appendChild(header);
      var bar = el('div', { style: { height: '4px', background: 'var(--bg-tertiary)', borderRadius: '2px', overflow: 'hidden' } });
      bar.appendChild(el('div', { style: { height: '100%', width: (c.unpaidAmount / maxProv * 100) + '%', background: c.color, borderRadius: '2px' } }));
      row.appendChild(bar);
      provWidget.appendChild(row);
    });

    // Total
    provWidget.appendChild(el('div', { style: { borderTop: '1px solid var(--border)', marginTop: '8px', paddingTop: '8px', display: 'flex', justifyContent: 'space-between', fontWeight: '700', fontSize: '12px' } }, [
      el('span', {}, 'Total Provisions'),
      el('span', { style: { color: 'var(--warning)' } }, EUR(totalProv))
    ]));

    container.appendChild(provWidget);
  }
}

// V55: Détail charges amélioré avec historique % CA HT - CORRIGÉ
// V59: Statuts cliquables (payé/provisionné) + montants projetés basés sur missions
function showChargeDetailEnhanced(categoryId, data, caHT) {
  // V55: Filtrer allProvisionsDetail pour la catégorie
  var filterFn = function(c) {
    if (categoryId === 'IR') {
      return c.cat === 'IR Estimé' || c.cat === 'IR';
    }
    if (categoryId === 'Autres') {
      var standard = ['URSSAF', 'TVA', 'IR Estimé', 'IR', 'CFP', 'CFE', 'Impôt PL', 'Impôt'];
      return !standard.some(function(s) { return c.cat === s || c.cat.indexOf(s) === 0; });
    }
    return c.cat === categoryId || c.cat.indexOf(categoryId) === 0;
  };

  // V57: Utiliser les données filtrées par période au lieu des provisions absolues
  var periodCharges = (data.detailChargesPayees || []).concat(data.detailChargesAPayer || []);
  var charges = periodCharges.filter(filterFn);

  // V59: Calculer les montants projetés basés sur les missions futures
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var projectedByMonth = {};
  var totalProjected = 0;
  MISSIONS.forEach(function(mis) {
    if (!mis.lignes || !mis.tjm) return;
    mis.lignes.forEach(function(l) {
      if (!l.ym || l.ym <= nowYm) return; // Seulement mois futurs
      if (!isInPeriod(l.ym)) return;
      var joursEffectifs = Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
      if (joursEffectifs <= 0) return;
      var caHTPrev = joursEffectifs * mis.tjm;
      var chargeMonth = getPaymentMonth(l.ym, mis.delaiPaiement || 0, mis.jourPaiement || 15);
      if (!isInPeriod(chargeMonth)) return;
      var projAmount = 0;
      if (categoryId === 'URSSAF') {
        projAmount = Math.round(caHTPrev * getUrssafRate(chargeMonth));
      } else if (categoryId === 'TVA' && isTVAApplicable(chargeMonth)) {
        projAmount = Math.round(caHTPrev * 0.2);
      } else if (categoryId === 'CFP') {
        projAmount = Math.round(caHTPrev * LEGAL.cfp);
      } else if (categoryId === 'Impôt PL' && COMPANY.prelevementLiberatoire) {
        projAmount = Math.round(caHTPrev * LEGAL.impLib);
      } else if (categoryId === 'IR' && !COMPANY.prelevementLiberatoire) {
        // IR projeté: estimation proportionnelle
        var irEst = calculateIR(caHTPrev, parseInt(chargeMonth.substring(0, 4)));
        projAmount = irEst.impot > 0 ? Math.round(irEst.impot) : 0;
      }
      if (projAmount > 0) {
        if (!projectedByMonth[chargeMonth]) projectedByMonth[chargeMonth] = 0;
        projectedByMonth[chargeMonth] += projAmount;
        totalProjected += projAmount;
      }
    });
  });

  // V57: Déterminer le taux URSSAF en fonction de l'année de la période sélectionnée
  var urssafRateText = (function() {
    var acre = getAcreInfo();
    // Déterminer l'année de la période actuelle
    var periodYear = PERIOD.year || TODAY.getFullYear();
    var stdRate = periodYear >= 2026 ? PCT(LEGAL.urssafStd2026) : PCT(LEGAL.urssafStd2025);
    var acreRate = periodYear >= 2026 ? PCT(LEGAL.urssafAcre2026) : PCT(LEGAL.urssafAcre2025);

    if (COMPANY.acre && acre.expiryYm) {
      // ACRE actif ou passé - afficher les deux taux selon l'année
      return acreRate + ' (ACRE) / ' + stdRate + ' (std) du CA HT';
    }
    return stdRate + ' du CA HT';
  })();
  var catInfo = {
    'URSSAF': { label: 'URSSAF - Cotisations sociales', rate: urssafRateText, desc: 'Maladie, retraite, allocations familiales' },
    'TVA': { label: 'TVA - Taxe sur la Valeur Ajoutée', rate: '20% du CA HT', desc: 'Collectée sur factures, reversée à l\'État' },
    'IR': { label: 'Impôt sur le Revenu', rate: 'Barème progressif ou 2.2% (PL)', desc: 'Impôt sur les bénéfices' },
    'CFP': { label: 'Contribution Formation Pro', rate: '0.2% du CA HT', desc: 'Formation professionnelle' },
    'CFE': { label: 'Cotisation Foncière des Entreprises', rate: 'Variable selon commune', desc: 'Impôt local' },
    'Impôt PL': { label: 'Prélèvement Libératoire', rate: '2.2% du CA HT', desc: 'Impôt forfaitaire sur le revenu' },
    'Autres': { label: 'Autres dépenses', rate: 'Variable', desc: 'Dépenses professionnelles diverses' }
  };
  var info = catInfo[categoryId] || { label: categoryId, rate: '-', desc: '' };

  var content = el('div', { style: { padding: '10px' } });

  // V55: Utiliser allProvisionsDetail pour le total (source unique de vérité)
  var total = charges.reduce(function(sum, c) { return sum + c.montant; }, 0);
  var pctCA = caHT > 0 ? (total / caHT * 100).toFixed(1) : 0;

  // V59: Calculer totaux payé et provisionné
  var totalPaid = charges.filter(function(c) { return c.id && isPaid(c.id); }).reduce(function(s, c) { return s + c.montant; }, 0);
  // Pour detailChargesPayees qui n'ont pas d'id, compter comme payé
  var totalPaidFromPayees = (data.detailChargesPayees || []).filter(filterFn).reduce(function(s, c) { return s + c.montant; }, 0);
  totalPaid = Math.max(totalPaid, totalPaidFromPayees);
  var totalUnpaid = total - totalPaid;

  content.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '16px', padding: '16px', background: 'var(--bg-tertiary)', borderRadius: '12px' } }, [
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textTransform: 'uppercase' } }, info.label),
    el('div', { style: { fontSize: '28px', fontWeight: '800', color: 'var(--danger)' } }, EUR(total)),
    el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' } }, pctCA + '% du CA HT'),
    // V59: Résumé payé / provisionné / projeté - badges visibles
    el('div', { style: { display: 'flex', justifyContent: 'center', gap: '8px', marginTop: '8px', fontSize: '10px' } }, [
      totalPaid > 0 ? el('span', { style: { background: 'var(--success)', color: 'white', padding: '2px 8px', borderRadius: '10px', fontWeight: '600' } }, 'Payé: ' + EUR(totalPaid)) : null,
      totalUnpaid > 0 ? el('span', { style: { background: '#f59e0b', color: 'white', padding: '2px 8px', borderRadius: '10px', fontWeight: '600' } }, 'Prov: ' + EUR(totalUnpaid)) : null,
      totalProjected > 0 ? el('span', { style: { background: '#a78bfa', color: 'white', padding: '2px 8px', borderRadius: '10px', fontWeight: '600' } }, 'Projeté: ' + EUR(totalProjected)) : null
    ].filter(Boolean))
  ]));

  // Info taux
  var infoBox = el('div', { style: { background: 'rgba(96, 165, 250, 0.1)', padding: '10px', borderRadius: '8px', marginBottom: '16px', fontSize: '11px' } });
  infoBox.appendChild(el('div', {}, [el('span', { style: { fontWeight: '600' } }, 'Taux: '), el('span', {}, info.rate)]));
  if (info.desc) infoBox.appendChild(el('div', { style: { color: 'var(--text-muted)', marginTop: '4px' } }, info.desc));
  content.appendChild(infoBox);

  // V59: Collecter tous les mois (charges réelles + projetées) et fusionner
  var allMonths = {};
  charges.forEach(function(c) {
    if (!allMonths[c.mois]) allMonths[c.mois] = { charges: [], projected: 0 };
    allMonths[c.mois].charges.push(c);
  });
  Object.keys(projectedByMonth).forEach(function(m) {
    if (!allMonths[m]) allMonths[m] = { charges: [], projected: 0 };
    allMonths[m].projected = projectedByMonth[m];
  });

  var sortedMonths = Object.keys(allMonths).sort().reverse();

  if (sortedMonths.length > 0) {
    content.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--accent)', fontWeight: '600', marginBottom: '8px', textTransform: 'uppercase' } }, '📅 Détail par mois'));
    var list = el('div', { style: { maxHeight: '300px', overflowY: 'auto' } });

    sortedMonths.forEach(function(mois) {
      var entry = allMonths[mois];
      var monthCharges = entry.charges;
      var monthProjected = entry.projected;
      var monthTotal = monthCharges.reduce(function(s, c) { return s + c.montant; }, 0);
      var monthData = data.monthsData[mois];
      var monthCA = monthData ? monthData.encHT : 0;
      var monthPct;
      if (monthCA > 0) {
        monthPct = (monthTotal / monthCA * 100).toFixed(1) + '%';
      } else if (categoryId === 'URSSAF') {
        var rate = getUrssafRate(mois);
        monthPct = PCT(rate);
      } else {
        monthPct = '-';
      }

      // V59: Ligne principale avec montant réel
      if (monthTotal > 0) {
        var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 10px', background: 'var(--bg-tertiary)', borderRadius: '6px', marginBottom: '2px', fontSize: '11px' } });
        row.appendChild(el('span', { style: { fontWeight: '600', minWidth: '44px' } }, fmtMonthShort(mois)));
        row.appendChild(el('span', { style: { fontWeight: '600', minWidth: '65px', textAlign: 'right' } }, EUR(monthTotal)));
        row.appendChild(el('span', { style: { color: 'var(--text-muted)', minWidth: '55px', textAlign: 'right' } }, monthPct + ' CA'));

        // V59: Statut cliquable: badge "Payé" ou "Provisionné" avec toggle au clic
        var unpaid = monthCharges.filter(function(c) { return c.id && !isPaid(c.id); });
        var allPaid = unpaid.length === 0;
        (function(unpaidList, chargesList, monthMois) {
          var statusBadge = el('button', {
            style: {
              border: 'none', borderRadius: '12px', padding: '4px 12px', fontSize: '10px', fontWeight: '700',
              cursor: 'pointer', minWidth: '90px', textAlign: 'center', transition: 'all 0.2s',
              background: allPaid ? 'var(--success)' : '#f59e0b',
              color: 'white',
              boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
            },
            title: allPaid ? 'Cliquer pour marquer comme non payé' : 'Cliquer pour marquer comme payé',
            onclick: function(e) {
              e.stopPropagation();
              if (allPaid) {
                // Toggle back to unpaid
                chargesList.forEach(function(c) { if (c.id) TREASURY.paidCharges[c.id] = false; });
              } else {
                // Mark all as paid
                unpaidList.forEach(function(c) { if (c.id) TREASURY.paidCharges[c.id] = true; });
              }
              saveAll();
              closeDynamicModal();
              render();
              // Re-open the detail after render
              setTimeout(function() { showChargeDetailEnhanced(categoryId, compute(), data.caHT || caHT); }, 50);
            }
          }, allPaid ? 'Payé' : 'Provisionné');
          row.appendChild(statusBadge);
        })(unpaid, monthCharges, mois);

        list.appendChild(row);
      }

      // V59: Ligne projetée si applicable
      if (monthProjected > 0) {
        var projRow = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 10px', background: 'rgba(167,139,250,0.08)', borderRadius: '6px', marginBottom: '4px', fontSize: '11px', borderLeft: '3px solid #a78bfa' } });
        projRow.appendChild(el('span', { style: { fontWeight: '600', minWidth: '44px', color: '#a78bfa' } }, monthTotal > 0 ? '' : fmtMonthShort(mois)));
        projRow.appendChild(el('span', { style: { fontWeight: '600', minWidth: '65px', textAlign: 'right', color: '#a78bfa' } }, EUR(monthProjected)));
        projRow.appendChild(el('span', { style: { color: 'var(--text-muted)', minWidth: '55px', textAlign: 'right', fontSize: '10px' } }, 'missions'));
        projRow.appendChild(el('span', { style: { color: '#a78bfa', fontSize: '10px', fontWeight: '700', minWidth: '90px', textAlign: 'center' } }, '◌ Projeté'));
        list.appendChild(projRow);
      }
    });
    content.appendChild(list);
  } else {
    content.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '20px' } }, 'Aucune charge pour cette catégorie'));
  }

  showModal(info.label, content);
}

function showChargeDetail(categoryId, data) {
  var charges = data.allProvisionsDetail ? data.allProvisionsDetail.filter(function(c) { return c.cat === categoryId; }) : [];
  // Déterminer le taux URSSAF en fonction des données présentes
  var urssafRateText = (function() {
    var acre = getAcreInfo();
    if (COMPANY.acre && acre.expiryYm) {
      var stdRate = PCT(LEGAL.urssafStd2025);
      var acreRate = PCT(LEGAL.urssafAcre2025);
      return acreRate + ' (ACRE) / ' + stdRate + ' (std) du CA HT';
    }
    return PCT(getUrssafRate()) + ' du CA HT';
  })();
  var catInfo = {
    'URSSAF': { label: 'URSSAF - Cotisations sociales', rate: urssafRateText, penalty: '5% + 0.2%/mois après 30j' },
    'TVA': { label: 'TVA - Taxe sur la Valeur Ajoutée', rate: '20% du CA HT', penalty: '10% + intérêts de retard' },
    'IR': { label: 'Impôt sur le Revenu', rate: 'Barème progressif', penalty: '10% majoration' },
    'CFE': { label: 'Cotisation Foncière des Entreprises', rate: 'Variable selon commune', penalty: '10% après mise en demeure' }
  };
  var info = catInfo[categoryId] || { label: categoryId, rate: '-', penalty: '-' };
  
  var content = el('div', { style: { padding: '10px' } });
  
  // Info taux
  var infoBox = el('div', { style: { background: 'var(--bg-tertiary)', padding: '12px', borderRadius: '8px', marginBottom: '16px', fontSize: '12px' } });
  infoBox.appendChild(el('div', { style: { fontWeight: '600', marginBottom: '8px' } }, info.label));
  infoBox.appendChild(el('div', {}, [el('span', { style: { color: 'var(--text-muted)' } }, 'Taux: '), el('span', {}, info.rate)]));
  infoBox.appendChild(el('div', {}, [el('span', { style: { color: 'var(--text-muted)' } }, 'Pénalité retard: '), el('span', { style: { color: 'var(--danger)' } }, info.penalty)]));
  content.appendChild(infoBox);
  
  // Liste des échéances
  if (charges.length > 0) {
    var table = el('div', { style: { fontSize: '12px' } });
    charges.sort(function(a, b) { return a.ym > b.ym ? -1 : 1; }).forEach(function(c) {
      var status = c.paid ? 'Payé' : (c.isLate ? 'Retard' : 'À payer');
      var statusColor = c.paid ? 'var(--success)' : (c.isLate ? 'var(--danger)' : 'var(--text-muted)');
      var row = el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid var(--border)' } });
      row.appendChild(el('span', {}, fmtMonth(c.ym)));
      row.appendChild(el('span', { style: { fontWeight: '600' } }, EUR(c.montant)));
      row.appendChild(el('span', { style: { color: statusColor, fontWeight: '600', padding: '2px 8px', background: c.paid ? 'rgba(16,185,129,0.15)' : (c.isLate ? 'rgba(239,68,68,0.15)' : 'rgba(156,163,175,0.15)'), borderRadius: '10px', fontSize: '10px' } }, status));
      if (!c.paid) {
        row.appendChild(el('button', { class: 'btn btn-sm btn-success', onclick: function() { markAllPaid([c.id]); closeDynamicModal(); render(); } }, 'Payer'));
      }
      table.appendChild(row);
    });
    content.appendChild(table);
  } else {
    content.appendChild(el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '20px' } }, 'Aucune charge pour cette catégorie'));
  }
  
  // Si c'est IR, ajouter bouton simulateur
  if (categoryId === 'IR') {
    content.appendChild(el('button', { class: 'btn btn-primary', style: { width: '100%', marginTop: '16px' }, onclick: function() { closeDynamicModal(); showIRDetail(); } }, '🧮 Ouvrir Simulateur IR'));
  }
  
  showModal(info.label, content);
}


// V51: Sous-onglet Analyse
function renderAnalyseSubTab(container, data, months) {
  // KPIs Performance
  container.appendChild(SectionTitle('📈', 'Performance'));
  
  var kpiGrid = el('div', { class: 'kpi-grid', style: { marginBottom: '16px' } });
  kpiGrid.appendChild(KPI({ label: 'CA Réalisé', value: EUR(data.caReal), sub: 'Prévu: ' + EUR(data.caPrev), color: 'info', trend: getTrend(data.sparklineData.caReal) }));
  kpiGrid.appendChild(KPI({ label: 'Encaissé HT', value: EUR(data.caEnc), sub: 'À encaisser: ' + EUR(data.caAEnc), color: 'success' }));
  kpiGrid.appendChild(KPI({ label: 'Bénéfice Net', value: EUR(data.beneficeNet), sub: 'Marge: ' + PCT(data.margeNette), color: data.beneficeNet >= 0 ? 'success' : 'danger' }));
  kpiGrid.appendChild(KPI({ label: 'TJM Effectif', value: EUR(data.tjmEffectif), sub: 'Net: ' + EUR(data.tjmNet), color: 'accent' }));
  container.appendChild(kpiGrid);
  
  // Répartition CA HT
  container.appendChild(SectionTitle('📊', 'Répartition CA HT'));
  
  var caHT = data.caReal || 1;
  var chargesTotal = data.totalCharges || 0;
  var salaires = data.salaires || 0;
  var benefice = Math.max(0, caHT - chargesTotal - salaires);
  
  var pctCharges = Math.round((chargesTotal / caHT) * 100);
  var pctSalaires = Math.round((salaires / caHT) * 100);
  var pctBenefice = Math.max(0, 100 - pctCharges - pctSalaires);
  
  var repartCard = el('div', { class: 'card' });
  
  // Barre de répartition
  var bar = el('div', { style: { display: 'flex', height: '24px', borderRadius: '12px', overflow: 'hidden', marginBottom: '16px' } });
  bar.appendChild(el('div', { style: { width: pctCharges + '%', background: 'var(--danger)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px', fontWeight: '600' } }, pctCharges > 10 ? pctCharges + '%' : ''));
  bar.appendChild(el('div', { style: { width: pctSalaires + '%', background: 'var(--info)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px', fontWeight: '600' } }, pctSalaires > 10 ? pctSalaires + '%' : ''));
  bar.appendChild(el('div', { style: { width: pctBenefice + '%', background: 'var(--success)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px', fontWeight: '600' } }, pctBenefice > 10 ? pctBenefice + '%' : ''));
  repartCard.appendChild(bar);
  
  // Légende
  var legend = el('div', { style: { display: 'flex', justifyContent: 'space-around', fontSize: '12px' } });
  legend.appendChild(el('div', { style: { textAlign: 'center' } }, [
    el('div', { style: { width: '12px', height: '12px', background: 'var(--danger)', borderRadius: '3px', display: 'inline-block', marginRight: '4px' } }),
    el('span', {}, 'Charges ' + EUR(chargesTotal))
  ]));
  legend.appendChild(el('div', { style: { textAlign: 'center' } }, [
    el('div', { style: { width: '12px', height: '12px', background: 'var(--info)', borderRadius: '3px', display: 'inline-block', marginRight: '4px' } }),
    el('span', {}, 'Salaires ' + EUR(salaires))
  ]));
  legend.appendChild(el('div', { style: { textAlign: 'center' } }, [
    el('div', { style: { width: '12px', height: '12px', background: 'var(--success)', borderRadius: '3px', display: 'inline-block', marginRight: '4px' } }),
    el('span', {}, 'Bénéfice ' + EUR(benefice))
  ]));
  repartCard.appendChild(legend);
  container.appendChild(repartCard);
  
  // Comparaison N-1
  var cmp = getCompareData();
  if (cmp.prev.ca > 0) {
    container.appendChild(SectionTitle('📅', 'Comparaison ' + (TODAY.getFullYear() - 1) + ' vs ' + TODAY.getFullYear()));
    renderCompareWidget(container);
  }
  
  // CA par client
  container.appendChild(SectionTitle('👥', 'CA par Client'));
  renderClientsWidget(container);
}

// ═══════════════════════════════════════════════════════════════════════════
// V52 - NOUVELLE NAVIGATION SIMPLIFIÉE
// Accueil | Performance | Missions | Finances | Params
// ═══════════════════════════════════════════════════════════════════════════

function renderAccueil(container) {
  var data = compute();

  // 1. CA ANNUEL avec plafond micro-entrepreneur (en haut)
  renderCAPlafondWidget(container);

  // 2. MA TRÉSORERIE (Hero avec camembert)
  renderDashboardHero(container, data);

  // 3. À FAIRE (Actions + Jalons fusionnés)
  renderActionsAndMilestones(container);

  // Insights (conseils contextuels)
  renderInsights(container);
}

function renderPerformance(container) {
  var data = compute();
  var months = getPeriodMonths();

  // Header
  var header = el('div', { class: 'page-header' });
  header.appendChild(el('h2', { class: 'page-title' }, '📊 Performance'));
  container.appendChild(header);

  // Graphique principal
  container.appendChild(SectionTitle('📈', 'Évolution CA & Charges'));
  renderDashboardCharts(container, months);

  // KPIs Performance avec détail au clic
  container.appendChild(SectionTitle('🎯', 'Indicateurs'));

  var kpiGrid = el('div', { class: 'kpi-grid', style: { marginBottom: '16px' } });
  kpiGrid.appendChild(KPI({ label: 'CA Réalisé', value: EUR(data.caReal), sub: 'Prévu: ' + EUR(data.caPrev), color: 'info', trend: getTrend(data.sparklineData.caReal), onClick: function() { showCARealisedDetail(data); } }));
  kpiGrid.appendChild(KPI({ label: 'CA Encaissé HT', value: EUR(data.caHT), sub: 'TTC: ' + EUR(data.caEnc), color: 'success', onClick: function() { showEncaisseDetail(data); } }));
  kpiGrid.appendChild(KPI({ label: 'Bénéfice Net', value: EUR(data.beneficeNet), sub: 'Marge: ' + PCT(data.margeNette), color: data.beneficeNet >= 0 ? 'success' : 'danger', onClick: function() { showBeneficeDetail(data); } }));
  kpiGrid.appendChild(KPI({ label: 'TJM Effectif', value: EUR(data.tjmEffectif), sub: 'Net: ' + EUR(data.tjmNet), color: 'accent', onClick: showTJMDetail }));
  // V65: Indicateur Impôt - utilise getIRForYear() comme source unique de vérité
  var periodYear = PERIOD.year || TODAY.getFullYear();
  var irData = getIRForYear(periodYear);
  var totalImpot = COMPANY.prelevementLiberatoire ? Math.round(irData.caTotal * 0.022) : irData.impot;
  var impotLabel = COMPANY.prelevementLiberatoire ? 'Impôt PL' : 'IR Estimé';
  kpiGrid.appendChild(KPI({ label: impotLabel, value: EUR(totalImpot), sub: periodYear + ' • CA: ' + EUR(irData.caTotal), color: 'warning', onClick: showIRDetail }));
  container.appendChild(kpiGrid);

  // V57: Répartition CA HT - Basée sur le CA ENCAISSÉ (pas réalisé)
  container.appendChild(SectionTitle('📊', 'Répartition CA Encaissé HT'));

  // V57: Utiliser caHT (CA encaissé HT) pour cohérence avec le bénéfice net
  var caHTEnc = data.caHT || 1;
  // V57: Charges hors TVA (la TVA n'est pas une charge, c'est une dette)
  var chargesHorsTVA = (data.totalCharges || 0) - (data.tvaTotale || 0);
  var salaires = data.salaires || 0;
  var benefice = caHTEnc - chargesHorsTVA - salaires;

  var pctCharges = caHTEnc > 0 ? Math.round((chargesHorsTVA / caHTEnc) * 100) : 0;
  var pctSalaires = caHTEnc > 0 ? Math.round((salaires / caHTEnc) * 100) : 0;
  var pctBenefice = Math.max(0, 100 - pctCharges - pctSalaires);

  var repartCard = el('div', { class: 'card' });

  // Barre de répartition
  var bar = el('div', { style: { display: 'flex', height: '24px', borderRadius: '12px', overflow: 'hidden', marginBottom: '16px' } });
  bar.appendChild(el('div', { style: { width: pctCharges + '%', background: 'var(--danger)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px', fontWeight: '600' } }, pctCharges > 10 ? pctCharges + '%' : ''));
  bar.appendChild(el('div', { style: { width: pctSalaires + '%', background: 'var(--info)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px', fontWeight: '600' } }, pctSalaires > 10 ? pctSalaires + '%' : ''));
  bar.appendChild(el('div', { style: { width: pctBenefice + '%', background: 'var(--success)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: '10px', fontWeight: '600' } }, pctBenefice > 10 ? pctBenefice + '%' : ''));
  repartCard.appendChild(bar);

  // Légende
  var legend = el('div', { style: { display: 'flex', justifyContent: 'space-around', fontSize: '12px' } });
  legend.appendChild(el('div', { style: { textAlign: 'center' } }, [
    el('div', { style: { width: '12px', height: '12px', background: 'var(--danger)', borderRadius: '3px', display: 'inline-block', marginRight: '4px' } }),
    el('span', {}, 'Charges ' + EUR(chargesHorsTVA))
  ]));
  legend.appendChild(el('div', { style: { textAlign: 'center' } }, [
    el('div', { style: { width: '12px', height: '12px', background: 'var(--info)', borderRadius: '3px', display: 'inline-block', marginRight: '4px' } }),
    el('span', {}, 'Salaires ' + EUR(salaires))
  ]));
  legend.appendChild(el('div', { style: { textAlign: 'center' } }, [
    el('div', { style: { width: '12px', height: '12px', background: 'var(--success)', borderRadius: '3px', display: 'inline-block', marginRight: '4px' } }),
    el('span', {}, 'Bénéfice ' + EUR(benefice))
  ]));
  repartCard.appendChild(legend);
  container.appendChild(repartCard);

  // V55: Réorganisation du layout selon demande utilisateur
  // 1. Répartition CA/Bénéf (déjà fait ci-dessus)
  // 2. Impôts & Charges (détail)
  renderChargesSubTab(container, data);

  // 3. Comparaison N-1
  var cmp = getCompareData();
  if (cmp.prev.ca > 0) {
    container.appendChild(SectionTitle('📅', 'Comparaison ' + (TODAY.getFullYear() - 1) + ' vs ' + TODAY.getFullYear()));
    renderCompareWidget(container);
  }

  // 4. CA par client (en dernier, avec visualisation améliorée)
  container.appendChild(SectionTitle('👥', 'Répartition par Client'));
  renderClientsWidgetVisual(container, data);
}

function renderMissionsView(container) {
  renderMissions(container);
}

var FINANCES_TAB = 'factures'; // sous-onglet finances: factures, tresorerie, missions

function renderFinances(container) {
  // Header avec sous-onglets
  var header = el('div', { class: 'page-header', style: { marginBottom: '0' } });
  header.appendChild(el('h2', { class: 'page-title' }, '💰 Finances'));
  container.appendChild(header);

  // Sous-onglets Factures / Trésorerie / Missions
  var tabs = el('div', { style: { display: 'flex', gap: '4px', marginBottom: '16px', padding: '4px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });

  var tabFactures = el('button', {
    style: { flex: '1', padding: '8px 10px', border: 'none', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer', background: FINANCES_TAB === 'factures' ? 'var(--accent)' : 'transparent', color: FINANCES_TAB === 'factures' ? 'white' : 'var(--text-muted)' },
    onclick: function() { FINANCES_TAB = 'factures'; render(); }
  }, '📄 Factures');

  var tabTreso = el('button', {
    style: { flex: '1', padding: '8px 10px', border: 'none', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer', background: FINANCES_TAB === 'tresorerie' ? 'var(--accent)' : 'transparent', color: FINANCES_TAB === 'tresorerie' ? 'white' : 'var(--text-muted)' },
    onclick: function() { FINANCES_TAB = 'tresorerie'; render(); }
  }, '🏦 Trésorerie');

  var tabMissions = el('button', {
    style: { flex: '1', padding: '8px 10px', border: 'none', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer', background: FINANCES_TAB === 'missions' ? 'var(--accent)' : 'transparent', color: FINANCES_TAB === 'missions' ? 'white' : 'var(--text-muted)' },
    onclick: function() { FINANCES_TAB = 'missions'; render(); }
  }, '💼 Missions');

  // V72: Nouvel onglet Analyse
  var tabAnalyse = el('button', {
    style: { flex: '1', padding: '8px 10px', border: 'none', borderRadius: '6px', fontSize: '11px', fontWeight: '600', cursor: 'pointer', background: FINANCES_TAB === 'analyse' ? 'var(--accent)' : 'transparent', color: FINANCES_TAB === 'analyse' ? 'white' : 'var(--text-muted)' },
    onclick: function() { FINANCES_TAB = 'analyse'; render(); }
  }, '📊 Analyse');

  tabs.appendChild(tabFactures);
  tabs.appendChild(tabTreso);
  tabs.appendChild(tabMissions);
  tabs.appendChild(tabAnalyse);
  container.appendChild(tabs);

  // Contenu selon sous-onglet
  if (FINANCES_TAB === 'tresorerie') {
    renderTresorerieContent(container);
  } else if (FINANCES_TAB === 'missions') {
    renderMissionsContent(container);
  } else if (FINANCES_TAB === 'analyse') {
    renderAnalyseContent(container);
  } else {
    renderFacturesContent(container);
  }
}

// V60: Contenu Missions dans Finance - avec distinction Réalisé/Encaissé/Latent/Prévu
function renderMissionsContent(container) {
  var data = compute();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());

  // V60: Calculer les 4 types de CA
  var activeMissions = MISSIONS.filter(function(m) { return isMissionActive(m); });
  var aVenirMissions = MISSIONS.filter(function(m) { return getMissionStatus(m) === 'a_venir'; });
  var caRealise = 0;   // Jours réellement travaillés × TJM
  var caEncaisse = 0;  // Factures payées (HT)
  var caLatent = 0;    // Factures envoyées mais pas encore payées
  var caPrevu = 0;     // CA projeté sur missions futures (jours prévus non encore travaillés)
  var totalJours = 0;

  MISSIONS.forEach(function(m) {
    if (!m.lignes) return;
    // CA Réalisé = jours réels × TJM
    m.lignes.forEach(function(l) {
      if (!isInPeriod(l.ym)) return;
      var joursEffectifs = l.joursReels > 0 ? l.joursReels : 0;
      caRealise += joursEffectifs * m.tjm;
      totalJours += joursEffectifs;
      // CA Prévu = jours prévus non encore réalisés sur mois futurs
      if (l.ym > nowYm) {
        var joursPrevusFuturs = Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
        if (l.joursReels <= 0) {
          caPrevu += joursPrevusFuturs * m.tjm;
        }
      }
    });
    // CA Encaissé et Latent
    if (m.factures) m.factures.forEach(function(f) {
      if (f.jours <= 0) return;
      var paymentMonth = getPaymentMonth(f.mois, m.delaiPaiement, m.jourPaiement);
      if (!isInPeriod(f.mois) && !isInPeriod(paymentMonth)) return;
      if (f.status === 'payée' && isInPeriod(paymentMonth)) {
        caEncaisse += f.ht;
      } else if (f.status === 'envoyée') {
        caLatent += f.ht;
      }
    });
  });

  // KPIs Missions - 4 indicateurs + missions actives
  var kpiGrid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px', marginBottom: '16px' } });

  var kpiBlock = function(value, label, color, sub) {
    var block = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
    block.appendChild(el('div', { style: { fontSize: '20px', fontWeight: '800', color: color } }, value));
    block.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, label));
    if (sub) block.appendChild(el('div', { style: { fontSize: '9px', color: 'var(--text-muted)', marginTop: '2px' } }, sub));
    return block;
  };

  kpiGrid.appendChild(kpiBlock(String(activeMissions.length) + (aVenirMissions.length > 0 ? ' + ' + aVenirMissions.length : ''), 'Missions actives' + (aVenirMissions.length > 0 ? ' + à venir' : ''), 'var(--accent)', totalJours + ' jours travaillés'));
  kpiGrid.appendChild(kpiBlock(EUR(caRealise), 'CA Réalisé', 'var(--info)', 'Jours travaillés × TJM'));
  kpiGrid.appendChild(kpiBlock(EUR(caEncaisse), 'CA Encaissé', 'var(--success)', 'Factures payées HT'));
  kpiGrid.appendChild(kpiBlock(EUR(caLatent), 'CA Latent', 'var(--warning)', 'Facturé non encaissé'));

  container.appendChild(kpiGrid);

  // V60: CA Prévu si existant
  if (caPrevu > 0) {
    var prevuBlock = el('div', { style: { textAlign: 'center', padding: '12px', background: 'rgba(139,92,246,0.08)', borderRadius: '8px', marginBottom: '16px', border: '1px dashed rgba(139,92,246,0.3)' } });
    prevuBlock.appendChild(el('div', { style: { fontSize: '20px', fontWeight: '800', color: '#a78bfa' } }, EUR(caPrevu)));
    prevuBlock.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, '🔮 CA Prévu (missions en cours & à venir)'));
    container.appendChild(prevuBlock);
  }

  // Bouton ajouter
  container.appendChild(el('button', { class: 'btn btn-success', style: { width: '100%', marginBottom: '16px' }, onclick: showMissionModal }, '+ Nouvelle Mission'));

  // Liste des missions
  if (MISSIONS.length === 0) {
    var emptyDiv = el('div', { class: 'no-results' });
    emptyDiv.appendChild(el('div', { class: 'no-results-icon' }, '💼'));
    emptyDiv.appendChild(el('div', { class: 'no-results-title' }, 'Aucune mission'));
    emptyDiv.appendChild(el('div', { class: 'no-results-hint' }, 'Ajoute ta première mission pour commencer'));
    container.appendChild(emptyDiv);
    return;
  }

  MISSIONS.forEach(function(m) {
    var jours = 0, ca = 0;
    if (m.factures) m.factures.forEach(function(f) {
      if (isInPeriod(f.mois) && f.jours > 0) { jours += f.jours; ca += f.ht; }
    });

    var card = el('div', { class: 'mission-card', style: { cursor: 'pointer' }, onclick: function() { showMissionModal(m); } });
    var header = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' } });
    header.appendChild(el('div', { style: { fontWeight: '700', fontSize: '14px' } }, m.client));
    // V60: Statut mission complet : Actif / À venir / Terminé
    var mStatus = getMissionStatus(m);
    var badgeCls = mStatus === 'active' ? 'badge-success' : mStatus === 'a_venir' ? 'badge-warning' : 'badge-muted';
    var badgeTxt = mStatus === 'active' ? 'Actif' : mStatus === 'a_venir' ? 'À venir' : 'Terminé';
    header.appendChild(el('div', { class: 'badge ' + badgeCls }, badgeTxt));
    card.appendChild(header);

    // V60: Titre du poste sous le nom du client
    if (m.titre) {
      card.appendChild(el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px', fontStyle: 'italic' } }, m.titre));
    }

    // V60: Période de la mission
    if (m.debut && m.fin) {
      card.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px' } }, '📅 ' + fmtDate(new Date(m.debut)) + ' → ' + fmtDate(new Date(m.fin))));
    }

    var details = el('div', { style: { fontSize: '12px', color: 'var(--text-muted)', display: 'flex', gap: '12px' } });
    details.appendChild(el('span', {}, '💶 TJM: ' + EUR(m.tjm)));
    details.appendChild(el('span', {}, '📅 ' + jours + ' jours'));
    details.appendChild(el('span', {}, '💰 ' + EUR(ca)));
    card.appendChild(details);

    container.appendChild(card);
  });
}

// V72: Module Composition Compte avec Waterfall Chart
function renderAnalyseContent(container) {
  var data = compute();
  var periodLabel = PERIOD.month !== null ? fmtMonthShort(ym(PERIOD.year, PERIOD.month)) : PERIOD.year;

  // Calculer les données pour le Waterfall
  var caHT = data.caHT || 0;
  var chargesURSSAF = 0;
  var chargesTVA = 0;
  var chargesIR = 0;
  var autresDepenses = 0;

  // URSSAF + CFP
  if (data.detailChargesAPayer) {
    data.detailChargesAPayer.forEach(function(c) {
      if (c.cat === 'URSSAF' || c.cat === 'CFP') chargesURSSAF += c.montant;
      else if (c.cat === 'TVA') chargesTVA += c.montant;
      else if (c.cat === 'IR' || c.cat === 'IR Estimé') chargesIR += c.montant;
      else autresDepenses += c.montant;
    });
  }
  // Ajouter charges déjà payées
  if (data.detailChargesPayees) {
    data.detailChargesPayees.forEach(function(c) {
      if (c.cat === 'URSSAF' || c.cat === 'CFP') chargesURSSAF += c.montant;
      else if (c.cat === 'TVA') chargesTVA += c.montant;
      else if (c.cat === 'IR' || c.cat === 'IR Estimé') chargesIR += c.montant;
      else autresDepenses += c.montant;
    });
  }

  var totalCharges = chargesURSSAF + chargesTVA + chargesIR + autresDepenses;
  var netDisponible = Math.max(0, caHT - totalCharges);

  // Waterfall data
  var waterfallData = [
    { id: 'ca', label: 'CA Produit HT', value: caHT, cumul: caHT, type: 'total', color: 'var(--success)', icon: '💰' },
    { id: 'urssaf', label: 'Charges sociales', value: -chargesURSSAF, cumul: caHT - chargesURSSAF, type: 'decrease', color: 'var(--danger)', icon: '🏥', detail: 'URSSAF + CFP' },
    { id: 'tva', label: 'TVA à reverser', value: -chargesTVA, cumul: caHT - chargesURSSAF - chargesTVA, type: 'decrease', color: '#ec4899', icon: '🏛️' },
    { id: 'ir', label: 'IR / Impôts', value: -chargesIR, cumul: caHT - chargesURSSAF - chargesTVA - chargesIR, type: 'decrease', color: '#f59e0b', icon: '🧾' },
    { id: 'autres', label: 'Autres dépenses', value: -autresDepenses, cumul: caHT - totalCharges, type: 'decrease', color: 'var(--text-muted)', icon: '📋' },
    { id: 'net', label: 'Marge disponible', value: netDisponible, cumul: netDisponible, type: 'total', color: 'var(--accent)', icon: '💎' }
  ];

  // Filtrer les barres à 0
  waterfallData = waterfallData.filter(function(d) { return d.value !== 0 || d.type === 'total'; });

  // Card titre
  var card = el('div', { class: 'card', style: { marginBottom: '16px' } });
  card.appendChild(el('div', { class: 'card-title' }, '📊 Composition du Compte - ' + periodLabel));
  card.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '16px' } }, 'Cliquez sur une barre pour voir le détail'));

  // Waterfall Chart Container
  var chartContainer = el('div', { style: { position: 'relative', marginBottom: '20px' } });

  // Trouver le max pour l'échelle
  var maxVal = caHT * 1.05;
  var barHeight = 40;
  var chartHeight = waterfallData.length * (barHeight + 12);

  // Dessiner le waterfall horizontal
  var waterfall = el('div', { style: { position: 'relative', height: chartHeight + 'px' } });

  waterfallData.forEach(function(d, idx) {
    var startPct = 0;
    var widthPct = 0;

    if (d.type === 'total') {
      widthPct = Math.abs(d.value) / maxVal * 100;
    } else {
      // Pour les decreases, la barre part du cumul précédent
      var prevCumul = idx > 0 ? waterfallData[idx - 1].cumul : caHT;
      startPct = d.cumul / maxVal * 100;
      widthPct = Math.abs(d.value) / maxVal * 100;
    }

    var row = el('div', { style: {
      display: 'flex', alignItems: 'center', height: barHeight + 'px', marginBottom: '12px', cursor: 'pointer'
    }, onclick: function() { showWaterfallDetail(d, data); } });

    // Label gauche
    var labelDiv = el('div', { style: { width: '130px', paddingRight: '10px', textAlign: 'right', fontSize: '11px' } });
    labelDiv.appendChild(el('div', { style: { fontWeight: '600' } }, d.icon + ' ' + d.label));
    labelDiv.appendChild(el('div', { style: { color: d.value >= 0 ? 'var(--success)' : 'var(--danger)', fontWeight: '700' } }, (d.value >= 0 ? '+' : '') + EUR(d.value)));
    row.appendChild(labelDiv);

    // Barre
    var barContainer = el('div', { style: { flex: 1, position: 'relative', height: '100%', background: 'var(--bg-tertiary)', borderRadius: '8px', overflow: 'hidden' } });

    if (d.type === 'total') {
      var bar = el('div', { style: {
        position: 'absolute', left: '0', top: '0', height: '100%',
        width: widthPct + '%', background: d.color, borderRadius: '8px',
        display: 'flex', alignItems: 'center', justifyContent: 'flex-end', paddingRight: '8px',
        color: 'white', fontSize: '10px', fontWeight: '700', minWidth: '60px'
      } }, EUR(Math.abs(d.value)));
      barContainer.appendChild(bar);
    } else {
      // Barre de decrease (démarre là où finit le précédent)
      var bar = el('div', { style: {
        position: 'absolute', left: startPct + '%', top: '0', height: '100%',
        width: widthPct + '%', background: d.color, borderRadius: '4px',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        color: 'white', fontSize: '10px', fontWeight: '700', opacity: '0.9'
      } }, widthPct > 8 ? EUR(Math.abs(d.value)) : '');
      barContainer.appendChild(bar);

      // Ligne de connexion
      if (idx > 0) {
        var prevCumul = waterfallData[idx - 1].cumul;
        var linePos = prevCumul / maxVal * 100;
        var line = el('div', { style: {
          position: 'absolute', left: linePos + '%', top: '0', height: '100%',
          width: '2px', background: 'var(--border)', opacity: '0.5'
        }});
        barContainer.appendChild(line);
      }
    }

    row.appendChild(barContainer);
    waterfall.appendChild(row);
  });

  chartContainer.appendChild(waterfall);
  card.appendChild(chartContainer);

  // Légende
  var legend = el('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '12px', justifyContent: 'center', fontSize: '10px', padding: '10px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  var legendItems = [
    { label: 'Revenu', color: 'var(--success)' },
    { label: 'Charges sociales', color: 'var(--danger)' },
    { label: 'TVA', color: '#ec4899' },
    { label: 'Impôts', color: '#f59e0b' },
    { label: 'Marge', color: 'var(--accent)' }
  ];
  legendItems.forEach(function(l) {
    var item = el('div', { style: { display: 'flex', alignItems: 'center', gap: '4px' } });
    item.appendChild(el('div', { style: { width: '12px', height: '12px', background: l.color, borderRadius: '3px' } }));
    item.appendChild(el('span', { style: { color: 'var(--text-muted)' } }, l.label));
    legend.appendChild(item);
  });
  card.appendChild(legend);

  container.appendChild(card);

  // Card Ratios
  var ratiosCard = el('div', { class: 'card', style: { marginBottom: '16px' } });
  ratiosCard.appendChild(el('div', { class: 'card-title' }, '📈 Ratios Clés'));

  var ratiosGrid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' } });

  var margeRate = caHT > 0 ? Math.round(netDisponible / caHT * 100) : 0;
  var chargesRate = caHT > 0 ? Math.round(totalCharges / caHT * 100) : 0;
  var urssafRate = caHT > 0 ? Math.round(chargesURSSAF / caHT * 100) : 0;
  var irRate = caHT > 0 ? Math.round(chargesIR / caHT * 100) : 0;

  function addRatioCard(label, value, color, percent) {
    var kpi = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
    kpi.appendChild(el('div', { style: { fontSize: '22px', fontWeight: '800', color: color } }, percent + '%'));
    kpi.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '4px' } }, label));
    kpi.appendChild(el('div', { style: { fontSize: '11px', fontWeight: '600', marginTop: '2px' } }, EUR(value)));
    ratiosGrid.appendChild(kpi);
  }

  addRatioCard('Marge nette', netDisponible, 'var(--accent)', margeRate);
  addRatioCard('Total charges', totalCharges, 'var(--danger)', chargesRate);
  addRatioCard('Charges sociales', chargesURSSAF, 'var(--warning)', urssafRate);
  addRatioCard('IR / Impôts', chargesIR, '#f59e0b', irRate);

  ratiosCard.appendChild(ratiosGrid);
  container.appendChild(ratiosCard);
}

// V72: Détail d'une barre du Waterfall (drill-down camembert)
function showWaterfallDetail(d, data) {
  var modal = $('#formModal');
  $('#formModalTitle').textContent = d.icon + ' ' + d.label;
  var body = $('#formModalBody');
  body.innerHTML = '';

  var items = [];
  var totalCat = 0;

  // Collecter les détails selon la catégorie
  if (d.id === 'ca') {
    // Détail CA par client
    MISSIONS.forEach(function(m) {
      var clientCA = 0;
      if (m.factures) m.factures.forEach(function(f) {
        if (f.status === 'payée' && f.jours > 0 && isInPeriod(getPaymentMonth(f.mois, m.delaiPaiement, m.jourPaiement))) {
          clientCA += f.ht;
        }
      });
      if (clientCA > 0) items.push({ label: m.client, value: clientCA, color: 'var(--success)' });
    });
    totalCat = data.caHT || 0;
  } else if (d.id === 'urssaf') {
    items.push({ label: 'URSSAF', value: 0, color: 'var(--danger)' });
    items.push({ label: 'CFP', value: 0, color: '#f87171' });
    (data.detailChargesAPayer || []).concat(data.detailChargesPayees || []).forEach(function(c) {
      if (c.cat === 'URSSAF') items[0].value += c.montant;
      else if (c.cat === 'CFP') items[1].value += c.montant;
    });
    totalCat = items[0].value + items[1].value;
  } else if (d.id === 'tva') {
    items.push({ label: 'TVA à reverser', value: 0, color: '#ec4899' });
    (data.detailChargesAPayer || []).concat(data.detailChargesPayees || []).forEach(function(c) {
      if (c.cat === 'TVA') items[0].value += c.montant;
    });
    totalCat = items[0].value;
  } else if (d.id === 'ir') {
    items.push({ label: 'IR Estimé', value: 0, color: '#f59e0b' });
    (data.detailChargesAPayer || []).concat(data.detailChargesPayees || []).forEach(function(c) {
      if (c.cat === 'IR' || c.cat === 'IR Estimé') items[0].value += c.montant;
    });
    totalCat = items[0].value;
  } else if (d.id === 'net') {
    var marge = data.caHT - (data.provisionsAbsolues || 0) - (data.totalPayees || 0);
    items.push({ label: 'Cash disponible', value: data.cashDispoAbsolu || 0, color: 'var(--accent)' });
    items.push({ label: 'Rémunération possible', value: data.salaireReco || 0, color: 'var(--success)' });
    totalCat = Math.abs(d.value);
  }

  // Filtrer items vides
  items = items.filter(function(i) { return i.value > 0; });

  if (items.length === 0) {
    body.appendChild(el('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-muted)' } }, 'Aucun détail disponible'));
    openModal('formModal');
    return;
  }

  // Montant total
  body.appendChild(el('div', { style: { textAlign: 'center', marginBottom: '20px' } }, [
    el('div', { style: { fontSize: '32px', fontWeight: '800', color: d.color } }, EUR(Math.abs(d.value))),
    el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, Math.round(Math.abs(d.value) / (data.caHT || 1) * 100) + '% du CA HT')
  ]));

  // Camembert simplifié (barres horizontales proportionnelles)
  var pieContainer = el('div', { style: { marginBottom: '20px' } });
  var maxItemValue = Math.max.apply(null, items.map(function(i) { return i.value; }));

  items.forEach(function(item) {
    var pct = totalCat > 0 ? Math.round(item.value / totalCat * 100) : 0;
    var widthPct = maxItemValue > 0 ? (item.value / maxItemValue * 100) : 0;

    var row = el('div', { style: { marginBottom: '12px', cursor: 'pointer' }, onclick: function() {
      // Niveau 2: détail des écritures
      showTransactionDetail(d.id, item.label, data);
    }});

    var labelRow = el('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '4px', fontSize: '12px' } });
    labelRow.appendChild(el('span', { style: { fontWeight: '600' } }, item.label));
    labelRow.appendChild(el('span', { style: { color: 'var(--text-muted)' } }, EUR(item.value) + ' (' + pct + '%)'));
    row.appendChild(labelRow);

    var barBg = el('div', { style: { height: '24px', background: 'var(--bg-tertiary)', borderRadius: '6px', overflow: 'hidden' } });
    barBg.appendChild(el('div', { style: { height: '100%', width: widthPct + '%', background: item.color, borderRadius: '6px', minWidth: '20px' } }));
    row.appendChild(barBg);

    pieContainer.appendChild(row);
  });

  body.appendChild(pieContainer);
  body.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', textAlign: 'center' } }, 'Cliquez sur une ligne pour voir les écritures'));

  openModal('formModal');
}

// V72: Niveau 2 - Détail des transactions/écritures
function showTransactionDetail(catId, subLabel, data) {
  var transactions = [];

  // Collecter les transactions selon la catégorie
  if (catId === 'ca') {
    MISSIONS.forEach(function(m) {
      if (m.client !== subLabel) return;
      if (m.factures) m.factures.forEach(function(f) {
        if (f.status === 'payée' && f.jours > 0 && isInPeriod(getPaymentMonth(f.mois, m.delaiPaiement, m.jourPaiement))) {
          transactions.push({ date: f.mois, label: 'Facture ' + f.id, montant: f.ht, status: 'payée' });
        }
      });
    });
  } else {
    var catMatch = subLabel;
    if (catId === 'urssaf' && subLabel === 'URSSAF') catMatch = 'URSSAF';
    else if (catId === 'urssaf' && subLabel === 'CFP') catMatch = 'CFP';
    else if (catId === 'tva') catMatch = 'TVA';
    else if (catId === 'ir') catMatch = 'IR';

    (data.detailChargesAPayer || []).forEach(function(c) {
      if (c.cat === catMatch || (catId === 'ir' && (c.cat === 'IR' || c.cat === 'IR Estimé'))) {
        transactions.push({ date: c.mois, label: c.desc || c.cat, montant: c.montant, status: 'à payer', id: c.id });
      }
    });
    (data.detailChargesPayees || []).forEach(function(c) {
      if (c.cat === catMatch || (catId === 'ir' && (c.cat === 'IR' || c.cat === 'IR Estimé'))) {
        transactions.push({ date: c.mois, label: c.desc || c.cat, montant: c.montant, status: 'payé', id: c.id });
      }
    });
  }

  var modal = $('#formModal');
  $('#formModalTitle').textContent = '📋 ' + subLabel + ' - Détail';
  var body = $('#formModalBody');
  body.innerHTML = '';

  if (transactions.length === 0) {
    body.appendChild(el('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-muted)' } }, 'Aucune écriture'));
    return;
  }

  // Liste des transactions
  transactions.sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); });

  var list = el('div', { style: { maxHeight: '400px', overflowY: 'auto' } });
  var total = 0;

  transactions.forEach(function(t) {
    total += t.montant;
    var row = el('div', { style: {
      display: 'flex', alignItems: 'center', padding: '10px', marginBottom: '8px',
      background: 'var(--bg-tertiary)', borderRadius: '8px', gap: '12px'
    }});

    row.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', minWidth: '60px' } }, t.date ? fmtMonthShort(t.date) : '-'));
    row.appendChild(el('div', { style: { flex: 1, fontSize: '12px' } }, t.label));
    row.appendChild(el('div', { style: { fontWeight: '700', fontSize: '12px' } }, EUR(t.montant)));

    var statusColor = t.status === 'payé' || t.status === 'payée' ? 'var(--success)' : 'var(--warning)';
    row.appendChild(el('div', { style: { fontSize: '9px', padding: '2px 6px', background: statusColor, color: 'white', borderRadius: '4px' } }, t.status));

    // Bouton toggle si à payer
    if (t.status === 'à payer' && t.id) {
      row.appendChild(el('button', { class: 'btn btn-sm', style: { fontSize: '10px' }, onclick: function(e) {
        e.stopPropagation();
        TREASURY.paidCharges[t.id] = true;
        saveAll();
        COMPUTED = compute();
        render();
        toast('Marqué payé', 'success');
      }}, '✓'));
    }

    list.appendChild(row);
  });

  body.appendChild(list);

  // Total
  body.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', marginTop: '12px', background: 'var(--bg-secondary)', borderRadius: '8px', fontWeight: '700' } }, [
    el('span', {}, 'Total'),
    el('span', {}, EUR(total))
  ]));
}

function renderFacturesContent(container) {
  var data = compute();

  // V51: Section Indicateurs (KPIs facturation)
  var indicatorsDiv = el('div', { class: 'card', style: { marginBottom: '16px', padding: '16px' } });
  indicatorsDiv.appendChild(el('div', { class: 'card-title', style: { marginBottom: '12px' } }, '📊 Indicateurs'));

  var kpiGrid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' } });

  // KPI: À créer
  var kpiACreer = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiACreer.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: 'var(--text-muted)' } }, String(data.facturesStats.brouillon)));
  kpiACreer.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'À créer'));
  kpiGrid.appendChild(kpiACreer);

  // KPI: Envoyées
  var kpiEnvoyees = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiEnvoyees.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: 'var(--info)' } }, String(data.facturesStats.envoyees)));
  kpiEnvoyees.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Envoyées'));
  kpiGrid.appendChild(kpiEnvoyees);

  // KPI: En retard
  var kpiRetard = el('div', { style: { textAlign: 'center', padding: '12px', background: data.facturesStats.retard > 0 ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiRetard.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: data.facturesStats.retard > 0 ? 'var(--danger)' : 'var(--text-muted)' } }, String(data.facturesStats.retard)));
  kpiRetard.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'En retard'));
  kpiGrid.appendChild(kpiRetard);

  // KPI: Payées
  var kpiPayees = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiPayees.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: 'var(--success)' } }, String(data.facturesStats.payees)));
  kpiPayees.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Payées'));
  kpiGrid.appendChild(kpiPayees);

  indicatorsDiv.appendChild(kpiGrid);
  container.appendChild(indicatorsDiv);

  // Chips de filtre par statut
  var chips = el('div', { class: 'filter-chips', style: { marginBottom: '16px' } });
  var totalFactures = data.facturesStats.brouillon + data.facturesStats.envoyees + data.facturesStats.payees;
  var filters = [
    { key: 'all', label: 'Toutes', count: totalFactures },
    { key: 'brouillon', label: 'À créer', count: data.facturesStats.brouillon },
    { key: 'envoyées', label: 'Envoyées', count: data.facturesStats.envoyees },
    { key: 'retard', label: 'En retard', count: data.facturesStats.retard },
    { key: 'payées', label: 'Payées', count: data.facturesStats.payees }
  ];
  filters.forEach(function(f) {
    var chip = el('div', { class: 'filter-chip' + (FACTURE_FILTER === f.key ? ' active' : ''), onclick: function() { FACTURE_FILTER = f.key; render(); } });
    chip.appendChild(document.createTextNode(f.label));
    chip.appendChild(el('span', { class: 'count' }, String(f.count)));
    chips.appendChild(chip);
  });
  container.appendChild(chips);

  // Liste des factures
  var factures = [];
  MISSIONS.forEach(function(m) {
    if (m.factures) m.factures.forEach(function(f) {
      if (!isInPeriod(f.mois) || f.jours <= 0) return;
      f.paymentMonth = getPaymentMonth(f.mois, m.delaiPaiement, m.jourPaiement);
      var paymentDate = getPaymentDate(f.mois, m.delaiPaiement, m.jourPaiement);
      f.paymentDate = paymentDate;
      f.isLate = f.status === 'envoyée' && TODAY > paymentDate;
      factures.push(f);
    });
  });

  // Filtre par statut
  if (FACTURE_FILTER !== 'all') {
    factures = factures.filter(function(f) {
      if (FACTURE_FILTER === 'retard') return f.isLate;
      if (FACTURE_FILTER === 'envoyées') return f.status === 'envoyée';
      if (FACTURE_FILTER === 'payées') return f.status === 'payée';
      if (FACTURE_FILTER === 'brouillon') return f.status === 'brouillon';
      return true;
    });
  }

  factures.sort(function(a, b) { return b.mois.localeCompare(a.mois); });

  if (factures.length === 0) {
    var emptyDiv = el('div', { class: 'no-results' });
    emptyDiv.appendChild(el('div', { class: 'no-results-icon' }, '📄'));
    emptyDiv.appendChild(el('div', { class: 'no-results-title' }, 'Aucune facture'));
    emptyDiv.appendChild(el('div', { class: 'no-results-hint' }, 'Les factures apparaîtront quand tu saisiras des jours'));
    container.appendChild(emptyDiv);
    return;
  }

  factures.forEach(function(f) {
    var badgeClass, badgeText;
    if (f.status === 'payée') { badgeClass = 'badge-success'; badgeText = '✅ Payée'; }
    else if (f.isLate) { badgeClass = 'badge-late'; badgeText = '📤 Envoyée · ⚠️ RETARD'; }
    else if (f.status === 'envoyée') { badgeClass = 'badge-warning'; badgeText = '📤 Envoyée'; }
    else { badgeClass = 'badge-muted'; badgeText = '📝 Brouillon'; }

    var card = el('div', { class: 'facture-card', onclick: function() { showFactureModal(f); } });
    card.appendChild(el('div', { class: 'badge ' + badgeClass, style: { fontSize: '9px', whiteSpace: 'nowrap' } }, badgeText));
    var infoDiv = el('div', { class: 'facture-info' });
    infoDiv.appendChild(el('div', { class: 'facture-id' }, f.client + ' · ' + fmtMonthShort(f.mois)));
    infoDiv.appendChild(el('div', { class: 'facture-meta' }, f.jours + 'j · Paiement ' + fmtMonthShort(f.paymentMonth)));
    card.appendChild(infoDiv);
    card.appendChild(el('div', { class: 'facture-amount' }, [el('div', { class: 'facture-ht' }, EUR(f.ht)), f.tva > 0 ? el('div', { class: 'facture-tva' }, 'TVA ' + EUR(f.tva)) : null]));
    container.appendChild(card);
  });
}

function renderTresorerieContent(container) {
  var data = compute();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var selectedMonth = PERIOD.month !== null ? ym(PERIOD.year, PERIOD.month) : nowYm;

  // V72: Calculer projection salaire pour chaque mois de l'année
  var months = [];
  for (var m = 0; m < 12; m++) months.push(ym(PERIOD.year, m));
  var salaireProjections = computeSalaireProjections(months, data);

  // V72: Données du mois sélectionné pour le donut
  var monthData = getMonthFinancialData(selectedMonth, data);

  // === SECTION 1: KPI HERO ===
  var heroSection = el('div', { style: { marginBottom: '16px' } });

  // Solde compte + Cash dispo
  var heroGrid = el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '12px' } });

  var soldeCard = el('div', { class: 'treso-item', style: { cursor: 'pointer' }, onclick: showCashDetail });
  soldeCard.appendChild(el('div', { class: 'treso-item-value ' + (data.soldeAbsolu >= 0 ? 'text-success' : 'text-danger') }, EUR(data.soldeAbsolu)));
  soldeCard.appendChild(el('div', { class: 'treso-item-label' }, '🏦 Solde Compte'));
  heroGrid.appendChild(soldeCard);

  var cashCard = el('div', { class: 'treso-item' });
  cashCard.appendChild(el('div', { class: 'treso-item-value ' + (data.cashDispoAbsolu >= 0 ? 'text-success' : 'text-danger') }, EUR(data.cashDispoAbsolu)));
  cashCard.appendChild(el('div', { class: 'treso-item-label' }, '💎 Cash Disponible'));
  heroGrid.appendChild(cashCard);

  heroSection.appendChild(heroGrid);
  container.appendChild(heroSection);

  // === SECTION 2: GRAPHIQUE PROJECTION SALAIRE ===
  var chartCard = el('div', { class: 'card', style: { marginBottom: '16px' } });
  chartCard.appendChild(el('div', { class: 'card-title' }, '📈 Projection Salaire ' + PERIOD.year));
  chartCard.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '12px' } }, 'Salaire versable par mois (réalisé + projection)'));

  // Graphique barre simplifiée (sans Chart.js pour éviter dépendance)
  var chartContainer = el('div', { style: { display: 'flex', alignItems: 'flex-end', gap: '4px', height: '140px', padding: '8px 0' } });
  var maxSal = Math.max.apply(null, salaireProjections.map(function(s) { return s.salaire; })) || 2000;

  salaireProjections.forEach(function(proj, idx) {
    var isPast = proj.ym < nowYm;
    var isCurrent = proj.ym === nowYm;
    var isFuture = proj.ym > nowYm;
    var isSelected = proj.ym === selectedMonth;
    var height = maxSal > 0 ? Math.max(4, (proj.salaire / maxSal) * 100) : 4;

    var barColor = isPast ? 'rgba(96,165,250,0.6)' : isCurrent ? 'var(--accent)' : 'rgba(167,139,250,0.5)';
    if (proj.salaire <= 0) barColor = 'var(--bg-tertiary)';

    var bar = el('div', { style: {
      flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', cursor: 'pointer'
    }, onclick: function() {
      PERIOD.month = idx;
      render();
    }});

    // Montant au-dessus
    if (proj.salaire > 0) {
      bar.appendChild(el('div', { style: { fontSize: '8px', color: 'var(--text-muted)', marginBottom: '2px' } }, (proj.salaire / 1000).toFixed(1) + 'k'));
    }

    // Barre
    bar.appendChild(el('div', { style: {
      width: '100%', height: height + '%', background: barColor,
      borderRadius: '4px 4px 0 0', transition: 'height 0.3s',
      border: isSelected ? '2px solid var(--accent)' : 'none',
      boxShadow: isSelected ? '0 0 8px rgba(139,92,246,0.5)' : 'none'
    }}));

    // Label mois
    bar.appendChild(el('div', { style: {
      fontSize: '9px', marginTop: '4px',
      color: isSelected ? 'var(--accent)' : isCurrent ? 'var(--text-primary)' : 'var(--text-muted)',
      fontWeight: isSelected || isCurrent ? '700' : '400'
    }}, fmtMonthShort(proj.ym).substring(0, 3)));

    chartContainer.appendChild(bar);
  });

  chartCard.appendChild(chartContainer);

  // Légende
  var legend = el('div', { style: { display: 'flex', gap: '16px', justifyContent: 'center', fontSize: '9px', color: 'var(--text-muted)' } });
  legend.appendChild(el('span', {}, '● Réalisé'));
  legend.appendChild(el('span', { style: { color: 'rgba(167,139,250,0.8)' } }, '● Projection'));
  chartCard.appendChild(legend);

  container.appendChild(chartCard);

  // === SECTION 3: DONUT COMPOSITION MOIS + KPI CENTRAL ===
  var donutCard = el('div', { class: 'card', style: { marginBottom: '16px' } });
  donutCard.appendChild(el('div', { class: 'card-title' }, '🍩 Composition - ' + fmtMonth(selectedMonth)));

  var donutContainer = el('div', { style: { display: 'flex', alignItems: 'center', gap: '20px', padding: '16px 0' } });

  // Donut (simulé avec divs CSS)
  var donutSize = 140;
  var donutWrapper = el('div', { style: {
    width: donutSize + 'px', height: donutSize + 'px', position: 'relative', flexShrink: 0
  }});

  // Calculer les segments du donut
  var segments = [
    { label: 'CA HT', value: monthData.caHT, color: 'var(--success)' },
    { label: 'Charges', value: monthData.charges, color: 'var(--danger)' },
    { label: 'Provisions', value: monthData.provisions, color: 'var(--warning)' },
    { label: 'Salaires', value: monthData.salaires, color: 'var(--info)' }
  ];
  var total = segments.reduce(function(sum, s) { return sum + s.value; }, 0) || 1;

  // Dessiner le donut avec conic-gradient
  var gradientParts = [];
  var cumul = 0;
  segments.forEach(function(s) {
    if (s.value > 0) {
      var pct = (s.value / total) * 100;
      gradientParts.push(s.color + ' ' + cumul + '% ' + (cumul + pct) + '%');
      cumul += pct;
    }
  });

  var donutBg = gradientParts.length > 0 ? 'conic-gradient(' + gradientParts.join(', ') + ')' : 'var(--bg-tertiary)';

  var donutOuter = el('div', { style: {
    width: '100%', height: '100%', borderRadius: '50%', background: donutBg
  }});

  // Centre du donut (trou)
  var donutCenter = el('div', { style: {
    position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
    width: (donutSize * 0.65) + 'px', height: (donutSize * 0.65) + 'px',
    borderRadius: '50%', background: 'var(--bg-primary)',
    display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center'
  }});

  // KPI Central: Rémunération recommandée
  var recoSalaire = monthData.salaireReco;
  donutCenter.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Versable'));
  donutCenter.appendChild(el('div', { style: { fontSize: '20px', fontWeight: '800', color: 'var(--accent)' } }, EUR(recoSalaire)));

  donutWrapper.appendChild(donutOuter);
  donutWrapper.appendChild(donutCenter);
  donutContainer.appendChild(donutWrapper);

  // Légende donut
  var donutLegend = el('div', { style: { flex: 1 } });
  segments.forEach(function(s) {
    if (s.value > 0) {
      var pct = Math.round((s.value / total) * 100);
      var row = el('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' } });
      row.appendChild(el('div', { style: { width: '12px', height: '12px', borderRadius: '3px', background: s.color } }));
      row.appendChild(el('div', { style: { flex: 1, fontSize: '11px' } }, s.label));
      row.appendChild(el('div', { style: { fontSize: '11px', fontWeight: '600' } }, EUR(s.value)));
      row.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, pct + '%'));
      donutLegend.appendChild(row);
    }
  });
  donutContainer.appendChild(donutLegend);

  donutCard.appendChild(donutContainer);
  container.appendChild(donutCard);

  // === SECTION 4: ACTIONS DE GESTION ===
  var actionsCard = el('div', { class: 'card', style: { marginBottom: '16px' } });
  actionsCard.appendChild(el('div', { class: 'card-title' }, '⚡ Actions - ' + fmtMonth(selectedMonth)));

  // Bouton verser salaire
  var salaireRow = el('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  salaireRow.appendChild(el('div', { style: { flex: 1 } }, [
    el('div', { style: { fontWeight: '600', fontSize: '12px' } }, '💸 Verser un salaire'),
    el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Recommandé: ' + EUR(recoSalaire))
  ]));
  var salaireInput = el('input', { type: 'number', class: 'form-input', style: { width: '100px', fontSize: '12px' }, value: recoSalaire, placeholder: 'Montant' });
  salaireRow.appendChild(salaireInput);
  salaireRow.appendChild(el('button', { class: 'btn btn-success btn-sm', onclick: function() {
    var montant = parseFloat(salaireInput.value) || 0;
    if (montant <= 0) { toast('Montant invalide', 'error'); return; }
    TREASURY.salaires = TREASURY.salaires || {};
    TREASURY.salaires[selectedMonth] = (TREASURY.salaires[selectedMonth] || 0) + montant;
    saveAll();
    COMPUTED = compute();
    render();
    toast('Salaire de ' + EUR(montant) + ' versé!', 'success');
  }}, '✓ Verser'));
  actionsCard.appendChild(salaireRow);

  // Liste des charges du mois avec toggle provision/payé
  var chargesMois = getChargesForMonth(selectedMonth, data);
  if (chargesMois.length > 0) {
    actionsCard.appendChild(el('div', { style: { fontSize: '11px', fontWeight: '600', marginBottom: '8px', color: 'var(--text-muted)' } }, '📋 Charges du mois'));

    chargesMois.forEach(function(c) {
      var isPaid = TREASURY.paidCharges && TREASURY.paidCharges[c.id];
      var row = el('div', { style: {
        display: 'flex', alignItems: 'center', gap: '10px', padding: '10px',
        background: isPaid ? 'rgba(34,197,94,0.1)' : 'var(--bg-tertiary)',
        borderRadius: '6px', marginBottom: '6px'
      }});

      row.appendChild(el('div', { style: { flex: 1 } }, [
        el('div', { style: { fontSize: '12px', fontWeight: '600' } }, c.cat),
        el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, c.desc || '')
      ]));

      row.appendChild(el('div', { style: { fontWeight: '700', fontSize: '12px' } }, EUR(c.montant)));

      // Toggle button
      var toggleBtn = el('button', { class: 'btn btn-sm ' + (isPaid ? '' : 'btn-success'), onclick: function() {
        if (isPaid) {
          delete TREASURY.paidCharges[c.id];
        } else {
          TREASURY.paidCharges = TREASURY.paidCharges || {};
          TREASURY.paidCharges[c.id] = true;
        }
        saveAll();
        COMPUTED = compute();
        render();
        toast(isPaid ? 'Remis en provision' : 'Marqué payé', 'success');
      }}, isPaid ? '↩ Provision' : '✓ Payé');
      row.appendChild(toggleBtn);

      actionsCard.appendChild(row);
    });
  }

  container.appendChild(actionsCard);

  // === SECTION 5: GRILLE RÉSUMÉ ===
  var grid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', marginBottom: '12px' } });

  var soldeInitBlock = el('div', { class: 'treso-item', onclick: showEditSoldeInitial });
  soldeInitBlock.appendChild(el('div', { class: 'treso-item-value' }, EUR(TREASURY.soldeInitial)));
  soldeInitBlock.appendChild(el('div', { class: 'treso-item-label' }, '🏦 Solde Initial'));
  soldeInitBlock.appendChild(el('div', { class: 'treso-item-count' }, '✏️ Modifier'));
  grid.appendChild(soldeInitBlock);

  var autoBlock = el('div', { class: 'treso-item' });
  autoBlock.appendChild(el('div', { class: 'treso-item-value', style: { color: data.autonomieMois >= 6 ? 'var(--success)' : data.autonomieMois >= 3 ? 'var(--warning)' : 'var(--danger)' } }, data.autonomieMois + ' mois'));
  autoBlock.appendChild(el('div', { class: 'treso-item-label' }, '⏱️ Autonomie'));
  autoBlock.appendChild(el('div', { class: 'treso-item-count' }, 'Sans nouveau CA'));
  grid.appendChild(autoBlock);

  container.appendChild(grid);
}

// V72: Calculer projection salaire pour chaque mois
function computeSalaireProjections(months, data) {
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var projections = [];

  // Calcul cumulatif simulé pour projection
  var runningCash = TREASURY.soldeInitial || 0;

  months.forEach(function(m) {
    var monthInfo = data.monthsData ? data.monthsData[m] : null;
    var salaire = 0;

    if (m <= nowYm && monthInfo) {
      // Mois passé ou en cours: salaire réellement versé
      salaire = monthInfo.salaires || 0;
      runningCash += (monthInfo.encaisse || 0) - (monthInfo.charges || 0) - salaire;
    } else {
      // Mois futur: projection
      var futureCA = 0, futureCharges = 0;
      MISSIONS.forEach(function(mis) {
        if (!mis.lignes) return;
        mis.lignes.forEach(function(l) {
          if (l.ym !== m) return;
          var jours = Math.max(0, (l.joursPrevus || 0) - (l.conges || 0));
          futureCA += jours * mis.tjm;
          var rate = getUrssafRate(m);
          futureCharges += Math.round(jours * mis.tjm * (rate + LEGAL.cfp));
        });
      });

      runningCash += futureCA - futureCharges;
      // Projection: on peut verser 70% du cash restant
      salaire = Math.max(0, Math.round(runningCash * 0.7 / 100) * 100);
      runningCash -= salaire;
    }

    projections.push({ ym: m, salaire: salaire });
  });

  return projections;
}

// V72: Données financières d'un mois spécifique
function getMonthFinancialData(monthYm, data) {
  var monthInfo = data.monthsData ? data.monthsData[monthYm] : {};
  var caHT = monthInfo ? monthInfo.encaisse || 0 : 0;
  var charges = monthInfo ? monthInfo.charges || 0 : 0;
  var salaires = monthInfo ? monthInfo.salaires || 0 : 0;

  // Provisions du mois
  var provisions = 0;
  if (data.detailChargesAPayer) {
    data.detailChargesAPayer.forEach(function(c) {
      if (c.mois === monthYm) provisions += c.montant;
    });
  }

  // Salaire recommandé = cash dispo après charges - marge sécurité
  var disponible = caHT - charges - provisions;
  var salaireReco = Math.max(0, Math.round(disponible * 0.8 / 100) * 100);

  return { caHT: caHT, charges: charges, provisions: provisions, salaires: salaires, salaireReco: salaireReco };
}

// V72: Récupérer les charges d'un mois spécifique
function getChargesForMonth(monthYm, data) {
  var charges = [];
  if (data.detailChargesAPayer) {
    data.detailChargesAPayer.forEach(function(c) {
      if (c.mois === monthYm) charges.push(c);
    });
  }
  if (data.detailChargesPayees) {
    data.detailChargesPayees.forEach(function(c) {
      if (c.mois === monthYm) charges.push(c);
    });
  }
  return charges;
}

function renderParams(container) {
  renderAdmin(container);
}

function renderDashboard(container) {
  var data = compute();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var months = getPeriodMonths();

  // V51: Sous-onglets dashboard
  renderDashboardSubTabs(container);

  // Afficher le contenu selon le sous-onglet actif
  if (DASHBOARD_SUB === 'charges') {
    renderChargesSubTab(container, data);
    return;
  }
  if (DASHBOARD_SUB === 'analyse') {
    renderAnalyseSubTab(container, data, months);
    return;
  }
  // Sinon: Accueil (défaut)

  // ═══════════════════════════════════════════════════════════════════════════
  // V49 - NOUVEL ORDRE ERGONOMIQUE
  // 1. URGENCES (ce qui nécessite une action immédiate)
  // 2. PERFORMANCE (combien je gagne)
  // 3. TRÉSORERIE (combien j'ai)
  // ═══════════════════════════════════════════════════════════════════════════

  // ═══════════════════════════════════════════════════════════════════════════
  // V51 - DASHBOARD ACCUEIL SIMPLIFIÉ
  // 1. TRÉSORERIE (Hero)
  // 2. À FAIRE (Actions urgentes + Timeline)
  // 3. CA ANNUEL (avec plafond micro)
  // 4. PROJECTION AUTONOMIE
  // ═══════════════════════════════════════════════════════════════════════════

  // 1. MA TRÉSORERIE (Hero)
  renderDashboardHero(container, data);

  // 2. À FAIRE (Actions urgentes + Timeline jalons)
  container.appendChild(SectionTitle('⚡', 'À Faire'));
  renderActionsWidget(container);
  renderLegalTimeline(container);

  // 3. CA ANNUEL avec plafond micro-entrepreneur
  renderCAPlafondWidget(container);

  // 4. PROJECTION AUTONOMIE
  renderProjectionAutonomie(container);

  // Insights (conseils contextuels)
  renderInsights(container);

  // V51: Dashboard Accueil simplifié - pas de sections PERFORMANCE/TRÉSORERIE ici
  // Ces informations sont disponibles dans les sous-onglets Analyse et dans l'onglet Trésorerie
}

function drawMainChart() {
  if (typeof Chart === 'undefined') { console.error('Chart.js not loaded'); return; }
  var canvas = $('#mainChart');
  if (!canvas || !canvas.getContext) { console.error('mainChart canvas not found'); return; }
  var ctx = canvas.getContext('2d');
  if (!ctx) { console.error('mainChart context failed'); return; }
  if (mainChart) { mainChart.destroy(); mainChart = null; }
  if (!COMPUTED || !COMPUTED.monthsData) { COMPUTED = compute(); }

  var months = getPeriodMonths();
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  var labels = months.map(fmtMonthShort);
  var dataPrev = [], dataReal = [], dataEnc = [], dataAEnc = [], dataOff = [];
  var cumP = 0, cumR = 0, cumE = 0, cumA = 0;
  
  months.forEach(function(m) {
    var md = COMPUTED.monthsData[m] || {};
    var wd = COMPUTED.workedDays[m] || {};
    var isFuture = m > nowYm;
    var hasReal = (md.real || 0) > 0;
    // Utiliser les valeurs HT : real et prev sont déjà en HT, encHT pour l'encaissé
    var encHT = md.encHT || 0;
    var hasEnc = encHT > 0;
    
    // Calculer le "à encaisser HT" pour ce mois à partir des factures
    var aEncHT = 0;
    if (isFuture) {
      COMPUTED.facturesAEncaisser.forEach(function(f) {
        if (f.paymentMonth === m) {
          aEncHT += f.ht || 0;
        }
      });
    }
    
    if (SHOW_CUMUL) { 
      cumP += md.prev || 0; 
      cumR += md.real || 0; 
      cumE += encHT; 
      if (isFuture) cumA += aEncHT;
      
      // Prévu: masquer si on a des données réalisées cumulées
      dataPrev.push(cumR > 0 ? null : cumP); 
      dataReal.push(cumR); 
      dataEnc.push(cumE); 
      // Projection: seulement pour mois futurs sans encaissé
      dataAEnc.push(isFuture && cumA > 0 ? cumE + cumA : null);
    } else { 
      // Prévu: masquer si on a du réalisé ce mois
      dataPrev.push(hasReal ? null : (md.prev || 0)); 
      dataReal.push(md.real || 0); 
      dataEnc.push(encHT); 
      // Projection: seulement pour mois futurs
      dataAEnc.push(isFuture ? encHT + aEncHT : null);
    }
    dataOff.push(wd.conges || 0);
  });
  
  mainChart = new Chart(ctx, {
    data: {
      labels: labels,
      datasets: [
        { type: 'bar', label: 'Congés', data: dataOff, backgroundColor: 'rgba(251,191,36,0.4)', borderColor: '#f59e0b', borderWidth: 1, borderRadius: 2, yAxisID: 'y1', barPercentage: 0.25 },
        { type: 'line', label: 'Prévu', data: dataPrev, borderColor: '#a78bfa', borderWidth: 1.5, borderDash: [6, 3], tension: 0.3, pointRadius: 2, pointBackgroundColor: '#a78bfa', spanGaps: false, yAxisID: 'y' },
        { type: 'line', label: 'Réalisé', data: dataReal, borderColor: '#22d3ee', borderWidth: 2, fill: false, tension: 0.3, pointRadius: 2, pointBackgroundColor: '#22d3ee', yAxisID: 'y' },
        { type: 'line', label: 'Encaissé', data: dataEnc, borderColor: '#34d399', borderWidth: 2, tension: 0.3, pointRadius: 2, pointBackgroundColor: '#34d399', yAxisID: 'y' },
        { type: 'line', label: 'Proj. Enc.', data: dataAEnc, borderColor: '#71717a', borderWidth: 1.5, borderDash: [3, 3], tension: 0.3, pointRadius: 2, pointBackgroundColor: '#71717a', spanGaps: true, yAxisID: 'y' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      onClick: function(e, els) { if (els.length) showMonthCongesModal(months[els[0].index]); },
      plugins: { legend: { position: 'top', align: 'end', labels: { color: '#a1a1aa', boxWidth: 8, padding: 6, font: { size: 9 } } } },
      scales: {
        x: { ticks: { color: '#71717a', font: { size: 10 } }, grid: { display: false } },
        y: { position: 'right', ticks: { color: '#71717a', font: { size: 9 }, callback: function(v) { return v >= 1000 ? (v/1000) + 'k€' : v + '€'; } }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y1: { position: 'left', max: Math.max.apply(null, dataOff) * 3 || 10, ticks: { color: '#f59e0b', font: { size: 9 }, callback: function(v) { return v + 'j'; } }, grid: { display: false } }
      }
    }
  });
}

function drawSoldeChart() {
  if (typeof Chart === 'undefined') { console.error('Chart.js not loaded'); return; }
  var canvas = $('#soldeChart');
  if (!canvas || !canvas.getContext) { console.error('soldeChart canvas not found'); return; }
  var ctx = canvas.getContext('2d');
  if (!ctx) { console.error('soldeChart context failed'); return; }
  if (soldeChart) { soldeChart.destroy(); soldeChart = null; }
  if (!COMPUTED || !COMPUTED.monthsData) { COMPUTED = compute(); }
  
  var months = getPeriodMonths();
  var labels = months.map(fmtMonthShort);
  var dataSolde = [], dataSalaires = [], dataSoldeProjection = [], dataSalairesProjection = [], dataCashDispoProj = [];
  var nowYm = ym(TODAY.getFullYear(), TODAY.getMonth());
  
  // Calculer le dernier solde/cash connu pour les projections
  var lastKnownSolde = COMPUTED.soldeAbsolu || 0;
  var lastKnownCash = COMPUTED.cashDispoAbsolu || 0;
  var lastKnownProvisions = COMPUTED.provisionsAbsolues || 0;
  
  // Calculer les CA futurs connus (basés sur les factures à encaisser)
  var futureCAByMonth = {};
  var futureChargesByMonth = {};
  COMPUTED.facturesAEncaisser.forEach(function(f) {
    var paymentMonth = f.paymentMonth;
    if (paymentMonth > nowYm) {
      futureCAByMonth[paymentMonth] = (futureCAByMonth[paymentMonth] || 0) + f.ttc;
      // Calculer les charges associées (URSSAF + CFP + TVA si applicable)
      var rate = getUrssafRate(paymentMonth);
      var charges = Math.round(f.ht * (rate + LEGAL.cfp));
      if (f.tva > 0) charges += f.tva;
      if (COMPANY.prelevementLiberatoire) charges += Math.round(f.ht * LEGAL.impLib);
      futureChargesByMonth[paymentMonth] = (futureChargesByMonth[paymentMonth] || 0) + charges;
    }
  });
  
  // Variables pour simulation progressive
  var projSolde = lastKnownSolde;
  var projCashDispo = lastKnownCash;
  var projProvisions = lastKnownProvisions;
  var RESERVE_MIN = 150; // Garder 150€ minimum sur le compte
  
  months.forEach(function(m) {
    var md = COMPUTED.monthsData[m];
    var isFuture = m > nowYm;
    
    if (isFuture) {
      // Mois futur: projection basée sur le CA connu
      dataSolde.push(null);
      dataSalaires.push(null);
      
      // CA du mois (encaissements prévus)
      var caMonth = futureCAByMonth[m] || 0;
      var chargesMonth = futureChargesByMonth[m] || 0;
      
      // Mettre à jour le solde projeté
      projSolde += caMonth;
      projProvisions += chargesMonth;
      
      // Calculer le cash dispo projeté
      projCashDispo = projSolde - projProvisions;
      
      // Règle de versement de salaire : garder 150€, verser le reste
      var salaireVersable = Math.max(0, projCashDispo - RESERVE_MIN);
      salaireVersable = Math.floor(salaireVersable / 100) * 100; // Arrondir aux 100€
      
      // Déduire le salaire du solde
      projSolde -= salaireVersable;
      projCashDispo = projSolde - projProvisions;
      
      // Stocker les projections
      dataSoldeProjection.push(SHOW_CASH_DISPO ? projCashDispo : projSolde);
      dataSalairesProjection.push(salaireVersable);
      dataCashDispoProj.push(projCashDispo);
    } else {
      // Mois passé ou actuel: données réelles
      dataSolde.push(md ? (SHOW_CASH_DISPO ? md.cashDispo : md.solde) : 0);
      dataSalaires.push(md ? md.salaires : 0);
      dataSoldeProjection.push(null);
      dataSalairesProjection.push(null);
      dataCashDispoProj.push(null);
    }
  });
  
  // Plugin pour afficher les montants sur les barres
  var dataLabelsPlugin = {
    id: 'dataLabelsPlugin',
    afterDatasetsDraw: function(chart) {
      var ctx = chart.ctx;
      chart.data.datasets.forEach(function(dataset, i) {
        if (dataset.type !== 'bar') return;
        var meta = chart.getDatasetMeta(i);
        var isProjection = i === 1; // dataset projection
        meta.data.forEach(function(bar, index) {
          var value = dataset.data[index];
          if (value === null || value === 0) return;
          var label = value >= 1000 ? Math.round(value/1000) + 'k' : Math.round(value);
          ctx.save();
          if (isProjection) {
            ctx.fillStyle = 'rgba(168,85,247,0.8)';
          } else {
            ctx.fillStyle = value >= 0 ? '#10b981' : '#f87171';
          }
          ctx.font = 'bold 9px system-ui';
          ctx.textAlign = 'center';
          ctx.textBaseline = value >= 0 ? 'bottom' : 'top';
          var y = value >= 0 ? bar.y - 4 : bar.y + 4;
          ctx.fillText(label + '€', bar.x, y);
          ctx.restore();
        });
      });
      
      // Afficher "Moy: X€" sur la ligne moyenne
      var moyDataset = chart.data.datasets[4];
      if (moyDataset && COMPUTED.salaireMoyen > 0) {
        var moyMeta = chart.getDatasetMeta(4);
        var lastPoint = moyMeta.data[moyMeta.data.length - 1];
        if (lastPoint) {
          ctx.save();
          ctx.fillStyle = 'rgba(34,211,238,0.8)';
          ctx.font = 'bold 9px system-ui';
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          var moyLabel = 'Moy: ' + (COMPUTED.salaireMoyen >= 1000 ? Math.round(COMPUTED.salaireMoyen/1000) + 'k€' : COMPUTED.salaireMoyen + '€');
          ctx.fillText(moyLabel, lastPoint.x + 5, lastPoint.y);
          ctx.restore();
        }
      }
    }
  };
  
  soldeChart = new Chart(ctx, {
    data: {
      labels: labels,
      datasets: [
        { type: 'bar', label: SHOW_CASH_DISPO ? 'Cash Dispo' : 'Solde', data: dataSolde, backgroundColor: dataSolde.map(function(v) { return v === null ? 'transparent' : (v >= 0 ? 'rgba(16,185,129,0.6)' : 'rgba(248,113,113,0.6)'); }), borderRadius: 3, yAxisID: 'y' },
        { type: 'bar', label: 'Projection', data: dataSoldeProjection, backgroundColor: 'rgba(168,85,247,0.3)', borderColor: 'rgba(168,85,247,0.6)', borderWidth: 1, borderRadius: 3, yAxisID: 'y' },
        { type: 'line', label: 'Salaires', data: dataSalaires, borderColor: '#22d3ee', borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#22d3ee', fill: false, yAxisID: 'y1', spanGaps: false },
        { type: 'line', label: 'Sal. Proj.', data: dataSalairesProjection, borderColor: 'rgba(34,211,238,0.4)', borderWidth: 2, borderDash: [4, 4], tension: 0.3, pointRadius: 2, pointBackgroundColor: 'rgba(34,211,238,0.4)', fill: false, yAxisID: 'y1', spanGaps: false },
        { type: 'line', label: 'Moy', data: months.map(function() { return COMPUTED.salaireMoyen || 0; }), borderColor: 'rgba(34,211,238,0.5)', borderWidth: 1.5, borderDash: [4, 4], pointRadius: 0, yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      onClick: function(e, els) { if (els.length && els[0].datasetIndex === 0) showMonthDetail(months[els[0].index]); },
      plugins: { legend: { position: 'top', align: 'end', labels: { color: '#a1a1aa', boxWidth: 8, padding: 6, font: { size: 9 } } } },
      scales: {
        x: { ticks: { color: '#71717a', font: { size: 10 } }, grid: { display: false } },
        y: { position: 'left', ticks: { color: '#71717a', font: { size: 10 }, callback: function(v) { return v >= 1000 ? (v/1000) + 'k€' : v + '€'; } }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y1: { position: 'right', ticks: { color: '#22d3ee', font: { size: 9 }, callback: function(v) { return v >= 1000 ? (v/1000) + 'k€' : v + '€'; } }, grid: { display: false } }
      }
    },
    plugins: [dataLabelsPlugin]
  });
}

function renderMissions(container) {
  var data = compute();
  
  var header = el('div', { class: 'page-header' });
  header.appendChild(el('h2', { class: 'page-title' }, '💼 Missions'));
  container.appendChild(header);
  
  if (MISSIONS.length === 0) {
    container.appendChild(el('div', { class: 'empty-state' }, [el('div', { class: 'empty-icon' }, '💼'), el('div', { class: 'empty-title' }, 'Aucune mission'), el('div', { class: 'empty-text' }, 'Ajoute ta première mission pour commencer'), el('button', { class: 'btn btn-success', onclick: showMissionModal }, '+ Nouvelle Mission')]));
    return;
  }
  
  MISSIONS.forEach(function(m) {
    var now = localISO(TODAY);
    var status = m.fin < now ? 'ended' : m.debut > now ? 'upcoming' : 'active';
    var statusLabel = status === 'active' ? 'En cours' : status === 'upcoming' ? 'À venir' : 'Terminée';
    
    var totalJours = 0, totalCA = 0, facturesPayees = 0, facturesTotal = 0, facturesRetard = 0, facturesEnvoyees = 0, totalCharges = 0;
    if (m.lignes) m.lignes.forEach(function(l) {
      if (isInPeriod(l.ym)) {
        var jours = l.joursReels || 0;
        totalJours += jours;
        totalCA += jours * m.tjm;
        // Charges sociales/fiscales (sans TVA car elle n'est pas une charge sur le bénéfice)
        var rate = getUrssafRate(l.ym);
        var chargesCA = jours * m.tjm * (rate + LEGAL.cfp + (COMPANY.prelevementLiberatoire ? LEGAL.impLib : 0));
        totalCharges += chargesCA;
      }
    });
    if (m.factures) m.factures.forEach(function(f) { 
      if (isInPeriod(f.mois) && f.jours > 0) { 
        facturesTotal++; 
        if (f.status === 'payée') facturesPayees++; 
        else if (f.status === 'envoyée') {
          facturesEnvoyees++;
          var paymentDate = getPaymentDate(f.mois, m.delaiPaiement, m.jourPaiement);
          if (TODAY > paymentDate) facturesRetard++;
        }
      } 
    });
    
    // Bénéfice = CA HT - Charges (URSSAF + CFP + IR)
    var benefice = totalCA - totalCharges;
    var margePct = totalCA > 0 ? benefice / totalCA : 0;
    var progress = facturesTotal > 0 ? facturesPayees / facturesTotal : 0;
    
    // Statut factures
    var factureStatus = '';
    var factureStatusColor = 'var(--text-muted)';
    if (facturesRetard > 0) { factureStatus = '⚠️ ' + facturesRetard + ' en retard'; factureStatusColor = 'var(--danger)'; }
    else if (facturesEnvoyees > 0) { factureStatus = '📤 ' + facturesEnvoyees + ' en attente'; factureStatusColor = 'var(--warning)'; }
    else if (facturesPayees === facturesTotal && facturesTotal > 0) { factureStatus = '✅ Tout payé'; factureStatusColor = 'var(--success)'; }
    
    var card = el('div', { class: 'mission-card', onclick: function() { showMissionModal(m); } });
    var cardHeader = el('div', { class: 'mission-header' });
    cardHeader.appendChild(el('div', {}, [el('div', { class: 'mission-client' }, m.client), el('div', { class: 'mission-titre' }, m.titre || m.site || '')]));
    cardHeader.appendChild(el('div', { class: 'mission-status ' + status }, statusLabel));
    card.appendChild(cardHeader);
    
    card.appendChild(el('div', { class: 'mission-dates' }, '📅 ' + fmtLong(m.debut) + ' → ' + fmtLong(m.fin)));
    
    var stats = el('div', { class: 'mission-stats' });
    stats.appendChild(el('div', { class: 'mission-stat' }, [el('div', { class: 'mission-stat-value' }, totalJours + 'j'), el('div', { class: 'mission-stat-label' }, 'Jours')]));
    stats.appendChild(el('div', { class: 'mission-stat' }, [el('div', { class: 'mission-stat-value text-info' }, EUR(m.tjm)), el('div', { class: 'mission-stat-label' }, 'TJM')]));
    stats.appendChild(el('div', { class: 'mission-stat' }, [el('div', { class: 'mission-stat-value text-success' }, EUR(totalCA)), el('div', { class: 'mission-stat-label' }, 'CA')]));
    stats.appendChild(el('div', { class: 'mission-stat' }, [el('div', { class: 'mission-stat-value', style: { color: benefice >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(benefice)), el('div', { class: 'mission-stat-label' }, 'Bénéfice')]));
    stats.appendChild(el('div', { class: 'mission-stat' }, [el('div', { class: 'mission-stat-value', style: { color: margePct >= 0.5 ? 'var(--success)' : 'var(--warning)' } }, PCT(margePct)), el('div', { class: 'mission-stat-label' }, 'Marge')]));
    card.appendChild(stats);
    
    var progressDiv = el('div', { class: 'mission-progress' });
    var progressBar = el('div', { class: 'mission-progress-bar' });
    progressBar.appendChild(el('div', { class: 'mission-progress-fill', style: { width: (progress * 100) + '%' } }));
    progressDiv.appendChild(progressBar);
    card.appendChild(progressDiv);
    
    // Ligne avec statut factures
    var factureInfo = el('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: '10px', marginTop: '4px' } });
    factureInfo.appendChild(el('span', { style: { color: 'var(--text-muted)' } }, facturesPayees + '/' + facturesTotal + ' factures payées'));
    if (factureStatus) factureInfo.appendChild(el('span', { style: { color: factureStatusColor, fontWeight: '600' } }, factureStatus));
    card.appendChild(factureInfo);
    
    container.appendChild(card);
  });
  
  container.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '16px' }, onclick: showMissionModal }, '+ Nouvelle Mission'));
}

function renderFactures(container) {
  var data = compute();
  container.appendChild(el('h2', { style: { fontSize: '20px', fontWeight: '800', marginBottom: '16px' } }, '📄 Facturation'));

  // V51: Section Indicateurs (KPIs facturation)
  var indicatorsDiv = el('div', { class: 'card', style: { marginBottom: '16px', padding: '16px' } });
  indicatorsDiv.appendChild(el('div', { class: 'card-title', style: { marginBottom: '12px' } }, '📊 Indicateurs'));

  var kpiGrid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' } });

  // KPI: À créer
  var kpiACreer = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiACreer.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: 'var(--text-muted)' } }, String(data.facturesStats.brouillon)));
  kpiACreer.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'À créer'));
  kpiGrid.appendChild(kpiACreer);

  // KPI: Envoyées
  var kpiEnvoyees = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiEnvoyees.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: 'var(--info)' } }, String(data.facturesStats.envoyees)));
  kpiEnvoyees.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Envoyées'));
  kpiGrid.appendChild(kpiEnvoyees);

  // KPI: En retard
  var kpiRetard = el('div', { style: { textAlign: 'center', padding: '12px', background: data.facturesStats.retard > 0 ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiRetard.appendChild(el('div', { style: { fontSize: '24px', fontWeight: '800', color: data.facturesStats.retard > 0 ? 'var(--danger)' : 'var(--text-muted)' } }, String(data.facturesStats.retard) + (data.facturesStats.retard > 0 ? ' 🔴' : '')));
  kpiRetard.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'En retard'));
  kpiGrid.appendChild(kpiRetard);

  // KPI: Encaissé
  var kpiEncaisse = el('div', { style: { textAlign: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } });
  kpiEncaisse.appendChild(el('div', { style: { fontSize: '20px', fontWeight: '800', color: 'var(--success)' } }, EUR(data.caEnc)));
  kpiEncaisse.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Encaissé'));
  kpiGrid.appendChild(kpiEncaisse);

  indicatorsDiv.appendChild(kpiGrid);

  // Stats additionnelles
  var statsDiv = el('div', { style: { display: 'flex', justifyContent: 'space-between', marginTop: '12px', fontSize: '11px', color: 'var(--text-muted)' } });
  var avgDelai = Math.round(data.facturesStats.delaiMoyen || 0);
  statsDiv.appendChild(el('span', {}, 'Délai moyen encaissement: ' + avgDelai + ' jours'));
  var tauxRetard = data.facturesStats.payees > 0 ? Math.round((data.facturesStats.retard / (data.facturesStats.payees + data.facturesStats.envoyees + data.facturesStats.retard)) * 100) : 0;
  statsDiv.appendChild(el('span', {}, 'Taux de retard: ' + tauxRetard + '%'));
  indicatorsDiv.appendChild(statsDiv);

  container.appendChild(indicatorsDiv);

  // V61: Validation numérotation factures (Art. L441-9)
  var numValidation = validateInvoiceNumbering(PERIOD.year || TODAY.getFullYear());
  if (numValidation.total > 0 && !numValidation.valid) {
    var alertDiv = el('div', { class: 'card', style: { marginBottom: '16px', padding: '14px', background: 'rgba(239, 68, 68, 0.08)', border: '1px solid rgba(239, 68, 68, 0.3)' } });
    alertDiv.appendChild(el('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' } }, [
      el('span', { style: { fontSize: '16px' } }, '⚠️'),
      el('span', { style: { fontWeight: '700', fontSize: '13px', color: 'var(--danger)' } }, 'Anomalie numérotation factures')
    ]));
    if (numValidation.gaps.length > 0) {
      alertDiv.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' } }, 'Numéros manquants: ' + numValidation.gaps.join(', ')));
      alertDiv.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } }, 'Art. L441-9: La numérotation doit être séquentielle et sans trous.'));
    }
    if (numValidation.duplicates.length > 0) {
      alertDiv.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' } }, 'Doublons: ' + numValidation.duplicates.map(function(d) { return d.numero; }).join(', ')));
    }
    alertDiv.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '6px' } }, 'Séquence: ' + numValidation.first + ' → ' + numValidation.last + ' (' + numValidation.total + ' factures)'));
    container.appendChild(alertDiv);
  } else if (numValidation.total > 0) {
    var okDiv = el('div', { style: { display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '12px', fontSize: '11px', color: 'var(--success)' } });
    okDiv.appendChild(el('span', {}, '✅'));
    okDiv.appendChild(el('span', {}, 'Numérotation conforme: ' + numValidation.first + ' → ' + numValidation.last + ' (' + numValidation.total + ' factures, aucun trou)'));
    container.appendChild(okDiv);
  }

  // V51: Section "Mes Contrats" (ex-Missions)
  var contratsDiv = el('div', { class: 'card', style: { marginBottom: '16px', padding: '16px' } });
  var contratsHeader = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' } });
  contratsHeader.appendChild(el('div', { class: 'card-title', style: { margin: 0 } }, '🏢 Mes Contrats'));
  contratsHeader.appendChild(el('button', { class: 'btn btn-sm', onclick: showMissionModal }, '+ Nouveau'));
  contratsDiv.appendChild(contratsHeader);

  if (MISSIONS.length === 0) {
    contratsDiv.appendChild(el('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-muted)', fontSize: '12px' } }, 'Aucun contrat. Cliquez sur "+ Nouveau" pour créer votre premier contrat.'));
  } else {
    MISSIONS.forEach(function(m) {
      // V56: Utiliser m.fin (pas m.dateFin) - cohérent avec la sauvegarde
      var isActive = !m.fin || new Date(m.fin) >= TODAY;
      var contratRow = el('div', { style: {
        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
        padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '8px',
        cursor: 'pointer', opacity: isActive ? 1 : 0.6
      }, onclick: function() { showEditMissionModal(m); } });

      var contratInfo = el('div', {});
      contratInfo.appendChild(el('div', { style: { fontWeight: '600' } }, m.client || 'Sans client'));
      contratInfo.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } },
        EUR(m.tjm || 0) + '/j · ' + (m.debut ? fmtMonthShort(m.debut.substring(0, 7)) : '-') +
        (m.fin ? ' → ' + fmtMonthShort(m.fin.substring(0, 7)) : ' → En cours')));
      contratRow.appendChild(contratInfo);

      var badge = el('span', { style: {
        padding: '4px 8px', borderRadius: '4px', fontSize: '10px', fontWeight: '600',
        background: isActive ? 'rgba(34, 197, 94, 0.1)' : 'var(--bg-secondary)',
        color: isActive ? 'var(--success)' : 'var(--text-muted)'
      }}, isActive ? 'En cours' : 'Terminé');
      contratRow.appendChild(badge);

      contratsDiv.appendChild(contratRow);
    });
  }
  container.appendChild(contratsDiv);

  // Section Factures
  container.appendChild(el('div', { class: 'card-title', style: { marginBottom: '12px' } }, '📄 Factures'));

  // Barre de recherche (B17)
  var searchBar = el('div', { class: 'search-filter-bar' });
  var searchBox = el('div', { class: 'search-box' });
  var searchInput = el('input', { 
    type: 'text', 
    placeholder: 'Rechercher par client, mois...', 
    value: SEARCH_STATE.factures.query,
    oninput: function(e) {
      SEARCH_STATE.factures.query = e.target.value;
      clearBtn.classList.toggle('visible', e.target.value.length > 0);
      render();
    }
  });
  var clearBtn = el('button', { 
    class: 'clear-search' + (SEARCH_STATE.factures.query ? ' visible' : ''), 
    onclick: function() { 
      SEARCH_STATE.factures.query = ''; 
      searchInput.value = ''; 
      clearBtn.classList.remove('visible');
      render(); 
    } 
  }, '×');
  searchBox.appendChild(searchInput);
  searchBox.appendChild(clearBtn);
  searchBar.appendChild(searchBox);
  container.appendChild(searchBar);
  
  // V51: Chips de filtre par statut (renommés selon cahier des charges)
  var chips = el('div', { class: 'filter-chips', style: { marginBottom: '16px' } });
  var totalFactures = data.facturesStats.brouillon + data.facturesStats.envoyees + data.facturesStats.payees;
  var filters = [
    { key: 'all', label: 'Toutes', count: totalFactures },
    { key: 'brouillon', label: 'À créer', count: data.facturesStats.brouillon },
    { key: 'envoyées', label: 'Envoyées', count: data.facturesStats.envoyees },
    { key: 'retard', label: 'En retard', count: data.facturesStats.retard },
    { key: 'payées', label: 'Encaissé', count: data.facturesStats.payees }
  ];
  filters.forEach(function(f) {
    var chip = el('div', { class: 'filter-chip' + (FACTURE_FILTER === f.key ? ' active' : ''), onclick: function() { FACTURE_FILTER = f.key; render(); } });
    chip.appendChild(document.createTextNode(f.label));
    chip.appendChild(el('span', { class: 'count' }, String(f.count)));
    chips.appendChild(chip);
  });
  container.appendChild(chips);
  
  var factures = [];
  MISSIONS.forEach(function(m) {
    if (m.factures) m.factures.forEach(function(f) {
      if (!isInPeriod(f.mois) || f.jours <= 0) return;
      f.paymentMonth = getPaymentMonth(f.mois, m.delaiPaiement, m.jourPaiement);
      var paymentDate = getPaymentDate(f.mois, m.delaiPaiement, m.jourPaiement);
      f.paymentDate = paymentDate;
      // RETARD: facture envoyée ET date paiement dépassée
      f.isLate = f.status === 'envoyée' && TODAY > paymentDate;
      factures.push(f);
    });
  });
  
  // Filtre par statut
  if (FACTURE_FILTER !== 'all') {
    factures = factures.filter(function(f) {
      if (FACTURE_FILTER === 'retard') return f.isLate;
      if (FACTURE_FILTER === 'envoyées') return f.status === 'envoyée';
      if (FACTURE_FILTER === 'payées') return f.status === 'payée';
      if (FACTURE_FILTER === 'brouillon') return f.status === 'brouillon';
      return true;
    });
  }
  
  // Filtre par recherche textuelle (B17)
  var searchQuery = SEARCH_STATE.factures.query.toLowerCase().trim();
  if (searchQuery) {
    factures = factures.filter(function(f) {
      return f.client.toLowerCase().includes(searchQuery) ||
             f.mois.includes(searchQuery) ||
             (f.numero && f.numero.toLowerCase().includes(searchQuery)) ||
             fmtMonth(f.mois).toLowerCase().includes(searchQuery);
    });
  }
  
  factures.sort(function(a, b) { return b.mois.localeCompare(a.mois); });
  
  // Afficher nombre de résultats si recherche active
  if (searchQuery) {
    container.appendChild(el('div', { class: 'search-results-info' }, [
      el('span', { class: 'count' }, String(factures.length)),
      document.createTextNode(' résultat(s) pour "' + SEARCH_STATE.factures.query + '"')
    ]));
  }
  
  if (factures.length === 0) {
    var emptyDiv = el('div', { class: 'no-results' });
    emptyDiv.appendChild(el('div', { class: 'no-results-icon' }, searchQuery ? '🔍' : '📄'));
    emptyDiv.appendChild(el('div', { class: 'no-results-title' }, searchQuery ? 'Aucun résultat' : 'Aucune facture'));
    emptyDiv.appendChild(el('div', { class: 'no-results-hint' }, searchQuery ? 'Essayez avec d\'autres termes' : 'Les factures apparaîtront quand tu saisiras des jours'));
    container.appendChild(emptyDiv);
    return;
  }
  
  factures.forEach(function(f) {
    // Badge combiné pour envoyée + retard
    var badgeClass, badgeText;
    if (f.status === 'payée') { badgeClass = 'badge-success'; badgeText = '✅ Payée'; }
    else if (f.isLate) { badgeClass = 'badge-late'; badgeText = '📤 Envoyée · ⚠️ RETARD'; }
    else if (f.status === 'envoyée') { badgeClass = 'badge-warning'; badgeText = '📤 Envoyée'; }
    else { badgeClass = 'badge-muted'; badgeText = '📝 Brouillon'; }
    
    // Highlight recherche si active
    var clientText = f.client + ' · ' + fmtMonthShort(f.mois);
    if (searchQuery && f.client.toLowerCase().includes(searchQuery)) {
      clientText = highlightText(f.client, searchQuery) + ' · ' + fmtMonthShort(f.mois);
    }
    
    var card = el('div', { class: 'facture-card', onclick: function() { showFactureModal(f); } });
    card.appendChild(el('div', { class: 'badge ' + badgeClass, style: { fontSize: '9px', whiteSpace: 'nowrap' } }, badgeText));
    var infoDiv = el('div', { class: 'facture-info' });
    var idDiv = el('div', { class: 'facture-id' });
    idDiv.innerHTML = clientText;
    infoDiv.appendChild(idDiv);
    infoDiv.appendChild(el('div', { class: 'facture-meta' }, f.jours + 'j · Paiement ' + fmtMonthShort(f.paymentMonth)));
    card.appendChild(infoDiv);
    card.appendChild(el('div', { class: 'facture-amount' }, [el('div', { class: 'facture-ht' }, EUR(f.ht)), f.tva > 0 ? el('div', { class: 'facture-tva' }, 'TVA ' + EUR(f.tva)) : null]));
    container.appendChild(card);
  });
}

function renderTresorerie(container) {
  var data = compute();
  
  // Header avec actions
  var header = el('div', { class: 'page-header' });
  header.appendChild(el('h2', { class: 'page-title' }, '🏦 Trésorerie'));
  var actions = el('div', { class: 'page-actions' });
  actions.appendChild(el('button', { class: 'btn btn-sm', onclick: showChargeModal }, '📋 Charge'));
  actions.appendChild(el('button', { class: 'btn btn-sm btn-success', onclick: function() { showSalaireModal(data.salaireReco); } }, '💸 Salaire'));
  header.appendChild(actions);
  container.appendChild(header);
  
  // SOLDE COMPTE en premier (ABSOLU)
  var soldeCard = el('div', { class: 'hero', style: { cursor: 'default' }, onclick: showCashDetail });
  var soldeMain = el('div', { class: 'hero-main' });
  soldeMain.appendChild(el('div', { class: 'hero-label' }, 'Solde Compte Pro'));
  soldeMain.appendChild(el('div', { class: 'hero-value ' + (data.soldeAbsolu >= 0 ? 'positive' : 'negative') }, EUR(data.soldeAbsolu)));
  soldeCard.appendChild(soldeMain);
  container.appendChild(soldeCard);
  
  // 4 blocs en grille
  var grid = el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '10px', marginBottom: '12px' } });
  
  // Solde Initial (éditable)
  var soldeInitBlock = el('div', { class: 'treso-item', onclick: function() { showEditSoldeInitial(); } });
  soldeInitBlock.appendChild(el('div', { class: 'treso-item-value' }, EUR(TREASURY.soldeInitial)));
  soldeInitBlock.appendChild(el('div', { class: 'treso-item-label' }, '🏦 Solde Initial'));
  soldeInitBlock.appendChild(el('div', { class: 'treso-item-count' }, '✏️ Modifier'));
  grid.appendChild(soldeInitBlock);
  
  // Encaissé
  var encBlock = el('div', { class: 'treso-item', onclick: function() { showDetailList('Factures Encaissées', data.detailEncaisse, 'success', function(i) { return i.client + ' · ' + fmtMonthShort(i.mois); }); } });
  encBlock.appendChild(el('div', { class: 'treso-item-value text-success' }, EUR(data.caEnc)));
  encBlock.appendChild(el('div', { class: 'treso-item-label' }, '💵 Encaissé TTC'));
  encBlock.appendChild(el('div', { class: 'treso-item-count' }, data.detailEncaisse.length + ' factures'));
  grid.appendChild(encBlock);
  
  // Charges Payées
  var chargesBlock = el('div', { class: 'treso-item', onclick: function() { showDetailList('Charges Payées', data.detailChargesPayees, 'danger', function(i) { return i.cat + (i.source ? ' · ' + i.source : ''); }); } });
  chargesBlock.appendChild(el('div', { class: 'treso-item-value text-danger' }, EUR(data.chargesPayees)));
  chargesBlock.appendChild(el('div', { class: 'treso-item-label' }, '📋 Charges Payées'));
  chargesBlock.appendChild(el('div', { class: 'treso-item-count' }, data.detailChargesPayees.length + ' lignes'));
  grid.appendChild(chargesBlock);
  
  // Salaires
  var salBlock = el('div', { class: 'treso-item', onclick: function() { showDetailList('Salaires Versés', data.detailSalaires, 'info', function(i) { return fmtMonth(i.mois); }); } });
  salBlock.appendChild(el('div', { class: 'treso-item-value text-info' }, EUR(data.salaires)));
  salBlock.appendChild(el('div', { class: 'treso-item-label' }, '💸 Salaires'));
  salBlock.appendChild(el('div', { class: 'treso-item-count' }, data.detailSalaires.length + ' versements'));
  grid.appendChild(salBlock);
  
  // V48: Intérêts Compte Pro - TOUJOURS AFFICHÉ (actif ou non)
  var totalInterets = TREASURY.rendementActif ? getTotalRendement() : 0;
  var interetsBlock = el('div', { class: 'treso-item', onclick: function() { 
    if (TREASURY.rendementActif) {
      showRendementDetail(); 
    } else {
      // Rediriger vers Admin pour activer
      toast('Active le rendement dans Admin > Trésorerie', 'info');
      VIEW = 'params';
      render();
    }
  } });
  if (TREASURY.rendementActif && totalInterets > 0) {
    interetsBlock.appendChild(el('div', { class: 'treso-item-value text-success' }, '+' + EUR(totalInterets)));
    interetsBlock.appendChild(el('div', { class: 'treso-item-label' }, '📈 Intérêts'));
    interetsBlock.appendChild(el('div', { class: 'treso-item-count' }, TREASURY.rendementTaux + '% brut/an'));
  } else if (TREASURY.rendementActif) {
    interetsBlock.appendChild(el('div', { class: 'treso-item-value text-muted' }, '0 €'));
    interetsBlock.appendChild(el('div', { class: 'treso-item-label' }, '📈 Intérêts'));
    interetsBlock.appendChild(el('div', { class: 'treso-item-count' }, 'En attente...'));
  } else {
    interetsBlock.style.border = '2px dashed var(--glass-border)';
    interetsBlock.style.background = 'transparent';
    interetsBlock.appendChild(el('div', { class: 'treso-item-value', style: { color: 'var(--text-muted)', fontSize: '14px' } }, '📈 Rendement'));
    interetsBlock.appendChild(el('div', { class: 'treso-item-label', style: { color: 'var(--accent)' } }, '⚙️ Activer'));
    interetsBlock.appendChild(el('div', { class: 'treso-item-count' }, 'Cliquer pour configurer'));
  }
  grid.appendChild(interetsBlock);
  
  container.appendChild(grid);
  
  // V48: CARD TRAÇABILITÉ DES INTÉRÊTS (si rendement actif)
  if (TREASURY.rendementActif && TREASURY.rendementHistorique && TREASURY.rendementHistorique.length > 0) {
    var interetsCard = el('div', { class: 'card', style: { background: 'linear-gradient(135deg, var(--success-glow), transparent)' } });
    var interetsHeader = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' } });
    interetsHeader.appendChild(el('div', { style: { fontWeight: '700' } }, '📈 Historique Intérêts Compte Pro'));
    interetsHeader.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', background: 'var(--bg-tertiary)', padding: '4px 8px', borderRadius: '12px' } }, TREASURY.rendementTaux + '% brut annuel'));
    interetsCard.appendChild(interetsHeader);
    
    // Tableau des 6 derniers mois
    var recentInterets = TREASURY.rendementHistorique.slice(-6).reverse();
    var table = el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '4px', fontSize: '11px' } });
    
    // En-têtes
    table.appendChild(el('div', { style: { fontWeight: '600', color: 'var(--text-muted)', padding: '4px' } }, 'Mois'));
    table.appendChild(el('div', { style: { fontWeight: '600', color: 'var(--text-muted)', padding: '4px', textAlign: 'right' } }, 'Solde moy.'));
    table.appendChild(el('div', { style: { fontWeight: '600', color: 'var(--text-muted)', padding: '4px', textAlign: 'right' } }, 'Intérêts'));
    
    // Lignes
    recentInterets.forEach(function(int, idx) {
      var bgColor = idx % 2 === 0 ? 'var(--bg-tertiary)' : 'transparent';
      table.appendChild(el('div', { style: { padding: '6px 4px', background: bgColor, borderRadius: idx % 2 === 0 ? '4px 0 0 4px' : '0' } }, fmtMonthShort(int.mois)));
      table.appendChild(el('div', { style: { padding: '6px 4px', background: bgColor, textAlign: 'right' } }, EUR(int.soldeMoyen)));
      table.appendChild(el('div', { style: { padding: '6px 4px', background: bgColor, textAlign: 'right', color: 'var(--success)', fontWeight: '600', borderRadius: idx % 2 === 0 ? '0 4px 4px 0' : '0' } }, '+' + EUR(int.montant)));
    });
    
    interetsCard.appendChild(table);
    
    // Total
    var totalRow = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '12px', paddingTop: '8px', borderTop: '1px solid var(--glass-border)' } });
    totalRow.appendChild(el('span', { style: { fontWeight: '700' } }, 'Total perçu (' + TREASURY.rendementHistorique.length + ' mois)'));
    totalRow.appendChild(el('span', { style: { fontWeight: '800', fontSize: '16px', color: 'var(--success)' } }, '+' + EUR(totalInterets)));
    interetsCard.appendChild(totalRow);
    
    // Note fiscale
    interetsCard.appendChild(el('div', { style: { marginTop: '8px', fontSize: '9px', color: 'var(--text-muted)' } }, '⚠️ Soumis au PFU 30% (12.8% IR + 17.2% PS)'));
    
    container.appendChild(interetsCard);
  }
  
  // Bloc PROVISIONS (ABSOLUES)
  var provCard = el('div', { class: 'card', onclick: showProvisionsDetail, style: { cursor: 'pointer' } });
  var provHeader = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' } });
  provHeader.appendChild(el('div', { style: { fontWeight: '700' } }, '📦 Provisions à Payer'));
  provHeader.appendChild(el('div', { class: 'text-provision', style: { fontWeight: '800', fontSize: '20px' } }, EUR(data.provisionsAbsolues)));
  provCard.appendChild(provHeader);
  
  // Aperçu par type
  var provPreview = el('div', { style: { display: 'flex', gap: '12px', flexWrap: 'wrap' } });
  Object.keys(data.provByType).forEach(function(cat) {
    provPreview.appendChild(el('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, cat + ': ' + EUR(data.provByType[cat])));
  });
  provCard.appendChild(provPreview);
  provCard.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginTop: '8px' } }, 'Cliquer pour détails et paiement rapide'));
  container.appendChild(provCard);
  
  // Résultat CASH DISPONIBLE (ABSOLU)
  var cashCard = el('div', { class: 'card', style: { background: data.cashDispoAbsolu >= 0 ? 'var(--success-glow)' : 'var(--danger-glow)' } });
  cashCard.appendChild(el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [el('span', { style: { fontWeight: '700', fontSize: '15px' } }, '= Cash Disponible'), el('span', { style: { fontWeight: '800', fontSize: '24px', color: data.cashDispoAbsolu >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(data.cashDispoAbsolu))]));
  cashCard.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' } }, 'Autonomie: ' + data.runway + ' mois'));
  container.appendChild(cashCard);
  
  // Graphique Salaires
  var chartCard = el('div', { class: 'card' });
  chartCard.appendChild(el('div', { class: 'card-title' }, [el('span', {}, '📊 Évolution Salaires'), el('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Moy: ' + EUR(data.salaireMoyen))]));
  chartCard.appendChild(el('div', { class: 'chart-container' }, [el('canvas', { id: 'tresoSalairesChart' })]));
  container.appendChild(chartCard);
  
  setTimeout(function() {
    var canvas = $('#tresoSalairesChart');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    if (!ctx) return;
    if (salairesChart) salairesChart.destroy();
    var months = getPeriodMonths();
    var labels = months.map(fmtMonthShort);
    var dataSal = months.map(function(m) { return data.monthsData[m] ? data.monthsData[m].salaires : 0; });
    salairesChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: [
        { label: 'Salaires', data: dataSal, backgroundColor: 'rgba(96,165,250,0.7)', borderRadius: 4 },
        { type: 'line', label: 'Moyenne', data: months.map(function() { return data.salaireMoyen; }), borderColor: 'rgba(96,165,250,0.4)', borderWidth: 2, borderDash: [5,5], pointRadius: 0 }
      ]},
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#71717a', font: { size: 10 } }, grid: { display: false } }, y: { ticks: { color: '#71717a', font: { size: 10 }, callback: function(v) { return v >= 1000 ? (v/1000) + 'k€' : v + '€'; } }, grid: { color: 'rgba(255,255,255,0.04)' } } } }
    });
  }, 50);
  
  // Historique des mouvements avec recherche/filtres (B17, B18)
  var mouvementsCard = el('div', { class: 'card', style: { marginTop: '16px' } });
  mouvementsCard.appendChild(el('div', { class: 'card-title' }, '📜 Historique des Mouvements'));
  
  // Barre de recherche et filtres
  var searchBar = el('div', { class: 'search-filter-bar', style: { marginTop: '12px' } });
  var searchBox = el('div', { class: 'search-box' });
  var searchInput = el('input', { 
    type: 'text', 
    placeholder: 'Rechercher...', 
    value: SEARCH_STATE.tresorerie.query,
    oninput: function(e) {
      SEARCH_STATE.tresorerie.query = e.target.value;
      clearBtn.classList.toggle('visible', e.target.value.length > 0);
      render();
    }
  });
  var clearBtn = el('button', { 
    class: 'clear-search' + (SEARCH_STATE.tresorerie.query ? ' visible' : ''), 
    onclick: function() { 
      SEARCH_STATE.tresorerie.query = ''; 
      searchInput.value = ''; 
      clearBtn.classList.remove('visible');
      render(); 
    } 
  }, '×');
  searchBox.appendChild(searchInput);
  searchBox.appendChild(clearBtn);
  searchBar.appendChild(searchBox);
  
  // Filtre par type
  var typeFilter = el('select', { 
    class: 'filter-dropdown',
    onchange: function(e) { SEARCH_STATE.tresorerie.type = e.target.value; render(); }
  });
  typeFilter.appendChild(el('option', { value: 'all', selected: SEARCH_STATE.tresorerie.type === 'all' }, 'Tous les types'));
  typeFilter.appendChild(el('option', { value: 'salaire', selected: SEARCH_STATE.tresorerie.type === 'salaire' }, '💸 Salaires'));
  typeFilter.appendChild(el('option', { value: 'charge', selected: SEARCH_STATE.tresorerie.type === 'charge' }, '📋 Charges'));
  typeFilter.appendChild(el('option', { value: 'encaissement', selected: SEARCH_STATE.tresorerie.type === 'encaissement' }, '💵 Encaissements'));
  searchBar.appendChild(typeFilter);
  
  mouvementsCard.appendChild(searchBar);
  
  // Collecter tous les mouvements
  var allMouvements = [];
  
  // Salaires
  data.detailSalaires.forEach(function(s) {
    allMouvements.push({ type: 'salaire', label: '💸 Salaire', detail: fmtMonth(s.mois), montant: -s.montant, date: s.mois + '-01', category: 'Salaire' });
  });
  
  // Charges payées
  data.detailChargesPayees.forEach(function(c) {
    allMouvements.push({ type: 'charge', label: '📋 ' + c.cat, detail: c.source || '', montant: -c.montant, date: c.mois + '-01', category: c.cat });
  });
  
  // Encaissements
  data.detailEncaisse.forEach(function(e) {
    allMouvements.push({ type: 'encaissement', label: '💵 ' + e.client, detail: fmtMonth(e.mois), montant: e.ht + (e.tva || 0), date: e.paymentMonth + '-01', category: 'Encaissement' });
  });
  
  // Tri par date décroissante
  allMouvements.sort(function(a, b) { return b.date.localeCompare(a.date); });
  
  // Filtrage
  var searchQuery = SEARCH_STATE.tresorerie.query.toLowerCase().trim();
  var typeFilterValue = SEARCH_STATE.tresorerie.type;
  
  var filteredMouvements = allMouvements.filter(function(m) {
    // Filtre par type
    if (typeFilterValue !== 'all' && m.type !== typeFilterValue) return false;
    // Filtre par recherche
    if (searchQuery) {
      return m.label.toLowerCase().includes(searchQuery) ||
             m.detail.toLowerCase().includes(searchQuery) ||
             m.category.toLowerCase().includes(searchQuery);
    }
    return true;
  });
  
  // Limiter à 20 mouvements pour la lisibilité
  var displayMouvements = filteredMouvements.slice(0, 20);
  
  // Afficher résultats
  if (searchQuery || typeFilterValue !== 'all') {
    mouvementsCard.appendChild(el('div', { class: 'search-results-info', style: { textAlign: 'left', padding: '8px 0' } }, [
      el('span', { class: 'count' }, String(filteredMouvements.length)),
      document.createTextNode(' mouvement(s) trouvé(s)')
    ]));
  }
  
  if (displayMouvements.length === 0) {
    var emptyDiv = el('div', { class: 'no-results', style: { padding: '20px' } });
    emptyDiv.appendChild(el('div', { class: 'no-results-icon' }, '📜'));
    emptyDiv.appendChild(el('div', { class: 'no-results-title' }, 'Aucun mouvement'));
    emptyDiv.appendChild(el('div', { class: 'no-results-hint' }, searchQuery ? 'Essayez d\'autres termes' : 'Les mouvements apparaîtront avec l\'activité'));
    mouvementsCard.appendChild(emptyDiv);
  } else {
    var mouvList = el('div', { style: { marginTop: '8px' } });
    displayMouvements.forEach(function(m) {
      var row = el('div', { class: 'detail-row', style: { padding: '10px 0', borderBottom: '1px solid var(--glass-border)' } });
      var left = el('div', { style: { flex: '1' } });
      var labelText = m.label;
      if (searchQuery && m.label.toLowerCase().includes(searchQuery)) {
        labelText = highlightText(m.label, searchQuery);
      }
      var labelEl = el('div', { style: { fontWeight: '600', fontSize: '13px' } });
      labelEl.innerHTML = labelText;
      left.appendChild(labelEl);
      left.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, m.detail));
      row.appendChild(left);
      row.appendChild(el('div', { style: { fontWeight: '700', color: m.montant >= 0 ? 'var(--success)' : 'var(--danger)' } }, (m.montant >= 0 ? '+' : '') + EUR(m.montant)));
      mouvList.appendChild(row);
    });
    mouvementsCard.appendChild(mouvList);
    
    if (filteredMouvements.length > 20) {
      mouvementsCard.appendChild(el('div', { style: { textAlign: 'center', fontSize: '11px', color: 'var(--text-muted)', padding: '12px' } }, 'Affichage limité à 20 mouvements'));
    }
  }
  
  container.appendChild(mouvementsCard);
}

function showEditSoldeInitial() {
  $('#formModalTitle').textContent = '🏦 Modifier Solde Initial';
  var body = $('#formModalBody');
  body.innerHTML = '';
  body.appendChild(el('div', { style: { marginBottom: '16px', fontSize: '12px', color: 'var(--text-muted)' } }, 'Le solde initial correspond au montant présent sur ton compte pro au début de ton activité ou de la période de suivi.'));
  body.appendChild(createInput('Solde Initial (€)', 'number', 'editSoldeInit', TREASURY.soldeInitial));
  body.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '16px' }, onclick: function() {
    TREASURY.soldeInitial = parseFloat($('#editSoldeInit').value) || 0;
    saveAll(); closeModal('formModal'); render();
    toast('Solde initial mis à jour', 'success');
  } }, '✅ Enregistrer'));
  openModal('formModal');
}

function renderAdmin(container) {
  container.appendChild(el('h2', { style: { fontSize: '20px', fontWeight: '800', marginBottom: '16px' } }, '⚙️ Administration'));
  
  // Entreprise
  var entCard = el('div', { class: 'card' });
  entCard.appendChild(el('div', { class: 'card-title' }, '🏢 Entreprise'));
  entCard.appendChild(createInput('Nom / Raison sociale', 'text', 'adminNom', COMPANY.nom));
  entCard.appendChild(el('div', { class: 'form-row' }, [
    createInput('SIRET', 'text', 'adminSiret', COMPANY.siret),
    createInput('Code APE', 'text', 'adminAPE', COMPANY.codeApe || '', 'Ex: 6201Z')
  ]));
  entCard.appendChild(createInput('Adresse', 'text', 'adminAdresse', COMPANY.adresse || ''));
  entCard.appendChild(el('div', { class: 'form-row' }, [
    createInput('Email', 'email', 'adminEmail', COMPANY.email || ''),
    createInput('Téléphone', 'tel', 'adminTel', COMPANY.telephone || '')
  ]));
  entCard.appendChild(createInput('Date de création', 'date', 'adminDebut', COMPANY.debut));
  
  // Si TVA active, afficher champ TVA intracom
  if (COMPANY.tvaDepuis) {
    entCard.appendChild(createInput('N° TVA Intracommunautaire', 'text', 'adminTVAIntracom', COMPANY.tvaIntracom || '', 'Ex: FR12345678901'));
  }
  
  entCard.appendChild(el('div', { style: { marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--glass-border)' } }));
  entCard.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px' } }, '💳 Coordonnées bancaires (pour factures)'));
  entCard.appendChild(el('div', { class: 'form-row' }, [
    createInput('IBAN', 'text', 'adminIBAN', COMPANY.iban || '', 'Ex: FR76 1234...'),
    createInput('BIC', 'text', 'adminBIC', COMPANY.bic || '', 'Ex: BNPAFRPP')
  ]));
  container.appendChild(entCard);
  
  // Fiscal
  var fiscCard = el('div', { class: 'card' });
  fiscCard.appendChild(el('div', { class: 'card-title' }, '💶 Régime Fiscal'));
  
  var acreRow = el('div', { class: 'toggle-row' });
  acreRow.appendChild(el('div', { class: 'toggle-label' }, 'ACRE actif'));
  var acreToggle = el('label', { class: 'toggle-switch' });
  acreToggle.innerHTML = '<input type="checkbox" id="adminAcre" ' + (COMPANY.acre ? 'checked' : '') + '><span class="toggle-slider"></span>';
  acreRow.appendChild(acreToggle);
  fiscCard.appendChild(acreRow);
  
  var plRow = el('div', { class: 'toggle-row' });
  plRow.appendChild(el('div', { class: 'toggle-label' }, 'Prélèvement Libératoire'));
  var plToggle = el('label', { class: 'toggle-switch' });
  plToggle.innerHTML = '<input type="checkbox" id="adminPL" ' + (COMPANY.prelevementLiberatoire ? 'checked' : '') + '><span class="toggle-slider"></span>';
  plRow.appendChild(plToggle);
  fiscCard.appendChild(plRow);
  
  fiscCard.appendChild(createInput('TVA depuis (laisser vide si non assujetti)', 'month', 'adminTVA', COMPANY.tvaDepuis || ''));
  
  // Périodicité URSSAF
  fiscCard.appendChild(createSelect('Périodicité URSSAF', 'adminUrssafPeriod', [
    { value: 'mensuel', label: '📅 Mensuel (fin de chaque mois)' },
    { value: 'trimestriel', label: '📆 Trimestriel (30/04, 31/07, 31/10, 31/01)' }
  ], COMPANY.urssafPeriodicite || 'mensuel'));
  
  // Note sur l'IR
  fiscCard.appendChild(el('div', { style: { marginTop: '12px', padding: '12px', background: 'var(--info-glow)', borderRadius: 'var(--radius-sm)', fontSize: '11px' } }, [
    el('strong', {}, '💡 Simulation IR: '),
    document.createTextNode('Clique sur la carte "IR Estimé" du dashboard pour configurer les paramètres (parts fiscales, PER, autres revenus) par année.')
  ]));
  
  container.appendChild(fiscCard);
  
  // Trésorerie
  var tresoCard = el('div', { class: 'card' });
  tresoCard.appendChild(el('div', { class: 'card-title' }, '💰 Trésorerie'));
  tresoCard.appendChild(createInput('Solde initial du compte (€)', 'number', 'adminSolde', TREASURY.soldeInitial));
  tresoCard.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '16px' } }, 'Solde de ton compte pro au démarrage de l\'activité'));
  
  // V47: Option Rendement Compte Pro
  tresoCard.appendChild(el('div', { style: { borderTop: '1px solid var(--glass-border)', paddingTop: '12px', marginTop: '8px' } }));
  tresoCard.appendChild(el('div', { style: { fontSize: '11px', fontWeight: '600', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' } }, '📈 Rendement Compte Pro'));
  tresoCard.appendChild(el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', marginBottom: '10px' } }, 'Calcul automatique des intérêts mensuels basés sur le solde moyen'));
  
  // Toggle Rendement actif
  var rendementToggle = el('div', { class: 'toggle-row', style: { paddingBottom: '8px', borderBottom: 'none' } });
  rendementToggle.appendChild(el('span', { class: 'toggle-label' }, 'Activer le rendement'));
  var switchRendement = el('label', { class: 'toggle-switch' });
  var inputRendement = el('input', { type: 'checkbox', id: 'adminRendementActif', checked: TREASURY.rendementActif || false, onchange: function() {
    var tauxField = $('#adminRendementTaux');
    if (tauxField) tauxField.disabled = !this.checked;
  } });
  switchRendement.appendChild(inputRendement);
  switchRendement.appendChild(el('span', { class: 'toggle-slider' }));
  rendementToggle.appendChild(switchRendement);
  tresoCard.appendChild(rendementToggle);
  
  // Champ Taux
  var tauxRow = el('div', { class: 'form-row', style: { marginTop: '10px', alignItems: 'flex-end' } });
  var tauxField = createInput('Taux annuel brut (%)', 'number', 'adminRendementTaux', TREASURY.rendementTaux || 2);
  tauxField.querySelector('input').step = '0.1';
  tauxField.querySelector('input').min = '0';
  tauxField.querySelector('input').max = '20';
  tauxField.querySelector('input').disabled = !(TREASURY.rendementActif || false);
  tauxRow.appendChild(tauxField);
  
  // Info calcul
  var infoRendement = el('div', { style: { flex: '1', fontSize: '10px', color: 'var(--text-muted)', padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px' } });
  var tauxMensuel = ((TREASURY.rendementTaux || 2) / 12).toFixed(3);
  infoRendement.innerHTML = '<span style="color: var(--info);">💡</span> Exemple: 10 000€ × ' + tauxMensuel + '% = <strong>' + EUR(10000 * (TREASURY.rendementTaux || 2) / 100 / 12) + '/mois</strong>';
  tauxRow.appendChild(infoRendement);
  tresoCard.appendChild(tauxRow);
  
  // Historique rendements si actif
  if (TREASURY.rendementActif && TREASURY.rendementHistorique && TREASURY.rendementHistorique.length > 0) {
    var totalRendement = getTotalRendement();
    var histInfo = el('div', { style: { marginTop: '12px', padding: '10px', background: 'var(--success-glow)', borderRadius: '8px', fontSize: '11px' } });
    histInfo.innerHTML = '<span style="font-weight: 700; color: var(--success);">✅ Total intérêts perçus: ' + EUR(totalRendement) + '</span><br><span style="color: var(--text-muted);">(' + TREASURY.rendementHistorique.length + ' mois calculés)</span>';
    tresoCard.appendChild(histInfo);
  }
  
  container.appendChild(tresoCard);
  
  // Info URSSAF et ACRE
  var acre = getAcreInfo();
  var infoCard = el('div', { class: 'card' });
  infoCard.appendChild(el('div', { class: 'card-title' }, '📊 Informations Utiles'));
  
  // ACRE Status
  var acreInfo = el('div', { class: 'info-box' });
  acreInfo.appendChild(el('div', { class: 'info-box-title' }, 'Statut ACRE'));
  if (COMPANY.acre && acre.active) {
    acreInfo.appendChild(el('div', { style: { color: 'var(--success)', fontWeight: '700', marginBottom: '8px' } }, '✅ ACRE Actif'));
    acreInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Expire le'), el('span', {}, fmtLong(acre.expiryDate))]));
    acreInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Jours restants'), el('span', {}, acre.daysLeft + ' jours')]));
  } else if (COMPANY.acre) {
    acreInfo.appendChild(el('div', { style: { color: 'var(--warning)', fontWeight: '700' } }, '⚠️ ACRE Expiré'));
  } else {
    acreInfo.appendChild(el('div', { style: { color: 'var(--text-muted)' } }, 'ACRE non activé'));
  }
  infoCard.appendChild(acreInfo);
  
  // Taux URSSAF
  var ratesInfo = el('div', { class: 'info-box' });
  ratesInfo.appendChild(el('div', { class: 'info-box-title' }, 'Taux URSSAF BNC (du CA HT)'));
  ratesInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, '2025 - Standard'), el('span', {}, PCT(LEGAL.urssafStd2025))]));
  ratesInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, '2025 - Avec ACRE'), el('span', { style: { color: 'var(--success)' } }, PCT(LEGAL.urssafAcre2025))]));
  ratesInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, '2026 - Standard'), el('span', {}, PCT(LEGAL.urssafStd2026))]));
  ratesInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, '2026 - Avec ACRE'), el('span', { style: { color: 'var(--success)' } }, PCT(LEGAL.urssafAcre2026))]));

  // Taux applicable actuellement
  var currentRate = getUrssafRate(ym(TODAY.getFullYear(), TODAY.getMonth()));
  var acre = getAcreInfo();
  var acreStatus = COMPANY.acre ? (acre.active ? ' (ACRE actif jusqu\'au ' + fmtDate(acre.expiryDate) + ')' : ' (ACRE expiré le ' + fmtDate(acre.expiryDate) + ')') : '';
  ratesInfo.appendChild(el('div', { style: { marginTop: '8px', padding: '8px', background: 'var(--bg-tertiary)', borderRadius: '6px' } }, [el('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, 'Ton taux actuel: '), el('span', { style: { fontWeight: '700', color: 'var(--accent)' } }, PCT(currentRate)), el('span', { style: { fontSize: '10px', color: 'var(--text-muted)', display: 'block', marginTop: '4px' } }, acreStatus)]));
  infoCard.appendChild(ratesInfo);
  
  // Autres infos
  var otherInfo = el('div', { class: 'info-box' });
  otherInfo.appendChild(el('div', { class: 'info-box-title' }, 'Autres Cotisations'));
  otherInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'CFP (Formation)'), el('span', {}, PCT(LEGAL.cfp) + ' du CA HT')]));
  otherInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Prélèvement Libératoire'), el('span', {}, PCT(LEGAL.impLib) + ' du CA HT')]));
  otherInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'TVA'), el('span', {}, PCT(LEGAL.tvaRate) + ' (sur HT)')]));
  infoCard.appendChild(otherInfo);

  // Plafonds et seuils micro-entreprise
  var seuilsInfo = el('div', { class: 'info-box' });
  seuilsInfo.appendChild(el('div', { class: 'info-box-title' }, '📊 Plafonds Micro-entreprise 2025/2026'));
  seuilsInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'CA max BNC/Services'), el('span', { style: { fontWeight: '700' } }, EUR(LEGAL.plafondBNC))]));
  seuilsInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'CA max Vente'), el('span', {}, EUR(LEGAL.plafondVente))]));
  seuilsInfo.appendChild(el('div', { style: { marginTop: '8px', fontSize: '11px', color: 'var(--text-muted)' } }, 'Franchise TVA (services):'));
  seuilsInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Seuil standard'), el('span', {}, EUR(LEGAL.seuilTVA))]));
  seuilsInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Seuil majoré (perte)'), el('span', { style: { color: 'var(--danger)' } }, EUR(LEGAL.seuilTVAMajore))]));
  infoCard.appendChild(seuilsInfo);
  
  // Échéances de paiement - format tableau clair
  var echeancesInfo = el('div', { class: 'info-box' });
  echeancesInfo.appendChild(el('div', { class: 'info-box-title' }, '📅 Échéances de Paiement'));
  
  // Helper pour créer une ligne d'échéance
  function createEcheanceRow(icon, label, dateLabel, color, details) {
    var row = el('div', { style: { marginBottom: '16px' } });
    var header = el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' } });
    header.appendChild(el('span', { style: { fontWeight: '600', color: color } }, icon + ' ' + label));
    header.appendChild(el('span', { style: { fontWeight: '700', color: color, fontSize: '13px' } }, dateLabel));
    row.appendChild(header);
    var detailDiv = el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', paddingLeft: '8px', borderLeft: '2px solid ' + color, lineHeight: '1.6' } });
    detailDiv.innerHTML = details;
    row.appendChild(detailDiv);
    return row;
  }
  
  // URSSAF + CFP
  echeancesInfo.appendChild(createEcheanceRow(
    '🏥', 'URSSAF + CFP', 'Fin du mois suivant', 'var(--danger)',
    '<b>Mensuel:</b> 31/01 (déc), 28/02 (jan), 31/03 (fév)...<br><b>Trimestriel:</b> 30/04, 31/07, 31/10, 31/01'
  ));
  
  // Prélèvement Libératoire ou IR
  if (COMPANY.prelevementLiberatoire) {
    echeancesInfo.appendChild(createEcheanceRow(
      '💰', 'Prélèvement Libératoire (' + PCT(LEGAL.impLib) + ')', 'Avec URSSAF', '#fbbf24',
      'Prélevé automatiquement en même temps que les cotisations URSSAF.<br>Condition: RFR N-2 ≤ 29 315€ (1 part)'
    ));
  } else {
    echeancesInfo.appendChild(createEcheanceRow(
      '💰', 'Impôt sur le Revenu', '15 de chaque mois', '#fbbf24',
      '<b>Acomptes mensuels:</b> 15/01, 15/02, 15/03...<br><b>Trimestriel:</b> 15/02, 15/05, 15/08, 15/11<br><b>Déclaration:</b> Mai-Juin · <b>Solde:</b> 25 septembre'
    ));
  }
  
  // TVA
  if (COMPANY.tvaDepuis) {
    echeancesInfo.appendChild(createEcheanceRow(
      '🏛️', 'TVA (régime simplifié)', 'Mai + Acomptes', '#f472b6',
      '<b>Déclaration CA12:</b> ~5 mai (2ème jour ouvré après 1er mai)<br><b>Acompte 55%:</b> 15-24 juillet<br><b>Acompte 40%:</b> 15-24 décembre'
    ));
  } else {
    echeancesInfo.appendChild(createEcheanceRow(
      '🏛️', 'TVA', 'Non assujetti', 'var(--success)',
      'Franchise en base tant que CA < 37 500€ (services).<br>Seuil majoré: 41 250€ (TVA immédiate si dépassé)'
    ));
  }
  
  // CFE
  echeancesInfo.appendChild(createEcheanceRow(
    '🏢', 'CFE', '15 décembre', 'var(--warning)',
    'Paiement unique annuel. Avis disponible mi-novembre.<br><b>Exonéré:</b> 1ère année, ou si CA N-2 < 5 000€<br>Acompte 50% le 16 juin si CFE > 3 000€'
  ));
  
  // Résumé calendrier
  echeancesInfo.appendChild(el('div', { style: { marginTop: '16px', paddingTop: '12px', borderTop: '1px solid var(--glass-border)' } }));
  var calendarSummary = el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } });
  calendarSummary.innerHTML = '<b>📆 Récap dates clés:</b><br>' +
    '• <b>Fin de chaque mois:</b> URSSAF' + (COMPANY.prelevementLiberatoire ? ' + Prél. Lib.' : '') + '<br>' +
    '• <b>15 de chaque mois:</b> ' + (COMPANY.prelevementLiberatoire ? '—' : 'Acompte IR') + '<br>' +
    '• <b>Mai:</b> Déclaration revenus' + (COMPANY.tvaDepuis ? ' + TVA CA12' : '') + '<br>' +
    '• <b>15 décembre:</b> CFE';
  echeancesInfo.appendChild(calendarSummary);
  
  // Charges facultatives
  echeancesInfo.appendChild(el('div', { style: { marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--glass-border)' } }));
  var optionalCharges = el('div', { style: { fontSize: '10px', color: 'var(--text-muted)' } });
  optionalCharges.innerHTML = '<b>📋 Charges optionnelles:</b><br>' +
    '• <b>RC Pro:</b> 150-400€/an (obligatoire pour certains métiers)<br>' +
    '• <b>Mutuelle:</b> 30-150€/mois<br>' +
    '• <b>Prévoyance:</b> Variable<br>' +
    '• <b>Compte bancaire dédié:</b> Obligatoire si CA > 10k€ sur 2 ans';
  echeancesInfo.appendChild(optionalCharges);
  
  infoCard.appendChild(echeancesInfo);
  
  // Résumé annuel
  var data = compute();
  var summaryInfo = el('div', { class: 'info-box' });
  summaryInfo.appendChild(el('div', { class: 'info-box-title' }, 'Résumé Période'));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'CA Réalisé'), el('span', { style: { fontWeight: '700', color: 'var(--info)' } }, EUR(data.caReal))]));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'CA Encaissé (TTC)'), el('span', { style: { fontWeight: '700', color: 'var(--success)' } }, EUR(data.caEnc))]));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Total Charges'), el('span', { style: { fontWeight: '700', color: 'var(--danger)' } }, EUR(data.totalCharges))]));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Bénéfice Net'), el('span', { style: { fontWeight: '700', color: data.beneficeNet >= 0 ? 'var(--success)' : 'var(--danger)' } }, EUR(data.beneficeNet))]));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Salaires Versés'), el('span', { style: { fontWeight: '700', color: 'var(--info)' } }, EUR(data.salaires))]));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Jours Travaillés'), el('span', { style: { fontWeight: '700' } }, data.joursReal + 'j')]));
  summaryInfo.appendChild(el('div', { class: 'info-row' }, [el('span', { class: 'info-row-label' }, 'Jours Congés'), el('span', { style: { fontWeight: '700', color: 'var(--warning)' } }, data.joursOff + 'j')]));
  infoCard.appendChild(summaryInfo);
  
  container.appendChild(infoCard);
  
  // Sauvegarder
  container.appendChild(el('button', { class: 'btn btn-success btn-block', style: { marginTop: '12px' }, onclick: function() {
    COMPANY.nom = $('#adminNom').value;
    COMPANY.siret = $('#adminSiret').value;
    COMPANY.codeApe = $('#adminAPE') ? $('#adminAPE').value : '';
    COMPANY.adresse = $('#adminAdresse') ? $('#adminAdresse').value : '';
    COMPANY.email = $('#adminEmail') ? $('#adminEmail').value : '';
    COMPANY.telephone = $('#adminTel') ? $('#adminTel').value : '';
    COMPANY.debut = $('#adminDebut').value;
    COMPANY.acre = $('#adminAcre').checked;
    COMPANY.prelevementLiberatoire = $('#adminPL').checked;
    COMPANY.tvaDepuis = $('#adminTVA').value || null;
    COMPANY.urssafPeriodicite = $('#adminUrssafPeriod') ? $('#adminUrssafPeriod').value : 'mensuel';
    if ($('#adminTVAIntracom')) COMPANY.tvaIntracom = $('#adminTVAIntracom').value || '';
    if ($('#adminIBAN')) COMPANY.iban = $('#adminIBAN').value || '';
    if ($('#adminBIC')) COMPANY.bic = $('#adminBIC').value || '';
    TREASURY.soldeInitial = parseFloat($('#adminSolde').value) || 0;
    // V47: Sauvegarde paramètres rendement
    var wasRendementActif = TREASURY.rendementActif;
    TREASURY.rendementActif = $('#adminRendementActif') ? $('#adminRendementActif').checked : false;
    TREASURY.rendementTaux = $('#adminRendementTaux') ? parseFloat($('#adminRendementTaux').value) || 2 : 2;
    // Si rendement vient d'être activé, calculer l'historique
    if (TREASURY.rendementActif && !wasRendementActif) {
      TREASURY.rendementHistorique = [];
      updateRendementHistorique();
    }
    // Si taux changé et rendement actif, recalculer
    if (TREASURY.rendementActif) {
      TREASURY.rendementHistorique = [];
      updateRendementHistorique();
    }
    saveAll(); render();
    toast('Configuration sauvegardée', 'success');
  } }, '✅ Sauvegarder'));
  
  // Export/Import
  var ioCard = el('div', { class: 'card', style: { marginTop: '12px' } });
  ioCard.appendChild(el('div', { class: 'card-title' }, '💾 Données'));
  var ioBtns = el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '10px' } });
  ioBtns.appendChild(el('button', { class: 'btn', onclick: exportData }, '📤 Export'));
  var importWrapper = el('div', { class: 'file-input-wrapper' });
  importWrapper.appendChild(el('button', { class: 'btn btn-block' }, '📥 Import'));
  var importInput = el('input', { type: 'file', accept: '.json' });
  importInput.onchange = function(e) { if (e.target.files[0]) importData(e.target.files[0]); };
  importWrapper.appendChild(importInput);
  ioBtns.appendChild(importWrapper);
  ioBtns.appendChild(el('button', { class: 'btn btn-danger', onclick: function() { if (confirm('Supprimer TOUTES les données?')) { Object.keys(localStorage).filter(function(k) { return k.indexOf('freel') === 0; }).forEach(function(k) { localStorage.removeItem(k); }); location.reload(); } } }, '🗑️ Reset'));
  ioCard.appendChild(ioBtns);
  
  // Exports comptables obligatoires
  ioCard.appendChild(el('div', { style: { marginTop: '16px', paddingTop: '12px', borderTop: '1px solid var(--glass-border)' } }));
  ioCard.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px' } }, '📋 Exports Comptables (Art. L123-28 Code Commerce)'));
  var comptaBtns = el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' } });
  
  // Sélecteur d'année pour l'export
  var currentYear = TODAY.getFullYear();
  var yearSelect = el('select', { class: 'form-select', id: 'exportYear', style: { marginBottom: '8px' } });
  [currentYear - 1, currentYear, currentYear + 1].forEach(function(y) {
    var opt = el('option', { value: y }, String(y));
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  });
  ioCard.appendChild(yearSelect);
  
  comptaBtns.appendChild(el('button', { class: 'btn', style: { background: 'var(--success-glow)', borderColor: 'var(--success)' }, onclick: function() { 
    var year = parseInt($('#exportYear').value);
    exportLivreRecettes(year); 
  } }, '📗 Livre CSV'));
  
  // V46: Bouton export PDF Livre des Recettes (conformité contrôle fiscal)
  comptaBtns.appendChild(el('button', { class: 'btn', style: { background: 'var(--danger-glow)', borderColor: 'var(--danger)' }, onclick: function() { 
    var year = parseInt($('#exportYear').value);
    exportLivreRecettesPDF(year); 
  } }, '📕 Livre PDF'));
  
  // Bouton export FEC
  comptaBtns.appendChild(el('button', { class: 'btn', style: { background: 'var(--info-glow)', borderColor: 'var(--info)' }, onclick: function() { 
    var year = parseInt($('#exportYear').value);
    exportFEC(year); 
  } }, '📊 Export FEC'));
  
  // Statistiques du livre des recettes
  var registryCount = COMPANY.invoiceRegistry ? COMPANY.invoiceRegistry.length : 0;
  var registryInfo = el('div', { style: { fontSize: '10px', color: 'var(--text-muted)', gridColumn: 'span 2' } });
  registryInfo.textContent = '📊 ' + registryCount + ' facture(s) enregistrée(s)';
  comptaBtns.appendChild(registryInfo);
  
  ioCard.appendChild(comptaBtns);
  
  // Gestion des clients
  ioCard.appendChild(el('div', { style: { marginTop: '16px', paddingTop: '12px', borderTop: '1px solid var(--glass-border)' } }));
  ioCard.appendChild(el('div', { style: { fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px' } }, '🏢 Gestion Clients'));
  var clientsBtns = el('div', { style: { display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap' } });
  clientsBtns.appendChild(el('button', { class: 'btn btn-sm', onclick: function() { showClientModal(); } }, '+ Nouveau Client'));
  clientsBtns.appendChild(el('span', { style: { fontSize: '11px', color: 'var(--text-muted)' } }, CLIENTS.length + ' client(s)'));
  if (CLIENTS.length > 0) {
    var clientList = el('select', { class: 'form-select', style: { flex: '1', minWidth: '120px' }, onchange: function(e) {
      if (e.target.value) {
        var cli = getClient(e.target.value);
        if (cli) showClientModal(cli);
        e.target.value = '';
      }
    } });
    clientList.appendChild(el('option', { value: '' }, '-- Modifier --'));
    CLIENTS.forEach(function(c) { clientList.appendChild(el('option', { value: c.id }, c.nom)); });
    clientsBtns.appendChild(clientList);
  }
  ioCard.appendChild(clientsBtns);
  
  container.appendChild(ioCard);
  
  container.appendChild(el('div', { style: { textAlign: 'center', marginTop: '24px', fontSize: '11px', color: 'var(--text-muted)' } }, 'Freel V' + APP_VERSION + ' · Made with 💚'));
}

function render() {
  var container = $('#app');
  if (!container) { console.error('Container #app not found'); return; }
  container.innerHTML = '';

  try {
    if (VIEW === 'accueil') renderAccueil(container);
    else if (VIEW === 'performance') renderPerformance(container);
    else if (VIEW === 'missions') { VIEW = 'finances'; FINANCES_TAB = 'missions'; renderFinances(container); }
    else if (VIEW === 'finances') renderFinances(container);
    else if (VIEW === 'params') renderParams(container);
  } catch (e) {
    console.error('Render error:', e);
    container.innerHTML = '<div style="padding:20px;color:red;">Erreur: ' + e.message + '</div>';
  }

  $$('.nav-tab, .bottom-nav-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.view === VIEW); });
  var periodYear = $('#periodYear');
  if (periodYear) periodYear.textContent = PERIOD.type === 'year' ? PERIOD.year : 'Custom';
  // V72: Synchroniser le dropdown mois
  var monthFilter = $('#monthFilter');
  if (monthFilter) monthFilter.value = PERIOD.month !== null && PERIOD.month !== undefined ? String(PERIOD.month) : '';
  updateNotifBadge();

  // V61: Dessiner les graphiques après le render si onglet Performance
  // Utiliser un délai plus long pour garantir que le DOM est prêt
  if (VIEW === 'performance') {
    requestAnimationFrame(function() {
      setTimeout(function() {
        try {
          var mc = $('#mainChart');
          var sc = $('#soldeChart');
          // V61: Forcer les dimensions du canvas avant de dessiner
          if (mc && mc.getContext) {
            var mcParent = mc.parentElement;
            if (mcParent) {
              mc.style.width = '100%';
              mc.style.height = '100%';
            }
            drawMainChart();
            if (mainChart) mainChart.resize();
          }
          if (sc && sc.getContext) {
            var scParent = sc.parentElement;
            if (scParent) {
              sc.style.width = '100%';
              sc.style.height = '100%';
            }
            drawSoldeChart();
            if (soldeChart) soldeChart.resize();
          }
        } catch (e) {
          console.error('Chart render error:', e);
        }
      }, 100);
    });
  }
}

// === ONBOARDING ===
var OB_STEP = 0;
var OB_STEPS = [
  { icon: '👋', title: 'Bienvenue sur Freel!', text: 'Ton assistant de gestion freelance. Configurons ton activité.', fields: [] },
  { icon: '🏢', title: 'Ton entreprise', text: 'Quelques infos de base', fields: ['nom', 'debut'] },
  { icon: '💶', title: 'Fiscalité', text: 'Tes options fiscales actuelles', fields: ['acre', 'pl'] },
  { icon: '💼', title: 'Première mission', text: 'Ajoute ta mission actuelle', fields: ['mission'] }
];

function showOnboarding() {
  if (COMPANY.onboardingDone) return;
  OB_STEP = 0;
  updateOnboarding();
  $('#onboarding').classList.add('active');
}

function updateOnboarding() {
  var step = OB_STEPS[OB_STEP];
  $('#obIcon').textContent = step.icon;
  $('#obTitle').textContent = step.title;
  $('#obText').textContent = step.text;
  
  var stepsDiv = $('#obSteps');
  stepsDiv.innerHTML = '';
  OB_STEPS.forEach(function(_, i) {
    var dot = el('div', { class: 'onboarding-step' + (i === OB_STEP ? ' active' : i < OB_STEP ? ' done' : '') });
    stepsDiv.appendChild(dot);
  });
  
  var form = $('#obForm');
  form.innerHTML = '';
  
  if (step.fields.includes('nom')) {
    form.appendChild(createInput('Nom de ton entreprise', 'text', 'obNom', COMPANY.nom));
  }
  if (step.fields.includes('debut')) {
    form.appendChild(createInput('Date de début d\'activité', 'date', 'obDebut', COMPANY.debut));
    form.appendChild(createInput('Solde initial compte pro (€)', 'number', 'obSolde', TREASURY.soldeInitial));
  }
  if (step.fields.includes('acre')) {
    var acreRow = el('div', { class: 'toggle-row' });
    acreRow.appendChild(el('div', { class: 'toggle-label' }, 'ACRE actif (exonération 1ère année)'));
    var acreToggle = el('label', { class: 'toggle-switch' });
    acreToggle.innerHTML = '<input type="checkbox" id="obAcre" ' + (COMPANY.acre ? 'checked' : '') + '><span class="toggle-slider"></span>';
    acreRow.appendChild(acreToggle);
    form.appendChild(acreRow);
  }
  if (step.fields.includes('pl')) {
    var plRow = el('div', { class: 'toggle-row' });
    plRow.appendChild(el('div', { class: 'toggle-label' }, 'Prélèvement Libératoire'));
    var plToggle = el('label', { class: 'toggle-switch' });
    plToggle.innerHTML = '<input type="checkbox" id="obPL" ' + (COMPANY.prelevementLiberatoire ? 'checked' : '') + '><span class="toggle-slider"></span>';
    plRow.appendChild(plToggle);
    form.appendChild(plRow);
    
    var tvaRow = el('div', { class: 'toggle-row' });
    tvaRow.appendChild(el('div', { class: 'toggle-label' }, 'Assujetti à la TVA'));
    var tvaToggle = el('label', { class: 'toggle-switch' });
    tvaToggle.innerHTML = '<input type="checkbox" id="obTVA"><span class="toggle-slider"></span>';
    tvaRow.appendChild(tvaToggle);
    form.appendChild(tvaRow);
  }
  if (step.fields.includes('mission')) {
    form.appendChild(createInput('Client', 'text', 'obClient', ''));
    form.appendChild(createInput('TJM (€)', 'number', 'obTJM', ''));
    var row = el('div', { class: 'form-row' });
    row.appendChild(createInput('Début', 'date', 'obMDebut', ''));
    row.appendChild(createInput('Fin', 'date', 'obMFin', ''));
    form.appendChild(row);
  }
  
  $('#obNext').textContent = OB_STEP === OB_STEPS.length - 1 ? 'Terminer 🎉' : 'Continuer →';
  $('#obSkip').style.display = OB_STEP === 0 ? 'block' : 'none';
}

function nextOnboarding() {
  if (OB_STEP === 1) {
    if ($('#obNom')) COMPANY.nom = $('#obNom').value;
    if ($('#obDebut')) COMPANY.debut = $('#obDebut').value;
    if ($('#obSolde')) TREASURY.soldeInitial = parseFloat($('#obSolde').value) || 5000;
  }
  if (OB_STEP === 2) {
    if ($('#obAcre')) COMPANY.acre = $('#obAcre').checked;
    if ($('#obPL')) COMPANY.prelevementLiberatoire = $('#obPL').checked;
    if ($('#obTVA') && $('#obTVA').checked) COMPANY.tvaDepuis = ym(TODAY.getFullYear(), TODAY.getMonth());
  }
  if (OB_STEP === 3) {
    var client = $('#obClient') ? $('#obClient').value : '';
    var tjm = $('#obTJM') ? parseFloat($('#obTJM').value) : 0;
    var debut = $('#obMDebut') ? $('#obMDebut').value : '';
    var fin = $('#obMFin') ? $('#obMFin').value : '';
    if (client && tjm && debut && fin) {
      var mission = { id: 'M' + Date.now(), client: client, titre: '', site: '', debut: debut, fin: fin, tjm: tjm, delaiPaiement: 2, jourPaiement: 15 };
      buildMission(mission);
      MISSIONS.push(mission);
    }
  }
  
  OB_STEP++;
  if (OB_STEP >= OB_STEPS.length) {
    COMPANY.onboardingDone = true;
    saveAll();
    $('#onboarding').classList.remove('active');
    render();
    toast('Bienvenue sur Freel! 🎉', 'success');
  } else {
    updateOnboarding();
  }
}

function skipOnboarding() {
  COMPANY.onboardingDone = true;
  saveAll();
  $('#onboarding').classList.remove('active');
  render();
}

// === INIT ===
function init() {
  loadAll();
  initSupabase(); // V51: Initialize cloud sync
  MISSIONS.forEach(buildMission);
  
  // Navigation
  $$('.nav-tab, .bottom-nav-tab').forEach(function(t) {
    t.onclick = function() { VIEW = t.dataset.view; render(); };
  });
  
  // Period
  $('#prevYear').onclick = function() { PERIOD.year--; PERIOD.type = 'year'; PERIOD.month = null; $('#monthFilter').value = ''; TIMELINE_IDX = null; render(); };
  $('#nextYear').onclick = function() { PERIOD.year++; PERIOD.type = 'year'; PERIOD.month = null; $('#monthFilter').value = ''; TIMELINE_IDX = null; render(); };
  $('#periodYear').onclick = function() { PERIOD.type = 'year'; PERIOD.month = null; $('#monthFilter').value = ''; $$('.period-input').forEach(function(i) { i.style.display = 'none'; }); render(); };
  // V72: Filtre mensuel
  $('#monthFilter').onchange = function() {
    var val = this.value;
    PERIOD.type = 'year';
    PERIOD.month = val === '' ? null : parseInt(val);
    TIMELINE_IDX = null;
    render();
  };
  $('#periodCustomBtn').onclick = function() {
    PERIOD.type = 'custom';
    PERIOD.month = null; // V72: Reset month filter
    $('#monthFilter').value = '';
    PERIOD.start = PERIOD.start || ym(TODAY.getFullYear(), 0);
    PERIOD.end = PERIOD.end || ym(TODAY.getFullYear(), 11);
    $('#periodStart').value = PERIOD.start;
    $('#periodEnd').value = PERIOD.end;
    $('#periodStart').style.display = 'block';
    $('#periodEnd').style.display = 'block';
    render();
  };
  $('#periodStart').onchange = function() { PERIOD.start = this.value; TIMELINE_IDX = null; render(); };
  $('#periodEnd').onchange = function() { PERIOD.end = this.value; TIMELINE_IDX = null; render(); };
  
  // FAB
  $('#fab').onclick = function() { openModal('fabModal'); };
  
  // Modals
  $$('.modal').forEach(function(m) {
    m.onclick = function(e) { if (e.target === m) closeModal(m.id); };
  });
  
  // Onboarding
  $('#obNext').onclick = nextOnboarding;
  $('#obSkip').onclick = skipOnboarding;
  
  // Sprint 12: Raccourcis clavier améliorés + recherche + backup
  createSearchOverlay();
  createKeyboardHelp();
  createBackupIndicator();
  initKeyboardShortcuts();
  initTheme();
  createNotifCenter();
  updateNotifBadge();

  // Privacy toggle
  var privacyBtn = $('#privacyToggle');
  if (privacyBtn) {
    privacyBtn.onclick = togglePrivacy;
  }
  
  // V47: Mettre à jour l'historique des intérêts si rendement actif
  if (TREASURY.rendementActif) {
    if (!TREASURY.rendementHistorique) TREASURY.rendementHistorique = [];
    updateRendementHistorique();
  }

  // V50: Fix - Pré-calculer COMPUTED avant le premier rendu
  COMPUTED = compute();

  // V55: Rendu immédiat pour éviter l'écran noir, puis requestAnimationFrame pour les graphiques
  render();

  // V61: Appel différé avec setTimeout pour garantir le layout complet
  setTimeout(function() {
    if (VIEW === 'performance') {
      try {
        if ($('#mainChart')) {
          drawMainChart();
          if (mainChart) mainChart.resize();
        }
        if ($('#soldeChart')) {
          drawSoldeChart();
          if (soldeChart) soldeChart.resize();
        }
      } catch (e) {
        console.error('Init chart error:', e);
      }
    }

    if (!COMPANY.onboardingDone && MISSIONS.length === 0) {
      showOnboarding();
    }
  }, 150);
}

document.addEventListener('DOMContentLoaded', init);

/*
 * ═══════════════════════════════════════════════════════════════════════════
 * CHANGELOG FREEL V56 - 14 février 2026
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 🔴 CORRECTIONS
 * ──────────────
 * 1. GRAPHIQUES PERFORMANCE
 *    - Fix canvas Chart.js: suppression styles inline qui cassaient le rendu
 *    - Les graphiques CA et Trésorerie s'affichent maintenant correctement
 *
 * 2. CALCUL JOURS TRAVAILLÉS
 *    - Nouvelle fonction daysBizInRange() pour calcul partiel
 *    - Prise en compte de la date exacte de début/fin de mission
 *    - Premier mois: jours ouvrables du jour de début à fin de mois
 *    - Dernier mois: jours ouvrables du début de mois au jour de fin
 *
 * 3. STATUT MISSION
 *    - Fix: utilisation de m.fin au lieu de m.dateFin (cohérence données)
 *    - Les missions se terminant après aujourd'hui sont bien marquées "En cours"
 *
 * 🟠 AMÉLIORATIONS UX
 * ──────────────────
 * 4. WIDGET IMPÔTS & CHARGES
 *    - Nouveau design camembert (style identique au widget Clients)
 *    - Visualisation intuitive de la répartition des charges
 *    - Total au centre du donut
 *    - Barres horizontales avec couleurs par catégorie
 *
 * 5. NAVIGATION SIMPLIFIÉE
 *    - Suppression onglet Missions (doublon avec Finances > Missions)
 *    - Navigation à 4 onglets: Accueil, Perf, Finances, Params
 *    - Redirection automatique si URL mission vers Finances
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * CHANGELOG FREEL V50 - 5 février 2026 (Clean Slate)
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 🔴 CORRECTIONS CRITIQUES
 * ────────────────────────
 * 1. FIX DASHBOARD VIDE AU LANCEMENT
 *    - Pré-calcul COMPUTED avant le premier render
 *    - Double requestAnimationFrame pour timing fiable
 *    - Remplacement setTimeout(50ms) par requestAnimationFrame pour charts
 *    - Ajout vérifications null/getContext dans draw functions
 *    - Try-catch autour du render avec message d'erreur visible
 *
 * 2. MIGRATION STOCKAGE V39 → V50
 *    - Nouveau préfixe localStorage: freel_v50_
 *    - Migration automatique des données v39 existantes
 *    - Aucune perte de données utilisateur
 *
 * 🟠 NETTOYAGE DU CODE
 * ────────────────────
 * 3. SUPPRESSION CODE MORT
 *    - Suppression SUPABASE_CONFIG non utilisé
 *    - Suppression console.log de debug
 *    - Nettoyage commentaires "SPRINT X" obsolètes
 *
 * 4. INITIALISATION PROPRE
 *    - COMPANY initialisé avec valeurs vides par défaut
 *    - Ajout propriétés manquantes: ville, codePostal, commune
 *    - onboardingDone = false par défaut (nouveaux utilisateurs)
 *
 * 5. ROBUSTESSE
 *    - Null checks dans render() et draw functions
 *    - Fallback compute() si COMPUTED vide
 *    - Gestion d'erreur avec message visible
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * CHANGELOG FREEL V49 - 11 janvier 2026 (Refonte UX)
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 🔴 REFONTE ERGONOMIQUE MAJEURE
 * ──────────────────────────────
 * 1. RÉORGANISATION DU DASHBOARD
 *    - Nouvel ordre logique basé sur le flux mental utilisateur
 *    - Principe: URGENCES → PERFORMANCE → TRÉSORERIE
 *    
 *    AVANT (V48):
 *    ├─ Deadlines + Alertes
 *    ├─ Hero (Trésorerie)      ← Mélange
 *    ├─ CA (4 KPIs)
 *    ├─ Activité (TJM, Taux, Rémunération, IR)
 *    ├─ Timeline (Trésorerie)  ← Mélange
 *    ├─ Graph CA
 *    └─ Graph Tréso            ← Mélange
 *    
 *    APRÈS (V49):
 *    ├─ 1. URGENCES
 *    │   └─ Deadlines + Alertes
 *    ├─ 2. PERFORMANCE (combien je gagne)
 *    │   ├─ KPIs: CA Réalisé, Encaissé, Bénéfice, IR
 *    │   ├─ Graph CA (juste après les KPIs)
 *    │   └─ KPIs: TJM, Taux Facturation, À Encaisser
 *    └─ 3. TRÉSORERIE (combien j'ai)
 *        ├─ Hero: Cash Dispo (avec badge "↗ projections")
 *        ├─ KPIs: Rémunération, Rendement Compte
 *        ├─ Timeline Échéancier
 *        └─ Graph Trésorerie
 *
 * 2. RENDEMENT COMPTE PRO - DÉPLACÉ
 *    - AVANT: Configuration dans Admin (contre-intuitif)
 *    - APRÈS: Configuration au clic depuis le Dashboard
 *    - Nouvelle fonction showRendementConfig()
 *    - Toggle + champ taux + historique dans la même popup
 *    - KPI "Configurer" si non activé, montant si activé
 *
 * 3. INDICATEURS CLIQUABLES AJOUTÉS AU DASHBOARD
 *    - Hero: badge "↗ projections" visible (opacity 0.85)
 *    - Tous les KPI utilisent la fonction KPI() avec .interactive
 *    - Rémunération déplacé dans section Trésorerie
 *
 * 🟢 AMÉLIORATIONS UX
 * ───────────────────
 * 4. COHÉRENCE VISUELLE
 *    - Graphique CA directement sous les KPIs CA
 *    - Graphique Tréso directement sous Timeline
 *    - Sections clairement délimitées avec SectionTitle()
 *
 * 5. FLUX LOGIQUE
 *    - "Je gagne → J'ai → Je dépense"
 *    - Regroupement thématique (Gestalt: proximité)
 *    - Réduction du va-et-vient mental
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * CHANGELOG FREEL V48 (inclus)
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 🔴 CORRECTIONS CRITIQUES UX
 * ───────────────────────────
 * 1. INDICATEURS DE CLIQUABILITÉ VRAIMENT VISIBLES
 *    - AVANT: Icône "↗" avec opacité 0.4-0.5 (quasi invisible)
 *    - APRÈS: Badge textuel "↗ détail" avec fond coloré, opacité 0.85
 *    - KPI: Badge violet avec texte, devient blanc sur fond violet au hover
 *    - Treso-item: Pastille ronde violette avec icône blanche
 *    - Principe: TOUJOURS VISIBLE, pas seulement au hover
 *
 * 2. TRAÇABILITÉ INTÉRÊTS COMPTE PRO
 *    - AVANT: Bloc caché si rendement non activé
 *    - APRÈS: Bloc TOUJOURS VISIBLE avec invitation à configurer
 *    - Clic sur le bloc "Rendement" redirige vers Admin si non configuré
 *    - Toast informatif "Active le rendement dans Admin > Trésorerie"
 *
 * 3. NOUVELLE CARD HISTORIQUE INTÉRÊTS
 *    - Tableau des 6 derniers mois directement visible
 *    - Colonnes: Mois | Solde moyen | Intérêts
 *    - Total perçu avec nombre de mois
 *    - Note fiscale PFU 30%
 *    - Background dégradé vert pour identifier la card
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * CHANGELOG FREEL V47 (inclus)
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 🔴 NOUVELLES FONCTIONNALITÉS
 * ────────────────────────────
 * 1. RENDEMENT COMPTE PRO
 *    - Option activable dans Admin > Trésorerie
 *    - Champ libre pour le taux annuel brut (ex: 2%)
 *    - Calcul automatique des intérêts mensuels
 *    - Formule: Intérêts = Solde moyen × (Taux/12)
 *    - Historique détaillé avec solde moyen par mois
 *    - Intégré au calcul du solde absolu
 *    - Note fiscale: rappel PFU 30% sur intérêts
 *
 * 2. FONCTIONS AJOUTÉES
 *    - getSoldeMoyenMois(ym): calcule le solde moyen d'un mois
 *    - calculerRendementMensuel(ym): calcule les intérêts d'un mois
 *    - updateRendementHistorique(): met à jour l'historique des intérêts
 *    - getTotalRendement(): total des intérêts perçus
 *    - showRendementDetail(): modale détail des intérêts
 *    - getNextMonth/getPreviousMonth: helpers navigation mois
 *
 * 🟠 CORRECTIONS UX/UI
 * ────────────────────
 * 3. INDICATEURS DE CLIQUABILITÉ CORRIGÉS
 *    - Indicateurs maintenant PERSISTANTS (toujours visibles)
 *    - Indicateurs UNIQUEMENT sur éléments vraiment cliquables
 *    - Nouvelle classe .interactive pour KPI cliquables
 *    - Fonction KPI() ajoute automatiquement .interactive si onClick défini
 *    - Suppression des animations bounce sur timeline (trop intrusif)
 *    - Opacité 0.4 → 1 au hover (au lieu de 0 → 1)
 *
 * 4. STRUCTURE TREASURY ÉTENDUE
 *    - rendementActif: boolean
 *    - rendementTaux: float (%)
 *    - rendementHistorique: [{mois, soldeMoyen, montant, taux}]
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * CHANGELOG FREEL V46 (inclus)
 * ═══════════════════════════════════════════════════════════════════════════
 * - Export PDF Livre des Recettes (conformité Art. L123-25)
 * - Indicateurs de cliquabilité (corrigés en V47)
 *
 * CHANGELOG FREEL V45 (inclus)
 * ═══════════════════════════════════════════════════════════════════════════
 * - Correction abattement IR: sans plafond (min 305€)
 * - Taux URSSAF 2026: 26.1% / 13.05% ACRE
 * - KPI cohérent HT/HT
 * - Projections intelligentes basées sur missions actives
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * PROCHAINES ÉTAPES (Sprint 8)
 * ═══════════════════════════════════════════════════════════════════════════
 * - [x] Validation numérotation factures sans trous (Art. L441-9) ✅ V61
 * - [x] TVA déductible sur achats pro ✅ V61
 * - [ ] Tests unitaires calculs fiscaux
 * - [ ] Intégration Supabase
 * - [x] Rendement compte pro ✅ V47
 * - [x] Indicateurs cliquabilité corrigés ✅ V47
 */
</script>
</body>
</html>
